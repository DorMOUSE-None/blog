<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" class="next-head"/><meta charSet="utf-8" class="next-head"/><title class="next-head">Utop&#x27;s Blog</title><link rel="preload" href="https://www.ffutop.com/blog/_next/static/0kzTAuvoPaNQCLzaNLnfP/pages/post.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/0kzTAuvoPaNQCLzaNLnfP/pages/_app.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/runtime/webpack-8ed9452df514b4d17d80.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/chunks/commons.7e5e68e72610ac3a4255.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/chunks/styles.e15adcc4edd7c21ed4d5.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/runtime/main-fd73dbd6f398b7b886ec.js" as="script"/><link rel="stylesheet" href="https://www.ffutop.com/blog/_next/static/css/commons.736184b0.chunk.css"/><link rel="stylesheet" href="https://www.ffutop.com/blog/_next/static/css/styles.a7260672.chunk.css"/></head><body><div id="__next"><header class="component-header"><h1 class="title">ffutop</h1><ul class="nav-items"><li><a href="/blog/index">åšå®¢</a></li><li><a href="/blog/archives">å½’æ¡£</a></li><li><a href="/blog/tags">æ ‡ç­¾</a></li><li><a href="/blog/about">å…³äº</a></li></ul></header><div><main class="main"><div class="page-post"><div class="markdown-content"><p>ç›¸æ¯”è¾ƒäºå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æ— è®ºä»ç‰©ç†è®¤çŸ¥ä¸Šï¼ŒæŠ‘æˆ–æ˜¯ç†è®ºç†è§£ä¸Šï¼Œéƒ½å­˜åœ¨ç€ç›¸å½“å¤§çš„å…¥é—¨é—¨æ§›ã€‚ç‰¹åˆ«æ˜¯åœ¨å°†å­—ç¬¦è®¾å¤‡ä¸æ§åˆ¶å°ã€å‘½ä»¤è¡Œç»ˆç«¯æ··æ·†çš„æ—¶å€™ï¼Œå°±æ›´åŠ éš¾ä»¥è¿›è¡Œåˆ†è¾¨äº†ã€‚</p>
<p>å›åˆ°å­—ç¬¦è®¾å¤‡æœ¬èº«ï¼Œå­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡æœ€ä¸»è¦çš„åŒºåˆ«å°±åœ¨äºå—è®¾å¤‡å¯ä»¥éšæœºè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½å¤Ÿé¡ºåºè¯»ï¼Œé¡ºåºå†™ã€‚</p>
<p>é‚£ä¹ˆï¼Œå¸¸è§çš„å­—ç¬¦è®¾å¤‡æœ‰ä»€ä¹ˆï¼Ÿæ˜¾ç¤ºå™¨ã€é”®ç›˜ã€é¼ æ ‡ã€‚</p>
<h2>å®è§‚æ¦‚è§ˆ</h2>
<p>é€šå¸¸åœ¨æˆ‘ä»¬çš„è®¤è¯†ä¸­ï¼Œå‘½ä»¤è¡Œç»ˆç«¯å°±è¢«è®¤ä¸ºæ˜¯ä¸ä¸€å¥—å­—ç¬¦è®¾å¤‡ç›¸é…åˆæ¥ä½¿ç”¨çš„ã€‚å¾ˆæ­£å¸¸å˜›ã€‚æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ª Shell ï¼Œé€šè¿‡é”®ç›˜è¾“å…¥ä¸€äº›å­—ç¬¦ï¼Œé…åˆæ˜¾ç¤ºå™¨æŠŠè¿™äº›ç»è¿‡åŠ å·¥çš„å­—ç¬¦å±•ç¤ºå‡ºæ¥ã€‚</p>
<p>é‚£ä¹ˆï¼Œæ˜¯ä¸æ˜¯å°±æ„å‘³ç€ Shell ä½œä¸ºä¸€ä¸ªä»»åŠ¡(è¿›ç¨‹)ï¼Œä»¥é”®ç›˜è®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å…¥ï¼Œä»¥æ˜¾ç¤ºè®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å‡º?</p>
<p>çœ‹çœ‹ä¸€ä¸ª 1 å·ä»»åŠ¡ <code>/bin/bash</code> çš„æ–‡ä»¶æè¿°ç¬¦è¯´æ˜å§ã€‚</p>
<pre><code class="language-sh">$ ls -al
total 0
dr-x------ 2 root root  0 Dec 13 23:20 .
dr-xr-xr-x 9 root root  0 Dec 13 23:20 ..
lrwx------ 1 root root 64 Dec 13 23:20 0 -> /dev/pts/0
lrwx------ 1 root root 64 Dec 13 23:20 1 -> /dev/pts/0
lrwx------ 1 root root 64 Dec 13 23:20 2 -> /dev/pts/0
lrwx------ 1 root root 64 Dec 25 01:09 255 -> /dev/pts/0
</code></pre>
<p>è¿™é‡Œæ–‡ä»¶æè¿°ç¬¦ 0, 1, 2 åˆ†åˆ«è¡¨ç¤ºä»»åŠ¡çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ã€‚è¿™äº›å†…å®¹åœ¨è¡¨ç°å½¢å¼ä¸Šåšäº†ä¸€ä¸ªé“¾æ¥ã€‚</p>
<p>é‚£ä¹ˆï¼Œ<code>/dev/pts/0</code> æ˜¯ä»€ä¹ˆ? </p>
<pre><code class="language-sh">crw--w---- 1 root tty 136, 0 Dec 13 23:20 /dev/pts/0
</code></pre>
<p>ä¸€ä¸ªå­—ç¬¦è®¾å¤‡ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œä¼¼ä¹å’Œæœ€åˆé¢„æƒ³çš„æœ‰æ¯”è¾ƒå¤§çš„åŒºåˆ«ã€‚è‡³å°‘åœ¨å‡è±¡ä¸­ï¼Œè‡³å°‘æ˜¯ä¸€ä¸ªè¾“å…¥(é”®ç›˜)ï¼Œä¸€ä¸ªè¾“å‡º(æ˜¾ç¤ºå™¨)ã€‚æ€ä¹ˆå°±æ··æˆäº†ä¸€ä¸ªå‘¢ï¼Ÿ</p>
<p>æœ¬æ¥æ˜¯æ€ä¹ˆéƒ½æƒ³ä¸é€šçš„ï¼Œä½†åæ¥é…åˆ"Unixä¸€åˆ‡çš†æ–‡ä»¶"çš„ä¿¡æ¡ï¼Œæ€»ç®—æ˜¯æœ‰ç‚¹æ˜ç™½äº†ã€‚</p>
<p>ç›¸ä¿¡å¤§å®¶éƒ½æœ‰è¿™è¿™æ ·çš„ç»å†ï¼ŒæŸä¸ªç¨‹åºæ˜¯ä»¥é”®ç›˜è¾“å…¥ä½œä¸ºæ ‡å‡†è¾“å…¥çš„ã€‚å…¶å®å°±å’Œä¸Šé¢ğŸ‘†å±•ç¤ºçš„ä¸€æ · <code>0 -> /dev/pts/0</code> ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰è€ƒè™‘è¿‡è¿™æ•´å¥—æµç¨‹æ˜¯æ€ä¹ˆåä½œçš„å‘¢ï¼Ÿ</p>
<p><img src="http://img.ffutop.com/923C7CB6-9092-45A2-B9D8-BC0806792B20.jpg"></p>
<p>å¯¹äºç¨‹åºæ¥è¯´ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ™®é€šçš„è°ƒç”¨ <code>read</code>, <code>write</code> ç­‰ç»è¿‡å°è£…çš„å‡½æ•°ï¼Œæ¥è¯»å–ä¸€ä¸ªæ‰€è°“çš„æ–‡ä»¶ã€‚</p>
<p>ä½†å¯¹äºæ–‡ä»¶æ˜¯å­—ç¬¦è®¾å¤‡æ—¶ï¼Œæœ€ç»ˆè°ƒç”¨çš„å°±æ˜¯ <code>tty_read</code>, <code>tty_write</code> äº†ã€‚é€šä¿—çš„è®²ï¼Œå¤§æ¦‚ç‡çš„å°±æ˜¯é”®ç›˜ä½œä¸ºè¾“å…¥ï¼Œæ˜¾ç¤ºå™¨ä½œä¸ºè¾“å‡ºäº†ã€‚</p>
<h2>æºç å‰–æ</h2>
<h3>æ–‡ä»¶è¯»å†™</h3>
<p>è¿™éƒ¨åˆ†ä¸Šä¸€ç¯‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œä¸åšè¿‡å¤šè¯´æ˜ã€‚</p>
<p>ç®€å•å›é¡¾ä¸‹ <code>sys_read</code> å‡½æ•°</p>
<pre><code class="language-c">int sys_read(unsigned int fd,char * buf,int count)
{
    struct file * file;
    struct m_inode * inode;

    if (fd>=NR_OPEN || count&#x3C;0 || !(file=current->filp[fd]))
        return -EINVAL;
    if (!count)
        return 0;
    verify_area(buf,count);
    inode = file->f_inode;
    if (inode->i_pipe)
        return (file->f_mode&#x26;1)?read_pipe(inode,buf,count):-EIO;
    /* ç¡®è®¤åˆ°ièŠ‚ç‚¹æè¿°çš„æ˜¯å­—ç¬¦è®¾å¤‡ */
    if (S_ISCHR(inode->i_mode)) 
        return rw_char(READ,inode->i_zone[0],buf,count,&#x26;file->f_pos);
    if (S_ISBLK(inode->i_mode))
        return block_read(inode->i_zone[0],&#x26;file->f_pos,buf,count);
    if (S_ISDIR(inode->i_mode) || S_ISREG(inode->i_mode)) {
        if (count+file->f_pos > inode->i_size)
            count = inode->i_size - file->f_pos;
        if (count&#x3C;=0)
            return 0;
        return file_read(inode,file,buf,count);
    }
    printk("(Read)inode->i_mode=%06o\n\r",inode->i_mode);
    return -EINVAL;
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ° <code>S_ISCHR()</code> å°±æ˜¯åœ¨å¯¹ièŠ‚ç‚¹çš„ç±»å‹è¿›è¡Œåˆ¤åˆ«ï¼Œä»è€Œè¿›è¡Œä¸åŒçš„åˆ†å‘ã€‚</p>
<pre><code class="language-c">static crw_ptr crw_table[]={
    NULL,       /* nodev */
    rw_memory,  /* /dev/mem etc */
    NULL,       /* /dev/fd */
    NULL,       /* /dev/hd */
    rw_ttyx,    /* /dev/ttyx */
    rw_tty,     /* /dev/tty */
    NULL,       /* /dev/lp */
    NULL};      /* unnamed pipes */
/**
 * è¿™æ®µè¿˜æ˜¯æ¶‰åŠåˆ°åˆ†å‘ï¼Œç”±ä¸åŒçš„è®¾å¤‡å·(dev) æ¥ç¡®å®šæ‰§è¡Œå‡½æ•° (ttyx, ä¸²å£ç»ˆç«¯; tty, æ§åˆ¶å°ç»ˆç«¯; mem, /dev/mem ç­‰)
 * crw_ptr æ˜¯ C è¯­è¨€ä¸­å¸¸è§çš„å‡½æ•°æŒ‡é’ˆã€‚ç”±devå·æ¥ç¡®å®šè°ƒç”¨å“ªä¸ªå‡½æ•°
 */
int rw_char(int rw,int dev, char * buf, int count, off_t * pos)
{
    crw_ptr call_addr;

    if (MAJOR(dev)>=NRDEVS)
        return -ENODEV;
    if (!(call_addr=crw_table[MAJOR(dev)]))
        return -ENODEV;
    return call_addr(rw,MINOR(dev),buf,count,pos);
}
</code></pre>
<p>æ‰§è¡Œåˆ° <code>rw_tty</code>, <code>rw_ttyx</code> ä¸¤ä¸ªå‡½æ•°ï¼Œå°±å°†å¯¹è¯»/å†™è¿›è¡ŒåŒºåˆ†ï¼Œå¹¶ç”±ç‰¹å®šçš„å‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p>
<pre><code class="language-c">static int rw_ttyx(int rw,unsigned minor,char * buf,int count,off_t * pos)
{
    return ((rw==READ)?tty_read(minor,buf,count):
        tty_write(minor,buf,count));
}

static int rw_tty(int rw,unsigned minor,char * buf,int count, off_t * pos)
{
    if (current->tty&#x3C;0)
        return -EPERM;
    return rw_ttyx(rw,current->tty,buf,count,pos);
}
</code></pre>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œåº”è¯¥èƒ½å¤ŸåŸºæœ¬äº†è§£äº†å­—ç¬¦è®¾å¤‡ï¼Œä½œä¸º Linux çš„æ–‡ä»¶ï¼Œæ‰€åº”è¯¥æœ‰çš„è¯»å†™çš„ç›¸å…³æ”¯æŒã€‚</p>
<p>ä½†æ˜¯ï¼Œç©¶ç«Ÿè¯»ã€å†™çš„å†…å®¹åœ¨å“ªå‘¢ï¼Ÿæ¯”å¦‚æ­£è§„æ–‡ä»¶ï¼Œéƒ½å¾ˆå®¹æ˜“åœ°å¯ä»¥ç†è§£åˆ°ï¼Œå°±æ˜¯ä»ç£ç›˜ä¸­å–å‡ºæŸä¸ª/æŸå‡ ä¸ªç›˜å—çš„å†…å®¹å³å¯ã€‚å­—ç¬¦è®¾å¤‡çš„IOè¦ä»å“ªé‡Œå–(å¾€å“ªé‡Œé€)æ•°æ®å‘¢?</p>
<h3>å­—ç¬¦è®¾å¤‡é©±åŠ¨</h3>
<p>å¯¹äºè®¾å¤‡é©±åŠ¨è¿™ä¸ªæ¦‚å¿µï¼Œè‡³ä»Šæ²¡æœ‰ææ¸…æ¥šã€‚ä¸è¿‡ï¼Œè¿™ä¸å¦¨ç¢å¯¹ä»£ç çš„ç†è§£ã€‚åæ­£å¯¹äºå­—ç¬¦è®¾å¤‡é©±åŠ¨æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€äº›è½¯ä»¶å±‚é¢çš„ä»£ç ï¼Œä¸æ™®é€šä»£ç çš„å”¯ä¸€åŒºåˆ«ï¼Œå°±æ˜¯å¯¹å¤–è®¾ç¡¬ä»¶åšäº†ç›¸åº”çš„äº¤äº’æ”¯æŒã€‚</p>
<p><img src="http://img.ffutop.com/6A5EDA5A-0C39-4CC5-8D93-B50C64AEE46B.jpg"></p>
<p>æ‰¿æ¥æ“ä½œç³»ç»Ÿçš„å­—ç¬¦è®¾å¤‡æ¥å£ï¼Œ<code>tty_read</code>ã€<code>tty_write</code> è´Ÿè´£è¯»å…¥å’Œå†™å‡ºã€‚</p>
<p>ä»å“ªé‡Œè¯»ï¼Ÿ<code>secondary</code> æ•°æ®é˜Ÿåˆ—ï¼›å¾€å“ªé‡Œå†™ï¼Ÿ<code>write_q</code> æ•°æ®é˜Ÿåˆ—ã€‚</p>
<p>åŒæ—¶ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œä¸è¿™äº›é˜Ÿåˆ—ç›´æ¥ç›¸å…³çš„ï¼Œå°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„é”®ç›˜å’Œæ˜¾ç¤ºå™¨äº†ã€‚æ˜¯ä¸æ˜¯æœ‰äº†ç‚¹è±ç„¶å¼€æœ—çš„æ„Ÿè§‰ã€‚</p>
<p>å¥½ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™é‡Œæè¿°çš„ä¸‰ä¸ªé˜Ÿåˆ—ç©¶ç«Ÿæ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚è¿™é‡Œå°±ä¸å¾—ä¸å…ˆçœ‹çœ‹å†…å­˜ä¸­æŠ½è±¡å‡ºæ¥çš„æè¿°ç»ˆç«¯çš„æ•°æ®ç»“æ„ <code>tty_struct</code>ã€‚</p>
<pre><code class="language-c">/**
 * copied from include/linux/tty.h
 */
struct tty_struct {
    struct termios termios;     /* terminal IO conf */
    int pgrp;                   /* æ‰€å±è¿›ç¨‹ç»„ */
    int stopped;                /* åœæ­¢æ ‡å¿— */
    void (*write)(struct tty_struct * tty); /* ç»ˆç«¯å†™å‡½æ•°æŒ‡é’ˆ */
    struct tty_queue read_q;    /* ç»ˆç«¯è¯»é˜Ÿåˆ— */
    struct tty_queue write_q;   /* ç»ˆç«¯å†™é˜Ÿåˆ— */
    struct tty_queue secondary; /* ç»ˆç«¯è¾…åŠ©é˜Ÿåˆ— */
};

/**
 * copied from include/termios.h
 */
struct termios {                /* terminal IO å±æ€§ */
    unsigned long c_iflag;      /* input mode flags */
    unsigned long c_oflag;      /* output mode flags */
    unsigned long c_cflag;      /* control mode flags */
    unsigned long c_lflag;      /* local mode flags */
    unsigned char c_line;       /* line discipline */
    unsigned char c_cc[NCCS];   /* control characters */
};

/**
 * copied from include/linux/tty.h
 */
struct tty_queue {
    unsigned long data;         /* å­—ç¬¦è¡Œæ•°é‡ | ä¸²å£ç»ˆç«¯åˆ™å­˜å‚¨ç«¯å£å· */
    unsigned long head;         /* å¤´æŒ‡é’ˆ */
    unsigned long tail;         /* å°¾æŒ‡é’ˆ */
    struct task_struct * proc_list; /* ç­‰å¾…è¯¥ç»ˆç«¯çš„ä»»åŠ¡é˜Ÿåˆ— */
    char buf[TTY_BUF_SIZE];     /* é˜Ÿåˆ—çš„ç¼“å†²åŒº */
};
</code></pre>
<p>å¯¹äºä»»ä½•ä»»åŠ¡éœ€è¦è¯»å†™å­—ç¬¦è®¾å¤‡(è¿™é‡ŒæŒ‡ç»ˆç«¯è®¾å¤‡)ï¼Œæœ€ç»ˆç›´æ¥è¯»å–/å†™å…¥åˆ°çš„å°±æ˜¯ <code>secondary</code> å’Œ <code>write_q</code>ã€‚</p>
<hr>
<p>è¿™é‡Œå¯èƒ½æœ‰ä¸ªå°å°çš„ç–‘é—®? ä¸ºä»€ä¹ˆè¯»ç»ˆç«¯è®¾å¤‡ä¸æ˜¯è¯» <code>read_q</code> å‘¢ï¼Ÿ</p>
<p>å…¶å®ä¹Ÿæ¯”è¾ƒå¥½è§£é‡Šï¼Œç›¸ä¿¡æ—¥å¸¸åœ¨æ“ä½œå‘½ä»¤è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨é”®ç›˜ä¸Šæ•²å‡»çš„é”®ä½ä¸æ˜¾ç¤ºå™¨ä¸Šå®é™…å±•ç¤ºçš„å†…å®¹æ˜¯ä¸ç›¸åŒ¹é…çš„ã€‚æœ€æ™®é€šçš„ï¼Œæˆ‘ä»¬é”®å…¥äº† <strong>delete(åˆ é™¤é”®)</strong>ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯ä¸€ä¸ª <strong>delete</strong> å¯¹åº”çš„ ascii (å½“ç„¶ï¼Œè¿™é‡Œè¯·å…ˆå¿½è§†éæ‰“å°å­—ç¬¦çš„é—®é¢˜)ï¼Œè€Œæ˜¯åˆ é™¤äº†æœ€åä¸€ä¸ªå­—ç¬¦å‘¢ï¼Ÿå®Œå…¨å¯ä»¥æƒ³è±¡ï¼Œåæ­£ä»»ä½•é”®ä½ä¸é©±åŠ¨äº¤äº’çš„æ—¶å€™éƒ½æ˜¯ä¼ å…¥ä¸€ä¸²äºŒè¿›åˆ¶ç å˜›ã€‚</p>
<p>è¿™é‡Œçš„ <code>secondary</code> å®Œæˆçš„å°±æ˜¯æ€ä¹ˆä¸€ä¸ªå·¥ä½œï¼Œ<code>read_q</code> å­˜å‚¨çš„æ˜¯æ‰€æœ‰çš„å¤–è®¾(è¿™é‡Œæ˜¯é”®ç›˜)çš„è¾“å…¥ï¼Œå¹¶åŸæ ·å­˜å‚¨ã€‚è€Œåˆ°äº† <code>secondary</code> å°±æ˜¯ç»è¿‡ç›¸åº”çš„åŠ å·¥ï¼Œè¯¸å¦‚æ§åˆ¶å­—ç¬¦ä¹‹ç±»çš„éƒ½å±•ç°äº†å„è‡ªçš„æ„ä¹‰ï¼Œå¹¶å®Œæˆä¸€äº›åŠ å·¥å·¥ä½œï¼Œè€Œä¸å†ä»…ä»…åªæ˜¯æ™®é€šåœ°å±•ç¤ºäº†ã€‚</p>
<hr>
<p>å¦å¤–ï¼Œå¯èƒ½è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚è™½ç„¶æˆ‘ä»¬å·²ç»ä¹ æƒ¯äº†åœ¨å‘½ä»¤è¡Œäº¤äº’æ—¶ï¼Œæ‰€æœ‰çš„è¾“å…¥éƒ½å°†ç›´æ¥åœ¨æ˜¾ç¤ºå™¨ä¸Šè¿›è¡Œå±•ç¤ºï¼Œå¥½åƒæˆ‘ä»¬åœ¨ç›´æ¥å¾€æ˜¾ç¤ºå™¨ä¸Šå†™å†…å®¹ã€‚ä½†æ˜¯ï¼Œå‰é¢æˆ‘ä»¬æè¿°çš„å†…å®¹éƒ½æ˜¯ï¼Œé”®ç›˜è®¾å¤‡ä½œä¸ºè¾“å…¥ï¼Œæ˜¯è¦å†™åˆ° <code>read_q</code> ä¹ƒè‡³ <code>secondary</code> å¹¶æœ€ç»ˆä½œä¸ºè¿›ç¨‹çš„è¾“å…¥çš„ã€‚åœ¨æ˜¾ç¤ºå™¨ä¸Šæ˜¾ç¤ºå¹¶ä¸æ˜¯å®ƒæœ¬æ¥åº”è¯¥å¹²çš„äº‹æƒ… (æ¯”è¾ƒæ˜¾ç¤ºå™¨ä¸Šå±•ç¤ºçš„åº”è¯¥æ˜¯ <code>write_q</code> çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹çš„æ ‡å‡†è¾“å‡º)</p>
<p>äº‹å®ä¸Šï¼Œè¿™ä»…ä»…åªæ˜¯ä¸€ä¸ªå›æ˜¾ï¼Œå°† <code>secondary</code> é˜Ÿåˆ—çš„å†…å®¹å¤åˆ¶äº†ä¸€ä»½åˆ°å†™é˜Ÿåˆ—ï¼Œä¹Ÿå°±å‘ˆç°å‡ºè®©æ˜¾ç¤ºå™¨æ‰“å°ç›¸åº”é”®ç›˜è¾“å…¥çš„æ•ˆæœäº†ã€‚</p>
<p>åŒæ—¶ï¼Œè¿™ä¹Ÿå°±èƒ½å¤Ÿç›´æ¥è§£é‡Šä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨ <code>passwd</code>, <code>su</code>, <code>sudo</code> ç­‰å‘½ä»¤æ—¶ï¼Œè¦æ±‚è¾“å…¥å¯†ç éƒ½æ˜¯ä¸åœ¨æ˜¾ç¤ºå™¨ä¸Šå›æ˜¾çš„ã€‚å®ç°ä¹Ÿç›¸å½“ç®€å•äº†å˜›ã€‚æŠŠ tty_struct.termios çš„ç›¸åº”æ§åˆ¶å±æ€§ (ECHO) é‡ç½®ï¼Œå°±å¯ä»¥å®ç°ä¸å›æ˜¾çš„æ•ˆæœäº†ã€‚</p>
<h3>ç»ˆç«¯è®¾å¤‡äº¤äº’</h3>
<p>æœ€åä¸€éƒ¨åˆ†ï¼Œåº”è¯¥ä¹Ÿæ˜¯æœ€å…³å¿ƒçš„äº†ã€‚å¤–è®¾å¦‚ä½•ä¸æ“ä½œç³»ç»Ÿå®Œæˆäº¤äº’ã€‚å…¶å®ä¹Ÿèƒ½å¤Ÿæƒ³å¾—åˆ°äº†â€”â€”ä¸­æ–­ã€‚</p>
<p>åœ¨æ“ä½œç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œå°±æŠŠä¸­æ–­æè¿°ç¬¦è¡¨çš„ä¸­æ–­è¡¨é¡¹é…ç½®å¾—å½“ã€‚ä¹‹åçš„äº‹æƒ…å°±æ˜¯ç­‰å¾…é”®ç›˜ç­‰å¤–è®¾è¾“å…¥çš„ä¸­æ–­ä¿¡å·äº†ã€‚</p>
<p>åˆçœ‹å›åˆ°äº† <code>init/main.c</code> ç¨‹åº</p>
<pre><code class="language-c">void main(void)
{
    ...
    trap_init();
    blk_dev_init();
    chr_dev_init(); /* å—è®¾å¤‡ç›¸å…³åˆå§‹åŒ–, æ–¹æ³•ä½“æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰å®ç° */
    tty_init();     /* tty ç»ˆç«¯è®¾å¤‡åˆå§‹åŒ– */
    time_init();
    sched_init();
    buffer_init(buffer_memory_end);
    ...
}
</code></pre>
<pre><code>/**
 * Copied from kernel/chr_drv/tty_io.c
 * ç»ˆç«¯è®¾å¤‡åˆè¯†åŒ–
 */
void tty_init(void)
{
    /** ä¸²å£è®¾å¤‡åˆå§‹åŒ– */
    rs_init();
    /** æ§åˆ¶å°è®¾å¤‡åˆå§‹åŒ– */
    con_init();
}
</code></pre>
<p>è‡³äºä¸ºä»€ä¹ˆæœ‰ä¸¤ç§åˆå§‹åŒ–æ–¹å¼ã€‚è¿™æ¥æºäºç»ˆç«¯åˆåŒºåˆ†ä¸ºæ§åˆ¶å°ç»ˆç«¯ä¸ä¸²å£ç»ˆç«¯ï¼ŒåŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯ç›´æ¥å»ºç«‹åœ¨ä¸»æœºä¸Šï¼Œä¸²å£ç»ˆç«¯æ˜¯é€šè¿‡ä¸²è¡Œæ¥å£è¿æ¥åˆ°ä¸»æœºçš„ã€‚å½“ç„¶ï¼Œè¿™éƒ½æ˜¯å¤è€çš„æ–¹å¼äº†ï¼Œç»†èŠ‚å°±ä¸å¤ªæ¸…æ¥šäº†ã€‚</p>
<p>ä¸‹é¢æ¥çœ‹çœ‹ <code>con_init()</code> åšäº†å“ªäº›å·¥ä½œ(<code>rs_init()</code> çš„å†…å®¹è¯·è‡ªè¡Œäº†è§£)</p>
<pre><code class="language-c">void con_init(void)
{
    register unsigned char a;
    char *display_desc = "????";
    char *display_ptr;

    /**
     * è¯»å– setup.s ç¨‹åºé¢„å¤„ç†çš„å†…å®¹
     * åŒ…æ‹¬æ˜¾ç¤ºå™¨çš„å„ç§é…ç½®å‚æ•°
     */
    video_num_columns = ORIG_VIDEO_COLS;
    video_size_row = video_num_columns * 2;
    video_num_lines = ORIG_VIDEO_LINES;
    video_page = ORIG_VIDEO_PAGE;
    video_erase_char = 0x0720;

    /**
     * è¯»å–æ˜¾ç¤ºå™¨çš„é…ç½®å¹¶è¿›è¡Œç›¸å…³è®¾ç½® (çœç•¥ä»£ç )
     */
    ...

    origin  = video_mem_start;
    scr_end = video_mem_start + video_num_lines * video_size_row;
    top = 0;
    bottom  = video_num_lines;

    gotoxy(ORIG_X,ORIG_Y);
    /** è®¾ç½®é™·é˜±é—¨ */
    set_trap_gate(0x21,&#x26;keyboard_interrupt);
    outb_p(inb_p(0x21)&#x26;0xfd,0x21);
    a=inb_p(0x61);
    outb_p(a|0x80,0x61);
    outb(a,0x61);
}
</code></pre>
<p>åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°æœ€é‡è¦çš„å†…å®¹å°±æ˜¯<strong>è®¾ç½®é”®ç›˜ä¸­æ–­é™·é˜±é—¨</strong>äº†ã€‚</p>
<p>ä¹‹ååªæœ‰é™é™åœ°ç­‰å¾…é”®ä½æ•²å‡»ï¼Œä¹Ÿå°±èƒ½å¤Ÿäº§ç”Ÿç¡¬ä»¶ä¸­æ–­ï¼Œä»è€Œè®© <code>read_q</code> è·å¾—åˆ°ç›¸åº”çš„å­—ç¬¦è¾“å…¥ã€‚</p>
<p>è‡³äºé”®ç›˜ä¸­æ–­çš„ç›¸åº”å¤„ç†æµç¨‹ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚ç®€è¿°ä¸€äº›æ­¥éª¤:</p>
<ol>
<li>
<p>äº§ç”Ÿç¡¬ä¸­æ–­ <code>keyboard_interrupt</code>ï¼Œç”±ç¨‹åº <code>Keyboard.s</code> çš„æ±‡ç¼–ä»£ç è¿›è¡Œå¤„ç†</p>
</li>
<li>
<p>æ ¹æ®ä¸åŒçš„é”®ç›˜(US é”®ç›˜ã€å¾·å¼é”®ç›˜ç­‰ç­‰)å°†è·å¾—çš„é”®ä½ä¿¡å·è¿›è¡Œç›¸åº”çš„å­—ç¬¦è½¬æ¢(æŸ¥è½¬æ¢è¡¨)</p>
</li>
<li>
<p>è°ƒç”¨ <code>do_tty_interrupt</code> å¤„ç†å‡½æ•° (ç¡®è®¤æ˜¯ç»™å“ªä¸ªç»ˆç«¯çš„ä¿¡å·)</p>
</li>
<li>
<p>è°ƒç”¨ <code>copy_to_cooked(tty)</code> ï¼Œå³å®Œæˆ <code>read_q</code> åˆ° <code>secondary</code> çš„ç›¸å…³åŠ å·¥ã€‚</p>
</li>
</ol>
<pre><code class="language-plain">  __                    __                  
 / _| __ _ _ __   __ _ / _| ___ _ __   __ _ 
| |_ / _` | '_ \ / _` | |_ / _ \ '_ \ / _` |
|  _| (_| | | | | (_| |  _|  __/ | | | (_| |
|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |
                 |___/                |___/ 
</code></pre></div></div></main><footer class="footer">ffutop Â© <!-- -->2019<!-- -->, Powered byÂ <a href="https://reactjs.org/">React</a>Â andÂ <a href="https://nextjs.org/">Next.js</a></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{}},"page":"/post","query":{"content":"\u003cp\u003eç›¸æ¯”è¾ƒäºå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æ— è®ºä»ç‰©ç†è®¤çŸ¥ä¸Šï¼ŒæŠ‘æˆ–æ˜¯ç†è®ºç†è§£ä¸Šï¼Œéƒ½å­˜åœ¨ç€ç›¸å½“å¤§çš„å…¥é—¨é—¨æ§›ã€‚ç‰¹åˆ«æ˜¯åœ¨å°†å­—ç¬¦è®¾å¤‡ä¸æ§åˆ¶å°ã€å‘½ä»¤è¡Œç»ˆç«¯æ··æ·†çš„æ—¶å€™ï¼Œå°±æ›´åŠ éš¾ä»¥è¿›è¡Œåˆ†è¾¨äº†ã€‚\u003c/p\u003e\n\u003cp\u003eå›åˆ°å­—ç¬¦è®¾å¤‡æœ¬èº«ï¼Œå­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡æœ€ä¸»è¦çš„åŒºåˆ«å°±åœ¨äºå—è®¾å¤‡å¯ä»¥éšæœºè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½å¤Ÿé¡ºåºè¯»ï¼Œé¡ºåºå†™ã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆï¼Œå¸¸è§çš„å­—ç¬¦è®¾å¤‡æœ‰ä»€ä¹ˆï¼Ÿæ˜¾ç¤ºå™¨ã€é”®ç›˜ã€é¼ æ ‡ã€‚\u003c/p\u003e\n\u003ch2\u003eå®è§‚æ¦‚è§ˆ\u003c/h2\u003e\n\u003cp\u003eé€šå¸¸åœ¨æˆ‘ä»¬çš„è®¤è¯†ä¸­ï¼Œå‘½ä»¤è¡Œç»ˆç«¯å°±è¢«è®¤ä¸ºæ˜¯ä¸ä¸€å¥—å­—ç¬¦è®¾å¤‡ç›¸é…åˆæ¥ä½¿ç”¨çš„ã€‚å¾ˆæ­£å¸¸å˜›ã€‚æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ª Shell ï¼Œé€šè¿‡é”®ç›˜è¾“å…¥ä¸€äº›å­—ç¬¦ï¼Œé…åˆæ˜¾ç¤ºå™¨æŠŠè¿™äº›ç»è¿‡åŠ å·¥çš„å­—ç¬¦å±•ç¤ºå‡ºæ¥ã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆï¼Œæ˜¯ä¸æ˜¯å°±æ„å‘³ç€ Shell ä½œä¸ºä¸€ä¸ªä»»åŠ¡(è¿›ç¨‹)ï¼Œä»¥é”®ç›˜è®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å…¥ï¼Œä»¥æ˜¾ç¤ºè®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å‡º?\u003c/p\u003e\n\u003cp\u003eçœ‹çœ‹ä¸€ä¸ª 1 å·ä»»åŠ¡ \u003ccode\u003e/bin/bash\u003c/code\u003e çš„æ–‡ä»¶æè¿°ç¬¦è¯´æ˜å§ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003e$ ls -al\ntotal 0\ndr-x------ 2 root root  0 Dec 13 23:20 .\ndr-xr-xr-x 9 root root  0 Dec 13 23:20 ..\nlrwx------ 1 root root 64 Dec 13 23:20 0 -\u003e /dev/pts/0\nlrwx------ 1 root root 64 Dec 13 23:20 1 -\u003e /dev/pts/0\nlrwx------ 1 root root 64 Dec 13 23:20 2 -\u003e /dev/pts/0\nlrwx------ 1 root root 64 Dec 25 01:09 255 -\u003e /dev/pts/0\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¿™é‡Œæ–‡ä»¶æè¿°ç¬¦ 0, 1, 2 åˆ†åˆ«è¡¨ç¤ºä»»åŠ¡çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ã€‚è¿™äº›å†…å®¹åœ¨è¡¨ç°å½¢å¼ä¸Šåšäº†ä¸€ä¸ªé“¾æ¥ã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆï¼Œ\u003ccode\u003e/dev/pts/0\u003c/code\u003e æ˜¯ä»€ä¹ˆ? \u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003ecrw--w---- 1 root tty 136, 0 Dec 13 23:20 /dev/pts/0\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä¸€ä¸ªå­—ç¬¦è®¾å¤‡ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œä¼¼ä¹å’Œæœ€åˆé¢„æƒ³çš„æœ‰æ¯”è¾ƒå¤§çš„åŒºåˆ«ã€‚è‡³å°‘åœ¨å‡è±¡ä¸­ï¼Œè‡³å°‘æ˜¯ä¸€ä¸ªè¾“å…¥(é”®ç›˜)ï¼Œä¸€ä¸ªè¾“å‡º(æ˜¾ç¤ºå™¨)ã€‚æ€ä¹ˆå°±æ··æˆäº†ä¸€ä¸ªå‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eæœ¬æ¥æ˜¯æ€ä¹ˆéƒ½æƒ³ä¸é€šçš„ï¼Œä½†åæ¥é…åˆ\"Unixä¸€åˆ‡çš†æ–‡ä»¶\"çš„ä¿¡æ¡ï¼Œæ€»ç®—æ˜¯æœ‰ç‚¹æ˜ç™½äº†ã€‚\u003c/p\u003e\n\u003cp\u003eç›¸ä¿¡å¤§å®¶éƒ½æœ‰è¿™è¿™æ ·çš„ç»å†ï¼ŒæŸä¸ªç¨‹åºæ˜¯ä»¥é”®ç›˜è¾“å…¥ä½œä¸ºæ ‡å‡†è¾“å…¥çš„ã€‚å…¶å®å°±å’Œä¸Šé¢ğŸ‘†å±•ç¤ºçš„ä¸€æ · \u003ccode\u003e0 -\u003e /dev/pts/0\u003c/code\u003e ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰è€ƒè™‘è¿‡è¿™æ•´å¥—æµç¨‹æ˜¯æ€ä¹ˆåä½œçš„å‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"http://img.ffutop.com/923C7CB6-9092-45A2-B9D8-BC0806792B20.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eå¯¹äºç¨‹åºæ¥è¯´ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ™®é€šçš„è°ƒç”¨ \u003ccode\u003eread\u003c/code\u003e, \u003ccode\u003ewrite\u003c/code\u003e ç­‰ç»è¿‡å°è£…çš„å‡½æ•°ï¼Œæ¥è¯»å–ä¸€ä¸ªæ‰€è°“çš„æ–‡ä»¶ã€‚\u003c/p\u003e\n\u003cp\u003eä½†å¯¹äºæ–‡ä»¶æ˜¯å­—ç¬¦è®¾å¤‡æ—¶ï¼Œæœ€ç»ˆè°ƒç”¨çš„å°±æ˜¯ \u003ccode\u003etty_read\u003c/code\u003e, \u003ccode\u003etty_write\u003c/code\u003e äº†ã€‚é€šä¿—çš„è®²ï¼Œå¤§æ¦‚ç‡çš„å°±æ˜¯é”®ç›˜ä½œä¸ºè¾“å…¥ï¼Œæ˜¾ç¤ºå™¨ä½œä¸ºè¾“å‡ºäº†ã€‚\u003c/p\u003e\n\u003ch2\u003eæºç å‰–æ\u003c/h2\u003e\n\u003ch3\u003eæ–‡ä»¶è¯»å†™\u003c/h3\u003e\n\u003cp\u003eè¿™éƒ¨åˆ†ä¸Šä¸€ç¯‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œä¸åšè¿‡å¤šè¯´æ˜ã€‚\u003c/p\u003e\n\u003cp\u003eç®€å•å›é¡¾ä¸‹ \u003ccode\u003esys_read\u003c/code\u003e å‡½æ•°\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003eint sys_read(unsigned int fd,char * buf,int count)\n{\n    struct file * file;\n    struct m_inode * inode;\n\n    if (fd\u003e=NR_OPEN || count\u0026#x3C;0 || !(file=current-\u003efilp[fd]))\n        return -EINVAL;\n    if (!count)\n        return 0;\n    verify_area(buf,count);\n    inode = file-\u003ef_inode;\n    if (inode-\u003ei_pipe)\n        return (file-\u003ef_mode\u0026#x26;1)?read_pipe(inode,buf,count):-EIO;\n    /* ç¡®è®¤åˆ°ièŠ‚ç‚¹æè¿°çš„æ˜¯å­—ç¬¦è®¾å¤‡ */\n    if (S_ISCHR(inode-\u003ei_mode)) \n        return rw_char(READ,inode-\u003ei_zone[0],buf,count,\u0026#x26;file-\u003ef_pos);\n    if (S_ISBLK(inode-\u003ei_mode))\n        return block_read(inode-\u003ei_zone[0],\u0026#x26;file-\u003ef_pos,buf,count);\n    if (S_ISDIR(inode-\u003ei_mode) || S_ISREG(inode-\u003ei_mode)) {\n        if (count+file-\u003ef_pos \u003e inode-\u003ei_size)\n            count = inode-\u003ei_size - file-\u003ef_pos;\n        if (count\u0026#x3C;=0)\n            return 0;\n        return file_read(inode,file,buf,count);\n    }\n    printk(\"(Read)inode-\u003ei_mode=%06o\\n\\r\",inode-\u003ei_mode);\n    return -EINVAL;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¯ä»¥çœ‹åˆ° \u003ccode\u003eS_ISCHR()\u003c/code\u003e å°±æ˜¯åœ¨å¯¹ièŠ‚ç‚¹çš„ç±»å‹è¿›è¡Œåˆ¤åˆ«ï¼Œä»è€Œè¿›è¡Œä¸åŒçš„åˆ†å‘ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003estatic crw_ptr crw_table[]={\n    NULL,       /* nodev */\n    rw_memory,  /* /dev/mem etc */\n    NULL,       /* /dev/fd */\n    NULL,       /* /dev/hd */\n    rw_ttyx,    /* /dev/ttyx */\n    rw_tty,     /* /dev/tty */\n    NULL,       /* /dev/lp */\n    NULL};      /* unnamed pipes */\n/**\n * è¿™æ®µè¿˜æ˜¯æ¶‰åŠåˆ°åˆ†å‘ï¼Œç”±ä¸åŒçš„è®¾å¤‡å·(dev) æ¥ç¡®å®šæ‰§è¡Œå‡½æ•° (ttyx, ä¸²å£ç»ˆç«¯; tty, æ§åˆ¶å°ç»ˆç«¯; mem, /dev/mem ç­‰)\n * crw_ptr æ˜¯ C è¯­è¨€ä¸­å¸¸è§çš„å‡½æ•°æŒ‡é’ˆã€‚ç”±devå·æ¥ç¡®å®šè°ƒç”¨å“ªä¸ªå‡½æ•°\n */\nint rw_char(int rw,int dev, char * buf, int count, off_t * pos)\n{\n    crw_ptr call_addr;\n\n    if (MAJOR(dev)\u003e=NRDEVS)\n        return -ENODEV;\n    if (!(call_addr=crw_table[MAJOR(dev)]))\n        return -ENODEV;\n    return call_addr(rw,MINOR(dev),buf,count,pos);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæ‰§è¡Œåˆ° \u003ccode\u003erw_tty\u003c/code\u003e, \u003ccode\u003erw_ttyx\u003c/code\u003e ä¸¤ä¸ªå‡½æ•°ï¼Œå°±å°†å¯¹è¯»/å†™è¿›è¡ŒåŒºåˆ†ï¼Œå¹¶ç”±ç‰¹å®šçš„å‡½æ•°è¿›è¡Œå¤„ç†ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003estatic int rw_ttyx(int rw,unsigned minor,char * buf,int count,off_t * pos)\n{\n    return ((rw==READ)?tty_read(minor,buf,count):\n        tty_write(minor,buf,count));\n}\n\nstatic int rw_tty(int rw,unsigned minor,char * buf,int count, off_t * pos)\n{\n    if (current-\u003etty\u0026#x3C;0)\n        return -EPERM;\n    return rw_ttyx(rw,current-\u003etty,buf,count,pos);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåˆ°æ­¤ä¸ºæ­¢ï¼Œåº”è¯¥èƒ½å¤ŸåŸºæœ¬äº†è§£äº†å­—ç¬¦è®¾å¤‡ï¼Œä½œä¸º Linux çš„æ–‡ä»¶ï¼Œæ‰€åº”è¯¥æœ‰çš„è¯»å†™çš„ç›¸å…³æ”¯æŒã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œç©¶ç«Ÿè¯»ã€å†™çš„å†…å®¹åœ¨å“ªå‘¢ï¼Ÿæ¯”å¦‚æ­£è§„æ–‡ä»¶ï¼Œéƒ½å¾ˆå®¹æ˜“åœ°å¯ä»¥ç†è§£åˆ°ï¼Œå°±æ˜¯ä»ç£ç›˜ä¸­å–å‡ºæŸä¸ª/æŸå‡ ä¸ªç›˜å—çš„å†…å®¹å³å¯ã€‚å­—ç¬¦è®¾å¤‡çš„IOè¦ä»å“ªé‡Œå–(å¾€å“ªé‡Œé€)æ•°æ®å‘¢?\u003c/p\u003e\n\u003ch3\u003eå­—ç¬¦è®¾å¤‡é©±åŠ¨\u003c/h3\u003e\n\u003cp\u003eå¯¹äºè®¾å¤‡é©±åŠ¨è¿™ä¸ªæ¦‚å¿µï¼Œè‡³ä»Šæ²¡æœ‰ææ¸…æ¥šã€‚ä¸è¿‡ï¼Œè¿™ä¸å¦¨ç¢å¯¹ä»£ç çš„ç†è§£ã€‚åæ­£å¯¹äºå­—ç¬¦è®¾å¤‡é©±åŠ¨æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€äº›è½¯ä»¶å±‚é¢çš„ä»£ç ï¼Œä¸æ™®é€šä»£ç çš„å”¯ä¸€åŒºåˆ«ï¼Œå°±æ˜¯å¯¹å¤–è®¾ç¡¬ä»¶åšäº†ç›¸åº”çš„äº¤äº’æ”¯æŒã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"http://img.ffutop.com/6A5EDA5A-0C39-4CC5-8D93-B50C64AEE46B.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eæ‰¿æ¥æ“ä½œç³»ç»Ÿçš„å­—ç¬¦è®¾å¤‡æ¥å£ï¼Œ\u003ccode\u003etty_read\u003c/code\u003eã€\u003ccode\u003etty_write\u003c/code\u003e è´Ÿè´£è¯»å…¥å’Œå†™å‡ºã€‚\u003c/p\u003e\n\u003cp\u003eä»å“ªé‡Œè¯»ï¼Ÿ\u003ccode\u003esecondary\u003c/code\u003e æ•°æ®é˜Ÿåˆ—ï¼›å¾€å“ªé‡Œå†™ï¼Ÿ\u003ccode\u003ewrite_q\u003c/code\u003e æ•°æ®é˜Ÿåˆ—ã€‚\u003c/p\u003e\n\u003cp\u003eåŒæ—¶ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œä¸è¿™äº›é˜Ÿåˆ—ç›´æ¥ç›¸å…³çš„ï¼Œå°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„é”®ç›˜å’Œæ˜¾ç¤ºå™¨äº†ã€‚æ˜¯ä¸æ˜¯æœ‰äº†ç‚¹è±ç„¶å¼€æœ—çš„æ„Ÿè§‰ã€‚\u003c/p\u003e\n\u003cp\u003eå¥½ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™é‡Œæè¿°çš„ä¸‰ä¸ªé˜Ÿåˆ—ç©¶ç«Ÿæ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚è¿™é‡Œå°±ä¸å¾—ä¸å…ˆçœ‹çœ‹å†…å­˜ä¸­æŠ½è±¡å‡ºæ¥çš„æè¿°ç»ˆç«¯çš„æ•°æ®ç»“æ„ \u003ccode\u003etty_struct\u003c/code\u003eã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003e/**\n * copied from include/linux/tty.h\n */\nstruct tty_struct {\n    struct termios termios;     /* terminal IO conf */\n    int pgrp;                   /* æ‰€å±è¿›ç¨‹ç»„ */\n    int stopped;                /* åœæ­¢æ ‡å¿— */\n    void (*write)(struct tty_struct * tty); /* ç»ˆç«¯å†™å‡½æ•°æŒ‡é’ˆ */\n    struct tty_queue read_q;    /* ç»ˆç«¯è¯»é˜Ÿåˆ— */\n    struct tty_queue write_q;   /* ç»ˆç«¯å†™é˜Ÿåˆ— */\n    struct tty_queue secondary; /* ç»ˆç«¯è¾…åŠ©é˜Ÿåˆ— */\n};\n\n/**\n * copied from include/termios.h\n */\nstruct termios {                /* terminal IO å±æ€§ */\n    unsigned long c_iflag;      /* input mode flags */\n    unsigned long c_oflag;      /* output mode flags */\n    unsigned long c_cflag;      /* control mode flags */\n    unsigned long c_lflag;      /* local mode flags */\n    unsigned char c_line;       /* line discipline */\n    unsigned char c_cc[NCCS];   /* control characters */\n};\n\n/**\n * copied from include/linux/tty.h\n */\nstruct tty_queue {\n    unsigned long data;         /* å­—ç¬¦è¡Œæ•°é‡ | ä¸²å£ç»ˆç«¯åˆ™å­˜å‚¨ç«¯å£å· */\n    unsigned long head;         /* å¤´æŒ‡é’ˆ */\n    unsigned long tail;         /* å°¾æŒ‡é’ˆ */\n    struct task_struct * proc_list; /* ç­‰å¾…è¯¥ç»ˆç«¯çš„ä»»åŠ¡é˜Ÿåˆ— */\n    char buf[TTY_BUF_SIZE];     /* é˜Ÿåˆ—çš„ç¼“å†²åŒº */\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¯¹äºä»»ä½•ä»»åŠ¡éœ€è¦è¯»å†™å­—ç¬¦è®¾å¤‡(è¿™é‡ŒæŒ‡ç»ˆç«¯è®¾å¤‡)ï¼Œæœ€ç»ˆç›´æ¥è¯»å–/å†™å…¥åˆ°çš„å°±æ˜¯ \u003ccode\u003esecondary\u003c/code\u003e å’Œ \u003ccode\u003ewrite_q\u003c/code\u003eã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eè¿™é‡Œå¯èƒ½æœ‰ä¸ªå°å°çš„ç–‘é—®? ä¸ºä»€ä¹ˆè¯»ç»ˆç«¯è®¾å¤‡ä¸æ˜¯è¯» \u003ccode\u003eread_q\u003c/code\u003e å‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eå…¶å®ä¹Ÿæ¯”è¾ƒå¥½è§£é‡Šï¼Œç›¸ä¿¡æ—¥å¸¸åœ¨æ“ä½œå‘½ä»¤è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨é”®ç›˜ä¸Šæ•²å‡»çš„é”®ä½ä¸æ˜¾ç¤ºå™¨ä¸Šå®é™…å±•ç¤ºçš„å†…å®¹æ˜¯ä¸ç›¸åŒ¹é…çš„ã€‚æœ€æ™®é€šçš„ï¼Œæˆ‘ä»¬é”®å…¥äº† \u003cstrong\u003edelete(åˆ é™¤é”®)\u003c/strong\u003eï¼Œä¸ºä»€ä¹ˆä¸æ˜¯ä¸€ä¸ª \u003cstrong\u003edelete\u003c/strong\u003e å¯¹åº”çš„ ascii (å½“ç„¶ï¼Œè¿™é‡Œè¯·å…ˆå¿½è§†éæ‰“å°å­—ç¬¦çš„é—®é¢˜)ï¼Œè€Œæ˜¯åˆ é™¤äº†æœ€åä¸€ä¸ªå­—ç¬¦å‘¢ï¼Ÿå®Œå…¨å¯ä»¥æƒ³è±¡ï¼Œåæ­£ä»»ä½•é”®ä½ä¸é©±åŠ¨äº¤äº’çš„æ—¶å€™éƒ½æ˜¯ä¼ å…¥ä¸€ä¸²äºŒè¿›åˆ¶ç å˜›ã€‚\u003c/p\u003e\n\u003cp\u003eè¿™é‡Œçš„ \u003ccode\u003esecondary\u003c/code\u003e å®Œæˆçš„å°±æ˜¯æ€ä¹ˆä¸€ä¸ªå·¥ä½œï¼Œ\u003ccode\u003eread_q\u003c/code\u003e å­˜å‚¨çš„æ˜¯æ‰€æœ‰çš„å¤–è®¾(è¿™é‡Œæ˜¯é”®ç›˜)çš„è¾“å…¥ï¼Œå¹¶åŸæ ·å­˜å‚¨ã€‚è€Œåˆ°äº† \u003ccode\u003esecondary\u003c/code\u003e å°±æ˜¯ç»è¿‡ç›¸åº”çš„åŠ å·¥ï¼Œè¯¸å¦‚æ§åˆ¶å­—ç¬¦ä¹‹ç±»çš„éƒ½å±•ç°äº†å„è‡ªçš„æ„ä¹‰ï¼Œå¹¶å®Œæˆä¸€äº›åŠ å·¥å·¥ä½œï¼Œè€Œä¸å†ä»…ä»…åªæ˜¯æ™®é€šåœ°å±•ç¤ºäº†ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eå¦å¤–ï¼Œå¯èƒ½è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚è™½ç„¶æˆ‘ä»¬å·²ç»ä¹ æƒ¯äº†åœ¨å‘½ä»¤è¡Œäº¤äº’æ—¶ï¼Œæ‰€æœ‰çš„è¾“å…¥éƒ½å°†ç›´æ¥åœ¨æ˜¾ç¤ºå™¨ä¸Šè¿›è¡Œå±•ç¤ºï¼Œå¥½åƒæˆ‘ä»¬åœ¨ç›´æ¥å¾€æ˜¾ç¤ºå™¨ä¸Šå†™å†…å®¹ã€‚ä½†æ˜¯ï¼Œå‰é¢æˆ‘ä»¬æè¿°çš„å†…å®¹éƒ½æ˜¯ï¼Œé”®ç›˜è®¾å¤‡ä½œä¸ºè¾“å…¥ï¼Œæ˜¯è¦å†™åˆ° \u003ccode\u003eread_q\u003c/code\u003e ä¹ƒè‡³ \u003ccode\u003esecondary\u003c/code\u003e å¹¶æœ€ç»ˆä½œä¸ºè¿›ç¨‹çš„è¾“å…¥çš„ã€‚åœ¨æ˜¾ç¤ºå™¨ä¸Šæ˜¾ç¤ºå¹¶ä¸æ˜¯å®ƒæœ¬æ¥åº”è¯¥å¹²çš„äº‹æƒ… (æ¯”è¾ƒæ˜¾ç¤ºå™¨ä¸Šå±•ç¤ºçš„åº”è¯¥æ˜¯ \u003ccode\u003ewrite_q\u003c/code\u003e çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹çš„æ ‡å‡†è¾“å‡º)\u003c/p\u003e\n\u003cp\u003eäº‹å®ä¸Šï¼Œè¿™ä»…ä»…åªæ˜¯ä¸€ä¸ªå›æ˜¾ï¼Œå°† \u003ccode\u003esecondary\u003c/code\u003e é˜Ÿåˆ—çš„å†…å®¹å¤åˆ¶äº†ä¸€ä»½åˆ°å†™é˜Ÿåˆ—ï¼Œä¹Ÿå°±å‘ˆç°å‡ºè®©æ˜¾ç¤ºå™¨æ‰“å°ç›¸åº”é”®ç›˜è¾“å…¥çš„æ•ˆæœäº†ã€‚\u003c/p\u003e\n\u003cp\u003eåŒæ—¶ï¼Œè¿™ä¹Ÿå°±èƒ½å¤Ÿç›´æ¥è§£é‡Šä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨ \u003ccode\u003epasswd\u003c/code\u003e, \u003ccode\u003esu\u003c/code\u003e, \u003ccode\u003esudo\u003c/code\u003e ç­‰å‘½ä»¤æ—¶ï¼Œè¦æ±‚è¾“å…¥å¯†ç éƒ½æ˜¯ä¸åœ¨æ˜¾ç¤ºå™¨ä¸Šå›æ˜¾çš„ã€‚å®ç°ä¹Ÿç›¸å½“ç®€å•äº†å˜›ã€‚æŠŠ tty_struct.termios çš„ç›¸åº”æ§åˆ¶å±æ€§ (ECHO) é‡ç½®ï¼Œå°±å¯ä»¥å®ç°ä¸å›æ˜¾çš„æ•ˆæœäº†ã€‚\u003c/p\u003e\n\u003ch3\u003eç»ˆç«¯è®¾å¤‡äº¤äº’\u003c/h3\u003e\n\u003cp\u003eæœ€åä¸€éƒ¨åˆ†ï¼Œåº”è¯¥ä¹Ÿæ˜¯æœ€å…³å¿ƒçš„äº†ã€‚å¤–è®¾å¦‚ä½•ä¸æ“ä½œç³»ç»Ÿå®Œæˆäº¤äº’ã€‚å…¶å®ä¹Ÿèƒ½å¤Ÿæƒ³å¾—åˆ°äº†â€”â€”ä¸­æ–­ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨æ“ä½œç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œå°±æŠŠä¸­æ–­æè¿°ç¬¦è¡¨çš„ä¸­æ–­è¡¨é¡¹é…ç½®å¾—å½“ã€‚ä¹‹åçš„äº‹æƒ…å°±æ˜¯ç­‰å¾…é”®ç›˜ç­‰å¤–è®¾è¾“å…¥çš„ä¸­æ–­ä¿¡å·äº†ã€‚\u003c/p\u003e\n\u003cp\u003eåˆçœ‹å›åˆ°äº† \u003ccode\u003einit/main.c\u003c/code\u003e ç¨‹åº\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003evoid main(void)\n{\n    ...\n    trap_init();\n    blk_dev_init();\n    chr_dev_init(); /* å—è®¾å¤‡ç›¸å…³åˆå§‹åŒ–, æ–¹æ³•ä½“æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰å®ç° */\n    tty_init();     /* tty ç»ˆç«¯è®¾å¤‡åˆå§‹åŒ– */\n    time_init();\n    sched_init();\n    buffer_init(buffer_memory_end);\n    ...\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003e/**\n * Copied from kernel/chr_drv/tty_io.c\n * ç»ˆç«¯è®¾å¤‡åˆè¯†åŒ–\n */\nvoid tty_init(void)\n{\n    /** ä¸²å£è®¾å¤‡åˆå§‹åŒ– */\n    rs_init();\n    /** æ§åˆ¶å°è®¾å¤‡åˆå§‹åŒ– */\n    con_init();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè‡³äºä¸ºä»€ä¹ˆæœ‰ä¸¤ç§åˆå§‹åŒ–æ–¹å¼ã€‚è¿™æ¥æºäºç»ˆç«¯åˆåŒºåˆ†ä¸ºæ§åˆ¶å°ç»ˆç«¯ä¸ä¸²å£ç»ˆç«¯ï¼ŒåŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯ç›´æ¥å»ºç«‹åœ¨ä¸»æœºä¸Šï¼Œä¸²å£ç»ˆç«¯æ˜¯é€šè¿‡ä¸²è¡Œæ¥å£è¿æ¥åˆ°ä¸»æœºçš„ã€‚å½“ç„¶ï¼Œè¿™éƒ½æ˜¯å¤è€çš„æ–¹å¼äº†ï¼Œç»†èŠ‚å°±ä¸å¤ªæ¸…æ¥šäº†ã€‚\u003c/p\u003e\n\u003cp\u003eä¸‹é¢æ¥çœ‹çœ‹ \u003ccode\u003econ_init()\u003c/code\u003e åšäº†å“ªäº›å·¥ä½œ(\u003ccode\u003ers_init()\u003c/code\u003e çš„å†…å®¹è¯·è‡ªè¡Œäº†è§£)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003evoid con_init(void)\n{\n    register unsigned char a;\n    char *display_desc = \"????\";\n    char *display_ptr;\n\n    /**\n     * è¯»å– setup.s ç¨‹åºé¢„å¤„ç†çš„å†…å®¹\n     * åŒ…æ‹¬æ˜¾ç¤ºå™¨çš„å„ç§é…ç½®å‚æ•°\n     */\n    video_num_columns = ORIG_VIDEO_COLS;\n    video_size_row = video_num_columns * 2;\n    video_num_lines = ORIG_VIDEO_LINES;\n    video_page = ORIG_VIDEO_PAGE;\n    video_erase_char = 0x0720;\n\n    /**\n     * è¯»å–æ˜¾ç¤ºå™¨çš„é…ç½®å¹¶è¿›è¡Œç›¸å…³è®¾ç½® (çœç•¥ä»£ç )\n     */\n    ...\n\n    origin  = video_mem_start;\n    scr_end = video_mem_start + video_num_lines * video_size_row;\n    top = 0;\n    bottom  = video_num_lines;\n\n    gotoxy(ORIG_X,ORIG_Y);\n    /** è®¾ç½®é™·é˜±é—¨ */\n    set_trap_gate(0x21,\u0026#x26;keyboard_interrupt);\n    outb_p(inb_p(0x21)\u0026#x26;0xfd,0x21);\n    a=inb_p(0x61);\n    outb_p(a|0x80,0x61);\n    outb(a,0x61);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåº”è¯¥èƒ½å¤Ÿçœ‹åˆ°æœ€é‡è¦çš„å†…å®¹å°±æ˜¯\u003cstrong\u003eè®¾ç½®é”®ç›˜ä¸­æ–­é™·é˜±é—¨\u003c/strong\u003eäº†ã€‚\u003c/p\u003e\n\u003cp\u003eä¹‹ååªæœ‰é™é™åœ°ç­‰å¾…é”®ä½æ•²å‡»ï¼Œä¹Ÿå°±èƒ½å¤Ÿäº§ç”Ÿç¡¬ä»¶ä¸­æ–­ï¼Œä»è€Œè®© \u003ccode\u003eread_q\u003c/code\u003e è·å¾—åˆ°ç›¸åº”çš„å­—ç¬¦è¾“å…¥ã€‚\u003c/p\u003e\n\u003cp\u003eè‡³äºé”®ç›˜ä¸­æ–­çš„ç›¸åº”å¤„ç†æµç¨‹ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚ç®€è¿°ä¸€äº›æ­¥éª¤:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eäº§ç”Ÿç¡¬ä¸­æ–­ \u003ccode\u003ekeyboard_interrupt\u003c/code\u003eï¼Œç”±ç¨‹åº \u003ccode\u003eKeyboard.s\u003c/code\u003e çš„æ±‡ç¼–ä»£ç è¿›è¡Œå¤„ç†\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eæ ¹æ®ä¸åŒçš„é”®ç›˜(US é”®ç›˜ã€å¾·å¼é”®ç›˜ç­‰ç­‰)å°†è·å¾—çš„é”®ä½ä¿¡å·è¿›è¡Œç›¸åº”çš„å­—ç¬¦è½¬æ¢(æŸ¥è½¬æ¢è¡¨)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eè°ƒç”¨ \u003ccode\u003edo_tty_interrupt\u003c/code\u003e å¤„ç†å‡½æ•° (ç¡®è®¤æ˜¯ç»™å“ªä¸ªç»ˆç«¯çš„ä¿¡å·)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eè°ƒç”¨ \u003ccode\u003ecopy_to_cooked(tty)\u003c/code\u003e ï¼Œå³å®Œæˆ \u003ccode\u003eread_q\u003c/code\u003e åˆ° \u003ccode\u003esecondary\u003c/code\u003e çš„ç›¸å…³åŠ å·¥ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e"},"buildId":"0kzTAuvoPaNQCLzaNLnfP","dynamicBuildId":false,"assetPrefix":"https://www.ffutop.com/blog","nextExport":true}</script><script async="" id="__NEXT_PAGE__/post" src="https://www.ffutop.com/blog/_next/static/0kzTAuvoPaNQCLzaNLnfP/pages/post.js"></script><script async="" id="__NEXT_PAGE__/_app" src="https://www.ffutop.com/blog/_next/static/0kzTAuvoPaNQCLzaNLnfP/pages/_app.js"></script><script src="https://www.ffutop.com/blog/_next/static/runtime/webpack-8ed9452df514b4d17d80.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/chunks/commons.7e5e68e72610ac3a4255.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/chunks/styles.e15adcc4edd7c21ed4d5.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/runtime/main-fd73dbd6f398b7b886ec.js" async=""></script></body></html>