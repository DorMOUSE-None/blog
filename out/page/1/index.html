<!DOCTYPE html><html><head><meta charSet="utf-8" class="next-head"/><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" class="next-head"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/fE8MAaKO9Spaap-vhmcxA/pages/index.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/fE8MAaKO9Spaap-vhmcxA/pages/_app.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/runtime/webpack-8ed9452df514b4d17d80.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/chunks/commons.ca07934498d0c5523bf5.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/chunks/styles.b54d8442e6b63c30cad4.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/runtime/main-3daabeb1dde7624c7fe0.js" as="script"/><link rel="stylesheet" href="https://www.ffutop.com/blog/_next/static/css/commons.a1d4ae30.chunk.css"/><link rel="stylesheet" href="https://www.ffutop.com/blog/_next/static/css/styles.f85dcf60.chunk.css"/></head><body><div id="__next"><header class="component-header"><h1 class="title">ffutop</h1><ul class="nav-items"><li><a href="/blog/index">åšå®¢</a></li><li><a href="/blog/archives">å½’æ¡£</a></li><li><a href="/blog/tags">æ ‡ç­¾</a></li><li><a href="/blog/about">å…³äº</a></li></ul></header><div><main class="main"><div><h1>Spring JDBC æºç å­¦ä¹ </h1><div><h2>æ¦‚è§ˆ</h2>
<p>åœ¨å­¦ä¹  Spring-JDBC ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦ä» Java åŸç”Ÿæä¾›çš„ JDBC å¼€å§‹ï¼Œå¯¹ JDBC æ“ä½œçš„ä¸€æ•´å¥—å®Œæ•´çš„æµç¨‹æœ‰ä¸€ä¸ªæ¸…æ™°çš„æ¦‚å¿µã€‚</p></div></div><div><h1>åŒºå—é“¾æŠ€æœ¯æ¦‚è¿°</h1><div><p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fs8oc4ri7qj30mq055aap.jpg" alt="åŒºå—é“¾ç®€å•ç»“æ„"></p>
<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1foxcpmmpfhj31kw107n2e.jpg" alt="Merkle tree"></p></div></div><div><h1>ASM - ClassReader ä¸ Java ClassFile æ–‡ä»¶æ ¼å¼</h1><div><h2>Java ClassFile æ–‡ä»¶æ ¼å¼</h2>
<p>è¯»äº†å°†è¿‘ä¸€å‘¨çš„æ—¶é—´ï¼Œå‹‰å¼ºç®—æ˜¯æŠŠ ClassFile çš„æ–‡ä»¶æ ¼å¼ç»™ç®€å•çš„æ¢³ç†äº†ä¸ªè„‰ç»œã€‚
<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html">The class File Format(Java SE 8)</a> </p>
<blockquote>
<p>u1, u2, u4 åˆ†åˆ«è¡¨ç¤ºæ— ç¬¦å·çš„ä¸€å­—èŠ‚ã€äºŒå­—èŠ‚ã€å››å­—èŠ‚æ•°æ®(ä»¥å¤§ç«¯å­˜å‚¨)</p>
</blockquote>
<pre><code class="language-c++">ClassFile {
    u4             magic;                                   // é­”æ•°(magic) å›ºå®šä¸º 0xCAFEBABE
    u2             minor_version;                           // æ¬¡ç‰ˆæœ¬å·
    u2             major_version;                           // ä¸»ç‰ˆæœ¬å·
    u2             constant_pool_count;                     // å¸¸é‡æ±  constant_pool çš„æ•°é‡ + 1, æœ€å¤§ä¸º (2&#x3C;&#x3C;16 - 1) = 65535
    cp_info        constant_pool[constant_pool_count-1];    // å¸¸é‡æ±  å–å€¼ä¸‹æ ‡ä¸º [1, constant_pool_count)
    u2             access_flags;                            // å¯¹ç±» or æ¥å£çš„è®¿é—®æƒé™å’Œå±æ€§çš„æ ‡å¿—çš„æ©ç 
    u2             this_class;                              // å€¼ä¸º constant_pool çš„æœ‰æ•ˆä¸‹æ ‡(ä¸” constant_pool[this_class] çš„ç±»å‹ä¸º CONSTANT_Class_info)
    u2             super_class;                             // å€¼ä¸º 0 æˆ–è€… constant_pool çš„æœ‰æ•ˆä¸‹æ ‡(åŒä¸Š), å¦‚æœæ˜¯ interface, åˆ™è¯¥å€¼ä¸€å®šä¸ºæœ‰æ•ˆä¸‹æ ‡
    u2             interfaces_count;                        // ç›´æ¥çˆ¶æ¥å£çš„æ•°é‡
    u2             interfaces[interfaces_count];            // å€¼å¿…é¡»æ˜¯ constant_pool çš„æœ‰æ•ˆä¸‹æ ‡, ä¸” interfaces[i](0â‰¤i&#x3C;interfaces_count), æŒ‡å‘çš„ç±»å‹ä¸º CONSTANT_Class_info)
    u2             fields_count;                            // å­—æ®µæ•°é‡, ç»Ÿè®¡æ‰€æœ‰å­—æ®µ, åŒ…æ‹¬ class variables(é™æ€å˜é‡) å’Œ instance variables(å®ä¾‹å˜é‡)
    field_info     fields[fields_count];                    // å­—æ®µçš„è¯¦ç»†å£°æ˜, ä¸åŒ…å«ç»§æ‰¿æ¥çš„å­—æ®µ
    u2             methods_count;                           // æ–¹æ³•æ•°é‡
    method_info    methods[methods_count];                  // æ–¹æ³•çš„è¯¦ç»†å£°æ˜, ä¸åŒ…æ‹¬ç»§æ‰¿æ¥çš„æ–¹æ³•
    u2             attributes_count;                        // å±æ€§æ•°é‡
    attribute_info attributes[attributes_count];            // å±æ€§çš„è¯¦ç»†å£°æ˜
}
</code></pre></div></div><div><h1>java-memory-model</h1><div><h2>JVM è¿è¡Œæ—¶æ•°æ®åŒº</h2>
<p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1ft5osi6it1j31kw0ql78e.jpg"></p></div></div><div><h1>ASM æ ¸å¿ƒåŒ…åŸºæœ¬å†…å®¹æ¼«è°ˆ</h1><div><blockquote>
<p>æœ¬æ–‡æè¿°çš„ ASM æŒ‡çš„æ˜¯ OW2 ASM</p>
</blockquote>
<h2>ASM-Core çš„ç»“æ„</h2>
<p><em>é¦–å…ˆæ˜¯ä¸€äº›æ¦‚è¿°æ€§çš„å†…å®¹ã€‚</em></p>
<p>ç”±äº ASM æ“ä½œçš„ JAVA å­—èŠ‚ç æœ‰ä¸¥æ ¼çš„æ ¼å¼è§„å®šï¼Œä¸”å³ä½¿éšç€ JVM æ ‡å‡†çš„å‡çº§ä¹Ÿæå°‘å‡ºç°é‡å¤§è°ƒæ•´ã€‚
å› æ­¤é€‚ç”¨é¢ç‹­çª„çš„è®¿é—®è€…æ¨¡å¼åœ¨è¯¥é¡¹ç›®ä¸­è¢«å¤§é‡åœ°ä½¿ç”¨ï¼Œå¹¶ä¸”å·²ç»åˆ°äº†ä¸§å¿ƒç—…ç‹‚çš„ç¨‹åº¦:)</p>
<p>ä»æ ¸å¿ƒåŒ…å£°æ˜çš„ç±»æ¥çœ‹ï¼Œä¸»è¦åŒ…æ‹¬:</p>
<ol>
<li>
<p>ClassReader - ä½œä¸ºç»“æ„åŒ–å¯¹è±¡ï¼Œå°†æ¥æ”¶(accept)è®¿é—®è€…çš„è®¿é—®</p>
</li>
<li>
<p>å‡ ç§è®¿é—®è€…æŠ½è±¡ç±»ä»¥åŠç›¸åº”çš„å®ç°ç±»</p>
</li>
</ol>
<ul>
<li>AnnotationVisitor -> AnnotationWriter</li>
<li>ClassVisitor -> ClassWriter</li>
<li>FieldVisitor -> FieldWriter</li>
<li>MethodVisitor -> MethodWriter</li>
<li>ModuleVisitor -> ModuleWriter</li>
</ul>
<ol start="3">
<li>
<p>Opcodes &#x26; Constants - ClassFile ä¸­æè¿°çš„å¤§é‡å¸¸é‡ç¬¦å·ä¸å€¼</p>
</li>
<li>
<p>å…¶å®ƒä¸€äº›è¾…åŠ©çš„ç±»</p>
</li>
</ol>
<ul>
<li>Attribute - ç”¨äºå¤„ç†éæ ‡å‡†åŒ–çš„å±æ€§(ClassFile å…è®¸<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html">JVMS</a> ä¸­æœªå®šä¹‰çš„ Attribute)</li>
<li>ByteArray - åŠ¨æ€å¯è‡ªé€‚åº”çš„ byte[] (å­—èŠ‚æ•°ç»„)</li>
<li>Context - ClassReader åœ¨è¢«è§£æ(è¢«è®¿é—®)è¿‡ç¨‹ä¸­ç”¨äºè¡¨ç¤ºâ€œç´¯ç§¯çŠ¶æ€â€çš„ä¸€ä¸ªç±»/å¯¹è±¡</li>
<li>Symbol - ç”¨äºè¡¨ç¤º ClassFile ä¸­æè¿°çš„ Constant çš„åŸºç±»</li>
<li>SymbolTable - ç”¨äºå­˜å‚¨å¸¸é‡æ± å¯¹è±¡</li>
<li>å…¶å®ƒå†…å®¹çœç•¥</li>
</ul></div></div><div><h1>ASM-VerifyErroré”™è¯¯ä¿¡æ¯è§£å†³</h1><div><h2>æŠ¥é”™ä¿¡æ¯</h2>
<pre><code class="language-java">java.lang.VerifyError: class net.sf.cglib.core.DebuggingClassWriter overrides final method visit.(IILjava/lang/String;Ljava/lang/String;Ljava/lang/String;[Ljava/lang/String;)V
</code></pre></div></div><div><h1>Java å®‰å…¨è®¿é—®ä¸æƒé™æ§åˆ¶</h1><div><h2>ç»ªè®º</h2>
<p><em>æœ¬æ–‡åªæ˜¯å¯¹ Java å®‰å…¨è®¿é—®ä¸æƒé™æ§åˆ¶çš„åŸºç¡€æ€§æ¢ç©¶ã€‚</em></p>
<p><strong>æœ¬èŠ‚ä¸å…¨æ–‡å†…å®¹æ— å…³ï¼Œå¦‚æ— å…´è¶£é˜…è¯»ï¼Œå¯ä»¥è·³è¿‡</strong></p>
<p>äº†è§£ Java å®‰å…¨è®¿é—®ç›¸å…³å†…å®¹çš„åˆè¡·ï¼Œæ˜¯å‡†å¤‡åœ¨é¡¹ç›®ä¸­åˆ©ç”¨ Java æ ‡å‡†åº“æä¾›çš„ ServiceLoader å¯¹ SPI å®ç°ç±»è¿›è¡Œ"è‡ªåŠ¨å‘ç°"å’ŒåŠ è½½ã€‚
è¿™å¯¹äºå°†æœ¬é¡¹ç›®ä½œä¸ºäºŒæ–¹åº“æ¥ä¾èµ–çš„ä¸Šå±‚é¡¹ç›®å°†æ›´ä¸ºæ–¹ä¾¿ï¼Œåªéœ€è¦
1. åœ¨ <code>META-INF.services</code> ç›®å½•ä¸‹é…ç½®è¢«å‘½åä¸º SPI æ¥å£å…¨é™å®šåçš„æ–‡ä»¶åŠæ·»åŠ ç›¸å…³å†…å®¹
2. ç”±é¡¹ç›®çš„æ³¨å†Œç®¡ç†å™¨è§¦å‘ä¸‹åˆ— Java ä»£ç </p>
<pre><code class="language-java">{
    ServiceLoader&#x3C;XxxPolicy> xxxPolicyServiceLoader = ServiceLoader.load(XxxPolicy.class);
    for (Iterator&#x3C;XxxPolicy> it = xxxPolicyServiceLoader.iterator(); it.hasNext(); ) {
        XxxPolicy xxxPolicy = it.next();
        // ... more code ...
    }
}
</code></pre>
<p>å°±å¯ä»¥å®Œæˆä¸€ä¸ªæ–°çš„ SPI ç­–ç•¥çš„æ³¨å†Œå·¥ä½œã€‚</p>
<p>ä½†æ˜¯ï¼Œåœ¨å°è¯•å®ç°ï¼Œäº†è§£äº† ServiceLoader æºç ï¼Œä»¥åŠ DriverManager å’Œ mysql-connection-java-.jar åœ¨æ³¨å†Œ Driver ç›¸å…³çš„ä»£ç ã€‚
å‘ç°æ€ä¹ˆä¹Ÿç»•ä¸å¼€ Java å®‰å…¨è®¿é—®ç›¸å…³çš„å†…å®¹ã€‚è¯¸å¦‚ä¸‹åˆ—è¿™æ®µæ¥è‡ª DriverManager.loadInitialDrivers() çš„ä»£ç :</p>
<pre><code class="language-java">AccessController.doPrivileged(new PrivilegedAction&#x3C;Void>() {
    public Void run() {

        ServiceLoader&#x3C;Driver> loadedDrivers = ServiceLoader.load(Driver.class);
        Iterator&#x3C;Driver> driversIterator = loadedDrivers.iterator();

        try{
            while(driversIterator.hasNext()) {
            driversIterator.next();
            }
        } catch(Throwable t) {
                // Do nothing
        }
        return null;
    }
});
</code></pre>
<p>è¯¸å¦‚ AccessController, Permission, SecurityManager çš„ä»£ç å§‹ç»ˆæ˜¯ä¸€ä¸ªç»•ä¸å¼€çš„ä¸»æ—‹å¾‹ã€‚</p>
<p>ä¸ºäº†æ¢ç©¶è¿™éƒ¨åˆ†æ§åˆ¶å¯¹é¡¹ç›®ä¸­ ServiceLoader çš„çœŸæ­£ä½œç”¨ä»¥åŠå…¶ç¼–ç æ„ä¹‰ï¼Œå¼€å§‹äº†å¯¹æœ¬æ–‡æ‰€æè¿°çš„ä¸»ä½“å†…å®¹çš„åˆæ­¥äº†è§£ã€‚</p></div></div><div><h1>CGlib Enhancer ä¸»æµç¨‹æºç è§£æ</h1><div><h2>å‰è¨€</h2>
<p>æ­¤åšæ–‡å†™ä½œçš„ç›®çš„: </p>
<ul>
<li>(Core) é€šè¿‡äº†è§£ CGlib Enhancer çš„æ•´ä¸ªè°ƒç”¨é“¾ï¼Œäº†è§£å…¶å¯¹äºå”¯ä¸€ä¾èµ–çš„ ASM åº“çš„è°ƒç”¨æ–¹å¼ã€‚</li>
<li>åŸºäº Enhancer å¯¹å·²æœ‰å­—èŠ‚ç è¿›è¡Œå¢å¼ºçš„è¿›ä¸€æ­¥ç†è§£ä¸æŒæ¡ã€‚</li>
</ul></div></div><div><h1>å¦‚ä½•æ–¹ä¾¿åœ°è·å– CGlib ç”Ÿæˆç±»</h1><div><h2>é…ç½®å‚æ•°</h2>
<p><strong>å‘½ä»¤è¡Œä½¿ç”¨</strong></p>
<p>åœ¨ java å¯åŠ¨å‘½ä»¤ä¸­æ·»åŠ å‚æ•°é…ç½®é¡¹ <code>-Dcglib.debugLocation=&#x3C;Custom Path></code></p>
<p><strong>ç¼–ç å®ç°</strong></p>
<p>åœ¨æ‰§è¡Œ CGlib è·å–æ–°ç”Ÿæˆç±»ä¹‹å‰ï¼Œè°ƒç”¨ <code>System.setProperty("cglib.debugLocation", &#x3C;Custom Path>)</code></p></div></div><div><a href="/page/NaN">ä¸Šä¸€é¡µ</a><a href="/page/NaN">ä¸‹ä¸€é¡µ</a></div></main><footer class="footer">ffutop Â© <!-- -->2019<!-- -->, Built with<a href="https://reactjs.org/">React</a></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{}},"page":"/","query":{"mdDatasParts":[{"url":"2018-01-15-Spring-JDBC-Code-Reading","fileName":"2018-01-15-Spring-JDBC-Code-Reading.md","title":"Spring JDBC æºç å­¦ä¹ ","author":"fangfeng","date":"2018-01-15T00:00:00.000Z","tags":["Spring","JDBC"],"content":"\u003ch2\u003eæ¦‚è§ˆ\u003c/h2\u003e\n\u003cp\u003eåœ¨å­¦ä¹  Spring-JDBC ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦ä» Java åŸç”Ÿæä¾›çš„ JDBC å¼€å§‹ï¼Œå¯¹ JDBC æ“ä½œçš„ä¸€æ•´å¥—å®Œæ•´çš„æµç¨‹æœ‰ä¸€ä¸ªæ¸…æ™°çš„æ¦‚å¿µã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e/**\n * copied from https://www.tutorialspoint.com/jdbc/jdbc-sample-code.htm\n * updated by DorMOUSENone\n */\n\n//STEP 1. å¼•å…¥å¿…é¡»çš„åŒ…\nimport java.sql.*;\n\npublic class Example {\n    // JDBC é©±åŠ¨å ä¸ DB URL \n    static final String JDBC_DRIVER = \"com.mysql.jdbc.Driver\";  \n    static final String DB_URL = \"jdbc:mysql://\u0026#x3C;host\u003e:\u0026#x3C;port\u003e/\u0026#x3C;dbName\u003e\";\n\n    // æ•°æ®åº“ç™»å½•éªŒè¯ (ç”¨æˆ·åã€å¯†ç ç­‰)\n    static final String USER = \"username\";\n    static final String PASS = \"password\";\n   \n    public static void main(String[] args) {\n        Connection conn = null;\n        Statement stmt = null;\n        try{\n            //STEP 2: æ³¨å†Œé©±åŠ¨(æ³¨å†Œåˆ°é©±åŠ¨ç®¡ç†å™¨ DriverManager ç±»ä¸­)\n            Class.forName(\"com.mysql.jdbc.Driver\");\n\n            //STEP 3: åˆ›å»ºä¸€ä¸ªè¿æ¥\n            System.out.println(\"Connecting to database...\");\n            conn = DriverManager.getConnection(DB_URL,USER,PASS);\n\n            //STEP 4: æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢\n            System.out.println(\"Creating statement...\");\n            stmt = conn.createStatement();\n            String sql;\n            sql = \"SELECT id, first, last, age FROM Employees\";\n            ResultSet rs = stmt.executeQuery(sql);\n\n            //STEP 5: å°†ç»“æœä»ç»“æœé›†(ResultSet)ä¸­å–å‡º\n            while(rs.next()){\n                //æ ¹æ®åˆ—åé€ä¸€å–å‡ºæ•°æ®\n                int id  = rs.getInt(\"id\");\n                int age = rs.getInt(\"age\");\n                String first = rs.getString(\"first\");\n                String last = rs.getString(\"last\");\n\n                //å±•ç¤ºç»“æœ\n                System.out.print(\"ID: \" + id);\n                System.out.print(\", Age: \" + age);\n                System.out.print(\", First: \" + first);\n                System.out.println(\", Last: \" + last);\n            }\n            //STEP 6: æ¸…ç†ç¯å¢ƒ\n            rs.close();\n            stmt.close();\n            conn.close();\n        }catch(SQLException se){\n            //å¤„ç† JDBC é”™è¯¯\n            se.printStackTrace();\n        }catch(Exception e){\n            //å¤„ç† Class.forName() å¼•èµ·çš„é”™è¯¯\n            e.printStackTrace();\n        }finally{\n            // finally ä»£ç åº“æ¥å…³é—­èµ„æº\n            try{\n                if(stmt!=null)\n                    stmt.close();\n            }catch(SQLException se2){\n            }// ä¸åšä»»ä½•å¤„ç†\n            try{\n                if(conn!=null)\n                    conn.close();\n            }catch(SQLException se){\n                se.printStackTrace();\n            }\n        }\n        System.out.println(\"Goodbye!\");\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä»ä¸Šé¢çš„é€šç”¨ JDBC ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåˆ©ç”¨ Java åŸç”Ÿæä¾›çš„ java.sql.* åŒ…å¯ä»¥å®Œæˆæ³¨å†Œé©±åŠ¨ï¼Œåˆ›å»ºè¿æ¥ï¼Œæ‰§è¡ŒæŸ¥è¯¢ï¼Œå¤„ç†ç»“æœç­‰ä¸€ç³»åˆ—ä¸€æ•´å¥—æ“ä½œã€‚\u003c/p\u003e\n\u003cp\u003eè€Œ Spring-JDBC å¯¹äº Java åŸç”Ÿæä¾›çš„ JDBC ï¼Œå¯¹ä¸€ç³»åˆ—æ•°æ®åŠæ“ä½œè¿›è¡Œäº†æ•´åˆï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå®ç°äº† DataSource æ¥å£ï¼Œç”¨äºæ•´åˆæ•°æ®æºé…ç½®ï¼Œå°†å„ç§é›¶æ•£çš„å±æ€§å€¼ï¼ˆè¯¸å¦‚ URLã€ç”¨æˆ·åã€ å¯†ç ç­‰ï¼‰æ•´åˆæˆå®Œæ•´çš„ä¸€ä¸ªå¯¹è±¡ï¼Œä¾¿äºé‡ç”¨ï¼›ä¹Ÿå®ç°äº† getConnection(â€¦) æ¥å£ï¼Œä¾¿äºç›´æ¥é€šè¿‡ DataSource è·å–è¿æ¥ã€‚\u003c/li\u003e\n\u003cli\u003eå¯¹æ‰§è¡ŒæŸ¥è¯¢çš„æµç¨‹è¿›è¡Œäº†å°è£…ã€‚\u003c/li\u003e\n\u003cli\u003eå¯¹ç»“æœé›†çš„å¤„ç†æä¾›äº†å¤šç§æ¥å£ï¼Œé’ˆå¯¹ä¸åŒçš„åº”ç”¨åœºæ™¯å¯è‡ªç”±é€‰æ‹©æ‰€å¿…é¡»çš„å®ç°ç±»ã€‚ä¾‹å¦‚ç›´æ¥é€šè¿‡ JDBC è·å¾— Bean ï¼Œè€Œæ— éœ€å¦‚ä¸Šä¾‹ 39-42 è¡Œæ‰€ç¤ºï¼Œé€ä¸€ç¼–ç è¿›è¡Œæå–ã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eæœ¬èŠ‚æä¾›å¯¹ã€ŠSpring-JDBC æºç å­¦ä¹ ã€‹å®Œæ•´å­¦ä¹ è¿‡ç¨‹çš„ä¸€ä¸ªæ¢³ç†ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"http://blog.csdn.net/dormousenone/article/details/79035440\"\u003eJdbcTemplate\u003c/a\u003e ä¸€èŠ‚ä½œä¸ºå­¦ä¹  Spring-jdbc çš„åˆ‡å…¥ç‚¹ï¼Œæ˜¯ org.springframework.jdbc.core åŒ…ä¸­çš„æ ¸å¿ƒç±»ï¼Œæ˜¯ä¸€ä¸ªæä¾›ä¸åŒåœºæ™¯ä¸‹æ•°æ®åº“æ“ä½œçš„æ¨¡æ¿ç±»ã€‚ä¸»è¦æè¿°å…¶æŒæœ‰çš„å±æ€§ DataSource ç­‰ä»¥åŠå…¶å®ç°çš„æ–¹æ³•ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://blog.csdn.net/dormousenone/article/details/79037012\"\u003eDataSource\u003c/a\u003e ä¸€èŠ‚æ‰¿æ¥ JdbcTemplate ä¸€èŠ‚ï¼Œæä¾› Spring-jdbc å¯¹æ•°æ®æºçš„ä¸€ä¸ªåŒ…è£…ä¸åº”ç”¨ã€‚åŒæ—¶æè¿°å…¶æ ¸å¿ƒæ–¹æ³• getConnection(â€¦) çš„å®ç°ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://blog.csdn.net/dormousenone/article/details/79042212\"\u003eDriverManager\u003c/a\u003e æè¿°å…¶å¯¹ä¸åŒæ•°æ®åº“ä¾›åº”å•†æä¾›çš„é©±åŠ¨çš„ç®¡ç†ä¸ä½¿ç”¨æ–¹æ³•ã€‚åŒæ—¶ç®€å•æè¿°é€šè¿‡å…·ä½“é©±åŠ¨è·å¾—ä¸€ä¸ªè¿æ¥çš„å®ç°ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://blog.csdn.net/dormousenone/article/details/79046865\"\u003ePreparedStatement \u0026#x26; CallableStatement\u003c/a\u003e ä¸€èŠ‚ä¸»è¦è¡¨è¿° Spring-jdbc å¦‚ä½•å¯¹æ‰§è¡ŒæŸ¥è¯¢çš„æµç¨‹è¿›è¡Œäº†å°è£…ã€‚ç‰¹åˆ«æ˜¯å¯¹äº PreparedStatement ä¸ CallableStatement è¿™ç±»é¢„ç½®å¯å˜ SQL è¯­å¥ï¼Œåœ¨æ‰§è¡Œå‰å¿…é¡»å¯¹å…¶ä¸­å¯å˜å‚æ•°è¿›è¡Œè¡¥å…¨çš„ Statement ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://blog.csdn.net/dormousenone/article/details/79062275\"\u003eResultSet\u003c/a\u003e æè¿° Spring-jdbc å¦‚ä½•å¯¹ç»“æœé›†è¿›è¡Œå¤„ç†ï¼Œæä¾›äº†å¤šç§ä¸åŒçš„æ¥å£å®ç°ä¸åŒçš„å¤„ç†é€»è¾‘ã€‚è¿™ç§å°è£…åçš„æ“ä½œå¯ä»¥æå¤§åœ°ç®€åŒ–ç›´æ¥ä½¿ç”¨ Java åŸç”Ÿ JDBC æ‰€å¿…é¡»çš„ç¡¬ç¼–ç æå–æ•°æ®çš„é—®é¢˜ã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003eJdbcTemplate\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"https://ws2.sinaimg.cn/large/006tNc79gy1fn90ghu9ufj30ki0jm75t.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eJdbcTemplate ç±»ä½œä¸º org.springframework.core åŒ…ä¸‹çš„æ ¸å¿ƒç±»ï¼Œå¯¹ Java å®ç°çš„ JDBC è¿›è¡Œäº†ä¸€å®šç¨‹åº¦çš„å°è£…ï¼Œå¯ä»¥ç®€åŒ– JDBC çš„ä½¿ç”¨ï¼ŒåŒæ—¶é¿å…è®¸å¤šå¸¸è§çš„é”™è¯¯ã€‚ç”±è¯¥ç±»æ¥æ‰§è¡Œ JDBC å·¥ä½œæµï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦æä¾› SQL è¯­å¥å°±å¯ä»¥è·å¾— DB æ‰§è¡Œç»“æœï¼ˆğŸ˜€ï¼Œå½“ç„¶å®é™…æ“ä½œä¸Šæ²¡æœ‰æè¿°çš„è¿™ä¹ˆç®€å•ï¼‰ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä½¿ç”¨ JdbcTemplate ç±»åªéœ€è¦å®ç°ä¸¤ä¸ªå›è°ƒæ¥å£ PreparedStatementCreator (åˆ›å»ºä¸€ä¸ª PreparedStatementï¼Œç»™å®šè¿æ¥ï¼Œæä¾› SQL è¯­å¥ä»¥åŠå¿…è¦çš„å‚æ•°), ResultSetExtractor (ç”¨äºèŠ±å¼è·å–ç»“æœé›†)ã€‚å½“ç„¶ï¼Œä¸å®ç°ä¸Šè¿°ä¸¤ä¸ªæ¥å£ä¹Ÿå¯ä»¥è¿›è¡Œç®€å•çš„æ•°æ®åº“æ“ä½œï¼Œæ¯”å¦‚åªé€šè¿‡ JdbcTemplate è·å–ä¸€ä¸ªè¿æ¥(Connection) æˆ–è€…æ‰§è¡Œä¸€ä¸ªé™æ€ SQL Updateã€‚\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eçœ‹ä¸æ‡‚æ— æ‰€è°“ï¼Œå…ˆç»§ç»­å‘ä¸‹çœ‹ï¼Œä¼šåšæ›´è¯¦ç»†çš„è®²è§£ã€‚\u003c/em\u003e\u003c/p\u003e\n\u003ch3\u003eJdbcAccessor\u003c/h3\u003e\n\u003cp\u003eé¦–å…ˆäº†è§£ JdbcTemplate çš„å®ç°ï¼ŒJdbcTemplate ç»§æ‰¿äº† JdbcAccessor æŠ½è±¡ç±»ï¼Œè¯¥æŠ½è±¡ç±»æœ‰ä¸¤ä¸ªä¸»è¦å±æ€§â€”â€” \u003cstrong\u003eDataSource dataSource\u003c/strong\u003e \u0026#x26; \u003cstrong\u003eSQLExceptionTranslator exceptionTranslator\u003c/strong\u003e ï¼Œä»¥åŠä¸€ä¸ªæ‡’åŠ è½½æ ‡è¯†ç¬¦ \u003cstrong\u003elazyInit\u003c/strong\u003e ã€‚\u003c/p\u003e\n\u003cp\u003eå…¶ä¸­ï¼Œ\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eDataSource å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªå­˜å‚¨æœ‰ä¸æ•°æ®åº“ç›¸å…³çš„å±æ€§å®ä¾‹ï¼Œä¸»è¦æ–¹æ³•åŒ…æ‹¬ \u003ccode\u003eConnection getConnection()\u003c/code\u003e \u0026#x26; \u003ccode\u003eConnection getConnection(String username, String password)\u003c/code\u003e ã€‚\u003c/li\u003e\n\u003cli\u003eSQLExceptionTranslator åˆ©ç”¨ç­–ç•¥æ¨¡å¼å°† Java å®šä¹‰çš„ SQLException è½¬æ¢æˆ Spring å£°æ˜çš„ DataAccessExceptionã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eJdbcAccessor å®ç°çš„ InitializingBean æ¥å£ï¼ŒInitializingBean æ¥å£ä¸º Bean æä¾›äº†ä¸€ä¸ªåˆå§‹åŒ–å®ä¾‹çš„æ–¹æ³• â€”â€” afterPropertiesSet() æ–¹æ³•ï¼Œå‡¡æ˜¯ç»§æ‰¿è¯¥æ¥å£çš„ç±»ï¼Œä¸€èˆ¬éƒ½åœ¨ç±»æ„é€ æ–¹æ³•ä¸­æ‰§è¡Œè¯¥æ–¹æ³•ã€‚åŒæ ·çš„ï¼Œå£°æ˜åˆå§‹åŒ–å®ä¾‹è°ƒç”¨çš„æ–¹æ³•è¿˜å¯é‡‡ç”¨ \u003ccode\u003e\u0026#x3C;bean id=\"\" class=\"\" init-method=\"myInitMethod\"/\u003e\u003c/code\u003e åœ¨åˆå§‹åŒ– bean æ—¶æ‰§è¡Œ myInitMethod() æ–¹æ³•ã€‚å…·ä½“æ‰§è¡Œé¡ºåºä¸º ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003ebean çš„å±æ€§æ³¨å…¥\u003c/li\u003e\n\u003cli\u003eè°ƒç”¨ afterPropertiesSet() æ–¹æ³•\u003c/li\u003e\n\u003cli\u003eæ‰§è¡Œ myInitMethod() æ–¹æ³•\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eæ­¤å¤„ç»§æ‰¿è¯¥æ¥å£æ˜¯ä¸ºäº†å®ç° DataSource éªŒè¯ä»¥åŠ SQLExceptionTranslator çš„æ‡’åŠ è½½ OR NOT çš„é€‰æ‹©ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e@Override\npublic void afterPropertiesSet() {\n    if (getDataSource() == null) {  // åˆ¤æ–­æ˜¯å¦æ³¨å…¥äº† DataSource\n        throw new IllegalArgumentException(\"Property 'dataSource' is required\");\n    }\n    if (!isLazyInit()) {    // æ ¹æ®æ‡’åŠ è½½æ ‡è¯†ç¬¦é€‰æ‹©æ‰§è¡Œä¸å¦\n        getExceptionTranslator();   // è·å–ä¸€ä¸ª SQLExceptionTranslator å®ä¾‹\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¯¥æ–¹æ³•åœ¨ BeanFactory å®Œæˆè¯¥ bean çš„ä¾èµ–æ³¨å…¥åæ‰§è¡Œï¼Œå°†é¦–å…ˆåˆ¤æ–­ DataSource æ˜¯å¦å·²ç»è¢«æ³¨å…¥ï¼Œå†æ ¹æ®æ‡’åŠ è½½æ ‡è¯†ç¬¦æ¥å†³å®šæ˜¯å¦å®ä¾‹åŒ–ä¸€ä¸ª SQLExceptionTranslator ã€‚\u003c/p\u003e\n\u003ch3\u003eJdbcOperations\u003c/h3\u003e\n\u003cp\u003eåŒæ—¶ï¼ŒJdbcTemplate ç±»å®ç°äº† JdbcOperations æ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰äº†åŸºæœ¬çš„ JDBC æ“ä½œã€‚åŸºæœ¬æ–¹æ³•å¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003e\u0026#x3C;T\u003e T execute(ConnectionCallback\u0026#x3C;T\u003e action);\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\u0026#x3C;T\u003e T execute(StatementCallback\u0026#x3C;T\u003e action);\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\u0026#x3C;T\u003e T execute(PreparedStatementCreator psc, PreparedStatementCallback\u0026#x3C;T\u003e action);\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\u0026#x3C;T\u003e T execute(CallableStatementCreator csc, CallableStatementCallback\u0026#x3C;T\u003e action);\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://ws3.sinaimg.cn/large/006tNc79gy1fncp2ncqd6j31j00au0uv.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eå…¶å®ƒçš„ execute(â€¦) , query(â€¦), update(â€¦) ç­‰æœ€ç»ˆéƒ½å°†è°ƒç”¨ä¸Šè¿° 4 ç§æ–¹æ³•å…¶ä¸€æ¥å®Œæˆç›®çš„ã€‚\u003c/p\u003e\n\u003cp\u003eè¯¦ç»†è§‚å¯Ÿä¸Šè¿°æ–¹æ³•çš„å…¥å‚ï¼Œ ConnectionCallback, StatementCallback, PreparedStatementCallback å’Œ CallableStatementCallback å››ä¸ª Callback æ¥å£ï¼Œåˆ†åˆ«éƒ½æ˜¯å‡½æ•°å¼æ¥å£ï¼Œå…¶ä¸­çš„å”¯ä¸€æ–¹æ³• doInXXX() å°†åœ¨ execute() ä¸­è¢«è°ƒç”¨ï¼Œä»¥æ­¤å®ç°è·å¾— ResultSet å¹¶è¿”å› Result ã€‚execute ä¸­è°ƒç”¨ doInXXX() çš„é€šç”¨ä»£ç å¦‚ä¸‹ ï¼ˆä»¥ Statement ä¸ºä¾‹ï¼‰ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eå¯¹äºä¸ç†è§£\u003cstrong\u003eå›è°ƒ\u003c/strong\u003eçš„åŒå­¦ï¼Œè¯·è‡ªè¡Œäº†è§£æ¦‚å¿µ\u003c/em\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic \u0026#x3C;T\u003e T execute(StatementCallback\u0026#x3C;T\u003e action) throws DataAccessException {\n    // é€šè¿‡å·¥å…·ç±» DataSourceUtils è·å–ä¸€ä¸ªè¿æ¥\n    Connection con = DataSourceUtils.getConnection(obtainDataSource());\n    // ä¸€ä¸ª Statement ç©ºå®ä¾‹ï¼ŒPreparedStatement, CallableStatement ç±»ä¼¼\n    Statement stmt = null;\n    try {\n        stmt = con.createStatement();   // é€šè¿‡è¿æ¥(Connection)è·å–ä¸€ä¸ª Statement\n        applyStatementSettings(stmt);   // é…ç½® Statement å‚æ•°\n        // å›è°ƒæ‰§è¡Œ doInXXX() æ–¹æ³•, å¹¶è·å¾— result\n        T result = action.doInStatement(stmt);  \n        handleWarnings(stmt);\n        return result;\n    }\n    catch (SQLException ex) {\n        // Release Connection early, to avoid potential connection pool deadlock\n        // in the case when the exception translator hasn't been initialized yet.\n        String sql = getSql(action);\n        JdbcUtils.closeStatement(stmt);\n        stmt = null;\n        DataSourceUtils.releaseConnection(con, getDataSource());\n        con = null;\n        throw translateException(\"StatementCallback\", sql, ex);\n    }\n    finally {\n        JdbcUtils.closeStatement(stmt);\n        DataSourceUtils.releaseConnection(con, getDataSource());\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¯¹äº Statement, PreparedStatement, CallableStatement çš„åŒºåˆ«ï¼Œé¦–å…ˆä¸‹å›¾è¡¨ç°äº†ä¸‰ä¸ªæ¥å£çš„ç»§æ‰¿å…³ç³»ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eStatement å¯ä»¥æ”¯æŒé™æ€ SQL è¯­å¥\u003c/li\u003e\n\u003cli\u003ePreparedStatement æ”¯æŒå¯å˜å‚æ•°çš„ SQL è¯­å¥\u003c/li\u003e\n\u003cli\u003eCallableStatement æ”¯æŒå¯å˜å‚æ•°çš„ SQL è¯­å¥ï¼Œå¹¶ä¸”æ”¯æŒå®šåˆ¶ DB çš„è¾“å‡ºç»“æœ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"https://ws3.sinaimg.cn/large/006tNc79gy1fncpaec17yj30ew0hcdh7.jpg\"\u003e\u003c/p\u003e\n\u003ch2\u003eDataSource\u003c/h2\u003e\n\u003cp\u003eä¸Šä¸€èŠ‚åœ¨ç²—ç•¥åœ°äº†è§£äº† JdbcTemplate æä¾›çš„æ–¹æ³•ä¹‹åï¼Œä¸‹é¢å…ˆæ¥å¯¹ DataSource åšä¸€ç‚¹äº†è§£ã€‚\u003c/p\u003e\n\u003ch3\u003eJava æä¾›çš„ DataSource å®šä¹‰\u003c/h3\u003e\n\u003cp\u003eDataSource æ˜¯ Java æ ¸å¿ƒåº“æä¾›çš„æ¥å£ã€‚ä½äº javax.sql package ä¸‹ã€‚\u003c/p\u003e\n\u003cp\u003eDataSource æ¥å£å¯ä»¥è¢«è§†ä½œæ˜¯ä¸€ä¸ªæä¾›ç‰©ç† DB å®ä¾‹è¿æ¥(Connection) çš„å·¥å‚ï¼Œé€šè¿‡ DataSource æŒæœ‰çš„å„ç§å±æ€§ï¼ˆåŒ…æ‹¬ DB Url, Username, Password ç­‰ï¼‰æ¥è·å–ä¸€ä¸ªè¿æ¥(Connection) ã€‚DataSource æ¥å£æœ‰ä¸‰ç§ä¸åŒçš„å®ç°æ–¹æ¡ˆï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæœ€åŸºæœ¬çš„å®ç°â€”â€”ç”Ÿäº§ä¸€ä¸ªæ ‡å‡†è¿æ¥(Connection) å¯¹è±¡\u003c/li\u003e\n\u003cli\u003eè¿æ¥æ± æ–¹æ¡ˆâ€”â€”ç”Ÿäº§ä¼šè¢«è‡ªåŠ¨æ·»åŠ åˆ°è¿æ¥æ± çš„å¯¹è±¡\u003c/li\u003e\n\u003cli\u003eåˆ†å¸ƒå¼äº‹ç‰©å®ç°â€”â€”ç”Ÿäº§ä¸€ä¸ªå¯ä»¥æ”¯æŒåˆ†å¸ƒå¼äº‹ç‰©ï¼Œå¹¶é»˜è®¤è¢«æ·»åŠ åˆ°è¿æ¥æ± çš„è¿æ¥å¯¹è±¡\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eåŒ…æ‹¬ä¸¤ä¸ªå¯¹å¤–æä¾›è¿æ¥(Connection) å¯¹è±¡çš„æ–¹æ³•ï¼Œ\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003eConnection getConnection() throws SQLException;\nConnection getConnection(String username, String password) throws SQLException;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå…¶çˆ¶æ¥å£ CommonDataSource æä¾›è®¾ç½®/è·å– LogWriterï¼Œç™»å½• DB è¶…æ—¶æ—¶é—´å’Œè·å–çˆ¶ Logger çš„æ–¹æ³•ã€‚\u003c/p\u003e\n\u003ch3\u003eSpring-JDBC æ‰©å±•çš„ DataSource å®šä¹‰\u003c/h3\u003e\n\u003cp\u003eåœ¨ Spring-jdbc ä¸‹ï¼ŒDataSources æœ€é¡¶çº§çš„ç±»æ˜¯ AbstractDataSource ï¼Œå¯¹ DataSource çš„æ‰€æœ‰çˆ¶æ¥å£æ–¹æ³•åšäº†å®ç°ã€‚ä½†ä¿ç•™ getConnection() æ–¹æ³•ç”±å­ç±»å®ç°ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨ AbstractDriverBasedDataSource ä¸­ï¼Œå®šä¹‰äº†å¤§é‡çš„å‚æ•°ï¼Œè¯¸å¦‚ url, username ç­‰ï¼Œè¿™äº›éƒ½è¢«ç”¨æ¥å®šä½å¹¶å®šä¹‰ä¸æ•°æ®åº“å®ä¾‹çš„è¿æ¥ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic abstract class AbstractDriverBasedDataSource extends AbstractDataSource {\n\n   @Nullable\n   private String url;\n\n   @Nullable\n   private String username;\n\n   @Nullable\n   private String password;\n\n   @Nullable\n   private String catalog;\n\n   @Nullable\n   private String schema;\n\n   @Nullable\n   // å¯ä»¥çœ‹åˆ°æ­¤å¤„æœ‰ä¸€ä¸ª Properties ç±»\n   private Properties connectionProperties;\n   \n   // çœç•¥è‹¥å¹²æ–¹æ³•\n  \n\n    @Override\n    public Connection getConnection() throws SQLException {\n        // è°ƒç”¨å†…éƒ¨æ–¹æ³• getConnectionFromDriver()\n        return getConnectionFromDriver(getUsername(), getPassword());\n    }\n\n    @Override\n    public Connection getConnection(String username, String password) throws SQLException {\n        // è°ƒç”¨å†…éƒ¨æ–¹æ³• getConnectionFromDriver()\n        return getConnectionFromDriver(username, password);\n    }\n  \n   // å®šä¹‰äº†ä¸€ä¸ªè·å– Connection çš„æ–¹æ³•ï¼Œç”± getConnection() æ–¹æ³•è°ƒç”¨ï¼Œ\n   // æ­¤æ–¹æ³•ä¸»è¦æ˜¯å°†å±æ€§åšäº†ä¸€ä¸ªæ•´åˆ\n   // å…·ä½“è·å– Connection çš„é€»è¾‘ä»ç„¶ä¸‹æ”¾åˆ°å­ç±»å®ç° è§ 40 è¡Œ\n   protected Connection getConnectionFromDriver(@Nullable String username, @Nullable String password) throws SQLException {\n        Properties mergedProps = new Properties();\n        Properties connProps = getConnectionProperties();\n        if (connProps != null) {\n            mergedProps.putAll(connProps);\n        }\n        if (username != null) {\n            mergedProps.setProperty(\"user\", username);\n        }\n        if (password != null) {\n            mergedProps.setProperty(\"password\", password);\n        }\n        \n        // è·å– Connection é€»è¾‘ä¸‹æ”¾\n        Connection con = getConnectionFromDriver(mergedProps);\n        if (this.catalog != null) {\n            con.setCatalog(this.catalog);\n        }\n        if (this.schema != null) {\n            con.setSchema(this.schema);\n        }\n        return con;\n    }\n  \n    // è¯¥ç±»ä¸­è·å– Connection çš„æ–¹æ³•æ˜¯æŠ½è±¡æ–¹æ³•\n    protected abstract Connection getConnectionFromDriver(Properties props) throws SQLException;\n\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæ•´åˆæ–¹æ¡ˆä¸ºå°†é™¤ url å¤–çš„æ‰€æœ‰å‚æ•°æ•´åˆåœ¨åŒä¸€ä¸ª Properties å¯¹è±¡ä¸­ (å…¶ä¸­ï¼ŒProperties å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Hash Map) ã€‚æœ€ç»ˆè°ƒç”¨ \u003ccode\u003eConnection getConnectionFromDriver(Properties props)\u003c/code\u003e è·å–è¿æ¥ã€‚\u003c/p\u003e\n\u003cp\u003eAbstractDriverBasedDataSource æŠ½è±¡ç±»çš„ä¸¤ä¸ªå­ç±» DriverManagerDataSource å’Œ SimpleDriverDataSource éƒ½ä»¥ä¸åŒæ–¹å¼è·å¾—äº†è¿æ¥(Connection)ï¼Œä½†æ€»ç»“è€Œè¨€ï¼Œè·å–è¿æ¥(Connection) çš„ä»»åŠ¡è¢«å§”æ‰˜ç»™äº† Driver æ¥å®ç°ï¼ˆå…¶ä¸­ï¼ŒDriver æœ‰ Java å®šä¹‰æ¥å£ï¼Œå¹¶ç”±å„æ•°æ®åº“æä¾›å•†æä¾›ï¼Œä¾‹å¦‚ MySQL æä¾›äº† mysql-connector-java-XXX.jar æ¥å®Œæˆé’ˆå¯¹ç›¸åº”æ•°æ®åº“çš„å…·ä½“å®ç°ï¼‰ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e// ----------------------------\n// SimpleDriverDataSource çš„å®ç°\n// ----------------------------\n@Override\nprotected Connection getConnectionFromDriver(Properties props) throws SQLException {\n    Driver driver = getDriver();\n    String url = getUrl();\n    Assert.notNull(driver, \"Driver must not be null\");\n    if (logger.isDebugEnabled()) {\n        logger.debug(\"Creating new JDBC Driver Connection to [\" + url + \"]\");\n    }\n    // å“ˆå“ˆï¼Œé‡ç‚¹åœ¨è¿™... driver åœ¨è¯¥ç±»ä¸­è¢«é¢„å…ˆæ³¨å…¥\n    return driver.connect(url, props);\n}\n\n// -----------------------------\n// DriverManagerDataSource çš„å®ç°\n// -----------------------------\n@Override\nprotected Connection getConnectionFromDriver(Properties props) throws SQLException {\n    String url = getUrl();\n    Assert.state(url != null, \"'url' not set\");\n    if (logger.isDebugEnabled()) {\n        logger.debug(\"Creating new JDBC DriverManager Connection to [\" + url + \"]\");\n    }\n    // è°ƒäº†ä¸ªå†…éƒ¨å‡½æ•°\n    return getConnectionFromDriverManager(url, props);\n}\n\nprotected Connection getConnectionFromDriverManager(String url, Properties props) throws SQLException {\n    // å§”æ‰˜ç»™ DriverManager ç±»æ¥è·å–è¿æ¥\n    // DriverManager çš„ä¸»è¦æ“ä½œæ˜¯éå†åœ¨è¯¥ç®¡ç†ç±»ä¸­æ³¨å†Œçš„ Driver\n    // æ¯ä¸ª Driver å®ä¾‹éƒ½å»å°è¯•ä¸€ä¸‹ï¼Œèƒ½ä¸èƒ½è·å¾—ä¸€ä¸ªè¿æ¥\n    // ç¬¬ä¸€æ¬¡åœ¨æŸä¸ª Driver ä¸­æ‹¿åˆ°ä¸€ä¸ªè¿æ¥å³è¿”å›è¿æ¥ (Connection)\n    return DriverManager.getConnection(url, props);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eç®€è¦çš„ç±»å›¾å¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws4.sinaimg.cn/large/006tNc79gy1fncrgqcjqoj31es15ajxj.jpg\"\u003e\u003c/p\u003e\n\u003ch2\u003eDriverManager\u003c/h2\u003e\n\u003cp\u003eä¸Šé¢æåˆ° DataSource è·å–è¿æ¥(Connection) çš„æ“ä½œå®è´¨ä¸Šå°†å§”æ‰˜å…·ä½“çš„ Driver æ¥æä¾› Connection ã€‚æœ‰ä¸¤ç§ä¸åŒçš„æ–¹å¼ï¼ŒåŒ…æ‹¬ç»ç”± DriverManager éå†æ‰€æœ‰å¤„äºç®¡ç†ä¸‹çš„ Driver å°è¯•è·å–è¿æ¥ï¼Œæˆ–è€…åœ¨ DataSource å®ä¾‹ä¸­ç›´æ¥å£°æ˜ä¸€ä¸ªç‰¹å®šçš„ Driver æ¥è·å–è¿æ¥ã€‚\u003c/p\u003e\n\u003cp\u003eå¯¹äºè·å–è¿æ¥çš„å…·ä½“æ“ä½œï¼ŒæŒ–å‘-å¾…å¡«ã€‚åªæè¿°ç®€å•çš„æ•°æ®åº“ä¾›åº”å•†æä¾›çš„ Driver å¦‚ä½•ä¸ java ç›¸è”ç³»ã€‚\u003c/p\u003e\n\u003cp\u003e###åœ¨ DriverManager ä¸­æ³¨å†Œ Driver å®ä¾‹\u003c/p\u003e\n\u003cp\u003eé€šå¸¸åœ¨ä¸æ•°æ®åº“äº¤äº’é€»è¾‘çš„ Java ä»£ç ä¸­ï¼Œéƒ½ä¼šæœ‰ \u003ccode\u003eClass.forName(\"com.mysql.jdbc.Driver\")\u003c/code\u003e (æ­¤å¤„ä»¥ MySQL æä¾›çš„ mysql-connector-java-XXX.jar ä¸ºä¾‹ï¼Œä¸‹åŒï¼‰çš„ä»£ç å—ï¼ŒåŠ è½½æŒ‡å®šçš„ com.mysql.jdbc.Driver ä¸º java.lang.Class ç±»ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eå½“ç„¶ï¼Œåœ¨ JDBC 4.0 æ ‡å‡†ä¸‹ï¼Œå¯ä»¥ä¸å¿…å†æ˜¾ç¤ºå£°æ˜ \u003ccode\u003eClass.forName(\"\")\u003c/code\u003e è¯­å¥ï¼ŒDriver ä¹ŸåŒæ ·ä¼šåœ¨ DriverManager åˆå§‹åŒ–æ—¶è‡ªåŠ¨æ³¨å†Œã€‚\u003c/em\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e// Class ç±»ä¸­å¯¹äº forName(String className) çš„æ–¹æ³•\n// ä½œç”¨ä¸ºè¿”å›ä¸€ä¸ª java.lang.Class å®ä¾‹ã€‚\npublic static Class\u0026#x3C;?\u003e forName(String className) throws ClassNotFoundException {...}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåŒæ—¶ï¼Œ JVM åœ¨åŠ è½½ç±»çš„è¿‡ç¨‹ä¸­ä¼šæ‰§è¡Œç±»ä¸­çš„ static ä»£ç å—ã€‚ä¸‹è¿° row 10 ~ 16 çš„ä»£ç ç‰‡æ®µå°†è¢«æ‰§è¡Œã€‚å”¯ä¸€çš„é€»è¾‘å°±æ˜¯ new ä¸€ä¸ª com.mysql.jdbc.Driver å®ä¾‹ï¼Œå¹¶å°†å®ä¾‹æ³¨å†Œ(registerDriver) åˆ° \u003cstrong\u003ejava.sql.DriverManager\u003c/strong\u003e ä¸­ã€‚ \u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epackage com.mysql.jdbc;\n\npublic class Driver extends NonRegisteringDriver implements java.sql.Driver {\n    // ~ Static fields/initializers\n    // ---------------------------------------------\n\n    //\n    // Register ourselves with the DriverManager\n    //\n    static {\n        try {\n            java.sql.DriverManager.registerDriver(new Driver());\n        } catch (SQLException E) {\n            throw new RuntimeException(\"Can't register driver!\");\n        }\n    }\n\n    // ~ Constructors\n    // -----------------------------------------------------------\n\n    /**\n     * Construct a new driver and register it with DriverManager\n     * \n     * @throws SQLException\n     *             if a database error occurs.\n     */\n    public Driver() throws SQLException {\n        // Required for Class.forName().newInstance()\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä¸‹é¢å†æ¥çœ‹ä¸€ä¸‹ DriverManager ä¸­çš„ registerDriver() æ–¹æ³•ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic class DriverManager {\n\n    // DriverManager ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Driver åˆ—è¡¨\n    // æ­¤å¤„çš„ DriverInfo é‡Œé¢å³åŒ…è£…äº† Driver \n    private final static CopyOnWriteArrayList\u0026#x3C;DriverInfo\u003e registeredDrivers = \n        new CopyOnWriteArrayList\u0026#x3C;\u003e();\n\n    // åœ¨ DriverManager ä¸­æ³¨å†Œ Driver\n    public static synchronized void registerDriver(java.sql.Driver driver)\n        throws SQLException {\n        registerDriver(driver, null);\n    }\n  \n    public static synchronized void registerDriver(java.sql.Driver driver,\n            DriverAction da)\n        throws SQLException {\n\n        /* å¦‚æœå½“å‰ Driver ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œå³æ·»åŠ åˆ°åˆ—è¡¨ã€‚ */\n        if(driver != null) {\n            registeredDrivers.addIfAbsent(new DriverInfo(driver, da));\n        } else {\n            // This is for compatibility with the original DriverManager\n            throw new NullPointerException();\n        }\n\n        println(\"registerDriver: \" + driver);\n\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eé€šè¿‡ DriverManager è·å–è¿æ¥(Connection)\u003c/h3\u003e\n\u003cp\u003eä¸Šä¸€èŠ‚æœ‰æåˆ°è¿‡å¯ä»¥é€šè¿‡ DriverManager æ¥éå†è·å–è¿æ¥ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å£°æ˜å…·ä½“ Driver å¹¶è·å–è¿æ¥ã€‚ä¸‹é¢ä»£ç å±•ç¤ºçš„æ˜¯é€šè¿‡ DriverManager è·å–è¿æ¥çš„æ“ä½œã€‚ \u003cdel\u003eå“ˆå“ˆå“ˆï¼Œåæ­£æœ€åéƒ½æ˜¯ç”±å…·ä½“é©±åŠ¨å®ç°è·å–è¿æ¥ã€‚\u003c/del\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic class DriverManager {\n    // è·å–è¿æ¥çš„ public æ¥å£ (1)\n    public static Connection getConnection(String url,\n        java.util.Properties info) throws SQLException {\n        return (getConnection(url, info, Reflection.getCallerClass()));\n    }\n    // è·å–è¿æ¥çš„ public æ¥å£ (2)\n    public static Connection getConnection(String url,\n        String user, String password) throws SQLException {\n        java.util.Properties info = new java.util.Properties();\n\n        if (user != null) {\n            info.put(\"user\", user);\n        }\n        if (password != null) {\n            info.put(\"password\", password);\n        }\n\n        return (getConnection(url, info, Reflection.getCallerClass()));\n    }\n    // è·å–è¿æ¥çš„ public æ¥å£ (3)\n    public static Connection getConnection(String url)\n        throws SQLException {\n        java.util.Properties info = new java.util.Properties();\n        return (getConnection(url, info, Reflection.getCallerClass()));\n    }\n \n    // è·å–è¿æ¥çš„å†…éƒ¨é€»è¾‘å®ç°\n    private static Connection getConnection(\n        String url, java.util.Properties info, Class\u0026#x3C;?\u003e caller) \n        throws SQLException {\n        /*\n         * When callerCl is null, we should check the application's\n         * (which is invoking this class indirectly)\n         * classloader, so that the JDBC driver class outside rt.jar\n         * can be loaded from here.\n         */\n        ClassLoader callerCL = caller != null ? caller.getClassLoader() : null;\n        synchronized(DriverManager.class) {\n            // synchronize loading of the correct classloader.\n            if (callerCL == null) {\n                callerCL = Thread.currentThread().getContextClassLoader();\n            }\n        }\n        // url æ˜¯å®šä½ DBMS æœ€é‡è¦çš„å‚æ•°ï¼Œä¸èƒ½ä¸ºç©º\n        if(url == null) {\n            throw new SQLException(\"The url cannot be null\", \"08001\");\n        }\n\n        println(\"DriverManager.getConnection(\\\"\" + url + \"\\\")\");\n\n        // éå†æ‰€æœ‰æ³¨å†Œçš„ Driver ï¼Œå¹¶éƒ½å°è¯•è·å–è¿æ¥(Connection)\n        SQLException reason = null;\n\n        for(DriverInfo aDriver : registeredDrivers) {\n            // åˆ¤æ–­æ³¨å†Œçš„ Driver æ˜¯å¦ç”± ClassLoader callerCL åŠ è½½ï¼Œä¸æ˜¯åˆ™è·³è¿‡\n            if(isDriverAllowed(aDriver.driver, callerCL)) {\n                try {\n                    println(\"    trying \" + aDriver.driver.getClass().getName());\n                    // è·å–è¿æ¥ï¼Œ:) è¿˜æ˜¯ç”± driver å®ä¾‹è‡ªè¡Œæä¾›\n                    Connection con = aDriver.driver.connect(url, info);\n                    if (con != null) {\n                        // Success!\n                        println(\"getConnection returning \" + \n                                aDriver.driver.getClass().getName());\n                        return (con);\n                    }\n                } catch (SQLException ex) {\n                    if (reason == null) {\n                        reason = ex;\n                    }\n                }\n\n            } else {\n                println(\"    skipping: \" + aDriver.getClass().getName());\n            }\n\n        }\n\n        // å¦‚æœè¿è¡Œåˆ°ä¸‹åˆ—ä»£ç ï¼Œåˆ™è¡¨æ˜è·å–è¿æ¥å¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯\n        if (reason != null)    {\n            println(\"getConnection failed: \" + reason);\n            throw reason;\n        }\n\n        println(\"getConnection: no suitable driver found for \"+ url);\n        throw new SQLException(\"No suitable driver found for \"+ url, \"08001\");\n    }\n\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cem\u003eç®€å•çš„æä¸€å˜´ï¼ŒConnection ä»ç„¶åªæ˜¯ä¸€ä¸ªé’ˆå¯¹ Java -\u003e DB Server çš„ä¸Šå±‚æ¥å£ï¼Œå¦‚æœæƒ³è¦æ›´æ·±å±‚æ¬¡åœ°äº†è§£ Connection ä¸ DB Server çš„äº¤äº’ï¼Œå¯ä»¥å°è¯•å»çœ‹ä¸€ä¸‹ com.mysql.jdbc.MysqlIO ç±»ï¼ŒMySQL å®ç°çš„ JDBC4Connection ç±»ä¹Ÿæ˜¯åœ¨ä½¿ç”¨è¯¥ç±»æ¥å®ç°å¯¹ DB Server äº¤äº’ã€‚ï¼ˆå“ˆå“ˆï¼Œåªçœ‹è¿‡ MySQL æä¾›çš„ Driver åŒ…ï¼‰ã€‚\u003c/em\u003e\u003c/p\u003e\n\u003ch2\u003ePreparedStatement \u0026#x26; CallableStatement\u003c/h2\u003e\n\u003cp\u003eåœ¨äº†è§£äº† DataSource è·å–è¿æ¥(Connection) çš„å®è´¨ä»¥åŠ JdbcTemplate çš„é€šç”¨æ¥å£ä¹‹åï¼Œä½¿ç”¨ Spring-jdbc è¿›è¡Œæ•°æ®åº“ç›¸å…³çš„æ“ä½œå¯ä»¥ç›´æˆªäº†å½“çš„åˆ©ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œå®ç°ï¼ˆæ­¤å¤„ä»…å±•ç¤ºé€šè¿‡ Java ç¡¬ç¼–ç çš„å½¢å¼è¿›è¡Œå®ç°ï¼ŒXML é…ç½®æ–¹æ³•ç±»ä¼¼ï¼‰ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic static void main(String... args) {\n    // å®šä¹‰æ•°æ®æº\n    DriverManagerDataSource dataSource = new DriverManagerDataSource();\n    // é…ç½®å‚æ•°\n    dataSource.setUrl(\"jdbc:mysql://\u0026#x3C;host\u003e:\u0026#x3C;port\u003e/\u0026#x3C;dbName\u003e?\u0026#x3C;props\u003e\");\n    dataSource.setUsername(\"\u0026#x3C;username\u003e\");\n    dataSource.setPassword(\"\u0026#x3C;passwd\u003e\");\n    \n    // å®ä¾‹åŒ–ä¸€ä¸ª JDBC å·¥å…·ç±»\n    JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);\n    // æ‰§è¡Œç›¸å…³ CRUD æ“ä½œ \n    jdbcTemplate.execute();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå›é¡¾ç¬¬ä¸€èŠ‚æ‰€è®²çš„ JdbcTemplate çš„ 4 ä¸ªåŸºç¡€æ–¹æ³•ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003e\u0026#x3C;T\u003e T execute(ConnectionCallback\u0026#x3C;T\u003e action);\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\u0026#x3C;T\u003e T execute(StatementCallback\u0026#x3C;T\u003e action);\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\u0026#x3C;T\u003e T execute(PreparedStatementCreator psc, PreparedStatementCallback\u0026#x3C;T\u003e action);\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\u0026#x3C;T\u003e T execute(CallableStatementCreator csc, CallableStatementCallback\u0026#x3C;T\u003e action);\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://ws1.sinaimg.cn/large/006tKfTcgy1fndsm5tl7aj30zg0byq47.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eå››ä¸ªåŸºç¡€æ–¹æ³•éƒ½æœ‰ä¸€ä¸ªç‰¹å®šçš„å›è°ƒå‡½æ•°å°†é€šè¿‡é¢„é…ç½®çš„ DataSource å¾—åˆ°çš„ Connection æˆ– æ›´è¿›ä¸€æ­¥çš„ Statement or PreparedStatement or CallableStatement ä½œä¸ºå…¥å‚æ¥æ‰§è¡Œå®šä¹‰çš„å”¯ä¸€æ–¹æ³•ã€‚\u003c/p\u003e\n\u003cp\u003eä»¥ \u003ccode\u003e\u0026#x3C;T\u003e T execute(StatementCallback\u0026#x3C;T\u003e action);\u003c/code\u003e ä¸ºä¾‹æ¥äº†è§£ä¸€ä¸‹æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic \u0026#x3C;T\u003e T execute(StatementCallback\u0026#x3C;T\u003e action) throws DataAccessException {\n    // é€šè¿‡å·¥å…·ç±» DataSourceUtils è·å–ä¸€ä¸ªè¿æ¥\n    Connection con = DataSourceUtils.getConnection(obtainDataSource());\n    // ä¸€ä¸ª Statement ç©ºå®ä¾‹ï¼ŒPreparedStatement, CallableStatement ç±»ä¼¼\n    Statement stmt = null;\n    try {\n        stmt = con.createStatement();   // é€šè¿‡è¿æ¥(Connection)è·å–ä¸€ä¸ª Statement\n        applyStatementSettings(stmt);   // é…ç½® Statement å‚æ•°\n        // å›è°ƒæ‰§è¡Œ doInXXX() æ–¹æ³•, å¹¶è·å¾— result\n        T result = action.doInStatement(stmt);  \n        handleWarnings(stmt);\n        return result;\n    } catch() {\n      \n    } finally {\n      \n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œå¯¹äº PreparedStatement å’Œ CallableStatement è€Œè¨€ï¼Œè·å–ä¸€ä¸ª \u003cem\u003eXXX\u003c/em\u003eStatement çš„æ–¹å¼å°±æœ‰æ‰€ä¸åŒäº†ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e// è·å– Statement å®ä¾‹\nStatement stmt = con.createStatement();\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e// è·å– PreparedStatement å®ä¾‹\n// psc æ˜¯ä¸€ä¸ª PreparedStatementCreator æ¥å£å®ç°çš„å®ä¾‹\nPreparedStatement ps = psc.createPreparedStatement(con);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e// è·å– CallableStatement å®ä¾‹\n// csc æ˜¯ä¸€ä¸ª CallableStatementCreator æ¥å£å®ç°çš„å®ä¾‹\nCallableStatement cs = csc.createCallableStatement(con);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¯ä»¥çœ‹åˆ° Statement ç›´æ¥é€šè¿‡ Connection è·å–å®ä¾‹ï¼Œä½†æ˜¯ PreparedStatement å’Œ CallableStatement å°±æœ‰æ‰€ä¸åŒï¼Œå…¶åŒºåˆ«å°±åœ¨äº PreparedStatement å’Œ CallableStatement ä¸¤ä¸ª Statement éƒ½æ˜¯å¯ä»¥å®šåˆ¶å…¥å‚çš„ï¼Œæ›´ç”šè€…ï¼Œ CallableStatement å¯ä»¥å®šåˆ¶ DB æ‰§è¡Œç»“æœçš„å‡ºå‚ã€‚å½“ç„¶ï¼Œæ ¸å¿ƒè¿˜æ˜¯ \u003ccode\u003econ.prepareStatement() OR con.prepareCall()\u003c/code\u003e æ–¹æ³•ï¼Œåªä¸è¿‡æ˜¯å°†è·å– XXXStatement çš„æ“ä½œä¸‹æ”¾ç»™ XXXStatementCreator å®ä¾‹ç±»å®ç°ï¼Œç»™äºˆä½¿ç”¨è€…é‡å¤çš„è‡ªä¸»æƒï¼ŒåŒæ—¶ä¹Ÿæ˜¯é€»è¾‘è§£è€¦çš„ä¸€ç§æ“ä½œã€‚\u003c/p\u003e\n\u003cp\u003eä¾‹å¦‚ï¼š\u003c/p\u003e\n\u003cp\u003eSimplePreparedStatementCreator è¿™ä¸ª PreparedStatementCreator æ¥å£çš„å®ç°ç±»ï¼Œåªæ˜¯ç®€å•çš„è°ƒç”¨äº† \u003ccode\u003econ.prepareStatement(sql)\u003c/code\u003e æ–¹æ³•ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003eprivate static class SimplePreparedStatementCreator \n    implements PreparedStatementCreator, SqlProvider {\n\n    private final String sql;\n\n    @Override\n    public PreparedStatement createPreparedStatement(Connection con) \n        throws SQLException {\n        return con.prepareStatement(this.sql);\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè€Œå¯¹äº PreparedStatementCreatorImpl ï¼Œåœ¨ createPreparedStatement(Connection con) çš„å®ç°ä¸Šï¼Œåˆæ·»åŠ äº†æ›´å¤šçš„æ“ä½œã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003eprivate class PreparedStatementCreatorImpl\n        implements PreparedStatementCreator, PreparedStatementSetter, SqlProvider, ParameterDisposer {\n\n    private final String actualSql;\n\n    private final List\u0026#x3C;?\u003e parameters;\n\n    @Override\n    public PreparedStatement createPreparedStatement(Connection con) throws SQLException {\n        PreparedStatement ps;\n        if (generatedKeysColumnNames != null || returnGeneratedKeys) {\n            if (generatedKeysColumnNames != null) {\n                // è·å–ä¸€ä¸ª PreparedStatement å®ä¾‹ï¼Œä¸‹åŒ\n                ps = con.prepareStatement(this.actualSql, \n                                          generatedKeysColumnNames);\n            }\n            else {\n                ps = con.prepareStatement(this.actualSql, \n                                         PreparedStatement.RETURN_GENERATED_KEYS);\n            }\n        }\n        else if (resultSetType == ResultSet.TYPE_FORWARD_ONLY \n                 \u0026#x26;\u0026#x26; !updatableResults) {\n            ps = con.prepareStatement(this.actualSql);\n        }\n        else {\n            ps = con.prepareStatement(this.actualSql, resultSetType,\n                updatableResults ? ResultSet.CONCUR_UPDATABLE : \n                                      ResultSet.CONCUR_READ_ONLY);\n        }\n        // å°†å¯å˜ SQL (ä¾‹å¦‚ SELECT * FROM msg WHERE id = ?) çš„ ? ç”¨å®é™…å‚æ•°æ›¿æ¢\n        setValues(ps);\n        return ps;\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä»ä¸Šè¿°ä¸¤ç§ PreparedStatementCreator æ¥å£çš„ä¸åŒå®ç°ï¼Œä¹Ÿå¯ä»¥ä»å¦ä¸€ç§è§’åº¦ç†è§£åˆ°ï¼Œå‡½æ•°å¼æ¥å£å°†è·å–ç›®æ ‡å‡ºå‚çš„å…·ä½“é€»è¾‘äº¤ç»™ä½¿ç”¨è€…å®šä¹‰ï¼Œç»™äºˆäº†ä½¿ç”¨è€…å……åˆ†çš„è‡ªä¸»æƒï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ç§ä¸šåŠ¡é€»è¾‘çš„è§£è€¦ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨ä¸Šé¢ä»£ç  PreparedStatementCreatorImpl ç±»çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ç¬¬ 32 è¡Œä»£ç  \u003ccode\u003esetValue(ps)\u003c/code\u003e ã€‚æ­¤å¤„çš„æ–¹æ³•æ˜¯ç”±æ¥å£ PreparedStatementSetter å®šä¹‰çš„ã€‚ä¸»è¦ç›®çš„æ˜¯å°†å¯å˜ SQL ä¸­çš„ ? å‚æ•°ç”¨å®é™…å‚æ•°è¿›è¡Œä¸€ä¸ªæ›¿æ¢ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e// ä»¥ SQL (SELECT * FROM msg WHERE id = ? AND day = ?) ä¸ºä¾‹\n/** çº¯ Java æ ¸å¿ƒåº“çš„å®ç° PreparedStatement å‚æ•°æ³¨å…¥ */\nps.setInt(1, 1763);\nps.setString(2, \"2018-01-01\");\nps.executeQuery();\n\n/** ä»¥ Spring-jdbc å®ç° PreparedStatement å‚æ•°æ³¨å…¥ */\n// setValues() ç”±æ¥å£ PreparedStatementSetter å®šä¹‰ï¼Œå°è£…äº†æ³¨å…¥å‚æ•°çš„å…·ä½“å®ç°é€»è¾‘\n// å¯ä»¥ç”±ä½¿ç”¨è€…è‡ªè¡Œå®šä¹‰\nsetValues(ps);  \nps.executeQuery();\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"https://ws1.sinaimg.cn/large/006tKfTcgy1fndyybh4q1j31kw0u3afx.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eä¸Šé¢ç±»å›¾è¡¨ç¤ºäº† PreparedStatementSetter åŠå…¶å®ç°ç±»çš„ç›¸å…³ä¾èµ–ã€‚\u003c/p\u003e\n\u003cp\u003eSetter çš„ä¸»è¦ç›®æ ‡å³ä¸ºå¯¹ SQL ä¸­çš„ ? å‚æ•°è¿›è¡Œæ³¨å…¥ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cdel\u003eä¸ªäººç²¾åŠ›æœ‰é™ï¼Œå¯¹Spring-jdbcåœ¨Statementä¸Šå¯¹å‚æ•°æ³¨å…¥çš„å›è°ƒç†è§£æœ‰é™ã€‚\u003c/del\u003e\u003c/p\u003e\n\u003ch2\u003eResultSet\u003c/h2\u003e\n\u003cp\u003eåœ¨å‰å‡ èŠ‚å·²ç»æåˆ°è®²äº†æ•°æ®æºã€é©±åŠ¨ç®¡ç†å™¨ä»¥åŠ Statement ä¹‹åï¼Œåˆ©ç”¨ JDBC çš„æœ€é‡è¦çš„ç›®çš„å°±æ˜¯å¯¹ DB è¿›è¡Œæ“ä½œï¼Œå¹¶è·å¾—é¢„æœŸç»“æœã€‚å¯¹äºæŸ¥è¯¢è¯­å¥è€Œè¨€ï¼Œç»“æœåº”è¯¥æ˜¯è‹¥å¹²è®°å½•è¡Œï¼›å°±æ›´æ–°è¯­å¥è€Œè¨€ï¼Œç»“æœå¯èƒ½æ˜¯å½±å“çš„è¡Œæ•°ã€‚è€Œ Spring-jdbc å¯¹ ResultSet é¢å¤–è¿›è¡Œçš„å°è£…ï¼Œå³æ˜¯å°†åŸæœ¬æ•£ä¹±çš„ç»“æœè¿›è¡Œä¸€ä¸ªæ•´åˆï¼Œä¾‹å¦‚æ•´åˆæˆä¸€ä¸ª(ä¸€ç»„)å®Œæ•´çš„ Bean æ¥è¿›è¡Œå±•ç¤ºã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨ JdbcTemplate ä¸­ï¼Œå››ä¸ªåŸºæœ¬æ–¹æ³•å…¥å‚éƒ½åŒ…æ‹¬ä¸€ä¸ªå›è°ƒæ¥å£ï¼Œè€Œåœ¨æ‰§è¡Œå›è°ƒè·å¾— ResultSet ä¹‹åï¼Œæ–¹æ³•å¹¶ä¸æ˜¯ç›´æ¥è¿”å›ï¼Œè€Œæ˜¯è¿›è¡Œäº†ä¸€å®šçš„æ“ä½œã€‚\u003c/p\u003e\n\u003cp\u003eä»¥ä¸€ä¸ª PreparedStatementCallback çš„å®ä¾‹ç±»ä¸ºä¾‹ï¼Œåœ¨ doInPreparedStatement() æ–¹æ³•ä¸­ï¼Œè·å¾—äº† ResultSet ï¼Œä½†æ˜¯ä»é€šè¿‡ rse.extractData(rs) è¯­å¥è¿›è¡Œäº†å¤„ç†åå†è¿”å›ç»“æœ\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic T doInPreparedStatement(PreparedStatement ps) throws SQLException {\n    // å£°æ˜ä¸€ä¸ª ResultSet \n    ResultSet rs = null;\n    try {\n        if (pss != null) {  // setValues() æ–¹æ³•å¡«å…… PreparedStatement ä¸­çš„å¯å˜å‚æ•° ? \n            pss.setValues(ps);\n        }\n        rs = ps.executeQuery(); // æ‰§è¡ŒæŸ¥è¯¢ sql ï¼Œè·å–ç»“æœ\n        return rse.extractData(rs); // é‡ç‚¹... è¯¥è¯­å¥ä¸€å®šæ˜¯å¯¹ç»“æœè¿›è¡Œäº†ä¸€äº›æ“ä½œ.\n    }\n    finally {\n        JdbcUtils.closeResultSet(rs);\n        if (pss instanceof ParameterDisposer) {\n            ((ParameterDisposer) pss).cleanupParameters();\n        }\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåœ¨æ¥çœ‹ä¸€ä¸‹ç©¶ç«Ÿåœ¨è¿”å›ç»“æœå‰è¿›è¡Œäº†ä»€ä¹ˆæ“ä½œã€‚\u003c/p\u003e\n\u003cp\u003eç”±äºæ˜¯ä¸€ä¸ªå›è°ƒæ¥å£çš„å®ç°ç±»ï¼Œrse åº”è¯¥åœ¨å¤–éƒ¨æ–¹æ³•ä¸­ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic \u0026#x3C;T\u003e T query(\n        PreparedStatementCreator psc, @Nullable final PreparedStatementSetter pss, \n        final ResultSetExtractor\u0026#x3C;T\u003e rse)\n        throws DataAccessException {\n\n    return execute(psc, new PreparedStatementCallback\u0026#x3C;T\u003e() {\n        @Override\n        public T doInPreparedStatement(PreparedStatement ps) throws SQLException {\n            ... \n        }\n    });\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¯ä»¥çœ‹åˆ° rse æ˜¯ä¸€ä¸ª ResultSetExtractor çš„å®ä¾‹ã€‚ä»åç§°ä¸Šå¯ä»¥çœ‹å‡º Extractor å³ä¸ºæå–å™¨ï¼Œç»“æœé›†æå–å™¨ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e/** å‡½æ•°å¼æ¥å£ï¼Œæä¾›çš„å”¯ä¸€æ–¹æ³•ä¸º extractData(...) */\n@FunctionalInterface\npublic interface ResultSetExtractor\u0026#x3C;T\u003e {\n\n    @Nullable\n    T extractData(ResultSet rs) throws SQLException, DataAccessException;\n\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"https://ws3.sinaimg.cn/large/006tKfTcgy1fndzz0pqnrj31a60i676v.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eSpring-jdbc ä¸­ç°æœ‰çš„å®ç°æœ‰ä¸‰ä¸ªç±»ï¼Œå…¶ä¸­ RowCallbackHandlerResultSetExtractor å’Œ RowMapperResultSetExtractor ä¸¤ä¸ªç±»ä»ä¸Šé¢ç±»å›¾åŠå‘½åå³å¯çœ‹å‡ºï¼Œä¸¤ä¸ªæ˜¯ä½œä¸ºä¸€ä¸ªé€‚é…å™¨è€Œå­˜åœ¨çš„ï¼Œå°† extractData() è¿›è¡Œè½¬æ¢ï¼Œåˆ†åˆ«ç”± RowCallbackHandler å’Œ RowMapper å®ä¾‹è¿›è¡Œå…·ä½“æ“ä½œã€‚è€Œ AbstractLobStreamingResultSetExtractor ç±»ä»åç§°ä¸Šçœ‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç±»ä¼¼æµæ“ä½œçš„å®ç°ç±»(å…¶ä¸­çš„ Lob æŒ‡çš„æ˜¯ DB ä¸­çš„ BLOB ä¸ CLOB ç±»å‹ï¼Œåœ¨ Spring-jdbc ä¸­ä¹ŸåŠ å…¥äº†é¢å¤–çš„æ”¯æŒ) ã€‚\u003c/p\u003e\n\u003ch3\u003eRowCallbackHandler\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://ws3.sinaimg.cn/large/006tKfTcgy1fnh2uw3a0aj30h20jeta4.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eä»åç§°ä¸Šçœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸ ResultSet ç»“æœé›†è¡Œç›¸å…³çš„å›è°ƒæ¥å£ã€‚processRow(ResultSet rs) æ–¹æ³•å°†å¤„ç†è¡Œç›¸å…³çš„é€»è¾‘ã€‚\u003c/p\u003e\n\u003cp\u003eä»å®ƒçš„ä¸€ä¸ªå®ç°ç±» RowCountCallbackHandler æ¥è¯´ï¼Œå…¶æœ€ä¸»è¦çš„ç§æœ‰å±æ€§ rowCount å³æ˜¯ç»Ÿè®¡ ResultSet çš„ç»“æœè¡Œæ•°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“ä½¿ç”¨çš„è¯¥ç±»çš„æ¡ˆä¾‹ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic static void main(String[] args) throws ClassNotFoundException {\n\n    DriverManagerDataSource dataSource = new DriverManagerDataSource();\n    dataSource.setUrl(\"jdbc:mysql://\u0026#x3C;host\u003e:\u0026#x3C;port\u003e/\u0026#x3C;dbName\u003e\");\n    dataSource.setUsername(\"\u0026#x3C;username\u003e\");\n    dataSource.setPassword(\"\u0026#x3C;password\u003e\");\n\n    JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);\n    RowCountCallbackHandler rcch = new RowCountCallbackHandler();\n\n    jdbcTemplate.query(\"SELECT * FROM info WHERE id='2018'\", (RowCallbackHandler) rcch);\n    \n    System.out.println(rcch.getRowCount()); //è·å–ç»“æœé›†è¡Œæ•°\n    System.out.println(rcch.getColumnCount());  // è·å–ç»“æœé›†åˆ—æ•°\n    for (String arg : rcch.getColumnNames()) {  // æ‰“å°ç»“æœé›†æ¯ä¸€åˆ—åç§°\n        System.out.println(\"ColumnNames : \" + arg);\n    }\n    for (int i : rcch.getColumnTypes()) {   // æ‰“å°ç»“æœé›†æ¯ä¸€åˆ—ç±»å‹(Types ä¸ºæšä¸¾ç±»)\n        System.out.println(\"ColumnTypes : \" + i);\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå…·ä½“æŸ¥çœ‹ RowCountCallbackHandler ç±»çš„ processRow() æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œå…¶è·å–åˆ—ç›¸å…³ä¿¡æ¯éƒ½æ¥è‡ªäº ResultSetMetaData ã€‚è€Œç»“æœè¡Œæ•°æ¥æºäº Iterator è¿­ä»£ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e@Override\npublic final void processRow(ResultSet rs) throws SQLException {\n    if (this.rowCount == 0) {\n        ResultSetMetaData rsmd = rs.getMetaData();\n        this.columnCount = rsmd.getColumnCount();\n        this.columnTypes = new int[this.columnCount];\n        this.columnNames = new String[this.columnCount];\n        for (int i = 0; i \u0026#x3C; this.columnCount; i++) {\n            this.columnTypes[i] = rsmd.getColumnType(i + 1);\n            this.columnNames[i] = JdbcUtils.lookupColumnName(rsmd, i + 1);\n        }\n        // could also get column names\n    }\n    processRow(rs, this.rowCount++);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eRowMapper\u003c/h3\u003e\n\u003cp\u003eä¸Šé¢ RowCallbackHandler æ¥å£ä»é€»è¾‘ä¸Šåˆ’åˆ†æ˜¯ç”¨äºå¤„ç† ResultSet å…ƒæ•°æ®ä¿¡æ¯çš„ã€‚è€Œ RowMapper è¾ƒä¸Šä¸€ä¸ªæ¥å£è€Œè¨€ï¼Œæœ‰æ›´é«˜çš„å®ç”¨æ€§ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws3.sinaimg.cn/large/006tKfTcgy1fnh3h739kaj30z60nago4.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eç‰¹åˆ«æ˜¯å…¶å®ç°ç±» BeanPropertyRowMapper å¯ä»¥å°†æ•£ä¹±çš„ ResultSet çš„ç»“æœæ•°æ®æ•´ç†æˆä¸€ä¸ªä¸ª Object Bean ä½œä¸ºè¿”å›ç»“æœã€‚è€Œçœå»äº†å¯¹é€ä¸€è¯»å– ResultSet è¡Œè®°å½•å¹¶å¡«å…… Bean å±æ€§çš„éº»çƒ¦ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003eJdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);\n\nBeanPropertyRowMapper\u0026#x3C;Model\u003e rowMapper = new BeanPropertyRowMapper\u0026#x3C;\u003e(Model.class);\nList\u0026#x3C;Model\u003e list = jdbcTemplate.query(\"SELECT * FROM info WHERE id = '2018'\", rowMapper);\n/** è·å¾—çš„ Model list çš„å¯¹åº”å±æ€§å°†é€šè¿‡ Java çš„åå°„æœºåˆ¶è¿›è¡Œå¡«å……\n *  List\u0026#x3C;Model\u003e list å³ç»“æœ\n */\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå½“ç„¶ï¼Œè¦æ±‚æ˜¯ Model ç±»ä¸­çš„å±æ€§ä¸ DB table ä¸­çš„åˆ—åä¿æŒä¸€è‡´ï¼ˆå¤§å°å†™æ— è¦æ±‚ï¼‰ã€‚\u003c/p\u003e\n\u003cp\u003eè€Œå…¶å®ƒä¸¤ä¸ªç±»çš„å®ç°ä¹Ÿæ˜¯åŸºäºåå°„æœºåˆ¶ï¼Œå®ç°å…¶ç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-text\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003ch2\u003eæ¦‚è§ˆ\u003c/h2\u003e\n\u003cp\u003eåœ¨å­¦ä¹  Spring-JDBC ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦ä» Java åŸç”Ÿæä¾›çš„ JDBC å¼€å§‹ï¼Œå¯¹ JDBC æ“ä½œçš„ä¸€æ•´å¥—å®Œæ•´çš„æµç¨‹æœ‰ä¸€ä¸ªæ¸…æ™°çš„æ¦‚å¿µã€‚\u003c/p\u003e"},{"url":"2018-03-01-åŒºå—é“¾ç®€å•ä»‹ç»","fileName":"2018-03-01-åŒºå—é“¾ç®€å•ä»‹ç».md","title":"åŒºå—é“¾æŠ€æœ¯æ¦‚è¿°","author":"fangfeng","date":"2018-03-01T00:00:00.000Z","tags":["BlockChain","Smart Contract"],"content":"\u003cp\u003e\u003cimg src=\"https://ws3.sinaimg.cn/large/006tKfTcgy1fs8oc4ri7qj30mq055aap.jpg\" alt=\"åŒºå—é“¾ç®€å•ç»“æ„\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws1.sinaimg.cn/large/006tNc79gy1foxcpmmpfhj31kw107n2e.jpg\" alt=\"Merkle tree\"\u003e\u003c/p\u003e\n\u003ch2\u003eåŸºæœ¬å·¥ä½œæµç¨‹\u003c/h2\u003e\n\u003ch3\u003eæ–°äº¤æ˜“å‘èµ·æµç¨‹\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eç”¨æˆ·é€šè¿‡å…¬/ç§é’¥ä¸åŒºå—é“¾ç½‘ç»œè¿›è¡Œäº¤äº’\u003c/li\u003e\n\u003cli\u003eå¤„ç†ç”¨æˆ·äº¤æ˜“çš„èŠ‚ç‚¹å‘ç½‘ç»œé‚»èŠ‚ç‚¹å¹¿æ’­ç”¨æˆ·äº¤æ˜“\u003c/li\u003e\n\u003cli\u003eé‚»èŠ‚ç‚¹éªŒè¯äº¤æ˜“çš„æœ‰æ•ˆæ€§ï¼›å¯ä¿¡ï¼Œç»§ç»­å‘å…¶å®ƒé‚»èŠ‚ç‚¹å¹¿æ’­ï¼›ä¸å¯ä¿¡ï¼Œä¸¢å¼ƒã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003eæ–°åŒºå—äº§ç”Ÿæµç¨‹\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eçŸ¿å·¥å°è¯•å°†ä¸€ä¸ªæ—¶é—´åŒºé—´å†…çš„äº¤æ˜“è¿›è¡Œæ‰“åŒ…å½¢æˆæ–°åŒºå—ï¼ˆæ€ä¹ˆæ‰“åŒ…ï¼Œçœ‹ä¸‹æ–‡ï¼‰\u003c/li\u003e\n\u003cli\u003eç”Ÿäº§å‡ºæ–°åŒºå—çš„çŸ¿å·¥èŠ‚ç‚¹å‘ç½‘ç»œå¹¿æ’­æ–°åŒºå—\u003c/li\u003e\n\u003cli\u003eæ”¶åˆ°æ–°åŒºå—çš„ç½‘ç»œèŠ‚ç‚¹éªŒè¯è¯¥åŒºå—çš„æœ‰æ•ˆæ€§\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003ca href=\"https://blockchain.info/zh-cn\"\u003eæ¯”ç‰¹å¸åŒºå—æµè§ˆå™¨\u003c/a\u003e      æ›´å¤š\u003ca href=\"https://en.wikipedia.org/wiki/Metric_prefix\"\u003eå›½é™…å•ä½åˆ¶å‰ç¼€\u003c/a\u003e\u003c/p\u003e\n\u003ch2\u003eç½‘ç»œå…±è¯†\u003c/h2\u003e\n\u003cp\u003eæ‰€æœ‰åŒºå—é“¾ç½‘ç»œèŠ‚ç‚¹éœ€è¦å¯¹äº¤æ˜“ä»¥åŠå…¶åœ¨æ–°åŒºå—é‡Œé¢çš„é¡ºåºè¾¾æˆä¸€è‡´ï¼ˆäº¤æ˜“çš„æœ‰æ•ˆæ€§ä»¥åŠäº¤æ˜“çš„æ‰“åŒ…é¡ºåºï¼‰ã€‚\u003c/p\u003e\n\u003cp\u003eå¯èƒ½å‡ºç°ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¥³å·«æ”»å‡»â€”â€”å•ä¸€å®ä½“ä»¥å¤šé‡èº«ä»½é‡å¤å¯¹æ–°åŒºå—ç»“æœè¿›è¡Œè¡¨å†³ï¼ˆå°‘æ•°äººæŠ“ä½äº†ç½‘ç»œçš„æŠ•ç¥¨æƒï¼‰\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98\"\u003eæ‹œå åº­å°†å†›é—®é¢˜\u003c/a\u003eâ€”â€”åˆ†å¸ƒå¼å¯¹ç­‰ç½‘ç»œçš„é€šä¿¡å®¹é”™é—®é¢˜\u003cul\u003e\n\u003cli\u003eä¸åŒçš„è®¡ç®—æœºé€šè¿‡é€šè®¯äº¤æ¢ä¿¡æ¯è¾¾æˆå…±è¯†è€ŒæŒ‰ç…§åŒä¸€å¥—åä½œç­–ç•¥è¡ŒåŠ¨\u003cul\u003e\n\u003cli\u003eæˆå‘˜è®¡ç®—æœºå¯èƒ½å‡ºé”™è€Œå‘é€é”™è¯¯ä¿¡æ¯\u003c/li\u003e\n\u003cli\u003eç½‘ç»œçš„ä¸å¯é æ€§\u003c/li\u003e\n\u003cli\u003eä»è€Œå½±å“ç½‘ç»œå…±è¯†çš„è¾¾æˆï¼Œç ´åä¸€è‡´æ€§ã€‚\u003c/li\u003e\n\u003c/ul\u003e\u003c/li\u003e\n\u003cli\u003eä¸è§£å†³çš„è¯å¯èƒ½å¯¼è‡´â€”â€”åŒºå—é“¾åˆ†å‰\u003c/li\u003e\n\u003c/ul\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè§£å†³æ–¹æ¡ˆï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå·¥ä½œé‡è¯æ˜ï¼ˆproof-of-work, PoWï¼‰ï¼Œæƒç›Šè¯æ˜(proof-of-stake, PoS)ï¼Œç™½åå•æœºåˆ¶ï¼ˆä»…é€‚ç”¨äºç§æœ‰ç½‘ç»œï¼‰ç­‰\u003c/li\u003e\n\u003cli\u003eå®ç”¨æ‹œå åº­å®¹é”™ç®—æ³•\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eå±€é™\u003c/h3\u003e\n\u003cp\u003eç½‘ç»œå…±è¯†æœºåˆ¶çš„å®ç°å¯¼è‡´äº†ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eäº¤æ˜“ååé‡\u003c/li\u003e\n\u003cli\u003eæ›´é«˜çš„äº¤æ˜“æ—¶å»¶ã€‚äº¤æ˜“ç¡®è®¤æ—¶é—´ï¼ˆåªæœ‰æ‰“åŒ…çš„æ–°åŒºå—ä¸­æ‰äº¤æ˜“æ‰ä¼šè¢«æ‰¿è®¤ï¼‰ã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eå…±è¯†æœºåˆ¶çš„ä¼¸ç¼©å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šè§£å†³ä¸Šè¿°é—®é¢˜\u003c/p\u003e\n\u003ch2\u003eèµ„äº§äº¤æ˜“\u003c/h2\u003e\n\u003cp\u003eç®€å•äº¤æ˜“çŠ¶æ€æè¿°ï¼Œä»¥é›†ä¸­å¼æ•°æ®åº“ä¸ºä¾‹\u003c/p\u003e\n\u003cp\u003eå‡è®¾åˆå§‹çŠ¶æ€ä¸º\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e-------------------------\n| èµ„äº§ç±»å‹ | æ‰€æœ‰è€… | æ•°é‡ |\n-------------------------\n|   CNY   |  é˜²é£  |  10 |\n-------------------------\n|   CNY   |  çº¢è–¯  |  0  |\n-------------------------\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eé˜²é£ å‘ çº¢è–¯ è½¬è´¦ 2 CNY \u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e-------------------------\n| èµ„äº§ç±»å‹ | æ‰€æœ‰è€… | æ•°é‡ |\n-------------------------\n|   CNY   |  é˜²é£  |  8  |\n-------------------------\n|   CNY   |  çº¢è–¯  |  2  |\n-------------------------\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæ•°æ®åº“ä¸­ç›¸åº”è®°å½•çš„æ›´æ”¹å®Œæˆäº†èµ„äº§çš„äº¤æ˜“è¿‡ç¨‹ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨åŒºå—é“¾ä¸­ï¼Œä»ç„¶å°†åˆ†å¸ƒå¼é“¾çœ‹ä½œæ˜¯ä¸€ä¸ªè¾¾æˆå…±è¯†çš„é›†ä¸­å¼æ•°æ®åº“\u003c/p\u003e\n\u003cp\u003eé‚£ä¹ˆç°åœ¨çš„åˆå§‹çŠ¶æ€å¯ä»¥è¡¨ç¤ºæˆ\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e---------------------------------\n| èµ„äº§ç±»å‹ |     æ‰€æœ‰è€…     | æ•°é‡ |\n---------------------------------\n|   IOTA  |  é˜²é£ pub_key  | 10  |\n---------------------------------\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eç°åœ¨çš„æ‰€æœ‰è€…ç”±å…¬é’¥è¡¨ç¤ºï¼Œæƒ³è¦ä¿®æ”¹è®°å½•å¿…é¡»æä¾›å¯¹åº”çš„å¯†é’¥ã€‚\u003c/p\u003e\n\u003cp\u003eä¾‹å¦‚ï¼Œé˜²é£ å‘ çº¢è–¯ è½¬è´¦ 2 IOTA ï¼Œéœ€è¦æä¾›é˜²é£çš„ç§é’¥å’Œçº¢è–¯çš„å…¬é’¥ã€‚äº¤æ˜“è®°å½•ä¿®æ”¹ç»“æœï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e---------------------------------\n| èµ„äº§ç±»å‹ |     æ‰€æœ‰è€…     | æ•°é‡ |\n---------------------------------\n                                 è¢«åˆ é™¤äº†         |   IOTA  |  é˜²é£ pub_key  | 10  |\n---------------------------------\n|   IOTA  |  çº¢è–¯ pub_key  |  2  |\n---------------------------------\n|   IOTA  |  é˜²é£ pub_key  |  8  |\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eäº¤æ˜“çš„æ¦‚å¿µæµç¨‹ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå®šä½é˜²é£æ‰€æœ‰çš„èµ„äº§è®°å½•è¡Œ\u003c/li\u003e\n\u003cli\u003eåˆ é™¤è¯¥è¡Œå‰éªŒè¯å¯†é’¥\u003c/li\u003e\n\u003cli\u003eç¡®è®¤è¯¥è®°å½•æ²¡æœ‰è¢«åˆ«çš„äº¤æ˜“ä½¿ç”¨ï¼ˆåŒèŠ±é—®é¢˜ï¼ŒåŒé‡äº¤æ˜“ï¼‰\u003c/li\u003e\n\u003cli\u003eå†™å…¥æ–°çš„æ­£ç¡®çš„è®°å½•ï¼ˆçº¢è–¯è·å¾—çš„èµ„äº§ \u0026#x26; é˜²é£å‰©ä½™çš„èµ„äº§ï¼‰ï¼Œç¡®ä¿äº¤æ˜“å‰ä¸äº¤æ˜“åèµ„äº§æ€»é¢ä¸å˜\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eä¸Šé¢çš„æ¨¡å‹ â€”â€” åŸºäºæ¯”ç‰¹å¸çš„äº¤æ˜“æ¨¡å‹(UTXO \u003cem\u003emodel\u003c/em\u003e)\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eé€‚åˆäºæ•°å­—æ ‡è®°èµ„äº§çš„ä¼ è¾“ä¸è¿½è¸ª\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ¦‚å¿µï¼šUTXO (unspent transaction outputs) æœªèŠ±è´¹çš„äº¤æ˜“è¾“å‡ºï¼šæ•°æ®åº“ç°æœ‰çš„è®°å½•\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e---------------------------------\u003c/p\u003e\n\u003cp\u003eå¦ä¸€ç§æ¨¡å‹å¸¸ç”¨äºæ™ºèƒ½åˆçº¦ â€”â€” åŸºäºè´¦å·çš„æ¨¡å‹(account-based \u003cem\u003emodel\u003c/em\u003e)\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæä¾›äº†å»ºç«‹å¤šæ­¥éª¤æ‰§è¡Œçš„åŸºæœ¬æœºåˆ¶\u003c/strong\u003e \u003c/p\u003e\n\u003ch3\u003eèµ„äº§å¦‚ä½•äº§ç”Ÿ\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eæ¯”ç‰¹å¸ï¼š\u003cul\u003e\n\u003cli\u003eçŸ¿å·¥èŠ‚ç‚¹å…è®¸åœ¨æŒ–å‡ºçš„æ–°èŠ‚ç‚¹ä¸­åŠ å…¥ä¸€ç§ coinbase ç±»å‹çš„äº¤æ˜“ï¼ˆä¸å­˜åœ¨äº¤æ˜“è¾“å…¥ï¼Œæ–°èµ„äº§æ•°é¢æœ‰æ¯”ç‰¹å¸é“¾æå‰å®šä¹‰ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\u003c/li\u003e\n\u003cli\u003eåœ¨åˆ›å§‹æ–°ä»£å¸çš„æ—¶å€™å…¨é¢å‘è¡Œ\u003c/li\u003e\n\u003cli\u003eå…¶å®ƒæœºåˆ¶\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eåŒºå—é“¾ç‰¹æ€§\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eä¸€ç§å¥å£®çš„ã€çœŸæ­£çš„åˆ†å¸ƒå¼å¯¹ç­‰ç³»ç»Ÿï¼Œå®ƒèƒ½å®¹å¿èŠ‚ç‚¹æ•…éšœã€‚\u003c/li\u003e\n\u003cli\u003eèƒ½å¤Ÿè¯†åˆ«å†²çªå’Œåˆ†å‰å¹¶è‡ªåŠ¨è§£å†³çš„ç½‘ç»œï¼Œä»¥ä¾¿æ”¶æ•›åˆ°å•ä¸€çš„ã€å…¬è®¤çš„å”¯ä¸€çŠ¶æ€ã€‚ï¼ˆåŒºå—é“¾æ°¸è¿œé€‰æ‹©æœ€é•¿çš„åˆ†æ”¯æ¥è¾¾æˆç½‘ç»œä¸Šçš„å…±è¯†ï¼‰\u003c/li\u003e\n\u003cli\u003eç½‘ç»œæ´»åŠ¨çš„é€æ˜æ€§ã€å¯éªŒè¯æ€§ã€å¯å®¡è®¡æ€§ã€‚æˆ‘ä»¬èƒ½è·å–å¯éªŒè¯çš„è¿‡ç¨‹ï¼Œæ— è®ºå®ƒä»¬æ˜¯å¦äº¤æ¢å’Œè·Ÿè¸ªæ•°å­—èµ„äº§ï¼Œè¿˜æ˜¯æ•°æ®é©±åŠ¨çš„äº¤äº’ã€‚æ¯ä¸€ä¸ªè¡Œä¸ºï¼Œéƒ½å­˜æœ‰å…¬å¼€çš„ä¸ç½‘ç»œäº¤äº’çš„è®°å½•ï¼Œå¹¶ä»¥æ­¤æ¥æ¶ˆé™¤äººä¸ºçš„çŸ›ç›¾ã€‚\u003c/li\u003e\n\u003cli\u003eè¿™æ˜¯ä¸€ç§å¯ä»¥æ ‡è®°ä¸åŒä¿¡æ¯çš„è§¦å‘è€…çš„æ–¹æ³•ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨æ²¡æœ‰ä¸­å¤®æƒå¨çš„æƒ…å†µä¸‹å¼ºåˆ¶æ‰§è¡Œã€‚\u003c/li\u003e\n\u003cli\u003eè¿™æ˜¯ä¸€ä¸ªä½¿å¾—ä¸ä¿¡ä»»åŒæ–¹æ ¹æ®å¯é¢„æµ‹çš„ã€ç¡®å®šæ€§çš„æ–¹å¼äº¤äº’çš„ç³»ç»Ÿã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003eæ™ºèƒ½åˆçº¦\u003c/h2\u003e\n\u003cp\u003eè‡ªåŠ¨åŒ–åœ°æ‰§è¡Œä¸€ç³»åˆ—åˆçº¦æ¡æ¬¾çš„äº¤æ˜“åè®®\u003c/p\u003e\n\u003cp\u003eæ™ºèƒ½åˆçº¦æ˜¯å­˜å‚¨åœ¨åŒºå—é“¾ä¸­çš„è„šæœ¬ï¼ˆè®¤è¯†ä¸Šå¯ä»¥ä¸å…³ç³»å‹æ•°æ®åº“çš„å­˜å‚¨è¿‡ç¨‹ç±»ä¼¼ï¼‰ã€‚\u003c/p\u003e\n\u003cp\u003eä»¥åŸºäºè´¦å·çš„æ¨¡å‹ä¸ºä¾‹å¯¹åˆçº¦æ‰§è¡Œè¿›è¡Œæè¿°ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eå‡è®¾å®šä¹‰ä¸€ä¸ªåˆçº¦ï¼ŒåŒ…æ‹¬ä¸‰ä¸ªæ–¹æ³•\n\n(1) â€œå­˜å‚¨â€â€”â€”åˆçº¦çš„â€œå­˜æ¬¾â€åŠŸèƒ½å…è®¸ é˜²é£ï¼ˆé€šè¿‡é˜²é£çš„å¯†é’¥éªŒè¯ï¼‰å°†è‹¥å¹²å•ä½çš„Xå­˜å…¥åˆçº¦ä¸­ï¼›\n(2) â€œäº¤æ˜“â€â€”â€”â€œäº¤æ˜“â€åŠŸèƒ½å…è®¸ä»»ä½•äººå‘åˆçº¦å‘é€5å•ä½Yï¼Œå¹¶ä»åˆçº¦æŒæœ‰çš„Xä¸­è¿”å›1å•ä½ç»™äº¤æ˜“æ–¹ï¼›\n(3) â€œæ’¤é”€â€â€”â€”â€œæ’¤é”€â€åŠŸèƒ½å…è®¸ é˜²é£ å–å‡ºåˆçº¦ä¸­å­˜æœ‰çš„æ‰€æœ‰èµ„äº§ã€‚\n\n    è¯·æ³¨æ„ï¼Œä¸Šè¿°â€œå­˜æ¬¾â€å’Œâ€œæ’¤é”€â€åŠŸèƒ½è¢«é™åˆ¶ä¸ºåªå…è®¸è¢« é˜²é£ï¼ˆå®é™…ä¸Šæ˜¯é˜²é£çš„ç§é’¥ï¼‰è°ƒç”¨ã€‚å½“ç„¶ï¼Œè¿™åªæœ‰ç”±äºä¸Šè¿°åˆçº¦ç”±é˜²é£åˆ¶å®šã€‚è‹¥äººä¸ºçš„åˆ¶å®šä¸€ä¸ªæ‰€æœ‰äººéƒ½èƒ½è°ƒç”¨ä»»ä½•åŠŸèƒ½çš„åˆçº¦ä¹Ÿæ˜¯å…è®¸çš„ï¼ˆè™½ç„¶è¿™åœ¨äº‹å®ä¸Šæ²¡æœ‰æ„ä¹‰ï¼‰ã€‚\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eé‚£ä¹ˆåœ¨åŸºäºè´¦æˆ·çš„æ¨¡å‹ä¸‹ï¼Œå¯ä»¥è®¤ä¸º æ‹¥æœ‰â€œå­˜å‚¨â€ã€â€œäº¤æ˜“â€ã€â€œæ’¤é”€â€æ–¹æ³•çš„åˆçº¦æŒæœ‰ä¸€ä¸ªå•ç‹¬çš„è´¦æˆ·ï¼ˆä¸ç”¨æˆ·æ‰€æŒæœ‰çš„è´¦æˆ·ç­‰ä»·ï¼‰ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨ä¸Šè¿°åˆçº¦ä¸‹ï¼Œè¿™ä¸ªè´¦æˆ·å°†å¯èƒ½æŒæœ‰ä¸€å®šæ•°é‡çš„èµ„äº§ã€‚é™¤äº†åªèƒ½æŒ‰ç…§é¢„å®šçš„åˆçº¦æ­¥éª¤å¯¹èµ„äº§è¿›è¡Œå¤„ç½®ä¹‹å¤–ï¼Œå…¶å®ƒä¸ç”¨æˆ·æŒæœ‰çš„è´¦æˆ·åˆ«æ— äºŒè‡´ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-text\"\u003e  __                    __\n / _| __ _ _ __   __ _ / _| ___ _ __   __ _\n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/\n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003cp\u003e\u003cimg src=\"https://ws3.sinaimg.cn/large/006tKfTcgy1fs8oc4ri7qj30mq055aap.jpg\" alt=\"åŒºå—é“¾ç®€å•ç»“æ„\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws1.sinaimg.cn/large/006tNc79gy1foxcpmmpfhj31kw107n2e.jpg\" alt=\"Merkle tree\"\u003e\u003c/p\u003e"},{"url":"2018-06-11-ASM-ClassReader","fileName":"2018-06-11-ASM-ClassReader.md","title":"ASM - ClassReader ä¸ Java ClassFile æ–‡ä»¶æ ¼å¼","author":"fangfeng","date":"2018-06-11T00:00:00.000Z","tags":[],"content":"\u003ch2\u003eJava ClassFile æ–‡ä»¶æ ¼å¼\u003c/h2\u003e\n\u003cp\u003eè¯»äº†å°†è¿‘ä¸€å‘¨çš„æ—¶é—´ï¼Œå‹‰å¼ºç®—æ˜¯æŠŠ ClassFile çš„æ–‡ä»¶æ ¼å¼ç»™ç®€å•çš„æ¢³ç†äº†ä¸ªè„‰ç»œã€‚\n\u003ca href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/index.html\"\u003eThe class File Format(Java SE 8)\u003c/a\u003e \u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eu1, u2, u4 åˆ†åˆ«è¡¨ç¤ºæ— ç¬¦å·çš„ä¸€å­—èŠ‚ã€äºŒå­—èŠ‚ã€å››å­—èŠ‚æ•°æ®(ä»¥å¤§ç«¯å­˜å‚¨)\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre\u003e\u003ccode class=\"language-c++\"\u003eClassFile {\n    u4             magic;                                   // é­”æ•°(magic) å›ºå®šä¸º 0xCAFEBABE\n    u2             minor_version;                           // æ¬¡ç‰ˆæœ¬å·\n    u2             major_version;                           // ä¸»ç‰ˆæœ¬å·\n    u2             constant_pool_count;                     // å¸¸é‡æ±  constant_pool çš„æ•°é‡ + 1, æœ€å¤§ä¸º (2\u0026#x3C;\u0026#x3C;16 - 1) = 65535\n    cp_info        constant_pool[constant_pool_count-1];    // å¸¸é‡æ±  å–å€¼ä¸‹æ ‡ä¸º [1, constant_pool_count)\n    u2             access_flags;                            // å¯¹ç±» or æ¥å£çš„è®¿é—®æƒé™å’Œå±æ€§çš„æ ‡å¿—çš„æ©ç \n    u2             this_class;                              // å€¼ä¸º constant_pool çš„æœ‰æ•ˆä¸‹æ ‡(ä¸” constant_pool[this_class] çš„ç±»å‹ä¸º CONSTANT_Class_info)\n    u2             super_class;                             // å€¼ä¸º 0 æˆ–è€… constant_pool çš„æœ‰æ•ˆä¸‹æ ‡(åŒä¸Š), å¦‚æœæ˜¯ interface, åˆ™è¯¥å€¼ä¸€å®šä¸ºæœ‰æ•ˆä¸‹æ ‡\n    u2             interfaces_count;                        // ç›´æ¥çˆ¶æ¥å£çš„æ•°é‡\n    u2             interfaces[interfaces_count];            // å€¼å¿…é¡»æ˜¯ constant_pool çš„æœ‰æ•ˆä¸‹æ ‡, ä¸” interfaces[i](0â‰¤i\u0026#x3C;interfaces_count), æŒ‡å‘çš„ç±»å‹ä¸º CONSTANT_Class_info)\n    u2             fields_count;                            // å­—æ®µæ•°é‡, ç»Ÿè®¡æ‰€æœ‰å­—æ®µ, åŒ…æ‹¬ class variables(é™æ€å˜é‡) å’Œ instance variables(å®ä¾‹å˜é‡)\n    field_info     fields[fields_count];                    // å­—æ®µçš„è¯¦ç»†å£°æ˜, ä¸åŒ…å«ç»§æ‰¿æ¥çš„å­—æ®µ\n    u2             methods_count;                           // æ–¹æ³•æ•°é‡\n    method_info    methods[methods_count];                  // æ–¹æ³•çš„è¯¦ç»†å£°æ˜, ä¸åŒ…æ‹¬ç»§æ‰¿æ¥çš„æ–¹æ³•\n    u2             attributes_count;                        // å±æ€§æ•°é‡\n    attribute_info attributes[attributes_count];            // å±æ€§çš„è¯¦ç»†å£°æ˜\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eé€šè¿‡ \u003ccode\u003ejavac Xxx.java\u003c/code\u003e å‘½ä»¤å¾—åˆ°çš„ \u003ccode\u003eXxx.class\u003c/code\u003e æ–‡ä»¶ä¸¥æ ¼æŒ‰ç…§å®šä¹‰çš„ ClassFile æ–‡ä»¶æ ¼å¼ä»¥8æ¯”ç‰¹çš„å­—èŠ‚ä¸ºå•ä½è¿›è¡Œå­˜å‚¨ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eä¸‹é¢çš„ä¾‹å­éƒ½å°†é€šè¿‡ Trie.java (å®é™…ä»£ç è§æœ¬æ–‡æœ€å) ä»¥åŠå…¶ç»ç¼–è¯‘åçš„æ–‡ä»¶ Trie.class åšåŸºæœ¬çš„ä»‹ç»ã€‚\u003c/strong\u003e\u003c/p\u003e\n\u003ch3\u003emagic, minor_verion \u0026#x26; major_version\u003c/h3\u003e\n\u003cp\u003eé€šè¿‡å‘½ä»¤ \u003ccode\u003exxd Trie.class\u003c/code\u003e æŸ¥çœ‹ Trie.class çš„åå…­è¿›åˆ¶ç¼–ç ï¼Œå‰16å­—èŠ‚çš„å†…å®¹å¦‚ä¸‹:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-text\"\u003e00000000: cafe babe 0000 0034 008f 0a00 2400 4b09  .......4....$.K.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¯ä»¥çœ‹åˆ°å‰4å­—èŠ‚çš„å†…å®¹ \u003ccode\u003e0xcafebabe\u003c/code\u003eï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ï¼Œä½†æ˜¯ä½œä¸ºå…¶æ˜¯èƒ½å¦è¢«JVM(Java Virtual Machine, Javaè™šæ‹Ÿæœº)æ¥æ”¶çš„Classæ–‡ä»¶çš„ä¸€ä¸ªæ ¡éªŒã€‚\u003c/p\u003e\n\u003cp\u003eç´§æ¥ç€çš„4ä¸ªå­—èŠ‚åŒ…æ‹¬\u003ccode\u003eæ¬¡ç‰ˆæœ¬å·\u003c/code\u003e å’Œ \u003ccode\u003eä¸»ç‰ˆæœ¬å·\u003c/code\u003eï¼Œæš‚æ—¶ä¸åšæ·±å…¥ã€‚\u003c/p\u003e\n\u003ch3\u003eå¸¸é‡æ±  constant_pool\u003c/h3\u003e\n\u003cp\u003eä»ç¬¬10ä¸ªå­—èŠ‚å¼€å§‹(ä»ç¬¬0å­—èŠ‚å¼€å§‹è®¡æ•°)ï¼Œè¿ç»­çš„ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºå¸¸é‡æ± ä¸­å„ç§ CONSTANT çš„æ€»ä¸ªæ•°+1 (constant_pool_count)ã€‚constant_pool_count åªæœ‰2å­—èŠ‚ä¹Ÿå°±æ„å‘³ç€: å¸¸é‡æ± çš„æœ€å¤§å¸¸é‡æ•°é‡ä¸º (2\u0026#x3C;\u0026#x3C;16 - 1) = 65535 (å½“ç„¶ï¼Œè²Œä¼¼åœ¨è¿™ä¸ªé‡çº§ä¸Šï¼Œä¹Ÿä»æ²¡è§è¿‡æœ‰è°èƒ½å¤Ÿç»´æŠ¤è¿™æ ·ä¸€ä¸ªå¤§JAVAç±»æ–‡ä»¶äº†)ã€‚\u003c/p\u003e\n\u003cp\u003eå¯ä»¥çœ‹åˆ° constant_pool_count çš„å†…å®¹ä¸º \u003ccode\u003e0x008f = 143\u003c/code\u003e ï¼Œå³å¯¹äºå¸¸é‡æ± çš„å£°æ˜å¯ä»¥è®¤ä¸ºæ˜¯ \u003ccode\u003ecp_info constant_pool[142]\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-text\"\u003ecp_info {\n    u1 tag;\n    u1 info[]; \n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåˆ©ç”¨ JDK è‡ªå¸¦çš„ \u003ccode\u003ejavap\u003c/code\u003e æ¥æŸ¥çœ‹ \u003ccode\u003eTrie.class\u003c/code\u003e æ–‡ä»¶(\u003ccode\u003ejavap -v Trie.class\u003c/code\u003e)ï¼Œå¯ä»¥å¯¹ cp_info çš„æ ¼å¼æœ‰ä¸€ä¸ªç²—æµ…ä½†å½¢è±¡åŒ–çš„è®¤è¯†(ç»“æœè§\u003cstrong\u003eé™„å½•2\u003c/strong\u003e)\nå…¶ä¸­ç¬¬ä¸€åˆ—çš„å†…å®¹ \u003ccode\u003e#? = ?\u003c/code\u003e \u003ccode\u003e#?\u003c/code\u003eè¡¨ç¤ºidï¼Œ\u003ccode\u003e= ?\u003c/code\u003eè¡¨ç¤ºä¸€ä¸ª cp_info çš„å®é™…ç±»å‹ï¼Œæœ‰ \u003ccode\u003ecp_info.tag\u003c/code\u003e æŒ‡å®šï¼Œå…·ä½“æ˜ å°„è¡¨ä¸º\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eConstant Type\u003c/th\u003e\n\u003cth\u003eValue\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_Class\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e7\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_Fieldref\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e9\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_Methodref\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e10\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_InterfaceMethodref\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e11\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_String\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e8\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_Integer\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e3\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_Float\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e4\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_Long\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e5\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_Double\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e6\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_NameAndType\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e12\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_Utf8\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e1\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_MethodHandle\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e15\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_MethodType\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e16\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_InvokeDynamic\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e18\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_Module\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e19\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eCONSTANT_Package\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e20\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eåœ¨ Java ClassFile çš„æ ¼å¼å®šä¹‰ä¸­ï¼ŒåŒæ—¶å®šä¹‰äº†æ¯ç§ \u003ccode\u003eCONSTANT\u003c/code\u003e çš„é•¿åº¦ä¸æ ¼å¼ã€‚\nä¾‹å¦‚:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-c++\"\u003eCONSTANT_Class_info {\n    u1 tag;\n    u2 name_index;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-c++\"\u003eCONSTANT_Fieldref_info {\n     u1 tag;\n     u2 class_index;\n     u2 name_and_type_index;\n}\nCONSTANT_Methodref_info {\n  u1 tag;\n  u2 class_index;\n  u2 name_and_type_index;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæ›´å¤šçš„ \u003ccode\u003eCONSTANT_XXX\u003c/code\u003e çš„æ ¼å¼å®šä¹‰è§ \u003ca href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4\"\u003eClassFile CONSTANT_XXX ç»“æ„\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eç®€å•è§£æä¸€ä¸‹ cp_info[1]ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-text\"\u003e00000000: cafe babe 0000 0034 008f 0a00 2400 4b09  .......4....$.K.\n\n#1 = Methodref          #36.#75       // java/lang/Object.\"\u0026#x3C;init\u003e\":()V\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003ecp_info[1].tag = 0x0a = 10\u003c/code\u003eï¼Œå³ cp_info[1] çš„ç±»å‹ä¸º Methodref ã€‚\nä¹‹åå°±ç›´æ¥å¥—ç”¨ \u003ccode\u003eCONSTANT_Methodref_info\u003c/code\u003e çš„æ•°æ®ç»“æ„å®šä¹‰çš„æ ¼å¼\n\u003ccode\u003ecp_info[1].class_index = 0x0024 = 36\u003c/code\u003eï¼Œå³ cp_info[1].class_index è¡¨ç¤ºçš„ç±»åæŒ‡å‘å¸¸é‡æ± ç¬¬ 36 ä¸ªå…ƒç´ è¡¨ç¤ºçš„ç±»\n\u003ccode\u003ecp_info[1].name_and_type_index = 0x004b = 75\u003c/code\u003eã€‚è¡¨ç¤ºæŒ‡å‘çš„æ˜¯å¸¸é‡æ± ç¬¬ 75 ä¸ªå…ƒç´ è¡¨ç¤ºçš„ NameAndType ç»“æ„\u003c/p\u003e\n\u003cp\u003eå¯¹äºè¿™éƒ¨åˆ†å†…å®¹çš„ç†è§£ï¼Œå¦‚æœè§‰å¾—æœ‰èƒ½å¤Ÿé˜…è¯»è‹±æ–‡æ–‡æ¡£ï¼Œå¯ä»¥å‚è€ƒ \u003ca href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/index.html\"\u003eThe JavaÂ® Virtual Machine Specification Chap 4.\u003c/a\u003e\nå¦åˆ™ï¼Œå¯ä»¥é€‰æ‹© \u003ca href=\"http://icyfenix.iteye.com/blog/1256329\"\u003eJava è™šæ‹Ÿæœºè§„èŒƒ(Java SE 7 ç‰ˆ) ç¬¬å››ç« \u003c/a\u003e\nå¹¶å°è¯•æ ¹æ®ç»ç¼–è¯‘å.classæ–‡ä»¶çš„äºŒè¿›åˆ¶ç è¿›è¡Œäººå·¥è§£æï¼Œä»¥åŠ æ·±å¯¹æ­¤çš„ç†è§£ã€‚\u003c/p\u003e\n\u003ch3\u003emore...\u003c/h3\u003e\n\u003cp\u003eæ›´å¤šå†…å®¹äºæ­¤åŸºæœ¬ç±»ä¼¼ï¼Œå‡å±äºå·²ç»è¢«ä¸¥æ ¼é¢„å®šä¹‰çš„è§„èŒƒåŒ–æ ¼å¼ï¼Œå¯¹æ­¤è¿›è¡Œè§£æå³å¯å¾—åˆ°ç›¸åº”çš„å†…å®¹ã€‚\u003c/p\u003e\n\u003ch2\u003eASM æ¦‚è§ˆ\u003c/h2\u003e\n\u003ch3\u003eåŒ…ç»“æ„\u003c/h3\u003e\n\u003cp\u003easm, asm-analysis, asm-commons, asm-tree, asm-util, asm-xml æ¨¡å—åŸºäº Maven çš„ç»„ç»‡å½¢å¼ï¼Œå¹¶åŒ…å«æœ‰å•å…ƒæµ‹è¯•çš„å†…å®¹ã€‚\u003c/p\u003e\n\u003cp\u003easm-test å®ç°äº†å¯¹ä¸Šè¿°æ¨¡å—çš„å•å…ƒæµ‹è¯•çš„æ•´åˆã€‚\u003c/p\u003e\n\u003cp\u003ebenchmarks å®šä¹‰äº†ä¸€äº›åŸºæœ¬çš„ JMH åŸºå‡†æµ‹è¯•æ¥è¡¡é‡ASMçš„è¡¨ç°\u003c/p\u003e\n\u003cp\u003egradle åŒ…å«äº†ä¸€äº› Gradle åŒ…è£…å™¨ï¼Œæ¥è¾…åŠ© Linux or Windows è„šæœ¬çš„è°ƒç”¨è¯·æ±‚\u003c/p\u003e\n\u003cp\u003etools åŒ…å«ä¸¤ä¸ª Gradle é¡¹ç›®æ¥å¸®åŠ© ASM ç”Ÿæˆ Artifacts ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws1.sinaimg.cn/large/006tKfTcgy1frywra01upj308g0akmxr.jpg\" alt=\"ASM Structure\"\u003e\u003c/p\u003e\n\u003ch3\u003eä»£ç ç»„ç»‡å½¢å¼\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"http://asm.ow2.io/asm-package-dependencies.svg\" alt=\"Code Organization\"\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eorg.objectweb.asm ä½œä¸ºæ ¸å¿ƒåŒ…ï¼Œå®šä¹‰äº† ASM è®¿é—®è€… API ä»¥åŠä¸¤ä¸ªæ ¸å¿ƒç±» ClassReader \u0026#x26; ClassWriter æ¥è¯»å†™ç¼–è¯‘åçš„ Java ç±»ã€‚è¯¥åŒ…ä¸ä¾èµ–äºå…¶ä»–åŒ…ï¼Œä¸”å¯å•ç‹¬ä½¿ç”¨\u003c/li\u003e\n\u003cli\u003eorg.objectweb.asm.signature æä¾›äº†è¯»å†™æ³›å‹ç­¾åçš„ API\u003c/li\u003e\n\u003cli\u003eorg.objectweb.asm.tree æä¾›äº†ç±» DOM API ä¸ç±» SAX APIã€‚\u003c/li\u003e\n\u003cli\u003eorg.objectweb.asm.tree.analysis åŸºäº .tree æä¾›äº†é™æ€å­—èŠ‚ç åˆ†ææ¡†æ¶\u003c/li\u003e\n\u003cli\u003eorg.objectweb.asm.commons æä¾›äº†ä¸€äº›åŸºäº core å’Œ tree åŒ…çš„ç±»é€‚é…å™¨ã€‚\u003c/li\u003e\n\u003cli\u003eorg.objectweb.asm.util æä¾›äº†ä¸€äº›ç”¨äº DEBUG çš„è®¿é—®è€…ç±»ä¸é€‚é…å™¨ç±»\u003c/li\u003e\n\u003cli\u003eorg.objectweb.asm.xml ç›®å‰å·²ç»è¢« @Deprecated ã€‚æä¾›äº†ç±»æ–‡ä»¶ä¸ XML äº’ç›¸è½¬æ¢çš„èƒ½åŠ›\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç»¼ä¸Šï¼Œasm æ ¸å¿ƒåŒ…æ˜¯æœ€ä¸ºå¤æ‚çš„ä¸€ä¸ªæ¨¡å—ï¼Œè€Œå…¶å®ƒè¯¸å¦‚ tree, util, xml ç­‰éƒ½åªæ˜¯æä¾›äº†å°† JAVA ç±»ä»ä¸€ç§é«˜çº§è¡¨ç¤ºå½¢æ€è½¬æ¢ä¸ºå¦ä¸€ç§çš„èƒ½åŠ›ã€‚signature ä¹Ÿç›¸å½“ç®€å•ï¼Œæä¾›äº†è§£æå’Œæ‰“å°ç®€å•è¯­æ³•çš„èƒ½åŠ›ã€‚\u003c/p\u003e\n\u003ch3\u003eä¸»è¦æ•°æ®ç»“æ„\u003c/h3\u003e\n\u003cp\u003eæ ¸å¿ƒåŒ…ç”± 28 ä¸ªç±»(æ¥å£) ç»„æˆã€‚å¦‚æœä¸è€ƒè™‘ Opcodes æ¥å£, 5 ä¸ªæŠ½è±¡è®¿é—®è€…ç±»(AnnotationVistitor, ClassVisitor, FieldVisitor, MethodVisitor and ModuleVisitor), 6 ä¸ªå·¥å…·ç±»(ConstantDynamic, Contants, Handle, Type, TypePath and TypeReference), å‰©ä¸‹ 16 ä¸ªç±»çš„ç”±ä¸‹å›¾æä¾›ä¸€ä¸ªç²—ç•¥çš„å±•ç¤ºã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"http://asm.ow2.io/asm-package-overview.svg\"\u003e\u003c/p\u003e\n\u003cp\u003eç¼–è¯‘ç±»åˆ°è®¿é—®äº‹ä»¶çš„è½¬æ¢åªç”±ä¸€ä¸ªç±» ClassReader ä»¥åŠè¾…åŠ©ç±» Context å®Œæˆã€‚å…¶é€†è¿‡ç¨‹ç”±ä»¥ ClassWriter ä¸ºæ ¸å¿ƒçš„å…¶å®ƒ 14 ä¸ªç±»å®Œæˆã€‚\u003c/p\u003e\n\u003ch3\u003eClassReader\u003c/h3\u003e\n\u003cp\u003eClassReader ä½œä¸º ASM æ ¸å¿ƒåŒ…è§£æç°æœ‰ .class çš„å”¯ä¸€å·¥å…·ï¼Œç»„ç»‡å½¢å¼ç›¸å½“ç®€å•ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåœ¨æ„é€ å‡½æ•°ä¸­å®Œæˆå¯¹å¸¸é‡æ± å’Œå¼•å¯¼æ–¹æ³•çš„è§£æ\u003cul\u003e\n\u003cli\u003eå­˜å‚¨æ¯ä¸ªå¸¸é‡æ± é¡¹ç›®çš„èµ·å§‹åç§»é‡ cpInfoOffsets\u003c/li\u003e\n\u003cli\u003eå­˜å‚¨æ¯ä¸ªå¼•å¯¼æ–¹æ³•çš„èµ·å§‹åç§»é‡ bootstrapMethodOffsets\u003c/li\u003e\n\u003cli\u003eå­˜å‚¨æœ€é•¿å­—ç¬¦ä¸²å¸¸é‡çš„å¤§å° maxStringLength\u003c/li\u003e\n\u003c/ul\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e  ClassReader(final byte[] classFileBuffer, final int classFileOffset, final boolean checkClassVersion) {\n    this.b = classFileBuffer;   // .class æ–‡ä»¶ç¼“å­˜\n    // æ£€æŸ¥ä¸»ç‰ˆæœ¬å·, ç¬¬6,7ä¸ªå­—èŠ‚(ä»0å­—èŠ‚å¼€å§‹è®¡æ•°)\n    if (checkClassVersion \u0026#x26;\u0026#x26; readShort(classFileOffset + 6) \u003e Opcodes.V11) {\n      throw new IllegalArgumentException(\n          \"Unsupported class file major version \" + readShort(classFileOffset + 6));\n    }\n    // åˆ›å»ºå¸¸é‡æ± æ•°ç»„ï¼Œå¸¸é‡æ± é•¿åº¦çš„å®šä¹‰ constant_pool_count åœ¨ç¬¬8,9å­—èŠ‚\n    int constantPoolCount = readUnsignedShort(classFileOffset + 8);     // è¯»å–æ— ç¬¦å·short, å³è¯»å–è¿ç»­ä¸¤å­—èŠ‚ä½œä¸ºä¸€ä¸ªshortå€¼\n    cpInfoOffsets = new int[constantPoolCount];                         // æ¯ä¸ªå¸¸é‡çš„åç§»ä½ç½®\n    cpInfoValues = new Object[constantPoolCount];                       // æ¯ä¸ªå¸¸é‡çš„å®ä¾‹å¯¹è±¡\n    int currentCpInfoIndex = 1;\n    int currentCpInfoOffset = classFileOffset + 10;\n    int currentMaxStringLength = 0;                                     // æœ€é•¿å­—ç¬¦ä¸²å¸¸é‡\n    while (currentCpInfoIndex \u0026#x3C; constantPoolCount) {\n      cpInfoOffsets[currentCpInfoIndex++] = currentCpInfoOffset + 1;\n      int cpInfoSize;\n      switch (classFileBuffer[currentCpInfoOffset]) {\n        case Symbol.CONSTANT_FIELDREF_TAG:\n        case Symbol.CONSTANT_METHODREF_TAG:\n        case Symbol.CONSTANT_INTERFACE_METHODREF_TAG:\n        case Symbol.CONSTANT_INTEGER_TAG:\n        case Symbol.CONSTANT_FLOAT_TAG:\n        case Symbol.CONSTANT_NAME_AND_TYPE_TAG:\n        case Symbol.CONSTANT_INVOKE_DYNAMIC_TAG:\n        case Symbol.CONSTANT_DYNAMIC_TAG:\n          cpInfoSize = 5;\n          break;\n        case Symbol.CONSTANT_LONG_TAG:\n        case Symbol.CONSTANT_DOUBLE_TAG:\n          cpInfoSize = 9;\n          currentCpInfoIndex++;\n          break;\n        case Symbol.CONSTANT_UTF8_TAG:\n          cpInfoSize = 3 + readUnsignedShort(currentCpInfoOffset + 1);\n          if (cpInfoSize \u003e currentMaxStringLength) {\n            // The size in bytes of this CONSTANT_Utf8 structure provides a conservative estimate\n            // of the length in characters of the corresponding string, and is much cheaper to\n            // compute than this exact length.\n            currentMaxStringLength = cpInfoSize;\n          }\n          break;\n        case Symbol.CONSTANT_METHOD_HANDLE_TAG:\n          cpInfoSize = 4;\n          break;\n        case Symbol.CONSTANT_CLASS_TAG:\n        case Symbol.CONSTANT_STRING_TAG:\n        case Symbol.CONSTANT_METHOD_TYPE_TAG:\n        case Symbol.CONSTANT_PACKAGE_TAG:\n        case Symbol.CONSTANT_MODULE_TAG:\n          cpInfoSize = 3;\n          break;\n        default:\n          throw new IllegalArgumentException();\n      }\n      currentCpInfoOffset += cpInfoSize;\n    }\n    this.maxStringLength = currentMaxStringLength;\n    // The Classfile's access_flags field is just after the last constant pool entry.\n    this.header = currentCpInfoOffset;\n\n    // è¯»å– BootstrapMethods å±æ€§(å¦‚æœå­˜åœ¨)\n    int currentAttributeOffset = getFirstAttributeOffset();\n    int[] currentBootstrapMethodOffsets = null;\n    for (int i = readUnsignedShort(currentAttributeOffset - 2); i \u003e 0; --i) {\n      // è¯»å–æ¯ä¸ª attribute_info çš„å±æ€§åå’Œå±æ€§é•¿åº¦\n      String attributeName = readUTF8(currentAttributeOffset, new char[maxStringLength]);\n      int attributeLength = readInt(currentAttributeOffset + 2);\n      currentAttributeOffset += 6;\n      // å¦‚æœå½“å‰å±æ€§åä¸º BootstrapMethods ï¼Œåˆ™è¿›å…¥å¤„ç†é€»è¾‘\n      if (Constants.BOOTSTRAP_METHODS.equals(attributeName)) {\n        // Read the num_bootstrap_methods field and create an array of this size.\n        currentBootstrapMethodOffsets = new int[readUnsignedShort(currentAttributeOffset)];\n        // Compute and store the offset of each 'bootstrap_methods' array field entry.\n        int currentBootstrapMethodOffset = currentAttributeOffset + 2;\n        for (int j = 0; j \u0026#x3C; currentBootstrapMethodOffsets.length; ++j) {\n          currentBootstrapMethodOffsets[j] = currentBootstrapMethodOffset;\n          // Skip the bootstrap_method_ref and num_bootstrap_arguments fields (2 bytes each),\n          // as well as the bootstrap_arguments array field (of size num_bootstrap_arguments * 2).\n          currentBootstrapMethodOffset +=\n              4 + readUnsignedShort(currentBootstrapMethodOffset + 2) * 2;\n        }\n      }\n      currentAttributeOffset += attributeLength;\n    }\n    this.bootstrapMethodOffsets = currentBootstrapMethodOffsets;\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåˆ°æ­¤ä¸ºæ­¢ï¼ŒClassReader å·²ç»è§£æäº†åŒ…æ‹¬ magic, minor version, major version, constant pool ã€‚\nä½†æ˜¯ï¼Œè¯¸å¦‚ field_info, method_info, attribute_info ç­‰ä»ç„¶æ²¡æœ‰å¾—åˆ°å¤„ç†ã€‚\u003c/p\u003e\n\u003cp\u003eè¿™éƒ¨åˆ†çš„å†…å®¹åœ¨ accept(...) å’Œ readXXX(...) ä¸­å°†å¾—åˆ°è§£æã€‚\u003c/p\u003e\n\u003cp\u003eä¸»è¦æµç¨‹ç±»ä¼¼:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eè¯»å–å½“å‰å†…å®¹çš„åç§»é‡(ç›¸è¾ƒäºæ•´ä¸ª byte[])\u003c/li\u003e\n\u003cli\u003eè§£æå½“å‰çš„å†…å®¹\u003c/li\u003e\n\u003cli\u003eè°ƒç”¨ visitXXX æ–¹æ³•\u003c/li\u003e\n\u003cli\u003eåœ¨ visitXXX æ–¹æ³•ä¸­è¿›è¡Œç›¸å…³çš„å¤„ç†\u003c/li\u003e\n\u003cli\u003evisitEnd\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2\u003eé™„å½•1 Trie.java\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epackage me.fangfeng.filter;\n\nimport java.io.BufferedReader;\nimport java.io.BufferedWriter;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.FileNotFoundException;\nimport java.io.InputStreamReader;\nimport java.io.IOException;\nimport java.io.OutputStreamWriter;\n\n/**\n * @author fangfeng\n * @since 2018/5/16\n */\npublic class Trie {\n    \n    private static int MAX_ITEM = 700000;\n    private static int AVG_LENGTH = 11;\n    private static int MAX_NODE = MAX_ITEM * AVG_LENGTH;\n    private static int CHAR_NUM = 10;\n\n    int[][] nxt = new int[MAX_NODE][CHAR_NUM];\n    boolean[] flag = new boolean[MAX_NODE];\n    int trieIndex = 0;\n\n    void insert(long number) {\n        int tmpIndex = 0;\n        for (;number != 0;number /= 10) {\n            if (nxt[tmpIndex][(int) (number % 10)] == 0) {\n                nxt[tmpIndex][(int) (number % 10)] = ++trieIndex;\n            }\n            tmpIndex = nxt[tmpIndex][(int) (number % 10)];\n        }\n        flag[tmpIndex] = true;\n    }\n\n    boolean query(long number) {\n        int tmpIndex = 0;\n        for (;number != 0;number /= 10) {\n            if (nxt[tmpIndex][(int) (number % 10)] == 0) {\n                return false;\n            }\n            tmpIndex = nxt[tmpIndex][(int) (number % 10)];\n        }\n        return flag[tmpIndex];\n    }\n\n    public static void main(String... args) throws FileNotFoundException, IOException {\n\n        long start = System.currentTimeMillis();\n\n        String ruleFilePath = args[0];\n        String sendFilePath = args[1];\n        String outFilePath = args[2];\n\n        BufferedReader ruleReader = new BufferedReader(new InputStreamReader(new FileInputStream(ruleFilePath)));\n        BufferedReader sendReader = new BufferedReader(new InputStreamReader(new FileInputStream(sendFilePath)));\n\n        BufferedWriter outWriter = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(outFilePath)));\n\n        Trie trie = new Trie();\n        String mobile;\n        while((mobile = ruleReader.readLine()) != null) {\n            trie.insert(Long.parseLong(mobile));\n        }\n        ruleReader.close();\n\n        while((mobile = sendReader.readLine()) != null) {\n            if(trie.query(Long.parseLong(mobile)) == false) {\n                outWriter.write(mobile);\n                outWriter.newLine();\n            }\n        }\n        sendReader.close();\n\n        outWriter.flush();\n        outWriter.close();\n\n        long end = System.currentTimeMillis();\n        System.out.println(String.format(\"exec success! used %d ms\", end - start));\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eé™„å½•2 Constant pool\u003c/h2\u003e\n\u003cpre\u003e\u003ccode\u003eConstant pool:\n    #1 = Methodref          #36.#75       // java/lang/Object.\"\u0026#x3C;init\u003e\":()V\n    #2 = Fieldref           #23.#76       // me/fangfeng/filter/Trie.MAX_NODE:I\n    #3 = Fieldref           #23.#77       // me/fangfeng/filter/Trie.CHAR_NUM:I\n    #4 = Class              #49           // \"[[I\"\n    #5 = Fieldref           #23.#78       // me/fangfeng/filter/Trie.nxt:[[I\n    #6 = Fieldref           #23.#79       // me/fangfeng/filter/Trie.flag:[Z\n    #7 = Fieldref           #23.#80       // me/fangfeng/filter/Trie.trieIndex:I\n    #8 = Long               10l\n   #10 = Methodref          #81.#82       // java/lang/System.currentTimeMillis:()J\n   #11 = Class              #83           // java/io/BufferedReader\n   #12 = Class              #84           // java/io/InputStreamReader\n   #13 = Class              #85           // java/io/FileInputStream\n   #14 = Methodref          #13.#86       // java/io/FileInputStream.\"\u0026#x3C;init\u003e\":(Ljava/lang/String;)V\n   #15 = Methodref          #12.#87       // java/io/InputStreamReader.\"\u0026#x3C;init\u003e\":(Ljava/io/InputStream;)V\n   #16 = Methodref          #11.#88       // java/io/BufferedReader.\"\u0026#x3C;init\u003e\":(Ljava/io/Reader;)V\n   #17 = Class              #89           // java/io/BufferedWriter\n   #18 = Class              #90           // java/io/OutputStreamWriter\n   #19 = Class              #91           // java/io/FileOutputStream\n   #20 = Methodref          #19.#86       // java/io/FileOutputStream.\"\u0026#x3C;init\u003e\":(Ljava/lang/String;)V\n   #21 = Methodref          #18.#92       // java/io/OutputStreamWriter.\"\u0026#x3C;init\u003e\":(Ljava/io/OutputStream;)V\n   #22 = Methodref          #17.#93       // java/io/BufferedWriter.\"\u0026#x3C;init\u003e\":(Ljava/io/Writer;)V\n   #23 = Class              #94           // me/fangfeng/filter/Trie\n   #24 = Methodref          #23.#75       // me/fangfeng/filter/Trie.\"\u0026#x3C;init\u003e\":()V\n   #25 = Methodref          #11.#95       // java/io/BufferedReader.readLine:()Ljava/lang/String;\n   #26 = Methodref          #96.#97       // java/lang/Long.parseLong:(Ljava/lang/String;)J\n   #27 = Methodref          #23.#98       // me/fangfeng/filter/Trie.insert:(J)V\n   #28 = Methodref          #11.#99       // java/io/BufferedReader.close:()V\n   #29 = Methodref          #23.#100      // me/fangfeng/filter/Trie.query:(J)Z\n   #30 = Methodref          #17.#101      // java/io/BufferedWriter.write:(Ljava/lang/String;)V\n   #31 = Methodref          #17.#102      // java/io/BufferedWriter.newLine:()V\n   #32 = Methodref          #17.#103      // java/io/BufferedWriter.flush:()V\n   #33 = Methodref          #17.#99       // java/io/BufferedWriter.close:()V\n   #34 = Fieldref           #81.#104      // java/lang/System.out:Ljava/io/PrintStream;\n   #35 = String             #105          // exec success! used %d ms\n   #36 = Class              #106          // java/lang/Object\n   #37 = Methodref          #96.#107      // java/lang/Long.valueOf:(J)Ljava/lang/Long;\n   #38 = Methodref          #108.#109     // java/lang/String.format:(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;\n   #39 = Methodref          #110.#111     // java/io/PrintStream.println:(Ljava/lang/String;)V\n   #40 = Integer            700000\n   #41 = Fieldref           #23.#112      // me/fangfeng/filter/Trie.MAX_ITEM:I\n   #42 = Fieldref           #23.#113      // me/fangfeng/filter/Trie.AVG_LENGTH:I\n   #43 = Utf8               MAX_ITEM\n   #44 = Utf8               I\n   #45 = Utf8               AVG_LENGTH\n   #46 = Utf8               MAX_NODE\n   #47 = Utf8               CHAR_NUM\n   #48 = Utf8               nxt\n   #49 = Utf8               [[I\n   #50 = Utf8               flag\n   #51 = Utf8               [Z\n   #52 = Utf8               trieIndex\n   #53 = Utf8               \u0026#x3C;init\u003e\n   #54 = Utf8               ()V\n   #55 = Utf8               Code\n   #56 = Utf8               LineNumberTable\n   #57 = Utf8               insert\n   #58 = Utf8               (J)V\n   #59 = Utf8               StackMapTable\n   #60 = Utf8               query\n   #61 = Utf8               (J)Z\n   #62 = Utf8               main\n   #63 = Utf8               ([Ljava/lang/String;)V\n   #64 = Class              #114          // \"[Ljava/lang/String;\"\n   #65 = Class              #115          // java/lang/String\n   #66 = Class              #83           // java/io/BufferedReader\n   #67 = Class              #89           // java/io/BufferedWriter\n   #68 = Class              #94           // me/fangfeng/filter/Trie\n   #69 = Utf8               Exceptions\n   #70 = Class              #116          // java/io/FileNotFoundException\n   #71 = Class              #117          // java/io/IOException\n   #72 = Utf8               \u0026#x3C;clinit\u003e\n   #73 = Utf8               SourceFile\n   #74 = Utf8               Trie.java\n   #75 = NameAndType        #53:#54       // \"\u0026#x3C;init\u003e\":()V\n   #76 = NameAndType        #46:#44       // MAX_NODE:I\n   #77 = NameAndType        #47:#44       // CHAR_NUM:I\n   #78 = NameAndType        #48:#49       // nxt:[[I\n   #79 = NameAndType        #50:#51       // flag:[Z\n   #80 = NameAndType        #52:#44       // trieIndex:I\n   #81 = Class              #118          // java/lang/System\n   #82 = NameAndType        #119:#120     // currentTimeMillis:()J\n   #83 = Utf8               java/io/BufferedReader\n   #84 = Utf8               java/io/InputStreamReader\n   #85 = Utf8               java/io/FileInputStream\n   #86 = NameAndType        #53:#121      // \"\u0026#x3C;init\u003e\":(Ljava/lang/String;)V\n   #87 = NameAndType        #53:#122      // \"\u0026#x3C;init\u003e\":(Ljava/io/InputStream;)V\n   #88 = NameAndType        #53:#123      // \"\u0026#x3C;init\u003e\":(Ljava/io/Reader;)V\n   #89 = Utf8               java/io/BufferedWriter\n   #90 = Utf8               java/io/OutputStreamWriter\n   #91 = Utf8               java/io/FileOutputStream\n   #92 = NameAndType        #53:#124      // \"\u0026#x3C;init\u003e\":(Ljava/io/OutputStream;)V\n   #93 = NameAndType        #53:#125      // \"\u0026#x3C;init\u003e\":(Ljava/io/Writer;)V\n   #94 = Utf8               me/fangfeng/filter/Trie\n   #95 = NameAndType        #126:#127     // readLine:()Ljava/lang/String;\n   #96 = Class              #128          // java/lang/Long\n   #97 = NameAndType        #129:#130     // parseLong:(Ljava/lang/String;)J\n   #98 = NameAndType        #57:#58       // insert:(J)V\n   #99 = NameAndType        #131:#54      // close:()V\n  #100 = NameAndType        #60:#61       // query:(J)Z\n  #101 = NameAndType        #132:#121     // write:(Ljava/lang/String;)V\n  #102 = NameAndType        #133:#54      // newLine:()V\n  #103 = NameAndType        #134:#54      // flush:()V\n  #104 = NameAndType        #135:#136     // out:Ljava/io/PrintStream;\n  #105 = Utf8               exec success! used %d ms\n  #106 = Utf8               java/lang/Object\n  #107 = NameAndType        #137:#138     // valueOf:(J)Ljava/lang/Long;\n  #108 = Class              #115          // java/lang/String\n  #109 = NameAndType        #139:#140     // format:(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;\n  #110 = Class              #141          // java/io/PrintStream\n  #111 = NameAndType        #142:#121     // println:(Ljava/lang/String;)V\n  #112 = NameAndType        #43:#44       // MAX_ITEM:I\n  #113 = NameAndType        #45:#44       // AVG_LENGTH:I\n  #114 = Utf8               [Ljava/lang/String;\n  #115 = Utf8               java/lang/String\n  #116 = Utf8               java/io/FileNotFoundException\n  #117 = Utf8               java/io/IOException\n  #118 = Utf8               java/lang/System\n  #119 = Utf8               currentTimeMillis\n  #120 = Utf8               ()J\n  #121 = Utf8               (Ljava/lang/String;)V\n  #122 = Utf8               (Ljava/io/InputStream;)V\n  #123 = Utf8               (Ljava/io/Reader;)V\n  #124 = Utf8               (Ljava/io/OutputStream;)V\n  #125 = Utf8               (Ljava/io/Writer;)V\n  #126 = Utf8               readLine\n  #127 = Utf8               ()Ljava/lang/String;\n  #128 = Utf8               java/lang/Long\n  #129 = Utf8               parseLong\n  #130 = Utf8               (Ljava/lang/String;)J\n  #131 = Utf8               close\n  #132 = Utf8               write\n  #133 = Utf8               newLine\n  #134 = Utf8               flush\n  #135 = Utf8               out\n  #136 = Utf8               Ljava/io/PrintStream;\n  #137 = Utf8               valueOf\n  #138 = Utf8               (J)Ljava/lang/Long;\n  #139 = Utf8               format\n  #140 = Utf8               (Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;\n  #141 = Utf8               java/io/PrintStream\n  #142 = Utf8               println\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eå‚è€ƒ\u003c/h2\u003e\n\u003cp\u003e[1]: \u003ca href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/index.html\"\u003ehttps://docs.oracle.com/javase/specs/jvms/se8/html/index.html\u003c/a\u003e \"Java Virtual Machine Specification\"\n[2]: \u003ca href=\"http://icyfenix.iteye.com/blog/1256329\"\u003ehttp://icyfenix.iteye.com/blog/1256329\u003c/a\u003e \"Javaè™šæ‹Ÿæœºè§„èŒƒï¼ˆJava SE 7 ä¸­æ–‡ç‰ˆï¼‰\"\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003ch2\u003eJava ClassFile æ–‡ä»¶æ ¼å¼\u003c/h2\u003e\n\u003cp\u003eè¯»äº†å°†è¿‘ä¸€å‘¨çš„æ—¶é—´ï¼Œå‹‰å¼ºç®—æ˜¯æŠŠ ClassFile çš„æ–‡ä»¶æ ¼å¼ç»™ç®€å•çš„æ¢³ç†äº†ä¸ªè„‰ç»œã€‚\n\u003ca href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/index.html\"\u003eThe class File Format(Java SE 8)\u003c/a\u003e \u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eu1, u2, u4 åˆ†åˆ«è¡¨ç¤ºæ— ç¬¦å·çš„ä¸€å­—èŠ‚ã€äºŒå­—èŠ‚ã€å››å­—èŠ‚æ•°æ®(ä»¥å¤§ç«¯å­˜å‚¨)\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre\u003e\u003ccode class=\"language-c++\"\u003eClassFile {\n    u4             magic;                                   // é­”æ•°(magic) å›ºå®šä¸º 0xCAFEBABE\n    u2             minor_version;                           // æ¬¡ç‰ˆæœ¬å·\n    u2             major_version;                           // ä¸»ç‰ˆæœ¬å·\n    u2             constant_pool_count;                     // å¸¸é‡æ±  constant_pool çš„æ•°é‡ + 1, æœ€å¤§ä¸º (2\u0026#x3C;\u0026#x3C;16 - 1) = 65535\n    cp_info        constant_pool[constant_pool_count-1];    // å¸¸é‡æ±  å–å€¼ä¸‹æ ‡ä¸º [1, constant_pool_count)\n    u2             access_flags;                            // å¯¹ç±» or æ¥å£çš„è®¿é—®æƒé™å’Œå±æ€§çš„æ ‡å¿—çš„æ©ç \n    u2             this_class;                              // å€¼ä¸º constant_pool çš„æœ‰æ•ˆä¸‹æ ‡(ä¸” constant_pool[this_class] çš„ç±»å‹ä¸º CONSTANT_Class_info)\n    u2             super_class;                             // å€¼ä¸º 0 æˆ–è€… constant_pool çš„æœ‰æ•ˆä¸‹æ ‡(åŒä¸Š), å¦‚æœæ˜¯ interface, åˆ™è¯¥å€¼ä¸€å®šä¸ºæœ‰æ•ˆä¸‹æ ‡\n    u2             interfaces_count;                        // ç›´æ¥çˆ¶æ¥å£çš„æ•°é‡\n    u2             interfaces[interfaces_count];            // å€¼å¿…é¡»æ˜¯ constant_pool çš„æœ‰æ•ˆä¸‹æ ‡, ä¸” interfaces[i](0â‰¤i\u0026#x3C;interfaces_count), æŒ‡å‘çš„ç±»å‹ä¸º CONSTANT_Class_info)\n    u2             fields_count;                            // å­—æ®µæ•°é‡, ç»Ÿè®¡æ‰€æœ‰å­—æ®µ, åŒ…æ‹¬ class variables(é™æ€å˜é‡) å’Œ instance variables(å®ä¾‹å˜é‡)\n    field_info     fields[fields_count];                    // å­—æ®µçš„è¯¦ç»†å£°æ˜, ä¸åŒ…å«ç»§æ‰¿æ¥çš„å­—æ®µ\n    u2             methods_count;                           // æ–¹æ³•æ•°é‡\n    method_info    methods[methods_count];                  // æ–¹æ³•çš„è¯¦ç»†å£°æ˜, ä¸åŒ…æ‹¬ç»§æ‰¿æ¥çš„æ–¹æ³•\n    u2             attributes_count;                        // å±æ€§æ•°é‡\n    attribute_info attributes[attributes_count];            // å±æ€§çš„è¯¦ç»†å£°æ˜\n}\n\u003c/code\u003e\u003c/pre\u003e"},{"url":"2018-06-21-java-memory-model","fileName":"2018-06-21-java-memory-model.md","title":"java-memory-model","author":"fangfeng","date":"2018-06-21T00:00:00.000Z","tags":["Java","JVM","Memory Model"],"content":"\u003ch2\u003eJVM è¿è¡Œæ—¶æ•°æ®åŒº\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"https://ws4.sinaimg.cn/large/006tNc79gy1ft5osi6it1j31kw0ql78e.jpg\"\u003e\u003c/p\u003e\n\u003ch3\u003ePCå¯„å­˜å™¨\u003c/h3\u003e\n\u003cp\u003eä¸æ“ä½œç³»ç»Ÿä¸­çš„PCå¯„å­˜å™¨åŠŸèƒ½åŸºæœ¬ä¸€è‡´ã€‚æ¯•ç«Ÿ JVM å»ºç«‹çš„åˆè¡·å°±æ˜¯æ¨¡æ‹Ÿä¸€å°æœºå™¨ã€‚\næŒ‡å‘å­˜å‚¨åœ¨\u003cstrong\u003eæ–¹æ³•åŒº\u003c/strong\u003eçš„å­—èŠ‚ç methods_infoéƒ¨åˆ†çš„å†…å­˜åœ°å€ã€‚\u003c/p\u003e\n\u003ch3\u003eè™šæ‹Ÿæœºæ ˆ\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eè™šæ‹Ÿæœºæ ˆ\u003c/strong\u003eç”¨äºå­˜å‚¨\u003cstrong\u003eæ ˆå¸§\u003c/strong\u003e\u003c/p\u003e\n\u003ch3\u003eæœ¬åœ°æ–¹æ³•æ ˆ\u003c/h3\u003e\n\u003cp\u003eç”¨äºæ”¯æŒ native æ–¹æ³•çš„æ‰§è¡Œ\u003c/p\u003e\n\u003ch3\u003eæ ˆå¸§\u003c/h3\u003e\n\u003cp\u003eå­˜å‚¨åœ¨\u003cstrong\u003eè™šæ‹Ÿæœºæ ˆ\u003c/strong\u003eä¸­ï¼Œä¸»è¦åŒ…æ‹¬\u003cstrong\u003eå±€éƒ¨å˜é‡è¡¨\u003c/strong\u003eå’Œ\u003cstrong\u003eæ“ä½œæ•°æ ˆ\u003c/strong\u003e(åˆç§°\u003cstrong\u003eå½“å‰æ ˆå¸§çš„æ“ä½œæ•°æ ˆ\u003c/strong\u003e)ä»¥åŠ\u003cstrong\u003eè¿è¡Œæ—¶å¸¸é‡æ± çš„å¼•ç”¨\u003c/strong\u003eã€‚\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eä»ç„¶æœ‰å¿…è¦åŒºåˆ«ä¸¤ä¸ªæ¦‚å¿µ: æ“ä½œæ•° \u0026#x26; æŒ‡ä»¤\u003c/em\u003e\n\u003cem\u003eæŒ‡ä»¤æŒ‡ä½¿æ“ä½œæ•°è¿›è¡Œç›¸å…³æ“ä½œçš„åŸºæœ¬å‘½ä»¤\u003c/em\u003e\n\u003cem\u003eæ“ä½œæ•°é€šå¸¸æŒ‡æ•´æ•°ã€æµ®ç‚¹æ•°ä»¥åŠç±»å‹å¼•ç”¨ç­‰\u003c/em\u003e\u003c/p\u003e\n\u003ch3\u003eæ–¹æ³•åŒº\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eæ–¹æ³•åŒº\u003c/strong\u003eæ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„ä¸€å—åŒºåŸŸï¼Œä¸»è¦ç”¨äºå­˜å‚¨I/Oæ“ä½œä¸­è¯»å…¥çš„ç±»/æ¥å£çš„å­—èŠ‚ç (ClassFile æ–‡ä»¶)\nåŒ…æ‹¬æœ‰ constant_pool, field_info, method_info, attribute_info ç­‰\u003c/p\u003e\n\u003ch3\u003eJavaå †\u003c/h3\u003e\n\u003cp\u003eç”¨äºå­˜å‚¨å„ç§ç±»çš„å®ä¾‹å¯¹è±¡\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003ch2\u003eJVM è¿è¡Œæ—¶æ•°æ®åŒº\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"https://ws4.sinaimg.cn/large/006tNc79gy1ft5osi6it1j31kw0ql78e.jpg\"\u003e\u003c/p\u003e"},{"url":"2018-06-25-ASM-Core","fileName":"2018-06-25-ASM-Core.md","title":"ASM æ ¸å¿ƒåŒ…åŸºæœ¬å†…å®¹æ¼«è°ˆ","author":"fangfeng","date":"2018-06-25T00:00:00.000Z","tags":["Java","ASM","Visitor Pattern"],"content":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡æè¿°çš„ ASM æŒ‡çš„æ˜¯ OW2 ASM\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2\u003eASM-Core çš„ç»“æ„\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eé¦–å…ˆæ˜¯ä¸€äº›æ¦‚è¿°æ€§çš„å†…å®¹ã€‚\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eç”±äº ASM æ“ä½œçš„ JAVA å­—èŠ‚ç æœ‰ä¸¥æ ¼çš„æ ¼å¼è§„å®šï¼Œä¸”å³ä½¿éšç€ JVM æ ‡å‡†çš„å‡çº§ä¹Ÿæå°‘å‡ºç°é‡å¤§è°ƒæ•´ã€‚\nå› æ­¤é€‚ç”¨é¢ç‹­çª„çš„è®¿é—®è€…æ¨¡å¼åœ¨è¯¥é¡¹ç›®ä¸­è¢«å¤§é‡åœ°ä½¿ç”¨ï¼Œå¹¶ä¸”å·²ç»åˆ°äº†ä¸§å¿ƒç—…ç‹‚çš„ç¨‹åº¦:)\u003c/p\u003e\n\u003cp\u003eä»æ ¸å¿ƒåŒ…å£°æ˜çš„ç±»æ¥çœ‹ï¼Œä¸»è¦åŒ…æ‹¬:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eClassReader - ä½œä¸ºç»“æ„åŒ–å¯¹è±¡ï¼Œå°†æ¥æ”¶(accept)è®¿é—®è€…çš„è®¿é—®\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eå‡ ç§è®¿é—®è€…æŠ½è±¡ç±»ä»¥åŠç›¸åº”çš„å®ç°ç±»\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eAnnotationVisitor -\u003e AnnotationWriter\u003c/li\u003e\n\u003cli\u003eClassVisitor -\u003e ClassWriter\u003c/li\u003e\n\u003cli\u003eFieldVisitor -\u003e FieldWriter\u003c/li\u003e\n\u003cli\u003eMethodVisitor -\u003e MethodWriter\u003c/li\u003e\n\u003cli\u003eModuleVisitor -\u003e ModuleWriter\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e\n\u003cp\u003eOpcodes \u0026#x26; Constants - ClassFile ä¸­æè¿°çš„å¤§é‡å¸¸é‡ç¬¦å·ä¸å€¼\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eå…¶å®ƒä¸€äº›è¾…åŠ©çš„ç±»\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eAttribute - ç”¨äºå¤„ç†éæ ‡å‡†åŒ–çš„å±æ€§(ClassFile å…è®¸\u003ca href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html\"\u003eJVMS\u003c/a\u003e ä¸­æœªå®šä¹‰çš„ Attribute)\u003c/li\u003e\n\u003cli\u003eByteArray - åŠ¨æ€å¯è‡ªé€‚åº”çš„ byte[] (å­—èŠ‚æ•°ç»„)\u003c/li\u003e\n\u003cli\u003eContext - ClassReader åœ¨è¢«è§£æ(è¢«è®¿é—®)è¿‡ç¨‹ä¸­ç”¨äºè¡¨ç¤ºâ€œç´¯ç§¯çŠ¶æ€â€çš„ä¸€ä¸ªç±»/å¯¹è±¡\u003c/li\u003e\n\u003cli\u003eSymbol - ç”¨äºè¡¨ç¤º ClassFile ä¸­æè¿°çš„ Constant çš„åŸºç±»\u003c/li\u003e\n\u003cli\u003eSymbolTable - ç”¨äºå­˜å‚¨å¸¸é‡æ± å¯¹è±¡\u003c/li\u003e\n\u003cli\u003eå…¶å®ƒå†…å®¹çœç•¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eClassFile æ–‡ä»¶æ ¼å¼\u003c/h2\u003e\n\u003cp\u003eæœ¬èŠ‚çš„å†…å®¹å¯ä»¥å‚é˜… \u003ca href=\"https://dormouse-none.github.io/2018-06-11-ASM-ClassReader/\"\u003eClassFile æ–‡ä»¶æ ¼å¼\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eClassFile æ˜¯ ASM æ“ä½œå­—èŠ‚ç çš„åŸºç¡€ä¸å‰æã€‚åœ¨ JVMS å®šä¹‰äº† .class æ–‡ä»¶æ ¼å¼ä¹‹åï¼ŒASM æ‰åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œäº†å¯¹ ClassFile çš„å­—èŠ‚ç æ“ä½œã€‚\u003c/p\u003e\n\u003cp\u003eå› æ­¤ï¼Œæ— è®ºå¦‚ä½•ï¼Œä¸ªäººè®¤ä¸ºåœ¨çœŸæ­£å¼€å§‹äº†è§£ ASM ä¹‹å‰ï¼Œé€šè¯»ä¸€é ClassFile æ–‡ä»¶æ ¼å¼æ˜¯å®Œå…¨æœ‰å¿…è¦çš„ã€‚å¹¶ä¸”ï¼Œåœ¨åŸºæœ¬äº†è§£ ClassFile å†…å®¹çš„åŸºç¡€ä¸Šï¼Œ\nå°è¯•å¯¹æŸä¸ª .class æ–‡ä»¶è¿›è¡Œæ‰‹å·¥è§£æä¹Ÿä¸å¤±ä¸ºä¸€ç§åŠ æ·±ç†è§£çš„é€”å¾„ã€‚\u003c/p\u003e\n\u003ch2\u003eVisitor Pattern\u003c/h2\u003e\n\u003cp\u003eç”±äº ASM çš„å®ç°é‡‡ç”¨äº†åé—¨çš„è®¿é—®è€…æ¨¡å¼ã€‚å› æ­¤ï¼Œäº†è§£è®¿é—®è€…æ¨¡å¼ä¹Ÿæ˜¯ä¸€ä¸ªå¿…ä¸å¯å°‘çš„é‡è¦ç¯èŠ‚ã€‚åŒæ—¶åœ¨äº†è§£åä¹Ÿå°†ä¸ºæºç é˜…è¯»è€…æä¾›æ›´æ¸…æ™°çš„è§£è¯»æ€è·¯ã€‚\u003c/p\u003e\n\u003cp\u003eã€Šè®¾è®¡æ¨¡å¼ï¼šå¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€ã€‹ä¸€ä¹¦çš„â€œ5.11 VISITOR(è®¿é—®è€…)â€”â€”å¯¹è±¡è¡Œä¸ºå‹æ¨¡å¼â€æä¾›äº†å¾ˆè¯¦å°½çš„è§£é‡Šã€‚\u003c/p\u003e\n\u003cp\u003eæœ¬äººå¯¹è¿™æ–¹é¢çš„ä¸ç”šäº†è§£ï¼Œæ¨èè‡ªè¡ŒæŸ¥æ‰¾èµ„æ–™ã€‚\u003c/p\u003e\n\u003ch2\u003eClassReader\u003c/h2\u003e\n\u003cp\u003eClassReader æ˜¯è§£æç°æœ‰çš„ .class æ–‡ä»¶çš„åŸºæœ¬å·¥å…·ã€‚åŒæ—¶ï¼ŒClassReader ä¹Ÿä½œä¸ºä¸€ä¸ªå†…å®¹çš„æŒæœ‰è€…ï¼Œä¸ SymboleTable é…åˆï¼Œæ¥æ»¡è¶³è®¿é—®è€…åŸºæœ¬çš„è®¿é—®éœ€æ±‚ã€‚\u003c/p\u003e\n\u003cp\u003eåˆ¨é™¤å¤§é‡çš„å†…éƒ¨ç§æœ‰æ–¹æ³•ï¼ŒClassReader å¯¹å¤–å¼€æ”¾çš„æ¥å£ç›¸å½“ç®€å•ã€‚æœ€æ ¸å¿ƒçš„æ–¹æ³•ä»…åŒ…æ‹¬ ClassReader(...) ä»¥åŠ accetp(...)\u003c/p\u003e\n\u003ch3\u003eClassReader(...) æ„é€ æ–¹æ³•\u003c/h3\u003e\n\u003cp\u003eé¡¾åæ€ä¹‰ï¼Œæ„é€ æ–¹æ³•ç”¨äºå®ä¾‹åŒ– ClassReader å¯¹è±¡ï¼ŒåŒ…æ‹¬ä¸€äº›å¿…é¡»çš„å˜é‡çš„åˆå§‹åŒ–ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨æ„é€ å‡½æ•°ä¸­å®Œæˆçš„åˆå§‹åŒ–å†…å®¹åŒ…æ‹¬:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ ¡éªŒç‰ˆæœ¬å·\u003c/li\u003e\n\u003cli\u003eå­˜å‚¨æ¯ä¸ªå¸¸é‡æ± é¡¹ç›®çš„èµ·å§‹åç§»é‡ cpInfoOffsets\u003c/li\u003e\n\u003cli\u003eå­˜å‚¨æ¯ä¸ªå¼•å¯¼æ–¹æ³•çš„èµ·å§‹åç§»é‡ bootstrapMethodOffsets\u003c/li\u003e\n\u003cli\u003eå­˜å‚¨æœ€é•¿å­—ç¬¦ä¸²å¸¸é‡çš„å¤§å° maxStringLength\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e  ClassReader(final byte[] classFileBuffer, final int classFileOffset, final boolean checkClassVersion) {\n    this.b = classFileBuffer;   // .class æ–‡ä»¶ç¼“å­˜\n    // æ£€æŸ¥ä¸»ç‰ˆæœ¬å·, ç¬¬6,7ä¸ªå­—èŠ‚(ä»0å­—èŠ‚å¼€å§‹è®¡æ•°)\n    if (checkClassVersion \u0026#x26;\u0026#x26; readShort(classFileOffset + 6) \u003e Opcodes.V11) {\n      throw new IllegalArgumentException(\n          \"Unsupported class file major version \" + readShort(classFileOffset + 6));\n    }\n    // åˆ›å»ºå¸¸é‡æ± æ•°ç»„ï¼Œå¸¸é‡æ± é•¿åº¦çš„å®šä¹‰ constant_pool_count åœ¨ç¬¬8,9å­—èŠ‚\n    int constantPoolCount = readUnsignedShort(classFileOffset + 8);     // è¯»å–æ— ç¬¦å·short, å³è¯»å–è¿ç»­ä¸¤å­—èŠ‚ä½œä¸ºä¸€ä¸ªshortå€¼\n    cpInfoOffsets = new int[constantPoolCount];                         // æ¯ä¸ªå¸¸é‡çš„åç§»ä½ç½®\n    cpInfoValues = new Object[constantPoolCount];                       // æ¯ä¸ªå¸¸é‡çš„å®ä¾‹å¯¹è±¡\n    int currentCpInfoIndex = 1;\n    int currentCpInfoOffset = classFileOffset + 10;\n    int currentMaxStringLength = 0;                                     // æœ€é•¿å­—ç¬¦ä¸²å¸¸é‡\n    while (currentCpInfoIndex \u0026#x3C; constantPoolCount) {\n      cpInfoOffsets[currentCpInfoIndex++] = currentCpInfoOffset + 1;\n      int cpInfoSize;\n      switch (classFileBuffer[currentCpInfoOffset]) {\n        case Symbol.CONSTANT_FIELDREF_TAG:\n        case Symbol.CONSTANT_METHODREF_TAG:\n        case Symbol.CONSTANT_INTERFACE_METHODREF_TAG:\n        case Symbol.CONSTANT_INTEGER_TAG:\n        case Symbol.CONSTANT_FLOAT_TAG:\n        case Symbol.CONSTANT_NAME_AND_TYPE_TAG:\n        case Symbol.CONSTANT_INVOKE_DYNAMIC_TAG:\n        case Symbol.CONSTANT_DYNAMIC_TAG:\n          cpInfoSize = 5;\n          break;\n        case Symbol.CONSTANT_LONG_TAG:\n        case Symbol.CONSTANT_DOUBLE_TAG:\n          cpInfoSize = 9;\n          currentCpInfoIndex++;\n          break;\n        case Symbol.CONSTANT_UTF8_TAG:\n          cpInfoSize = 3 + readUnsignedShort(currentCpInfoOffset + 1);\n          if (cpInfoSize \u003e currentMaxStringLength) {\n            // The size in bytes of this CONSTANT_Utf8 structure provides a conservative estimate\n            // of the length in characters of the corresponding string, and is much cheaper to\n            // compute than this exact length.\n            currentMaxStringLength = cpInfoSize;\n          }\n          break;\n        case Symbol.CONSTANT_METHOD_HANDLE_TAG:\n          cpInfoSize = 4;\n          break;\n        case Symbol.CONSTANT_CLASS_TAG:\n        case Symbol.CONSTANT_STRING_TAG:\n        case Symbol.CONSTANT_METHOD_TYPE_TAG:\n        case Symbol.CONSTANT_PACKAGE_TAG:\n        case Symbol.CONSTANT_MODULE_TAG:\n          cpInfoSize = 3;\n          break;\n        default:\n          throw new IllegalArgumentException();\n      }\n      currentCpInfoOffset += cpInfoSize;\n    }\n    this.maxStringLength = currentMaxStringLength;\n    // The Classfile's access_flags field is just after the last constant pool entry.\n    this.header = currentCpInfoOffset;\n\n    // è¯»å– BootstrapMethods å±æ€§(å¦‚æœå­˜åœ¨)\n    int currentAttributeOffset = getFirstAttributeOffset();\n    int[] currentBootstrapMethodOffsets = null;\n    for (int i = readUnsignedShort(currentAttributeOffset - 2); i \u003e 0; --i) {\n      // è¯»å–æ¯ä¸ª attribute_info çš„å±æ€§åå’Œå±æ€§é•¿åº¦\n      String attributeName = readUTF8(currentAttributeOffset, new char[maxStringLength]);\n      int attributeLength = readInt(currentAttributeOffset + 2);\n      currentAttributeOffset += 6;\n      // å¦‚æœå½“å‰å±æ€§åä¸º BootstrapMethods ï¼Œåˆ™è¿›å…¥å¤„ç†é€»è¾‘\n      if (Constants.BOOTSTRAP_METHODS.equals(attributeName)) {\n        // Read the num_bootstrap_methods field and create an array of this size.\n        currentBootstrapMethodOffsets = new int[readUnsignedShort(currentAttributeOffset)];\n        // Compute and store the offset of each 'bootstrap_methods' array field entry.\n        int currentBootstrapMethodOffset = currentAttributeOffset + 2;\n        for (int j = 0; j \u0026#x3C; currentBootstrapMethodOffsets.length; ++j) {\n          currentBootstrapMethodOffsets[j] = currentBootstrapMethodOffset;\n          // Skip the bootstrap_method_ref and num_bootstrap_arguments fields (2 bytes each),\n          // as well as the bootstrap_arguments array field (of size num_bootstrap_arguments * 2).\n          currentBootstrapMethodOffset +=\n              4 + readUnsignedShort(currentBootstrapMethodOffset + 2) * 2;\n        }\n      }\n      currentAttributeOffset += attributeLength;\n    }\n    this.bootstrapMethodOffsets = currentBootstrapMethodOffsets;\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåˆ°æ­¤ä¸ºæ­¢ï¼ŒClassReader å·²ç»è§£æäº†åŒ…æ‹¬ magic, minor version, major version, constant pool ã€‚\nä½†æ˜¯ï¼Œè¯¸å¦‚ field_info, method_info, attribute_info ç­‰ä»ç„¶æ²¡æœ‰å¾—åˆ°å¤„ç†ã€‚\u003c/p\u003e\n\u003ch3\u003eaccept(...)\u003c/h3\u003e\n\u003cp\u003eè®¿é—®è€…æ¨¡å¼çš„æ ¸å¿ƒæ“ä½œå°±æ˜¯ç»“æ„åŒ–å¯¹è±¡æ¥å—(accept)è®¿é—®è€…å¯¹è±¡å®ä¾‹çš„è®¿é—®ï¼Œå¹¶å°†ç»“æ„åŒ–å†…å®¹å®Œå…¨æš´éœ²ç»™è®¿é—®è€…ã€‚\u003c/p\u003e\n\u003cp\u003eä»æŠ½è±¡çš„æ–¹æ³•è§’åº¦çœ‹ï¼Œå¯ä»¥ç†è§£æˆ:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e  // --- ç»“æ„åŒ–å¯¹è±¡çš„ accept() æ–¹æ³• ---\n  public void accept(Visitor visitor) {\n    visitor.visit(this);\n  }\n\n  // --- è®¿é—®è€…å¯¹è±¡çš„ visit() æ–¹æ³• ---\n  public Xxx visit(Element element) {\n    // è‹¥å¹²å…³äº element çš„è¯»æ“ä½œ + å…¶å®ƒæ“ä½œ\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic void accept(\n      final ClassVisitor classVisitor,\n      final Attribute[] attributePrototypes,\n      final int parsingOptions) {\n    // å®šä¹‰ Context ä½œä¸ºè¾…åŠ©ç±»ï¼Œæš‚å­˜è¢«è®¿é—®è¿‡ç¨‹çš„â€œç´¯ç§¯çŠ¶æ€â€\n    Context context = new Context();\n    context.attributePrototypes = attributePrototypes;\n    /**\n     * è§£æé€‰é¡¹: \n     * 1. SKIP_CODE - ä¸è§£æ CODE å±æ€§ \n     * 2. SKIP_DEBUG - ä¸è§£æ DEBUG ç›¸å…³çš„å±æ€§(ä¾‹å¦‚SourceFile, SourceDebugExtension, LocalVariableTable, LocalVariableTypeTable, LineNumberTable)\n     * 4. SKIP_FRAMES - è·³è¿‡å¯¹ StackMap å’Œ StackMapTable å±æ€§çš„è§£æ\n     * ...\n     */\n    context.parsingOptions = parsingOptions;\n    // ä»å¸¸é‡æ± è¯»å–å¸¸é‡æ‰€ä½¿ç”¨çš„ç¼“å†²æ•°å­—\n    context.charBuffer = new char[maxStringLength];\n\n    // Read the access_flags, this_class, super_class, interface_count and interfaces fields.\n    // è§£æè®¿é—®æ§åˆ¶, å½“å‰ç±», çˆ¶ç±», æ¥å£æ•°é‡ä¸æ¥å£å€¼ç­‰\n    char[] charBuffer = context.charBuffer;\n    int currentOffset = header;\n    int accessFlags = readUnsignedShort(currentOffset);\n    String thisClass = readClass(currentOffset + 2, charBuffer);\n    String superClass = readClass(currentOffset + 4, charBuffer);\n    String[] interfaces = new String[readUnsignedShort(currentOffset + 6)];\n    currentOffset += 8;\n    for (int i = 0; i \u0026#x3C; interfaces.length; ++i) {\n      interfaces[i] = readClass(currentOffset, charBuffer);\n      currentOffset += 2;\n    }\n\n    // Read the class attributes (the variables are ordered as in Section 4.7 of the JVMS).\n    // Attribute offsets exclude the attribute_name_index and attribute_length fields.\n    // - The offset of the InnerClasses attribute, or 0.\n    int innerClassesOffset = 0;\n    // - The offset of the EnclosingMethod attribute, or 0.\n    int enclosingMethodOffset = 0;\n    // - The string corresponding to the Signature attribute, or null.\n    String signature = null;\n    // - The string corresponding to the SourceFile attribute, or null.\n    String sourceFile = null;\n    // - The string corresponding to the SourceDebugExtension attribute, or null.\n    String sourceDebugExtension = null;\n    // - The offset of the RuntimeVisibleAnnotations attribute, or 0.\n    int runtimeVisibleAnnotationsOffset = 0;\n    // - The offset of the RuntimeInvisibleAnnotations attribute, or 0.\n    int runtimeInvisibleAnnotationsOffset = 0;\n    // - The offset of the RuntimeVisibleTypeAnnotations attribute, or 0.\n    int runtimeVisibleTypeAnnotationsOffset = 0;\n    // - The offset of the RuntimeInvisibleTypeAnnotations attribute, or 0.\n    int runtimeInvisibleTypeAnnotationsOffset = 0;\n    // - The offset of the Module attribute, or 0.\n    int moduleOffset = 0;\n    // - The offset of the ModulePackages attribute, or 0.\n    int modulePackagesOffset = 0;\n    // - The string corresponding to the ModuleMainClass attribute, or null.\n    String moduleMainClass = null;\n    // - The string corresponding to the NestHost attribute, or null.\n    String nestHostClass = null;\n    // - The offset of the NestMembers attribute, or 0.\n    int nestMembersOffset = 0;\n    // - The non standard attributes (linked with their {@link Attribute#nextAttribute} field).\n    //   This list in the \u0026#x3C;i\u003ereverse order\u0026#x3C;/i\u003e or their order in the ClassFile structure.\n    Attribute attributes = null;\n\n    // è§£æ Class æŒæœ‰çš„å±æ€§\n    int currentAttributeOffset = getFirstAttributeOffset();\n    for (int i = readUnsignedShort(currentAttributeOffset - 2); i \u003e 0; --i) {\n      // Read the attribute_info's attribute_name and attribute_length fields.\n      String attributeName = readUTF8(currentAttributeOffset, charBuffer);\n      int attributeLength = readInt(currentAttributeOffset + 2);\n      currentAttributeOffset += 6;\n      // The tests are sorted in decreasing frequency order (based on frequencies observed on\n      // typical classes).\n      if (Constants.SOURCE_FILE.equals(attributeName)) {\n        sourceFile = readUTF8(currentAttributeOffset, charBuffer);\n      } else if (Constants.INNER_CLASSES.equals(attributeName)) {\n        innerClassesOffset = currentAttributeOffset;\n      } else if (Constants.ENCLOSING_METHOD.equals(attributeName)) {\n        enclosingMethodOffset = currentAttributeOffset;\n      } else if (Constants.NEST_HOST.equals(attributeName)) {\n        nestHostClass = readClass(currentAttributeOffset, charBuffer);\n      } else if (Constants.NEST_MEMBERS.equals(attributeName)) {\n        nestMembersOffset = currentAttributeOffset;\n      } else if (Constants.SIGNATURE.equals(attributeName)) {\n        signature = readUTF8(currentAttributeOffset, charBuffer);\n      } else if (Constants.RUNTIME_VISIBLE_ANNOTATIONS.equals(attributeName)) {\n        runtimeVisibleAnnotationsOffset = currentAttributeOffset;\n      } else if (Constants.RUNTIME_VISIBLE_TYPE_ANNOTATIONS.equals(attributeName)) {\n        runtimeVisibleTypeAnnotationsOffset = currentAttributeOffset;\n      } else if (Constants.DEPRECATED.equals(attributeName)) {\n        accessFlags |= Opcodes.ACC_DEPRECATED;\n      } else if (Constants.SYNTHETIC.equals(attributeName)) {\n        accessFlags |= Opcodes.ACC_SYNTHETIC;\n      } else if (Constants.SOURCE_DEBUG_EXTENSION.equals(attributeName)) {\n        sourceDebugExtension =\n            readUTF(currentAttributeOffset, attributeLength, new char[attributeLength]);\n      } else if (Constants.RUNTIME_INVISIBLE_ANNOTATIONS.equals(attributeName)) {\n        runtimeInvisibleAnnotationsOffset = currentAttributeOffset;\n      } else if (Constants.RUNTIME_INVISIBLE_TYPE_ANNOTATIONS.equals(attributeName)) {\n        runtimeInvisibleTypeAnnotationsOffset = currentAttributeOffset;\n      } else if (Constants.MODULE.equals(attributeName)) {\n        moduleOffset = currentAttributeOffset;\n      } else if (Constants.MODULE_MAIN_CLASS.equals(attributeName)) {\n        moduleMainClass = readClass(currentAttributeOffset, charBuffer);\n      } else if (Constants.MODULE_PACKAGES.equals(attributeName)) {\n        modulePackagesOffset = currentAttributeOffset;\n      } else if (Constants.BOOTSTRAP_METHODS.equals(attributeName)) {\n        // This attribute is read in the constructor.\n      } else {\n        Attribute attribute =\n            readAttribute(\n                attributePrototypes,\n                attributeName,\n                currentAttributeOffset,\n                attributeLength,\n                charBuffer,\n                -1,\n                null);\n        attribute.nextAttribute = attributes;\n        attributes = attribute;\n      }\n      currentAttributeOffset += attributeLength;\n    }\n\n    // ç¬¬ä¸€ä¸ª .visit() ã€‚è®© ClassVisitor çš„å®ç°ç±»å¤„ç†å½“å‰ç±»çš„ç‰ˆæœ¬å·, è®¿é—®æ§åˆ¶æ ‡å¿—, å½“å‰ç±», ç»“æ„, çˆ¶ç±», æ¥å£\n    // å…·ä½“ visit() ç”±å®ç°ç±»éšæ„å®šåˆ¶ã€‚ä¾‹å¦‚ï¼Œé’ˆå¯¹äºé‚£äº›æœ‰æ‰“å°åŠŸèƒ½çš„è®¿é—®è€…å®ç°ç±»ï¼Œç›´æ¥æ‰“å°ä¹Ÿä¸å¤±ä¸ºä¸€ç§æœ‰æ•ˆçš„è®¿é—®æ“ä½œ\n    // Visit the class declaration. The minor_version and major_version fields start 6 bytes before\n    // the first constant pool entry, which itself starts at cpInfoOffsets[1] - 1 (by definition).\n    classVisitor.visit(\n        readInt(cpInfoOffsets[1] - 7), accessFlags, thisClass, signature, superClass, interfaces);\n\n    // è®¿é—® SourceFile å’Œ SourceDebugExtenstion å±æ€§\n    // Visit the SourceFile and SourceDebugExtenstion attributes.\n    if ((parsingOptions \u0026#x26; SKIP_DEBUG) == 0\n        \u0026#x26;\u0026#x26; (sourceFile != null || sourceDebugExtension != null)) {\n      classVisitor.visitSource(sourceFile, sourceDebugExtension);\n    }\n\n    // Visit the Module, ModulePackages and ModuleMainClass attributes.\n    if (moduleOffset != 0) {\n      readModule(classVisitor, context, moduleOffset, modulePackagesOffset, moduleMainClass);\n    }\n\n    // Visit the NestHost attribute.\n    if (nestHostClass != null) {\n      classVisitor.visitNestHostExperimental(nestHostClass);\n    }\n\n    // Visit the EnclosingMethod attribute.\n    if (enclosingMethodOffset != 0) {\n      String className = readClass(enclosingMethodOffset, charBuffer);\n      int methodIndex = readUnsignedShort(enclosingMethodOffset + 2);\n      String name = methodIndex == 0 ? null : readUTF8(cpInfoOffsets[methodIndex], charBuffer);\n      String type = methodIndex == 0 ? null : readUTF8(cpInfoOffsets[methodIndex] + 2, charBuffer);\n      classVisitor.visitOuterClass(className, name, type);\n    }\n\n    // Visit the RuntimeVisibleAnnotations attribute.\n    if (runtimeVisibleAnnotationsOffset != 0) {\n      int numAnnotations = readUnsignedShort(runtimeVisibleAnnotationsOffset);\n      int currentAnnotationOffset = runtimeVisibleAnnotationsOffset + 2;\n      while (numAnnotations-- \u003e 0) {\n        // Parse the type_index field.\n        String annotationDescriptor = readUTF8(currentAnnotationOffset, charBuffer);\n        currentAnnotationOffset += 2;\n        // Parse num_element_value_pairs and element_value_pairs and visit these values.\n        currentAnnotationOffset =\n            readElementValues(\n                classVisitor.visitAnnotation(annotationDescriptor, /* visible = */ true),\n                currentAnnotationOffset,\n                /* named = */ true,\n                charBuffer);\n      }\n    }\n\n    // Visit the RuntimeInvisibleAnnotations attribute.\n    if (runtimeInvisibleAnnotationsOffset != 0) {\n      int numAnnotations = readUnsignedShort(runtimeInvisibleAnnotationsOffset);\n      int currentAnnotationOffset = runtimeInvisibleAnnotationsOffset + 2;\n      while (numAnnotations-- \u003e 0) {\n        // Parse the type_index field.\n        String annotationDescriptor = readUTF8(currentAnnotationOffset, charBuffer);\n        currentAnnotationOffset += 2;\n        // Parse num_element_value_pairs and element_value_pairs and visit these values.\n        currentAnnotationOffset =\n            readElementValues(\n                classVisitor.visitAnnotation(annotationDescriptor, /* visible = */ false),\n                currentAnnotationOffset,\n                /* named = */ true,\n                charBuffer);\n      }\n    }\n\n    // Visit the RuntimeVisibleTypeAnnotations attribute.\n    if (runtimeVisibleTypeAnnotationsOffset != 0) {\n      int numAnnotations = readUnsignedShort(runtimeVisibleTypeAnnotationsOffset);\n      int currentAnnotationOffset = runtimeVisibleTypeAnnotationsOffset + 2;\n      while (numAnnotations-- \u003e 0) {\n        // Parse the target_type, target_info and target_path fields.\n        currentAnnotationOffset = readTypeAnnotationTarget(context, currentAnnotationOffset);\n        // Parse the type_index field.\n        String annotationDescriptor = readUTF8(currentAnnotationOffset, charBuffer);\n        currentAnnotationOffset += 2;\n        // Parse num_element_value_pairs and element_value_pairs and visit these values.\n        currentAnnotationOffset =\n            readElementValues(\n                classVisitor.visitTypeAnnotation(\n                    context.currentTypeAnnotationTarget,\n                    context.currentTypeAnnotationTargetPath,\n                    annotationDescriptor,\n                    /* visible = */ true),\n                currentAnnotationOffset,\n                /* named = */ true,\n                charBuffer);\n      }\n    }\n\n    // Visit the RuntimeInvisibleTypeAnnotations attribute.\n    if (runtimeInvisibleTypeAnnotationsOffset != 0) {\n      int numAnnotations = readUnsignedShort(runtimeInvisibleTypeAnnotationsOffset);\n      int currentAnnotationOffset = runtimeInvisibleTypeAnnotationsOffset + 2;\n      while (numAnnotations-- \u003e 0) {\n        // Parse the target_type, target_info and target_path fields.\n        currentAnnotationOffset = readTypeAnnotationTarget(context, currentAnnotationOffset);\n        // Parse the type_index field.\n        String annotationDescriptor = readUTF8(currentAnnotationOffset, charBuffer);\n        currentAnnotationOffset += 2;\n        // Parse num_element_value_pairs and element_value_pairs and visit these values.\n        currentAnnotationOffset =\n            readElementValues(\n                classVisitor.visitTypeAnnotation(\n                    context.currentTypeAnnotationTarget,\n                    context.currentTypeAnnotationTargetPath,\n                    annotationDescriptor,\n                    /* visible = */ false),\n                currentAnnotationOffset,\n                /* named = */ true,\n                charBuffer);\n      }\n    }\n\n    // è®¿é—®éæ ‡å‡†çš„å±æ€§\n    // Visit the non standard attributes.\n    while (attributes != null) {\n      // Copy and reset the nextAttribute field so that it can also be used in ClassWriter.\n      Attribute nextAttribute = attributes.nextAttribute;\n      attributes.nextAttribute = null;\n      classVisitor.visitAttribute(attributes);\n      attributes = nextAttribute;\n    }\n\n    // Visit the NestedMembers attribute.\n    if (nestMembersOffset != 0) {\n      int numberOfNestMembers = readUnsignedShort(nestMembersOffset);\n      int currentNestMemberOffset = nestMembersOffset + 2;\n      while (numberOfNestMembers-- \u003e 0) {\n        classVisitor.visitNestMemberExperimental(readClass(currentNestMemberOffset, charBuffer));\n        currentNestMemberOffset += 2;\n      }\n    }\n\n    // Visit the InnerClasses attribute.\n    if (innerClassesOffset != 0) {\n      int numberOfClasses = readUnsignedShort(innerClassesOffset);\n      int currentClassesOffset = innerClassesOffset + 2;\n      while (numberOfClasses-- \u003e 0) {\n        classVisitor.visitInnerClass(\n            readClass(currentClassesOffset, charBuffer),\n            readClass(currentClassesOffset + 2, charBuffer),\n            readUTF8(currentClassesOffset + 4, charBuffer),\n            readUnsignedShort(currentClassesOffset + 6));\n        currentClassesOffset += 8;\n      }\n    }\n\n    // è®¿é—®å­—æ®µå’Œæ–¹æ³•\n    // Visit the fields and methods.\n    int fieldsCount = readUnsignedShort(currentOffset);\n    currentOffset += 2;\n    while (fieldsCount-- \u003e 0) {\n      currentOffset = readField(classVisitor, context, currentOffset);\n    }\n    int methodsCount = readUnsignedShort(currentOffset);\n    currentOffset += 2;\n    while (methodsCount-- \u003e 0) {\n      currentOffset = readMethod(classVisitor, context, currentOffset);\n    }\n\n    // Visit the end of the class.\n    classVisitor.visitEnd();\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eå°ç»“\u003c/h3\u003e\n\u003cp\u003eå…¶å®ï¼Œå°†æ•´ä¸ª ClassReader ç†è§£æˆä¸€ä¸ªå¯¹ .class å­—èŠ‚æ–‡ä»¶çš„è§£æå™¨ä¸å¤±ä¸ºä¸€ç§å¯è¡Œçš„è®¤çŸ¥ã€‚\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eåœ¨æ„é€ æ–¹æ³•ä¸­å®Œæˆå¯¹ .class æ–‡ä»¶ minor_version, major_version çš„ç¡®è®¤ã€‚\u003c/li\u003e\n\u003cli\u003eç»§è€Œå®Œæˆå¯¹æ•´ä¸ª Constants_pool çš„è§£æ\u003c/li\u003e\n\u003cli\u003eä»¥åŠ BootstarpMethod å±æ€§çš„å®šä½\u003c/li\u003e\n\u003cli\u003eä¹‹ååœ¨ accept(...) æ–¹æ³•ä¸­é€ä¸€è°ƒç”¨ç›¸åº”çš„è®¿é—®è€…å®ç°ç±»å®ç°å¯¹ä¸åŒå†…å®¹çš„è®¿é—®ã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼ŒClassReader ç»å¯¹ä¸ä¼šæ¶‰åŠåˆ°å¯¹å…¶è§£æçš„ .class æ–‡ä»¶å†…å®¹çš„å†™æ“ä½œã€‚\næ‰€æœ‰çš„å†™æ“ä½œéƒ½åŸºäºä¸åŒçš„ç›®çš„ï¼Œåœ¨ ClassVisitor ä¸­å®ç°ã€‚\u003c/p\u003e\n\u003ch2\u003eClassVisitor\u003c/h2\u003e\n\u003cp\u003eJava .class çš„è®¿é—®è€…ï¼ŒæŒ‰ç…§ä¸¥æ ¼çš„é¡ºåºè§„èŒƒé€ä¸€è°ƒç”¨ \u003c/p\u003e\n\u003cp\u003evisit\n[ visitSource ] [ visitModule ][ visitNestHost ][ visitOuterClass ]\n( visitAnnotation | visitTypeAnnotation | visitAttribute )\u003cem\u003e\n( visitNestMember | visitInnerClass | visitField | visitMethod )\u003c/em\u003e\nvisitEnd.\u003c/p\u003e\n\u003cp\u003eå„ä¸ª visitXXX æ–¹æ³•\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic abstract class ClassVisitor {\n\n  /**\n   * è®¿é—®ç±»çš„é¦–éƒ¨\n      */\n    public void visit(final int version, final int access, final String name, final String signature, final String superName, final String[] interfaces) {}\n\n  /**\n   * è®¿é—®ç±»çš„æºæ–‡ä»¶åç­‰\n      */\n    public void visitSource(final String source, final String debug) {}\n\n  /**\n   * è®¿é—®ä¸ç±»å…³è”çš„æ¨¡å—\n      */\n    public ModuleVisitor visitModule(final String name, final int access, final String version) {}\n\n  public void visitOuterClass(final String owner, final String name, final String descriptor) {}\n\n  public AnnotationVisitor visitAnnotation(final String descriptor, final boolean visible) {}\n\n  public AnnotationVisitor visitTypeAnnotation(\n      final int typeRef, final TypePath typePath, final String descriptor, final boolean visible) {}\n\n  public void visitAttribute(final Attribute attribute) {}\n\n  public void visitInnerClass(\n      final String name, final String outerName, final String innerName, final int access) {}\n\n  /**\n   * è®¿é—®ç±»çš„å˜é‡\n      */\n    public FieldVisitor visitField(\n      final int access,\n      final String name,\n      final String descriptor,\n      final String signature,\n      final Object value) {}\n\n  /**\n   * è®¿é—®ç±»çš„æ–¹æ³•\n      */\n    public MethodVisitor visitMethod(\n      final int access,\n      final String name,\n      final String descriptor,\n      final String signature,\n      final String[] exceptions) {}\n\n  public void visitEnd() {}\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eéšç€ visitXxx() æ–¹æ³•çš„é€ä¸€æ‰§è¡Œï¼ŒClassVisitor å°†å¯¹å½“å‰çš„ .class æ–‡ä»¶è¶Šæ¥è¶Šç†Ÿæ‚‰ï¼Œå¹¶é€æ¸è¡¥å…¨å¸¸é‡æ± (ç”± SymbolTable æŒæœ‰å¹¶ç»´æŠ¤)\u003c/p\u003e\n\u003ch2\u003eæ€»ç»“\u003c/h2\u003e\n\u003cp\u003eåˆ°æ­¤ä¸ºæ­¢ï¼Œå¯¹æ•´ä¸ª ClassReader \u0026#x26; ClassVisitor å°†æœ‰ä¸€ä¸ªåŸºç¡€è€Œç®€å•çš„å°è±¡ã€‚\u003c/p\u003e\n\u003cp\u003eClassReader é€šè¿‡å¯¹ .class æ–‡ä»¶å­—èŠ‚ç çš„è§£æè€Œè·å¾—å¯¹è¿™ä¸ªç±»çš„å…·ä½“å°è±¡(æ›´å¤šçš„åå‘æ˜¯éšæ„è®¿é—® .class çš„å„ç§ç»†èŠ‚)ã€‚\u003c/p\u003e\n\u003cp\u003eClassVisitor é€šè¿‡ visitXxx(...) æ–¹æ³•ï¼Œç”±å…¶å®ƒå¯¹è±¡(å¯ä»¥æ˜¯ ClassReader, ä¹Ÿå¯ä»¥ç›´æ¥æ˜¯ Coder)é€æ¸å¯¹å…¶å¼€æ”¾ä¸€äº› .class çš„ç»†èŠ‚ï¼Œ\nä½†éœ€è¦ ClassVisitor è‡ªè¡Œç»´æŠ¤è·å¾—çš„å†…å®¹(å¦‚æœæœ‰å¿…è¦çš„è¯)ã€‚ç”±æ­¤å¾—åˆ°å¯¹ .class å…¨éƒ¨å†…å®¹çš„äº†è§£(å½“ç„¶ï¼Œå¦‚æœæœ¬èº« visitXxx() å¾—åˆ°çš„å†…å®¹ä¸å…¨ï¼Œåˆ™äº†è§£çš„è‡ªç„¶æœ‰é™)ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡æè¿°çš„ ASM æŒ‡çš„æ˜¯ OW2 ASM\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2\u003eASM-Core çš„ç»“æ„\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eé¦–å…ˆæ˜¯ä¸€äº›æ¦‚è¿°æ€§çš„å†…å®¹ã€‚\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eç”±äº ASM æ“ä½œçš„ JAVA å­—èŠ‚ç æœ‰ä¸¥æ ¼çš„æ ¼å¼è§„å®šï¼Œä¸”å³ä½¿éšç€ JVM æ ‡å‡†çš„å‡çº§ä¹Ÿæå°‘å‡ºç°é‡å¤§è°ƒæ•´ã€‚\nå› æ­¤é€‚ç”¨é¢ç‹­çª„çš„è®¿é—®è€…æ¨¡å¼åœ¨è¯¥é¡¹ç›®ä¸­è¢«å¤§é‡åœ°ä½¿ç”¨ï¼Œå¹¶ä¸”å·²ç»åˆ°äº†ä¸§å¿ƒç—…ç‹‚çš„ç¨‹åº¦:)\u003c/p\u003e\n\u003cp\u003eä»æ ¸å¿ƒåŒ…å£°æ˜çš„ç±»æ¥çœ‹ï¼Œä¸»è¦åŒ…æ‹¬:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eClassReader - ä½œä¸ºç»“æ„åŒ–å¯¹è±¡ï¼Œå°†æ¥æ”¶(accept)è®¿é—®è€…çš„è®¿é—®\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eå‡ ç§è®¿é—®è€…æŠ½è±¡ç±»ä»¥åŠç›¸åº”çš„å®ç°ç±»\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eAnnotationVisitor -\u003e AnnotationWriter\u003c/li\u003e\n\u003cli\u003eClassVisitor -\u003e ClassWriter\u003c/li\u003e\n\u003cli\u003eFieldVisitor -\u003e FieldWriter\u003c/li\u003e\n\u003cli\u003eMethodVisitor -\u003e MethodWriter\u003c/li\u003e\n\u003cli\u003eModuleVisitor -\u003e ModuleWriter\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e\n\u003cp\u003eOpcodes \u0026#x26; Constants - ClassFile ä¸­æè¿°çš„å¤§é‡å¸¸é‡ç¬¦å·ä¸å€¼\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eå…¶å®ƒä¸€äº›è¾…åŠ©çš„ç±»\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eAttribute - ç”¨äºå¤„ç†éæ ‡å‡†åŒ–çš„å±æ€§(ClassFile å…è®¸\u003ca href=\"https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html\"\u003eJVMS\u003c/a\u003e ä¸­æœªå®šä¹‰çš„ Attribute)\u003c/li\u003e\n\u003cli\u003eByteArray - åŠ¨æ€å¯è‡ªé€‚åº”çš„ byte[] (å­—èŠ‚æ•°ç»„)\u003c/li\u003e\n\u003cli\u003eContext - ClassReader åœ¨è¢«è§£æ(è¢«è®¿é—®)è¿‡ç¨‹ä¸­ç”¨äºè¡¨ç¤ºâ€œç´¯ç§¯çŠ¶æ€â€çš„ä¸€ä¸ªç±»/å¯¹è±¡\u003c/li\u003e\n\u003cli\u003eSymbol - ç”¨äºè¡¨ç¤º ClassFile ä¸­æè¿°çš„ Constant çš„åŸºç±»\u003c/li\u003e\n\u003cli\u003eSymbolTable - ç”¨äºå­˜å‚¨å¸¸é‡æ± å¯¹è±¡\u003c/li\u003e\n\u003cli\u003eå…¶å®ƒå†…å®¹çœç•¥\u003c/li\u003e\n\u003c/ul\u003e"},{"url":"2018-06-28-ASM-VerifyError","fileName":"2018-06-28-ASM-VerifyError.md","title":"ASM-VerifyErroré”™è¯¯ä¿¡æ¯è§£å†³","author":"fangfeng","date":"2018-06-28T00:00:00.000Z","tags":[],"content":"\u003ch2\u003eæŠ¥é”™ä¿¡æ¯\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003ejava.lang.VerifyError: class net.sf.cglib.core.DebuggingClassWriter overrides final method visit.(IILjava/lang/String;Ljava/lang/String;Ljava/lang/String;[Ljava/lang/String;)V\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eèƒŒæ™¯\u003c/h2\u003e\n\u003cp\u003eé¡¹ç›®ä¾èµ–çš„ \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCGlib ç‰ˆæœ¬æ˜¯ 2.2.2\u003c/li\u003e\n\u003cli\u003eASM ç‰ˆæœ¬æ˜¯ 3.3.1\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eé—®é¢˜å®šä½\u003c/h2\u003e\n\u003cp\u003eå‰ä¸¤å¤©åˆšç²—ç•¥é€šè¯»äº† ASM ï¼Œç»“æœå°±é‡ä¸Šè¿™æ ·ä¸€ä¸ªé—®é¢˜ã€‚\u003c/p\u003e\n\u003cp\u003eä» \u003ccode\u003enet.sf.cglib.core.DebuggingClassWriter\u003c/code\u003e çœ‹ï¼Œè¿™æ˜¯ CGlib çš„ä¸€ä¸ªå®ç°ç±»\u003c/p\u003e\n\u003cp\u003eä»æè¿° \u003ccode\u003eoverrides final method visit.(IILjava/lang/String;Ljava/lang/String;Ljava/lang/String;[Ljava/lang/String;)V\u003c/code\u003e\nä»¥åŠ DebuggingClassWriter ç±»çš„å­—èŠ‚ç åç¼–è¯‘ç»“æœ\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic class DebuggingClassWriter extends ClassWriter {\n    public void visit(int version, int access, String name, String signature, String superName, String[] interfaces) {\n        this.className = name.replace('/', '.');\n        this.superName = superName.replace('/', '.');\n        super.visit(version, access, name, signature, superName, interfaces);\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè‡³å°‘åº”è¯¥æ˜¯ visit(...) æ–¹æ³•è¦é‡è½½çš„çˆ¶ç±»çš„è¢«å£°æ˜ä¸º final çš„ ClassWriter.visit(...) æ‰å¯¼è‡´çš„é—®é¢˜ã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ä» ASM 3.3.1 ç‰ˆæœ¬çš„ ClassWriter ç±»å¯ä»¥çœ‹åˆ°\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e    public void visit(int var1, int var2, String var3, String var4, String var5, String[] var6) {\n        ...\n    }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003evisit æ–¹æ³•å¹¶æ²¡æœ‰è¢«å£°æ˜ä¸º final ã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œç»“åˆä¸€å®šçš„èƒŒæ™¯çŸ¥è¯†ï¼ŒASM é¡¹ç›®åœ¨åŠ å…¥äº† OW2 ç»„ç»‡åçš„æ–°ç‰ˆæœ¬(asm-3.3.1 æ˜¯æœªåŠ å…¥ OW2 å‰çš„æœ€åä¸€ä¸ªç‰ˆæœ¬)ï¼Œ\nClassWriter ç±»çš„æ‰€æœ‰ visitXxx(...) æ–¹æ³•éƒ½è¢«æ·»åŠ äº† \u003ccode\u003efinal\u003c/code\u003e é™åˆ¶ã€‚\u003c/p\u003e\n\u003cp\u003eå› æ­¤ï¼Œæ€€ç–‘æ˜¯é¡¹ç›®å®é™…ä¾èµ–äº†é«˜ç‰ˆæœ¬çš„ asm (asm 4.x åŠä»¥ä¸Š)\u003c/p\u003e\n\u003ch2\u003eè§£å†³\u003c/h2\u003e\n\u003cp\u003eç»è¿‡ç¡®è®¤ï¼Œç”±äºæ•´ä¸ªé¡¹ç›®ä¾èµ–å…³ç³»å¤æ‚ï¼Œæœ‰å…¶å®ƒé¡¹ç›®å¼•å…¥äº† asm-4.1.jarã€‚\nè€Œä¸”ç”±äºä½¿ç”¨ MAVEN è¿›è¡Œé¡¹ç›®ä¾èµ–ç®¡ç†ï¼Œasm-4.1.jar ä¸ä¾èµ–æ ‘æ ¹çš„æ·±åº¦æ›´æµ…ï¼Œ\nå› æ­¤ï¼Œæœ€ç»ˆæ‰“åŒ…çš„ war é‡Œé¢ç¡®å®å¼•å…¥äº† asm-4.1.jar ã€‚å¯¼è‡´äº†è¿™ä¸ªé—®é¢˜ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003ch2\u003eæŠ¥é”™ä¿¡æ¯\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003ejava.lang.VerifyError: class net.sf.cglib.core.DebuggingClassWriter overrides final method visit.(IILjava/lang/String;Ljava/lang/String;Ljava/lang/String;[Ljava/lang/String;)V\n\u003c/code\u003e\u003c/pre\u003e"},{"url":"2018-07-04-JDK-Permission","fileName":"2018-07-04-JDK-Permission.md","title":"Java å®‰å…¨è®¿é—®ä¸æƒé™æ§åˆ¶","author":"fangfeng","date":"2018-07-04T00:00:00.000Z","tags":["Java","Security","Permission"],"content":"\u003ch2\u003eç»ªè®º\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eæœ¬æ–‡åªæ˜¯å¯¹ Java å®‰å…¨è®¿é—®ä¸æƒé™æ§åˆ¶çš„åŸºç¡€æ€§æ¢ç©¶ã€‚\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæœ¬èŠ‚ä¸å…¨æ–‡å†…å®¹æ— å…³ï¼Œå¦‚æ— å…´è¶£é˜…è¯»ï¼Œå¯ä»¥è·³è¿‡\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eäº†è§£ Java å®‰å…¨è®¿é—®ç›¸å…³å†…å®¹çš„åˆè¡·ï¼Œæ˜¯å‡†å¤‡åœ¨é¡¹ç›®ä¸­åˆ©ç”¨ Java æ ‡å‡†åº“æä¾›çš„ ServiceLoader å¯¹ SPI å®ç°ç±»è¿›è¡Œ\"è‡ªåŠ¨å‘ç°\"å’ŒåŠ è½½ã€‚\nè¿™å¯¹äºå°†æœ¬é¡¹ç›®ä½œä¸ºäºŒæ–¹åº“æ¥ä¾èµ–çš„ä¸Šå±‚é¡¹ç›®å°†æ›´ä¸ºæ–¹ä¾¿ï¼Œåªéœ€è¦\n1. åœ¨ \u003ccode\u003eMETA-INF.services\u003c/code\u003e ç›®å½•ä¸‹é…ç½®è¢«å‘½åä¸º SPI æ¥å£å…¨é™å®šåçš„æ–‡ä»¶åŠæ·»åŠ ç›¸å…³å†…å®¹\n2. ç”±é¡¹ç›®çš„æ³¨å†Œç®¡ç†å™¨è§¦å‘ä¸‹åˆ— Java ä»£ç \u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e{\n    ServiceLoader\u0026#x3C;XxxPolicy\u003e xxxPolicyServiceLoader = ServiceLoader.load(XxxPolicy.class);\n    for (Iterator\u0026#x3C;XxxPolicy\u003e it = xxxPolicyServiceLoader.iterator(); it.hasNext(); ) {\n        XxxPolicy xxxPolicy = it.next();\n        // ... more code ...\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå°±å¯ä»¥å®Œæˆä¸€ä¸ªæ–°çš„ SPI ç­–ç•¥çš„æ³¨å†Œå·¥ä½œã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œåœ¨å°è¯•å®ç°ï¼Œäº†è§£äº† ServiceLoader æºç ï¼Œä»¥åŠ DriverManager å’Œ mysql-connection-java-.jar åœ¨æ³¨å†Œ Driver ç›¸å…³çš„ä»£ç ã€‚\nå‘ç°æ€ä¹ˆä¹Ÿç»•ä¸å¼€ Java å®‰å…¨è®¿é—®ç›¸å…³çš„å†…å®¹ã€‚è¯¸å¦‚ä¸‹åˆ—è¿™æ®µæ¥è‡ª DriverManager.loadInitialDrivers() çš„ä»£ç :\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003eAccessController.doPrivileged(new PrivilegedAction\u0026#x3C;Void\u003e() {\n    public Void run() {\n\n        ServiceLoader\u0026#x3C;Driver\u003e loadedDrivers = ServiceLoader.load(Driver.class);\n        Iterator\u0026#x3C;Driver\u003e driversIterator = loadedDrivers.iterator();\n\n        try{\n            while(driversIterator.hasNext()) {\n            driversIterator.next();\n            }\n        } catch(Throwable t) {\n                // Do nothing\n        }\n        return null;\n    }\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¯¸å¦‚ AccessController, Permission, SecurityManager çš„ä»£ç å§‹ç»ˆæ˜¯ä¸€ä¸ªç»•ä¸å¼€çš„ä¸»æ—‹å¾‹ã€‚\u003c/p\u003e\n\u003cp\u003eä¸ºäº†æ¢ç©¶è¿™éƒ¨åˆ†æ§åˆ¶å¯¹é¡¹ç›®ä¸­ ServiceLoader çš„çœŸæ­£ä½œç”¨ä»¥åŠå…¶ç¼–ç æ„ä¹‰ï¼Œå¼€å§‹äº†å¯¹æœ¬æ–‡æ‰€æè¿°çš„ä¸»ä½“å†…å®¹çš„åˆæ­¥äº†è§£ã€‚\u003c/p\u003e\n\u003ch2\u003eä»ç°è±¡å¼€å§‹...\u003c/h2\u003e\n\u003cp\u003eåœ¨é€šè¿‡ \u003ccode\u003ejava\u003c/code\u003e å‘½ä»¤æ‰§è¡Œæœ¬åœ°ä»£ç æ—¶ï¼Œå¶å°”/ç»å¸¸ä¼šå‡ºç°æ–‡ä»¶I/Oæ“ä½œã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic static void main(String... args) throws IOException {\n\n    System.out.println(System.getSecurityManager());\n\n    FileInputStream fis = new FileInputStream(\"/Users/fangfeng/test.in\");\n    for (int chr; (chr = fis.read()) != -1;) {\n        System.out.print((char) chr);\n    }\n    fis.close();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¯¸å¦‚ä¸Šé¢è¿™æ®µä»£ç ï¼Œæ„åœ¨è¯»å–å¤–éƒ¨è·¯å¾„ä¸‹ \u003ccode\u003etest.in\u003c/code\u003e æ–‡ä»¶(ä¸è¦æ”¾åœ¨é¡¹ç›®è·¯å¾„ä¸‹ï¼Œæ–‡æœ¬å†…å®¹ä¸º \u003ccode\u003e0123456789\u003c/code\u003e)ã€‚å½“ç„¶ï¼Œè¿˜åŒ…æ‹¬æ‰“å° System.getSecurityManager().toString() ã€‚\u003c/p\u003e\n\u003cp\u003eæ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™éƒ½æ˜¯èƒ½å¤Ÿæ‰§è¡ŒæˆåŠŸï¼Œç»“æœä¸º:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003enull\n0123456789\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œé€šè¿‡åœ¨å‘½ä»¤è¡Œ \u003ccode\u003ejava\u003c/code\u003e ä¸­æ·»åŠ é€‰é¡¹ \u003ccode\u003e-Djava.security.manager\u003c/code\u003eï¼Œå†æ¬¡æ‰§è¡Œä»£ç ï¼Œç»“æœä¸º:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003ejava.lang.SecurityManager@4e25154f\nException in thread \"main\" java.security.AccessControlException: access denied (\"java.io.FilePermission\" \"/Users/fangfeng/test.in\" \"read\")\n    at java.security.AccessControlContext.checkPermission(AccessControlContext.java:472)\n    at java.security.AccessController.checkPermission(AccessController.java:884)\n    at java.lang.SecurityManager.checkPermission(SecurityManager.java:549)\n    at java.lang.SecurityManager.checkRead(SecurityManager.java:888)\n    at java.io.FileInputStream.\u0026#x3C;init\u003e(FileInputStream.java:127)\n    at java.io.FileInputStream.\u0026#x3C;init\u003e(FileInputStream.java:93)\n    at me.fangfeng.security.SecurityTest.main(SecurityTest.java:16)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eç°åœ¨å·²ç»èƒ½å¤Ÿè·å–åˆ° \u003ccode\u003eSystem.getSecuriryManager\u003c/code\u003e çš„å®ä¾‹ã€‚\nä½†æ˜¯æƒ³è¦è¯»å– \u003ccode\u003etest.in\u003c/code\u003e æ–‡ä»¶å´å¤±è´¥äº†ï¼Œè¡¨ç°ä¸º access deniedï¼ˆè®¿é—®è¢«æ‹’ç»ï¼‰ã€‚\u003c/p\u003e\n\u003cp\u003eç°åœ¨ï¼Œåœ¨ç”¨æˆ·ç›®å½•ä¸‹(è¿™é‡Œæ˜¯ /Users/fangfeng, ä¸åŒç³»ç»Ÿä¸åŒç”¨æˆ·è¯·åšç›¸åº”ä¿®æ”¹) æ·»åŠ  \u003ccode\u003e.java.policy\u003c/code\u003e æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹åˆ—æ–‡æœ¬:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003egrant {\n    permission java.io.FilePermission \"/Users/fangfeng/test.in\", \"read\";\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå†æ¬¡ \u003ccode\u003ejava -Djava.security.manager \u0026#x3C;class's path\u003e\u003c/code\u003eï¼Œä¸ä»…èƒ½å¤Ÿå¾—åˆ° SecurityManager çš„å®ä¾‹ï¼ŒåŒæ—¶ä¹Ÿè¯»å–åˆ°äº†æ–‡æœ¬å†…å®¹ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003ejava.lang.SecurityManager@3af49f1c\n0123456789\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåˆ°æ­¤ä¸ºæ­¢ï¼Œåº”è¯¥å·²ç»èƒ½å¤Ÿæ„Ÿå—åˆ° Java å¯¹å®‰å…¨è®¿é—®çš„æ§åˆ¶åœ¨æ–‡ä»¶I/Oä¸Šçš„ä½“ç°äº†ã€‚\u003c/p\u003e\n\u003ch2\u003eå®‰å…¨æ§åˆ¶ä¸‹çš„æ“ä½œ\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåœ¨å¼€å§‹ä¸‹åˆ—å†…å®¹ä¹‹å‰ï¼Œéœ€è¦æå‰äº†è§£ä¸€ä¸ªå‰æ:\u003c/strong\u003e\n\u003cstrong\u003eJava å¯¹æ“ä½œæƒé™çš„æ§åˆ¶æ˜¯é€šè¿‡æ£€æŸ¥å½“å‰çº¿ç¨‹æ“ä½œä¸Šä¸‹æ–‡çš„ä»£ç æ˜¯å¦å­˜åœ¨è¦æ±‚çš„æ“ä½œæƒé™å®ç°çš„(é™¤äº†ç‰¹æƒçš„å£°æ˜ä»¥åŠå…¶å®ƒè¿˜éœ€è¦æ§åˆ¶åˆ«çš„çº¿ç¨‹ä¸Šä¸‹æ–‡æƒé™çš„æƒ…å†µ)\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eä¸Šä¸€èŠ‚æ¼”ç¤ºäº†æƒé™æ§åˆ¶ä¸‹æœ¬åœ°ä»£ç å¯¹æœ¬åœ°èµ„æºçš„è®¿é—®ã€‚ä½†æ˜¯ï¼Œå®‰å…¨æ§åˆ¶çœŸçš„æœ‰å¿…è¦å—ï¼Ÿ\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå°±æœ¬åœ°ç¨‹åºè€Œè¨€ï¼Œä¸å¿…è¦ã€‚äº‹å®ä¸Šï¼ŒJava ä¹Ÿç¡®å®æ˜¯è¿™ä¹ˆåšçš„ã€‚å¹³æ—¶åœ¨æœ¬åœ°åˆ©ç”¨ \u003ccode\u003ejava\u003c/code\u003e å‘½ä»¤æ‰§è¡Œç¨‹åºï¼Œéƒ½ä¸ä¼šå—åˆ°ä»»ä½•é™åˆ¶ã€‚Java å¯åŠ¨æ—¶é»˜è®¤ä¸ä¼šè£…è½½ SecurityManagerï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘å¯¹å„ç§æ“ä½œçš„æƒé™éªŒè¯ã€‚\u003c/li\u003e\n\u003cli\u003eå¯å¦‚æœç¨‹åºè¿è¡Œä¸ç½‘ç»œä¸Šå…¶å®ƒç¨‹åºäº¤äº’ï¼Œç”šè‡³ç›´æ¥åŠ è½½æ¥è‡ªç½‘ç»œçš„å­—èŠ‚ç ã€‚é‚£ä¹ˆï¼Œæƒé™æ§åˆ¶ç¡®å®æ˜¯æœ‰å¿…è¦çš„ã€‚è‡³å°‘ï¼Œå¦‚æœä¸å­˜åœ¨æƒé™æ§åˆ¶ï¼Œæ¥è‡ªç½‘ç»œçš„æ¶æ„ä»£ç è®¿é—®æ•´å°æœºå™¨çš„ä»»æ„èµ„æºéƒ½å°†ç•…é€šæ— é˜»ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eSecurityManager\u003c/h3\u003e\n\u003cp\u003eSecurityManager æ˜¯æ•´ä¸ªè®¿é—®æ§åˆ¶çš„ç®¡ç†å™¨å’ŒåŸºæœ¬å…¥å£ã€‚æ‰€æœ‰æ¶‰åŠåˆ°æƒé™æ§åˆ¶çš„ä»£ç ï¼Œéƒ½ä¼šç±»ä¼¼åœ°å­˜åœ¨ä¸‹åˆ—è¿™èˆ¬çš„ä»£ç :\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003eSecurityManager security = System.getSecurityManager();\n// å¦‚æœç³»ç»Ÿå­˜åœ¨å®‰å…¨ç®¡ç†å™¨\nif (security != null) {\n    // è°ƒç”¨ SecurityManager ä¸­ä»¥ check å¼€å¤´çš„æ–¹æ³•\n    security.checkXxx(...);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003esecurity.checkXxx(...)\u003c/code\u003e æ˜¯æ²¡æœ‰è¿”å›å€¼çš„(é™¤äº† checkTopLevelWindow)ï¼›å¯¹äºæ²¡æœ‰æ“ä½œæƒé™çš„ä»£ç ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸\u003c/p\u003e\n\u003cp\u003eè‡³äºåˆ°åº•åœ¨ check ä»€ä¹ˆï¼ŒJava ä¸­å®šä¹‰äº†åŒ…æ‹¬æ–‡ä»¶(File)ã€å¥—æ¥å­—(Socket)ã€ç½‘ç»œ(Net)ã€å®‰å…¨æ€§(Security)ã€è¿è¡Œæ—¶(Runtime)ã€å±æ€§(Property)ã€AWTã€åå°„(Reflect)å’Œå¯åºåˆ—åŒ–(Serializable) ä¹ç±»æƒé™ã€‚\u003c/p\u003e\n\u003cp\u003eé€šå¸¸ï¼Œsecurity.checkXxx(...) æ–¹æ³•å°†æ„é€ ä¸€ä¸ª XxxPermission(...) å¯¹è±¡æ¥è°ƒç”¨ SecurityManager æä¾›çš„ç»Ÿä¸€æ–¹æ³• checkPermission(Permission) ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e// ä»¥ checkRead(name) ä¸ºä¾‹\npublic void checkRead(String file) {\n    checkPermission(new FilePermission(file, SecurityConstants.FILE_READ_ACTION));\n}\n\n// è°ƒç”¨ checkPermission(Permission) æ–¹æ³•\npublic void checkPermission(Permission perm) {\n    // ç›´æ¥è°ƒç”¨ è®¿é—®æ§åˆ¶å™¨ æ¥å¯¹æƒé™è¿›è¡Œé‰´åˆ«\n    java.security.AccessController.checkPermission(perm);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eAccessController\u003c/h3\u003e\n\u003cp\u003eAccessController ç”¨äºä¸è®¿é—®æ§åˆ¶ç›¸å…³çš„æ“ä½œå’Œå†³å®šã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eAccessController ç±»ç”¨äºä»¥ä¸‹ä¸‰ä¸ªç›®çš„ï¼š\u003c/p\u003e\n\u003cp\u003eåŸºäºå½“å‰ç”Ÿæ•ˆçš„å®‰å…¨ç­–ç•¥å†³å®šæ˜¯å…è®¸è¿˜æ˜¯æ‹’ç»å¯¹å…³é”®ç³»ç»Ÿèµ„æºçš„è®¿é—®\nå°†ä»£ç æ ‡è®°ä¸ºäº«æœ‰â€œç‰¹æƒâ€ï¼Œä»è€Œå½±å“åç»­è®¿é—®å†³å®šï¼Œä»¥åŠ\nè·å–å½“å‰è°ƒç”¨ä¸Šä¸‹æ–‡çš„â€œå¿«ç…§â€ï¼Œè¿™æ ·ä¾¿å¯ä»¥ç›¸å¯¹äºå·²ä¿å­˜çš„ä¸Šä¸‹æ–‡ä½œå‡ºå…¶ä»–ä¸Šä¸‹æ–‡çš„è®¿é—®æ§åˆ¶å†³å®š\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3\u003eå°ç»“\u003c/h3\u003e\n\u003cp\u003eæ€»çš„æ¥è¯´ï¼ŒJava çš„è®¿é—®æ§åˆ¶å°±æ˜¯é€šè¿‡é’ˆå¯¹ä¸åŒçš„æ“ä½œæ„å»ºä¸åŒçš„ Permission å¯¹è±¡ï¼Œç„¶åé€šè¿‡ä¸ AccessControllerContent æŒæœ‰çš„å„ä»£ç çš„æƒé™è¿›è¡Œæ¯”å¯¹ï¼Œ\nä»è€Œåˆ¤æ–­ä»£ç æ˜¯å¦å­˜åœ¨ç›¸åº”çš„è®¿é—®æƒé™ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eæ‰€è°“çš„Permissionåˆ¤æ–­å°†æ˜¯å¯¹å½“å‰çº¿ç¨‹çš„è°ƒç”¨æ ˆçš„æ¯ä¸ªè°ƒç”¨è€…é€ä¸€å€’åºé€’å½’ï¼Œåˆ¤æ–­æ˜¯å¦æ‹¥æœ‰æƒé™ã€‚å¦‚æœå…¶ä¸­çš„æŸä¸ªä»£ç è¢«å£°æ˜ä¸º Privilegedï¼Œåˆ™ç›´æ¥è®¤ä¸ºæ˜¯æ‹¥æœ‰æƒé™\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ›´å¤šçš„å…³äº checkPermission(...) è°ƒç”¨ç›¸å…³çš„å†…å®¹ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥é˜…èµ„æ–™è¿›è¡Œå­¦ä¹ ï¼Œåœ¨æ­¤ä¸åšè¿‡å¤šé™ˆè¿°ã€‚:)\u003c/strong\u003e\u003c/p\u003e\n\u003ch2\u003eä¸ºæ“ä½œèµ‹æƒ\u003c/h2\u003e\n\u003cp\u003eä¸Šä¸€èŠ‚è®²å®Œäº†å¦‚æœå¯¹å½“å‰é¡¹ç›®é…ç½®äº† SecurityManager ï¼Œå°†å¯¹å„ç§æ•æ„Ÿæ“ä½œè¿›è¡Œè®¿é—®æ§åˆ¶ï¼Œå¹¶ä¸”å°†æ ¹æ®æ•´ä¸ªè°ƒç”¨é“¾è¢«èµ‹äºˆçš„æƒé™æ¥å†³å®šæ˜¯å…è®¸æ‰§è¡Œè¿˜æ˜¯æŠ›å‡º access deniedã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œç©¶ç«Ÿæ€ä¹ˆæ‰èƒ½å¤Ÿç»™ code èµ‹äºˆæƒé™å‘¢ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eå›é¡¾å‰ä¸€èŠ‚çš„å†…å®¹ï¼Œåœ¨åŸºæœ¬æ¢ç©¶ä¸­ï¼Œå…¶å®ä¸€ä¸ªèƒ½å¤Ÿçœ‹åˆ° \u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003egrant {\n    permission java.io.FilePermission \"/Users/fangfeng/test.in\", \"read\";\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¿™å°±æ˜¯ä¸€ç§èµ‹æƒçš„æ“ä½œã€‚\u003c/p\u003e\n\u003cp\u003eé€šè¿‡åœ¨æŒ‡å®šçš„æ–‡ä»¶ä¸­å†™å…¥ç¬¦åˆç‰¹å®šè§„åˆ™çš„ä»£ç ï¼Œæ¥å®Œæˆå¯¹ code çš„èµ‹æƒã€‚\u003ca href=\"https://docs.oracle.com/javase/8/docs/technotes/guides/security/PolicyFiles.html\"\u003eDefault Policy Implementation and Policy File Syntax\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eåœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™ï¼Œé»˜è®¤å°±ä¼šè¯»å– \u003ccode\u003e$JAVA\\_HOME/jre/lib/security/java.policy\u003c/code\u003e ä»¥åŠ \u003ccode\u003e${user.home}/.java.policy\u003c/code\u003e ä¸¤ä¸ªæ–‡ä»¶çš„èµ‹æƒå†…å®¹ï¼Œå¹¶åšç¼“å­˜ç»™åé¢ä»£ç ä½¿ç”¨ã€‚\u003c/p\u003e\n\u003cp\u003eå½“ç„¶ï¼ŒJava ä¹Ÿæä¾›æŒ‡å®šè‡ªå®šä¹‰çš„èµ‹æƒæ–‡ä»¶ï¼Œé€šè¿‡ -Djava.security.policy= æˆ–è€… -Djava.security.policy== ã€‚\u003c/p\u003e\n\u003ch2\u003eå‚è€ƒ\u003c/h2\u003e\n\u003cp\u003e[1]. Java Document - Security. \u003ca href=\"https://docs.oracle.com/javase/8/docs/technotes/guides/security/index.html\"\u003ehttps://docs.oracle.com/javase/8/docs/technotes/guides/security/index.html\u003c/a\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003ch2\u003eç»ªè®º\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003eæœ¬æ–‡åªæ˜¯å¯¹ Java å®‰å…¨è®¿é—®ä¸æƒé™æ§åˆ¶çš„åŸºç¡€æ€§æ¢ç©¶ã€‚\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæœ¬èŠ‚ä¸å…¨æ–‡å†…å®¹æ— å…³ï¼Œå¦‚æ— å…´è¶£é˜…è¯»ï¼Œå¯ä»¥è·³è¿‡\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eäº†è§£ Java å®‰å…¨è®¿é—®ç›¸å…³å†…å®¹çš„åˆè¡·ï¼Œæ˜¯å‡†å¤‡åœ¨é¡¹ç›®ä¸­åˆ©ç”¨ Java æ ‡å‡†åº“æä¾›çš„ ServiceLoader å¯¹ SPI å®ç°ç±»è¿›è¡Œ\"è‡ªåŠ¨å‘ç°\"å’ŒåŠ è½½ã€‚\nè¿™å¯¹äºå°†æœ¬é¡¹ç›®ä½œä¸ºäºŒæ–¹åº“æ¥ä¾èµ–çš„ä¸Šå±‚é¡¹ç›®å°†æ›´ä¸ºæ–¹ä¾¿ï¼Œåªéœ€è¦\n1. åœ¨ \u003ccode\u003eMETA-INF.services\u003c/code\u003e ç›®å½•ä¸‹é…ç½®è¢«å‘½åä¸º SPI æ¥å£å…¨é™å®šåçš„æ–‡ä»¶åŠæ·»åŠ ç›¸å…³å†…å®¹\n2. ç”±é¡¹ç›®çš„æ³¨å†Œç®¡ç†å™¨è§¦å‘ä¸‹åˆ— Java ä»£ç \u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e{\n    ServiceLoader\u0026#x3C;XxxPolicy\u003e xxxPolicyServiceLoader = ServiceLoader.load(XxxPolicy.class);\n    for (Iterator\u0026#x3C;XxxPolicy\u003e it = xxxPolicyServiceLoader.iterator(); it.hasNext(); ) {\n        XxxPolicy xxxPolicy = it.next();\n        // ... more code ...\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå°±å¯ä»¥å®Œæˆä¸€ä¸ªæ–°çš„ SPI ç­–ç•¥çš„æ³¨å†Œå·¥ä½œã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œåœ¨å°è¯•å®ç°ï¼Œäº†è§£äº† ServiceLoader æºç ï¼Œä»¥åŠ DriverManager å’Œ mysql-connection-java-.jar åœ¨æ³¨å†Œ Driver ç›¸å…³çš„ä»£ç ã€‚\nå‘ç°æ€ä¹ˆä¹Ÿç»•ä¸å¼€ Java å®‰å…¨è®¿é—®ç›¸å…³çš„å†…å®¹ã€‚è¯¸å¦‚ä¸‹åˆ—è¿™æ®µæ¥è‡ª DriverManager.loadInitialDrivers() çš„ä»£ç :\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003eAccessController.doPrivileged(new PrivilegedAction\u0026#x3C;Void\u003e() {\n    public Void run() {\n\n        ServiceLoader\u0026#x3C;Driver\u003e loadedDrivers = ServiceLoader.load(Driver.class);\n        Iterator\u0026#x3C;Driver\u003e driversIterator = loadedDrivers.iterator();\n\n        try{\n            while(driversIterator.hasNext()) {\n            driversIterator.next();\n            }\n        } catch(Throwable t) {\n                // Do nothing\n        }\n        return null;\n    }\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¯¸å¦‚ AccessController, Permission, SecurityManager çš„ä»£ç å§‹ç»ˆæ˜¯ä¸€ä¸ªç»•ä¸å¼€çš„ä¸»æ—‹å¾‹ã€‚\u003c/p\u003e\n\u003cp\u003eä¸ºäº†æ¢ç©¶è¿™éƒ¨åˆ†æ§åˆ¶å¯¹é¡¹ç›®ä¸­ ServiceLoader çš„çœŸæ­£ä½œç”¨ä»¥åŠå…¶ç¼–ç æ„ä¹‰ï¼Œå¼€å§‹äº†å¯¹æœ¬æ–‡æ‰€æè¿°çš„ä¸»ä½“å†…å®¹çš„åˆæ­¥äº†è§£ã€‚\u003c/p\u003e"},{"url":"2018-07-10-CGlib-Enhancer","fileName":"2018-07-10-CGlib-Enhancer.md","title":"CGlib Enhancer ä¸»æµç¨‹æºç è§£æ","author":"fangfeng","date":"2018-07-10T00:00:00.000Z","tags":["CGlib","ASM"],"content":"\u003ch2\u003eå‰è¨€\u003c/h2\u003e\n\u003cp\u003eæ­¤åšæ–‡å†™ä½œçš„ç›®çš„: \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e(Core) é€šè¿‡äº†è§£ CGlib Enhancer çš„æ•´ä¸ªè°ƒç”¨é“¾ï¼Œäº†è§£å…¶å¯¹äºå”¯ä¸€ä¾èµ–çš„ ASM åº“çš„è°ƒç”¨æ–¹å¼ã€‚\u003c/li\u003e\n\u003cli\u003eåŸºäº Enhancer å¯¹å·²æœ‰å­—èŠ‚ç è¿›è¡Œå¢å¼ºçš„è¿›ä¸€æ­¥ç†è§£ä¸æŒæ¡ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eEnhancer\u003c/h2\u003e\n\u003cp\u003eä»è¿™ç¯‡ä¸æ˜¯å®˜æ–¹ä½†æ›´èƒœäºå®˜æ–¹æ–‡æ¡£çš„ \u003ca href=\"http://mydailyjava.blogspot.com/2013/11/cglib-missing-manual.html\"\u003eCGlib Guide\u003c/a\u003e æ¥çœ‹ï¼Œå®ƒé¦–å…ˆæåˆ°çš„ç¬¬ä¸€ä¸ªç±»å°±æ˜¯ Enhancerã€‚\nå…¶è¢«ç”¨äºåˆ›å»º Java ä»£ç†ç±»ï¼Œç›¸è¾ƒäº Java æ ‡å‡†åº“çš„ Proxy ç±»ï¼Œå®ƒ\u003cstrong\u003eç‰¹åˆ«åœ°\u003c/strong\u003eï¼Œèƒ½å¤Ÿæ”¯æŒé‚£äº›æ²¡æœ‰å®ç°æ¥å£çš„ç±»çš„ä»£ç†å·¥ä½œã€‚\u003c/p\u003e\n\u003ch3\u003eEnhancer ç®€å•ç¤ºä¾‹å±•ç¤º\u003c/h3\u003e\n\u003cp\u003eé’ˆå¯¹ç°æœ‰çš„ SampleClass ç±»\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic class SampleClass {\n    public String test(String input) {\n        return \"Hello World!\";\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä½¿ç”¨ CGlib çš„ Enhancer å¯¹ SampleClass è¿›è¡Œå¢å¼ºï¼Œä¸‹åˆ—æ“ä½œçš„ç›®çš„åœ¨äºå°† test(String) æ–¹æ³•çš„è¿”å›å€¼æ”¹å†™æˆ \"Hello cglib!\"\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e@Test\npublic void testFixedValue() {\n    // new ä¸€ä¸ª Enhancer å®ä¾‹\n    Enhancer enhancer = new Enhancer();\n    // å£°æ˜ä½¿ç”¨çš„çˆ¶ç±»æ˜¯ SampleClass\n    enhancer.setSuperclass(SampleClass.class);\n    // è®¾ç½®å›è°ƒæ–¹æ³• - å›è°ƒæ–¹æ³•å®ç°ä¸º FixedValue (å›ºå®šå€¼) .\n    enhancer.setCallback(new FixedValue() {\n        public Object loadObject() throws Exception {\n            return \"Hello cglib!\";\n        }\n    });\n    // åˆ›å»º SampleClass çš„ä»£ç†å­ç±»å®ä¾‹\n    SampleClass proxy = (SampleClass) enhancer.create();\n    Assert.assertEquals(\"Hello cglib!\", proxy.test(null));\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eç®€å•æµ‹è¯•ä¸Šè¿°ä»£ç ï¼Œå¯ä»¥äº†è§£åˆ°ç¡®å®ï¼Œä»£ç†ç±»çš„ test(String) æ–¹æ³•çš„è¿”å›å€¼è¢«æ”¹å†™äº†ã€‚\né‚£ä¹ˆï¼Œç©¶ç«Ÿè¿™ç§æ“ä½œæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿä¸‹é¢ğŸ‘‡å°†è¿›è¡Œå…·ä½“çš„æ¢ç©¶ã€‚\u003c/p\u003e\n\u003ch2\u003eè°ƒç”¨é“¾è·Ÿè¸ª\u003c/h2\u003e\n\u003ch3\u003eé«˜åº¦æŠ½è±¡çš„æ—¶åºå›¾\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"https://ws4.sinaimg.cn/large/006tKfTcgy1ft4ifuo997j31jh0st42t.jpg\" alt=\"Enhancer è°ƒç”¨é“¾ æ—¶åºå›¾\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eä¸‹åˆ—å†…å®¹å°†æ ¹æ®æ—¶åºå›¾è¿›è¡Œç»„ç»‡ï¼Œæ ¹æ®è°ƒç”¨ç¼–å·(1,2,3...)è¿›è¡Œå±•å¼€\u003c/em\u003e\u003c/p\u003e\n\u003ch3\u003eSeq 1.\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic Object create() {\n    classOnly = false;\n    argumentTypes = null;\n    return createHelper();\n}\n\npublic Object create(Class[] argumentTypes, Object[] arguments) {\n    classOnly = false;\n    if (argumentTypes == null || arguments == null || argumentTypes.length != arguments.length) {\n        throw new IllegalArgumentException(\"Arguments must be non-null and of equal length\");\n    }\n    this.argumentTypes = argumentTypes;\n    this.arguments = arguments;\n    return createHelper();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä¸Šè¿°ä¸¤ä¸ª \u003ccode\u003ecreate(...)\u003c/code\u003e æ–¹æ³•ã€‚ç»“åˆä¸Šä¸€èŠ‚çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ° \u003ccode\u003ecreate()\u003c/code\u003e å¯¹åº”çš„\u003cstrong\u003eæ— å‚æ„é€ \u003c/strong\u003eã€‚\nå­˜åœ¨æ— å‚æ„é€ ï¼Œé‚£ä¹ˆ\u003cstrong\u003eæœ‰å‚çš„æ„é€ æ–¹æ³•\u003c/strong\u003eæ˜¾ç„¶ä¹Ÿæ˜¯åº”è¯¥è¢«æ”¯æŒidã€‚\u003ccode\u003ecreate(Class[], Object[])\u003c/code\u003e æ­£æ˜¯ä¸ºäº†è¿™ä¸ªç›®æ ‡è€Œå­˜åœ¨ã€‚é€šè¿‡æä¾›å‚æ•°ç±»å‹æ•°ç»„å’Œå‚æ•°å®ä¾‹æ•°ç»„ï¼Œå¯ä»¥å”¯ä¸€åœ°å®šä½åŠè°ƒç”¨ä»£ç†ç±»çš„ç‰¹å®šæ„é€ æ–¹æ³•ã€‚\u003c/p\u003e\n\u003cp\u003eè¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯å°† Enhancer ä½œä¸ºä¸€ä¸ªæ•°æ®å†…å®¹çš„æŒæœ‰è€…ï¼Œé‡ç½®äº†æ–°ä»£ç†ç±»å°†ä½¿ç”¨çš„æ„é€ å‡½æ•°å‚æ•°å†…å®¹ï¼Œä¹‹åå°±ç›´æ¥è°ƒç”¨äº† \u003ccode\u003ecreateHelper()\u003c/code\u003e ã€‚\u003c/p\u003e\n\u003ch3\u003eSeq 2.\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003eprivate Object createHelper() {\n    // å¯¹é¢„å£°æ˜çš„å›è°ƒæ–¹æ³•è¿›è¡ŒéªŒè¯ï¼Œè¦æ±‚ [å¤šä¸ªå›è°ƒå°±å¿…é¡»å­˜åœ¨ CallbackFilter ä½œä¸ºè°ƒåº¦å™¨]\n    preValidate();\n    // æ„å»ºä¸€ä¸ªå¯¹è¿™ç±»å¢å¼ºæ“ä½œå”¯ä¸€å®šä½çš„ key\n    Object key = KEY_FACTORY.newInstance((superclass != null) ? superclass.getName() : null,\n            ReflectUtils.getNames(interfaces),\n            filter == ALL_ZERO ? null : new WeakCacheKey\u0026#x3C;CallbackFilter\u003e(filter),\n            callbackTypes,\n            useFactory,\n            interceptDuringConstruction,\n            serialVersionUID);\n    this.currentKey = key;\n    // è°ƒç”¨çˆ¶ç±»é€šè¿‡çš„ create(...) æ–¹æ³•\n    Object result = super.create(key);\n    return result;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eSeq 3.\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003eprotected Object create(Object key) {\n    try {\n        // è·å–ç”¨äº åŠ è½½ ç”Ÿæˆç±» çš„ ClassLoader\n        ClassLoader loader = getClassLoader();\n        // ä»ç¼“å­˜ä¸­åŠ è½½ è¿™ä¸ª ClassLoader è¿‡å»åŠ è½½çš„ç›¸å…³æ•°æ®\n        Map\u0026#x3C;ClassLoader, ClassLoaderData\u003e cache = CACHE;\n        ClassLoaderData data = cache.get(loader);\n        // å¦‚æœåœ¨ ç¼“å­˜ ä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™åˆå§‹åŒ–æ„é€ å…³äºè¿™ä¸ª ClassLoader çš„æ•°æ®å®ä¾‹\n        if (data == null) {\n            // åŒæ­¥\n            synchronized (AbstractClassGenerator.class) {\n                // è¿›å…¥åŒæ­¥å—åçš„ å†æ¬¡ç¡®è®¤ï¼Œé¿å…é‡å¤åˆå§‹åŒ–æ„å»º\n                cache = CACHE;\n                data = cache.get(loader);\n                if (data == null) {\n                    // æ„å»ºæ–°çš„ ç¼“å­˜ï¼Œæ‹·è´åŸæœ‰çš„ç¼“å­˜é›†çš„å†…å®¹\n                    Map\u0026#x3C;ClassLoader, ClassLoaderData\u003e newCache = new WeakHashMap\u0026#x3C;ClassLoader, ClassLoaderData\u003e(cache);\n                    // åˆå§‹åŒ– ClassLoaderData ï¼ŒçœŸæ­£çš„æ„é€ æ“ä½œ\n                    data = new ClassLoaderData(loader);\n                    // æ·»åŠ åˆ°ç¼“å­˜ä¸­\n                    newCache.put(loader, data);\n                    CACHE = newCache;\n                }\n            }\n        }\n        this.key = key;\n        Object obj = data.get(this, getUseCache());\n        if (obj instanceof Class) {\n            // åˆæ¬¡å®ä¾‹åŒ–æ“ä½œï¼Œå°±æ˜¯ Class åˆ©ç”¨åå°„æ¥è¿›è¡Œå®ä¾‹åŒ–\n            return firstInstance((Class) obj);\n        }\n        // éåˆæ¬¡å®ä¾‹åŒ–ï¼Œåˆ™æ˜¯ä» ClassLoaderData ä¸­å¾—åˆ°çš„ä¹‹å‰ç»´æŠ¤çš„å†…å®¹\n        return nextInstance(obj);\n    } catch (RuntimeException e) {\n        throw e;\n    } catch (Error e) {\n        throw e;\n    } catch (Exception e) {\n        throw new CodeGenerationException(e);\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¿™éƒ¨åˆ†å†…å®¹æ¯”è¾ƒå¤šï¼Œä¸”æ˜¯è°ƒç”¨é“¾æ¯”è¾ƒé‡è¦çš„ä¸€ç¯ã€‚\u003cstrong\u003eSeq 4.\u003c/strong\u003e å’Œ \u003cstrong\u003eSeq 5.\u003c/strong\u003e å°†ä½œä¸ºå…¶å­å†…å®¹è¿›è¡Œè°ƒç”¨ï¼Œä½†ä¸ºäº†æœ¬åšæ–‡çš„ç»“æ„å®Œæ•´ï¼Œ \u003cem\u003eSeq 4. \u0026#x26; Seq5.\u003c/em\u003e çš„æ ‡é¢˜ä¸ \u003cem\u003eSeq 3.\u003c/em\u003e æ ‡é¢˜åŒçº§\u003c/p\u003e\n\u003ch3\u003eSeq 4.\u003c/h3\u003e\n\u003cp\u003eé¦–å…ˆåº”è¯¥è®¤è¯†åˆ°ï¼Œæ¯ä¸ªè¢«åŠ è½½çš„ Class ï¼Œåœ¨ \u003ccode\u003eequal\u003c/code\u003e çš„åˆ¤æ–­è¿‡ç¨‹ä¸­ï¼Œä¾æ®çš„æ˜¯åŒä¸€ä¸ª ClassLoader åŠ è½½çš„åŒä¸€ Class æ‰è¢«è®¤ä¸ºæ˜¯ç›¸åŒçš„ï¼Œå¦åˆ™å³ä½¿ Class æ˜¯åŒä¸€ä¸ªï¼Œä½†ä»ä¼šè¢«è®¤ä¸ºæ˜¯ä¸åŒçš„(ç”±ä¸åŒçš„ ClassLoader åŠ è½½)ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic ClassLoader getClassLoader() {\n    ClassLoader t = classLoader;\n    if (t == null) {\n        t = getDefaultClassLoader();\n    }\n    if (t == null) {\n        t = getClass().getClassLoader();\n    }\n    if (t == null) {\n        t = Thread.currentThread().getContextClassLoader();\n    }\n    if (t == null) {\n        throw new IllegalStateException(\"Cannot determine classloader\");\n    }\n    return t;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå› æ­¤ï¼Œåœ¨è¿™éƒ¨åˆ†ä¸­ï¼Œé¦–å…ˆéœ€è¦ç¡®å®šçš„æ˜¯ç”±å“ªä¸ª ClassLoader è¿›è¡ŒåŠ è½½çš„å·¥ä½œã€‚\u003ccode\u003egetClassLoader()\u003c/code\u003e çš„ç¡®å®šé¡ºåºæ˜¯:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå…·ä½“å®ç°ç±»å£°æ˜çš„ \u003cstrong\u003eé»˜è®¤ ClassLoader\u003c/strong\u003e ä¸ºç¬¬ä¸€ä¼˜å…ˆçº§\u003c/li\u003e\n\u003cli\u003eåŠ è½½å½“å‰ç±»(è¿™é‡Œæ˜¯ Enhancer) çš„ ClassLoader ä¸ºç¬¬äºŒä¼˜å…ˆçº§\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡ ClassLoader\u003c/strong\u003e ä¸ºç¬¬ä¸‰ä¼˜å…ˆçº§\u003c/li\u003e\n\u003cli\u003eæŠ›å‡ºå¼‚å¸¸\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eå›åˆ° \u003cstrong\u003eSeq 3.\u003c/strong\u003e çš„å†…å®¹ï¼Œ\nä¸‹ä¸€æ­¥æ˜¯å¯¹å½“å‰è¿™ä¸ª\u003cstrong\u003eAbstractClassGenerator\u003c/strong\u003e ç»´æŠ¤çš„ CACHE è¿›è¡Œå¤„ç†ï¼Œå¦‚æœåœ¨ CACHE ä¸­èƒ½å¤Ÿå¾—åˆ°ä»¥ç¡®å®šçš„ ClassLoader ä¸º Key çš„é”®å€¼å¯¹ï¼Œåˆ™ç›´æ¥è·å– ClassLoader å¯¹åº”çš„å€¼ï¼Œå¦åˆ™å°†è¿›è¡Œåˆå§‹åŒ–æ„å»ºä¸€ä¸ªæ–°çš„ ClassLoaderData ä½œä¸ºè¿™ä¸ª ClassLoader çš„å€¼ã€‚\u003c/p\u003e\n\u003ch3\u003eSeq 5.\u003c/h3\u003e\n\u003cp\u003eåœ¨æ„å»º ClassLoaderData çš„è¿‡ç¨‹ä¸­ï¼Œæœ€é‡è¦çš„ä¸€æ­¥:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic ClassLoaderData(ClassLoader classLoader) {\n    // ClassLoader ä¸å¯ä¸ºç©º\n    if (classLoader == null) {\n        throw new IllegalArgumentException(\"classLoader == null is not yet supported\");\n    }\n    // æ„å»º ClassLoader çš„å¼±å¼•ç”¨\n    this.classLoader = new WeakReference\u0026#x3C;ClassLoader\u003e(classLoader);\n    // å†™äº†ä¸ªåç½®è°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºæ‡’åŠ è½½ï¼Œåªæœ‰è°ƒç”¨äº† load.apply(...) æ‰ä¼šæ„å»º ç”Ÿæˆç±»\n    Function\u0026#x3C;AbstractClassGenerator, Object\u003e load =\n            new Function\u0026#x3C;AbstractClassGenerator, Object\u003e() {\n                public Object apply(AbstractClassGenerator gen) {\n                    Class klass = gen.generate(ClassLoaderData.this);\n                    return gen.wrapCachedClass(klass);\n                }\n            };\n    generatedClasses = new LoadingCache\u0026#x3C;AbstractClassGenerator, Object, Object\u003e(GET_KEY, load);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæ„å»ºäº†ä¸€ä¸ª Function å®ä¾‹ï¼Œè¿™ä¸ª Function ä½œä¸ºå‡½æ•°å¼æ¥å£ï¼Œé¢„å®šä¹‰æ‰§è¡Œçš„å…·ä½“æµç¨‹ï¼Œä½†ç”±ä¸Šä¸‹æ–‡ç¡®å®šå…·ä½“çš„è°ƒç”¨æ—¶åˆ»ã€‚\u003c/p\u003e\n\u003ch3\u003eSeq 6.\u003c/h3\u003e\n\u003cp\u003eåœ¨æ­£ç¡®å¾—åˆ°äº† ClassLoader å¯¹åº”çš„ ClassLoaderData ä¹‹åï¼ŒClassLoaderData çš„ \u003ccode\u003eget(...)\u003c/code\u003e æ–¹æ³•å°†åœ¨ç‰¹å®šçš„ ClassLoader ä¹‹ä¸‹ï¼Œè¿›è¡Œæ›´å…·ä½“çš„åŠ è½½æ–°ç”Ÿæˆç±»çš„å·¥ä½œã€‚\nå½“ç„¶ï¼Œè¿™é‡Œçš„å‰ææ˜¯æ–°çš„ç”Ÿæˆç±»çš„å­—èŠ‚ç å·²ç»è¢«æ„å»º:)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic Object get(AbstractClassGenerator gen, boolean useCache) {\n    // æ ‡è®°ä¸ºä¸ä½¿ç”¨ç¼“å­˜ï¼Œç›´æ¥æ„å»º æ–°çš„ç”Ÿæˆç±»\n    if (!useCache) {\n      return gen.generate(ClassLoaderData.this);\n    }\n    // ä½¿ç”¨ç¼“å†²çš„æƒ…å†µ\n    else {\n      Object cachedValue = generatedClasses.get(gen);\n      return gen.unwrapCachedValue(cachedValue);\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¯ä»¥çœ‹åˆ° \u003ccode\u003egen.generate(ClassLoaderData.this)\u003c/code\u003e è¿™æ®µä»£ç åœ¨ \u003ccode\u003eget(...)\u003c/code\u003e æ–¹æ³•å’Œä¸Šä¸€å°èŠ‚ \u003ccode\u003eClassLoaderData(...)\u003c/code\u003e æ„é€ æ–¹æ³•çš„ Function å‡½æ•°å¼å®ä¾‹éƒ½å‡ºç°äº†ã€‚\u003c/p\u003e\n\u003cp\u003eå®é™…ä¸Šï¼Œè¿™ä¹Ÿæ˜¯è§¦å‘ ClassLoader æ¥åŠ è½½åŠ¨æ€ç”Ÿæˆçš„æ–° Class çš„å”¯ä¸€å…¥å£ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eåˆ¤æ–­é€»è¾‘\u003c/em\u003e çš„ \u003ccode\u003eelse\u003c/code\u003e å†…å®¹çš„å”¯ä¸€åŒºåˆ«å°±åœ¨äºå…¶æ„å»ºçš„æ˜¯ä¸€ä¸ªåŠ è½½ç¼“å­˜ï¼Œå°†çœŸæ­£è§¦å‘ gen.generate(ClassLoaderData.this) çš„é€»è¾‘å»¶è¿Ÿã€‚(ä¸è¿‡ï¼Œæœ€ç»ˆä¹Ÿè¿˜æ˜¯ä¼šè¿›è¡Œè°ƒç”¨çš„ï¼Œ:) è¿™æ˜¯æ¯‹åº¸ç½®ç–‘çš„)ã€‚\u003c/p\u003e\n\u003ch3\u003eSeq 7.\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003eprotected Class generate(ClassLoaderData data) {\n    Class gen;\n    Object save = CURRENT.get();\n    CURRENT.set(this);\n    try {\n        // æ‹¿åˆ°ç”¨äºåŠ è½½ç”Ÿæˆç±»çš„ ClassLoader\n        ClassLoader classLoader = data.getClassLoader();\n        if (classLoader == null) {\n            throw new IllegalStateException(\"ClassLoader is null while trying to define class \" +\n                    getClassName() + \". It seems that the loader has been expired from a weak reference somehow. \" +\n                    \"Please file an issue at cglib's issue tracker.\");\n        }\n        // æ„å»ºä¸€ä¸ªåˆæ³•çš„ ç”Ÿæˆç±» çš„ç±»å(éé‡å¤)\n        synchronized (classLoader) {\n          String name = generateClassName(data.getUniqueNamePredicate());\n          data.reserveName(name);\n          this.setClassName(name);\n        }\n        if (attemptLoad) {\n            try {\n                // å°è¯•ç›´æ¥é€šè¿‡ ClassLoader è¿›è¡ŒåŠ è½½\n                gen = classLoader.loadClass(getClassName());\n                return gen;\n            } catch (ClassNotFoundException e) {\n                // ignore\n            }\n        }\n        // ç­–ç•¥ä¸‹çš„ç”Ÿæˆç±»æ„å»ºæ–¹æ³•\n        byte[] b = strategy.generate(this);\n        // é€šè¿‡è§£æå­—èŠ‚ç çš„å½¢å¼è·å– ç”Ÿæˆç±»çš„ className\n        String className = ClassNameReader.getClassName(new ClassReader(b));\n        ProtectionDomain protectionDomain = getProtectionDomain();\n        synchronized (classLoader) { // just in case\n            // åå°„çš„å½¢å¼åŠ è½½ Class ç±»\n            if (protectionDomain == null) {\n                gen = ReflectUtils.defineClass(className, b, classLoader);\n            } else {\n                gen = ReflectUtils.defineClass(className, b, classLoader, protectionDomain);\n            }\n        }\n        return gen;\n    } catch (RuntimeException e) {\n        throw e;\n    } catch (Error e) {\n        throw e;\n    } catch (Exception e) {\n        throw new CodeGenerationException(e);\n    } finally {\n        CURRENT.set(save);\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¿™ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯æ“ä½œå­—èŠ‚ç ï¼ŒåŠ è½½ Class çš„æ ¸å¿ƒè°ƒåº¦æ–¹æ³•ã€‚\u003c/p\u003e\n\u003cp\u003eå¯ä»¥çœ‹åˆ° \u003ccode\u003egenerateClassName(...)\u003c/code\u003e æ–¹æ³•å°†æ„å»ºä¸€ä¸ªå½“å‰ ClassLoader ä¸‹å”¯ä¸€, ä¸é‡å¤çš„æ–°çš„ç±»åã€‚\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003estrategy.generate(this)\u003c/code\u003e å°†é€šè¿‡ç‰¹å®šç­–ç•¥å®ç°çš„å½¢å¼ç”Ÿæˆæ–°çš„å­—èŠ‚ç \u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eReflectUtils.defineClass(className, b, classLoader)\u003c/code\u003e å°†ä½¿ç”¨åå°„ä½¿å¾— ClassLoader æ¥åŠ è½½è¿™ä¸ªæ–°çš„ç”Ÿæˆç±»ã€‚\u003c/p\u003e\n\u003ch3\u003eSeq 8.\u003c/h3\u003e\n\u003cp\u003eç”Ÿæˆæ–°çš„ä¸é‡å¤ç±»åè¿™éƒ¨åˆ†ä¸åšè¿‡å¤šé™ˆè¿°ï¼Œå¯ä»¥ç®€å•è¿›è¡Œäº†è§£ï¼Œå¹¶ç†Ÿæ‚‰ CGlib é»˜è®¤çš„æ–°ç±»åçš„å‘½åè§„åˆ™\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e// DefaultNamePolicy\npublic String getClassName(String prefix, String source, Object key, Predicate names) {\n    if (prefix == null) {\n        prefix = \"net.sf.cglib.empty.Object\";\n    } else if (prefix.startsWith(\"java\")) {\n        prefix = \"$\" + prefix;\n    }\n    String base =\n        prefix + \"$$\" +\n        source.substring(source.lastIndexOf('.') + 1) +\n        getTag() + \"$$\" +\n        Integer.toHexString(STRESS_HASH_CODE ? 0 : key.hashCode());\n    String attempt = base;\n    int index = 2;\n    while (names.evaluate(attempt))\n        attempt = base + \"_\" + index++;\n    return attempt;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eSeq 9.\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e// ä¸‹åˆ—æ˜¯ DefaultGeneratorStrategy çš„å®ç°\npublic byte[] generate(ClassGenerator cg) throws Exception {\n    DebuggingClassWriter cw = getClassVisitor();\n    transform(cg).generateClass(cw);\n    return transform(cw.toByteArray());\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eSeq 10.\u003c/h3\u003e\n\u003cp\u003eè°ƒç”¨ \u003ccode\u003egenerateClass(ClassVisitor)\u003c/code\u003e å°†è·å¾—åˆ°æ–°ç±»çš„å­—èŠ‚ç ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic void generateClass(ClassVisitor v) throws Exception {\n    // ç¡®å®šç”Ÿæˆç±»çš„ çˆ¶ç±»\n    Class sc = (superclass == null) ? Object.class : superclass;\n\n    // çˆ¶ç±»æ ‡è¯†ç¬¦ä¸å¯ä»¥ä¸º final\n    if (TypeUtils.isFinal(sc.getModifiers()))\n        throw new IllegalArgumentException(\"Cannot subclass final class \" + sc.getName());\n    // è·å–çˆ¶ç±»ç›´æ¥å£°æ˜çš„æ„é€ æ–¹æ³•\n    List constructors = new ArrayList(Arrays.asList(sc.getDeclaredConstructors()));\n    filterConstructors(sc, constructors);\n\n    // Order is very important: must add superclass, then\n    // its superclass chain, then each interface and\n    // its superinterfaces.\n    List actualMethods = new ArrayList();\n    List interfaceMethods = new ArrayList();\n    final Set forcePublic = new HashSet();\n    // ä»çˆ¶ç±»ä¸­æå–å„ç§ä¿¡æ¯\n    getMethods(sc, interfaces, actualMethods, interfaceMethods, forcePublic);\n\n    List methods = CollectionUtils.transform(actualMethods, new Transformer() {\n        public Object transform(Object value) {\n            Method method = (Method)value;\n            int modifiers = Constants.ACC_FINAL\n                | (method.getModifiers()\n                   \u0026#x26; ~Constants.ACC_ABSTRACT\n                   \u0026#x26; ~Constants.ACC_NATIVE\n                   \u0026#x26; ~Constants.ACC_SYNCHRONIZED);\n            if (forcePublic.contains(MethodWrapper.create(method))) {\n                modifiers = (modifiers \u0026#x26; ~Constants.ACC_PROTECTED) | Constants.ACC_PUBLIC;\n            }\n            return ReflectUtils.getMethodInfo(method, modifiers);\n        }\n    });\n\n    ClassEmitter e = new ClassEmitter(v);\n    if (currentData == null) {\n    e.begin_class(Constants.V1_2,\n                  Constants.ACC_PUBLIC,\n                  getClassName(),\n                  Type.getType(sc),\n                  (useFactory ?\n                   TypeUtils.add(TypeUtils.getTypes(interfaces), FACTORY) :\n                   TypeUtils.getTypes(interfaces)),\n                  Constants.SOURCE_FILE);\n    } else {\n        e.begin_class(Constants.V1_2,\n                Constants.ACC_PUBLIC,\n                getClassName(),\n                null,\n                new Type[]{FACTORY},\n                Constants.SOURCE_FILE);\n    }\n    List constructorInfo = CollectionUtils.transform(constructors, MethodInfoTransformer.getInstance());\n\n    e.declare_field(Constants.ACC_PRIVATE, BOUND_FIELD, Type.BOOLEAN_TYPE, null);\n    e.declare_field(Constants.ACC_PUBLIC | Constants.ACC_STATIC, FACTORY_DATA_FIELD, OBJECT_TYPE, null);\n    if (!interceptDuringConstruction) {\n        e.declare_field(Constants.ACC_PRIVATE, CONSTRUCTED_FIELD, Type.BOOLEAN_TYPE, null);\n    }\n    e.declare_field(Constants.PRIVATE_FINAL_STATIC, THREAD_CALLBACKS_FIELD, THREAD_LOCAL, null);\n    e.declare_field(Constants.PRIVATE_FINAL_STATIC, STATIC_CALLBACKS_FIELD, CALLBACK_ARRAY, null);\n    if (serialVersionUID != null) {\n        e.declare_field(Constants.PRIVATE_FINAL_STATIC, Constants.SUID_FIELD_NAME, Type.LONG_TYPE, serialVersionUID);\n    }\n\n    for (int i = 0; i \u0026#x3C; callbackTypes.length; i++) {\n        e.declare_field(Constants.ACC_PRIVATE, getCallbackField(i), callbackTypes[i], null);\n    }\n    // This is declared private to avoid \"public field\" pollution\n    e.declare_field(Constants.ACC_PRIVATE | Constants.ACC_STATIC, CALLBACK_FILTER_FIELD, OBJECT_TYPE, null);\n\n    if (currentData == null) {\n        emitMethods(e, methods, actualMethods);\n        emitConstructors(e, constructorInfo);\n    } else {\n        emitDefaultConstructor(e);\n    }\n    emitSetThreadCallbacks(e);\n    emitSetStaticCallbacks(e);\n    emitBindCallbacks(e);\n\n    if (useFactory || currentData != null) {\n        int[] keys = getCallbackKeys();\n        emitNewInstanceCallbacks(e);\n        emitNewInstanceCallback(e);\n        emitNewInstanceMultiarg(e, constructorInfo);\n        emitGetCallback(e, keys);\n        emitSetCallback(e, keys);\n        emitGetCallbacks(e);\n        emitSetCallbacks(e);\n    }\n\n    e.end_class();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003egenerateClass(...)\u003c/code\u003e æ‰§è¡Œçš„æ“ä½œå’Œ ASM åº“çš„ ClassVisitor è®¿é—® Class æ–‡ä»¶ç»“æ„çš„æµç¨‹åŸºæœ¬ç±»ä¼¼ã€‚\u003c/p\u003e\n\u003cp\u003eä»ä¸Šè¿°æˆªå–åˆ°çš„éƒ¨åˆ†ä»£ç ï¼Œä¾‹å¦‚:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003ee.begin_class(Constants.V1_2, Constants.ACC_PUBLIC, getClassName(), Type.getType(sc), \n        (useFactory ? TypeUtils.add(TypeUtils.getTypes(interfaces), FACTORY) : TypeUtils.getTypes(interfaces)),\n        Constants.SOURCE_FILE);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003ee.declare_field(Constants.PRIVATE_FINAL_STATIC, THREAD_CALLBACKS_FIELD, THREAD_LOCAL, null);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eéƒ½ä¸ \u003ccode\u003eclassVisitor.visit(...)\u003c/code\u003e ä»¥åŠ \u003ccode\u003eclassVisitor.visitField(...)\u003c/code\u003e ç›¸å½“ç±»ä¼¼ã€‚è€Œäº‹å®ä¸Šï¼Œè¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°ä¹Ÿç¡®å®è°ƒç”¨äº† cv.visitXxx(...) ã€‚\næ¯•ç«Ÿï¼Œä½œä¸º CGlib å”¯ä¸€ä¾èµ–çš„åº“ï¼ŒASM è¿˜æ˜¯å¯ä»¥è¯´æ˜¯éš¾ä»¥æ›¿ä»£çš„(æ—¢ç„¶å·²ç»æœ‰äº†å¯ç”¨çš„è½®å­ï¼Œåˆä½•å¿…é‡å¤é€ å‘¢?)\u003c/p\u003e\n\u003ch2\u003eæ„é€ çš„å®ä¾‹\u003c/h2\u003e\n\u003cp\u003eä¸‹é¢å°†å±•ç¤ºé€šè¿‡ CGlib ç”Ÿæˆçš„æ–°çš„ç±»(ç”±äºç”Ÿæˆçš„æ˜¯å­—èŠ‚ç ï¼Œæ‡’å¾—å†è‡ªè¡Œè§£æ ClassFile çš„å†…å®¹ï¼Œæ‰€æœ‰ç›´æ¥ç”¨ \u003ccode\u003eIDEA\u003c/code\u003e åšäº†å­—èŠ‚ç çš„è§£æ)\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eé¦–å…ˆå±•ç¤ºçš„éœ€è¦è¿›è¡Œå¢å¼ºçš„ SampleClass çš„å…·ä½“å†…å®¹\u003c/strong\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic class SampleClass {\n    public String test(String input) {\n        return \"Hello World!\";\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eç”¨äºå¢å¼ºçš„ç®€å•ä»£ç \u003c/strong\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e// çœç•¥éƒ¨åˆ†ä»£ç \npublic static void main(String... args) {\n    Enhancer enhancer = new Enhancer();\n    enhancer.setSuperclass(SampleClass.class);\n    enhancer.setCallback(new FixedValue() {\n        public Object loadObject() throws Exception {\n            return \"Hello cglib!\";\n        }\n    });\n    SampleClass proxy = (SampleClass) enhancer.create();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eåŠ¨æ€ç”Ÿæˆçš„æ–°çš„ç±»\u003c/strong\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003e//\n// Source code recreated from a .class file by IntelliJ IDEA\n// (powered by Fernflower decompiler)\n//\n\n// ä¸ç”¨è¿‡å¤šå…³æ³¨ï¼Œåªæ˜¯ CGlib ä¿è¯ç”Ÿæˆç±»ä¸åŸæœ‰çš„ç±»ä¸€å®šå±äºåŒä¸€åŒ…ä¸‹ï¼Œå·æ‡’ç›´æ¥æŠŠ SampleClass å†™åœ¨ CGlib é¡¹ç›®é‡Œäº†\npackage net.sf.cglib.samples;\n\nimport net.sf.cglib.proxy.Callback;\nimport net.sf.cglib.proxy.Factory;\nimport net.sf.cglib.proxy.FixedValue;\n\n/**\n * æ–°çš„ç±»åï¼Œé€šè¿‡ $$EnhancerByCGLIB ä»¥åŠ $$7cd64b81(è¿™ä¸ªæ˜¯å“ˆå¸Œå€¼) å¯¹ç±»åè¿›è¡Œå”¯ä¸€åŒºåˆ† \n * å¦‚æœè¿˜æ˜¯é‡å¤äº†ï¼Œåœ¨åŠ¨æ€ç”Ÿæˆå‰ä¼šè¿›è¡Œç±»åçš„æ£€æµ‹ï¼Œå¹¶é€šè¿‡å¢åŠ åºå· \"_\u0026#x3C;index\u003e\" çš„å½¢å¼è¿›è¡Œè¿›ä¸€æ­¥åŒºåˆ†\n *\n * å¯ä»¥çœ‹åˆ°æ–°ç”Ÿæˆçš„ç±»ç»§æ‰¿äº† SampleClass \n */\npublic class SampleClass$$EnhancerByCGLIB$$7cd64b81 extends SampleClass implements Factory {\n    private boolean CGLIB$BOUND;\n    public static Object CGLIB$FACTORY_DATA;\n    private static final ThreadLocal CGLIB$THREAD_CALLBACKS;\n    private static final Callback[] CGLIB$STATIC_CALLBACKS;\n\n    // ç»‘å®šä¸€ä¸ªåœ¨å¢å¼ºä¸­å£°æ˜çš„ Callback å®ä¾‹\n    private FixedValue CGLIB$CALLBACK_0;\n    // ç»‘å®šä¸€ä¸ªé™æ€çš„å›è°ƒè°ƒåº¦å®ä¾‹\n    private static Object CGLIB$CALLBACK_FILTER;\n\n    static void CGLIB$STATICHOOK1() {\n        CGLIB$THREAD_CALLBACKS = new ThreadLocal();\n    }\n\n    /**\n      * å¯¹ test(String) çš„æ–¹æ³•çš„å¢å¼º\n      */ \n    public final String test(String var1) {\n        // åœ¨æ–¹æ³•å—ä¸­æ‹¿åˆ° Callback å®ä¾‹\n        FixedValue var10000 = this.CGLIB$CALLBACK_0;\n        // ä¸ºç©ºåˆ™å°è¯•è·å–\n        if (this.CGLIB$CALLBACK_0 == null) {\n            CGLIB$BIND_CALLBACKS(this);\n            var10000 = this.CGLIB$CALLBACK_0;\n        }\n\n        // è§¦å‘å›è°ƒå®ä¾‹çš„æ–¹æ³•è·å¾—è¿”å›å€¼\n        return (String)var10000.loadObject();\n    }\n\n    /**\n      * ç”±äºæ­¤æ¬¡å¢å¼ºåªå£°æ˜äº†ä¸€ä¸ª Callback\n      * å› æ­¤æ‰€æœ‰æ–¹æ³•çš„å¢å¼ºéƒ½ç›¸åŒ, éƒ½æ˜¯è°ƒç”¨è¿™ä¸ªå›è°ƒæ–¹æ³•è·å–\n      */\n    public final boolean equals(Object var1) {\n        FixedValue var10000 = this.CGLIB$CALLBACK_0;\n        if (this.CGLIB$CALLBACK_0 == null) {\n            CGLIB$BIND_CALLBACKS(this);\n            var10000 = this.CGLIB$CALLBACK_0;\n        }\n\n        Object var2 = var10000.loadObject();\n        /**\n         * ä½†æ˜¯ï¼Œæ­¤å¤„ä¼šå°è¯•å¼ºåˆ¶è½¬å‹\n         * åŒæ—¶åœ¨æœ€ç»ˆæ‰§è¡Œå¤±è´¥çš„æ—¶å€™ç›´æ¥æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸\n         * æ¯•ç«Ÿä¸Šé¢å¢å¼ºçš„æ—¶å€™è¿”å›å›ºå®šå€¼ \"Hello, cglib!\"\n         */\n        return var2 == null ? false : (Boolean)var2;\n    }\n\n    public final String toString() {\n        FixedValue var10000 = this.CGLIB$CALLBACK_0;\n        if (this.CGLIB$CALLBACK_0 == null) {\n            CGLIB$BIND_CALLBACKS(this);\n            var10000 = this.CGLIB$CALLBACK_0;\n        }\n\n        return (String)var10000.loadObject();\n    }\n\n    public final int hashCode() {\n        FixedValue var10000 = this.CGLIB$CALLBACK_0;\n        if (this.CGLIB$CALLBACK_0 == null) {\n            CGLIB$BIND_CALLBACKS(this);\n            var10000 = this.CGLIB$CALLBACK_0;\n        }\n\n        Object var1 = var10000.loadObject();\n        return var1 == null ? 0 : ((Number)var1).intValue();\n    }\n\n    protected final Object clone() throws CloneNotSupportedException {\n        FixedValue var10000 = this.CGLIB$CALLBACK_0;\n        if (this.CGLIB$CALLBACK_0 == null) {\n            CGLIB$BIND_CALLBACKS(this);\n            var10000 = this.CGLIB$CALLBACK_0;\n        }\n\n        return var10000.loadObject();\n    }\n\n    public SampleClass$$EnhancerByCGLIB$$7cd64b81() {\n        CGLIB$BIND_CALLBACKS(this);\n    }\n\n    public static void CGLIB$SET_THREAD_CALLBACKS(Callback[] var0) {\n        CGLIB$THREAD_CALLBACKS.set(var0);\n    }\n\n    public static void CGLIB$SET_STATIC_CALLBACKS(Callback[] var0) {\n        CGLIB$STATIC_CALLBACKS = var0;\n    }\n\n    private static final void CGLIB$BIND_CALLBACKS(Object var0) {\n        SampleClass$$EnhancerByCGLIB$$7cd64b81 var1 = (SampleClass$$EnhancerByCGLIB$$7cd64b81)var0;\n        if (!var1.CGLIB$BOUND) {\n            var1.CGLIB$BOUND = true;\n            Object var10000 = CGLIB$THREAD_CALLBACKS.get();\n            if (var10000 == null) {\n                var10000 = CGLIB$STATIC_CALLBACKS;\n                if (CGLIB$STATIC_CALLBACKS == null) {\n                    return;\n                }\n            }\n\n            var1.CGLIB$CALLBACK_0 = (FixedValue)((Callback[])var10000)[0];\n        }\n\n    }\n\n    public Object newInstance(Callback[] var1) {\n        CGLIB$SET_THREAD_CALLBACKS(var1);\n        SampleClass$$EnhancerByCGLIB$$7cd64b81 var10000 = new SampleClass$$EnhancerByCGLIB$$7cd64b81();\n        CGLIB$SET_THREAD_CALLBACKS((Callback[])null);\n        return var10000;\n    }\n\n    public Object newInstance(Callback var1) {\n        CGLIB$SET_THREAD_CALLBACKS(new Callback[]{var1});\n        SampleClass$$EnhancerByCGLIB$$7cd64b81 var10000 = new SampleClass$$EnhancerByCGLIB$$7cd64b81();\n        CGLIB$SET_THREAD_CALLBACKS((Callback[])null);\n        return var10000;\n    }\n\n    public Object newInstance(Class[] var1, Object[] var2, Callback[] var3) {\n        CGLIB$SET_THREAD_CALLBACKS(var3);\n        SampleClass$$EnhancerByCGLIB$$7cd64b81 var10000 = new SampleClass$$EnhancerByCGLIB$$7cd64b81;\n        switch(var1.length) {\n        case 0:\n            var10000.\u0026#x3C;init\u003e();\n            CGLIB$SET_THREAD_CALLBACKS((Callback[])null);\n            return var10000;\n        default:\n            throw new IllegalArgumentException(\"Constructor not found\");\n        }\n    }\n\n    public Callback getCallback(int var1) {\n        CGLIB$BIND_CALLBACKS(this);\n        FixedValue var10000;\n        switch(var1) {\n        case 0:\n            var10000 = this.CGLIB$CALLBACK_0;\n            break;\n        default:\n            var10000 = null;\n        }\n\n        return var10000;\n    }\n\n    public void setCallback(int var1, Callback var2) {\n        switch(var1) {\n        case 0:\n            this.CGLIB$CALLBACK_0 = (FixedValue)var2;\n        default:\n        }\n    }\n\n    public Callback[] getCallbacks() {\n        CGLIB$BIND_CALLBACKS(this);\n        return new Callback[]{this.CGLIB$CALLBACK_0};\n    }\n\n    public void setCallbacks(Callback[] var1) {\n        this.CGLIB$CALLBACK_0 = (FixedValue)var1[0];\n    }\n\n    static {\n        CGLIB$STATICHOOK1();\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eä»ä¸Šé¢çš„ç”Ÿæˆç±»å¯ä»¥çœ‹å‡ºæ¥ï¼ŒCGlib æ‰€è¿›è¡Œçš„å¢å¼ºï¼Œæ˜¯åœ¨ä¸ç›´æ¥å¯¹åŸæœ‰çš„æ–¹æ³•ä½“å†…å®¹è¿›è¡Œæ”¹é€ çš„åŸºç¡€ä¸Š(ä¾‹å¦‚ä¸Šé¢çš„ test(String) æ–¹æ³•ï¼Œæ²¡æœ‰ç›´æ¥æ”¹å†™æˆ \u003ccode\u003ereturn \"Hello, cglib!\u003c/code\u003e çš„å½¢å¼)ï¼Œå¯¹æ–¹æ³•æ‰§è¡Œä¹‹å‰å…¥å‚æˆ–è€…æ–¹æ³•æ‰§è¡Œä¹‹åçš„è¿”å›å€¼è¿›è¡Œä¸€å®šçš„å¤„ç†ã€‚\u003c/p\u003e\n\u003cp\u003eä¸»è¦ä½¿ç”¨çš„å½¢å¼å°±æ˜¯å°†å›è°ƒå®ä¾‹ä¸åŸæœ‰æ–¹æ³•è¿›è¡Œç»‘å®šï¼Œå¹¶é€šè¿‡è°ƒç”¨å›è°ƒæ–¹æ³•æ¥å®ç°æ–¹æ³•çš„å¢å¼ºã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003ch2\u003eå‰è¨€\u003c/h2\u003e\n\u003cp\u003eæ­¤åšæ–‡å†™ä½œçš„ç›®çš„: \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e(Core) é€šè¿‡äº†è§£ CGlib Enhancer çš„æ•´ä¸ªè°ƒç”¨é“¾ï¼Œäº†è§£å…¶å¯¹äºå”¯ä¸€ä¾èµ–çš„ ASM åº“çš„è°ƒç”¨æ–¹å¼ã€‚\u003c/li\u003e\n\u003cli\u003eåŸºäº Enhancer å¯¹å·²æœ‰å­—èŠ‚ç è¿›è¡Œå¢å¼ºçš„è¿›ä¸€æ­¥ç†è§£ä¸æŒæ¡ã€‚\u003c/li\u003e\n\u003c/ul\u003e"},{"url":"2018-07-13-How-to-easily-get-CGlib-generated-code","fileName":"2018-07-13-How-to-easily-get-CGlib-generated-code.md","title":"å¦‚ä½•æ–¹ä¾¿åœ°è·å– CGlib ç”Ÿæˆç±»","author":"fangfeng","date":"2018-07-13T00:00:00.000Z","tags":["CGlib","tools"],"content":"\u003ch2\u003eé…ç½®å‚æ•°\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eå‘½ä»¤è¡Œä½¿ç”¨\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåœ¨ java å¯åŠ¨å‘½ä»¤ä¸­æ·»åŠ å‚æ•°é…ç½®é¡¹ \u003ccode\u003e-Dcglib.debugLocation=\u0026#x3C;Custom Path\u003e\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eç¼–ç å®ç°\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåœ¨æ‰§è¡Œ CGlib è·å–æ–°ç”Ÿæˆç±»ä¹‹å‰ï¼Œè°ƒç”¨ \u003ccode\u003eSystem.setProperty(\"cglib.debugLocation\", \u0026#x3C;Custom Path\u003e)\u003c/code\u003e\u003c/p\u003e\n\u003ch2\u003eå¦‚ä½•æ¸¸åˆƒæœ‰ä½™åœ° Debug æºæ‚ CGlib ç”Ÿæˆç±»çš„è°ƒç”¨é“¾\u003c/h2\u003e\n\u003cp\u003eç»å¸¸ä¼šé‡åˆ°ï¼Œé¡¹ç›®ä¸­ä¸ç»æ„é—´å°±é‡åˆ°äº† CGlib ä»£ç†ï¼Œç„¶åå¯¹è°ƒç”¨é“¾çš„ Debug å°±å¼€å§‹å‡ºç°æ–­å±‚ã€‚ç»§è€Œï¼Œå¯¹å¯¹è±¡æˆ–å®ä¾‹å˜é‡çš„è·Ÿè¸ªå°±æ˜¾å¾—ä¸€å¤´é›¾æ°´ã€‚\u003c/p\u003e\n\u003cp\u003eç‰¹åˆ«æ˜¯åœ¨ä¸äº†è§£ç”Ÿæˆç±»åˆ°åº•æ˜¯å¢å¼ºäº†é‚£äº›å†…å®¹çš„æ—¶å€™ï¼Œç”šè‡³å¯èƒ½è¿è°ƒç”¨é“¾éƒ½è·Ÿè¸ªä¸ä¸‹å»äº† T_T ã€‚\u003c/p\u003e\n\u003cp\u003eé€šè¿‡ \u003cstrong\u003eé…ç½®å‚æ•°\u003c/strong\u003e ä¸€èŠ‚çš„å†…å®¹ï¼Œä½ å°±å¯ä»¥åœ¨ä½ ç†æƒ³çš„ç›®å½• \u003ccode\u003e\u0026#x3C;Custom Path\u003e\u003c/code\u003e ä¸‹çœ‹åˆ°\u003cstrong\u003eæ‰€è°“é»‘ç›’\u003c/strong\u003eä¸­ç”Ÿæˆç±»çš„å®Œæˆå†…å®¹äº†ã€‚\u003c/p\u003e\n\u003cp\u003eä¸‹é¢çš„å†…å®¹ï¼Œå°†ç®€å•åœ°ä»‹ç»å¦‚ä½•é…åˆ CGlib ç”Ÿæˆç±»çš„å†…å®¹å®ç°: ä¿è¯ Debug çš„æ¯ä¸€æ­¥éª¤å¯è§; ä¿è¯ Debug çš„è¿‡ç¨‹ä¸ä¼šå‡ºç°\u003cem\u003eé»‘ç›’\u003c/em\u003eã€‚\u003c/p\u003e\n\u003ch3\u003eç¡®å®š \u003ccode\u003e\u0026#x3C;Custom Path\u003e\u003c/code\u003e ä¸‹å“ªä¸ªæ–‡ä»¶æ˜¯åŸæœ‰ Java ç±»çš„ç”Ÿæˆç±»\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-java\"\u003epublic String getClassName(String prefix, String source, Object key, Predicate names) {\n    if (prefix == null) {\n        prefix = \"net.sf.cglib.empty.Object\";\n    } else if (prefix.startsWith(\"java\")) {\n        prefix = \"$\" + prefix;\n    }\n    String base =\n        prefix + \"$$\" +\n        source.substring(source.lastIndexOf('.') + 1) +\n        getTag() + \"$$\" +\n        Integer.toHexString(STRESS_HASH_CODE ? 0 : key.hashCode());\n    String attempt = base;\n    int index = 2;\n    while (names.evaluate(attempt))\n        attempt = base + \"_\" + index++;\n    return attempt;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCGlib é»˜è®¤çš„ç±»åç”Ÿæˆç­–ç•¥ä¸‹ï¼Œç”Ÿæˆç±»çš„å…¨é™å®šåå°†ç»“åˆåŸæ–‡ä»¶çš„å…¨é™å®šåå†³å®šã€‚\u003c/p\u003e\n\u003cp\u003eé€šå¸¸å‘½åå¦‚ä¸‹: \u003ccode\u003e\u0026#x3C;åŸ Java ç±»å…¨é™å®šå\u003e$$\u0026#x3C;ç±»ä¼¼ EnhancerByCGlib\u003e$$\u0026#x3C;ç”Ÿæˆç±»æ ¸å¿ƒå†…å®¹çš„ hash å€¼\u003e_\u0026#x3C;index[å¯èƒ½å­˜åœ¨]\u003e\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eä¾‹å¦‚: åŸæœ‰ Java ç±»å…¨é™å®šåä¸º me.fangfeng.Test ï¼Œåˆ™ç”Ÿæˆç±»åå¯èƒ½ä¸º \u003ccode\u003eme.fangfeng.Test$$EnhancerByCGlib$$ab1203aa\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eå½“ç„¶ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¼šå­˜åœ¨ä¸€ä¸ªç±»åå½¢å¦‚ \u003ccode\u003eme.fangfeng.Test$$FastClassBySpring$$...\u003c/code\u003e çš„ç±»ï¼Œè¿™æ˜¯ä½œä¸ºç”Ÿæˆç±» \u003ccode\u003eme.fangfeng.Test$$EnhancerByCGlib$$ab1203aa\u003c/code\u003e çš„è¾…åŠ©ç±»æ¥ä½¿ç”¨ã€‚\u003c/p\u003e\n\u003ch3\u003eç®€å•äº†è§£ç”Ÿæˆç±»ä¸‹çš„è°ƒç”¨å…³ç³»\u003c/h3\u003e\n\u003cp\u003eJava ä»£ç è§¦å‘è¢«å¢å¼ºçš„ç±»ï¼Œå°†é¦–å…ˆè°ƒç”¨ç”Ÿæˆç±»ã€‚ä½†æ˜¯ï¼Œè¿™æ˜¯æ²¡åŠæ³•è¿›è¡Œ Debug çš„ï¼Œå› ä¸ºè¿™ä¸ªç”Ÿæˆç±»çš„å­—èŠ‚ç ç¼ºå°‘ SourceFile å±æ€§ï¼ŒåŒæ—¶ç¼ºå°‘ LineNumberTable å±æ€§ã€‚\u003c/p\u003e\n\u003cp\u003eä½†æ˜¯ï¼Œè¿™å¹¶ä¸å½±å“å¯¹è°ƒç”¨é“¾çš„è·Ÿè¸ªã€‚\u003c/p\u003e\n\u003cp\u003eCGlib çš„å¢å¼ºï¼Œæ‰€æœ‰çš„å¢å¼ºé€»è¾‘éƒ½æ˜¯ä»¥ Callback å®ç°ç±»çš„å½¢å¼æ¥æä¾›çš„ã€‚åŒæ—¶åœ¨ CGlib ç”Ÿæˆç±»ä¸­ä¹Ÿæœ‰ Callback çš„å®ä¾‹å˜é‡æ¥æŒæœ‰è¿™äº›æ³¨å…¥çš„ Callback ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eåŸæœ‰ Java ç±»\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws3.sinaimg.cn/large/006tKfTcgy1ft8e7kr7qvj30sc0j0wh4.jpg\" alt=\"LogonService.java\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå¯¹åº”çš„ç”Ÿæˆç±»\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws1.sinaimg.cn/large/006tKfTcgy1ft8e9ww4hqj31hg0oojzv.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws1.sinaimg.cn/large/006tKfTcgy1ft8eanb6c9j31j00lgn1e.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eè·Ÿè¸ª LogonService.addLogon(String var1) æ¼”ç¤º\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå½“å‰ LogonService çš„ç”Ÿæˆç±»å…¨é™å®šåä¸ºme.fangfeng.transactionBugs.LogonService\u003cspan class=\"inlineMath\"\u003e\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003eE\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003eh\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003er\u003c/mi\u003e\u003cmi\u003eB\u003c/mi\u003e\u003cmi\u003ey\u003c/mi\u003e\u003cmi\u003eS\u003c/mi\u003e\u003cmi\u003ep\u003c/mi\u003e\u003cmi\u003er\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003eg\u003c/mi\u003e\u003cmi\u003eC\u003c/mi\u003e\u003cmi\u003eG\u003c/mi\u003e\u003cmi\u003eL\u003c/mi\u003e\u003cmi\u003eI\u003c/mi\u003e\u003cmi\u003eB\u003c/mi\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eEnhancerBySpringCGLIB\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.05764em;\"\u003eE\u003c/span\u003e\u003cspan class=\"mord mathdefault\"\u003en\u003c/span\u003e\u003cspan class=\"mord mathdefault\"\u003eh\u003c/span\u003e\u003cspan class=\"mord mathdefault\"\u003ea\u003c/span\u003e\u003cspan class=\"mord mathdefault\"\u003en\u003c/span\u003e\u003cspan class=\"mord mathdefault\"\u003ec\u003c/span\u003e\u003cspan class=\"mord mathdefault\"\u003ee\u003c/span\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.02778em;\"\u003er\u003c/span\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.05017em;\"\u003eB\u003c/span\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.03588em;\"\u003ey\u003c/span\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.05764em;\"\u003eS\u003c/span\u003e\u003cspan class=\"mord mathdefault\"\u003ep\u003c/span\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.02778em;\"\u003er\u003c/span\u003e\u003cspan class=\"mord mathdefault\"\u003ei\u003c/span\u003e\u003cspan class=\"mord mathdefault\"\u003en\u003c/span\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.03588em;\"\u003eg\u003c/span\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.07153em;\"\u003eC\u003c/span\u003e\u003cspan class=\"mord mathdefault\"\u003eG\u003c/span\u003e\u003cspan class=\"mord mathdefault\"\u003eL\u003c/span\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.07847em;\"\u003eI\u003c/span\u003e\u003cspan class=\"mord mathdefault\" style=\"margin-right:0.05017em;\"\u003eB\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003ebfc1dc3.class; ä»¥ä¸‹ç®€ç§°ä¸º LogonSerivce$$bfc1dc3 \u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eé¦–å…ˆï¼Œé…ç½® \u003ccode\u003ecglib.debugLocation\u003c/code\u003e å‚æ•°ï¼Œå€¼ = é¡¹ç›®ç”Ÿæˆçš„ .class è·¯å¾„\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eæ— æ–­ç‚¹ç›´æ¥è¿è¡Œä¸€æ¬¡éœ€è¦å¤„ç†çš„é€»è¾‘\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eæ‰¾åˆ° LogonSerive$$bfc1dc3.class, éšæ„æ‰“ä¸Šä¸€ä¸ªçœ‹ä¼¼æœ‰æ•ˆçš„æ–­ç‚¹\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eåœ¨å„å¤„æ‰“ä¸Šå¿…è¦çš„æ–­ç‚¹ï¼Œå¼€å§‹è¿›è¡ŒçœŸæ­£çš„è°ƒè¯•å·¥ä½œ\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eä»£ç æ‰§è¡Œåˆ° \u003ccode\u003eLogonService$$bfc1dc3.class\u003c/code\u003e, è™½ç„¶æ²¡æœ‰çœŸæ­£è¿›å…¥æ–­ç‚¹ä½ç½®, ä½†æ˜¯å¯ä»¥çœ‹åˆ°è¿™ä¸ª \u003ccode\u003eLogonService$$bfc1dc3\u003c/code\u003e å®ä¾‹çš„å®ä¾‹å˜é‡ä¿¡æ¯\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://ws3.sinaimg.cn/large/006tKfTcgy1ft8eq1be61j319w0bwtde.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws1.sinaimg.cn/large/006tKfTcgy1ft8egtg1naj31ji0fmgp2.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eæ¯”ç…§ç”Ÿæˆç±»ä»£ç ä¸­ addLogon(String var1) æ–¹æ³•ä½“çš„å†…å®¹ä»¥åŠå±•ç¤ºçš„å®ä¾‹å˜é‡ä¿¡æ¯ã€‚å¯ä»¥çœ‹åˆ°ç”Ÿæˆç±»è°ƒç”¨çš„ Callback å®ä¾‹æ˜¯ \u003ccode\u003eCGLIB$CALLBACK_0\u003c/code\u003e\nç±»å‹æ˜¯ CglibAopProxy çš„é™æ€å†…éƒ¨ç§æœ‰ç±» DynamicAdvisedInterceptor ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://ws1.sinaimg.cn/large/006tKfTcgy1ft8eu91oscj31gq0ayju5.jpg\"\u003e\u003c/p\u003e\n\u003cp\u003eåœ¨ intercept(...) ä¸Šæ‰“ä¸ªæ–­ç‚¹ï¼Œè·³è¿‡ç”Ÿæˆç±» addLogon(String var1) æ–¹æ³•çš„ä¸‹ä¸€ä¸ªè°ƒç”¨æ–¹æ³•å°±æ˜¯ intercept(...) \u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eè€Œä¸”äº‹å®ä¸Šï¼ŒCGlib ç”Ÿæˆç±»çš„å†…å®¹åŸºæœ¬ä¹Ÿå°±æ˜¯å¯¹è°ƒç”¨æ–¹æ³•è¿›è¡Œçš„ä¸€ç§è½¬å‘\u003c/strong\u003e\u003c/p\u003e\n\u003col start=\"6\"\u003e\n\u003cli\u003eç»§ç»­ Debug ï¼Œå¯¹äºç”Ÿæˆç±»çš„å†…å®¹ï¼Œäººè‚‰äº†è§£å¹¶å®šä½åˆ°è§¦å‘çš„ Callback å®ä¾‹æˆ–è€… super.Xxx() æ–¹æ³•ã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"language-plain\"\u003e  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n\u003c/code\u003e\u003c/pre\u003e","digest":"\u003ch2\u003eé…ç½®å‚æ•°\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eå‘½ä»¤è¡Œä½¿ç”¨\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåœ¨ java å¯åŠ¨å‘½ä»¤ä¸­æ·»åŠ å‚æ•°é…ç½®é¡¹ \u003ccode\u003e-Dcglib.debugLocation=\u0026#x3C;Custom Path\u003e\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eç¼–ç å®ç°\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåœ¨æ‰§è¡Œ CGlib è·å–æ–°ç”Ÿæˆç±»ä¹‹å‰ï¼Œè°ƒç”¨ \u003ccode\u003eSystem.setProperty(\"cglib.debugLocation\", \u0026#x3C;Custom Path\u003e)\u003c/code\u003e\u003c/p\u003e"}],"items":32,"pages":4,"currentPage":0},"buildId":"fE8MAaKO9Spaap-vhmcxA","dynamicBuildId":false,"assetPrefix":"https://www.ffutop.com/blog","nextExport":true}</script><script async="" id="__NEXT_PAGE__/" src="https://www.ffutop.com/blog/_next/static/fE8MAaKO9Spaap-vhmcxA/pages/index.js"></script><script async="" id="__NEXT_PAGE__/_app" src="https://www.ffutop.com/blog/_next/static/fE8MAaKO9Spaap-vhmcxA/pages/_app.js"></script><script src="https://www.ffutop.com/blog/_next/static/runtime/webpack-8ed9452df514b4d17d80.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/chunks/commons.ca07934498d0c5523bf5.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/chunks/styles.b54d8442e6b63c30cad4.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/runtime/main-3daabeb1dde7624c7fe0.js" async=""></script></body></html>