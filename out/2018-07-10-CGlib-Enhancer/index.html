<!DOCTYPE html><html><head><meta charSet="utf-8" class="next-head"/><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" class="next-head"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/xx4WXnl7odya2QE7dUtyW/pages/post.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/xx4WXnl7odya2QE7dUtyW/pages/_app.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/runtime/webpack-8ed9452df514b4d17d80.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/chunks/commons.966200943f7869d2249d.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/chunks/styles.2d2aeb3a0a1eb931bc6e.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/runtime/main-3daabeb1dde7624c7fe0.js" as="script"/><link rel="stylesheet" href="https://www.ffutop.com/blog/_next/static/css/commons.a70990b9.chunk.css"/><link rel="stylesheet" href="https://www.ffutop.com/blog/_next/static/css/styles.196d8b6b.chunk.css"/></head><body><div id="__next"><header><h1 class="title">ffutop</h1><div><a href="/blog/blog/">åšå®¢</a><a href="/blog/archives/">å½’æ¡£</a><a href="/blog/tags/">æ ‡ç­¾</a><a href="/blog/about/">å…³äº</a></div></header><div><main class="main"><div><h2>å‰è¨€</h2>
<p>æ­¤åšæ–‡å†™ä½œçš„ç›®çš„:</p>
<ul>
<li>(Core) é€šè¿‡äº†è§£ CGlib Enhancer çš„æ•´ä¸ªè°ƒç”¨é“¾ï¼Œäº†è§£å…¶å¯¹äºå”¯ä¸€ä¾èµ–çš„ ASM åº“çš„è°ƒç”¨æ–¹å¼ã€‚</li>
<li>åŸºäº Enhancer å¯¹å·²æœ‰å­—èŠ‚ç è¿›è¡Œå¢å¼ºçš„è¿›ä¸€æ­¥ç†è§£ä¸æŒæ¡ã€‚</li>
</ul>
<p>&lt;!-- more --&gt;</p>
<h2>Enhancer</h2>
<p>ä»è¿™ç¯‡ä¸æ˜¯å®˜æ–¹ä½†æ›´èƒœäºå®˜æ–¹æ–‡æ¡£çš„ <a href="http://mydailyjava.blogspot.com/2013/11/cglib-missing-manual.html">CGlib Guide</a> æ¥çœ‹ï¼Œå®ƒé¦–å…ˆæåˆ°çš„ç¬¬ä¸€ä¸ªç±»å°±æ˜¯ Enhancerã€‚
å…¶è¢«ç”¨äºåˆ›å»º Java ä»£ç†ç±»ï¼Œç›¸è¾ƒäº Java æ ‡å‡†åº“çš„ Proxy ç±»ï¼Œå®ƒ<strong>ç‰¹åˆ«åœ°</strong>ï¼Œèƒ½å¤Ÿæ”¯æŒé‚£äº›æ²¡æœ‰å®ç°æ¥å£çš„ç±»çš„ä»£ç†å·¥ä½œã€‚</p>
<h3>Enhancer ç®€å•ç¤ºä¾‹å±•ç¤º</h3>
<p>é’ˆå¯¹ç°æœ‰çš„ SampleClass ç±»</p>
<pre><code class="hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SampleClass</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span><span class="hljs-params">(String input)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello World!"</span>;
    }
}</code></pre><p>ä½¿ç”¨ CGlib çš„ Enhancer å¯¹ SampleClass è¿›è¡Œå¢å¼ºï¼Œä¸‹åˆ—æ“ä½œçš„ç›®çš„åœ¨äºå°† test(String) æ–¹æ³•çš„è¿”å›å€¼æ”¹å†™æˆ &quot;Hello cglib!&quot;</p>
<pre><code class="hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFixedValue</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// new ä¸€ä¸ª Enhancer å®ä¾‹</span>
    Enhancer enhancer = <span class="hljs-keyword">new</span> Enhancer();
    <span class="hljs-comment">// å£°æ˜ä½¿ç”¨çš„çˆ¶ç±»æ˜¯ SampleClass</span>
    enhancer.setSuperclass(SampleClass.class);
    <span class="hljs-comment">// è®¾ç½®å›è°ƒæ–¹æ³• - å›è°ƒæ–¹æ³•å®ç°ä¸º FixedValue (å›ºå®šå€¼) .</span>
    enhancer.setCallback(<span class="hljs-keyword">new</span> FixedValue() {
        <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">loadObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello cglib!"</span>;
        }
    });
    <span class="hljs-comment">// åˆ›å»º SampleClass çš„ä»£ç†å­ç±»å®ä¾‹</span>
    SampleClass proxy = (SampleClass) enhancer.create();
    Assert.assertEquals(<span class="hljs-string">"Hello cglib!"</span>, proxy.test(<span class="hljs-keyword">null</span>));
}</code></pre><p>ç®€å•æµ‹è¯•ä¸Šè¿°ä»£ç ï¼Œå¯ä»¥äº†è§£åˆ°ç¡®å®ï¼Œä»£ç†ç±»çš„ test(String) æ–¹æ³•çš„è¿”å›å€¼è¢«æ”¹å†™äº†ã€‚
é‚£ä¹ˆï¼Œç©¶ç«Ÿè¿™ç§æ“ä½œæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿä¸‹é¢ğŸ‘‡å°†è¿›è¡Œå…·ä½“çš„æ¢ç©¶ã€‚</p>
<h2>è°ƒç”¨é“¾è·Ÿè¸ª</h2>
<h3>é«˜åº¦æŠ½è±¡çš„æ—¶åºå›¾</h3>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1ft4ifuo997j31jh0st42t.jpg" alt="Enhancer è°ƒç”¨é“¾ æ—¶åºå›¾"></p>
<p><em>ä¸‹åˆ—å†…å®¹å°†æ ¹æ®æ—¶åºå›¾è¿›è¡Œç»„ç»‡ï¼Œæ ¹æ®è°ƒç”¨ç¼–å·(1,2,3...)è¿›è¡Œå±•å¼€</em></p>
<h3>Seq 1.</h3>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>{
    classOnly = <span class="hljs-keyword">false</span>;
    argumentTypes = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">return</span> createHelper();
}

<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">create</span><span class="hljs-params">(Class[] argumentTypes, Object[] arguments)</span> </span>{
    classOnly = <span class="hljs-keyword">false</span>;
    <span class="hljs-keyword">if</span> (argumentTypes == <span class="hljs-keyword">null</span> || arguments == <span class="hljs-keyword">null</span> || argumentTypes.length != arguments.length) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Arguments must be non-null and of equal length"</span>);
    }
    <span class="hljs-keyword">this</span>.argumentTypes = argumentTypes;
    <span class="hljs-keyword">this</span>.arguments = arguments;
    <span class="hljs-keyword">return</span> createHelper();
}</code></pre><p>ä¸Šè¿°ä¸¤ä¸ª <code>create(...)</code> æ–¹æ³•ã€‚ç»“åˆä¸Šä¸€èŠ‚çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ° <code>create()</code> å¯¹åº”çš„<strong>æ— å‚æ„é€ </strong>ã€‚
å­˜åœ¨æ— å‚æ„é€ ï¼Œé‚£ä¹ˆ<strong>æœ‰å‚çš„æ„é€ æ–¹æ³•</strong>æ˜¾ç„¶ä¹Ÿæ˜¯åº”è¯¥è¢«æ”¯æŒidã€‚<code>create(Class[], Object[])</code> æ­£æ˜¯ä¸ºäº†è¿™ä¸ªç›®æ ‡è€Œå­˜åœ¨ã€‚é€šè¿‡æä¾›å‚æ•°ç±»å‹æ•°ç»„å’Œå‚æ•°å®ä¾‹æ•°ç»„ï¼Œå¯ä»¥å”¯ä¸€åœ°å®šä½åŠè°ƒç”¨ä»£ç†ç±»çš„ç‰¹å®šæ„é€ æ–¹æ³•ã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯å°† Enhancer ä½œä¸ºä¸€ä¸ªæ•°æ®å†…å®¹çš„æŒæœ‰è€…ï¼Œé‡ç½®äº†æ–°ä»£ç†ç±»å°†ä½¿ç”¨çš„æ„é€ å‡½æ•°å‚æ•°å†…å®¹ï¼Œä¹‹åå°±ç›´æ¥è°ƒç”¨äº† <code>createHelper()</code> ã€‚</p>
<h3>Seq 2.</h3>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> Object <span class="hljs-title">createHelper</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// å¯¹é¢„å£°æ˜çš„å›è°ƒæ–¹æ³•è¿›è¡ŒéªŒè¯ï¼Œè¦æ±‚ [å¤šä¸ªå›è°ƒå°±å¿…é¡»å­˜åœ¨ CallbackFilter ä½œä¸ºè°ƒåº¦å™¨]</span>
    preValidate();
    <span class="hljs-comment">// æ„å»ºä¸€ä¸ªå¯¹è¿™ç±»å¢å¼ºæ“ä½œå”¯ä¸€å®šä½çš„ key</span>
    Object key = KEY_FACTORY.newInstance((superclass != <span class="hljs-keyword">null</span>) ? superclass.getName() : <span class="hljs-keyword">null</span>,
            ReflectUtils.getNames(interfaces),
            filter == ALL_ZERO ? <span class="hljs-keyword">null</span> : <span class="hljs-keyword">new</span> WeakCacheKey&lt;CallbackFilter&gt;(filter),
            callbackTypes,
            useFactory,
            interceptDuringConstruction,
            serialVersionUID);
    <span class="hljs-keyword">this</span>.currentKey = key;
    <span class="hljs-comment">// è°ƒç”¨çˆ¶ç±»é€šè¿‡çš„ create(...) æ–¹æ³•</span>
    Object result = <span class="hljs-keyword">super</span>.create(key);
    <span class="hljs-keyword">return</span> result;
}</code></pre><h3>Seq 3.</h3>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">create</span><span class="hljs-params">(Object key)</span> </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// è·å–ç”¨äº åŠ è½½ ç”Ÿæˆç±» çš„ ClassLoader</span>
        ClassLoader loader = getClassLoader();
        <span class="hljs-comment">// ä»ç¼“å­˜ä¸­åŠ è½½ è¿™ä¸ª ClassLoader è¿‡å»åŠ è½½çš„ç›¸å…³æ•°æ®</span>
        Map&lt;ClassLoader, ClassLoaderData&gt; cache = CACHE;
        ClassLoaderData data = cache.get(loader);
        <span class="hljs-comment">// å¦‚æœåœ¨ ç¼“å­˜ ä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™åˆå§‹åŒ–æ„é€ å…³äºè¿™ä¸ª ClassLoader çš„æ•°æ®å®ä¾‹</span>
        <span class="hljs-keyword">if</span> (data == <span class="hljs-keyword">null</span>) {
            <span class="hljs-comment">// åŒæ­¥</span>
            <span class="hljs-keyword">synchronized</span> (AbstractClassGenerator.class) {
                <span class="hljs-comment">// è¿›å…¥åŒæ­¥å—åçš„ å†æ¬¡ç¡®è®¤ï¼Œé¿å…é‡å¤åˆå§‹åŒ–æ„å»º</span>
                cache = CACHE;
                data = cache.get(loader);
                <span class="hljs-keyword">if</span> (data == <span class="hljs-keyword">null</span>) {
                    <span class="hljs-comment">// æ„å»ºæ–°çš„ ç¼“å­˜ï¼Œæ‹·è´åŸæœ‰çš„ç¼“å­˜é›†çš„å†…å®¹</span>
                    Map&lt;ClassLoader, ClassLoaderData&gt; newCache = <span class="hljs-keyword">new</span> WeakHashMap&lt;ClassLoader, ClassLoaderData&gt;(cache);
                    <span class="hljs-comment">// åˆå§‹åŒ– ClassLoaderData ï¼ŒçœŸæ­£çš„æ„é€ æ“ä½œ</span>
                    data = <span class="hljs-keyword">new</span> ClassLoaderData(loader);
                    <span class="hljs-comment">// æ·»åŠ åˆ°ç¼“å­˜ä¸­</span>
                    newCache.put(loader, data);
                    CACHE = newCache;
                }
            }
        }
        <span class="hljs-keyword">this</span>.key = key;
        Object obj = data.get(<span class="hljs-keyword">this</span>, getUseCache());
        <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> Class) {
            <span class="hljs-comment">// åˆæ¬¡å®ä¾‹åŒ–æ“ä½œï¼Œå°±æ˜¯ Class åˆ©ç”¨åå°„æ¥è¿›è¡Œå®ä¾‹åŒ–</span>
            <span class="hljs-keyword">return</span> firstInstance((Class) obj);
        }
        <span class="hljs-comment">// éåˆæ¬¡å®ä¾‹åŒ–ï¼Œåˆ™æ˜¯ä» ClassLoaderData ä¸­å¾—åˆ°çš„ä¹‹å‰ç»´æŠ¤çš„å†…å®¹</span>
        <span class="hljs-keyword">return</span> nextInstance(obj);
    } <span class="hljs-keyword">catch</span> (RuntimeException e) {
        <span class="hljs-keyword">throw</span> e;
    } <span class="hljs-keyword">catch</span> (Error e) {
        <span class="hljs-keyword">throw</span> e;
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CodeGenerationException(e);
    }
}</code></pre><p>è¿™éƒ¨åˆ†å†…å®¹æ¯”è¾ƒå¤šï¼Œä¸”æ˜¯è°ƒç”¨é“¾æ¯”è¾ƒé‡è¦çš„ä¸€ç¯ã€‚<strong>Seq 4.</strong> å’Œ <strong>Seq 5.</strong> å°†ä½œä¸ºå…¶å­å†…å®¹è¿›è¡Œè°ƒç”¨ï¼Œä½†ä¸ºäº†æœ¬åšæ–‡çš„ç»“æ„å®Œæ•´ï¼Œ <em>Seq 4. &amp; Seq5.</em> çš„æ ‡é¢˜ä¸ <em>Seq 3.</em> æ ‡é¢˜åŒçº§</p>
<h3>Seq 4.</h3>
<p>é¦–å…ˆåº”è¯¥è®¤è¯†åˆ°ï¼Œæ¯ä¸ªè¢«åŠ è½½çš„ Class ï¼Œåœ¨ <code>equal</code> çš„åˆ¤æ–­è¿‡ç¨‹ä¸­ï¼Œä¾æ®çš„æ˜¯åŒä¸€ä¸ª ClassLoader åŠ è½½çš„åŒä¸€ Class æ‰è¢«è®¤ä¸ºæ˜¯ç›¸åŒçš„ï¼Œå¦åˆ™å³ä½¿ Class æ˜¯åŒä¸€ä¸ªï¼Œä½†ä»ä¼šè¢«è®¤ä¸ºæ˜¯ä¸åŒçš„(ç”±ä¸åŒçš„ ClassLoader åŠ è½½)ã€‚</p>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> ClassLoader <span class="hljs-title">getClassLoader</span><span class="hljs-params">()</span> </span>{
    ClassLoader t = classLoader;
    <span class="hljs-keyword">if</span> (t == <span class="hljs-keyword">null</span>) {
        t = getDefaultClassLoader();
    }
    <span class="hljs-keyword">if</span> (t == <span class="hljs-keyword">null</span>) {
        t = getClass().getClassLoader();
    }
    <span class="hljs-keyword">if</span> (t == <span class="hljs-keyword">null</span>) {
        t = Thread.currentThread().getContextClassLoader();
    }
    <span class="hljs-keyword">if</span> (t == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"Cannot determine classloader"</span>);
    }
    <span class="hljs-keyword">return</span> t;
}</code></pre><p>å› æ­¤ï¼Œåœ¨è¿™éƒ¨åˆ†ä¸­ï¼Œé¦–å…ˆéœ€è¦ç¡®å®šçš„æ˜¯ç”±å“ªä¸ª ClassLoader è¿›è¡ŒåŠ è½½çš„å·¥ä½œã€‚<code>getClassLoader()</code> çš„ç¡®å®šé¡ºåºæ˜¯:</p>
<ol>
<li>å…·ä½“å®ç°ç±»å£°æ˜çš„ <strong>é»˜è®¤ ClassLoader</strong> ä¸ºç¬¬ä¸€ä¼˜å…ˆçº§</li>
<li>åŠ è½½å½“å‰ç±»(è¿™é‡Œæ˜¯ Enhancer) çš„ ClassLoader ä¸ºç¬¬äºŒä¼˜å…ˆçº§</li>
<li><strong>å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡ ClassLoader</strong> ä¸ºç¬¬ä¸‰ä¼˜å…ˆçº§</li>
<li>æŠ›å‡ºå¼‚å¸¸</li>
</ol>
<p>å›åˆ° <strong>Seq 3.</strong> çš„å†…å®¹ï¼Œ
ä¸‹ä¸€æ­¥æ˜¯å¯¹å½“å‰è¿™ä¸ª<strong>AbstractClassGenerator</strong> ç»´æŠ¤çš„ CACHE è¿›è¡Œå¤„ç†ï¼Œå¦‚æœåœ¨ CACHE ä¸­èƒ½å¤Ÿå¾—åˆ°ä»¥ç¡®å®šçš„ ClassLoader ä¸º Key çš„é”®å€¼å¯¹ï¼Œåˆ™ç›´æ¥è·å– ClassLoader å¯¹åº”çš„å€¼ï¼Œå¦åˆ™å°†è¿›è¡Œåˆå§‹åŒ–æ„å»ºä¸€ä¸ªæ–°çš„ ClassLoaderData ä½œä¸ºè¿™ä¸ª ClassLoader çš„å€¼ã€‚</p>
<h3>Seq 5.</h3>
<p>åœ¨æ„å»º ClassLoaderData çš„è¿‡ç¨‹ä¸­ï¼Œæœ€é‡è¦çš„ä¸€æ­¥:</p>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClassLoaderData</span><span class="hljs-params">(ClassLoader classLoader)</span> </span>{
    <span class="hljs-comment">// ClassLoader ä¸å¯ä¸ºç©º</span>
    <span class="hljs-keyword">if</span> (classLoader == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"classLoader == null is not yet supported"</span>);
    }
    <span class="hljs-comment">// æ„å»º ClassLoader çš„å¼±å¼•ç”¨</span>
    <span class="hljs-keyword">this</span>.classLoader = <span class="hljs-keyword">new</span> WeakReference&lt;ClassLoader&gt;(classLoader);
    <span class="hljs-comment">// å†™äº†ä¸ªåç½®è°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºæ‡’åŠ è½½ï¼Œåªæœ‰è°ƒç”¨äº† load.apply(...) æ‰ä¼šæ„å»º ç”Ÿæˆç±»</span>
    Function&lt;AbstractClassGenerator, Object&gt; load =
            <span class="hljs-keyword">new</span> Function&lt;AbstractClassGenerator, Object&gt;() {
                <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">apply</span><span class="hljs-params">(AbstractClassGenerator gen)</span> </span>{
                    Class klass = gen.generate(ClassLoaderData.<span class="hljs-keyword">this</span>);
                    <span class="hljs-keyword">return</span> gen.wrapCachedClass(klass);
                }
            };
    generatedClasses = <span class="hljs-keyword">new</span> LoadingCache&lt;AbstractClassGenerator, Object, Object&gt;(GET_KEY, load);
}</code></pre><p>æ„å»ºäº†ä¸€ä¸ª Function å®ä¾‹ï¼Œè¿™ä¸ª Function ä½œä¸ºå‡½æ•°å¼æ¥å£ï¼Œé¢„å®šä¹‰æ‰§è¡Œçš„å…·ä½“æµç¨‹ï¼Œä½†ç”±ä¸Šä¸‹æ–‡ç¡®å®šå…·ä½“çš„è°ƒç”¨æ—¶åˆ»ã€‚</p>
<h3>Seq 6.</h3>
<p>åœ¨æ­£ç¡®å¾—åˆ°äº† ClassLoader å¯¹åº”çš„ ClassLoaderData ä¹‹åï¼ŒClassLoaderData çš„ <code>get(...)</code> æ–¹æ³•å°†åœ¨ç‰¹å®šçš„ ClassLoader ä¹‹ä¸‹ï¼Œè¿›è¡Œæ›´å…·ä½“çš„åŠ è½½æ–°ç”Ÿæˆç±»çš„å·¥ä½œã€‚
å½“ç„¶ï¼Œè¿™é‡Œçš„å‰ææ˜¯æ–°çš„ç”Ÿæˆç±»çš„å­—èŠ‚ç å·²ç»è¢«æ„å»º:)</p>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(AbstractClassGenerator gen, <span class="hljs-keyword">boolean</span> useCache)</span> </span>{
    <span class="hljs-comment">// æ ‡è®°ä¸ºä¸ä½¿ç”¨ç¼“å­˜ï¼Œç›´æ¥æ„å»º æ–°çš„ç”Ÿæˆç±»</span>
    <span class="hljs-keyword">if</span> (!useCache) {
      <span class="hljs-keyword">return</span> gen.generate(ClassLoaderData.<span class="hljs-keyword">this</span>);
    }
    <span class="hljs-comment">// ä½¿ç”¨ç¼“å†²çš„æƒ…å†µ</span>
    <span class="hljs-keyword">else</span> {
      Object cachedValue = generatedClasses.get(gen);
      <span class="hljs-keyword">return</span> gen.unwrapCachedValue(cachedValue);
    }
}</code></pre><p>å¯ä»¥çœ‹åˆ° <code>gen.generate(ClassLoaderData.this)</code> è¿™æ®µä»£ç åœ¨ <code>get(...)</code> æ–¹æ³•å’Œä¸Šä¸€å°èŠ‚ <code>ClassLoaderData(...)</code> æ„é€ æ–¹æ³•çš„ Function å‡½æ•°å¼å®ä¾‹éƒ½å‡ºç°äº†ã€‚</p>
<p>å®é™…ä¸Šï¼Œè¿™ä¹Ÿæ˜¯è§¦å‘ ClassLoader æ¥åŠ è½½åŠ¨æ€ç”Ÿæˆçš„æ–° Class çš„å”¯ä¸€å…¥å£ã€‚</p>
<p><em>åˆ¤æ–­é€»è¾‘</em> çš„ <code>else</code> å†…å®¹çš„å”¯ä¸€åŒºåˆ«å°±åœ¨äºå…¶æ„å»ºçš„æ˜¯ä¸€ä¸ªåŠ è½½ç¼“å­˜ï¼Œå°†çœŸæ­£è§¦å‘ gen.generate(ClassLoaderData.this) çš„é€»è¾‘å»¶è¿Ÿã€‚(ä¸è¿‡ï¼Œæœ€ç»ˆä¹Ÿè¿˜æ˜¯ä¼šè¿›è¡Œè°ƒç”¨çš„ï¼Œ:) è¿™æ˜¯æ¯‹åº¸ç½®ç–‘çš„)ã€‚</p>
<h3>Seq 7.</h3>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">protected</span> Class <span class="hljs-title">generate</span><span class="hljs-params">(ClassLoaderData data)</span> </span>{
    Class gen;
    Object save = CURRENT.get();
    CURRENT.set(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// æ‹¿åˆ°ç”¨äºåŠ è½½ç”Ÿæˆç±»çš„ ClassLoader</span>
        ClassLoader classLoader = data.getClassLoader();
        <span class="hljs-keyword">if</span> (classLoader == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"ClassLoader is null while trying to define class "</span> +
                    getClassName() + <span class="hljs-string">". It seems that the loader has been expired from a weak reference somehow. "</span> +
                    <span class="hljs-string">"Please file an issue at cglib's issue tracker."</span>);
        }
        <span class="hljs-comment">// æ„å»ºä¸€ä¸ªåˆæ³•çš„ ç”Ÿæˆç±» çš„ç±»å(éé‡å¤)</span>
        <span class="hljs-keyword">synchronized</span> (classLoader) {
          String name = generateClassName(data.getUniqueNamePredicate());
          data.reserveName(name);
          <span class="hljs-keyword">this</span>.setClassName(name);
        }
        <span class="hljs-keyword">if</span> (attemptLoad) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// å°è¯•ç›´æ¥é€šè¿‡ ClassLoader è¿›è¡ŒåŠ è½½</span>
                gen = classLoader.loadClass(getClassName());
                <span class="hljs-keyword">return</span> gen;
            } <span class="hljs-keyword">catch</span> (ClassNotFoundException e) {
                <span class="hljs-comment">// ignore</span>
            }
        }
        <span class="hljs-comment">// ç­–ç•¥ä¸‹çš„ç”Ÿæˆç±»æ„å»ºæ–¹æ³•</span>
        <span class="hljs-keyword">byte</span>[] b = strategy.generate(<span class="hljs-keyword">this</span>);
        <span class="hljs-comment">// é€šè¿‡è§£æå­—èŠ‚ç çš„å½¢å¼è·å– ç”Ÿæˆç±»çš„ className</span>
        String className = ClassNameReader.getClassName(<span class="hljs-keyword">new</span> ClassReader(b));
        ProtectionDomain protectionDomain = getProtectionDomain();
        <span class="hljs-keyword">synchronized</span> (classLoader) { <span class="hljs-comment">// just in case</span>
            <span class="hljs-comment">// åå°„çš„å½¢å¼åŠ è½½ Class ç±»</span>
            <span class="hljs-keyword">if</span> (protectionDomain == <span class="hljs-keyword">null</span>) {
                gen = ReflectUtils.defineClass(className, b, classLoader);
            } <span class="hljs-keyword">else</span> {
                gen = ReflectUtils.defineClass(className, b, classLoader, protectionDomain);
            }
        }
        <span class="hljs-keyword">return</span> gen;
    } <span class="hljs-keyword">catch</span> (RuntimeException e) {
        <span class="hljs-keyword">throw</span> e;
    } <span class="hljs-keyword">catch</span> (Error e) {
        <span class="hljs-keyword">throw</span> e;
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CodeGenerationException(e);
    } <span class="hljs-keyword">finally</span> {
        CURRENT.set(save);
    }
}</code></pre><p>è¿™ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯æ“ä½œå­—èŠ‚ç ï¼ŒåŠ è½½ Class çš„æ ¸å¿ƒè°ƒåº¦æ–¹æ³•ã€‚</p>
<p>å¯ä»¥çœ‹åˆ° <code>generateClassName(...)</code> æ–¹æ³•å°†æ„å»ºä¸€ä¸ªå½“å‰ ClassLoader ä¸‹å”¯ä¸€, ä¸é‡å¤çš„æ–°çš„ç±»åã€‚</p>
<p><code>strategy.generate(this)</code> å°†é€šè¿‡ç‰¹å®šç­–ç•¥å®ç°çš„å½¢å¼ç”Ÿæˆæ–°çš„å­—èŠ‚ç </p>
<p><code>ReflectUtils.defineClass(className, b, classLoader)</code> å°†ä½¿ç”¨åå°„ä½¿å¾— ClassLoader æ¥åŠ è½½è¿™ä¸ªæ–°çš„ç”Ÿæˆç±»ã€‚</p>
<h3>Seq 8.</h3>
<p>ç”Ÿæˆæ–°çš„ä¸é‡å¤ç±»åè¿™éƒ¨åˆ†ä¸åšè¿‡å¤šé™ˆè¿°ï¼Œå¯ä»¥ç®€å•è¿›è¡Œäº†è§£ï¼Œå¹¶ç†Ÿæ‚‰ CGlib é»˜è®¤çš„æ–°ç±»åçš„å‘½åè§„åˆ™</p>
<pre><code class="hljs"><span class="hljs-comment">// DefaultNamePolicy</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getClassName</span><span class="hljs-params">(String prefix, String source, Object key, Predicate names)</span> </span>{
    <span class="hljs-keyword">if</span> (prefix == <span class="hljs-keyword">null</span>) {
        prefix = <span class="hljs-string">"net.sf.cglib.empty.Object"</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prefix.startsWith(<span class="hljs-string">"java"</span>)) {
        prefix = <span class="hljs-string">"$"</span> + prefix;
    }
    String base =
        prefix + <span class="hljs-string">"$$"</span> +
        source.substring(source.lastIndexOf(<span class="hljs-string">'.'</span>) + <span class="hljs-number">1</span>) +
        getTag() + <span class="hljs-string">"$$"</span> +
        Integer.toHexString(STRESS_HASH_CODE ? <span class="hljs-number">0</span> : key.hashCode());
    String attempt = base;
    <span class="hljs-keyword">int</span> index = <span class="hljs-number">2</span>;
    <span class="hljs-keyword">while</span> (names.evaluate(attempt))
        attempt = base + <span class="hljs-string">"_"</span> + index++;
    <span class="hljs-keyword">return</span> attempt;
}</code></pre><h3>Seq 9.</h3>
<pre><code class="hljs"><span class="hljs-comment">// ä¸‹åˆ—æ˜¯ DefaultGeneratorStrategy çš„å®ç°</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] generate(ClassGenerator cg) <span class="hljs-keyword">throws</span> Exception {
    DebuggingClassWriter cw = getClassVisitor();
    transform(cg).generateClass(cw);
    <span class="hljs-keyword">return</span> transform(cw.toByteArray());
}</code></pre><h3>Seq 10.</h3>
<p>è°ƒç”¨ <code>generateClass(ClassVisitor)</code> å°†è·å¾—åˆ°æ–°ç±»çš„å­—èŠ‚ç ã€‚</p>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">generateClass</span><span class="hljs-params">(ClassVisitor v)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-comment">// ç¡®å®šç”Ÿæˆç±»çš„ çˆ¶ç±»</span>
    Class sc = (superclass == <span class="hljs-keyword">null</span>) ? Object.class : superclass;

    <span class="hljs-comment">// çˆ¶ç±»æ ‡è¯†ç¬¦ä¸å¯ä»¥ä¸º final</span>
    <span class="hljs-keyword">if</span> (TypeUtils.isFinal(sc.getModifiers()))
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Cannot subclass final class "</span> + sc.getName());
    <span class="hljs-comment">// è·å–çˆ¶ç±»ç›´æ¥å£°æ˜çš„æ„é€ æ–¹æ³•</span>
    List constructors = <span class="hljs-keyword">new</span> ArrayList(Arrays.asList(sc.getDeclaredConstructors()));
    filterConstructors(sc, constructors);

    <span class="hljs-comment">// Order is very important: must add superclass, then</span>
    <span class="hljs-comment">// its superclass chain, then each interface and</span>
    <span class="hljs-comment">// its superinterfaces.</span>
    List actualMethods = <span class="hljs-keyword">new</span> ArrayList();
    List interfaceMethods = <span class="hljs-keyword">new</span> ArrayList();
    <span class="hljs-keyword">final</span> Set forcePublic = <span class="hljs-keyword">new</span> HashSet();
    <span class="hljs-comment">// ä»çˆ¶ç±»ä¸­æå–å„ç§ä¿¡æ¯</span>
    getMethods(sc, interfaces, actualMethods, interfaceMethods, forcePublic);

    List methods = CollectionUtils.transform(actualMethods, <span class="hljs-keyword">new</span> Transformer() {
        <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object value)</span> </span>{
            Method method = (Method)value;
            <span class="hljs-keyword">int</span> modifiers = Constants.ACC_FINAL
                | (method.getModifiers()
                   &amp; ~Constants.ACC_ABSTRACT
                   &amp; ~Constants.ACC_NATIVE
                   &amp; ~Constants.ACC_SYNCHRONIZED);
            <span class="hljs-keyword">if</span> (forcePublic.contains(MethodWrapper.create(method))) {
                modifiers = (modifiers &amp; ~Constants.ACC_PROTECTED) | Constants.ACC_PUBLIC;
            }
            <span class="hljs-keyword">return</span> ReflectUtils.getMethodInfo(method, modifiers);
        }
    });

    ClassEmitter e = <span class="hljs-keyword">new</span> ClassEmitter(v);
    <span class="hljs-keyword">if</span> (currentData == <span class="hljs-keyword">null</span>) {
    e.begin_class(Constants.V1_2,
                  Constants.ACC_PUBLIC,
                  getClassName(),
                  Type.getType(sc),
                  (useFactory ?
                   TypeUtils.add(TypeUtils.getTypes(interfaces), FACTORY) :
                   TypeUtils.getTypes(interfaces)),
                  Constants.SOURCE_FILE);
    } <span class="hljs-keyword">else</span> {
        e.begin_class(Constants.V1_2,
                Constants.ACC_PUBLIC,
                getClassName(),
                <span class="hljs-keyword">null</span>,
                <span class="hljs-keyword">new</span> Type[]{FACTORY},
                Constants.SOURCE_FILE);
    }
    List constructorInfo = CollectionUtils.transform(constructors, MethodInfoTransformer.getInstance());

    e.declare_field(Constants.ACC_PRIVATE, BOUND_FIELD, Type.BOOLEAN_TYPE, <span class="hljs-keyword">null</span>);
    e.declare_field(Constants.ACC_PUBLIC | Constants.ACC_STATIC, FACTORY_DATA_FIELD, OBJECT_TYPE, <span class="hljs-keyword">null</span>);
    <span class="hljs-keyword">if</span> (!interceptDuringConstruction) {
        e.declare_field(Constants.ACC_PRIVATE, CONSTRUCTED_FIELD, Type.BOOLEAN_TYPE, <span class="hljs-keyword">null</span>);
    }
    e.declare_field(Constants.PRIVATE_FINAL_STATIC, THREAD_CALLBACKS_FIELD, THREAD_LOCAL, <span class="hljs-keyword">null</span>);
    e.declare_field(Constants.PRIVATE_FINAL_STATIC, STATIC_CALLBACKS_FIELD, CALLBACK_ARRAY, <span class="hljs-keyword">null</span>);
    <span class="hljs-keyword">if</span> (serialVersionUID != <span class="hljs-keyword">null</span>) {
        e.declare_field(Constants.PRIVATE_FINAL_STATIC, Constants.SUID_FIELD_NAME, Type.LONG_TYPE, serialVersionUID);
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; callbackTypes.length; i++) {
        e.declare_field(Constants.ACC_PRIVATE, getCallbackField(i), callbackTypes[i], <span class="hljs-keyword">null</span>);
    }
    <span class="hljs-comment">// This is declared private to avoid "public field" pollution</span>
    e.declare_field(Constants.ACC_PRIVATE | Constants.ACC_STATIC, CALLBACK_FILTER_FIELD, OBJECT_TYPE, <span class="hljs-keyword">null</span>);

    <span class="hljs-keyword">if</span> (currentData == <span class="hljs-keyword">null</span>) {
        emitMethods(e, methods, actualMethods);
        emitConstructors(e, constructorInfo);
    } <span class="hljs-keyword">else</span> {
        emitDefaultConstructor(e);
    }
    emitSetThreadCallbacks(e);
    emitSetStaticCallbacks(e);
    emitBindCallbacks(e);

    <span class="hljs-keyword">if</span> (useFactory || currentData != <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">int</span>[] keys = getCallbackKeys();
        emitNewInstanceCallbacks(e);
        emitNewInstanceCallback(e);
        emitNewInstanceMultiarg(e, constructorInfo);
        emitGetCallback(e, keys);
        emitSetCallback(e, keys);
        emitGetCallbacks(e);
        emitSetCallbacks(e);
    }

    e.end_class();
}</code></pre><p><code>generateClass(...)</code> æ‰§è¡Œçš„æ“ä½œå’Œ ASM åº“çš„ ClassVisitor è®¿é—® Class æ–‡ä»¶ç»“æ„çš„æµç¨‹åŸºæœ¬ç±»ä¼¼ã€‚</p>
<p>ä»ä¸Šè¿°æˆªå–åˆ°çš„éƒ¨åˆ†ä»£ç ï¼Œä¾‹å¦‚:</p>
<pre><code class="hljs">e.begin_class(Constants.V1_2, Constants.ACC_PUBLIC, getClassName(), Type.getType(sc), 
        (useFactory ? TypeUtils.add(TypeUtils.getTypes(interfaces), FACTORY) : TypeUtils.getTypes(interfaces)),
        Constants.SOURCE_FILE);</code></pre><pre><code class="hljs">e.declare_field(Constants.PRIVATE_FINAL_STATIC, THREAD_CALLBACKS_FIELD, THREAD_LOCAL, <span class="hljs-keyword">null</span>);</code></pre><p>éƒ½ä¸ <code>classVisitor.visit(...)</code> ä»¥åŠ <code>classVisitor.visitField(...)</code> ç›¸å½“ç±»ä¼¼ã€‚è€Œäº‹å®ä¸Šï¼Œè¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°ä¹Ÿç¡®å®è°ƒç”¨äº† cv.visitXxx(...) ã€‚
æ¯•ç«Ÿï¼Œä½œä¸º CGlib å”¯ä¸€ä¾èµ–çš„åº“ï¼ŒASM è¿˜æ˜¯å¯ä»¥è¯´æ˜¯éš¾ä»¥æ›¿ä»£çš„(æ—¢ç„¶å·²ç»æœ‰äº†å¯ç”¨çš„è½®å­ï¼Œåˆä½•å¿…é‡å¤é€ å‘¢?)</p>
<h2>æ„é€ çš„å®ä¾‹</h2>
<p>ä¸‹é¢å°†å±•ç¤ºé€šè¿‡ CGlib ç”Ÿæˆçš„æ–°çš„ç±»(ç”±äºç”Ÿæˆçš„æ˜¯å­—èŠ‚ç ï¼Œæ‡’å¾—å†è‡ªè¡Œè§£æ ClassFile çš„å†…å®¹ï¼Œæ‰€æœ‰ç›´æ¥ç”¨ <code>IDEA</code> åšäº†å­—èŠ‚ç çš„è§£æ)</p>
<p><strong>é¦–å…ˆå±•ç¤ºçš„éœ€è¦è¿›è¡Œå¢å¼ºçš„ SampleClass çš„å…·ä½“å†…å®¹</strong></p>
<pre><code class="hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SampleClass</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span><span class="hljs-params">(String input)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello World!"</span>;
    }
}</code></pre><p><strong>ç”¨äºå¢å¼ºçš„ç®€å•ä»£ç </strong></p>
<pre><code class="hljs"><span class="hljs-comment">// çœç•¥éƒ¨åˆ†ä»£ç </span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String... args)</span> </span>{
    Enhancer enhancer = <span class="hljs-keyword">new</span> Enhancer();
    enhancer.setSuperclass(SampleClass.class);
    enhancer.setCallback(<span class="hljs-keyword">new</span> FixedValue() {
        <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">loadObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello cglib!"</span>;
        }
    });
    SampleClass proxy = (SampleClass) enhancer.create();
}</code></pre><p><strong>åŠ¨æ€ç”Ÿæˆçš„æ–°çš„ç±»</strong></p>
<pre><code class="hljs"><span class="hljs-comment">//</span>
<span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span>
<span class="hljs-comment">// (powered by Fernflower decompiler)</span>
<span class="hljs-comment">//</span>

<span class="hljs-comment">// ä¸ç”¨è¿‡å¤šå…³æ³¨ï¼Œåªæ˜¯ CGlib ä¿è¯ç”Ÿæˆç±»ä¸åŸæœ‰çš„ç±»ä¸€å®šå±äºåŒä¸€åŒ…ä¸‹ï¼Œå·æ‡’ç›´æ¥æŠŠ SampleClass å†™åœ¨ CGlib é¡¹ç›®é‡Œäº†</span>
<span class="hljs-keyword">package</span> net.sf.cglib.samples;

<span class="hljs-keyword">import</span> net.sf.cglib.proxy.Callback;
<span class="hljs-keyword">import</span> net.sf.cglib.proxy.Factory;
<span class="hljs-keyword">import</span> net.sf.cglib.proxy.FixedValue;

<span class="hljs-comment">/**
 * æ–°çš„ç±»åï¼Œé€šè¿‡ $$EnhancerByCGLIB ä»¥åŠ $$7cd64b81(è¿™ä¸ªæ˜¯å“ˆå¸Œå€¼) å¯¹ç±»åè¿›è¡Œå”¯ä¸€åŒºåˆ† 
 * å¦‚æœè¿˜æ˜¯é‡å¤äº†ï¼Œåœ¨åŠ¨æ€ç”Ÿæˆå‰ä¼šè¿›è¡Œç±»åçš„æ£€æµ‹ï¼Œå¹¶é€šè¿‡å¢åŠ åºå· "_&lt;index&gt;" çš„å½¢å¼è¿›è¡Œè¿›ä¸€æ­¥åŒºåˆ†
 *
 * å¯ä»¥çœ‹åˆ°æ–°ç”Ÿæˆçš„ç±»ç»§æ‰¿äº† SampleClass 
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SampleClass</span>$$<span class="hljs-title">EnhancerByCGLIB</span>$$7<span class="hljs-title">cd64b81</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SampleClass</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Factory</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> CGLIB$BOUND;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object CGLIB$FACTORY_DATA;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal CGLIB$THREAD_CALLBACKS;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Callback[] CGLIB$STATIC_CALLBACKS;

    <span class="hljs-comment">// ç»‘å®šä¸€ä¸ªåœ¨å¢å¼ºä¸­å£°æ˜çš„ Callback å®ä¾‹</span>
    <span class="hljs-keyword">private</span> FixedValue CGLIB$CALLBACK_0;
    <span class="hljs-comment">// ç»‘å®šä¸€ä¸ªé™æ€çš„å›è°ƒè°ƒåº¦å®ä¾‹</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object CGLIB$CALLBACK_FILTER;

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> CGLIB$STATICHOOK1() {
        CGLIB$THREAD_CALLBACKS = <span class="hljs-keyword">new</span> ThreadLocal();
    }

    <span class="hljs-comment">/**
      * å¯¹ test(String) çš„æ–¹æ³•çš„å¢å¼º
      */</span> 
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title">test</span><span class="hljs-params">(String var1)</span> </span>{
        <span class="hljs-comment">// åœ¨æ–¹æ³•å—ä¸­æ‹¿åˆ° Callback å®ä¾‹</span>
        FixedValue var10000 = <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0;
        <span class="hljs-comment">// ä¸ºç©ºåˆ™å°è¯•è·å–</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0 == <span class="hljs-keyword">null</span>) {
            CGLIB$BIND_CALLBACKS(<span class="hljs-keyword">this</span>);
            var10000 = <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0;
        }

        <span class="hljs-comment">// è§¦å‘å›è°ƒå®ä¾‹çš„æ–¹æ³•è·å¾—è¿”å›å€¼</span>
        <span class="hljs-keyword">return</span> (String)var10000.loadObject();
    }

    <span class="hljs-comment">/**
      * ç”±äºæ­¤æ¬¡å¢å¼ºåªå£°æ˜äº†ä¸€ä¸ª Callback
      * å› æ­¤æ‰€æœ‰æ–¹æ³•çš„å¢å¼ºéƒ½ç›¸åŒ, éƒ½æ˜¯è°ƒç”¨è¿™ä¸ªå›è°ƒæ–¹æ³•è·å–
      */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object var1)</span> </span>{
        FixedValue var10000 = <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0 == <span class="hljs-keyword">null</span>) {
            CGLIB$BIND_CALLBACKS(<span class="hljs-keyword">this</span>);
            var10000 = <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0;
        }

        Object var2 = var10000.loadObject();
        <span class="hljs-comment">/**
         * ä½†æ˜¯ï¼Œæ­¤å¤„ä¼šå°è¯•å¼ºåˆ¶è½¬å‹
         * åŒæ—¶åœ¨æœ€ç»ˆæ‰§è¡Œå¤±è´¥çš„æ—¶å€™ç›´æ¥æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸
         * æ¯•ç«Ÿä¸Šé¢å¢å¼ºçš„æ—¶å€™è¿”å›å›ºå®šå€¼ "Hello, cglib!"
         */</span>
        <span class="hljs-keyword">return</span> var2 == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">false</span> : (Boolean)var2;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{
        FixedValue var10000 = <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0 == <span class="hljs-keyword">null</span>) {
            CGLIB$BIND_CALLBACKS(<span class="hljs-keyword">this</span>);
            var10000 = <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0;
        }

        <span class="hljs-keyword">return</span> (String)var10000.loadObject();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>{
        FixedValue var10000 = <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0 == <span class="hljs-keyword">null</span>) {
            CGLIB$BIND_CALLBACKS(<span class="hljs-keyword">this</span>);
            var10000 = <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0;
        }

        Object var1 = var10000.loadObject();
        <span class="hljs-keyword">return</span> var1 == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : ((Number)var1).intValue();
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Object <span class="hljs-title">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException </span>{
        FixedValue var10000 = <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0 == <span class="hljs-keyword">null</span>) {
            CGLIB$BIND_CALLBACKS(<span class="hljs-keyword">this</span>);
            var10000 = <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0;
        }

        <span class="hljs-keyword">return</span> var10000.loadObject();
    }

    <span class="hljs-keyword">public</span> SampleClass$$EnhancerByCGLIB$$<span class="hljs-number">7</span>cd64b81() {
        CGLIB$BIND_CALLBACKS(<span class="hljs-keyword">this</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> CGLIB$SET_THREAD_CALLBACKS(Callback[] var0) {
        CGLIB$THREAD_CALLBACKS.set(var0);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> CGLIB$SET_STATIC_CALLBACKS(Callback[] var0) {
        CGLIB$STATIC_CALLBACKS = var0;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> CGLIB$BIND_CALLBACKS(Object var0) {
        SampleClass$$EnhancerByCGLIB$$<span class="hljs-number">7</span>cd64b81 var1 = (SampleClass$$EnhancerByCGLIB$$<span class="hljs-number">7</span>cd64b81)var0;
        <span class="hljs-keyword">if</span> (!var1.CGLIB$BOUND) {
            var1.CGLIB$BOUND = <span class="hljs-keyword">true</span>;
            Object var10000 = CGLIB$THREAD_CALLBACKS.get();
            <span class="hljs-keyword">if</span> (var10000 == <span class="hljs-keyword">null</span>) {
                var10000 = CGLIB$STATIC_CALLBACKS;
                <span class="hljs-keyword">if</span> (CGLIB$STATIC_CALLBACKS == <span class="hljs-keyword">null</span>) {
                    <span class="hljs-keyword">return</span>;
                }
            }

            var1.CGLIB$CALLBACK_0 = (FixedValue)((Callback[])var10000)[<span class="hljs-number">0</span>];
        }

    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">newInstance</span><span class="hljs-params">(Callback[] var1)</span> </span>{
        CGLIB$SET_THREAD_CALLBACKS(var1);
        SampleClass$$EnhancerByCGLIB$$<span class="hljs-number">7</span>cd64b81 var10000 = <span class="hljs-keyword">new</span> SampleClass$$EnhancerByCGLIB$$<span class="hljs-number">7</span>cd64b81();
        CGLIB$SET_THREAD_CALLBACKS((Callback[])<span class="hljs-keyword">null</span>);
        <span class="hljs-keyword">return</span> var10000;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">newInstance</span><span class="hljs-params">(Callback var1)</span> </span>{
        CGLIB$SET_THREAD_CALLBACKS(<span class="hljs-keyword">new</span> Callback[]{var1});
        SampleClass$$EnhancerByCGLIB$$<span class="hljs-number">7</span>cd64b81 var10000 = <span class="hljs-keyword">new</span> SampleClass$$EnhancerByCGLIB$$<span class="hljs-number">7</span>cd64b81();
        CGLIB$SET_THREAD_CALLBACKS((Callback[])<span class="hljs-keyword">null</span>);
        <span class="hljs-keyword">return</span> var10000;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">newInstance</span><span class="hljs-params">(Class[] var1, Object[] var2, Callback[] var3)</span> </span>{
        CGLIB$SET_THREAD_CALLBACKS(var3);
        SampleClass$$EnhancerByCGLIB$$<span class="hljs-number">7</span>cd64b81 var10000 = <span class="hljs-keyword">new</span> SampleClass$$EnhancerByCGLIB$$<span class="hljs-number">7</span>cd64b81;
        <span class="hljs-keyword">switch</span>(var1.length) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
            var10000.&lt;init&gt;();
            CGLIB$SET_THREAD_CALLBACKS((Callback[])<span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">return</span> var10000;
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Constructor not found"</span>);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Callback <span class="hljs-title">getCallback</span><span class="hljs-params">(<span class="hljs-keyword">int</span> var1)</span> </span>{
        CGLIB$BIND_CALLBACKS(<span class="hljs-keyword">this</span>);
        FixedValue var10000;
        <span class="hljs-keyword">switch</span>(var1) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
            var10000 = <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
            var10000 = <span class="hljs-keyword">null</span>;
        }

        <span class="hljs-keyword">return</span> var10000;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCallback</span><span class="hljs-params">(<span class="hljs-keyword">int</span> var1, Callback var2)</span> </span>{
        <span class="hljs-keyword">switch</span>(var1) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
            <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0 = (FixedValue)var2;
        <span class="hljs-keyword">default</span>:
        }
    }

    <span class="hljs-keyword">public</span> Callback[] getCallbacks() {
        CGLIB$BIND_CALLBACKS(<span class="hljs-keyword">this</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Callback[]{<span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0};
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCallbacks</span><span class="hljs-params">(Callback[] var1)</span> </span>{
        <span class="hljs-keyword">this</span>.CGLIB$CALLBACK_0 = (FixedValue)var1[<span class="hljs-number">0</span>];
    }

    <span class="hljs-keyword">static</span> {
        CGLIB$STATICHOOK1();
    }
}</code></pre><p>ä»ä¸Šé¢çš„ç”Ÿæˆç±»å¯ä»¥çœ‹å‡ºæ¥ï¼ŒCGlib æ‰€è¿›è¡Œçš„å¢å¼ºï¼Œæ˜¯åœ¨ä¸ç›´æ¥å¯¹åŸæœ‰çš„æ–¹æ³•ä½“å†…å®¹è¿›è¡Œæ”¹é€ çš„åŸºç¡€ä¸Š(ä¾‹å¦‚ä¸Šé¢çš„ test(String) æ–¹æ³•ï¼Œæ²¡æœ‰ç›´æ¥æ”¹å†™æˆ <code>return &quot;Hello, cglib!</code> çš„å½¢å¼)ï¼Œå¯¹æ–¹æ³•æ‰§è¡Œä¹‹å‰å…¥å‚æˆ–è€…æ–¹æ³•æ‰§è¡Œä¹‹åçš„è¿”å›å€¼è¿›è¡Œä¸€å®šçš„å¤„ç†ã€‚</p>
<p>ä¸»è¦ä½¿ç”¨çš„å½¢å¼å°±æ˜¯å°†å›è°ƒå®ä¾‹ä¸åŸæœ‰æ–¹æ³•è¿›è¡Œç»‘å®šï¼Œå¹¶é€šè¿‡è°ƒç”¨å›è°ƒæ–¹æ³•æ¥å®ç°æ–¹æ³•çš„å¢å¼ºã€‚</p>
<pre><code class="hljs">__                    __                  
 / _| __ _ _ __   __ _ / _| ___ _ __   __ _ 
| |_ / _` | '_ \ / _` | |_ / _ \ '_ \ / _` |
|  _| (_| | | | | (_| |  _|  __/ | | | (_| |
|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |
                 |___/                |___/</code></pre></div></main><footer class="footer">ffutop Â© <!-- -->2019<!-- -->, Built with<a href="https://reactjs.org/">React</a></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{}},"page":"/post","query":{"fullUrl":"/2018-07-10-CGlib-Enhancer"},"buildId":"xx4WXnl7odya2QE7dUtyW","dynamicBuildId":false,"assetPrefix":"https://www.ffutop.com/blog","nextExport":true}</script><script async="" id="__NEXT_PAGE__/post" src="https://www.ffutop.com/blog/_next/static/xx4WXnl7odya2QE7dUtyW/pages/post.js"></script><script async="" id="__NEXT_PAGE__/_app" src="https://www.ffutop.com/blog/_next/static/xx4WXnl7odya2QE7dUtyW/pages/_app.js"></script><script src="https://www.ffutop.com/blog/_next/static/runtime/webpack-8ed9452df514b4d17d80.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/chunks/commons.966200943f7869d2249d.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/chunks/styles.2d2aeb3a0a1eb931bc6e.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/runtime/main-3daabeb1dde7624c7fe0.js" async=""></script></body></html>