<!DOCTYPE html><html><head><meta charSet="utf-8" class="next-head"/><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" class="next-head"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/xx4WXnl7odya2QE7dUtyW/pages/post.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/xx4WXnl7odya2QE7dUtyW/pages/_app.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/runtime/webpack-8ed9452df514b4d17d80.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/chunks/commons.966200943f7869d2249d.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/chunks/styles.2d2aeb3a0a1eb931bc6e.js" as="script"/><link rel="preload" href="https://www.ffutop.com/blog/_next/static/runtime/main-3daabeb1dde7624c7fe0.js" as="script"/><link rel="stylesheet" href="https://www.ffutop.com/blog/_next/static/css/commons.a70990b9.chunk.css"/><link rel="stylesheet" href="https://www.ffutop.com/blog/_next/static/css/styles.196d8b6b.chunk.css"/></head><body><div id="__next"><header><h1 class="title">ffutop</h1><div><a href="/blog/blog/">åšå®¢</a><a href="/blog/archives/">å½’æ¡£</a><a href="/blog/tags/">æ ‡ç­¾</a><a href="/blog/about/">å…³äº</a></div></header><div><main class="main"><div><p>ç›¸æ¯”è¾ƒäºå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æ— è®ºä»ç‰©ç†è®¤çŸ¥ä¸Šï¼ŒæŠ‘æˆ–æ˜¯ç†è®ºç†è§£ä¸Šï¼Œéƒ½å­˜åœ¨ç€ç›¸å½“å¤§çš„å…¥é—¨é—¨æ§›ã€‚ç‰¹åˆ«æ˜¯åœ¨å°†å­—ç¬¦è®¾å¤‡ä¸æ§åˆ¶å°ã€å‘½ä»¤è¡Œç»ˆç«¯æ··æ·†çš„æ—¶å€™ï¼Œå°±æ›´åŠ éš¾ä»¥è¿›è¡Œåˆ†è¾¨äº†ã€‚</p>
<p>å›åˆ°å­—ç¬¦è®¾å¤‡æœ¬èº«ï¼Œå­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡æœ€ä¸»è¦çš„åŒºåˆ«å°±åœ¨äºå—è®¾å¤‡å¯ä»¥éšæœºè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½å¤Ÿé¡ºåºè¯»ï¼Œé¡ºåºå†™ã€‚</p>
<p>é‚£ä¹ˆï¼Œå¸¸è§çš„å­—ç¬¦è®¾å¤‡æœ‰ä»€ä¹ˆï¼Ÿæ˜¾ç¤ºå™¨ã€é”®ç›˜ã€é¼ æ ‡ã€‚</p>
<p>&lt;!-- more --&gt;</p>
<h2>å®è§‚æ¦‚è§ˆ</h2>
<p>é€šå¸¸åœ¨æˆ‘ä»¬çš„è®¤è¯†ä¸­ï¼Œå‘½ä»¤è¡Œç»ˆç«¯å°±è¢«è®¤ä¸ºæ˜¯ä¸ä¸€å¥—å­—ç¬¦è®¾å¤‡ç›¸é…åˆæ¥ä½¿ç”¨çš„ã€‚å¾ˆæ­£å¸¸å˜›ã€‚æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ª Shell ï¼Œé€šè¿‡é”®ç›˜è¾“å…¥ä¸€äº›å­—ç¬¦ï¼Œé…åˆæ˜¾ç¤ºå™¨æŠŠè¿™äº›ç»è¿‡åŠ å·¥çš„å­—ç¬¦å±•ç¤ºå‡ºæ¥ã€‚</p>
<p>é‚£ä¹ˆï¼Œæ˜¯ä¸æ˜¯å°±æ„å‘³ç€ Shell ä½œä¸ºä¸€ä¸ªä»»åŠ¡(è¿›ç¨‹)ï¼Œä»¥é”®ç›˜è®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å…¥ï¼Œä»¥æ˜¾ç¤ºè®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å‡º?</p>
<p>çœ‹çœ‹ä¸€ä¸ª 1 å·ä»»åŠ¡ <code>/bin/bash</code> çš„æ–‡ä»¶æè¿°ç¬¦è¯´æ˜å§ã€‚</p>
<pre><code class="hljs">$ ls -al
total 0
dr-x------ 2 root root  0 Dec 13 23:20 .
dr-xr-xr-x 9 root root  0 Dec 13 23:20 ..
lrwx------ 1 root root 64 Dec 13 23:20 0 -&gt; /dev/pts/0
lrwx------ 1 root root 64 Dec 13 23:20 1 -&gt; /dev/pts/0
lrwx------ 1 root root 64 Dec 13 23:20 2 -&gt; /dev/pts/0
lrwx------ 1 root root 64 Dec 25 01:09 255 -&gt; /dev/pts/0</code></pre><p>è¿™é‡Œæ–‡ä»¶æè¿°ç¬¦ 0, 1, 2 åˆ†åˆ«è¡¨ç¤ºä»»åŠ¡çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ã€‚è¿™äº›å†…å®¹åœ¨è¡¨ç°å½¢å¼ä¸Šåšäº†ä¸€ä¸ªé“¾æ¥ã€‚</p>
<p>é‚£ä¹ˆï¼Œ<code>/dev/pts/0</code> æ˜¯ä»€ä¹ˆ?</p>
<pre><code class="hljs">crw--w---- 1 root tty 136, 0 Dec 13 23:20 /dev/pts/0</code></pre><p>ä¸€ä¸ªå­—ç¬¦è®¾å¤‡ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œä¼¼ä¹å’Œæœ€åˆé¢„æƒ³çš„æœ‰æ¯”è¾ƒå¤§çš„åŒºåˆ«ã€‚è‡³å°‘åœ¨å‡è±¡ä¸­ï¼Œè‡³å°‘æ˜¯ä¸€ä¸ªè¾“å…¥(é”®ç›˜)ï¼Œä¸€ä¸ªè¾“å‡º(æ˜¾ç¤ºå™¨)ã€‚æ€ä¹ˆå°±æ··æˆäº†ä¸€ä¸ªå‘¢ï¼Ÿ</p>
<p>æœ¬æ¥æ˜¯æ€ä¹ˆéƒ½æƒ³ä¸é€šçš„ï¼Œä½†åæ¥é…åˆ&quot;Unixä¸€åˆ‡çš†æ–‡ä»¶&quot;çš„ä¿¡æ¡ï¼Œæ€»ç®—æ˜¯æœ‰ç‚¹æ˜ç™½äº†ã€‚</p>
<p>ç›¸ä¿¡å¤§å®¶éƒ½æœ‰è¿™è¿™æ ·çš„ç»å†ï¼ŒæŸä¸ªç¨‹åºæ˜¯ä»¥é”®ç›˜è¾“å…¥ä½œä¸ºæ ‡å‡†è¾“å…¥çš„ã€‚å…¶å®å°±å’Œä¸Šé¢ğŸ‘†å±•ç¤ºçš„ä¸€æ · <code>0 -&gt; /dev/pts/0</code> ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰è€ƒè™‘è¿‡è¿™æ•´å¥—æµç¨‹æ˜¯æ€ä¹ˆåä½œçš„å‘¢ï¼Ÿ</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fyjvtjiu0zj31980oqmxe.jpg" alt=""></p>
<p>å¯¹äºç¨‹åºæ¥è¯´ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ™®é€šçš„è°ƒç”¨ <code>read</code>, <code>write</code> ç­‰ç»è¿‡å°è£…çš„å‡½æ•°ï¼Œæ¥è¯»å–ä¸€ä¸ªæ‰€è°“çš„æ–‡ä»¶ã€‚</p>
<p>ä½†å¯¹äºæ–‡ä»¶æ˜¯å­—ç¬¦è®¾å¤‡æ—¶ï¼Œæœ€ç»ˆè°ƒç”¨çš„å°±æ˜¯ <code>tty_read</code>, <code>tty_write</code> äº†ã€‚é€šä¿—çš„è®²ï¼Œå¤§æ¦‚ç‡çš„å°±æ˜¯é”®ç›˜ä½œä¸ºè¾“å…¥ï¼Œæ˜¾ç¤ºå™¨ä½œä¸ºè¾“å‡ºäº†ã€‚</p>
<h2>æºç å‰–æ</h2>
<h3>æ–‡ä»¶è¯»å†™</h3>
<p>è¿™éƒ¨åˆ†ä¸Šä¸€ç¯‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œä¸åšè¿‡å¤šè¯´æ˜ã€‚</p>
<p>ç®€å•å›é¡¾ä¸‹ <code>sys_read</code> å‡½æ•°</p>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sys_read</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> fd,<span class="hljs-keyword">char</span> * buf,<span class="hljs-keyword">int</span> count)</span>
</span>{
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> * <span class="hljs-title">file</span>;</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">m_inode</span> * <span class="hljs-title">inode</span>;</span>

	<span class="hljs-keyword">if</span> (fd&gt;=NR_OPEN || count&lt;<span class="hljs-number">0</span> || !(file=current-&gt;filp[fd]))
		<span class="hljs-keyword">return</span> -EINVAL;
	<span class="hljs-keyword">if</span> (!count)
		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
	verify_area(buf,count);
	inode = file-&gt;f_inode;
	<span class="hljs-keyword">if</span> (inode-&gt;i_pipe)
		<span class="hljs-keyword">return</span> (file-&gt;f_mode&amp;<span class="hljs-number">1</span>)?read_pipe(inode,buf,count):-EIO;
    <span class="hljs-comment">/* ç¡®è®¤åˆ°ièŠ‚ç‚¹æè¿°çš„æ˜¯å­—ç¬¦è®¾å¤‡ */</span>
	<span class="hljs-keyword">if</span> (S_ISCHR(inode-&gt;i_mode)) 
		<span class="hljs-keyword">return</span> rw_char(READ,inode-&gt;i_zone[<span class="hljs-number">0</span>],buf,count,&amp;file-&gt;f_pos);
	<span class="hljs-keyword">if</span> (S_ISBLK(inode-&gt;i_mode))
		<span class="hljs-keyword">return</span> block_read(inode-&gt;i_zone[<span class="hljs-number">0</span>],&amp;file-&gt;f_pos,buf,count);
	<span class="hljs-keyword">if</span> (S_ISDIR(inode-&gt;i_mode) || S_ISREG(inode-&gt;i_mode)) {
		<span class="hljs-keyword">if</span> (count+file-&gt;f_pos &gt; inode-&gt;i_size)
			count = inode-&gt;i_size - file-&gt;f_pos;
		<span class="hljs-keyword">if</span> (count&lt;=<span class="hljs-number">0</span>)
			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
		<span class="hljs-keyword">return</span> file_read(inode,file,buf,count);
	}
	printk(<span class="hljs-string">"(Read)inode-&gt;i_mode=%06o\n\r"</span>,inode-&gt;i_mode);
	<span class="hljs-keyword">return</span> -EINVAL;
}</code></pre><p>å¯ä»¥çœ‹åˆ° <code>S_ISCHR()</code> å°±æ˜¯åœ¨å¯¹ièŠ‚ç‚¹çš„ç±»å‹è¿›è¡Œåˆ¤åˆ«ï¼Œä»è€Œè¿›è¡Œä¸åŒçš„åˆ†å‘ã€‚</p>
<pre><code class="hljs"><span class="hljs-keyword">static</span> crw_ptr crw_table[]={
	<span class="hljs-literal">NULL</span>,		<span class="hljs-comment">/* nodev */</span>
	rw_memory,	<span class="hljs-comment">/* /dev/mem etc */</span>
	<span class="hljs-literal">NULL</span>,		<span class="hljs-comment">/* /dev/fd */</span>
	<span class="hljs-literal">NULL</span>,		<span class="hljs-comment">/* /dev/hd */</span>
	rw_ttyx,	<span class="hljs-comment">/* /dev/ttyx */</span>
	rw_tty,		<span class="hljs-comment">/* /dev/tty */</span>
	<span class="hljs-literal">NULL</span>,		<span class="hljs-comment">/* /dev/lp */</span>
	<span class="hljs-literal">NULL</span>};		<span class="hljs-comment">/* unnamed pipes */</span>
<span class="hljs-comment">/**
 * è¿™æ®µè¿˜æ˜¯æ¶‰åŠåˆ°åˆ†å‘ï¼Œç”±ä¸åŒçš„è®¾å¤‡å·(dev) æ¥ç¡®å®šæ‰§è¡Œå‡½æ•° (ttyx, ä¸²å£ç»ˆç«¯; tty, æ§åˆ¶å°ç»ˆç«¯; mem, /dev/mem ç­‰)
 * crw_ptr æ˜¯ C è¯­è¨€ä¸­å¸¸è§çš„å‡½æ•°æŒ‡é’ˆã€‚ç”±devå·æ¥ç¡®å®šè°ƒç”¨å“ªä¸ªå‡½æ•°
 */</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rw_char</span><span class="hljs-params">(<span class="hljs-keyword">int</span> rw,<span class="hljs-keyword">int</span> dev, <span class="hljs-keyword">char</span> * buf, <span class="hljs-keyword">int</span> count, <span class="hljs-keyword">off_t</span> * pos)</span>
</span>{
	crw_ptr call_addr;

	<span class="hljs-keyword">if</span> (MAJOR(dev)&gt;=NRDEVS)
		<span class="hljs-keyword">return</span> -ENODEV;
	<span class="hljs-keyword">if</span> (!(call_addr=crw_table[MAJOR(dev)]))
		<span class="hljs-keyword">return</span> -ENODEV;
	<span class="hljs-keyword">return</span> call_addr(rw,MINOR(dev),buf,count,pos);
}</code></pre><p>æ‰§è¡Œåˆ° <code>rw_tty</code>, <code>rw_ttyx</code> ä¸¤ä¸ªå‡½æ•°ï¼Œå°±å°†å¯¹è¯»/å†™è¿›è¡ŒåŒºåˆ†ï¼Œå¹¶ç”±ç‰¹å®šçš„å‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">rw_ttyx</span><span class="hljs-params">(<span class="hljs-keyword">int</span> rw,<span class="hljs-keyword">unsigned</span> minor,<span class="hljs-keyword">char</span> * buf,<span class="hljs-keyword">int</span> count,<span class="hljs-keyword">off_t</span> * pos)</span>
</span>{
	<span class="hljs-keyword">return</span> ((rw==READ)?tty_read(minor,buf,count):
		tty_write(minor,buf,count));
}

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">rw_tty</span><span class="hljs-params">(<span class="hljs-keyword">int</span> rw,<span class="hljs-keyword">unsigned</span> minor,<span class="hljs-keyword">char</span> * buf,<span class="hljs-keyword">int</span> count, <span class="hljs-keyword">off_t</span> * pos)</span>
</span>{
	<span class="hljs-keyword">if</span> (current-&gt;tty&lt;<span class="hljs-number">0</span>)
		<span class="hljs-keyword">return</span> -EPERM;
	<span class="hljs-keyword">return</span> rw_ttyx(rw,current-&gt;tty,buf,count,pos);
}</code></pre><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œåº”è¯¥èƒ½å¤ŸåŸºæœ¬äº†è§£äº†å­—ç¬¦è®¾å¤‡ï¼Œä½œä¸º Linux çš„æ–‡ä»¶ï¼Œæ‰€åº”è¯¥æœ‰çš„è¯»å†™çš„ç›¸å…³æ”¯æŒã€‚</p>
<p>ä½†æ˜¯ï¼Œç©¶ç«Ÿè¯»ã€å†™çš„å†…å®¹åœ¨å“ªå‘¢ï¼Ÿæ¯”å¦‚æ­£è§„æ–‡ä»¶ï¼Œéƒ½å¾ˆå®¹æ˜“åœ°å¯ä»¥ç†è§£åˆ°ï¼Œå°±æ˜¯ä»ç£ç›˜ä¸­å–å‡ºæŸä¸ª/æŸå‡ ä¸ªç›˜å—çš„å†…å®¹å³å¯ã€‚å­—ç¬¦è®¾å¤‡çš„IOè¦ä»å“ªé‡Œå–(å¾€å“ªé‡Œé€)æ•°æ®å‘¢?</p>
<h3>å­—ç¬¦è®¾å¤‡é©±åŠ¨</h3>
<p>å¯¹äºè®¾å¤‡é©±åŠ¨è¿™ä¸ªæ¦‚å¿µï¼Œè‡³ä»Šæ²¡æœ‰ææ¸…æ¥šã€‚ä¸è¿‡ï¼Œè¿™ä¸å¦¨ç¢å¯¹ä»£ç çš„ç†è§£ã€‚åæ­£å¯¹äºå­—ç¬¦è®¾å¤‡é©±åŠ¨æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€äº›è½¯ä»¶å±‚é¢çš„ä»£ç ï¼Œä¸æ™®é€šä»£ç çš„å”¯ä¸€åŒºåˆ«ï¼Œå°±æ˜¯å¯¹å¤–è®¾ç¡¬ä»¶åšäº†ç›¸åº”çš„äº¤äº’æ”¯æŒã€‚</p>
<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fykyc6lo9pj31i40u0ac8.jpg" alt=""></p>
<p>æ‰¿æ¥æ“ä½œç³»ç»Ÿçš„å­—ç¬¦è®¾å¤‡æ¥å£ï¼Œ<code>tty_read</code>ã€<code>tty_write</code> è´Ÿè´£è¯»å…¥å’Œå†™å‡ºã€‚</p>
<p>ä»å“ªé‡Œè¯»ï¼Ÿ<code>secondary</code> æ•°æ®é˜Ÿåˆ—ï¼›å¾€å“ªé‡Œå†™ï¼Ÿ<code>write_q</code> æ•°æ®é˜Ÿåˆ—ã€‚</p>
<p>åŒæ—¶ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œä¸è¿™äº›é˜Ÿåˆ—ç›´æ¥ç›¸å…³çš„ï¼Œå°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„é”®ç›˜å’Œæ˜¾ç¤ºå™¨äº†ã€‚æ˜¯ä¸æ˜¯æœ‰äº†ç‚¹è±ç„¶å¼€æœ—çš„æ„Ÿè§‰ã€‚</p>
<p>å¥½ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™é‡Œæè¿°çš„ä¸‰ä¸ªé˜Ÿåˆ—ç©¶ç«Ÿæ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚è¿™é‡Œå°±ä¸å¾—ä¸å…ˆçœ‹çœ‹å†…å­˜ä¸­æŠ½è±¡å‡ºæ¥çš„æè¿°ç»ˆç«¯çš„æ•°æ®ç»“æ„ <code>tty_struct</code>ã€‚</p>
<pre><code class="hljs"><span class="hljs-comment">/**
 * copied from include/linux/tty.h
 */</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_struct</span> {</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">termios</span> <span class="hljs-title">termios</span>;</span>     <span class="hljs-comment">/* terminal IO conf */</span>
	<span class="hljs-keyword">int</span> pgrp;                   <span class="hljs-comment">/* æ‰€å±è¿›ç¨‹ç»„ */</span>
	<span class="hljs-keyword">int</span> stopped;                <span class="hljs-comment">/* åœæ­¢æ ‡å¿— */</span>
	<span class="hljs-keyword">void</span> (*write)(struct tty_struct * tty); <span class="hljs-comment">/* ç»ˆç«¯å†™å‡½æ•°æŒ‡é’ˆ */</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_queue</span> <span class="hljs-title">read_q</span>;</span>    <span class="hljs-comment">/* ç»ˆç«¯è¯»é˜Ÿåˆ— */</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_queue</span> <span class="hljs-title">write_q</span>;</span>   <span class="hljs-comment">/* ç»ˆç«¯å†™é˜Ÿåˆ— */</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_queue</span> <span class="hljs-title">secondary</span>;</span> <span class="hljs-comment">/* ç»ˆç«¯è¾…åŠ©é˜Ÿåˆ— */</span>
};

<span class="hljs-comment">/**
 * copied from include/termios.h
 */</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">termios</span> {</span>                <span class="hljs-comment">/* terminal IO å±æ€§ */</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> c_iflag;		<span class="hljs-comment">/* input mode flags */</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> c_oflag;		<span class="hljs-comment">/* output mode flags */</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> c_cflag;		<span class="hljs-comment">/* control mode flags */</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> c_lflag;		<span class="hljs-comment">/* local mode flags */</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> c_line;		<span class="hljs-comment">/* line discipline */</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> c_cc[NCCS];	<span class="hljs-comment">/* control characters */</span>
};

<span class="hljs-comment">/**
 * copied from include/linux/tty.h
 */</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tty_queue</span> {</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> data;         <span class="hljs-comment">/* å­—ç¬¦è¡Œæ•°é‡ | ä¸²å£ç»ˆç«¯åˆ™å­˜å‚¨ç«¯å£å· */</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> head;         <span class="hljs-comment">/* å¤´æŒ‡é’ˆ */</span>
	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> tail;         <span class="hljs-comment">/* å°¾æŒ‡é’ˆ */</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> * <span class="hljs-title">proc_list</span>;</span> <span class="hljs-comment">/* ç­‰å¾…è¯¥ç»ˆç«¯çš„ä»»åŠ¡é˜Ÿåˆ— */</span>
	<span class="hljs-keyword">char</span> buf[TTY_BUF_SIZE];     <span class="hljs-comment">/* é˜Ÿåˆ—çš„ç¼“å†²åŒº */</span>
};</code></pre><p>å¯¹äºä»»ä½•ä»»åŠ¡éœ€è¦è¯»å†™å­—ç¬¦è®¾å¤‡(è¿™é‡ŒæŒ‡ç»ˆç«¯è®¾å¤‡)ï¼Œæœ€ç»ˆç›´æ¥è¯»å–/å†™å…¥åˆ°çš„å°±æ˜¯ <code>secondary</code> å’Œ <code>write_q</code>ã€‚</p>
<hr>
<p>è¿™é‡Œå¯èƒ½æœ‰ä¸ªå°å°çš„ç–‘é—®? ä¸ºä»€ä¹ˆè¯»ç»ˆç«¯è®¾å¤‡ä¸æ˜¯è¯» <code>read_q</code> å‘¢ï¼Ÿ</p>
<p>å…¶å®ä¹Ÿæ¯”è¾ƒå¥½è§£é‡Šï¼Œç›¸ä¿¡æ—¥å¸¸åœ¨æ“ä½œå‘½ä»¤è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨é”®ç›˜ä¸Šæ•²å‡»çš„é”®ä½ä¸æ˜¾ç¤ºå™¨ä¸Šå®é™…å±•ç¤ºçš„å†…å®¹æ˜¯ä¸ç›¸åŒ¹é…çš„ã€‚æœ€æ™®é€šçš„ï¼Œæˆ‘ä»¬é”®å…¥äº† <strong>delete(åˆ é™¤é”®)</strong>ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯ä¸€ä¸ª <strong>delete</strong> å¯¹åº”çš„ ascii (å½“ç„¶ï¼Œè¿™é‡Œè¯·å…ˆå¿½è§†éæ‰“å°å­—ç¬¦çš„é—®é¢˜)ï¼Œè€Œæ˜¯åˆ é™¤äº†æœ€åä¸€ä¸ªå­—ç¬¦å‘¢ï¼Ÿå®Œå…¨å¯ä»¥æƒ³è±¡ï¼Œåæ­£ä»»ä½•é”®ä½ä¸é©±åŠ¨äº¤äº’çš„æ—¶å€™éƒ½æ˜¯ä¼ å…¥ä¸€ä¸²äºŒè¿›åˆ¶ç å˜›ã€‚</p>
<p>è¿™é‡Œçš„ <code>secondary</code> å®Œæˆçš„å°±æ˜¯æ€ä¹ˆä¸€ä¸ªå·¥ä½œï¼Œ<code>read_q</code> å­˜å‚¨çš„æ˜¯æ‰€æœ‰çš„å¤–è®¾(è¿™é‡Œæ˜¯é”®ç›˜)çš„è¾“å…¥ï¼Œå¹¶åŸæ ·å­˜å‚¨ã€‚è€Œåˆ°äº† <code>secondary</code> å°±æ˜¯ç»è¿‡ç›¸åº”çš„åŠ å·¥ï¼Œè¯¸å¦‚æ§åˆ¶å­—ç¬¦ä¹‹ç±»çš„éƒ½å±•ç°äº†å„è‡ªçš„æ„ä¹‰ï¼Œå¹¶å®Œæˆä¸€äº›åŠ å·¥å·¥ä½œï¼Œè€Œä¸å†ä»…ä»…åªæ˜¯æ™®é€šåœ°å±•ç¤ºäº†ã€‚</p>
<hr>
<p>å¦å¤–ï¼Œå¯èƒ½è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚è™½ç„¶æˆ‘ä»¬å·²ç»ä¹ æƒ¯äº†åœ¨å‘½ä»¤è¡Œäº¤äº’æ—¶ï¼Œæ‰€æœ‰çš„è¾“å…¥éƒ½å°†ç›´æ¥åœ¨æ˜¾ç¤ºå™¨ä¸Šè¿›è¡Œå±•ç¤ºï¼Œå¥½åƒæˆ‘ä»¬åœ¨ç›´æ¥å¾€æ˜¾ç¤ºå™¨ä¸Šå†™å†…å®¹ã€‚ä½†æ˜¯ï¼Œå‰é¢æˆ‘ä»¬æè¿°çš„å†…å®¹éƒ½æ˜¯ï¼Œé”®ç›˜è®¾å¤‡ä½œä¸ºè¾“å…¥ï¼Œæ˜¯è¦å†™åˆ° <code>read_q</code> ä¹ƒè‡³ <code>secondary</code> å¹¶æœ€ç»ˆä½œä¸ºè¿›ç¨‹çš„è¾“å…¥çš„ã€‚åœ¨æ˜¾ç¤ºå™¨ä¸Šæ˜¾ç¤ºå¹¶ä¸æ˜¯å®ƒæœ¬æ¥åº”è¯¥å¹²çš„äº‹æƒ… (æ¯”è¾ƒæ˜¾ç¤ºå™¨ä¸Šå±•ç¤ºçš„åº”è¯¥æ˜¯ <code>write_q</code> çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹çš„æ ‡å‡†è¾“å‡º)</p>
<p>äº‹å®ä¸Šï¼Œè¿™ä»…ä»…åªæ˜¯ä¸€ä¸ªå›æ˜¾ï¼Œå°† <code>secondary</code> é˜Ÿåˆ—çš„å†…å®¹å¤åˆ¶äº†ä¸€ä»½åˆ°å†™é˜Ÿåˆ—ï¼Œä¹Ÿå°±å‘ˆç°å‡ºè®©æ˜¾ç¤ºå™¨æ‰“å°ç›¸åº”é”®ç›˜è¾“å…¥çš„æ•ˆæœäº†ã€‚</p>
<p>åŒæ—¶ï¼Œè¿™ä¹Ÿå°±èƒ½å¤Ÿç›´æ¥è§£é‡Šä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨ <code>passwd</code>, <code>su</code>, <code>sudo</code> ç­‰å‘½ä»¤æ—¶ï¼Œè¦æ±‚è¾“å…¥å¯†ç éƒ½æ˜¯ä¸åœ¨æ˜¾ç¤ºå™¨ä¸Šå›æ˜¾çš„ã€‚å®ç°ä¹Ÿç›¸å½“ç®€å•äº†å˜›ã€‚æŠŠ tty_struct.termios çš„ç›¸åº”æ§åˆ¶å±æ€§ (ECHO) é‡ç½®ï¼Œå°±å¯ä»¥å®ç°ä¸å›æ˜¾çš„æ•ˆæœäº†ã€‚</p>
<h3>ç»ˆç«¯è®¾å¤‡äº¤äº’</h3>
<p>æœ€åä¸€éƒ¨åˆ†ï¼Œåº”è¯¥ä¹Ÿæ˜¯æœ€å…³å¿ƒçš„äº†ã€‚å¤–è®¾å¦‚ä½•ä¸æ“ä½œç³»ç»Ÿå®Œæˆäº¤äº’ã€‚å…¶å®ä¹Ÿèƒ½å¤Ÿæƒ³å¾—åˆ°äº†â€”â€”ä¸­æ–­ã€‚</p>
<p>åœ¨æ“ä½œç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œå°±æŠŠä¸­æ–­æè¿°ç¬¦è¡¨çš„ä¸­æ–­è¡¨é¡¹é…ç½®å¾—å½“ã€‚ä¹‹åçš„äº‹æƒ…å°±æ˜¯ç­‰å¾…é”®ç›˜ç­‰å¤–è®¾è¾“å…¥çš„ä¸­æ–­ä¿¡å·äº†ã€‚</p>
<p>åˆçœ‹å›åˆ°äº† <code>init/main.c</code> ç¨‹åº</p>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    ...
	trap_init();
	blk_dev_init();
	chr_dev_init(); <span class="hljs-comment">/* å—è®¾å¤‡ç›¸å…³åˆå§‹åŒ–, æ–¹æ³•ä½“æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰å®ç° */</span>
	tty_init();     <span class="hljs-comment">/* tty ç»ˆç«¯è®¾å¤‡åˆå§‹åŒ– */</span>
	time_init();
	sched_init();
	buffer_init(buffer_memory_end);
    ...
}</code></pre><pre><code>/**
 * Copied from kernel/chr_drv/tty_io.c
 * ç»ˆç«¯è®¾å¤‡åˆè¯†åŒ–
 */
void tty_init(void)
{
    /** ä¸²å£è®¾å¤‡åˆå§‹åŒ– */
	rs_init();
    /** æ§åˆ¶å°è®¾å¤‡åˆå§‹åŒ– */
	con_init();
}
</code></pre>
<p>è‡³äºä¸ºä»€ä¹ˆæœ‰ä¸¤ç§åˆå§‹åŒ–æ–¹å¼ã€‚è¿™æ¥æºäºç»ˆç«¯åˆåŒºåˆ†ä¸ºæ§åˆ¶å°ç»ˆç«¯ä¸ä¸²å£ç»ˆç«¯ï¼ŒåŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯ç›´æ¥å»ºç«‹åœ¨ä¸»æœºä¸Šï¼Œä¸²å£ç»ˆç«¯æ˜¯é€šè¿‡ä¸²è¡Œæ¥å£è¿æ¥åˆ°ä¸»æœºçš„ã€‚å½“ç„¶ï¼Œè¿™éƒ½æ˜¯å¤è€çš„æ–¹å¼äº†ï¼Œç»†èŠ‚å°±ä¸å¤ªæ¸…æ¥šäº†ã€‚</p>
<p>ä¸‹é¢æ¥çœ‹çœ‹ <code>con_init()</code> åšäº†å“ªäº›å·¥ä½œ(<code>rs_init()</code> çš„å†…å®¹è¯·è‡ªè¡Œäº†è§£)</p>
<pre><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">con_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
	<span class="hljs-keyword">register</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> a;
	<span class="hljs-keyword">char</span> *display_desc = <span class="hljs-string">"????"</span>;
	<span class="hljs-keyword">char</span> *display_ptr;

    <span class="hljs-comment">/**
     * è¯»å– setup.s ç¨‹åºé¢„å¤„ç†çš„å†…å®¹
     * åŒ…æ‹¬æ˜¾ç¤ºå™¨çš„å„ç§é…ç½®å‚æ•°
     */</span>
	video_num_columns = ORIG_VIDEO_COLS;
	video_size_row = video_num_columns * <span class="hljs-number">2</span>;
	video_num_lines = ORIG_VIDEO_LINES;
	video_page = ORIG_VIDEO_PAGE;
	video_erase_char = <span class="hljs-number">0x0720</span>;

    <span class="hljs-comment">/**
     * è¯»å–æ˜¾ç¤ºå™¨çš„é…ç½®å¹¶è¿›è¡Œç›¸å…³è®¾ç½® (çœç•¥ä»£ç )
     */</span>
    ...

	origin	= video_mem_start;
	scr_end	= video_mem_start + video_num_lines * video_size_row;
	top	= <span class="hljs-number">0</span>;
	bottom	= video_num_lines;

	gotoxy(ORIG_X,ORIG_Y);
    <span class="hljs-comment">/** è®¾ç½®é™·é˜±é—¨ */</span>
	set_trap_gate(<span class="hljs-number">0x21</span>,&amp;keyboard_interrupt);
	outb_p(inb_p(<span class="hljs-number">0x21</span>)&amp;<span class="hljs-number">0xfd</span>,<span class="hljs-number">0x21</span>);
	a=inb_p(<span class="hljs-number">0x61</span>);
	outb_p(a|<span class="hljs-number">0x80</span>,<span class="hljs-number">0x61</span>);
	outb(a,<span class="hljs-number">0x61</span>);
}</code></pre><p>åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°æœ€é‡è¦çš„å†…å®¹å°±æ˜¯<strong>è®¾ç½®é”®ç›˜ä¸­æ–­é™·é˜±é—¨</strong>äº†ã€‚</p>
<p>ä¹‹ååªæœ‰é™é™åœ°ç­‰å¾…é”®ä½æ•²å‡»ï¼Œä¹Ÿå°±èƒ½å¤Ÿäº§ç”Ÿç¡¬ä»¶ä¸­æ–­ï¼Œä»è€Œè®© <code>read_q</code> è·å¾—åˆ°ç›¸åº”çš„å­—ç¬¦è¾“å…¥ã€‚</p>
<p>è‡³äºé”®ç›˜ä¸­æ–­çš„ç›¸åº”å¤„ç†æµç¨‹ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚ç®€è¿°ä¸€äº›æ­¥éª¤:</p>
<ol>
<li>
<p>äº§ç”Ÿç¡¬ä¸­æ–­ <code>keyboard_interrupt</code>ï¼Œç”±ç¨‹åº <code>Keyboard.s</code> çš„æ±‡ç¼–ä»£ç è¿›è¡Œå¤„ç†</p>
</li>
<li>
<p>æ ¹æ®ä¸åŒçš„é”®ç›˜(US é”®ç›˜ã€å¾·å¼é”®ç›˜ç­‰ç­‰)å°†è·å¾—çš„é”®ä½ä¿¡å·è¿›è¡Œç›¸åº”çš„å­—ç¬¦è½¬æ¢(æŸ¥è½¬æ¢è¡¨)</p>
</li>
<li>
<p>è°ƒç”¨ <code>do_tty_interrupt</code> å¤„ç†å‡½æ•° (ç¡®è®¤æ˜¯ç»™å“ªä¸ªç»ˆç«¯çš„ä¿¡å·)</p>
</li>
<li>
<p>è°ƒç”¨ <code>copy_to_cooked(tty)</code> ï¼Œå³å®Œæˆ <code>read_q</code> åˆ° <code>secondary</code> çš„ç›¸å…³åŠ å·¥ã€‚</p>
</li>
</ol>
<pre><code class="hljs">__                    __                  
 / _| __ _ _ __   __ _ / _| ___ _ __   __ _ 
| |_ / _` | '_ \ / _` | |_ / _ \ '_ \ / _` |
|  _| (_| | | | | (_| |  _|  __/ | | | (_| |
|_|  \__,_|_| |_|\__, |_|  \___|_| |_|\__, |
                 |___/                |___/</code></pre></div></main><footer class="footer">ffutop Â© <!-- -->2019<!-- -->, Built with<a href="https://reactjs.org/">React</a></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{}},"page":"/post","query":{"fullUrl":"/2018-12-28-understand-Kernel-7"},"buildId":"xx4WXnl7odya2QE7dUtyW","dynamicBuildId":false,"assetPrefix":"https://www.ffutop.com/blog","nextExport":true}</script><script async="" id="__NEXT_PAGE__/post" src="https://www.ffutop.com/blog/_next/static/xx4WXnl7odya2QE7dUtyW/pages/post.js"></script><script async="" id="__NEXT_PAGE__/_app" src="https://www.ffutop.com/blog/_next/static/xx4WXnl7odya2QE7dUtyW/pages/_app.js"></script><script src="https://www.ffutop.com/blog/_next/static/runtime/webpack-8ed9452df514b4d17d80.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/chunks/commons.966200943f7869d2249d.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/chunks/styles.2d2aeb3a0a1eb931bc6e.js" async=""></script><script src="https://www.ffutop.com/blog/_next/static/runtime/main-3daabeb1dde7624c7fe0.js" async=""></script></body></html>