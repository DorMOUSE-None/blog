(window.webpackJsonp=window.webpackJsonp||[]).push([["98d3"],{"5DNh":function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p><a href="https://dormouse-none.github.io/2018-10-14-understand-Kernel-5/">å‰ä¸€ç¯‡</a>å·²ç»æè¿°å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œäº†å®è§‚æ€§çš„æè¿°ï¼Œè¿™ä¸€ç¯‡ï¼Œå°†ä»¥ç‰¹å®šçš„æ–‡ä»¶è¯»å†™æ“ä½œä¸ºç¤ºä¾‹ï¼Œä¸²è”å¯¹æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬æ“ä½œã€‚</p>\n<p>é¦–å…ˆå…ˆæ¥çœ‹çœ‹å¹³å°ç›¸å…³çš„æ–‡ä»¶è¯»å†™æ“ä½œçš„ C ä»£ç æ˜¯æ€æ ·ä¸€ä¸ªè°ƒç”¨æ–¹å¼</p>\n<pre><code class="language-c">#include &#x3C;stdio.h>\n#include &#x3C;stdlib.h>\n#include &#x3C;string.h>\n#include &#x3C;unistd.h>\n#include &#x3C;fcntl.h>\n#include &#x3C;errno.h>\n#include &#x3C;sys/types.h>\n#include &#x3C;sys/stat.h>\n\nint panic()\n{\n    fprintf(stderr, "%s (errno=%d)\\n", strerror(errno), errno);\n    return -1;\n}\n\nint main(int argc, char *argv[])\n{\n    /* æ‰“å¼€æ–‡ä»¶ frw.txt (ä»¥å¯è¯»å†™ | è‹¥ä¸å­˜åœ¨åˆ™æ–°å»ºçš„å½¢å¼) */\n    int fd = open("/root/frw.txt", O_RDWR | O_CREAT);\n    if (fd == -1)\n        return panic();\n\n    /* å‘æ–‡ä»¶å†™å…¥ Hello World! å…±è®¡ 12 ä¸ªå­—ç¬¦ */\n    ssize_t wsize = write(fd, "Hello World!", 12);\n    if (wsize == -1)\n        return panic();\n\n    /* é‡å®šä½æ–‡ä»¶è¯»å†™æŒ‡é’ˆ */\n    off_t off = lseek(fd, 0, SEEK_SET);\n    if (off == -1)\n        return panic();\n\n    char* buf = (char *) malloc(wsize);\n    /* è¯»å–æ–‡ä»¶å†…å®¹ */\n    ssize_t rsize = read(fd, buf, wsize);\n    if (rsize == -1)\n        return panic();\n\n    printf("%s\\n", buf);\n    free(buf);\n    /* å…³é—­æ–‡ä»¶ */\n    int stat = close(fd);\n    if (stat == -1)\n        return panic();\n\n    return 0;\n}\n</code></pre>\n<h2>é«˜é€Ÿç¼“å†²åŒºåˆå§‹åŒ–</h2>\n<p>ä¸Šä¸€ç¯‡å·²ç»æè¿°è¿‡äº†ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„ã€åŒ…æ‹¬æ•°æ®ï¼Œéƒ½æ˜¯æŒä¹…åŒ–åœ°å­˜å‚¨åœ¨å­˜å‚¨è®¾å¤‡ä¸­çš„ã€‚</p>\n<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬åº”è¯¥ä¹Ÿéšçº¦çš„äº†è§£å¦ä¸€ä¸ªäº‹å®ï¼Œæ–‡ä»¶è¯»å†™æ“ä½œå¹¶ä¸ä¼šç›´æ¥æ“ä½œå­˜å‚¨è®¾å¤‡ä¸Šçš„æ•°æ®ï¼Œè€Œæ˜¯å…ˆç»è¿‡ä¸€ä¸ªç§°ä¹‹ä¸ºé«˜é€Ÿç¼“å†²çš„å†…å­˜åŒºåŸŸã€‚</p>\n<p>é‚£ä¹ˆï¼Œé«˜é€Ÿç¼“å†²æ˜¯ä»€ä¹ˆ? ç©¶ç«Ÿæ‰¿æ‹…ä»€ä¹ˆå·¥ä½œ? å…ˆæ¥çœ‹çœ‹å®ƒçš„åˆå§‹åŒ–æµç¨‹å§ã€‚</p>\n<p>é¦–å…ˆå›åˆ° <code>main.c</code> (å†…æ ¸ä»£ç çš„ä¸»å‡½æ•°)</p>\n<pre><code class="language-c">void main(void) \n{\n    ROOT_DEV = ORIG_ROOT_DEV;\n    drive_info = DRIVE_INFO;\n    memory_end = (1&#x3C;&#x3C;20) + (EXT_MEM_K&#x3C;&#x3C;10);\n    memory_end &#x26;= 0xfffff000;\n    if (memory_end > 16*1024*1024)\n        memory_end = 16*1024*1024;\n    if (memory_end > 12*1024*1024)\n        buffer_memory_end = 4*1024*1024;\n    else if (memory_end > 6*1024*1024)\n        buffer_memory_end = 2*1024*1024;\n    else\n        buffer_memory_end = 1*1024*1024;\n    main_memory_start = buffer_memory_end;\n#ifdef RAMDISK\n    main_memory_start += rd_init(main_memory_start, RAMDISK*1024);\n#endif\n    mem_init(main_memory_start,memory_end);\n    trap_init();\n    blk_dev_init();\n    chr_dev_init();\n    tty_init();\n    time_init();\n    sched_init();                       // ç¬¬å››ç¯‡å·²ç»è®²è¿‡ï¼Œè´Ÿè´£ä»»åŠ¡è°ƒåº¦æ¨¡å—çš„åˆå§‹åŒ–\n    buffer_init(buffer_memory_end);     // æœ¬ç¯‡çš„èµ·å§‹ï¼Œè´Ÿè´£ç¼“å†²åŒºçš„åˆå§‹åŒ–\n    hd_init();\n    floppy_init();\n    sti();\n    move_to_user_mode();\n    if (!fork()) {      /* we count on this going ok */\n        init();\n    }\n    for(;;) pause();\n}\n</code></pre>\n<p><code>buffer_init(buffer_memory_end);</code> ç”¨æ¥åˆå§‹åŒ–ç¼“å†²åŒºã€‚æ­¤å¤„æœ‰å‡ ä¸ªåŸå› :</p>\n<ol>\n<li>\n<p>CPU è¯»å†™æ“ä½œå¦‚æœç›´æ¥æ“ä½œå¤–å­˜ï¼Œé€Ÿåº¦ä¸Šæ˜¯ä¸€ä¸ªæå¤§çš„è€ƒéªŒã€‚æ¯•ç«Ÿå†…å­˜å·²ç»è¾ƒä¹‹ CPU é€Ÿåº¦æ…¢ï¼Œå¤–å­˜çš„è¯»å†™é€Ÿåº¦å°±æ›´æ…¢äº†ã€‚</p>\n</li>\n<li>\n<p>è§£è€¦ï¼Œå…¶å®è¯»å†™æ“ä½œå¹¶ä¸ä»…ä»…å‘ç”Ÿåœ¨å¤–å­˜(å—å­˜å‚¨è®¾å¤‡)ï¼ŒåŒæ ·çš„ï¼Œå­—ç¬¦è®¾å¤‡ç­‰ç­‰ä¹Ÿéƒ½ä¼šéœ€è¦è¯»å†™æ“ä½œï¼Œå¢åŠ ä¸­é—´å±‚å¯ä»¥å°è£…å˜åŒ–ã€‚</p>\n</li>\n<li>\n<p>æ›´å¤šï¼Œä¸ªäººäº†è§£æœ‰é™...</p>\n</li>\n</ol>\n<pre><code class="language-c">struct buffer_head {\n char * b_data;\n unsigned long b_blocknr;\n unsigned short b_dev;\n unsigned char b_uptodate;\n unsigned char b_dirt;\n unsigned char b_count;\n unsigned char b_lock;\n struct task_struct * b_wait;\n struct buffer_head * b_prev;\n struct buffer_head * b_next;\n struct buffer_head * b_prev_free;\n struct buffer_head * b_next_free;\n};\n\n/* from fs/buffer.c */\nvoid buffer_init(long buffer_end)\n{\n    struct buffer_head * h = start_buffer;\n    void * b;\n    int i;\n\n    if (buffer_end == 1&#x3C;&#x3C;20)\n        b = (void *) (640*1024);\n    else\n        b = (void *) buffer_end;\n    while ( (b -= BLOCK_SIZE) >= ((void *) (h+1)) ) {\n        h->b_dev = 0;\n        h->b_dirt = 0;\n        h->b_count = 0;\n        h->b_lock = 0;\n        h->b_uptodate = 0;\n        h->b_wait = NULL;\n        h->b_next = NULL;\n        h->b_prev = NULL;\n        h->b_data = (char *) b;\n        h->b_prev_free = h-1;\n        h->b_next_free = h+1;\n        h++;\n        NR_BUFFERS++;\n        /* è·³è¿‡ 640K ~ 1M çš„æ˜¾å­˜å’Œ BIOS RAM éƒ¨åˆ† */\n        if (b == (void *) 0x100000)\n            b = (void *) 0xA0000;\n    }\n    h--;\n    free_list = start_buffer;\n    free_list->b_prev_free = h;\n    h->b_next_free = free_list;\n    for (i=0;i&#x3C;NR_HASH;i++)\n        hash_table[i]=NULL;\n}\n</code></pre>\n<p>ç¼“å†²å—çš„æ‰€æœ‰å…³é”®ä¿¡æ¯éƒ½ç”± <code>buffer_head</code> æ•°æ®ç»“æ„è¿›è¡Œè®°å½•, è‡³äºæœ‰å¤šå°‘ä¸ª <code>buffer_head</code>? åªèƒ½è¯´èƒ½åˆ’åˆ†å¤šå°‘å°±åˆ’åˆ†å¤šå°‘ã€‚</p>\n<p>æ¯”è¾ƒç›´è§‚çš„ç»“æ„ä¿¡æ¯å¦‚ä¸‹</p>\n<p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fwy2iag1exj31kw0k1dgb.jpg"></p>\n<p>åœ¨ <code>main.c</code> ä¸­å·²ç»æå‰ç¡®è®¤äº†å†…æ ¸ç¨‹åºå ç”¨å†…å­˜çš„å¤§å°ï¼Œç¼“å†²åŒºå¤§å°ä»¥åŠä¸»å†…å­˜å¤§å°ã€‚</p>\n<p>åœ¨é«˜é€Ÿç¼“å†²åŒºçš„å¼€å§‹ä½ç½®ï¼Œéƒ½ç”¨æ¥å­˜å‚¨ <code>buffer_head</code> çš„ä¿¡æ¯ï¼Œä¸æ¯ä¸ªç¼“å†²å—(ä»ç¼“å†²åŒºç»“æŸä½ç½®å¼€å§‹åˆ†é…)ä¸€ä¸€å¯¹åº”ï¼Œç›´åˆ°ä¸­é—´æŸä¸ªä½ç½®ä¸è¶³ä»¥åˆ†é…ç¼“å†²å—ä¸ºæ­¢ã€‚</p>\n<p>å¦å¤–çš„ä¿¡æ¯ï¼Œå°±æ˜¯å¯ä»¥çœ‹åˆ°ä¸€ä¸ª <code>hash_table</code> æ•°æ®ç»“æ„äº†ã€‚</p>\n<p>åº”è¯¥éƒ½èƒ½å¤Ÿæƒ³è±¡ï¼Œæ¯ä¸ªç¼“å­˜å—ä¸å¤–å­˜ä¸­çš„æ•°æ®å—ç›¸å¯¹åº”ï¼Œé€šè¿‡è®¾å¤‡å· + æ•°æ®å—å·è¿›è¡Œå”¯ä¸€å®šä½ã€‚ä½†æ˜¯ï¼Œå¦‚ä½•å¿«é€ŸæŸ¥æ‰¾éœ€è¦æ“ä½œçš„æ•°æ®å—æ˜¯å¦å·²ç»å­˜åœ¨ä¸é«˜é€Ÿç¼“å­˜ä¸­äº†å‘¢? æ˜¾ç„¶ç›´æ¥éå†æŸ¥æ‰¾æ˜¯ä¸å¤ªå¯é çš„åŠæ³•ã€‚é‡‡ç”¨å¼€æ”¾åœ°å€æ³•çš„å“ˆå¸Œè¡¨èƒ½å¤ŸååŠ©å¿«é€Ÿå®šä½ç¼“å†²å—ã€‚</p>\n<h2>æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ</h2>\n<p>æ—¢ç„¶é«˜é€Ÿç¼“å†²åŒºéƒ½å‡†å¤‡å°±ç»ªäº†ï¼Œé‚£ä¹ˆæ–‡ä»¶ç³»ç»Ÿæ˜¯å¦å·²ç»æŒ‚è½½äº†å‘¢? å¾ˆé—æ†¾ï¼ŒçŸ¥é“ <code>main()</code> è°ƒç”¨ <code>init()</code> å‡½æ•°ä¹‹å‰ï¼Œæ–‡ä»¶ç³»ç»Ÿä¾ç„¶æ²¡æœ‰æŒ‚è½½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒCPU ä»ç„¶åªèƒ½é€šè¿‡åŸºæœ¬è¾“å…¥è¾“å‡ºå¯¹å­˜å‚¨è®¾å¤‡è¿›è¡Œç›¸å½“åˆçº§çš„ IO æ“ä½œã€‚</p>\n<p>é‚£ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™æ‰èƒ½å»æŒ‚è½½æ ¹ç›®å½•å‘¢?</p>\n<pre><code class="language-c">/* from init/main.c */\n/* ç”± main() è§¦å‘ */\nvoid init(void)\n{\n    int pid,i;\n    /* è¿™æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€ç¯äº†ï¼Œå¼€å§‹æŒ‚è½½çš„èµ·å§‹åŠ¨ä½œ */\n    setup((void *) &#x26;drive_info);\n    ...\n}\n</code></pre>\n<p><code>setup</code> å‡½æ•°åšäº†ä»€ä¹ˆå‘¢ï¼Ÿè¿™æ˜¯ä¸€ä¸ªå†…åµŒæ±‡ç¼–ï¼Œä¸»è¦åšçš„å°±æ˜¯è§¦å‘ç³»ç»Ÿè°ƒç”¨ <code>int 0x80</code></p>\n<pre><code class="language-asm">__inline__ int setup(void * BIOS) { \n    long __res; \n    __asm__ volatile (\n            "int $0x80" \n            : "=a" (__res) \n            : "0" (0),"b" ((long)(BIOS))\n    ); \n    if (__res >= 0) \n        return (int) __res; \n    errno = -__res; \n    return -1; \n}\n</code></pre>\n<p>å…¶ä¸­çœ‹åˆ°ç»™å‡ºçš„ <code>EAX = 0</code>, æŸ¥è¡¨(è¡¨åœ¨ <code>include/linux/sys.h</code> é‡Œ) å¯ä»¥çŸ¥é“è§¦å‘çš„æ˜¯ <code>sys_setup</code> å‡½æ•°(å‡½æ•°ä½äº <code>kernel/blk_drv/hd.c</code>)</p>\n<pre><code class="language-c">/* This may be used only once, enforced by \'static int callable\' */\nint sys_setup(void * BIOS)\n{\n    static int callable = 1;\n    int i,drive;\n    unsigned char cmos_disks;\n    struct partition *p;\n    struct buffer_head * bh;\n\n    /* setup åªå…è®¸è¢«è°ƒç”¨ä¸€æ¬¡ */\n    if (!callable)\n        return -1;\n    callable = 0;\n    /* å¯ä»¥å¼ºåˆ¶åœ¨æºç ä¸­æŒ‡å®šç¡¬ç›˜å‚æ•°, æ‰€ä»¥åŠ äº†å®å®šä¹‰ä½œåˆ¤æ–­*/\n#ifndef HD_TYPE\n    for (drive=0 ; drive&#x3C;2 ; drive++) {\n        hd_info[drive].cyl = *(unsigned short *) BIOS;\n        hd_info[drive].head = *(unsigned char *) (2+BIOS);\n        hd_info[drive].wpcom = *(unsigned short *) (5+BIOS);\n        hd_info[drive].ctl = *(unsigned char *) (8+BIOS);\n        hd_info[drive].lzone = *(unsigned short *) (12+BIOS);\n        hd_info[drive].sect = *(unsigned char *) (14+BIOS);\n        BIOS += 16;\n    }\n    if (hd_info[1].cyl)\n        NR_HD=2;\n    else\n        NR_HD=1;\n#endif\n    for (i=0 ; i&#x3C;NR_HD ; i++) {\n        hd[i*5].start_sect = 0;\n        hd[i*5].nr_sects = hd_info[i].head*\n                hd_info[i].sect*hd_info[i].cyl;\n    }\n\n    /*\n        We querry CMOS about hard disks : it could be that\n        we have a SCSI/ESDI/etc controller that is BIOS\n        compatable with ST-506, and thus showing up in our\n        BIOS table, but not register compatable, and therefore\n        not present in CMOS.\n\n        Furthurmore, we will assume that our ST-506 drives\n        &#x3C;if any> are the primary drives in the system, and\n        the ones reflected as drive 1 or 2.\n\n        The first drive is stored in the high nibble of CMOS\n        byte 0x12, the second in the low nibble.  This will be\n        either a 4 bit drive type or 0xf indicating use byte 0x19\n        for an 8 bit type, drive 1, 0x1a for drive 2 in CMOS.\n\n        Needless to say, a non-zero value means we have\n        an AT controller hard disk for that drive.\n\n\n    */\n\n    if ((cmos_disks = CMOS_READ(0x12)) &#x26; 0xf0)\n        if (cmos_disks &#x26; 0x0f)\n            NR_HD = 2;\n        else\n            NR_HD = 1;\n    else\n        NR_HD = 0;\n    for (i = NR_HD ; i &#x3C; 2 ; i++) {\n        hd[i*5].start_sect = 0;\n        hd[i*5].nr_sects = 0;\n    }\n    /* æ›´è¿›ä¸€æ­¥è®¾ç½®æ¯ä¸ªç›˜çš„å‚æ•° */\n    for (drive=0 ; drive&#x3C;NR_HD ; drive++) {\n        /* 0x300 å’Œ 0x305 åˆ†åˆ«ä»£è¡¨ä¸¤ä¸ªç¡¬ç›˜ */\n        /* è¯»å–æ¯ä¸ªç¡¬ç›˜çš„ç¬¬ä¸€å—æ•°æ® (1024B) */\n        if (!(bh = bread(0x300 + drive*5,0))) {\n            printk("Unable to read partition table of drive %d\\n\\r",\n                drive);\n            panic("");\n        }\n        /* åˆ¤æ–­ç¡¬ç›˜æœ‰æ•ˆæ€§ */\n        if (bh->b_data[510] != 0x55 || (unsigned char)\n            bh->b_data[511] != 0xAA) {\n            printk("Bad partition table on drive %d\\n\\r",drive);\n            panic("");\n        }\n        /* è¯»å–åˆ†åŒºè¡¨ (ä½äº å¼•å¯¼æ‰‡åŒºç¬¬ 446 å­—èŠ‚å¼€å§‹å¤„ */\n        p = 0x1BE + (void *)bh->b_data;\n        for (i=1;i&#x3C;5;i++,p++) {\n            hd[i+5*drive].start_sect = p->start_sect;\n            hd[i+5*drive].nr_sects = p->nr_sects;\n        }\n        brelse(bh);\n    }\n    if (NR_HD)\n        printk("Partition table%s ok.\\n\\r",(NR_HD>1)?"s":"");\n    rd_load();              /* å°è¯•åˆ›å»ºå¹¶åŠ è½½è™šæ‹Ÿç›˜ */\n    mount_root();           /* mount æ ¹æ–‡ä»¶ç³»ç»Ÿ */\n    return (0);\n}\n</code></pre>\n<p>ç»ˆäºåˆ°äº†æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™äº†</p>\n<p><code>mount_root</code> ç”¨æ¥åšåˆçº§çš„åˆå§‹åŒ–å·¥ä½œã€‚åŒæ—¶ï¼Œä¸Šä¸€èŠ‚å·²ç»æè¿°è¿‡äº†ï¼Œå­˜å‚¨è®¾å¤‡çš„è¶…çº§å—æ˜¯ç”¨äº†è®°å½•æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿæœ€é‡è¦çš„ç»“æ„ã€‚</p>\n<p>é‚£ä¹ˆé€šè¿‡å°†è¶…çº§å—çš„ä¿¡æ¯è¯»å–åˆ°å†…å­˜ï¼Œä¹Ÿå°±å¯ä»¥å°†å†…å­˜ä¸å¤–å­˜çš„æ–‡ä»¶ç³»ç»Ÿç›¸äº’è”ç³»èµ·æ¥äº†ã€‚</p>\n<p>ä¸‹é¢è¿™æ®µä»£ç æœ€é‡è¦çš„å†…å®¹å°±æ˜¯ <code>read_super()</code> å‡½æ•°äº† .</p>\n<pre><code class="language-c">void mount_root(void)\n{\n    int i,free;\n    struct super_block * p;\n    struct m_inode * mi;\n\n    if (32 != sizeof (struct d_inode))\n        panic("bad i-node size");\n    /* å…ˆåˆå§‹åŒ–æ–‡ä»¶è¡¨ï¼Œè¯¥ç‰ˆæœ¬æ“ä½œç³»ç»Ÿé™åˆ¶æœ€å¤§åŒæ—¶æ‰“å¼€ NR_FILE(64ä¸ª) æ–‡ä»¶ */\n    for(i=0;i&#x3C;NR_FILE;i++)\n        /* f_count = 0 è¡¨æ˜æ²¡æœ‰è¢«å¼•ç”¨ */\n        file_table[i].f_count=0;\n    /* å¦‚æœå¼•å¯¼ç›˜æ˜¯è½¯ç›˜çš„è¯ï¼Œæç¤ºæ’å…¥æ ¹æ–‡ä»¶ç³»ç»Ÿç›˜ */\n    if (MAJOR(ROOT_DEV) == 2) {\n        printk("Insert root floppy and press ENTER");\n        wait_for_keypress();\n    }\n    /* åˆå§‹åŒ–å†…å­˜è¶…çº§å—æ•°æ®ç»“æ„ (æ€»å…± 8 ä¸ª) */\n    for(p = &#x26;super_block[0] ; p &#x3C; &#x26;super_block[NR_SUPER] ; p++) {\n        p->s_dev = 0;\n        p->s_lock = 0;\n        p->s_wait = NULL;\n    }\n    /* Hint: è¯»å–è¶…çº§å—çš„ä¿¡æ¯ï¼ŒæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿé‡è¦çš„éƒ¨åˆ†(ä»£ç è¯·å¾€ä¸‹ç¿») */\n    if (!(p=read_super(ROOT_DEV)))\n        panic("Unable to mount root");\n    /* è¯»å–æ–‡ä»¶ç³»ç»Ÿçš„ 1 å·ièŠ‚ç‚¹ (å³è¯¥è®¾å¤‡ä¸Šæ–‡ä»¶ç³»ç»Ÿçš„æ ¹èŠ‚ç‚¹) */\n    if (!(mi=iget(ROOT_DEV,ROOT_INO)))\n        panic("Unable to read root i-node");\n    mi->i_count += 3 ;  /* NOTE! it is logically used 4 times, not 1 */\n    p->s_isup = p->s_imount = mi;\n    /* åº”è¯¥è¿˜è®°å¾—å§ï¼Œcurrent æŒ‡çš„æ˜¯å½“å‰çš„ä»»åŠ¡(ä»»åŠ¡1)ï¼Œä»¥åæ‰€æœ‰çš„ä»»åŠ¡éƒ½ä¼šç”±ä»»åŠ¡1æˆ–ä»»åŠ¡1çš„å­ä»»åŠ¡è¿›è¡Œæ´¾ç”Ÿï¼Œä¹Ÿå°±æ„å‘³ç€ current->root ä¼šä¸€ç›´å¤åˆ¶è¿‡å»\n     * åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œåº”è¯¥è®¤ä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿä»¥åŠè¢«æŒ‚è½½äº†ã€‚æ˜¯ä¸æ˜¯è·Ÿè¢«è€äº†ä¸€æ ·?\n     */\n    current->pwd = mi;\n    current->root = mi;\n    free=0;\n    i=p->s_nzones;\n    /* ç»Ÿè®¡è¿˜æœ‰å¤šå°‘ç©ºé—²æ•°æ®å—ä»¥åŠå¤šå°‘å¯ç”¨ièŠ‚ç‚¹ (é™„ä¸Šä¸€å¼ å¯åŠ¨è¿‡ç¨‹ä¸­æ‰“å°çš„ä¿¡æ¯) */\n    while (-- i >= 0)\n        if (!set_bit(i&#x26;8191,p->s_zmap[i>>13]->b_data))\n            free++;\n    printk("%d/%d free blocks\\n\\r",free,p->s_nzones);\n    free=0;\n    i=p->s_ninodes+1;\n    while (-- i >= 0)\n        if (!set_bit(i&#x26;8191,p->s_imap[i>>13]->b_data))\n            free++;\n    printk("%d/%d free inodes\\n\\r",free,p->s_ninodes);\n}\n</code></pre>\n<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwz8kvvgbpj30l006i3yb.jpg"></p>\n<p>é‡è¦è¦çš„éƒ¨åˆ†ï¼Œ<code>read_super(int dev)</code>ï¼Œç”¨äºè¯»å–è¶…çº§å—çš„æ•°æ®</p>\n<pre><code class="language-c">static struct super_block * read_super(int dev)\n{\n    struct super_block * s;\n    struct buffer_head * bh;\n    int i,block;\n\n    if (!dev)\n        return NULL;\n    check_disk_change(dev);\n    /* å¦‚æœè¯¥è¶…çº§å—å·²ç»åœ¨å†…å­˜ä¸­äº†ï¼Œé‚£ä¹ˆå°±ç›´æ¥ä½¿ç”¨ (å’Œè¿™é‡ŒæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æµç¨‹æ— å…³) */\n    if (s = get_super(dev))\n        return s;\n    /* è®¾å¤‡è¶…çº§å—ä¸åœ¨å†…å­˜ä¸­ï¼Œå°±å…ˆæ‰¾ä¸€ä¸ªç©ºé—²çš„å†…å­˜è¶…çº§å— (æ€»å…±ç»´æŠ¤ 8 ä¸ªè¶…çº§å—æ•°æ®ç»“æ„) */\n    for (s = 0+super_block ;; s++) {\n        if (s >= NR_SUPER+super_block)\n            return NULL;\n        if (!s->s_dev)\n            break;\n    }\n    s->s_dev = dev;\n    s->s_isup = NULL;\n    s->s_imount = NULL;\n    s->s_time = 0;\n    s->s_rd_only = 0;\n    s->s_dirt = 0;\n    lock_super(s);\n    /* é€šè¿‡ block read è¯»å–è®¾å¤‡ç¬¬ä¸€ä¸ªç‰©ç†å— (æ¯ä¸ªç‰©ç†å— 1024 B) */\n    if (!(bh = bread(dev,1))) {\n        s->s_dev=0;\n        free_super(s);\n        return NULL;\n    }\n    /* å¤åˆ¶ä¸€ä»½è¶…çº§å—çš„æ•°æ® */\n    *((struct d_super_block *) s) =\n        *((struct d_super_block *) bh->b_data);\n    /* é‡Šæ”¾ç¼“å†²åŒºçš„æ•°æ® */\n    brelse(bh);\n    /* éªŒè¯é­”æ•°, è¯¥ç‰ˆæœ¬æ“ä½œç³»ç»Ÿåªæ”¯æŒ 1.0 ç‰ˆ Minix æ–‡ä»¶ç³»ç»Ÿï¼Œé­”æ•° 0x137F */\n    if (s->s_magic != SUPER_MAGIC) {\n        s->s_dev = 0;\n        free_super(s);\n        return NULL;\n    }\n    /* å…ˆæ¸…ç©ºå†…å­˜ä¸­çš„æ•°æ® */\n    for (i=0;i&#x3C;I_MAP_SLOTS;i++)\n        s->s_imap[i] = NULL;\n    for (i=0;i&#x3C;Z_MAP_SLOTS;i++)\n        s->s_zmap[i] = NULL;\n    block=2;\n    /* è¯»å– i èŠ‚ç‚¹ä½å›¾å— */\n    for (i=0 ; i &#x3C; s->s_imap_blocks ; i++)\n        if (s->s_imap[i]=bread(dev,block))\n            block++;\n        else\n            break;\n    /* è¯»å–æ•°æ®å—ä½å›¾ */\n    for (i=0 ; i &#x3C; s->s_zmap_blocks ; i++)\n        if (s->s_zmap[i]=bread(dev,block))\n            block++;\n        else\n            break;\n    if (block != 2+s->s_imap_blocks+s->s_zmap_blocks) {\n        for(i=0;i&#x3C;I_MAP_SLOTS;i++)\n            brelse(s->s_imap[i]);\n        for(i=0;i&#x3C;Z_MAP_SLOTS;i++)\n            brelse(s->s_zmap[i]);\n        s->s_dev=0;\n        free_super(s);\n        return NULL;\n    }\n    s->s_imap[0]->b_data[0] |= 1;\n    s->s_zmap[0]->b_data[0] |= 1;\n    /* ä¸å‰é¢çš„ wait_on_super() å¯¹åº”(è§£å¼€lockæ ‡å¿—) */\n    free_super(s);\n    return s;\n}\n</code></pre>\n<p>æ˜¯ä¸æ˜¯è§‰å¾—ä¹Ÿæ²¡ä»€ä¹ˆï¼Œå°±è¿™æ ·æ ¹æ–‡ä»¶ç³»ç»Ÿå·²ç»æŒ‚è½½äº†? æ¯«æ— å®æ„Ÿæ˜¯å§ã€‚</p>\n<h2>Extra: æ™®é€šæŒ‚è½½</h2>\n<p>æ—¢ç„¶è®²è¿‡äº†æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ã€‚é‚£å°±é¡ºå¸¦ç€è®²è®²æ™®é€šæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½å§ã€‚</p>\n<p>ç›¸ä¿¡ä»å‘½ä»¤ä¸Šæ¥è®²åº”è¯¥æ¯”è¾ƒç®€å•ä¹Ÿæ¯”è¾ƒç†Ÿæ‚‰å§ã€‚<code>mount disk.img /mnt</code> ä¹Ÿç®—æ˜¯æŒ‚è½½åˆ° /mnt ä¸‹äº†</p>\n<p>ä½†æ˜¯ï¼Œç©¶ç«Ÿæ˜¯æ€ä¹ˆå®ç°çš„å‘¢?</p>\n<pre><code class="language-c">int sys_mount(char * dev_name, char * dir_name, int rw_flag)\n{\n    struct m_inode * dev_i, * dir_i;\n    struct super_block * sb;\n    int dev;\n\n    /** \n     * çœç•¥å¤§éƒ¨åˆ†åˆ¤æ–­é€»è¾‘, ä¸»è¦å°±æ˜¯:\n     * 1. åˆ¤æ–­ dev_name æ‰€å±çš„è®¾å¤‡å·ï¼Œè¯»å–è¯¥è®¾å¤‡ä¸Šçš„è¶…çº§å—\n     * 2. è¯»å– dir_name (éœ€è¦æŒ‚è½½åˆ°çš„ä½ç½®)ï¼Œåˆ¤å®šæ˜¯å¦å…è®¸è¢«æŒ‚è½½(æ¯”å¦‚æ ¹èŠ‚ç‚¹ä¸å…è®¸æŒ‚å…¶å®ƒè®¾å¤‡)\n     */\n    ...\n\n    /* è®¾ç½®è¶…çº§å—çš„ mount æ ‡å¿— */\n    sb->s_imount=dir_i;\n    /* è®¾ç½®è¯¥ i èŠ‚ç‚¹çš„ mount æ ‡å¿— */\n    dir_i->i_mount=1;\n    dir_i->i_dirt=1;        /* NOTE! we don\'t iput(dir_i) */\n    return 0;           /* we do that in umount */\n}\n</code></pre>\n<h2>æ–‡ä»¶è¯»å†™</h2>\n<p>å‰é¢è®²äº†è¿™ä¹ˆå¤šï¼Œç»ˆäºåˆ°äº†æœ€å…³å¿ƒçš„éƒ¨åˆ†äº†ã€‚å½“ç„¶ï¼Œä¹Ÿå¹¶ä¸æ˜¯è¯´å‰é¢çš„å†…å®¹ä¸é‡è¦ï¼Œäº‹å®ä¸Šï¼Œç›¸å½“é‡è¦ï¼Œåªæ˜¯éƒ½éšè—åœ¨äº†å†…æ ¸å¼•å¯¼çš„è¿‡ç¨‹ä¸­ï¼Œä¸”è°ƒç”¨é¢‘åº¦ä½ï¼Œæ‰å¯¼è‡´äº†æ²¡æœ‰å­˜åœ¨æ„Ÿã€‚ä½†æ˜¯è¿™æ°æ°æ‰æ˜¯æ”¯æŒæ–‡ä»¶è¯»å†™çš„åŸºçŸ³ã€‚</p>\n<p>ä¸å¤šè¯´åºŸè¯ï¼Œä¸‹é¢å°±è¦å¼€å§‹æ–‡ä»¶è¯»å†™çš„å†…å®¹ã€‚</p>\n<h3>æ‰“å¼€æ–‡ä»¶</h3>\n<p>æ‰“å¼€æ–‡ä»¶çš„å‡½æ•°åŸå‹æ˜¯ <code>int open(const char * filename, int flag, ...);</code></p>\n<p>å½“ç„¶ï¼Œæ­¤ç±»ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆçš„å®ç°éƒ½æ˜¯ <code>int 0x80</code> , æ˜ç¡®ä¸€ä¸ªè°ƒç”¨å·ï¼Œç„¶åå°±é™·å…¥å†…æ ¸æ€äº†ã€‚</p>\n<p>å†…æ ¸æ€ä¸‹è°ƒç”¨çš„å‡½æ•°æ˜¯: <code>int sys_open(const char * filename,int flag,int mode)</code> </p>\n<p>æ¥çœ‹çœ‹ç»†èŠ‚:</p>\n<pre><code class="language-c">int sys_open(const char * filename,int flag,int mode)\n{\n    struct m_inode * inode;\n    struct file * f;\n    int i,fd;\n\n    /*\n     * current æ˜¯ç”±å†…æ ¸æ•°æ®æ®µç»´æŠ¤çš„å½“å‰ä»»åŠ¡çš„æŒ‡é’ˆ\n     * umask æ˜¯æŒ‡å½“å‰ä»»åŠ¡åœ¨æ–°å»ºæ–‡ä»¶æ—¶çš„é»˜è®¤æ©ç \n     *   ä¾‹å¦‚ Linux é»˜è®¤æ˜¯ 022, å³æ–°å»ºæ–‡ä»¶è¢«ç¦æ­¢äº†ç»„ç”¨æˆ·ä¸å…¶å®ƒç”¨æˆ·çš„å†™æƒé™\n     * è¿™é‡Œæ˜¯å…ˆç¡®å®šæ–°å»ºæ–‡ä»¶çš„æƒé™\n     */\n    mode &#x26;= 0777 &#x26; ~current->umask;\n    /*\n     * æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¯ä¸ªæ–‡ä»¶å•ç‹¬ç»´æŠ¤ä¸€å¥—ï¼Œä»¥æ•°å­—æ ‡è®°\n     * æ‰¾ä¸€ä¸ªç©ºé—²çš„æ–‡ä»¶æè¿°ç¬¦é¡¹\n     */\n    for(fd=0 ; fd&#x3C;NR_OPEN ; fd++)\n        if (!current->filp[fd])\n            break;\n    if (fd>=NR_OPEN)\n        return -EINVAL;\n    /*\n     * é¡¾åæ€ä¹‰ï¼Œè®¾ç½®åœ¨è°ƒç”¨ exec() å‡½æ•°æ—¶ä¸»åŠ¨å…³é—­çš„æ–‡ä»¶\n     * exec() é€šå¸¸ä¸ fork() è”ç”¨ï¼Œfork() è´Ÿè´£å¤åˆ¶ä¸€ä¸ªä»»åŠ¡ï¼Œè€Œ exec è´Ÿè´£æ›¿æ¢æ–°ä»»åŠ¡çš„ä»£ç å’Œæ•°æ®æ®µ(ä»è€Œäº§ç”Ÿä¸€ä¸ªæ–°çš„ä»»åŠ¡)\n     * è¿™é‡Œçš„å£°æ˜å³æ˜¯å¤ä½ fd ä½ç½®çš„æ ‡å¿—ï¼Œå…è®¸å­ä»»åŠ¡ä¹ŸæŒæœ‰ç›¸åŒçš„æ–‡ä»¶æè¿°ç¬¦é¡¹\n     */\n    current->close_on_exec &#x26;= ~(1&#x3C;&#x3C;fd);\n    f=0+file_table;\n    /* åœ¨æ–‡ä»¶è¡¨ä¸­æ‰¾ä¸€é¡¹ç©ºé—²çš„ */\n    for (i=0 ; i&#x3C;NR_FILE ; i++,f++)\n        if (!f->f_count) break;\n    if (i>=NR_FILE)\n        return -EINVAL;\n    /* å½“å‰ä»»åŠ¡çš„æ–‡ä»¶æè¿°ç¬¦é¡¹æŒ‡å‘æ–‡ä»¶è¡¨é¡¹, åŒæ—¶æ–‡ä»¶è¡¨é¡¹çš„å¼•ç”¨è®¡æ•°+1*/\n    (current->filp[fd]=f)->f_count++;\n    /* è°ƒç”¨ open_namei æ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœå¤±è´¥åˆ™é‡Šæ”¾åˆšæ‰å ç”¨çš„æ–‡ä»¶ç»“æ„ï¼Œå¹¶è¿”å›é”™è¯¯ç  */\n    if ((i=open_namei(filename,flag,mode,&#x26;inode))&#x3C;0) {\n        current->filp[fd]=NULL;\n        f->f_count=0;\n        return i;\n    }\n    /* \n     * å¯¹ä¸åŒçš„æ–‡ä»¶è¿›è¡Œä¸åŒçš„ç‰¹æ®Šå¤„ç†, æ¯•ç«Ÿæœ‰ "ä¸€åˆ‡çš†æ–‡ä»¶" çš„å£å·å˜›\n     * è¯¸å¦‚å­—ç¬¦è®¾å¤‡ç­‰ä¹Ÿéƒ½æ˜¯æ–‡ä»¶\n     */\n/* ttys are somewhat special (ttyxx major==4, tty major==5) */\n    if (S_ISCHR(inode->i_mode))\n        if (MAJOR(inode->i_zone[0])==4) {\n            if (current->leader &#x26;&#x26; current->tty&#x3C;0) {\n                current->tty = MINOR(inode->i_zone[0]);\n                tty_table[current->tty].pgrp = current->pgrp;\n            }\n        } else if (MAJOR(inode->i_zone[0])==5)\n            if (current->tty&#x3C;0) {\n                iput(inode);\n                current->filp[fd]=NULL;\n                f->f_count=0;\n                return -EPERM;\n            }\n/* Likewise with block-devices: check for floppy_change */\n    if (S_ISBLK(inode->i_mode))\n        check_disk_change(inode->i_zone[0]);\n    /* åˆå§‹åŒ–å†…å­˜æ–‡ä»¶ç»“æ„çš„å„ä¸ªå‚æ•° */\n    f->f_mode = inode->i_mode;\n    f->f_flags = flag;\n    f->f_count = 1;\n    f->f_inode = inode;\n    f->f_pos = 0;\n    return (fd);\n}\n</code></pre>\n<p>åœ¨æ•´ä¸ªæ‰“å¼€æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œé™¤äº†çœŸæ­£å»æ–‡ä»¶ç³»ç»ŸæŸ¥æ‰¾æ–‡ä»¶çš„æ—¶å€™ç”¨åˆ°äº†æ–‡ä»¶åï¼Œå…¶å®ƒæ—¶å€™ï¼Œéƒ½å°†æ˜¯ä»¥æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œäº¤äº’çš„ã€‚</p>\n<p>å†çœ‹çœ‹æ›´ç»†èŠ‚çš„æ–¹é¢ï¼Œæ¯•ç«Ÿå°±ç›®å‰æ¥è¯´ï¼Œæˆ‘ä»¬è·³è¿‡äº†æœ€é‡è¦çš„ä¸€ç¯ <code>open_namei</code> ï¼Œä»è€Œçœ‹ä¼¼æ•´ä¸ªæµç¨‹éƒ½ç®€å•äº†å¾ˆå¤šå¾ˆå¤šã€‚</p>\n<p>é€šå¸¸æˆ‘ä»¬åœ¨ç¼–ç è¿‡ç¨‹ä¸­éƒ½æ˜¯é€šè¿‡ç»å¯¹åœ°å€/ç›¸å¯¹åœ°å€æ¥å”¯ä¸€å®šä½ä¸€ä¸ªæ–‡ä»¶ã€‚å› æ­¤ï¼Œå°±å¿…ç„¶å­˜åœ¨é€çº§å¯»æ‰¾æ–‡ä»¶çš„è¿‡ç¨‹</p>\n<pre><code class="language-c">static struct m_inode * get_dir(const char * pathname)\n{\n    char c;\n    const char * thisname;\n    struct m_inode * inode;\n    struct buffer_head * bh;\n    int namelen,inr,idev;\n    struct dir_entry * de;\n\n    /* åˆ¤å®šå½“å‰ä»»åŠ¡è®¾å®šçš„æ ¹èŠ‚ç‚¹æ˜¯å¦æœ‰æ•ˆ */\n    if (!current->root || !current->root->i_count)\n        panic("No root inode");\n    /* åˆ¤å®šå½“å‰è·¯å¾„ièŠ‚ç‚¹æ˜¯å¦æœ‰æ•ˆ */\n    if (!current->pwd || !current->pwd->i_count)\n        panic("No cwd inode");\n    /* \n     * è¿™é‡Œçš„ get_fs_byte(..) æ˜¯å®å®šä¹‰ï¼Œfs æŒ‡çš„æ˜¯ FS æ®µå¯„å­˜å™¨\n     * Linux å†…æ ¸å°† DS, ES ç”¨äºå†…æ ¸æ•°æ®æ®µ, ç”¨ FS æŒ‡å‘å±€éƒ¨æè¿°ç¬¦è¡¨çš„å½“å‰ä»»åŠ¡æ•°æ®æ®µ\n     * è¿™é‡Œå¯ä»¥ç®€å•ç†è§£æˆå–å­—ç¬¦æ•°ç»„çš„ç¬¬ä¸€ä¸ªå­—èŠ‚\n     */\n    if ((c=get_fs_byte(pathname))==\'/\') {\n        inode = current->root;\n        pathname++;\n    } else if (c)\n        inode = current->pwd;\n    else\n        return NULL;    /* empty name is bad */\n    inode->i_count++;\n    while (1) {\n        thisname = pathname;\n        if (!S_ISDIR(inode->i_mode) || !permission(inode,MAY_EXEC)) {\n            iput(inode);\n            return NULL;\n        }\n        for(namelen=0;(c=get_fs_byte(pathname++))&#x26;&#x26;(c!=\'/\');namelen++)\n            /* nothing */ ;\n        if (!c)\n            return inode;\n        if (!(bh = find_entry(&#x26;inode,thisname,namelen,&#x26;de))) {\n            iput(inode);\n            return NULL;\n        }\n        inr = de->inode;\n        idev = inode->i_dev;\n        brelse(bh);\n        iput(inode);\n        if (!(inode = iget(idev,inr)))\n            return NULL;\n    }\n}\n\n/*\n *  dir_namei()\n *\n * å¤„ç†è·¯å¾„ pathname, å¤„ç†æˆièŠ‚ç‚¹è¡¨ç¤ºçš„æœ€ç»ˆä¸€çº§ç›®å½•+ç›®å½•ä¸‹æ–‡ä»¶å(ä¹Ÿå¯èƒ½pathnameè¡¨ç¤ºçš„å°±æ˜¯ç›®å½•)\n */\nstatic struct m_inode * dir_namei(const char * pathname, int * namelen, const char ** name)\n{\n    char c;\n    const char * basename;\n    struct m_inode * dir;\n\n    if (!(dir = get_dir(pathname)))\n        return NULL;\n    basename = pathname;\n    while (c=get_fs_byte(pathname++))\n        if (c==\'/\')\n            basename=pathname;\n    *namelen = pathname-basename-1;\n    *name = basename;\n    return dir;\n}\n\n/*\n *  open_namei()\n *\n * namei for open - this is in fact almost the whole open-routine.\n */\nint open_namei(const char * pathname, int flag, int mode,\n    struct m_inode ** res_inode)\n{\n    const char * basename;\n    int inr,dev,namelen;\n    struct m_inode * dir, *inode;\n    struct buffer_head * bh;\n    struct dir_entry * de;\n\n    if ((flag &#x26; O_TRUNC) &#x26;&#x26; !(flag &#x26; O_ACCMODE))\n        flag |= O_WRONLY;\n    mode &#x26;= 0777 &#x26; ~current->umask;\n    mode |= I_REGULAR;\n    if (!(dir = dir_namei(pathname,&#x26;namelen,&#x26;basename)))\n        return -ENOENT;\n    /* å¦‚æœç»™çš„ pathname æ˜¯ä¸€ä¸ªç›®å½• */\n    if (!namelen) {         /* special case: \'/usr/\' etc */\n        if (!(flag &#x26; (O_ACCMODE|O_CREAT|O_TRUNC))) {\n            *res_inode=dir;\n            return 0;\n        }\n        iput(dir);\n        return -EISDIR;\n    }\n    /* æ‰¾åˆ°ç›®å½•å¯¹åº”çš„ièŠ‚ç‚¹çš„æ•°æ®å— */\n    bh = find_entry(&#x26;dir,basename,namelen,&#x26;de);\n    if (!bh) {\n        if (!(flag &#x26; O_CREAT)) {\n            iput(dir);\n            return -ENOENT;\n        }\n        if (!permission(dir,MAY_WRITE)) {\n            iput(dir);\n            return -EACCES;\n        }\n        inode = new_inode(dir->i_dev);\n        if (!inode) {\n            iput(dir);\n            return -ENOSPC;\n        }\n        inode->i_uid = current->euid;\n        inode->i_mode = mode;\n        inode->i_dirt = 1;\n        bh = add_entry(dir,basename,namelen,&#x26;de);\n        if (!bh) {\n            inode->i_nlinks--;\n            iput(inode);\n            iput(dir);\n            return -ENOSPC;\n        }\n        de->inode = inode->i_num;\n        bh->b_dirt = 1;\n        brelse(bh);\n        iput(dir);\n        *res_inode = inode;\n        return 0;\n    }\n    inr = de->inode;\n    dev = dir->i_dev;\n    brelse(bh);\n    iput(dir);\n    if (flag &#x26; O_EXCL)\n        return -EEXIST;\n    if (!(inode=iget(dev,inr)))\n        return -EACCES;\n    if ((S_ISDIR(inode->i_mode) &#x26;&#x26; (flag &#x26; O_ACCMODE)) ||\n        !permission(inode,ACC_MODE(flag))) {\n        iput(inode);\n        return -EPERM;\n    }\n    inode->i_atime = CURRENT_TIME;\n    if (flag &#x26; O_TRUNC)\n        truncate(inode);\n    *res_inode = inode;\n    return 0;\n}\n</code></pre>\n<h3>æ–‡ä»¶å†™å…¥</h3>\n<p>æ¥ä¸‹æ¥å°±è¦è¿›è¡Œæ–‡ä»¶å†™å…¥çš„æµç¨‹äº†</p>\n<p>å¦‚ä½•é™·å…¥å†…æ ¸æ€å‡½æ•°å°±ä¸å†ç»†è¯´äº†ï¼Œç›¸ä¿¡çœ‹è¿‡è¿™ä¹ˆå¤šç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œä¹Ÿèƒ½çŸ¥é“åŸºæœ¬ä¸Šç³»ç»Ÿè°ƒç”¨åœ¨å†…æ ¸æ€å¯¹åº”çš„å‡½æ•°éƒ½æ˜¯ä»¥ sys_ å½¢å¼å‡ºç°çš„</p>\n<pre><code class="language-c">int sys_write(unsigned int fd,char * buf,int count)\n{\n    struct file * file;\n    struct m_inode * inode;\n\n    /* éæ³• fd , æŠ›å¼‚å¸¸ */\n    if (fd>=NR_OPEN || count &#x3C;0 || !(file=current->filp[fd]))\n        return -EINVAL;\n    /* count = 0ï¼Œæ— éœ€å†™å…¥æ•°æ® */\n    if (!count)\n        return 0;\n    inode=file->f_inode;\n    /* é’ˆå¯¹ä¸åŒçš„ièŠ‚ç‚¹ç±»å‹ï¼Œæœ‰ä¸åŒçš„å†™å…¥å‡½æ•° */\n    if (inode->i_pipe)\n        return (file->f_mode&#x26;2)?write_pipe(inode,buf,count):-EIO;\n    if (S_ISCHR(inode->i_mode))\n        return rw_char(WRITE,inode->i_zone[0],buf,count,&#x26;file->f_pos);\n    if (S_ISBLK(inode->i_mode))\n        return block_write(inode->i_zone[0],&#x26;file->f_pos,buf,count);\n    if (S_ISREG(inode->i_mode))\n        return file_write(inode,file,buf,count);\n    printk("(Write)inode->i_mode=%06o\\n\\r",inode->i_mode);\n    return -EINVAL;\n}\n</code></pre>\n<p>çœ‹çœ‹å¯¹äºå¸¸è§„æ–‡ä»¶æ˜¯æ€ä¹ˆæ“ä½œçš„å§ã€‚</p>\n<pre><code class="language-c">int file_write(struct m_inode * inode, struct file * filp, char * buf, int count)\n{\n    off_t pos;      /* åç§»é‡ */\n    int block,c;\n    struct buffer_head * bh;\n    char * p;\n    int i=0;\n\n    /* å¦‚æœæ˜¯ Append æ¨¡å¼ï¼ŒæŠŠåç§»é‡é‡ç½®åˆ°æ–‡ä»¶æœ«å°¾ */\n    if (filp->f_flags &#x26; O_APPEND) \n        pos = inode->i_size;\n    /* å¦åˆ™å°±ä½¿ç”¨å½“å‰æ–‡ä»¶æ•°æ®ç»“æ„æŒæœ‰çš„åç§»é‡ */\n    /*\n        é™„ä¸Šæ•°æ®ç»“æ„  file çš„å†…å®¹ \n        struct file {\n            unsigned short f_mode;\n            unsigned short f_flags;\n            unsigned short f_count;\n            struct m_inode * f_inode;\n            off_t f_pos;    æ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶éƒ½å°†æŒæœ‰å½“å‰çš„åç§»å€¼\n        };\n     */\n    else\n        pos = filp->f_pos;\n    /* é€å­—ç¬¦å‘ç¼“å†²åŒºå†™å…¥æ•°æ® */\n    while (i&#x3C;count) {\n        /* æœ€å¼€å§‹å½“ç„¶æ˜¯åˆ›å»ºåœ¨ç£ç›˜ä¸Šå ç”¨ä¸€ä¸ªæ•°æ®å—äº† (å¦‚æœæ–‡ä»¶å¯¹åº”çš„å—ä¸å­˜åœ¨çš„è¯) */\n        if (!(block = create_block(inode,pos/BLOCK_SIZE)))\n            break;\n        /* æ ¹æ®æ•°æ®å—è·å¾—ç›¸åº”çš„ç¼“å†²å— */\n        if (!(bh=bread(inode->i_dev,block)))\n            break;\n        /* åœ¨ç¼“å†²å—ä¸­çš„åç§»é‡ */\n        c = pos % BLOCK_SIZE;\n        /* å®šä½åˆ°å…·ä½“çš„ç¼“å†²åŒºçš„å†…å­˜åœ°å€ */\n        p = c + bh->b_data;\n        bh->b_dirt = 1;\n        /* å½“å‰è¿™ä¸ªç¼“å†²å—è¿˜æœ‰å¤šå°‘å­—èŠ‚å¯å†™ */\n        c = BLOCK_SIZE-c;\n        /* å¦‚æœéœ€è¦å†™å…¥çš„æ•°æ®é‡å°‘äº c */\n        if (c > count-i) c = count-i;\n        /* æ·»åŠ åç§»é‡è®¡æ•°, æ›´æ–°æ•°æ®ç»“æ„ä¸­ç»´æŠ¤çš„å€¼ */\n        pos += c;\n        if (pos > inode->i_size) {\n            inode->i_size = pos;\n            inode->i_dirt = 1;\n        }\n        i += c;\n        /* å‘ç¼“å†²å—é€å­—èŠ‚å†™å…¥æ•°æ® */\n        while (c--\x3e0)\n            *(p++) = get_fs_byte(buf++);\n        /* é‡Šæ”¾å¯¹ç¼“å†²å—çš„å ç”¨ï¼Œå½“ç„¶ï¼Œåœ¨é‡Šæ”¾å‰ä¼šå®Œæˆç¼“å†²å—&#x3C;->å¤–å­˜æ•°æ®å—çš„åŒæ­¥ */\n        brelse(bh);\n    }\n    inode->i_mtime = CURRENT_TIME;\n    if (!(filp->f_flags &#x26; O_APPEND)) {\n        /* é APPEND æ¨¡å¼ï¼Œæ›´æ–°æ–‡ä»¶è¯»å†™æŒ‡é’ˆ(åç§»é‡); APPEND æ¨¡å¼æ˜¯ä½¿ç”¨ inode->i_size ï¼Œæ‰€æœ‰å°±ä¸éœ€è¦åœ¨è¿™é‡Œæ›´æ–°äº† */\n        filp->f_pos = pos;\n        inode->i_ctime = CURRENT_TIME;\n    }\n    return (i?i:-1);\n}\n</code></pre>\n<p>æ˜¯ä¸æ˜¯è§‰å¾—ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤ªé«˜å¤§ä¸Šçš„æ“ä½œã€‚ç¡®å®å¦‚æ­¤ï¼Œæ›´å¤šå…³äºç¼“å­˜å—ä¸æ–‡ä»¶ç³»ç»Ÿæ•°æ®å—çš„åŒæ­¥éƒ½å·²ç»è¢«åŒ…è£…åˆ° bread(), brelse() ä¸­äº†ã€‚</p>\n<p>ä¸è¿‡ï¼Œæš‚æ—¶æ— éœ€ç»†ç©¶ã€‚æ€»ä¹‹åˆ°æ­¤ä¸ºæ­¢ï¼Œå…ˆè¦æœ‰ä¸€ä¸ªåŸºç¡€çš„è§‚å¿µ: æ‰€æœ‰ä¸å¤–å­˜å‚¨å™¨(è¿™é‡Œä¹ŸåŒ…æ‹¬æ§åˆ¶å°ç­‰)è¿›è¡Œæ•°æ®äº¤äº’éƒ½å¿…é¡»ç»è¿‡ç¼“å†²åŒº</p>\n<p>ç¼“å†²åŒºå°è£…äº†å¯¹å¤–å­˜å‚¨å™¨çš„å…¨éƒ¨æ“ä½œï¼Œè€Œæä¾›ç»™ CPU æ›´é«˜æ•ˆçš„ I/O æ“ä½œï¼Œå½“ç„¶ï¼Œä¹Ÿæ›´ä¸ºç®€å•å¿«æ·</p>\n<h3>æ–‡ä»¶è¯»å–</h3>\n<p>è‡³äºæ–‡ä»¶è¯»å–ï¼Œä¹ŸåŸºæœ¬ç±»ä¼¼äº†ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸å†æ·±å…¥æè¿°ã€‚</p>\n<p>å½“ç„¶ï¼Œè¦æ³¨æ„çš„å°±æ˜¯ï¼Œåœ¨æœ¬ç¯‡å¼€å§‹çš„éƒ¨åˆ†æä¾›çš„ä¾‹ç¨‹ä¸­ï¼Œwrite &#x26; read ä¸­æ’å…¥äº† <code>off_t off = lseek(fd, 0, SEEK_SET);</code>  è¿™æ ·çš„ä»£ç ã€‚</p>\n<p>åŸå› åº”è¯¥ä¹Ÿèƒ½å¤Ÿæƒ³åˆ°ï¼Œå­¦ä¹  <code>sys_write(..)</code> çš„æ—¶å€™æˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼Œä»»åŠ¡å¯¹åŒä¸€ä¸ªæ–‡ä»¶åœ¨å†…å­˜ä¸­ç»´æŠ¤äº†ä¸€ä¸ªæ–‡ä»¶è¯»å†™åç§»é‡ã€‚å› æ­¤ï¼Œè¦è¯»å–åˆšæ‰å†™å…¥çš„å†…å®¹ï¼Œå°±ä¸å¾—ä¸å…ˆæ”¹åŠ¨è¿™ä¸ªè¯»å†™åç§»é‡äº†</p>\n<pre><code class="language-c">int sys_read(unsigned int fd,char * buf,int count)\n{\n    struct file * file;\n    struct m_inode * inode;\n\n    if (fd>=NR_OPEN || count&#x3C;0 || !(file=current->filp[fd]))\n        return -EINVAL;\n    if (!count)\n        return 0;\n    verify_area(buf,count);\n    inode = file->f_inode;\n    if (inode->i_pipe)\n        return (file->f_mode&#x26;1)?read_pipe(inode,buf,count):-EIO;\n    if (S_ISCHR(inode->i_mode))\n        return rw_char(READ,inode->i_zone[0],buf,count,&#x26;file->f_pos);\n    if (S_ISBLK(inode->i_mode))\n        return block_read(inode->i_zone[0],&#x26;file->f_pos,buf,count);\n    if (S_ISDIR(inode->i_mode) || S_ISREG(inode->i_mode)) {\n        if (count+file->f_pos > inode->i_size)\n            count = inode->i_size - file->f_pos;\n        if (count&#x3C;=0)\n            return 0;\n        return file_read(inode,file,buf,count);\n    }\n    printk("(Read)inode->i_mode=%06o\\n\\r",inode->i_mode);\n    return -EINVAL;\n}\n</code></pre>\n<h2>å°ç»“</h2>\n<p>è¿™ç¯‡å¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä»£ç å±‚é¢çš„æè¿°ï¼Œä»…ä»…åªæ˜¯æ¡äº†ä¸€ä¸ªç›¸å½“æœ‰é™çš„ç‰‡é¢ (å¸¸è§„æ–‡ä»¶è¯»å†™)ã€‚ä»æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½å¼€å§‹æä¾›äº†ä¸€ä¸ªè¯»å†™çš„å®Œæ•´æµç¨‹ä»‹ç»(å½“ç„¶ï¼Œå¾ˆå¤šç»†èŠ‚æ˜¯ç¼ºå¤±çš„ï¼Œä¸è¿‡ä¸è¦ç€æ€¥)ã€‚</p>\n<p>è™½ç„¶å¹³å¸¸éƒ½èƒ½å¤Ÿäº†è§£åˆ°ä¸€ä¸ªæ¯”è¾ƒæ¨¡ç³Šçš„å‰æï¼Œæ–‡ä»¶è¯»å†™éœ€è¦åˆ©ç”¨ç¼“å†²åŒºï¼Œä½†æ˜¯ç©¶ç«Ÿä»€ä¹ˆæ˜¯ç¼“å­˜åŒºï¼Œå¦‚ä½•ä½¿ç”¨éƒ½ä¸ä¼šæœ‰å¤ªå¤šçš„æ¦‚å¿µã€‚æœ¬ç¯‡æœ€å¤§çš„é‡ç‚¹ï¼Œå°±æ˜¯é¦–å…ˆè¯·è¯»è€…ä»¬å»ºç«‹èµ·ä¸€ä¸ªåŸºç¡€æ€§çš„å¯¹ç¼“å†²åŒºçš„äº†è§£ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸ªä¸­ä»‹åœ¨ I/O ä¸­æ‰®æ¼”äº†ç›¸å½“é‡è¦çš„è§’è‰²ã€‚è€Œä¸”å†…å­˜ä¹Ÿä¸ºå…¶æä¾›äº†ç›¸å½“å¤§çš„ä¸€ä»½ç©ºé—´ï¼Œå·®ä¸å¤šæœ‰ 1/4 äº†ã€‚</p>\n<p>è·¨äº†å·®ä¸å¤šåŠä¸ªå¤šæœˆæ¥å†™ï¼Œä¸Šä¸‹æ–‡çš„æ‰¿æ¥å¯èƒ½æœ‰äº›ç”Ÿç¡¬äº†ï¼Œç”šè‡³ä¸ä¸€è‡´äº†... å°´å°¬...</p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},"6bZZ":function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<h2>æ¦‚è§ˆ</h2>\n<p>åœ¨å­¦ä¹  Spring-JDBC ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦ä» Java åŸç”Ÿæä¾›çš„ JDBC å¼€å§‹ï¼Œå¯¹ JDBC æ“ä½œçš„ä¸€æ•´å¥—å®Œæ•´çš„æµç¨‹æœ‰ä¸€ä¸ªæ¸…æ™°çš„æ¦‚å¿µã€‚</p>\n<pre><code class="language-java">/**\n * copied from https://www.tutorialspoint.com/jdbc/jdbc-sample-code.htm\n * updated by DorMOUSENone\n */\n\n//STEP 1. å¼•å…¥å¿…é¡»çš„åŒ…\nimport java.sql.*;\n\npublic class Example {\n    // JDBC é©±åŠ¨å ä¸ DB URL \n    static final String JDBC_DRIVER = "com.mysql.jdbc.Driver";  \n    static final String DB_URL = "jdbc:mysql://&#x3C;host>:&#x3C;port>/&#x3C;dbName>";\n\n    // æ•°æ®åº“ç™»å½•éªŒè¯ (ç”¨æˆ·åã€å¯†ç ç­‰)\n    static final String USER = "username";\n    static final String PASS = "password";\n   \n    public static void main(String[] args) {\n        Connection conn = null;\n        Statement stmt = null;\n        try{\n            //STEP 2: æ³¨å†Œé©±åŠ¨(æ³¨å†Œåˆ°é©±åŠ¨ç®¡ç†å™¨ DriverManager ç±»ä¸­)\n            Class.forName("com.mysql.jdbc.Driver");\n\n            //STEP 3: åˆ›å»ºä¸€ä¸ªè¿æ¥\n            System.out.println("Connecting to database...");\n            conn = DriverManager.getConnection(DB_URL,USER,PASS);\n\n            //STEP 4: æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢\n            System.out.println("Creating statement...");\n            stmt = conn.createStatement();\n            String sql;\n            sql = "SELECT id, first, last, age FROM Employees";\n            ResultSet rs = stmt.executeQuery(sql);\n\n            //STEP 5: å°†ç»“æœä»ç»“æœé›†(ResultSet)ä¸­å–å‡º\n            while(rs.next()){\n                //æ ¹æ®åˆ—åé€ä¸€å–å‡ºæ•°æ®\n                int id  = rs.getInt("id");\n                int age = rs.getInt("age");\n                String first = rs.getString("first");\n                String last = rs.getString("last");\n\n                //å±•ç¤ºç»“æœ\n                System.out.print("ID: " + id);\n                System.out.print(", Age: " + age);\n                System.out.print(", First: " + first);\n                System.out.println(", Last: " + last);\n            }\n            //STEP 6: æ¸…ç†ç¯å¢ƒ\n            rs.close();\n            stmt.close();\n            conn.close();\n        }catch(SQLException se){\n            //å¤„ç† JDBC é”™è¯¯\n            se.printStackTrace();\n        }catch(Exception e){\n            //å¤„ç† Class.forName() å¼•èµ·çš„é”™è¯¯\n            e.printStackTrace();\n        }finally{\n            // finally ä»£ç åº“æ¥å…³é—­èµ„æº\n            try{\n                if(stmt!=null)\n                    stmt.close();\n            }catch(SQLException se2){\n            }// ä¸åšä»»ä½•å¤„ç†\n            try{\n                if(conn!=null)\n                    conn.close();\n            }catch(SQLException se){\n                se.printStackTrace();\n            }\n        }\n        System.out.println("Goodbye!");\n    }\n}\n</code></pre>\n<p>ä»ä¸Šé¢çš„é€šç”¨ JDBC ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåˆ©ç”¨ Java åŸç”Ÿæä¾›çš„ java.sql.* åŒ…å¯ä»¥å®Œæˆæ³¨å†Œé©±åŠ¨ï¼Œåˆ›å»ºè¿æ¥ï¼Œæ‰§è¡ŒæŸ¥è¯¢ï¼Œå¤„ç†ç»“æœç­‰ä¸€ç³»åˆ—ä¸€æ•´å¥—æ“ä½œã€‚</p>\n<p>è€Œ Spring-JDBC å¯¹äº Java åŸç”Ÿæä¾›çš„ JDBC ï¼Œå¯¹ä¸€ç³»åˆ—æ•°æ®åŠæ“ä½œè¿›è¡Œäº†æ•´åˆï¼š</p>\n<ol>\n<li>å®ç°äº† DataSource æ¥å£ï¼Œç”¨äºæ•´åˆæ•°æ®æºé…ç½®ï¼Œå°†å„ç§é›¶æ•£çš„å±æ€§å€¼ï¼ˆè¯¸å¦‚ URLã€ç”¨æˆ·åã€ å¯†ç ç­‰ï¼‰æ•´åˆæˆå®Œæ•´çš„ä¸€ä¸ªå¯¹è±¡ï¼Œä¾¿äºé‡ç”¨ï¼›ä¹Ÿå®ç°äº† getConnection(â€¦) æ¥å£ï¼Œä¾¿äºç›´æ¥é€šè¿‡ DataSource è·å–è¿æ¥ã€‚</li>\n<li>å¯¹æ‰§è¡ŒæŸ¥è¯¢çš„æµç¨‹è¿›è¡Œäº†å°è£…ã€‚</li>\n<li>å¯¹ç»“æœé›†çš„å¤„ç†æä¾›äº†å¤šç§æ¥å£ï¼Œé’ˆå¯¹ä¸åŒçš„åº”ç”¨åœºæ™¯å¯è‡ªç”±é€‰æ‹©æ‰€å¿…é¡»çš„å®ç°ç±»ã€‚ä¾‹å¦‚ç›´æ¥é€šè¿‡ JDBC è·å¾— Bean ï¼Œè€Œæ— éœ€å¦‚ä¸Šä¾‹ 39-42 è¡Œæ‰€ç¤ºï¼Œé€ä¸€ç¼–ç è¿›è¡Œæå–ã€‚</li>\n</ol>\n<p>æœ¬èŠ‚æä¾›å¯¹ã€ŠSpring-JDBC æºç å­¦ä¹ ã€‹å®Œæ•´å­¦ä¹ è¿‡ç¨‹çš„ä¸€ä¸ªæ¢³ç†ï¼š</p>\n<ol>\n<li><a href="http://blog.csdn.net/dormousenone/article/details/79035440">JdbcTemplate</a> ä¸€èŠ‚ä½œä¸ºå­¦ä¹  Spring-jdbc çš„åˆ‡å…¥ç‚¹ï¼Œæ˜¯ org.springframework.jdbc.core åŒ…ä¸­çš„æ ¸å¿ƒç±»ï¼Œæ˜¯ä¸€ä¸ªæä¾›ä¸åŒåœºæ™¯ä¸‹æ•°æ®åº“æ“ä½œçš„æ¨¡æ¿ç±»ã€‚ä¸»è¦æè¿°å…¶æŒæœ‰çš„å±æ€§ DataSource ç­‰ä»¥åŠå…¶å®ç°çš„æ–¹æ³•ã€‚</li>\n<li><a href="http://blog.csdn.net/dormousenone/article/details/79037012">DataSource</a> ä¸€èŠ‚æ‰¿æ¥ JdbcTemplate ä¸€èŠ‚ï¼Œæä¾› Spring-jdbc å¯¹æ•°æ®æºçš„ä¸€ä¸ªåŒ…è£…ä¸åº”ç”¨ã€‚åŒæ—¶æè¿°å…¶æ ¸å¿ƒæ–¹æ³• getConnection(â€¦) çš„å®ç°ã€‚</li>\n<li><a href="http://blog.csdn.net/dormousenone/article/details/79042212">DriverManager</a> æè¿°å…¶å¯¹ä¸åŒæ•°æ®åº“ä¾›åº”å•†æä¾›çš„é©±åŠ¨çš„ç®¡ç†ä¸ä½¿ç”¨æ–¹æ³•ã€‚åŒæ—¶ç®€å•æè¿°é€šè¿‡å…·ä½“é©±åŠ¨è·å¾—ä¸€ä¸ªè¿æ¥çš„å®ç°ã€‚</li>\n<li><a href="http://blog.csdn.net/dormousenone/article/details/79046865">PreparedStatement &#x26; CallableStatement</a> ä¸€èŠ‚ä¸»è¦è¡¨è¿° Spring-jdbc å¦‚ä½•å¯¹æ‰§è¡ŒæŸ¥è¯¢çš„æµç¨‹è¿›è¡Œäº†å°è£…ã€‚ç‰¹åˆ«æ˜¯å¯¹äº PreparedStatement ä¸ CallableStatement è¿™ç±»é¢„ç½®å¯å˜ SQL è¯­å¥ï¼Œåœ¨æ‰§è¡Œå‰å¿…é¡»å¯¹å…¶ä¸­å¯å˜å‚æ•°è¿›è¡Œè¡¥å…¨çš„ Statement ã€‚</li>\n<li><a href="http://blog.csdn.net/dormousenone/article/details/79062275">ResultSet</a> æè¿° Spring-jdbc å¦‚ä½•å¯¹ç»“æœé›†è¿›è¡Œå¤„ç†ï¼Œæä¾›äº†å¤šç§ä¸åŒçš„æ¥å£å®ç°ä¸åŒçš„å¤„ç†é€»è¾‘ã€‚è¿™ç§å°è£…åçš„æ“ä½œå¯ä»¥æå¤§åœ°ç®€åŒ–ç›´æ¥ä½¿ç”¨ Java åŸç”Ÿ JDBC æ‰€å¿…é¡»çš„ç¡¬ç¼–ç æå–æ•°æ®çš„é—®é¢˜ã€‚</li>\n</ol>\n<h2>JdbcTemplate</h2>\n<p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fn90ghu9ufj30ki0jm75t.jpg"></p>\n<p>JdbcTemplate ç±»ä½œä¸º org.springframework.core åŒ…ä¸‹çš„æ ¸å¿ƒç±»ï¼Œå¯¹ Java å®ç°çš„ JDBC è¿›è¡Œäº†ä¸€å®šç¨‹åº¦çš„å°è£…ï¼Œå¯ä»¥ç®€åŒ– JDBC çš„ä½¿ç”¨ï¼ŒåŒæ—¶é¿å…è®¸å¤šå¸¸è§çš„é”™è¯¯ã€‚ç”±è¯¥ç±»æ¥æ‰§è¡Œ JDBC å·¥ä½œæµï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦æä¾› SQL è¯­å¥å°±å¯ä»¥è·å¾— DB æ‰§è¡Œç»“æœï¼ˆğŸ˜€ï¼Œå½“ç„¶å®é™…æ“ä½œä¸Šæ²¡æœ‰æè¿°çš„è¿™ä¹ˆç®€å•ï¼‰ã€‚</p>\n<p><strong>ä½¿ç”¨ JdbcTemplate ç±»åªéœ€è¦å®ç°ä¸¤ä¸ªå›è°ƒæ¥å£ PreparedStatementCreator (åˆ›å»ºä¸€ä¸ª PreparedStatementï¼Œç»™å®šè¿æ¥ï¼Œæä¾› SQL è¯­å¥ä»¥åŠå¿…è¦çš„å‚æ•°), ResultSetExtractor (ç”¨äºèŠ±å¼è·å–ç»“æœé›†)ã€‚å½“ç„¶ï¼Œä¸å®ç°ä¸Šè¿°ä¸¤ä¸ªæ¥å£ä¹Ÿå¯ä»¥è¿›è¡Œç®€å•çš„æ•°æ®åº“æ“ä½œï¼Œæ¯”å¦‚åªé€šè¿‡ JdbcTemplate è·å–ä¸€ä¸ªè¿æ¥(Connection) æˆ–è€…æ‰§è¡Œä¸€ä¸ªé™æ€ SQL Updateã€‚</strong></p>\n<p><em>çœ‹ä¸æ‡‚æ— æ‰€è°“ï¼Œå…ˆç»§ç»­å‘ä¸‹çœ‹ï¼Œä¼šåšæ›´è¯¦ç»†çš„è®²è§£ã€‚</em></p>\n<h3>JdbcAccessor</h3>\n<p>é¦–å…ˆäº†è§£ JdbcTemplate çš„å®ç°ï¼ŒJdbcTemplate ç»§æ‰¿äº† JdbcAccessor æŠ½è±¡ç±»ï¼Œè¯¥æŠ½è±¡ç±»æœ‰ä¸¤ä¸ªä¸»è¦å±æ€§â€”â€” <strong>DataSource dataSource</strong> &#x26; <strong>SQLExceptionTranslator exceptionTranslator</strong> ï¼Œä»¥åŠä¸€ä¸ªæ‡’åŠ è½½æ ‡è¯†ç¬¦ <strong>lazyInit</strong> ã€‚</p>\n<p>å…¶ä¸­ï¼Œ</p>\n<ul>\n<li>DataSource å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªå­˜å‚¨æœ‰ä¸æ•°æ®åº“ç›¸å…³çš„å±æ€§å®ä¾‹ï¼Œä¸»è¦æ–¹æ³•åŒ…æ‹¬ <code>Connection getConnection()</code> &#x26; <code>Connection getConnection(String username, String password)</code> ã€‚</li>\n<li>SQLExceptionTranslator åˆ©ç”¨ç­–ç•¥æ¨¡å¼å°† Java å®šä¹‰çš„ SQLException è½¬æ¢æˆ Spring å£°æ˜çš„ DataAccessExceptionã€‚</li>\n</ul>\n<p>JdbcAccessor å®ç°çš„ InitializingBean æ¥å£ï¼ŒInitializingBean æ¥å£ä¸º Bean æä¾›äº†ä¸€ä¸ªåˆå§‹åŒ–å®ä¾‹çš„æ–¹æ³• â€”â€” afterPropertiesSet() æ–¹æ³•ï¼Œå‡¡æ˜¯ç»§æ‰¿è¯¥æ¥å£çš„ç±»ï¼Œä¸€èˆ¬éƒ½åœ¨ç±»æ„é€ æ–¹æ³•ä¸­æ‰§è¡Œè¯¥æ–¹æ³•ã€‚åŒæ ·çš„ï¼Œå£°æ˜åˆå§‹åŒ–å®ä¾‹è°ƒç”¨çš„æ–¹æ³•è¿˜å¯é‡‡ç”¨ <code>&#x3C;bean id="" class="" init-method="myInitMethod"/></code> åœ¨åˆå§‹åŒ– bean æ—¶æ‰§è¡Œ myInitMethod() æ–¹æ³•ã€‚å…·ä½“æ‰§è¡Œé¡ºåºä¸º ï¼š</p>\n<ol>\n<li>bean çš„å±æ€§æ³¨å…¥</li>\n<li>è°ƒç”¨ afterPropertiesSet() æ–¹æ³•</li>\n<li>æ‰§è¡Œ myInitMethod() æ–¹æ³•</li>\n</ol>\n<p>æ­¤å¤„ç»§æ‰¿è¯¥æ¥å£æ˜¯ä¸ºäº†å®ç° DataSource éªŒè¯ä»¥åŠ SQLExceptionTranslator çš„æ‡’åŠ è½½ OR NOT çš„é€‰æ‹©ã€‚</p>\n<pre><code class="language-java">@Override\npublic void afterPropertiesSet() {\n    if (getDataSource() == null) {  // åˆ¤æ–­æ˜¯å¦æ³¨å…¥äº† DataSource\n        throw new IllegalArgumentException("Property \'dataSource\' is required");\n    }\n    if (!isLazyInit()) {    // æ ¹æ®æ‡’åŠ è½½æ ‡è¯†ç¬¦é€‰æ‹©æ‰§è¡Œä¸å¦\n        getExceptionTranslator();   // è·å–ä¸€ä¸ª SQLExceptionTranslator å®ä¾‹\n    }\n}\n</code></pre>\n<p>è¯¥æ–¹æ³•åœ¨ BeanFactory å®Œæˆè¯¥ bean çš„ä¾èµ–æ³¨å…¥åæ‰§è¡Œï¼Œå°†é¦–å…ˆåˆ¤æ–­ DataSource æ˜¯å¦å·²ç»è¢«æ³¨å…¥ï¼Œå†æ ¹æ®æ‡’åŠ è½½æ ‡è¯†ç¬¦æ¥å†³å®šæ˜¯å¦å®ä¾‹åŒ–ä¸€ä¸ª SQLExceptionTranslator ã€‚</p>\n<h3>JdbcOperations</h3>\n<p>åŒæ—¶ï¼ŒJdbcTemplate ç±»å®ç°äº† JdbcOperations æ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰äº†åŸºæœ¬çš„ JDBC æ“ä½œã€‚åŸºæœ¬æ–¹æ³•å¦‚ä¸‹ï¼š</p>\n<ol>\n<li><code>&#x3C;T> T execute(ConnectionCallback&#x3C;T> action);</code></li>\n<li><code>&#x3C;T> T execute(StatementCallback&#x3C;T> action);</code></li>\n<li><code>&#x3C;T> T execute(PreparedStatementCreator psc, PreparedStatementCallback&#x3C;T> action);</code></li>\n<li><code>&#x3C;T> T execute(CallableStatementCreator csc, CallableStatementCallback&#x3C;T> action);</code></li>\n</ol>\n<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fncp2ncqd6j31j00au0uv.jpg"></p>\n<p>å…¶å®ƒçš„ execute(â€¦) , query(â€¦), update(â€¦) ç­‰æœ€ç»ˆéƒ½å°†è°ƒç”¨ä¸Šè¿° 4 ç§æ–¹æ³•å…¶ä¸€æ¥å®Œæˆç›®çš„ã€‚</p>\n<p>è¯¦ç»†è§‚å¯Ÿä¸Šè¿°æ–¹æ³•çš„å…¥å‚ï¼Œ ConnectionCallback, StatementCallback, PreparedStatementCallback å’Œ CallableStatementCallback å››ä¸ª Callback æ¥å£ï¼Œåˆ†åˆ«éƒ½æ˜¯å‡½æ•°å¼æ¥å£ï¼Œå…¶ä¸­çš„å”¯ä¸€æ–¹æ³• doInXXX() å°†åœ¨ execute() ä¸­è¢«è°ƒç”¨ï¼Œä»¥æ­¤å®ç°è·å¾— ResultSet å¹¶è¿”å› Result ã€‚execute ä¸­è°ƒç”¨ doInXXX() çš„é€šç”¨ä»£ç å¦‚ä¸‹ ï¼ˆä»¥ Statement ä¸ºä¾‹ï¼‰ï¼š</p>\n<p><em>å¯¹äºä¸ç†è§£<strong>å›è°ƒ</strong>çš„åŒå­¦ï¼Œè¯·è‡ªè¡Œäº†è§£æ¦‚å¿µ</em></p>\n<pre><code class="language-java">public &#x3C;T> T execute(StatementCallback&#x3C;T> action) throws DataAccessException {\n    // é€šè¿‡å·¥å…·ç±» DataSourceUtils è·å–ä¸€ä¸ªè¿æ¥\n    Connection con = DataSourceUtils.getConnection(obtainDataSource());\n    // ä¸€ä¸ª Statement ç©ºå®ä¾‹ï¼ŒPreparedStatement, CallableStatement ç±»ä¼¼\n    Statement stmt = null;\n    try {\n        stmt = con.createStatement();   // é€šè¿‡è¿æ¥(Connection)è·å–ä¸€ä¸ª Statement\n        applyStatementSettings(stmt);   // é…ç½® Statement å‚æ•°\n        // å›è°ƒæ‰§è¡Œ doInXXX() æ–¹æ³•, å¹¶è·å¾— result\n        T result = action.doInStatement(stmt);  \n        handleWarnings(stmt);\n        return result;\n    }\n    catch (SQLException ex) {\n        // Release Connection early, to avoid potential connection pool deadlock\n        // in the case when the exception translator hasn\'t been initialized yet.\n        String sql = getSql(action);\n        JdbcUtils.closeStatement(stmt);\n        stmt = null;\n        DataSourceUtils.releaseConnection(con, getDataSource());\n        con = null;\n        throw translateException("StatementCallback", sql, ex);\n    }\n    finally {\n        JdbcUtils.closeStatement(stmt);\n        DataSourceUtils.releaseConnection(con, getDataSource());\n    }\n}\n</code></pre>\n<p>å¯¹äº Statement, PreparedStatement, CallableStatement çš„åŒºåˆ«ï¼Œé¦–å…ˆä¸‹å›¾è¡¨ç°äº†ä¸‰ä¸ªæ¥å£çš„ç»§æ‰¿å…³ç³»ã€‚</p>\n<ul>\n<li>Statement å¯ä»¥æ”¯æŒé™æ€ SQL è¯­å¥</li>\n<li>PreparedStatement æ”¯æŒå¯å˜å‚æ•°çš„ SQL è¯­å¥</li>\n<li>CallableStatement æ”¯æŒå¯å˜å‚æ•°çš„ SQL è¯­å¥ï¼Œå¹¶ä¸”æ”¯æŒå®šåˆ¶ DB çš„è¾“å‡ºç»“æœ</li>\n</ul>\n<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fncpaec17yj30ew0hcdh7.jpg"></p>\n<h2>DataSource</h2>\n<p>ä¸Šä¸€èŠ‚åœ¨ç²—ç•¥åœ°äº†è§£äº† JdbcTemplate æä¾›çš„æ–¹æ³•ä¹‹åï¼Œä¸‹é¢å…ˆæ¥å¯¹ DataSource åšä¸€ç‚¹äº†è§£ã€‚</p>\n<h3>Java æä¾›çš„ DataSource å®šä¹‰</h3>\n<p>DataSource æ˜¯ Java æ ¸å¿ƒåº“æä¾›çš„æ¥å£ã€‚ä½äº javax.sql package ä¸‹ã€‚</p>\n<p>DataSource æ¥å£å¯ä»¥è¢«è§†ä½œæ˜¯ä¸€ä¸ªæä¾›ç‰©ç† DB å®ä¾‹è¿æ¥(Connection) çš„å·¥å‚ï¼Œé€šè¿‡ DataSource æŒæœ‰çš„å„ç§å±æ€§ï¼ˆåŒ…æ‹¬ DB Url, Username, Password ç­‰ï¼‰æ¥è·å–ä¸€ä¸ªè¿æ¥(Connection) ã€‚DataSource æ¥å£æœ‰ä¸‰ç§ä¸åŒçš„å®ç°æ–¹æ¡ˆï¼š</p>\n<ol>\n<li>æœ€åŸºæœ¬çš„å®ç°â€”â€”ç”Ÿäº§ä¸€ä¸ªæ ‡å‡†è¿æ¥(Connection) å¯¹è±¡</li>\n<li>è¿æ¥æ± æ–¹æ¡ˆâ€”â€”ç”Ÿäº§ä¼šè¢«è‡ªåŠ¨æ·»åŠ åˆ°è¿æ¥æ± çš„å¯¹è±¡</li>\n<li>åˆ†å¸ƒå¼äº‹ç‰©å®ç°â€”â€”ç”Ÿäº§ä¸€ä¸ªå¯ä»¥æ”¯æŒåˆ†å¸ƒå¼äº‹ç‰©ï¼Œå¹¶é»˜è®¤è¢«æ·»åŠ åˆ°è¿æ¥æ± çš„è¿æ¥å¯¹è±¡</li>\n</ol>\n<p>åŒ…æ‹¬ä¸¤ä¸ªå¯¹å¤–æä¾›è¿æ¥(Connection) å¯¹è±¡çš„æ–¹æ³•ï¼Œ</p>\n<pre><code class="language-java">Connection getConnection() throws SQLException;\nConnection getConnection(String username, String password) throws SQLException;\n</code></pre>\n<p>å…¶çˆ¶æ¥å£ CommonDataSource æä¾›è®¾ç½®/è·å– LogWriterï¼Œç™»å½• DB è¶…æ—¶æ—¶é—´å’Œè·å–çˆ¶ Logger çš„æ–¹æ³•ã€‚</p>\n<h3>Spring-JDBC æ‰©å±•çš„ DataSource å®šä¹‰</h3>\n<p>åœ¨ Spring-jdbc ä¸‹ï¼ŒDataSources æœ€é¡¶çº§çš„ç±»æ˜¯ AbstractDataSource ï¼Œå¯¹ DataSource çš„æ‰€æœ‰çˆ¶æ¥å£æ–¹æ³•åšäº†å®ç°ã€‚ä½†ä¿ç•™ getConnection() æ–¹æ³•ç”±å­ç±»å®ç°ã€‚</p>\n<p>åœ¨ AbstractDriverBasedDataSource ä¸­ï¼Œå®šä¹‰äº†å¤§é‡çš„å‚æ•°ï¼Œè¯¸å¦‚ url, username ç­‰ï¼Œè¿™äº›éƒ½è¢«ç”¨æ¥å®šä½å¹¶å®šä¹‰ä¸æ•°æ®åº“å®ä¾‹çš„è¿æ¥ã€‚</p>\n<pre><code class="language-java">public abstract class AbstractDriverBasedDataSource extends AbstractDataSource {\n\n   @Nullable\n   private String url;\n\n   @Nullable\n   private String username;\n\n   @Nullable\n   private String password;\n\n   @Nullable\n   private String catalog;\n\n   @Nullable\n   private String schema;\n\n   @Nullable\n   // å¯ä»¥çœ‹åˆ°æ­¤å¤„æœ‰ä¸€ä¸ª Properties ç±»\n   private Properties connectionProperties;\n   \n   // çœç•¥è‹¥å¹²æ–¹æ³•\n  \n\n    @Override\n    public Connection getConnection() throws SQLException {\n        // è°ƒç”¨å†…éƒ¨æ–¹æ³• getConnectionFromDriver()\n        return getConnectionFromDriver(getUsername(), getPassword());\n    }\n\n    @Override\n    public Connection getConnection(String username, String password) throws SQLException {\n        // è°ƒç”¨å†…éƒ¨æ–¹æ³• getConnectionFromDriver()\n        return getConnectionFromDriver(username, password);\n    }\n  \n   // å®šä¹‰äº†ä¸€ä¸ªè·å– Connection çš„æ–¹æ³•ï¼Œç”± getConnection() æ–¹æ³•è°ƒç”¨ï¼Œ\n   // æ­¤æ–¹æ³•ä¸»è¦æ˜¯å°†å±æ€§åšäº†ä¸€ä¸ªæ•´åˆ\n   // å…·ä½“è·å– Connection çš„é€»è¾‘ä»ç„¶ä¸‹æ”¾åˆ°å­ç±»å®ç° è§ 40 è¡Œ\n   protected Connection getConnectionFromDriver(@Nullable String username, @Nullable String password) throws SQLException {\n        Properties mergedProps = new Properties();\n        Properties connProps = getConnectionProperties();\n        if (connProps != null) {\n            mergedProps.putAll(connProps);\n        }\n        if (username != null) {\n            mergedProps.setProperty("user", username);\n        }\n        if (password != null) {\n            mergedProps.setProperty("password", password);\n        }\n        \n        // è·å– Connection é€»è¾‘ä¸‹æ”¾\n        Connection con = getConnectionFromDriver(mergedProps);\n        if (this.catalog != null) {\n            con.setCatalog(this.catalog);\n        }\n        if (this.schema != null) {\n            con.setSchema(this.schema);\n        }\n        return con;\n    }\n  \n    // è¯¥ç±»ä¸­è·å– Connection çš„æ–¹æ³•æ˜¯æŠ½è±¡æ–¹æ³•\n    protected abstract Connection getConnectionFromDriver(Properties props) throws SQLException;\n\n}\n</code></pre>\n<p>æ•´åˆæ–¹æ¡ˆä¸ºå°†é™¤ url å¤–çš„æ‰€æœ‰å‚æ•°æ•´åˆåœ¨åŒä¸€ä¸ª Properties å¯¹è±¡ä¸­ (å…¶ä¸­ï¼ŒProperties å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Hash Map) ã€‚æœ€ç»ˆè°ƒç”¨ <code>Connection getConnectionFromDriver(Properties props)</code> è·å–è¿æ¥ã€‚</p>\n<p>AbstractDriverBasedDataSource æŠ½è±¡ç±»çš„ä¸¤ä¸ªå­ç±» DriverManagerDataSource å’Œ SimpleDriverDataSource éƒ½ä»¥ä¸åŒæ–¹å¼è·å¾—äº†è¿æ¥(Connection)ï¼Œä½†æ€»ç»“è€Œè¨€ï¼Œè·å–è¿æ¥(Connection) çš„ä»»åŠ¡è¢«å§”æ‰˜ç»™äº† Driver æ¥å®ç°ï¼ˆå…¶ä¸­ï¼ŒDriver æœ‰ Java å®šä¹‰æ¥å£ï¼Œå¹¶ç”±å„æ•°æ®åº“æä¾›å•†æä¾›ï¼Œä¾‹å¦‚ MySQL æä¾›äº† mysql-connector-java-XXX.jar æ¥å®Œæˆé’ˆå¯¹ç›¸åº”æ•°æ®åº“çš„å…·ä½“å®ç°ï¼‰ã€‚</p>\n<pre><code class="language-java">// ----------------------------\n// SimpleDriverDataSource çš„å®ç°\n// ----------------------------\n@Override\nprotected Connection getConnectionFromDriver(Properties props) throws SQLException {\n    Driver driver = getDriver();\n    String url = getUrl();\n    Assert.notNull(driver, "Driver must not be null");\n    if (logger.isDebugEnabled()) {\n        logger.debug("Creating new JDBC Driver Connection to [" + url + "]");\n    }\n    // å“ˆå“ˆï¼Œé‡ç‚¹åœ¨è¿™... driver åœ¨è¯¥ç±»ä¸­è¢«é¢„å…ˆæ³¨å…¥\n    return driver.connect(url, props);\n}\n\n// -----------------------------\n// DriverManagerDataSource çš„å®ç°\n// -----------------------------\n@Override\nprotected Connection getConnectionFromDriver(Properties props) throws SQLException {\n    String url = getUrl();\n    Assert.state(url != null, "\'url\' not set");\n    if (logger.isDebugEnabled()) {\n        logger.debug("Creating new JDBC DriverManager Connection to [" + url + "]");\n    }\n    // è°ƒäº†ä¸ªå†…éƒ¨å‡½æ•°\n    return getConnectionFromDriverManager(url, props);\n}\n\nprotected Connection getConnectionFromDriverManager(String url, Properties props) throws SQLException {\n    // å§”æ‰˜ç»™ DriverManager ç±»æ¥è·å–è¿æ¥\n    // DriverManager çš„ä¸»è¦æ“ä½œæ˜¯éå†åœ¨è¯¥ç®¡ç†ç±»ä¸­æ³¨å†Œçš„ Driver\n    // æ¯ä¸ª Driver å®ä¾‹éƒ½å»å°è¯•ä¸€ä¸‹ï¼Œèƒ½ä¸èƒ½è·å¾—ä¸€ä¸ªè¿æ¥\n    // ç¬¬ä¸€æ¬¡åœ¨æŸä¸ª Driver ä¸­æ‹¿åˆ°ä¸€ä¸ªè¿æ¥å³è¿”å›è¿æ¥ (Connection)\n    return DriverManager.getConnection(url, props);\n}\n</code></pre>\n<p>ç®€è¦çš„ç±»å›¾å¦‚ä¸‹ï¼š</p>\n<p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1fncrgqcjqoj31es15ajxj.jpg"></p>\n<h2>DriverManager</h2>\n<p>ä¸Šé¢æåˆ° DataSource è·å–è¿æ¥(Connection) çš„æ“ä½œå®è´¨ä¸Šå°†å§”æ‰˜å…·ä½“çš„ Driver æ¥æä¾› Connection ã€‚æœ‰ä¸¤ç§ä¸åŒçš„æ–¹å¼ï¼ŒåŒ…æ‹¬ç»ç”± DriverManager éå†æ‰€æœ‰å¤„äºç®¡ç†ä¸‹çš„ Driver å°è¯•è·å–è¿æ¥ï¼Œæˆ–è€…åœ¨ DataSource å®ä¾‹ä¸­ç›´æ¥å£°æ˜ä¸€ä¸ªç‰¹å®šçš„ Driver æ¥è·å–è¿æ¥ã€‚</p>\n<p>å¯¹äºè·å–è¿æ¥çš„å…·ä½“æ“ä½œï¼ŒæŒ–å‘-å¾…å¡«ã€‚åªæè¿°ç®€å•çš„æ•°æ®åº“ä¾›åº”å•†æä¾›çš„ Driver å¦‚ä½•ä¸ java ç›¸è”ç³»ã€‚</p>\n<p>###åœ¨ DriverManager ä¸­æ³¨å†Œ Driver å®ä¾‹</p>\n<p>é€šå¸¸åœ¨ä¸æ•°æ®åº“äº¤äº’é€»è¾‘çš„ Java ä»£ç ä¸­ï¼Œéƒ½ä¼šæœ‰ <code>Class.forName("com.mysql.jdbc.Driver")</code> (æ­¤å¤„ä»¥ MySQL æä¾›çš„ mysql-connector-java-XXX.jar ä¸ºä¾‹ï¼Œä¸‹åŒï¼‰çš„ä»£ç å—ï¼ŒåŠ è½½æŒ‡å®šçš„ com.mysql.jdbc.Driver ä¸º java.lang.Class ç±»ã€‚</p>\n<p><em>å½“ç„¶ï¼Œåœ¨ JDBC 4.0 æ ‡å‡†ä¸‹ï¼Œå¯ä»¥ä¸å¿…å†æ˜¾ç¤ºå£°æ˜ <code>Class.forName("")</code> è¯­å¥ï¼ŒDriver ä¹ŸåŒæ ·ä¼šåœ¨ DriverManager åˆå§‹åŒ–æ—¶è‡ªåŠ¨æ³¨å†Œã€‚</em></p>\n<pre><code class="language-java">// Class ç±»ä¸­å¯¹äº forName(String className) çš„æ–¹æ³•\n// ä½œç”¨ä¸ºè¿”å›ä¸€ä¸ª java.lang.Class å®ä¾‹ã€‚\npublic static Class&#x3C;?> forName(String className) throws ClassNotFoundException {...}\n</code></pre>\n<p>åŒæ—¶ï¼Œ JVM åœ¨åŠ è½½ç±»çš„è¿‡ç¨‹ä¸­ä¼šæ‰§è¡Œç±»ä¸­çš„ static ä»£ç å—ã€‚ä¸‹è¿° row 10 ~ 16 çš„ä»£ç ç‰‡æ®µå°†è¢«æ‰§è¡Œã€‚å”¯ä¸€çš„é€»è¾‘å°±æ˜¯ new ä¸€ä¸ª com.mysql.jdbc.Driver å®ä¾‹ï¼Œå¹¶å°†å®ä¾‹æ³¨å†Œ(registerDriver) åˆ° <strong>java.sql.DriverManager</strong> ä¸­ã€‚ </p>\n<pre><code class="language-java">package com.mysql.jdbc;\n\npublic class Driver extends NonRegisteringDriver implements java.sql.Driver {\n    // ~ Static fields/initializers\n    // ---------------------------------------------\n\n    //\n    // Register ourselves with the DriverManager\n    //\n    static {\n        try {\n            java.sql.DriverManager.registerDriver(new Driver());\n        } catch (SQLException E) {\n            throw new RuntimeException("Can\'t register driver!");\n        }\n    }\n\n    // ~ Constructors\n    // -----------------------------------------------------------\n\n    /**\n     * Construct a new driver and register it with DriverManager\n     * \n     * @throws SQLException\n     *             if a database error occurs.\n     */\n    public Driver() throws SQLException {\n        // Required for Class.forName().newInstance()\n    }\n}\n</code></pre>\n<p>ä¸‹é¢å†æ¥çœ‹ä¸€ä¸‹ DriverManager ä¸­çš„ registerDriver() æ–¹æ³•ã€‚</p>\n<pre><code class="language-java">public class DriverManager {\n\n    // DriverManager ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Driver åˆ—è¡¨\n    // æ­¤å¤„çš„ DriverInfo é‡Œé¢å³åŒ…è£…äº† Driver \n    private final static CopyOnWriteArrayList&#x3C;DriverInfo> registeredDrivers = \n        new CopyOnWriteArrayList&#x3C;>();\n\n    // åœ¨ DriverManager ä¸­æ³¨å†Œ Driver\n    public static synchronized void registerDriver(java.sql.Driver driver)\n        throws SQLException {\n        registerDriver(driver, null);\n    }\n  \n    public static synchronized void registerDriver(java.sql.Driver driver,\n            DriverAction da)\n        throws SQLException {\n\n        /* å¦‚æœå½“å‰ Driver ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œå³æ·»åŠ åˆ°åˆ—è¡¨ã€‚ */\n        if(driver != null) {\n            registeredDrivers.addIfAbsent(new DriverInfo(driver, da));\n        } else {\n            // This is for compatibility with the original DriverManager\n            throw new NullPointerException();\n        }\n\n        println("registerDriver: " + driver);\n\n    }\n}\n</code></pre>\n<h3>é€šè¿‡ DriverManager è·å–è¿æ¥(Connection)</h3>\n<p>ä¸Šä¸€èŠ‚æœ‰æåˆ°è¿‡å¯ä»¥é€šè¿‡ DriverManager æ¥éå†è·å–è¿æ¥ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å£°æ˜å…·ä½“ Driver å¹¶è·å–è¿æ¥ã€‚ä¸‹é¢ä»£ç å±•ç¤ºçš„æ˜¯é€šè¿‡ DriverManager è·å–è¿æ¥çš„æ“ä½œã€‚ <del>å“ˆå“ˆå“ˆï¼Œåæ­£æœ€åéƒ½æ˜¯ç”±å…·ä½“é©±åŠ¨å®ç°è·å–è¿æ¥ã€‚</del></p>\n<pre><code class="language-java">public class DriverManager {\n    // è·å–è¿æ¥çš„ public æ¥å£ (1)\n    public static Connection getConnection(String url,\n        java.util.Properties info) throws SQLException {\n        return (getConnection(url, info, Reflection.getCallerClass()));\n    }\n    // è·å–è¿æ¥çš„ public æ¥å£ (2)\n    public static Connection getConnection(String url,\n        String user, String password) throws SQLException {\n        java.util.Properties info = new java.util.Properties();\n\n        if (user != null) {\n            info.put("user", user);\n        }\n        if (password != null) {\n            info.put("password", password);\n        }\n\n        return (getConnection(url, info, Reflection.getCallerClass()));\n    }\n    // è·å–è¿æ¥çš„ public æ¥å£ (3)\n    public static Connection getConnection(String url)\n        throws SQLException {\n        java.util.Properties info = new java.util.Properties();\n        return (getConnection(url, info, Reflection.getCallerClass()));\n    }\n \n    // è·å–è¿æ¥çš„å†…éƒ¨é€»è¾‘å®ç°\n    private static Connection getConnection(\n        String url, java.util.Properties info, Class&#x3C;?> caller) \n        throws SQLException {\n        /*\n         * When callerCl is null, we should check the application\'s\n         * (which is invoking this class indirectly)\n         * classloader, so that the JDBC driver class outside rt.jar\n         * can be loaded from here.\n         */\n        ClassLoader callerCL = caller != null ? caller.getClassLoader() : null;\n        synchronized(DriverManager.class) {\n            // synchronize loading of the correct classloader.\n            if (callerCL == null) {\n                callerCL = Thread.currentThread().getContextClassLoader();\n            }\n        }\n        // url æ˜¯å®šä½ DBMS æœ€é‡è¦çš„å‚æ•°ï¼Œä¸èƒ½ä¸ºç©º\n        if(url == null) {\n            throw new SQLException("The url cannot be null", "08001");\n        }\n\n        println("DriverManager.getConnection(\\"" + url + "\\")");\n\n        // éå†æ‰€æœ‰æ³¨å†Œçš„ Driver ï¼Œå¹¶éƒ½å°è¯•è·å–è¿æ¥(Connection)\n        SQLException reason = null;\n\n        for(DriverInfo aDriver : registeredDrivers) {\n            // åˆ¤æ–­æ³¨å†Œçš„ Driver æ˜¯å¦ç”± ClassLoader callerCL åŠ è½½ï¼Œä¸æ˜¯åˆ™è·³è¿‡\n            if(isDriverAllowed(aDriver.driver, callerCL)) {\n                try {\n                    println("    trying " + aDriver.driver.getClass().getName());\n                    // è·å–è¿æ¥ï¼Œ:) è¿˜æ˜¯ç”± driver å®ä¾‹è‡ªè¡Œæä¾›\n                    Connection con = aDriver.driver.connect(url, info);\n                    if (con != null) {\n                        // Success!\n                        println("getConnection returning " + \n                                aDriver.driver.getClass().getName());\n                        return (con);\n                    }\n                } catch (SQLException ex) {\n                    if (reason == null) {\n                        reason = ex;\n                    }\n                }\n\n            } else {\n                println("    skipping: " + aDriver.getClass().getName());\n            }\n\n        }\n\n        // å¦‚æœè¿è¡Œåˆ°ä¸‹åˆ—ä»£ç ï¼Œåˆ™è¡¨æ˜è·å–è¿æ¥å¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯\n        if (reason != null)    {\n            println("getConnection failed: " + reason);\n            throw reason;\n        }\n\n        println("getConnection: no suitable driver found for "+ url);\n        throw new SQLException("No suitable driver found for "+ url, "08001");\n    }\n\n}\n</code></pre>\n<p><em>ç®€å•çš„æä¸€å˜´ï¼ŒConnection ä»ç„¶åªæ˜¯ä¸€ä¸ªé’ˆå¯¹ Java -> DB Server çš„ä¸Šå±‚æ¥å£ï¼Œå¦‚æœæƒ³è¦æ›´æ·±å±‚æ¬¡åœ°äº†è§£ Connection ä¸ DB Server çš„äº¤äº’ï¼Œå¯ä»¥å°è¯•å»çœ‹ä¸€ä¸‹ com.mysql.jdbc.MysqlIO ç±»ï¼ŒMySQL å®ç°çš„ JDBC4Connection ç±»ä¹Ÿæ˜¯åœ¨ä½¿ç”¨è¯¥ç±»æ¥å®ç°å¯¹ DB Server äº¤äº’ã€‚ï¼ˆå“ˆå“ˆï¼Œåªçœ‹è¿‡ MySQL æä¾›çš„ Driver åŒ…ï¼‰ã€‚</em></p>\n<h2>PreparedStatement &#x26; CallableStatement</h2>\n<p>åœ¨äº†è§£äº† DataSource è·å–è¿æ¥(Connection) çš„å®è´¨ä»¥åŠ JdbcTemplate çš„é€šç”¨æ¥å£ä¹‹åï¼Œä½¿ç”¨ Spring-jdbc è¿›è¡Œæ•°æ®åº“ç›¸å…³çš„æ“ä½œå¯ä»¥ç›´æˆªäº†å½“çš„åˆ©ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œå®ç°ï¼ˆæ­¤å¤„ä»…å±•ç¤ºé€šè¿‡ Java ç¡¬ç¼–ç çš„å½¢å¼è¿›è¡Œå®ç°ï¼ŒXML é…ç½®æ–¹æ³•ç±»ä¼¼ï¼‰ã€‚</p>\n<pre><code class="language-java">public static void main(String... args) {\n    // å®šä¹‰æ•°æ®æº\n    DriverManagerDataSource dataSource = new DriverManagerDataSource();\n    // é…ç½®å‚æ•°\n    dataSource.setUrl("jdbc:mysql://&#x3C;host>:&#x3C;port>/&#x3C;dbName>?&#x3C;props>");\n    dataSource.setUsername("&#x3C;username>");\n    dataSource.setPassword("&#x3C;passwd>");\n    \n    // å®ä¾‹åŒ–ä¸€ä¸ª JDBC å·¥å…·ç±»\n    JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);\n    // æ‰§è¡Œç›¸å…³ CRUD æ“ä½œ \n    jdbcTemplate.execute();\n}\n</code></pre>\n<p>å›é¡¾ç¬¬ä¸€èŠ‚æ‰€è®²çš„ JdbcTemplate çš„ 4 ä¸ªåŸºç¡€æ–¹æ³•ï¼š</p>\n<ol>\n<li><code>&#x3C;T> T execute(ConnectionCallback&#x3C;T> action);</code></li>\n<li><code>&#x3C;T> T execute(StatementCallback&#x3C;T> action);</code></li>\n<li><code>&#x3C;T> T execute(PreparedStatementCreator psc, PreparedStatementCallback&#x3C;T> action);</code></li>\n<li><code>&#x3C;T> T execute(CallableStatementCreator csc, CallableStatementCallback&#x3C;T> action);</code></li>\n</ol>\n<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fndsm5tl7aj30zg0byq47.jpg"></p>\n<p>å››ä¸ªåŸºç¡€æ–¹æ³•éƒ½æœ‰ä¸€ä¸ªç‰¹å®šçš„å›è°ƒå‡½æ•°å°†é€šè¿‡é¢„é…ç½®çš„ DataSource å¾—åˆ°çš„ Connection æˆ– æ›´è¿›ä¸€æ­¥çš„ Statement or PreparedStatement or CallableStatement ä½œä¸ºå…¥å‚æ¥æ‰§è¡Œå®šä¹‰çš„å”¯ä¸€æ–¹æ³•ã€‚</p>\n<p>ä»¥ <code>&#x3C;T> T execute(StatementCallback&#x3C;T> action);</code> ä¸ºä¾‹æ¥äº†è§£ä¸€ä¸‹æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘ã€‚</p>\n<pre><code class="language-java">public &#x3C;T> T execute(StatementCallback&#x3C;T> action) throws DataAccessException {\n    // é€šè¿‡å·¥å…·ç±» DataSourceUtils è·å–ä¸€ä¸ªè¿æ¥\n    Connection con = DataSourceUtils.getConnection(obtainDataSource());\n    // ä¸€ä¸ª Statement ç©ºå®ä¾‹ï¼ŒPreparedStatement, CallableStatement ç±»ä¼¼\n    Statement stmt = null;\n    try {\n        stmt = con.createStatement();   // é€šè¿‡è¿æ¥(Connection)è·å–ä¸€ä¸ª Statement\n        applyStatementSettings(stmt);   // é…ç½® Statement å‚æ•°\n        // å›è°ƒæ‰§è¡Œ doInXXX() æ–¹æ³•, å¹¶è·å¾— result\n        T result = action.doInStatement(stmt);  \n        handleWarnings(stmt);\n        return result;\n    } catch() {\n      \n    } finally {\n      \n    }\n}\n</code></pre>\n<p>ä½†æ˜¯ï¼Œå¯¹äº PreparedStatement å’Œ CallableStatement è€Œè¨€ï¼Œè·å–ä¸€ä¸ª <em>XXX</em>Statement çš„æ–¹å¼å°±æœ‰æ‰€ä¸åŒäº†ã€‚</p>\n<pre><code class="language-java">// è·å– Statement å®ä¾‹\nStatement stmt = con.createStatement();\n</code></pre>\n<pre><code class="language-java">// è·å– PreparedStatement å®ä¾‹\n// psc æ˜¯ä¸€ä¸ª PreparedStatementCreator æ¥å£å®ç°çš„å®ä¾‹\nPreparedStatement ps = psc.createPreparedStatement(con);\n</code></pre>\n<pre><code class="language-java">// è·å– CallableStatement å®ä¾‹\n// csc æ˜¯ä¸€ä¸ª CallableStatementCreator æ¥å£å®ç°çš„å®ä¾‹\nCallableStatement cs = csc.createCallableStatement(con);\n</code></pre>\n<p>å¯ä»¥çœ‹åˆ° Statement ç›´æ¥é€šè¿‡ Connection è·å–å®ä¾‹ï¼Œä½†æ˜¯ PreparedStatement å’Œ CallableStatement å°±æœ‰æ‰€ä¸åŒï¼Œå…¶åŒºåˆ«å°±åœ¨äº PreparedStatement å’Œ CallableStatement ä¸¤ä¸ª Statement éƒ½æ˜¯å¯ä»¥å®šåˆ¶å…¥å‚çš„ï¼Œæ›´ç”šè€…ï¼Œ CallableStatement å¯ä»¥å®šåˆ¶ DB æ‰§è¡Œç»“æœçš„å‡ºå‚ã€‚å½“ç„¶ï¼Œæ ¸å¿ƒè¿˜æ˜¯ <code>con.prepareStatement() OR con.prepareCall()</code> æ–¹æ³•ï¼Œåªä¸è¿‡æ˜¯å°†è·å– XXXStatement çš„æ“ä½œä¸‹æ”¾ç»™ XXXStatementCreator å®ä¾‹ç±»å®ç°ï¼Œç»™äºˆä½¿ç”¨è€…é‡å¤çš„è‡ªä¸»æƒï¼ŒåŒæ—¶ä¹Ÿæ˜¯é€»è¾‘è§£è€¦çš„ä¸€ç§æ“ä½œã€‚</p>\n<p>ä¾‹å¦‚ï¼š</p>\n<p>SimplePreparedStatementCreator è¿™ä¸ª PreparedStatementCreator æ¥å£çš„å®ç°ç±»ï¼Œåªæ˜¯ç®€å•çš„è°ƒç”¨äº† <code>con.prepareStatement(sql)</code> æ–¹æ³•ã€‚</p>\n<pre><code class="language-java">private static class SimplePreparedStatementCreator \n    implements PreparedStatementCreator, SqlProvider {\n\n    private final String sql;\n\n    @Override\n    public PreparedStatement createPreparedStatement(Connection con) \n        throws SQLException {\n        return con.prepareStatement(this.sql);\n    }\n}\n</code></pre>\n<p>è€Œå¯¹äº PreparedStatementCreatorImpl ï¼Œåœ¨ createPreparedStatement(Connection con) çš„å®ç°ä¸Šï¼Œåˆæ·»åŠ äº†æ›´å¤šçš„æ“ä½œã€‚</p>\n<pre><code class="language-java">private class PreparedStatementCreatorImpl\n        implements PreparedStatementCreator, PreparedStatementSetter, SqlProvider, ParameterDisposer {\n\n    private final String actualSql;\n\n    private final List&#x3C;?> parameters;\n\n    @Override\n    public PreparedStatement createPreparedStatement(Connection con) throws SQLException {\n        PreparedStatement ps;\n        if (generatedKeysColumnNames != null || returnGeneratedKeys) {\n            if (generatedKeysColumnNames != null) {\n                // è·å–ä¸€ä¸ª PreparedStatement å®ä¾‹ï¼Œä¸‹åŒ\n                ps = con.prepareStatement(this.actualSql, \n                                          generatedKeysColumnNames);\n            }\n            else {\n                ps = con.prepareStatement(this.actualSql, \n                                         PreparedStatement.RETURN_GENERATED_KEYS);\n            }\n        }\n        else if (resultSetType == ResultSet.TYPE_FORWARD_ONLY \n                 &#x26;&#x26; !updatableResults) {\n            ps = con.prepareStatement(this.actualSql);\n        }\n        else {\n            ps = con.prepareStatement(this.actualSql, resultSetType,\n                updatableResults ? ResultSet.CONCUR_UPDATABLE : \n                                      ResultSet.CONCUR_READ_ONLY);\n        }\n        // å°†å¯å˜ SQL (ä¾‹å¦‚ SELECT * FROM msg WHERE id = ?) çš„ ? ç”¨å®é™…å‚æ•°æ›¿æ¢\n        setValues(ps);\n        return ps;\n    }\n}\n</code></pre>\n<p>ä»ä¸Šè¿°ä¸¤ç§ PreparedStatementCreator æ¥å£çš„ä¸åŒå®ç°ï¼Œä¹Ÿå¯ä»¥ä»å¦ä¸€ç§è§’åº¦ç†è§£åˆ°ï¼Œå‡½æ•°å¼æ¥å£å°†è·å–ç›®æ ‡å‡ºå‚çš„å…·ä½“é€»è¾‘äº¤ç»™ä½¿ç”¨è€…å®šä¹‰ï¼Œç»™äºˆäº†ä½¿ç”¨è€…å……åˆ†çš„è‡ªä¸»æƒï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ç§ä¸šåŠ¡é€»è¾‘çš„è§£è€¦ã€‚</p>\n<p>åœ¨ä¸Šé¢ä»£ç  PreparedStatementCreatorImpl ç±»çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ç¬¬ 32 è¡Œä»£ç  <code>setValue(ps)</code> ã€‚æ­¤å¤„çš„æ–¹æ³•æ˜¯ç”±æ¥å£ PreparedStatementSetter å®šä¹‰çš„ã€‚ä¸»è¦ç›®çš„æ˜¯å°†å¯å˜ SQL ä¸­çš„ ? å‚æ•°ç”¨å®é™…å‚æ•°è¿›è¡Œä¸€ä¸ªæ›¿æ¢ã€‚</p>\n<pre><code class="language-java">// ä»¥ SQL (SELECT * FROM msg WHERE id = ? AND day = ?) ä¸ºä¾‹\n/** çº¯ Java æ ¸å¿ƒåº“çš„å®ç° PreparedStatement å‚æ•°æ³¨å…¥ */\nps.setInt(1, 1763);\nps.setString(2, "2018-01-01");\nps.executeQuery();\n\n/** ä»¥ Spring-jdbc å®ç° PreparedStatement å‚æ•°æ³¨å…¥ */\n// setValues() ç”±æ¥å£ PreparedStatementSetter å®šä¹‰ï¼Œå°è£…äº†æ³¨å…¥å‚æ•°çš„å…·ä½“å®ç°é€»è¾‘\n// å¯ä»¥ç”±ä½¿ç”¨è€…è‡ªè¡Œå®šä¹‰\nsetValues(ps);  \nps.executeQuery();\n</code></pre>\n<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fndyybh4q1j31kw0u3afx.jpg"></p>\n<p>ä¸Šé¢ç±»å›¾è¡¨ç¤ºäº† PreparedStatementSetter åŠå…¶å®ç°ç±»çš„ç›¸å…³ä¾èµ–ã€‚</p>\n<p>Setter çš„ä¸»è¦ç›®æ ‡å³ä¸ºå¯¹ SQL ä¸­çš„ ? å‚æ•°è¿›è¡Œæ³¨å…¥ã€‚</p>\n<p><del>ä¸ªäººç²¾åŠ›æœ‰é™ï¼Œå¯¹Spring-jdbcåœ¨Statementä¸Šå¯¹å‚æ•°æ³¨å…¥çš„å›è°ƒç†è§£æœ‰é™ã€‚</del></p>\n<h2>ResultSet</h2>\n<p>åœ¨å‰å‡ èŠ‚å·²ç»æåˆ°è®²äº†æ•°æ®æºã€é©±åŠ¨ç®¡ç†å™¨ä»¥åŠ Statement ä¹‹åï¼Œåˆ©ç”¨ JDBC çš„æœ€é‡è¦çš„ç›®çš„å°±æ˜¯å¯¹ DB è¿›è¡Œæ“ä½œï¼Œå¹¶è·å¾—é¢„æœŸç»“æœã€‚å¯¹äºæŸ¥è¯¢è¯­å¥è€Œè¨€ï¼Œç»“æœåº”è¯¥æ˜¯è‹¥å¹²è®°å½•è¡Œï¼›å°±æ›´æ–°è¯­å¥è€Œè¨€ï¼Œç»“æœå¯èƒ½æ˜¯å½±å“çš„è¡Œæ•°ã€‚è€Œ Spring-jdbc å¯¹ ResultSet é¢å¤–è¿›è¡Œçš„å°è£…ï¼Œå³æ˜¯å°†åŸæœ¬æ•£ä¹±çš„ç»“æœè¿›è¡Œä¸€ä¸ªæ•´åˆï¼Œä¾‹å¦‚æ•´åˆæˆä¸€ä¸ª(ä¸€ç»„)å®Œæ•´çš„ Bean æ¥è¿›è¡Œå±•ç¤ºã€‚</p>\n<p>åœ¨ JdbcTemplate ä¸­ï¼Œå››ä¸ªåŸºæœ¬æ–¹æ³•å…¥å‚éƒ½åŒ…æ‹¬ä¸€ä¸ªå›è°ƒæ¥å£ï¼Œè€Œåœ¨æ‰§è¡Œå›è°ƒè·å¾— ResultSet ä¹‹åï¼Œæ–¹æ³•å¹¶ä¸æ˜¯ç›´æ¥è¿”å›ï¼Œè€Œæ˜¯è¿›è¡Œäº†ä¸€å®šçš„æ“ä½œã€‚</p>\n<p>ä»¥ä¸€ä¸ª PreparedStatementCallback çš„å®ä¾‹ç±»ä¸ºä¾‹ï¼Œåœ¨ doInPreparedStatement() æ–¹æ³•ä¸­ï¼Œè·å¾—äº† ResultSet ï¼Œä½†æ˜¯ä»é€šè¿‡ rse.extractData(rs) è¯­å¥è¿›è¡Œäº†å¤„ç†åå†è¿”å›ç»“æœ</p>\n<pre><code class="language-java">public T doInPreparedStatement(PreparedStatement ps) throws SQLException {\n    // å£°æ˜ä¸€ä¸ª ResultSet \n    ResultSet rs = null;\n    try {\n        if (pss != null) {  // setValues() æ–¹æ³•å¡«å…… PreparedStatement ä¸­çš„å¯å˜å‚æ•° ? \n            pss.setValues(ps);\n        }\n        rs = ps.executeQuery(); // æ‰§è¡ŒæŸ¥è¯¢ sql ï¼Œè·å–ç»“æœ\n        return rse.extractData(rs); // é‡ç‚¹... è¯¥è¯­å¥ä¸€å®šæ˜¯å¯¹ç»“æœè¿›è¡Œäº†ä¸€äº›æ“ä½œ.\n    }\n    finally {\n        JdbcUtils.closeResultSet(rs);\n        if (pss instanceof ParameterDisposer) {\n            ((ParameterDisposer) pss).cleanupParameters();\n        }\n    }\n}\n</code></pre>\n<p>åœ¨æ¥çœ‹ä¸€ä¸‹ç©¶ç«Ÿåœ¨è¿”å›ç»“æœå‰è¿›è¡Œäº†ä»€ä¹ˆæ“ä½œã€‚</p>\n<p>ç”±äºæ˜¯ä¸€ä¸ªå›è°ƒæ¥å£çš„å®ç°ç±»ï¼Œrse åº”è¯¥åœ¨å¤–éƒ¨æ–¹æ³•ä¸­ã€‚</p>\n<pre><code class="language-java">public &#x3C;T> T query(\n        PreparedStatementCreator psc, @Nullable final PreparedStatementSetter pss, \n        final ResultSetExtractor&#x3C;T> rse)\n        throws DataAccessException {\n\n    return execute(psc, new PreparedStatementCallback&#x3C;T>() {\n        @Override\n        public T doInPreparedStatement(PreparedStatement ps) throws SQLException {\n            ... \n        }\n    });\n}\n</code></pre>\n<p>å¯ä»¥çœ‹åˆ° rse æ˜¯ä¸€ä¸ª ResultSetExtractor çš„å®ä¾‹ã€‚ä»åç§°ä¸Šå¯ä»¥çœ‹å‡º Extractor å³ä¸ºæå–å™¨ï¼Œç»“æœé›†æå–å™¨ã€‚</p>\n<pre><code class="language-java">/** å‡½æ•°å¼æ¥å£ï¼Œæä¾›çš„å”¯ä¸€æ–¹æ³•ä¸º extractData(...) */\n@FunctionalInterface\npublic interface ResultSetExtractor&#x3C;T> {\n\n    @Nullable\n    T extractData(ResultSet rs) throws SQLException, DataAccessException;\n\n}\n</code></pre>\n<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fndzz0pqnrj31a60i676v.jpg"></p>\n<p>Spring-jdbc ä¸­ç°æœ‰çš„å®ç°æœ‰ä¸‰ä¸ªç±»ï¼Œå…¶ä¸­ RowCallbackHandlerResultSetExtractor å’Œ RowMapperResultSetExtractor ä¸¤ä¸ªç±»ä»ä¸Šé¢ç±»å›¾åŠå‘½åå³å¯çœ‹å‡ºï¼Œä¸¤ä¸ªæ˜¯ä½œä¸ºä¸€ä¸ªé€‚é…å™¨è€Œå­˜åœ¨çš„ï¼Œå°† extractData() è¿›è¡Œè½¬æ¢ï¼Œåˆ†åˆ«ç”± RowCallbackHandler å’Œ RowMapper å®ä¾‹è¿›è¡Œå…·ä½“æ“ä½œã€‚è€Œ AbstractLobStreamingResultSetExtractor ç±»ä»åç§°ä¸Šçœ‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç±»ä¼¼æµæ“ä½œçš„å®ç°ç±»(å…¶ä¸­çš„ Lob æŒ‡çš„æ˜¯ DB ä¸­çš„ BLOB ä¸ CLOB ç±»å‹ï¼Œåœ¨ Spring-jdbc ä¸­ä¹ŸåŠ å…¥äº†é¢å¤–çš„æ”¯æŒ) ã€‚</p>\n<h3>RowCallbackHandler</h3>\n<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fnh2uw3a0aj30h20jeta4.jpg"></p>\n<p>ä»åç§°ä¸Šçœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸ ResultSet ç»“æœé›†è¡Œç›¸å…³çš„å›è°ƒæ¥å£ã€‚processRow(ResultSet rs) æ–¹æ³•å°†å¤„ç†è¡Œç›¸å…³çš„é€»è¾‘ã€‚</p>\n<p>ä»å®ƒçš„ä¸€ä¸ªå®ç°ç±» RowCountCallbackHandler æ¥è¯´ï¼Œå…¶æœ€ä¸»è¦çš„ç§æœ‰å±æ€§ rowCount å³æ˜¯ç»Ÿè®¡ ResultSet çš„ç»“æœè¡Œæ•°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“ä½¿ç”¨çš„è¯¥ç±»çš„æ¡ˆä¾‹ï¼š</p>\n<pre><code class="language-java">public static void main(String[] args) throws ClassNotFoundException {\n\n    DriverManagerDataSource dataSource = new DriverManagerDataSource();\n    dataSource.setUrl("jdbc:mysql://&#x3C;host>:&#x3C;port>/&#x3C;dbName>");\n    dataSource.setUsername("&#x3C;username>");\n    dataSource.setPassword("&#x3C;password>");\n\n    JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);\n    RowCountCallbackHandler rcch = new RowCountCallbackHandler();\n\n    jdbcTemplate.query("SELECT * FROM info WHERE id=\'2018\'", (RowCallbackHandler) rcch);\n    \n    System.out.println(rcch.getRowCount()); //è·å–ç»“æœé›†è¡Œæ•°\n    System.out.println(rcch.getColumnCount());  // è·å–ç»“æœé›†åˆ—æ•°\n    for (String arg : rcch.getColumnNames()) {  // æ‰“å°ç»“æœé›†æ¯ä¸€åˆ—åç§°\n        System.out.println("ColumnNames : " + arg);\n    }\n    for (int i : rcch.getColumnTypes()) {   // æ‰“å°ç»“æœé›†æ¯ä¸€åˆ—ç±»å‹(Types ä¸ºæšä¸¾ç±»)\n        System.out.println("ColumnTypes : " + i);\n    }\n}\n</code></pre>\n<p>å…·ä½“æŸ¥çœ‹ RowCountCallbackHandler ç±»çš„ processRow() æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œå…¶è·å–åˆ—ç›¸å…³ä¿¡æ¯éƒ½æ¥è‡ªäº ResultSetMetaData ã€‚è€Œç»“æœè¡Œæ•°æ¥æºäº Iterator è¿­ä»£ã€‚</p>\n<pre><code class="language-java">@Override\npublic final void processRow(ResultSet rs) throws SQLException {\n    if (this.rowCount == 0) {\n        ResultSetMetaData rsmd = rs.getMetaData();\n        this.columnCount = rsmd.getColumnCount();\n        this.columnTypes = new int[this.columnCount];\n        this.columnNames = new String[this.columnCount];\n        for (int i = 0; i &#x3C; this.columnCount; i++) {\n            this.columnTypes[i] = rsmd.getColumnType(i + 1);\n            this.columnNames[i] = JdbcUtils.lookupColumnName(rsmd, i + 1);\n        }\n        // could also get column names\n    }\n    processRow(rs, this.rowCount++);\n}\n</code></pre>\n<h3>RowMapper</h3>\n<p>ä¸Šé¢ RowCallbackHandler æ¥å£ä»é€»è¾‘ä¸Šåˆ’åˆ†æ˜¯ç”¨äºå¤„ç† ResultSet å…ƒæ•°æ®ä¿¡æ¯çš„ã€‚è€Œ RowMapper è¾ƒä¸Šä¸€ä¸ªæ¥å£è€Œè¨€ï¼Œæœ‰æ›´é«˜çš„å®ç”¨æ€§ã€‚</p>\n<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fnh3h739kaj30z60nago4.jpg"></p>\n<p>ç‰¹åˆ«æ˜¯å…¶å®ç°ç±» BeanPropertyRowMapper å¯ä»¥å°†æ•£ä¹±çš„ ResultSet çš„ç»“æœæ•°æ®æ•´ç†æˆä¸€ä¸ªä¸ª Object Bean ä½œä¸ºè¿”å›ç»“æœã€‚è€Œçœå»äº†å¯¹é€ä¸€è¯»å– ResultSet è¡Œè®°å½•å¹¶å¡«å…… Bean å±æ€§çš„éº»çƒ¦ã€‚</p>\n<pre><code class="language-java">JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);\n\nBeanPropertyRowMapper&#x3C;Model> rowMapper = new BeanPropertyRowMapper&#x3C;>(Model.class);\nList&#x3C;Model> list = jdbcTemplate.query("SELECT * FROM info WHERE id = \'2018\'", rowMapper);\n/** è·å¾—çš„ Model list çš„å¯¹åº”å±æ€§å°†é€šè¿‡ Java çš„åå°„æœºåˆ¶è¿›è¡Œå¡«å……\n *  List&#x3C;Model> list å³ç»“æœ\n */\n</code></pre>\n<p>å½“ç„¶ï¼Œè¦æ±‚æ˜¯ Model ç±»ä¸­çš„å±æ€§ä¸ DB table ä¸­çš„åˆ—åä¿æŒä¸€è‡´ï¼ˆå¤§å°å†™æ— è¦æ±‚ï¼‰ã€‚</p>\n<p>è€Œå…¶å®ƒä¸¤ä¸ªç±»çš„å®ç°ä¹Ÿæ˜¯åŸºäºåå°„æœºåˆ¶ï¼Œå®ç°å…¶ç›¸åº”çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>\n<pre><code class="language-text">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},"9vk+":function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>title: ç†è§£ Linux Kernel (8) - ç½‘ç»œ\nauthor: fangfeng\ndate: 2019-01-15\ntags:</p>\n<ul>\n<li>Linux</li>\n<li>Kernel</li>\n<li>Network</li>\n</ul>\n<hr>\n<p>{% pdf <a href="https://drive.google.com/file/d/1l5Vjrs8vKy6b9EvZFP7c7hOblv2kHgNx/preview">https://drive.google.com/file/d/1l5Vjrs8vKy6b9EvZFP7c7hOblv2kHgNx/preview</a> %}</p>'}},"B/bq":function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<h2>æ¦‚è¿°</h2>\n<p>ã€Šåªæ˜¯ä¸ºäº†å¥½ç©ã€‹ä¸€ä¹¦ä¸­ï¼Œæ—çº³æ–¯æè¿°è¿‡ä»–æœ€æ—©çš„è¯•éªŒæ€§ç¨‹åºå°±æ˜¯è®© CPU æ‰§è¡Œä¸¤ä¸ªä¸åŒçš„ä»»åŠ¡(ä¸€ä¸ªä¸æ–­è¾“å‡ºAï¼Œå¦ä¸€ä¸ªè¾“å‡ºB)ï¼ŒåŒæ—¶ä¸æ–­åœ°è®© CPU åœ¨ä¸¤ä¸ªä»»åŠ¡é—´çš„åˆ‡æ¢ã€‚</p>\n<p>ç»“åˆã€ŠLinux å†…æ ¸å®Œå…¨æ³¨é‡Šã€‹ä¸€ä¹¦ï¼Œå¾—åˆ°äº†å¤šä»»åŠ¡åˆ‡æ¢çš„ç¤ºä¾‹ç¨‹åºã€‚</p>\n<p>æœ¬èŠ‚æ‰€è¦æè¿°çš„å†…å®¹ï¼Œæ­£æ˜¯ç»“åˆä¸€ä¸ªæ¡†æ¶å¼çš„æ±‡ç¼–ç¨‹åº(å¤šä»»åŠ¡åˆ‡æ¢ç¨‹åº, ä¹¦ä¸­æä¾›çš„å†…å®¹æ¯”è¾ƒè€ï¼Œæ— æ³•é€‚åº”ç›®å‰çš„å„ç§å·¥å…·ã€ç¯å¢ƒ)ï¼Œåœ¨ç°æœ‰ç¯å¢ƒä¸­åŠ ä»¥å¤„ç†å¹¶æˆåŠŸè¿è¡Œã€‚</p>\n<p>å…³äºè¿è¡Œç¯å¢ƒçš„è¯´æ˜ï¼Œæ¬¢è¿å‚è€ƒ <a href="https://dormouse-none.github.io/2018-08-19-understand-Kernel-0/">ç†è§£ Linux Kernel (0)</a></p>\n<h2>å¼•å¯¼ç¨‹åº</h2>\n<p>åœ¨ <a href="https://dormouse-none.github.io/2018-08-19-understand-Kernel-1/">ç†è§£ Linux Kernel (1)</a> å·²ç»æè¿°è¿‡é€šè¿‡ BIOS åŠ è½½å¼•å¯¼ç¨‹åºï¼Œå¹¶æ‰§è¡Œå¼•å¯¼ç¨‹åºçš„å…¨éƒ¨æµç¨‹ã€‚\nå½“ç„¶ï¼Œä¹Ÿå°±ä»…ä»…åˆ°å¼•å¯¼ç¨‹åºå°±ç»“æŸäº†ã€‚è¯¸å¦‚æ“ä½œç³»ç»Ÿä¹‹ç±»çš„å†…å®¹æ ¹æœ¬å°±æ²¡æœ‰æ¶‰åŠã€‚</p>\n<p>ä¸è¿‡ï¼Œæ— è®ºæ˜¯æ“ä½œç³»ç»Ÿï¼Œè¿˜æ˜¯ç”¨æˆ·ç¨‹åºï¼Œéƒ½æ˜¯åŸºäº CPUã€å†…å­˜ç­‰ç¡¬ä»¶è€Œè¿›ä¸€æ­¥æŠ½è±¡çš„ä¸Šå±‚æ¦‚å¿µã€‚å¦‚æœé—®æ²¡æœ‰æ“ä½œç³»ç»Ÿè€Œç›´æ¥è¿è¡Œç¨‹åºæ˜¯å¦å¯è¡Œï¼Ÿæ¯«æ— ç–‘é—®ï¼Œè¿™ç»å¯¹æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p>\n<p>CPU åªæ˜¯å¿ å®åœ°æ‰§è¡Œå¯„å­˜å™¨å®šä½åˆ°çš„æœºå™¨æŒ‡ä»¤ï¼Œå¹¶åŠ ä»¥æ‰§è¡Œã€‚ç‰¹åˆ«æ˜¯ï¼Œå¦‚æœåœ¨ <a href="https://dormouse-none.github.io/2018-08-19-understand-Kernel-1/">ç†è§£ Linux Kernel (1)</a> æä¾›çš„è¾“å‡º "System Loading..." çš„ç¤ºä¾‹ç¨‹åºä¸Šç»§ç»­åŠ ä»¥æ”¹ç¼–ï¼Œæ— è®ºæ˜¯ç®—æœ¯è¿ç®—ã€æ˜¾ç¤ºæ–‡æœ¬ç­‰ç­‰ç›®çš„éƒ½æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚\nå½“ç„¶ï¼Œé™åˆ¶ä¹Ÿè¿˜æ˜¯æœ‰çš„ï¼Œ512B æ˜¯å¼•å¯¼ç¨‹åºçš„ä¸Šé™ã€‚</p>\n<p>åœ¨æœºå™¨ä¸Šç”µå¯åŠ¨ä¹‹åï¼Œå­˜å‚¨åœ¨éæ˜“å¤±æ€§å­˜å‚¨å™¨ / åªè¯»å­˜å‚¨å™¨ä¸Šçš„ BIOS ç¨‹åºå°†è¢«åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶è¿›è¡Œæ‰§è¡Œ(è‡³äºç»†èŠ‚ï¼Œä¸ç”šäº†è§£ï¼Œä¸è¡¨)\nä¹‹åï¼ŒBIOS å°†é»˜è®¤åœ°å°†æŒ‡å®šç£ç›˜(è½¯ç›˜ã€ç¡¬ç›˜ç­‰) é¦–ä¸ªæ‰‡åŒº 512 å­—èŠ‚çš„å†…å®¹(ç§°ä¸º boot å¼•å¯¼ç¨‹åº)åŠ è½½åˆ°å†…å­˜åœ°å€ï¼Œå¹¶ JMP åˆ° CS:IP = 0x07c00:0x0000 çš„ä½ç½®ã€‚ä»è€Œè§¦å‘å¼•å¯¼ç¨‹åºã€‚</p>\n<p>ç»§è€Œï¼Œå¦‚æœåœ¨ç¼–å†™ boot å¼•å¯¼ç¨‹åºçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿å…¶èƒ½å¤Ÿä»å¤–å­˜åŠ è½½é¢å¤–çš„ä»£ç ï¼Œå¹¶åœ¨å¼•å¯¼ç¨‹åºç»“æŸä½ç½®å°† CPU çš„æ§åˆ¶æƒäº¤ç»™è¿™æ®µé¢å¤–åŠ è½½çš„ä»£ç ã€‚æ˜¾ç„¶ï¼Œæ“ä½œç³»ç»Ÿå°±æ˜¯è¿™æ ·å­è¢«åŠ è½½çš„ã€‚</p>\n<p><code>BIOS -> boot å¼•å¯¼ç¨‹åº -> æ“ä½œç³»ç»Ÿå¼•å¯¼ç¨‹åº -> æ“ä½œç³»ç»Ÿ</code>\nè¿™å°±æ„æˆäº†ä¸€ä¸ªå®è§‚çš„æ“ä½œç³»ç»Ÿå¯åŠ¨çš„ä¸€ä¸ªæµç¨‹ã€‚</p>\n<p>boot.s å¼•å¯¼ç¨‹åº ä¸»ä½“ä»£ç æ¥è‡ªã€ŠLinux å†…æ ¸å®Œå…¨æ³¨é‡Šã€‹ï¼Œè¿›è¡Œäº†ä¸€å®šé‡çš„æ”¹å†™</p>\n<pre><code>BOOTSEG = 0x07c0\nSYSSEG = 0x0100\nSYSLEN = 17\n\nentry start\nstart:\n    jmpi    go,#BOOTSEG\ngo:\n    mov ax,cs\n    mov ds,ax\n    mov ss,ax\n    mov sp,#0x0400\n\nload_system:\n    xor dx,dx       ! å¼€å§‹ä½ç½®, ç£å¤´:ç¡¬ç›˜å·\n    mov cx,#0x0002  ! å¼€å§‹ä½ç½®, ç£é“:æ‰‡åŒº\n    mov ax,#0x0100\n    mov es,ax       ! è½½å…¥åˆ°, ES æ®µ\n    xor bx,bx       ! è½½å…¥åˆ°, åç§»é‡ \n    mov ax,#0x0211  ! AH: è¯»å–æ‰‡åŒºå­åŠŸèƒ½, AL: è¯»å–å¤šå°‘ä¸ªæ‰‡åŒº\n    int 0x13        ! BIOS 13 å·ä¸­æ–­\n    jnc continue_load   ! JUMP if CF = 0\ndie:\n    jmp die\n\ncontinue_load:\n    cli             ! æ¸…é™¤ä¸­æ–­å…è®¸ä½æ ‡å¿—\n    mov ax,#SYSSEG \n    mov ds,ax       ! è®¾ç½®æ•°æ®æ®µå¯„å­˜å™¨ä½ç½® 0x1000\n    xor ax,ax\n    mov es,ax       ! è®¾ç½®æ‰©å±•æ®µå¯„å­˜å™¨ 0x0000\n    mov cx,#0x1000  ! è®¡æ•°å™¨\n    sub si,si\n    sub di,di\n    rep \n    movsw\n\n    mov ax,#BOOTSEG\n    mov ds,ax       ! é‡æ–°è®¾ç½®æ•°æ®æ®µå¯„å­˜å™¨åˆ°å½“å‰æ•°æ®æ®µåŸºåœ°å€\n    lidt idt_48     ! è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨\n    lgdt gdt_48     ! è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨\n\n    mov ax,#0x0001\n    lmsw ax         ! è®¾ç½® CR0, è¿›å…¥ä¿æŠ¤æ¨¡å¼\n    jmpi 0,8\n\ngdt:\n    .word   0,0,0,0\n    .word   0x07FF,0x0000,0x9A00,0x00C0\n    .word   0x07FF,0x0000,0x9200,0x00C0\n\nidt_48:\n    .word   0,0,0\ngdt_48:\n    .word   0x07FF,0x7C00+gdt,0\n\n.org 510\n    .word   0xAA55\n</code></pre>\n<p>è¿™æ®µæ±‡ç¼–ç¨‹åºï¼Œé€šè¿‡ <code>load_system</code> æ ‡è¯†ç¬¦æ ‡è¯†çš„è¿™æ®µç¨‹åºè¡¨æ˜éœ€è¦åŠ è½½0å·ç£ç›˜,0å·ç£å¤´,0å·ç£é“,ä»ç¬¬2æ‰‡åŒºå¼€å§‹,è¿ç»­17ä¸ªæ‰‡åŒºçš„å†…å®¹(è¿™é‡Œå°†å­˜å‚¨æ”¯æŒä»»åŠ¡åˆ‡æ¢çš„ç¨‹åº)ï¼ŒåŠ è½½åˆ°å†…å­˜ä»¥ 0x1000 å¼€å§‹çš„ç‰©ç†åœ°å€å¤„ã€‚</p>\n<p><code>continue_load</code> æ ‡è¯†å°† 0x1000 ç‰©ç†åœ°å€å¼€å§‹çš„ 4096 å­— (å³ 8192 å­—èŠ‚) çš„å†…å®¹ä¾æ¬¡å¤åˆ¶åˆ°ä»¥ 0x0000 å¼€å§‹çš„ç‰©ç†åœ°å€å¤„ã€‚</p>\n<p>å…¶åï¼Œè®¾ç½® IDT (ä¸­æ–­æè¿°ç¬¦è¡¨)ã€IDTR(ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨) åŠ GDT(å…¨å±€æè¿°ç¬¦è¡¨)ã€GDTR(å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨)ï¼Œå°† CPU è¿è¡Œæ¨¡å¼æ”¹æˆ <code>ä¿æŠ¤æ¨¡å¼</code> ï¼Œç»§è€Œå°†æ§åˆ¶æƒè½¬äº¤ç»™è¿™ä¸ªè¢«åŠ è½½è¿›æ¥çš„ç¨‹åºã€‚</p>\n<h2>å¤šä»»åŠ¡ç¨‹åº</h2>\n<p>ä¸»ä½“å†…å®¹æ¥è‡ªã€ŠLinux å†…æ ¸å®Œå…¨æ³¨é‡Šã€‹ï¼Œç»è¿‡ä¸€å®šé‡æ”¹å˜ä»¥é€‚åº”å½“å‰è¿è¡Œç¯å¢ƒ</p>\n<pre><code># head.s\n.code32\nLATCH = 11930\nSCRN_SEL = 0x18\nTSS0_SEL = 0x20\nLDT0_SEL = 0x28\nTSS1_SEL = 0x30\nLDT1_SEL = 0x38\n\n.text\n.globl startup_32\nstartup_32:\n\n    movl $0x00000010,%eax       # æ®µé€‰æ‹©ç¬¦ 2\n    mov %ax,%ds                \n    lss init_stack,%esp         # Load Far Pointer åŠ è½½åˆ° SS:ESP \n\n    call setup_idt              # è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨\n    call setup_gdt              # è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨\n    movl $0x00000010,%eax\n    mov %ax,%ds\n    mov %ax,%es\n    mov %ax,%fs\n    mov %ax,%gs\n    lss init_stack,%esp         # Load Far Pointer åŠ è½½åˆ° SS:ESP\n\n# è®¾ç½® 8253 å®šæ—¶èŠ¯ç‰‡ 10s ä¸€ä¸ªä¸­æ–­\n    movb $0x36,%al  \n    movl $0x00000043,%edx\n    outb %al,%dx\n    movl $LATCH,%eax\n    movl $0x40,%edx\n    outb %al,%dx\n    movb %ah,%al\n    outb %al,%dx\n\n    movl $0x00080000,%eax       # é‡æ–°è®¾ç½® int 0x08 æ—¶é’Ÿä¸­æ–­\n    movw $timer_interrupt,%ax\n    movw $0x8E00,%dx\n    movl $0x08,%ecx\n    lea idt(,%ecx,8),%esi\n    movl %eax,(%esi)\n    movl %edx,4(%esi)\n    movw $system_interrupt,%ax  # é‡æ–°è®¾ç½® int 0x80 ç³»ç»Ÿä¸­æ–­\n    movw $0xef00,%dx\n    movl $0x80,%ecx\n    lea idt(,%ecx,8),%esi\n    movl %eax,(%esi)\n    movl %edx,4(%esi)\n\n    pushfl                      # é‡ç½® EFLAGS åµŒå¥—ä»»åŠ¡æ ‡å¿—ä½\n    andl $0xffffbfff,(%esp)\n    popfl\n    movl $TSS0_SEL,%eax\n    ltr %ax                     # Load Task Register\n    movl $LDT0_SEL,%eax\n    lldt %ax                    # Load Local Descriptor Register\n    movl $0,current\n    sti                         # set interrupt flag\n    pushl $0x17\n    pushl $init_stack\n    pushfl\n    pushl $0x0f\n    pushl $task0\n    iret\n\n\nsetup_gdt:\n    lgdt lgdt_opcode\n    ret\nsetup_idt:\n    lea ignore_int,%edx         # é¢„å…ˆæŠŠä¸­æ–­å¤„ç†ç¨‹åºçš„åç§»åœ°å€ ignore_int å­˜åˆ° EDX\n    movl $0x00080000,%eax       # é¢„å­˜ 0x0008 - æ®µé€‰æ‹©ç¬¦\n    movw %dx,%ax                # è¡¥ä¸Š 0-15 ä½åç§»åœ°å€\n    movw $0x8E00,%dx            # DX è¡¥ä¸Šæ ‡å¿—ä½\n    lea idt,%edi\n    mov $256,%ecx\nrp_idt: movl %eax,(%edi)        # å¾ªç¯ 256 éå¤„ç† IDT\n    movl %edx,4(%edi)\n    addl $8,%edi\n    dec %ecx\n    jne rp_idt\n    lidt lidt_opcode\n    ret\n\n\nwrite_char:\n    push %gs\n    pushl %ebx\n    mov $SCRN_SEL,%ebx\n    mov %bx,%gs\n    movl scr_loc,%ebx\n    shl $1,%ebx\n    movb %al,%gs:(%ebx)\n    shr $1,%ebx\n    incl %ebx\n    cmpl $2000,%ebx\n    jb 1f\n    movl $0,%ebx\n1:  movl %ebx,scr_loc\n    popl %ebx\n    pop %gs\n    ret\n\n\n\n.align 4\nignore_int:                 # é»˜è®¤çš„ä¸­æ–­å¤„ç†ç¨‹åº\n    push %ds\n    pushl %eax\n    movl $0x10,%eax\n    mov %ax,%ds\n    movl $67,%eax\n    call write_char\n    popl %eax\n    pop %ds\n    iret\n\n\n.align 4\ntimer_interrupt:            # å®šæ—¶ä¸­æ–­å¤„ç†ç¨‹åº\n    push %ds\n    pushl %eax\n    movl $0x10,%eax\n    mov %ax,%ds\n    movb $0x20,%al\n    outb %al,$0x20\n    movl $1,%eax\n    cmpl %eax,current\n    je 1f\n    movl %eax,current\n    jmp $TSS1_SEL, $0\n    jmp 2f\n1:  movl $0,current\n    jmp $TSS0_SEL, $0\n2:  popl %eax\n    pop %ds\n    iret\n\n\n.align 4\nsystem_interrupt:           # ç³»ç»Ÿè°ƒç”¨ä¸­æ–­å¤„ç†ç¨‹åº\n    push %ds\n    pushl %edx\n    pushl %ecx\n    pushl %ebx\n    pushl %eax\n    movl $0x10,%edx\n    mov %dx,%ds\n    call write_char\n    popl %eax\n    popl %ebx\n    popl %ecx\n    popl %edx\n    pop %ds\n    iret\n\n\ncurrent:.long 0\nscr_loc:.long 0\n\n.align 4\nlidt_opcode:\n    .word 256*8-1\n    .long idt\nlgdt_opcode:\n    .word (end_gdt-gdt)-1\n    .long gdt\n\n.align 8\nidt:    .fill 256,8,0\n\ngdt:    .quad 0x0000000000000000\n        .quad 0x00c09a00000007ff\n        .quad 0x00c09200000007ff\n        .quad 0x00c0920b80000002\n        .word 0x68,tss0,0xe900,0x0\n        .word 0x40,ldt0,0xe200,0x0\n        .word 0x68,tss1,0xe900,0x0\n        .word 0x40,ldt1,0xe200,0x0\nend_gdt:\n        .fill 128,4,0\ninit_stack:\n    .long init_stack\n    .word 0x0010\n\n\n.align 8\nldt0:   .quad 0x0000000000000000\n        .quad 0x00c0fa00000003ff\n        .quad 0x00c0f200000003ff\n\ntss0:   .long 0\n        .long krn_stk0, 0x10\n        .long 0,0,0,0,0\n        .long 0,0,0,0,0\n        .long 0,0,0,0,0\n        .long 0,0,0,0,0,0\n        .long LDT0_SEL,0x8000000\n\n        .fill 128,4,0\nkrn_stk0:\n\n\n.align 8\nldt1:   .quad 0x0000000000000000\n        .quad 0x00c0fa00000003ff\n        .quad 0x00c0f200000003ff\n\ntss1:   .long 0\n        .long krn_stk1,0x10\n        .long 0,0,0,0,0\n        .long task1,0x200\n        .long 0,0,0,0\n        .long usr_stk1,0,0,0\n        .long 0x17,0x0f,0x17,0x17,0x17,0x17\n        .long LDT1_SEL,0x8000000\n\n        .fill 128,4,0\nkrn_stk1:\n\n\ntask0:\n    movl $0x17,%eax\n    movw %ax,%ds\n    mov $65,%al\n    int $0x80\n    movl $0xfff,%ecx\n1:  loop 1b\n    jmp task0\ntask1:\n    mov $66,%al\n    int $0x80\n    movl $0xfff,%ecx\n1:  loop 1b\n    jmp task1\n\n    .fill 128,4,0\nusr_stk1:\n</code></pre>\n<p>ä¸Šé¢çš„è¿™ä¸ªç¨‹åºå†…å®¹ä¸å†è¯¦è¿°ï¼Œæƒ³äº†è§£ç»†èŠ‚è¯·å‚è€ƒ ã€ŠLinux å†…æ ¸å®Œå…¨æ³¨é‡Šã€‹</p>\n<p>ä¸‹é¢æä¾›ç¼–è¯‘ <code>boot.s</code> ä»¥åŠ <code>head.s</code> çš„å¯ç”¨ Makefile</p>\n<p>é¦–å…ˆæè¿°ä¸€ä¸‹é¢å¤–çš„å·¥å…·ç‰ˆæœ¬</p>\n<ul>\n<li>GNU as : GNU assembler version 2.26.1 </li>\n<li>GNU ld : GNU ld 2.26.1\nå…¶å®ƒå†…å®¹è¯¦è§ <a href="https://dormouse-none.github.io/2018-08-19-understand-Kernel-0/">ç†è§£ Linux Kernel (0)</a></li>\n</ul>\n<pre><code class="language-makefile"># Makefile for the simple example kernel.\nAS86    =as86 -0 -a\nLD86    =ld86 -0\nAS  =as\nASFLAGS =-32\nLD  =ld\nLDFLAGS =-s -x -M -m elf_i386 -e startup_32 -Ttext 0x0\n\nall:    Image\n\nImage: boot system\n    dd bs=32 if=boot of=Image skip=1\n    dd bs=512 if=system of=Image skip=8 seek=1\n    sync\n\ndisk: Image\n    dd bs=8192 if=Image of=/dev/fd0\n    sync;sync;sync\n\nhead.o: \n    $(AS) $(ASFLAGS) -o head.o head.s\n\nsystem: head.o \n    $(LD) $(LDFLAGS) head.o  -o system > System.map\n\nboot:   boot.s\n    $(AS86) -o boot.o boot.s\n    $(LD86) -s -o boot boot.o\n\nclean:\n    rm -f Image System.map core boot *.o system\n</code></pre>\n<h2>è¿è¡Œç»“æœ</h2>\n<p>æƒ³äº†è§£æ›´å¤šç»†èŠ‚çš„è¯·è‡ªè¡Œå®æ“æŸ¥çœ‹å§!</p>\n<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fun1fvafhwg30k40d4x6p.gif"></p>\n<h2>é™„ä»¶</h2>\n<p><a href="https://raw.githubusercontent.com/DorMOUSE-None/Repo/master/understand-kernel-2.zip">ç¨‹åºæºç </a></p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},BQvL:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:"<h2>æŠ¥é”™ä¿¡æ¯</h2>\n<pre><code class=\"language-java\">java.lang.VerifyError: class net.sf.cglib.core.DebuggingClassWriter overrides final method visit.(IILjava/lang/String;Ljava/lang/String;Ljava/lang/String;[Ljava/lang/String;)V\n</code></pre>\n<h2>èƒŒæ™¯</h2>\n<p>é¡¹ç›®ä¾èµ–çš„ </p>\n<ul>\n<li>CGlib ç‰ˆæœ¬æ˜¯ 2.2.2</li>\n<li>ASM ç‰ˆæœ¬æ˜¯ 3.3.1</li>\n</ul>\n<h2>é—®é¢˜å®šä½</h2>\n<p>å‰ä¸¤å¤©åˆšç²—ç•¥é€šè¯»äº† ASM ï¼Œç»“æœå°±é‡ä¸Šè¿™æ ·ä¸€ä¸ªé—®é¢˜ã€‚</p>\n<p>ä» <code>net.sf.cglib.core.DebuggingClassWriter</code> çœ‹ï¼Œè¿™æ˜¯ CGlib çš„ä¸€ä¸ªå®ç°ç±»</p>\n<p>ä»æè¿° <code>overrides final method visit.(IILjava/lang/String;Ljava/lang/String;Ljava/lang/String;[Ljava/lang/String;)V</code>\nä»¥åŠ DebuggingClassWriter ç±»çš„å­—èŠ‚ç åç¼–è¯‘ç»“æœ</p>\n<pre><code class=\"language-java\">public class DebuggingClassWriter extends ClassWriter {\n    public void visit(int version, int access, String name, String signature, String superName, String[] interfaces) {\n        this.className = name.replace('/', '.');\n        this.superName = superName.replace('/', '.');\n        super.visit(version, access, name, signature, superName, interfaces);\n    }\n}\n</code></pre>\n<p>è‡³å°‘åº”è¯¥æ˜¯ visit(...) æ–¹æ³•è¦é‡è½½çš„çˆ¶ç±»çš„è¢«å£°æ˜ä¸º final çš„ ClassWriter.visit(...) æ‰å¯¼è‡´çš„é—®é¢˜ã€‚</p>\n<p>ä½†æ˜¯ä» ASM 3.3.1 ç‰ˆæœ¬çš„ ClassWriter ç±»å¯ä»¥çœ‹åˆ°</p>\n<pre><code class=\"language-java\">    public void visit(int var1, int var2, String var3, String var4, String var5, String[] var6) {\n        ...\n    }\n</code></pre>\n<p>visit æ–¹æ³•å¹¶æ²¡æœ‰è¢«å£°æ˜ä¸º final ã€‚</p>\n<p>ä½†æ˜¯ï¼Œç»“åˆä¸€å®šçš„èƒŒæ™¯çŸ¥è¯†ï¼ŒASM é¡¹ç›®åœ¨åŠ å…¥äº† OW2 ç»„ç»‡åçš„æ–°ç‰ˆæœ¬(asm-3.3.1 æ˜¯æœªåŠ å…¥ OW2 å‰çš„æœ€åä¸€ä¸ªç‰ˆæœ¬)ï¼Œ\nClassWriter ç±»çš„æ‰€æœ‰ visitXxx(...) æ–¹æ³•éƒ½è¢«æ·»åŠ äº† <code>final</code> é™åˆ¶ã€‚</p>\n<p>å› æ­¤ï¼Œæ€€ç–‘æ˜¯é¡¹ç›®å®é™…ä¾èµ–äº†é«˜ç‰ˆæœ¬çš„ asm (asm 4.x åŠä»¥ä¸Š)</p>\n<h2>è§£å†³</h2>\n<p>ç»è¿‡ç¡®è®¤ï¼Œç”±äºæ•´ä¸ªé¡¹ç›®ä¾èµ–å…³ç³»å¤æ‚ï¼Œæœ‰å…¶å®ƒé¡¹ç›®å¼•å…¥äº† asm-4.1.jarã€‚\nè€Œä¸”ç”±äºä½¿ç”¨ MAVEN è¿›è¡Œé¡¹ç›®ä¾èµ–ç®¡ç†ï¼Œasm-4.1.jar ä¸ä¾èµ–æ ‘æ ¹çš„æ·±åº¦æ›´æµ…ï¼Œ\nå› æ­¤ï¼Œæœ€ç»ˆæ‰“åŒ…çš„ war é‡Œé¢ç¡®å®å¼•å…¥äº† asm-4.1.jar ã€‚å¯¼è‡´äº†è¿™ä¸ªé—®é¢˜ã€‚</p>\n<pre><code class=\"language-plain\">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>"}},BX5X:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>å‰é¢å‡ èŠ‚å·²ç»æè¿°è¿‡ï¼Œå¯¹äºå•æ ¸ CPU æ¥è¯´ã€‚CPU å°±å¤„äºä¸æ–­åœ°æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹(æˆ–è€…é€šè¿‡ <code>hlt</code> æŒ‡ä»¤ç›´æ¥åœæ­¢å·¥ä½œ)ã€‚</p>\n<p>é’ˆå¯¹äºæ¯ä¸€ä¸ªç¨‹åºæ¥è¯´ï¼Œè¿™ä¸ªç¨‹åºæ‰§è¡Œæµç¨‹æ˜¯é€šè¿‡ CPU ä¸­å‡ ç»„å¯„å­˜å™¨(é€šç”¨å¯„å­˜å™¨ã€æ®µå¯„å­˜å™¨ã€æ§åˆ¶å¯„å­˜å™¨ç­‰) å’Œå­˜å‚¨åœ¨å†…å­˜ä¸­çš„ä»£ç å’Œæ•°æ®åä½œå®Œæˆçš„ã€‚</p>\n<p>å¦‚æœè¦è¾¾åˆ°å•æ ¸å¤šä»»åŠ¡çš„ç›®çš„ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯å®Œæˆå¯¹å‡ ç»„å¯„å­˜å™¨ä¸­å½“å‰å€¼çš„ä¿å­˜(æˆ‘ç§°ä¹‹ä¸ºä¿å­˜ç°åœº)ã€‚è€Œå¯¹äºå†…å­˜æ¥è¯´ï¼Œå¤šä¸ªä»»åŠ¡çš„ä»£ç ã€æ•°æ®åŒæ—¶å­˜åœ¨å†…å­˜æ˜¯å®Œå…¨åˆç†ä¸”å¯è¡Œçš„ã€‚æ¯•ç«Ÿç›¸è¾ƒäºæœ‰é™çš„å¯„å­˜å™¨ï¼Œå†…å­˜å®åœ¨æ˜¯å¤ªå¤§äº†(ç›¸å¯¹è€Œè¨€)ã€‚</p>\n<h2>ä»»åŠ¡è°ƒåº¦çš„å®è§‚æè¿°</h2>\n<p>ä»å®è§‚ä¸Šæ¥è¯´ï¼Œæ“ä½œç³»ç»Ÿç»´æŠ¤äº†è‹¥å¹²ä¸ªä»»åŠ¡(å‡è®¾æœ‰ 0, 1, 5, 6)ã€‚</p>\n<p>ä¸‹é¢ä»¥ä¸€ä¸ªå‡è±¡çš„ä¾‹å­æ¥å¯¹ä»»åŠ¡è°ƒåº¦åšä¸€äº›å½¢è±¡çš„è¯´æ˜:</p>\n<ol>\n<li>\n<p>å‡è®¾å½“å‰ä»»åŠ¡æ˜¯ä»»åŠ¡ 5 ï¼Œæ“ä½œç³»ç»Ÿåˆ†é…ç»™å®ƒçš„ CPU ä½¿ç”¨æ—¶é—´æ˜¯ 30msã€‚</p>\n</li>\n<li>\n<p>æ¯ 10ms è®¡æ—¶å™¨(Intel 8253, å¯ç¼–ç¨‹è®¡æ•°å™¨/å®šæ—¶å™¨) å‘ CPU å‘èµ·ä¸€ä¸ªæ—¶é’Ÿä¸­æ–­ã€‚</p>\n</li>\n<li>\n<p>CPU å¼€å§‹å¤„ç†æ—¶é’Ÿä¸­æ–­(æ­¤æ—¶æ˜¯<strong>å†…æ ¸æ€</strong>)ã€‚å½“å‰ä»»åŠ¡å‰©ä½™å¯ç”¨æ—¶é—´ -10msã€‚</p>\n</li>\n<li>\n<p>æ£€æŸ¥å½“å‰ä»»åŠ¡çš„å‰©ä½™æ—¶é—´ç‰‡ï¼Œæœ‰å‰©ä½™ -> æ­¥éª¤ 5 ; å¦åˆ™ -> æ­¥éª¤ 6 </p>\n</li>\n<li>\n<p>ç›´æ¥é€€å‡ºå¯¹æ—¶é’Ÿä¸­æ–­çš„å¤„ç†å‡½æ•°(å›åˆ° <strong>ç”¨æˆ·æ€</strong>), é‡å¤æ­¥éª¤ 1 </p>\n</li>\n<li>\n<p>æ ¹æ®æ¯ä¸ªä»»åŠ¡çš„ä¼˜å…ˆçº§åŠå…¶å®ƒä¸€äº›å› ç´ ç¡®å®šæŠŠæ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´åˆ†é…ç»™å“ªä¸ªä»»åŠ¡ã€‚(å‡è®¾åˆ†é…ç»™ä»»åŠ¡ 6 ï¼Œ30ms çš„ CPU ä½¿ç”¨æ—¶é—´) -> é‡å¤æ­¥éª¤ 2 ã€‚</p>\n</li>\n</ol>\n<p>å½“ç„¶ï¼Œä¸Šé¢çš„æè¿°ä¸­å¿½ç•¥äº†å¾ˆå¤šçš„å› ç´ ã€‚</p>\n<h2>ä»»åŠ¡è°ƒåº¦å‡†å¤‡é˜¶æ®µ</h2>\n<p>è¿™é‡Œéƒ½å°†ä»¥ Linux 0.11 ç‰ˆæœ¬ä»£ç ä½œä¸ºå®ä¾‹ã€‚å½“ç„¶ï¼Œå…¶ä¸­ä¸€äº›ä»£ç ä¸ºäº†é€‚åº”ç°åœ¨çš„ GCC åšäº†ä¸€äº›ä¿®æ”¹ï¼Œå¦å¤–è¿˜å¯èƒ½ç›´æ¥æ‘†å‡º GCC ç¼–è¯‘åçš„æ±‡ç¼–ä»£ç æ¥è§£é‡Šè¯´æ˜ã€‚</p>\n<p>é¦–å…ˆï¼Œå†…æ ¸ä»£ç åœ¨ç»è¿‡ä¸€ç³»åˆ—çš„å‡†å¤‡æµç¨‹(åŒ…æ‹¬è®¾ç½®ä¸€äº›å¯„å­˜å™¨ä»¥åŠåœ¨å†…å­˜ä¸­æš‚å­˜æŸäº›å€¼ï¼Œè¯»å–è®¡ç®—æœºçš„ç¡¬ä»¶é…ç½®ç­‰)ã€‚çœŸæ­£å¼€å§‹å‡ºç°ä»»åŠ¡ 0 å§‹äºä¸‹åˆ—è¿™æ®µä»£ç :</p>\n<pre><code class="language-c">/* æ¥è‡ª Linux0.11 init/main.c */\nvoid main(void) \n{\n    ...\n\n    sched_init();       /* schedule, é¡¾åæ€ä¹‰å°±æ˜¯æ—¶é—´å®‰æ’å’¯ */\n    \n    ...\n    sti();\n    move_to_user_mode();\n    if (!fork()) {  \n        init();\n    }\n    for(;;) pause();\n}\n</code></pre>\n<p>åœ¨æ“ä½œç³»ç»Ÿçš„ä¸»å‡½æ•°ä¸­ï¼Œå¼€å§‹å¯¹ä»»åŠ¡è°ƒåº¦è¿›è¡Œä¸€å®šçš„å‡†å¤‡å·¥ä½œã€‚çœ‹çœ‹å…·ä½“ä»£ç å§</p>\n<pre><code class="language-c">/* è¿™é‡Œç»™å‡ºçš„æ˜¯ Linux0.11 kernel/sched.c ç»è¿‡é¢„ç¼–è¯‘çš„å‡½æ•°(é‡Œé¢æœ‰ä¸€äº›å†…è”æ±‡ç¼–) */\nvoid sched_init(void)\n{\n    int i;\n    struct desc_struct * p;    /* å£°æ˜ä¸€ä¸ªæè¿°ç¬¦æŒ‡é’ˆ */\n\n    if (sizeof(struct sigaction) != 16)\n        panic("Struct sigaction MUST be 16 bytes");\n    __asm__ (                           /* è¿™æ®µæ˜¯ä¸ºäº†è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨GDTçš„ç¬¬4é¡¹ï¼Œæ˜¯ä¸€ä¸ª 0 å·ä»»åŠ¡(å½“å‰ä»»åŠ¡)çš„ä»»åŠ¡è°ƒç”¨é—¨*/\n            "movw $104,%1\\n\\t" \n            "movw %%ax,%2\\n\\t" \n            "rorl $16,%%eax\\n\\t" \n            "movb %%al,%3\\n\\t" \n            "movb $" "0x89" ",%4\\n\\t" \n            "movb $0x00,%5\\n\\t" \n            "movb %%ah,%6\\n\\t" \n            "rorl $16,%%eax" \n            ::"a" (&#x26;(init_task.task.tss)), "m" (*(((char *) (gdt+4)))), "m" (*(((char *) (gdt+4))+2)), "m" (*(((char *) (gdt+4))+4)), "m" (*(((char *) (gdt+4))+5)), "m" (*(((char *) (gdt+4))+6)), "m" (*(((char *) (gdt+4))+7)) \n            );\n    __asm__ (                           /* è¿™é‡Œè®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨çš„ç¬¬5é¡¹ï¼Œ0å·ä»»åŠ¡çš„å±€éƒ¨æè¿°ç¬¦è¡¨åŸºå€é€‰æ‹©ç¬¦ */\n            "movw $104,%1\\n\\t" \n            "movw %%ax,%2\\n\\t" \n            "rorl $16,%%eax\\n\\t" \n            "movb %%al,%3\\n\\t" \n            "movb $" "0x82" ",%4\\n\\t" \n            "movb $0x00,%5\\n\\t" \n            "movb %%ah,%6\\n\\t" \n            "rorl $16,%%eax" \n            ::"a" (&#x26;(init_task.task.ldt)), "m" (*(((char *) (gdt+(4 +1))))), "m" (*(((char *) (gdt+(4 +1)))+2)), "m" (*(((char *) (gdt+(4 +1)))+4)), "m" (*(((char *) (gdt+(4 +1)))+5)), "m" (*(((char *) (gdt+(4 +1)))+6)), "m" (*(((char *) (gdt+(4 +1)))+7)) \n            );\n    p = gdt+2+4;        /* æè¿°ç¬¦æŒ‡é’ˆæŒ‡å‘ GDT ç¬¬6é¡¹ã€‚å› ä¸ºå‰é¢å·²ç»å ç”¨äº†ç¬¬4ï¼Œ5é¡¹ã€‚ç”±å†…æ ¸å ç”¨äº† 0ï¼Œ1ï¼Œ2ï¼Œ3ã€‚*/\n    for(i=1;i&#x3C;64;i++) {         /* å¾ªç¯ 63 æ¬¡ï¼Œè¿™æ˜¯ Linux0.11 æœ€å¤§æ”¯æŒ 64 ä¸ªä»»åŠ¡åŒæ—¶å­˜åœ¨ã€‚å½“å‰ä»»åŠ¡å·²ç»å äº†ä¸€ä¸ªä»»åŠ¡äº†*/\n        task[i] = ((void *) 0); /* 63ä¸ªä»»åŠ¡æŒ‡é’ˆå…¨éƒ¨å€¼ä¸º NULL */\n        p->a=p->b=0;            /* GDT ç´¯ç§¯ 126 é¡¹(126 * 8 å­—èŠ‚)å…¨éƒ¨ç½®ä¸º 0 ã€‚æ¯ä¸ªä»»åŠ¡å ç”¨ GDT ä¸¤é¡¹ï¼Œä¸€ä¸ºä»»åŠ¡é—¨ï¼Œä¸€ä¸ºå±€éƒ¨æè¿°ç¬¦è¡¨é€‰æ‹©ç¬¦*/\n        p++;\n        p->a=p->b=0;\n        p++;\n    }\n\n    __asm__("pushfl ; andl $0xffffbfff,(%esp) ; popfl");\n    __asm__("ltr %%ax"::"a" (((((unsigned long) 0)&#x3C;&#x3C;4)+(4&#x3C;&#x3C;3))));           /* load Task Register TR è®°å½•å½“å‰ä»»åŠ¡é—¨ä¸º gdt ç¬¬4é¡¹ */\n    __asm__("lldt %%ax"::"a" (((((unsigned long) 0)&#x3C;&#x3C;4)+((4 +1)&#x3C;&#x3C;3))));     /* load Local Descriptor Table Register LDTR è®°å½•å½“å‰é€‰æ‹©ç¬¦ä¸º gdt ç¬¬5é¡¹ */\n    /* ç»™8253èŠ¯ç‰‡ç¼–ç¨‹ï¼Œæ¯ 10ms å‘èµ·ä¸€æ¬¡æ—¶é’Ÿä¸­æ–­(ä¸‹é¢3è¡Œçš„å·¥ä½œ) */\n    __asm__ ("outb %%al,%%dx\\n" "\\tjmp 1f\\n" "1:\\tjmp 1f\\n" "1:"::"a" (0x36),"d" (0x43));   \n    __asm__ ("outb %%al,%%dx\\n" "\\tjmp 1f\\n" "1:\\tjmp 1f\\n" "1:"::"a" ((1193180/100) &#x26; 0xff),"d" (0x40));\n    __asm__ ("outb %%al,%%dx"::"a" ((1193180/100) >> 8),"d" (0x40));\n    __asm__ ("movw %%dx,%%ax\\n\\t" "movw %0,%%dx\\n\\t" "movl %%eax,%1\\n\\t" "movl %%edx,%2" : : "i" ((short) (0x8000+(0&#x3C;&#x3C;13)+(14&#x3C;&#x3C;8))), "o" (*((char *) (&#x26;idt[0x20]))), "o" (*(4+(char *) (&#x26;idt[0x20]))), "d" ((char *) (&#x26;timer_interrupt)),"a" (0x00080000)); /* åœ¨ IDT ä¸­è®¾ç½®æ—¶é’Ÿä¸­æ–­æè¿°ç¬¦é¡¹ï¼Œç¬¬32é¡¹ä¸ºæ—¶é’Ÿä¸­æ–­*/\n    __asm__ ("outb %%al,%%dx"::"a" (({ unsigned char _v; __asm__ volatile ("inb %%dx,%%al\\n" "\\tjmp 1f\\n" "1:\\tjmp 1f\\n" "1:":"=a" (_v):"d" (0x21)); _v; })&#x26;~0x01),"d" (0x21)); /*é‡æ–°è®¾ç½®æ—¶é’Ÿä¸­æ–­çš„å¯å±è”½å±æ€§ï¼Œè¿™æ ·å°±å¯åœ¨è°ƒç”¨ hlt åè¢«æ—¶é’Ÿä¸­æ–­å”¤é†’ */\n    __asm__ ("movw %%dx,%%ax\\n\\t" "movw %0,%%dx\\n\\t" "movl %%eax,%1\\n\\t" "movl %%edx,%2" : : "i" ((short) (0x8000+(3&#x3C;&#x3C;13)+(15&#x3C;&#x3C;8))), "o" (*((char *) (&#x26;idt[0x80]))), "o" (*(4+(char *) (&#x26;idt[0x80]))), "d" ((char *) (&#x26;system_call)),"a" (0x00080000)); /* åœ¨ IDT ä¸­è®¾ç½®ç³»ç»Ÿä¸­æ–­ï¼Œç¬¬128é¡¹ä¸ºæ—¶é’Ÿä¸­æ–­ */\n}\n</code></pre>\n<p>é€šè¿‡æ‰§è¡Œ <code>sched_init()</code> ï¼Œæ“ä½œç³»ç»Ÿå¼€å§‹æœ‰äº†ä»»åŠ¡çš„æ¦‚å¿µã€‚å¹¶ä¸”æŠŠå½“å‰ä»»åŠ¡ä½œä¸ºä»»åŠ¡ 0 æ¥åŠ ä»¥è®¤è¯†ã€‚</p>\n<p>åŒæ—¶ï¼Œé¢„ç½®äº† 64 ä¸ªä»»åŠ¡çŠ¶æ€æ•°ç»„ï¼Œç”¨æ¥è¾…åŠ©ä»»åŠ¡è°ƒåº¦å™¨å®Œæˆæœªæ¥è°ƒåº¦ä»»åŠ¡æ—¶ç¡®è®¤ç›®å‰æ‰€æœ‰ä»»åŠ¡çš„åŸºç¡€æ€§æ”¯æŒã€‚</p>\n<p>æœ€é‡è¦çš„ï¼Œå½“ç„¶æ˜¯å¯¹ 8253 èŠ¯ç‰‡çš„ç¼–ç¨‹ï¼Œä½¿å…¶æ¯ 10ms å‘ CPU å‘èµ·ä¸€ä¸ªç¡¬ä»¶æ—¶é’Ÿä¸­æ–­ã€‚ç”±æ­¤å°†æŠŠç³»ç»Ÿæš‚æ—¶æ€§çš„å¸¦å…¥<strong>å†…æ ¸æ€</strong> æ¥å®Œæˆ CPU ä¸‹ä¸€ä¸ª 10ms éœ€è¦è¿›è¡Œçš„ä»»åŠ¡çš„å†³ç­–å·¥ä½œã€‚</p>\n<p>æœ€åçš„è®¾ç½®æ—¶é’Ÿä¸­æ–­æè¿°ç¬¦å’Œç³»ç»Ÿä¸­æ–­æè¿°ç¬¦è‡ªä¸ç”¨è¯´ã€‚ä¸è®¾ç½®çš„è¯ï¼Œå¯¹äºæ¥æ”¶åˆ°çš„ä¸­æ–­æ ¹æœ¬å°±æ²¡åŠæ³•ç¡®è®¤å¤„ç†ä¸­æ–­çš„ä»£ç åœ¨å“ª(æ¯•ç«Ÿä¸­æ–­å¤„ç†é€»è¾‘ä¹Ÿæ˜¯ç”± CPU æ‰§è¡ŒæŒ‡ä»¤æ¥è§£å†³çš„)</p>\n<h2>ä»»åŠ¡è°ƒåº¦å®æ–½é˜¶æ®µ</h2>\n<p>ç”±äºæ—¶é’Ÿä¸­æ–­æ˜¯ç”±ç¡¬ä»¶èŠ¯ç‰‡è¿›è¡Œæ§åˆ¶ï¼Œæ ¹æœ¬ä¸ä¼šé¡¾åŠå½“å‰ CPU æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å·²ç»æ‰§è¡Œåˆ°äº†å“ªä¸ªæŒ‡ä»¤ (å“ˆå“ˆï¼Œè¿™ä¸å¾—æ˜¯å½“ç„¶çš„å˜›ï¼Œä¸ç„¶è¦ä»»åŠ¡è°ƒåº¦åšä»€ä¹ˆï¼Œæ‰€æœ‰ä»»åŠ¡æµæ°´çº¿ä½œä¸šå¾—äº†)ã€‚</p>\n<p>å› æ­¤ï¼Œä¸‹é¢çš„æè¿°å°†å€Ÿç€ä¸€æ¬¡æ—¶é’Ÿä¸­æ–­ï¼Œæ¥çœ‹ä¸€ä¸‹æ•´ä¸€ä¸ªä»»åŠ¡è°ƒåº¦æ“ä½œã€‚</p>\n<h3>å®šä½æ—¶é’Ÿä¸­æ–­å¤„ç†é€»è¾‘</h3>\n<p>Intel 8253èŠ¯ç‰‡å‘èµ·æ—¶é’Ÿä¸­æ–­ä¹‹åï¼ŒCPU ç«‹å³å¼€å§‹å¤„ç†è¯¥ä¸­æ–­</p>\n<ol>\n<li>\n<p>é€šè¿‡ IDTR èŠ¯ç‰‡æŸ¥æ‰¾ä¸­æ–­æè¿°ç¬¦è¡¨(IDT, æœ€å¤š256é¡¹ï¼Œæ¯é¡¹8å­—èŠ‚) çš„åŸºå€ã€‚</p>\n</li>\n<li>\n<p>ç»“åˆä¸­æ–­å·ä½œä¸ºåç§»é‡ï¼Œå®šä½è¡¨ä¸­æŸä¸€é¡¹å…·ä½“çš„ä¸­æ–­æè¿°ç¬¦ (æ—¶é’Ÿä¸­æ–­æ˜¯0x20ï¼Œå› æ­¤åç§»å°±æ˜¯ 0x20 * 8 = 256)</p>\n</li>\n</ol>\n<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fw51zkvo2nj313q0mm3z3.jpg">\nCopied from IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual</p>\n<ol start="3">\n<li>æ¯ä¸€ä¸ªä¸­æ–­æè¿°ç¬¦é¡¹éƒ½å°†æ˜¯ä»»åŠ¡é—¨ï¼Œä¸­æ–­é—¨ï¼Œé™·é˜±é—¨ä¸‰ç±»ä¸­çš„ä¸€ç±»ï¼Œå…¶æ‰€å ç”¨çš„ 8 å­—èŠ‚æ•°æ®å°†æŒ‰å¦‚ä¸‹çš„å½¢å¼è¿›è¡Œå­˜å‚¨</li>\n</ol>\n<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fw527o8903j314614ita0.jpg">\nCopied from IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual</p>\n<ol start="4">\n<li>æ—¶é’Ÿä¸­æ–­æ˜¯ä¸€ç§ä¸­æ–­é—¨ï¼Œå¯ä»¥çœ‹åˆ°ä½ 0~15 ä½å’Œé«˜ 48~63 ä½å…±åŒç»„æˆäº†æ®µå†…åç§»é‡ï¼Œè€Œä½16~31ä½ç»„æˆäº†ä¸€ä¸ªæ®µé€‰æ‹©ç¬¦(å¯ä»¥å» GDT æ‰¾åˆ°ç›¸åº”çš„æ®µ)ã€‚</li>\n</ol>\n<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fw52a4jbe0j31440zeq3j.jpg">\nCopied from IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual</p>\n<ol start="5">\n<li>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®šä½åˆ°å¤„ç†æ—¶é’Ÿä¸­æ–­çš„ä»£ç ç©¶ç«Ÿåœ¨å‘¢ã€‚ä¹‹åä¹Ÿå°±æ˜¯æ™®é€šçš„ CPU ç»§ç»­æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹(å½“ç„¶ï¼Œéœ€è¦æ³¨æ„ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦æ³¨æ„å½“å‰æ®µé€‰æ‹©ç¬¦æ‰€è¡¨ç¤ºçš„ DPL=0 ï¼Œå³å·²ç»è¿›å…¥äº†å†…æ ¸æ€)</li>\n</ol>\n<h3>æ¨¡æ¿å¼çš„ä¿å­˜ç°åœº timer_interrupt</h3>\n<p>åœ¨ä¸Šä¸€å°èŠ‚ç¬¬ 5 æ­¥å®šä½æ—¶é’Ÿä¸­æ–­çš„ä»£ç æ—¶ï¼Œç”±äºå‘ç”Ÿäº†ç‰¹æƒçº§çš„åˆ‡æ¢ï¼Œå› æ­¤ä¸­æ–­å¤„ç†æµç¨‹ä¼šè‡ªåŠ¨åœ°åœ¨æ–°çš„æ ˆ(è¿™é‡ŒæŒ‡å¤„ç†æ—¶é’Ÿä¸­æ–­ä½¿ç”¨çš„å†…æ ¸æ ˆ)ä¸­ä¿å­˜åŸæ¥ä»»åŠ¡çš„ä¿¡æ¯ï¼Œä¾æ¬¡å…¥æ–°æ ˆçš„æ•°æ®æœ‰åŸä»»åŠ¡çš„ SS, ESP, EFLAGS, CS, EIP, (Error Code) ã€‚</p>\n<p>ç„¶åå°†æ­£å¼è¿›å…¥åˆ° IDT å®šä½çš„æ—¶é’Ÿä¸­æ–­å¤„ç†é€»è¾‘çš„å¼€å§‹ä½ç½® (å½“ç„¶äº†ï¼Œåˆ°è¿™é‡Œä¹Ÿè¿˜æ˜¯åœ¨ä¿å­˜ç°åœºã€‚æ¯•ç«Ÿè¿˜æœ‰å¥½å¤šå¯„å­˜å™¨çš„æ•°æ®è¦ä¿å­˜çš„)</p>\n<pre><code class="language-assembly">.align 4\n_timer_interrupt:\n    push %ds        # save ds,es and put kernel data space\n    push %es        # into them. %fs is used by _system_call\n    push %fs\n    pushl %edx      # we save %eax,%ecx,%edx as gcc doesn\'t\n    pushl %ecx      # save those across function calls. %ebx\n    pushl %ebx      # is saved as we use that in ret_sys_call\n    pushl %eax\n    movl $0x10,%eax # 0x10 æ˜¯å†…æ ¸æ•°æ®æ®µé€‰æ‹©ç¬¦ï¼Œå³ GDT ç¬¬äºŒé¡¹\n    mov %ax,%ds\n    mov %ax,%es\n    movl $0x17,%eax # 0x17 æ˜¯å½“å‰ä»»åŠ¡æ•°æ®æ®µé€‰æ‹©ç¬¦ï¼ŒLDT ç¬¬äºŒé¡¹ (åŒºåˆ†é€‰æ‹©ç¬¦æ˜¯ä½¿ç”¨ GDT or LDT ï¼Œçœ‹ val &#x26; 0x4 çš„ç»“æœï¼Œå¦‚æœä¸º 1 ä½¿ç”¨ LDTï¼Œå¦åˆ™ GDT\n    mov %ax,%fs\n    incl _jiffies   # åæ­£æ¯æ¬¡æ—¶é’Ÿä¸­æ–­ +1 ï¼Œæƒ³ä¸åˆ°åˆé€‚çš„ä¸­æ–‡ç¿»è¯‘\n    movb $0x20,%al      # EOI to interrupt controller #1 å‘é€æŒ‡ä»¤è¯·æ±‚ç¡¬ä»¶ç»“æŸè¿™æ¬¡æ—¶é’Ÿä¸­æ–­çš„æŠ¥å‘Š\n    outb %al,$0x20\n    movl CS(%esp),%eax  # è¿™ä¸ª CS æ˜¯ä¸ªå¸¸é‡ï¼Œå–å‡ºå†…æ ¸æ ˆæš‚å­˜çš„åŸæ¥æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡çš„ä»£ç æ®µé€‰æ‹©ç¬¦\n    andl $3,%eax        # %eax is CPL (0 or 3, 0=supervisor)    åˆ¤æ–­ä¸€ä¸‹åœ¨ä¸­æ–­å¼€å§‹å‰ä»£ç çš„ç‰¹æƒçº§ 0 æ˜¯å†…æ ¸æ€ï¼Œ3 æ˜¯ç”¨æˆ·æ€\n    pushl %eax\n    call _do_timer      # è°ƒç”¨ do_timer(long CPL) ã€‚çœŸæ­£çš„å¤„ç†æ—¶é’Ÿä¸­æ–­\n    addl $4,%esp        # task switching to accounting ...\n    jmp ret_from_sys_call\n</code></pre>\n<h3>ä»»åŠ¡è°ƒåº¦ do_timer</h3>\n<pre><code class="language-c">void do_timer(long cpl)     /* è¿™ä¸ª cpl æ˜¯ä¸Šä¸€å°èŠ‚è·å–çš„åŸä»»åŠ¡æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤çš„ç‰¹æƒçº§ */\n{\n    extern int beepcount;       /* æ‰¬å£°å™¨å‘å£°è®¡æ•° */\n    extern void sysbeepstop(void);  /* å…³é—­æ‰¬å£°å™¨çš„å‡½æ•°å£°æ˜ */\n\n    if (beepcount)              /* è¿™æ®µé€»è¾‘ä½œç”¨å¾ˆä¸æ¸…æ™°ï¼Œå¯èƒ½æ˜¯å¯Œæœ‰å¹´ä»£æ„Ÿçš„äº§ç‰© */\n        if (!--beepcount)\n            sysbeepstop();\n\n    if (cpl)                    /* åˆ¤æ–­ç‰¹æƒçº§ ç„¶åç»™å½“å‰ä»»åŠ¡çš„ç”¨æˆ·æ€/å†…æ ¸æ€ç”¨æ—¶è®¡æ•° */\n        current->utime++;\n    else\n        current->stime++;\n\n    /* è¿™æ®µé€»è¾‘æ˜¯ç»™æ“ä½œç³»ç»Ÿå®šæ—¶ä»»åŠ¡ç”¨çš„ï¼Œç”¨å…´è¶£çš„æ¬¢è¿è‡ªå·±å­¦ä¹  */\n    if (next_timer) {\n        next_timer->jiffies--;\n        while (next_timer &#x26;&#x26; next_timer->jiffies &#x3C;= 0) {\n            void (*fn)(void);\n\n            fn = next_timer->fn;\n            next_timer->fn = ((void *) 0);\n            next_timer = next_timer->next;\n            (fn)();\n        }\n    }\n    if (current_DOR &#x26; 0xf0)\n        do_floppy_timer();\n    if ((--current->counter)>0) return;     /* åˆ†é…ç»™å½“å‰ä»»åŠ¡çš„æ—¶é—´ç‰‡ -1 ã€‚å¦‚æœä¸ä¸º0ï¼Œé‚£ä¹ˆç›´æ¥é€€å‡ºæ—¶é’Ÿä¸­æ–­ï¼Œè®©ä»»åŠ¡ç»§ç»­æ‰§è¡Œ */\n    current->counter=0;     /* å¦åˆ™ï¼Œå½“å‰ä»»åŠ¡çš„æ—¶é—´ç‰‡è®°ä¸º 0 */\n    if (!cpl) return;       /* å¦‚æœå½“å‰ä»»åŠ¡æ­£å¤„äºå†…æ ¸æ€(æ¯”å¦‚ç”¨æˆ·ç¨‹åºä¸­ä½¿ç”¨äº†ä¸€äº›ç³»ç»Ÿè°ƒç”¨)ï¼Œé‚£ä¹ˆå…ˆè®©è¿™ä¸ªä»»åŠ¡ç»§ç»­æ‰§è¡Œï¼Œé¿å…ä»»åŠ¡åˆ‡æ¢å¼•èµ·çš„éº»çƒ¦ */\n    schedule();             /* ä»»åŠ¡è°ƒç”¨ï¼Œå†³å®šä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡çš„ä¸»äºº */\n}\n</code></pre>\n<h3>ä»»åŠ¡è°ƒåº¦ schedule()</h3>\n<p>schedule() å°±å¼€å§‹å¯¹ CPU ä¹‹åè¦æŠŠæ—¶é—´ç‰‡åˆ†é…ç»™å“ªä¸ªä»»åŠ¡åšä¸€æ¬¡å†³ç­–äº†ã€‚</p>\n<p>ä½†æ˜¯ï¼Œåœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆäº†è§£ä¸€ä¸‹ç»“æ„ä½“ task_struct </p>\n<pre><code class="language-c">struct task_struct {\n    long state; /* -1 unrunnable, 0 runnable, >0 stopped */\n    long counter;\n    long priority;\n    long signal;\n    struct sigaction sigaction[32];\n    long blocked;   /* bitmap of masked signals */\n/* various fields */\n    int exit_code;\n    unsigned long start_code,end_code,end_data,brk,start_stack;\n    long pid,father,pgrp,session,leader;\n    unsigned short uid,euid,suid;\n    unsigned short gid,egid,sgid;\n    long alarm;\n    long utime,stime,cutime,cstime,start_time;\n    unsigned short used_math;\n/* file system info */\n    int tty;        /* -1 if no tty, so it must be signed */\n    unsigned short umask;\n    struct m_inode * pwd;\n    struct m_inode * root;\n    struct m_inode * executable;\n    unsigned long close_on_exec;\n    struct file * filp[NR_OPEN];\n/* ldt for this task 0 - zero 1 - cs 2 - ds&#x26;ss */\n    struct desc_struct ldt[3];\n/* tss for this task */\n    struct tss_struct tss;\n};\n</code></pre>\n<p>åŒ†åŒ†ä¸€ç¥ï¼Œä¸è¿‡æ˜¯ä¸æ˜¯è§‰å¾—æœ‰äº›å˜é‡åè¿˜æ˜¯å¾ˆç†Ÿæ‚‰çš„ï¼Œæ¯”å¦‚è¯´ priority, utime, uid, eid, gid ç­‰ç­‰ã€‚\nä½†æ˜¯æš‚æ—¶è¿˜ç”¨ä¸ä¸Šè¿™ä¹ˆå¤šã€‚åªè¦æœ‰ä¸ªæ¦‚å¿µå°±å¥½ã€‚æ“ä½œç³»ç»Ÿé€šè¿‡ä¸Šè¿°è¿™äº›å€¼å…±åŒç»´æŠ¤èµ·äº†ä¸€ä¸ªä»»åŠ¡çš„æ–¹æ–¹é¢é¢çš„ä¿¡æ¯ã€‚</p>\n<p>å…¶ä¸­ï¼Œéœ€è¦å†æ¬¡æ³¨æ„çš„æ˜¯ï¼ŒLinux0.11 ç‰ˆæœ¬æœ€å¤šåªæ”¯æŒ 64 ä¸ªä»»åŠ¡ (è¿™æ˜¯ç¡¬ç¼–ç å†³å®šçš„ä¸Šé™ï¼Œå› ä¸ºè¿™ä¸ª task_struct ç»“æ„å®ä¾‹åªå£°æ˜äº† 64 ä¸ª)</p>\n<pre><code class="language-c">/*\n *  \'schedule()\' is the scheduler function. This is GOOD CODE! There\n * probably won\'t be any reason to change this, as it should work well\n * in all circumstances (ie gives IO-bound processes good response etc).\n * The one thing you might take a look at is the signal-handler code here.\n *\n *   NOTE!!  Task 0 is the \'idle\' task, which gets called when no other\n * tasks can run. It can not be killed, and it cannot sleep. The \'state\'\n * information in task[0] is never used.\n */\nvoid schedule(void)\n{\n    int i,next,c;\n    struct task_struct ** p;\n\n/* check alarm, wake up any interruptible tasks that have got a signal */\n/* æ£€æµ‹ alarm (ä»»åŠ¡å®šæ—¶æŠ¥è­¦ä¿¡å·)ï¼Œå¹¶å”¤é†’å¯ä¸­æ–­çš„ä»»åŠ¡æ¥å®Œæˆé¢„å®šä¹‰çš„å·¥ä½œ, å¥½åƒè‡ªå·±ç”¨å¾—å°‘ï¼Œè¿˜ä¸å¤ªäº†è§£ alarm(xxx) çš„ç»†èŠ‚\n * ä»ä»»åŠ¡ 63 å·å¼€å§‹(æ€»å…± 64 ä¸ªä»»åŠ¡, 0~63) ï¼Œå€’ç€éå†æ‰€æœ‰ä»»åŠ¡ï¼Œæ£€æµ‹ alarm \n */\n    for(p = &#x26;LAST_TASK ; p > &#x26;FIRST_TASK ; --p)\n        if (*p) {\n            if ((*p)->alarm &#x26;&#x26; (*p)->alarm &#x3C; jiffies) {\n                    (*p)->signal |= (1&#x3C;&#x3C;(SIGALRM-1));\n                    (*p)->alarm = 0;\n                }\n            if (((*p)->signal &#x26; ~(_BLOCKABLE &#x26; (*p)->blocked)) &#x26;&#x26;\n            (*p)->state==TASK_INTERRUPTIBLE)\n                (*p)->state=TASK_RUNNING;\n        }\n\n/* this is the scheduler proper: */\n\n    while (1) {\n        c = -1;\n        next = 0;\n        i = NR_TASKS;   /* è¿™é‡Œçš„å® NR_TASKS = 64 */\n        p = &#x26;task[NR_TASKS];\n        while (--i) {\n            if (!*--p)\n                continue;\n            /* é€‰æ‹©ä»»åŠ¡çŠ¶æ€ä¸º å°±ç»ªæ€ï¼Œä¸” counter å€¼æœ€å¤§çš„ä»»åŠ¡å·ä½œä¸ºä¸‹ä¸€ä¸ªå ç”¨ CPU çš„ä»»åŠ¡\n            if ((*p)->state == TASK_RUNNING &#x26;&#x26; (*p)->counter > c) \n                c = (*p)->counter, next = i;\n        }\n        /* å¦‚æœæ²¡æœ‰å…¶å®ƒä»»åŠ¡ï¼Œé‚£ä¹ˆ next = 0 ï¼Œå³æ¥ä¸‹æ¥å ç”¨ cpu çš„ä»»åŠ¡å°±æ˜¯ 0å·ä»»åŠ¡(0å·ä»»åŠ¡ä¸€å®šå­˜åœ¨ï¼Œä¸èƒ½è¢« kill ) */\n        if (c) break;\n        /* å¦‚æœ 1~63 å·ä»»åŠ¡(ä¸å­˜åœ¨æˆ–ä¸åœ¨å°±ç»ªæ€)è‡³å°‘å­˜åœ¨ä¸€ä¸ªä»»åŠ¡ï¼Œä¸”æ—¶é—´ç‰‡éƒ½ä¸º 0 ï¼Œé‚£ä¹ˆé‡æ–°è®¡ç®—åˆ†é…ç»™æ¯ä¸ªä»»åŠ¡çš„ counter å€¼ */\n        for(p = &#x26;LAST_TASK ; p > &#x26;FIRST_TASK ; --p)\n            if (*p)\n                (*p)->counter = ((*p)->counter >> 1) + (*p)->priority;\n    }\n    /* å°†å½“å‰ä»»åŠ¡åˆ‡æ¢ä¸º next ï¼Œç„¶åå°±å¯ä»¥ä¸€åˆ‡å°±ç»ªï¼Œé€€å‡ºæ—¶é’Ÿä¸­æ–­ï¼Œå°±å˜æˆæ–°çš„å ç”¨cpuçš„ä»»åŠ¡æ¥æ‰§è¡Œäº† */\n    switch_to(next);\n}\n</code></pre>\n<p><strong>switch_to(next)</strong></p>\n<p>switch_to(next) è¿™ä¸ªå‡½æ•°ï¼Œæ˜¯é€šè¿‡å†…åµŒæ±‡ç¼–å†™çš„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ç»†èŠ‚(è¿™é‡Œé€‰ç”¨ GCC ç¼–è¯‘å‡ºæ¥çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œä¸ç›´æ¥ä½¿ç”¨å†…åµŒæ±‡ç¼–)</p>\n<pre><code class="language-assembly"># è¿™é‡Œçš„æ±‡ç¼–æŒ‡ä»¤ç´§è·Ÿåœ¨ if(c) break; ä¹‹å\n.L36:\n    movl    %ebx, %edx          # è¿™é‡Œ ebx å­˜å‚¨çš„æ˜¯ next å˜é‡çš„å€¼ï¼Œç°åœ¨å¤åˆ¶åˆ° edx ä¸Š\n    sall    $4, %edx            # sallã€addl ä¸¤è¡Œçš„ç›®çš„æ˜¯è®¡ç®—å¾—åˆ°ä¸€ä¸ª TSS é€‰æ‹©ç¬¦ï¼ŒTSS0 åœ¨ GDT æ˜¯ç¬¬4é¡¹ï¼ŒTSS1 åœ¨ GDT æ˜¯ç¬¬ 6 é¡¹ï¼Œç±»æ¨...å…¶ä¸­é€‰æ‹©ç¬¦å3ä½ä¸ºDPLå’Œ GDTR/LDTR é€‰é¡¹\n    addl    $32, %edx\n    movl    _task(,%ebx,4), %ecx    # æ‰¾åˆ° next å·ä»»åŠ¡çš„ task_struct çš„æŒ‡é’ˆ (å­˜å‚¨åœ¨ task[64] çš„æ•°ç»„ä¸­)\n#APP\n# 141 "sched.c" 1\n    cmpl %ecx,_current          # ç¡®è®¤æ˜¯ä¸æ˜¯åŸä»»åŠ¡\n    je 1f                       # æ˜¯çš„è¯ç›´æ¥è·³å‡º (è·³åˆ°æœ€è¿‘çš„æ ‡ç­¾ 1 )\n    movw %dx,8(%esp)\n    xchgl %ecx,_current         # äº¤æ¢ ecx å’Œ _current å­˜å‚¨çš„å€¼\n    ljmp 4(%esp)                # é€šè¿‡é—´æ¥è·³è½¬å®Œæˆä»»åŠ¡åˆ‡æ¢ã€‚é€šç”¨çš„å½¢å¼æ˜¯ jmp CS:IPï¼Œä½†æ˜¯ä½¿ç”¨é—´æ¥è·³è½¬ï¼Œåœ¨å†…å­˜ä¸­çš„å€¼å…ˆè¯»å– 32 ä½åç§»é‡ï¼Œå†è¯» 16 ä½æ®µé€‰æ‹©ç¬¦\n    cmpl %ecx,_last_task_used_math\n    jne 1f\n    clts                        # æ¸…é™¤ CR0 å¯„å­˜å™¨ä¸­çš„ TS Flag \n1:\n# 0 "" 2\n#NO_AP\n</code></pre>\n<p>ä¸Šé¢è¿™æ®µç¨‹åºæœ‰å¿…è¦å°†å®ƒå‰²è£‚æˆä¸¤éƒ¨åˆ†æ¥çœ‹å¾…ï¼Œä»¥ <code>ljmp 4(%esp)</code> ä¸ºç•Œã€‚</p>\n<p><code>jmp</code> ï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å½“æ˜æ˜¾çš„ç¨‹åºè·³è½¬ã€‚è¿™é‡Œ jmp ç»™å‡ºçš„é€‰æ‹©ç¬¦æ˜¯ GDT ä¸ŠæŸä¸ªä»»åŠ¡çš„ TSS æè¿°ç¬¦</p>\n<p>é€šè¿‡ <code>jmp</code> CPU å°†å®Œæˆè€çš„ä»»åŠ¡æ‰€æœ‰å¯„å­˜å™¨çš„ä¿å­˜ç°åœºï¼Œä»¥åŠæ–°çš„ä»»åŠ¡æ‰€æœ‰å¯„å­˜å™¨æš‚å­˜ç»“æœçš„è½½å…¥ã€‚</p>\n<p>CPU æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œå°†æ˜¯æ–°çš„ä»»åŠ¡ CS:EIP æ‰€æŒ‡æ˜çš„æŒ‡ä»¤ã€‚</p>\n<p>ç›¸åº”çš„ï¼Œ<code>ljmp</code> ä¹‹åçš„æŒ‡ä»¤å°†åœ¨è¯¥ä»»åŠ¡é‡æ–°è·å¾—å ç”¨ CPU åè·å¾—æ‰§è¡Œã€‚</p>\n<h2>ä»»åŠ¡è°ƒåº¦çš„ç»“æŸé˜¶æ®µ</h2>\n<p>è¿™æ®µå°±æ¯”è¾ƒç»•äº†ï¼Œç°åœ¨å‡è®¾ä¸€ä¸ªå‰æï¼Œå°±æ˜¯ä»»åŠ¡ A ä¹Ÿæ˜¯åœ¨æ—¶é’Ÿä¸­æ–­é‡æ–°è¿›è¡Œä»»åŠ¡è°ƒåº¦çš„æ—¶å€™è¢«æ›¿æ¢æ‰çš„ï¼Œç°åœ¨ CPU åˆ†é…çš„æ—¶é—´ç‰‡åˆè½®åˆ°äº†ä»»åŠ¡ A ã€‚</p>\n<p>ä¹Ÿå°±æ˜¯ç´§éšç€ä¸Šä¸€å°èŠ‚ <code>ljmp</code> çœ‹çœ‹ä»ä»»åŠ¡å†…æ ¸æ€å›åˆ°ç”¨æˆ·æ€çš„æµç¨‹ã€‚</p>\n<pre><code class="language-asm">    # è¿™æ®µä¸ä¸Šé¢ä¸€æ®µæŒ‡ä»¤æ˜¯ç›´æ¥æ‰¿æ¥çš„\n    movl    12(%esp), %eax\n    xorl    %gs:20, %eax\n    je  .L40\n    call    ___stack_chk_fail\n.L40:\n    addl    $24, %esp           # è¿™é‡Œè¿”è¿˜è¿™æ¬¡ call é¢å¤–ç”³è¯·çš„å†…æ ¸æ ˆç©ºé—´\n    .cfi_def_cfa_offset 8\n    popl    %ebx                # æ¢å¤è¿›å…¥ call çš„æ—¶å€™æš‚å­˜çš„ ebx\n    .cfi_restore 3\n    .cfi_def_cfa_offset 4\n    ret                         # return è·³è½¬å›åˆ°å½“åˆè°ƒç”¨çš„åœ°æ–¹\n    .cfi_endproc\n</code></pre>\n<p>è¿˜æ˜¯ä»æ±‡ç¼–æŒ‡ä»¤æ¥çœ‹</p>\n<pre><code class="language-asm">    call    _schedule           # åŸå…ˆè°ƒç”¨ schedule() çš„åœ°æ–¹\n.L93:\n    # return è·³è½¬å›æ¥ï¼Œç›´æ¥æ‰¿æ¥çš„æŒ‡ä»¤\n    addl    $8, %esp\n    .cfi_def_cfa_offset 8\n    popl    %ebx\n    .cfi_restore 3\n    .cfi_def_cfa_offset 4\n    ret                         # ç»§ç»­ return ï¼Œè·³å‡º do_timer() \n    .cfi_endproc\n</code></pre>\n<pre><code class="language-asm">    call _do_timer      # \'do_timer(long CPL)\' does everything from\n    addl $4,%esp        # task switching to accounting ...\n    jmp ret_from_sys_call\n</code></pre>\n<p><strong>ret_from_sys_call</strong></p>\n<p>è¿™é‡Œå°±æ‰“ç®—æ­£å¼ç»“æŸç”±äºè¿™æ¬¡æ—¶é’Ÿä¸­æ–­æ‰€å¼•å‘çš„å†…æ ¸æ€æŒ‡ä»¤æ‰§è¡Œçš„æµç¨‹ï¼Œæ­£å¼å›å½’ç”¨æˆ·æ€äº†ã€‚</p>\n<pre><code class="language-asm">ret_from_sys_call:\n    # è¿™ 3 è¡Œæ¥åˆ¤æ–­æ˜¯ä¸æ˜¯ä»»åŠ¡0ï¼Œå¦‚æœæ˜¯å°±ä¸è¿›è¡Œä¿¡å·é‡çš„å¤„ç†äº†\n    movl _current,%eax      # task[0] cannot have signals\n    cmpl _task,%eax\n    je 3f\n    # åˆ¤æ–­åœ¨å‘ç”Ÿæ—¶é’Ÿä¸­æ–­å‰ï¼ŒCS è¡¨ç¤ºçš„æ˜¯ä¸æ˜¯ LDT ç¬¬ 1 é¡¹ (å±€éƒ¨å˜é‡è¡¨çš„ä»£ç æ®µ)\n    # å¦åˆ™ CS å°±åº”è¯¥å†…æ ¸æ€ä»£ç æ®µäº†ï¼Œä¸è¿›è¡Œä¿¡å·é‡å¤„ç†\n    cmpw $0x0f,CS(%esp)     # was old code segment supervisor ?\n    jne 3f\n    # åˆ¤æ–­åœ¨å‘ç”Ÿæ—¶é’Ÿä¸­æ–­å‰ï¼ŒSS è¡¨ç¤ºçš„æ˜¯ä¸æ˜¯ LDT ç¬¬ 2 é¡¹ (å±€éƒ¨å˜é‡è¡¨çš„æ•°æ®æ®µ)\n    # å¦åˆ™è®¤ä¸ºç¨‹åºè¿˜å¤„åœ¨å†…æ ¸æ€ï¼Œä¸è¿›è¡Œä¿¡å·é‡å¤„ç†\n    cmpw $0x17,OLDSS(%esp)      # was stack segment = 0x17 ?\n    jne 3f\n    # è®¾ç½®ä¿¡å·é‡ (ä¸æ¸…æ¥šï¼Œå…ˆæŒ–ä¸ªå‘)\n    movl signal(%eax),%ebx\n    movl blocked(%eax),%ecx\n    notl %ecx\n    andl %ebx,%ecx\n    bsfl %ecx,%ecx\n    je 3f\n    btrl %ecx,%ebx\n    movl %ebx,signal(%eax)\n    incl %ecx\n    pushl %ecx\n    call _do_signal\n    popl %eax\n3:  popl %eax\n    popl %ebx\n    popl %ecx\n    popl %edx\n    pop %fs\n    pop %es\n    pop %ds\n    iret\n</code></pre>\n<p>è‡³æ­¤ï¼Œé€šè¿‡ iret å°†è·³è½¬å›åˆ°ç”¨æˆ·æ€ä»£ç è¢«ä¸­æ–­çš„ä½ç½®ï¼Œå¹¶ç»§ç»­æ‰§è¡Œ</p>\n<h2>è¡¥å……</h2>\n<h3>pause()</h3>\n<p><a href="https://dormouse-none.github.io/2018-10-06-understand-Kernel-3/">Linux Kernel(3) - æ“ä½œç³»ç»Ÿå¯åŠ¨</a> ä¸­ï¼Œæè¿°è¿‡ä»»åŠ¡0åœ¨å®Œæˆäº†æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„å¯åŠ¨æµç¨‹ä¹‹åï¼Œå”¯ä¸€åœ¨åšçš„äº‹æƒ…ï¼Œå°±æ˜¯è°ƒç”¨ <code>for(;;) pause();</code> </p>\n<p>CPU æ¯æ¬¡æŠŠæ—¶é—´ç‰‡åˆ†é…ç»™å®ƒï¼Œå®ƒå°±å¼€å§‹æµªè´¹æƒåŠ›ï¼Œç›´æ¥ä¸è¦äº†è¿™ä¸ªæ—¶é—´ç‰‡ã€‚</p>\n<p>ä¹‹å‰ä¸€ç›´ä»¥ä¸º pause() ä¼šé€‰æ‹©æ‰§è¡Œ <code>HLT</code> æŒ‡ä»¤è®© CPU æš‚æ—¶åœ°é™·å…¥åœæ­¢çŠ¶æ€ã€‚ä½†æ˜¯å‡ºä¹æ„æ–™ï¼Œå¹¶ä¸æ˜¯è¿™ä¸ªç»“æœ(å½“ç„¶ï¼Œæœ€ç»ˆæ˜¯ä¸æ˜¯è¿˜æ˜¯å¦ä¸€ä¸ªè¯´æ³•ã€‚æ¯•ç«Ÿä»£ç éƒ½æ˜¯äººå†™çš„ï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥å„è‡ªæœ‰ä¸€å¥—å®ç°)ã€‚</p>\n<p>å½“ CPU æŠŠæ‰§è¡ŒæŒ‡ä»¤çš„æƒåŠ›äº¤ä¸ªä»»åŠ¡ 0 æ—¶ï¼Œé€‰æ‹©è®© CPU åœæ­¢ï¼Œç›´åˆ°æ¥æ”¶åˆ°ç¡¬ä»¶ä¸­æ–­ä¸ºæ­¢ä¹Ÿä¸å¤±ä¸ºä¸€ç§é€‰æ‹©ã€‚å½“ç„¶ï¼Œä¸è®ºå…¶å®ƒï¼ŒLinux0.11ç‰ˆæœ¬çš„ä»£ç ä¸æ˜¯è¿™æ ·çš„ã€‚</p>\n<p>é€šè¿‡ <code>INT 0x80</code> é…åˆç³»ç»Ÿè°ƒç”¨å‡½æ•°æŸ¥è¡¨ï¼Œæœ€åå®šä½åˆ°çš„å°±æ˜¯ sys_pause() äº†</p>\n<pre><code>_sys_pause:\n.LFB13:\n    .cfi_startproc\n    subl    $12, %esp\n    .cfi_def_cfa_offset 16\n    movl    _current, %eax\n    movl    $1, (%eax)\n    call    _schedule       # è°ƒç”¨ schedule() é‡æ–°åˆ’åˆ†æ—¶é—´ç‰‡\n    movl    $0, %eax\n    addl    $12, %esp\n    .cfi_def_cfa_offset 4\n    ret\n    .cfi_endproc\n</code></pre>\n<h3>timer å®šæ—¶å™¨</h3>\n<p>ä¹‹å‰åœ¨ <code>do_timer()</code> å‡½æ•°ä¸­ä¹Ÿçœ‹è¿‡äº†æ¯æ¬¡æ—¶é’Ÿä¸­æ–­ï¼Œéƒ½ä¼šæ£€æŸ¥ä¸€éå®šæ—¶å™¨ï¼Œå¹¶å†³å®šæ˜¯å¦è§¦å‘é¢„ç½®çš„å®šæ—¶å™¨å¤„ç†å‡½æ•°ã€‚</p>\n<p>å½“ç„¶äº†ï¼Œæ—¢ç„¶æ˜¯è§¦å‘å®šæ—¶å™¨ï¼Œæ€»æ˜¯è¦æœ‰ä¸€ä¸ªå‰æâ€”â€”è®¾ç½®å®šæ—¶å™¨</p>\n<pre><code class="language-c">void add_timer(long jiffies, void (*fn)(void))\n{\n    struct timer_list * p;\n\n    if (!fn)\n        return;\n    cli();\n    if (jiffies &#x3C;= 0)\n        (fn)();\n    else {\n        for (p = timer_list ; p &#x3C; timer_list + TIME_REQUESTS ; p++)\n            if (!p->fn)\n                break;\n        if (p >= timer_list + TIME_REQUESTS)\n            panic("No more time requests free");\n        p->fn = fn;\n        p->jiffies = jiffies;\n        p->next = next_timer;\n        next_timer = p;\n        while (p->next &#x26;&#x26; p->next->jiffies &#x3C; p->jiffies) {\n            p->jiffies -= p->next->jiffies;\n            fn = p->fn;\n            p->fn = p->next->fn;\n            p->next->fn = fn;\n            jiffies = p->jiffies;\n            p->jiffies = p->next->jiffies;\n            p->next->jiffies = jiffies;\n            p = p->next;\n        }\n    }\n    sti();\n}\n</code></pre>\n<h2>å°ç»“</h2>\n<p>å¯¹äºä»»åŠ¡è°ƒåº¦ï¼Œæ›´éš¾çš„æ˜¯å¯¹ä¸€ä¸ªæ—¶é—´æ–­å±‚çš„ç†è§£ã€‚åœ¨è°ƒåº¦è¿‡ç¨‹ä¸­ï¼Œæ—§ä»»åŠ¡è¢«æš‚åœï¼Œæ–°çš„ä»»åŠ¡è¢«é‡æ–°å¯åŠ¨, ç›´åˆ°æ—§çš„ä»»åŠ¡åˆè¢«å¯åŠ¨ã€‚è¿™é‡Œå°±å¿…é¡»äººä¸ºåœ°å°†è¢«ä¸­æ–­çš„ä»»åŠ¡ä¸»åŠ¨çš„è¿æ¥èµ·æ¥çœ‹å¾…ã€‚</p>\n<p>æ—©æœŸç‰ˆæœ¬çš„ä»»åŠ¡è°ƒåº¦æ¨¡å—ç¡®å®æ¯”è¾ƒç®€å•ï¼Œç´¯è®¡ä¸è¿‡ç™¾è¡Œ C ä»£ç ã€‚å“ˆå“ˆã€‚ä¸€ç‚¹ä¸€ç‚¹ç»§ç»­æ¥å§ã€‚</p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},CrC2:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>åœ¨ç½‘ç»œåè®®ä¸Šï¼Œé«˜å±‚åè®®ç¡®å®æ¯”åº•å±‚åè®®æ›´å®¹æ˜“ç†è§£ï¼Œä¹Ÿæ›´åŠ çš„äººæ€§åŒ–ã€‚\nä¼ è¾“å±‚çš„ TCP, UDP éƒ½è¿˜åœç•™åœ¨å„ç§å­—èŠ‚å†…å®¹çš„æ•´åˆå’Œæ ¡éªŒä¸Šï¼Œè€Œæ›´ä¸Šå±‚çš„åº”ç”¨å±‚åè®®å°±å·²ç»èƒ½å¤Ÿç›´è§‚åˆ°é€šè¿‡ç›´æ¥è§£è¯»å°±èƒ½ç†è§£å…¶æ¯æ¡æ¶ˆæ¯çš„å«ä¹‰äº†ã€‚</p>\n<h2>SMTP åè®®</h2>\n<p>SMTPï¼Œç®€å•é‚®ä»¶ä¼ è¾“åè®®ã€‚å•ä»åè®®å†…å®¹ä¸Šæ¥è¯´ç¡®å®æ²¡æœ‰å¤ªå¤šçš„å­¦ä¹ éš¾åº¦ã€‚ä½†æ˜¯ï¼Œæ‰­è½¬â€œå¸¸è¯†â€æ°æ°æ˜¯å·¨å¤§çš„ç»Šè„šçŸ³ã€‚\nç›´æ¥å°±è¿›å…¥äº†ç½‘é¡µé‚®ä»¶ç³»ç»Ÿ or å®¢æˆ·ç«¯é‚®ä»¶ç³»ç»Ÿçš„æ—¶ä»£ã€‚å›¾å½¢åŒ–çš„ç•Œé¢é…åˆä¸Šä¸€äº›å…³é”®å­—çš„å†…å®¹ (æ¯”å¦‚æ”¶ä»¶äººï¼Œä¸»é¢˜ç­‰)ã€‚\nç‚¹å‡»å‘é€å°±è§‰å¾—ä¸€å°é‚®ä»¶å·²ç»å‘å‡ºå»äº†ã€‚</p>\n<p>ä½†æ˜¯ï¼Œç©¶ç«Ÿè¿™ä¸­é—´åšäº†ä»€ä¹ˆå‘¢ï¼Ÿ\n163ï¼ŒGMAIL, QQ ç­‰é‚®ç®±ç©¶ç«Ÿåˆåœ¨å…¶ä¸­æ‰®æ¼”ç€æ€æ ·çš„ä¸€ä¸ªè§’è‰²ï¼Ÿ</p>\n<p>é¦–å…ˆï¼ŒSMTP æ˜¯ä¸ºäº†é«˜æ•ˆã€å¯é åœ°ä¼ é€’é‚®ä»¶è€Œå­˜åœ¨çš„ã€‚</p>\n<p>ä¸‹é¢å…ˆç»™ä¸€æ®µæ¼”ç¤ºã€‚é€šè¿‡ telnet è¿æ¥åˆ° 183.57.48.34 (è¿™ä¸ªæ˜¯è…¾è®¯ä¼ä¸šé‚®å…¶ä¸­ä¸€å°æœºå™¨çš„ IP) 25 (SMTP æœåŠ¡ç«¯å£) ï¼Œä»¥æœ¬æœºä½œä¸º SMTP çš„å®¢æˆ·ç«¯ï¼Œè€Œå°† 183.XXX ä½œä¸º SMTP çš„æœåŠ¡ç«¯ï¼Œæ¥å®Œæˆé‚®ä»¶ä¿¡æ¯çš„ä¸€æ¬¡äº¤äº’ã€‚ (å½“ç„¶ï¼Œæœ€åå¤±è´¥äº†ã€‚è¢«ä¼ä¸šé‚®è¯†åˆ«ä¸ºåƒåœ¾é‚®ä»¶äº†...)</p>\n<p>ä¸‹åˆ—æ¯è¡Œ <code>#</code> å¼€å§‹åŠä¹‹åçš„å†…å®¹æ˜¯ä¸ªäººæ·»åŠ çš„æ³¨é‡Šï¼Œå…¶å®ƒå†…å®¹æ˜¯ telnet äº¤äº’çš„å†…å®¹ã€‚\nåŒæ—¶ï¼Œ<code>--</code> æ ‡å¿—è¯¥è¡Œå†…å®¹ç”±</p>\n<pre><code>$ telnet 183.57.48.34 25\nTrying 183.57.48.34...\nConnected to 183.57.48.34.\nEscape character is \'^]\'.\n220 bizmx17.qq.com MX QQ Mail Server\nHELO test                               -- # MEANS HELLO &#x3C;domain> åœ¨æ¯æ¬¡å»ºç«‹è¿æ¥é€šé“åï¼Œå‘é€çš„ç¬¬ä¸€æ¡æ¶ˆæ¯\n250 bizmx17.qq.com                         # æœåŠ¡å™¨çš„å›å¤å€¼ Code 250 \nMAIL FROM: &#x3C;from@test.net>              -- # MAIL è¡¨ç¤ºé‚®ä»¶çš„å‘èµ·æ–¹ï¼Œç”¨äºé€€ä¿¡ç­‰å…¶ä»–é‚®ä»¶åå‘äº‹ä»¶\n250 Ok                                   \nRCPT TO: &#x3C;to@xxx.xxx>                   -- # RCPT è¡¨ç¤ºé‚®ä»¶çš„æ¥æ”¶æ–¹ï¼Œç”¨äºæŠ•é€’é‚®ä»¶ç­‰æ­£å‘äº‹ä»¶\n250 Ok\nDATA                                    -- # DATA è¡¨ç¤ºä¹‹åçš„å†…å®¹å°†ä½œä¸ºé‚®ä»¶æ­£æ–‡ (æ­£æ–‡è¿™ä¸ªæè¿°å¯èƒ½ä¸å¤ªæ°å½“ï¼Œæ›´åº”è¯¥æ˜¯ç­‰åŒäºä¿¡å°å†…çš„æ‰€æœ‰å†…å®¹)\n354 End data with &#x3C;CR>&#x3C;LF>.&#x3C;CR>&#x3C;LF>\n                                        --\nIt\'s a fake mail.                       -- # é‚®ä»¶æ­£æ–‡ï¼Œå…¶å®è¿˜å¯ä»¥å†™ä¸Šè¯¸å¦‚ \'Subject: XXX\' \'Cc: XXX\' çš„å†…å®¹\n.                                       -- # æ­£æ–‡å†…å®¹ç»“æŸçš„æ ‡å¿—ï¼Œ&#x3C;CR>&#x3C;LF>.&#x3C;CR>&#x3C;LF>\n550 Mail content denied. http://service.exmail.qq.com/cgi-bin/help?subtype=1&#x26;&#x26;id=20022&#x26;&#x26;no=1000726 # è¿™é‡Œå¾ˆæ— å¥ˆï¼Œæ²¡è…¾è®¯ç»™æ‹¦äº†ï¼Œæ²¡å‘å‡ºå»ã€‚ä¸è¿‡åæ­£æ˜¯å‡çš„ï¼Œé‚®ä»¶ä¿¡æ¯ä¸å…¨ã€‚\n</code></pre>\n<h3>å‡ ä¸ªä¸»è¦çš„ SMTP äº¤äº’æŒ‡ä»¤</h3>\n<ul>\n<li>HELO: (HELLO)\nä¸»è¦ç”¨äºè®© SMTP æœåŠ¡å™¨å¯¹å½“å‰è¿æ¥çš„ SMTP å®¢æˆ·ç«¯(ä¸Šä¾‹æ˜¯ telnet æ¨¡æ‹Ÿçš„) å»ºç«‹ä¸€ä¸ªèº«ä»½æ ‡å¿— (ä¸€èˆ¬æ˜¯å½“å‰çš„ä¸»æœºå)</li>\n<li>MAIL:\nç”¨æ³• MAIL FROM: <a href="mailto:xx@xx.xx">xx@xx.xx</a> (ä¸åŒºåˆ†å¤§å°å†™)\nå¯ä»¥å°†å…¶ä¸æ™®é€šä¿¡ä»¶çš„ä¿¡å°ç­‰åŒã€‚æ¯•ç«Ÿéƒ½æ˜¯è¦å†™ä¸Šå‘ä¿¡äººï¼Œå¦‚æœæ²¡äººæ”¶ä¿¡ï¼Œä¹Ÿå°±å¯ä»¥æ ¹æ®è¿™ä¸ªå£°æ˜å°†ä¿¡ä»¶é€€å›ã€‚</li>\n<li>RCPT: (RECIPIENT)\nç”¨æ³• RCPT TO: <a href="mailto:xx@xx.xx">xx@xx.xx</a> (å¯å¤šæ¬¡é‡å¤å£°æ˜ï¼Œå³å°†ä¸€å°ä¿¡ä»¶å¤åˆ¶å¤šæ¬¡æŠ•é€ç»™æ¯æ¬¡å£°æ˜çš„å¯¹è±¡)\nç›¸å½“äºæ™®é€šä¿¡ä»¶çš„æ”¶ä¿¡äººã€‚ä¸è¿‡ä¹Ÿæœ‰ç‚¹åŒºåˆ«ï¼Œæ¯•ç«Ÿæ™®é€šä¿¡ä»¶æ²¡æ³•ä¸€ä»¶å¤šå‘å˜›ã€‚</li>\n<li>DATA:\n<code>DATA</code> ä¹‹ååˆ° <code>&#x3C;CR>&#x3C;LF>.&#x3C;CR>&#x3C;LF></code> ä¹‹å‰çš„æ‰€æœ‰å†…å®¹éƒ½ä½œä¸ºé‚®ä»¶çš„æ­£æ–‡å†…å®¹ã€‚ç­‰åŒäºæ™®é€šä¿¡ä»¶ä¿¡å°å†…çš„ä¿¡çº¸(å½“ç„¶äº†ï¼Œä¿¡çº¸ä¸Šåœ¨å†™ä¸Š <code>To XXX:</code> <code>Yours XXX</code> ä¹Ÿæ˜¯å¾ˆæ­£å¸¸çš„å˜›)ï¼Œç±»ä¼¼çš„ä¹Ÿå°±æ˜¯ DATA æ•°æ®ä¸­ä¹Ÿå¯ä»¥åŒ…æ‹¬ <code>Subject:</code> (ä¸»é¢˜), <code>From:</code> (å†™ä¿¡äºº), <code>Date:</code> (æ—¥æœŸ), <code>To:</code>(æ”¶ä»¶äºº)ç­‰å†…å®¹ã€‚</li>\n</ul>\n<hr>\n<h3>å‡ ä¸ªæ¬¡è¦çš„ SMTP äº¤äº’æŒ‡ä»¤</h3>\n<ul>\n<li>\n<p>RSET: (Reset)\né‡ç½®ï¼Œä¸¢å¼ƒä¹‹å‰é’ˆå¯¹é‚®ä»¶æ‰€æè¿°çš„æ‰€æœ‰å†…å®¹ï¼Œé‡æ–°å¼€å§‹ã€‚</p>\n</li>\n<li>\n<p>VRFY: (VERIFY)\nç”¨äºç¡®è®¤æ”¶ä»¶äººæ˜¯å¦å­˜åœ¨ï¼Œä»¥åŠæ”¶ä»¶äººçš„å®Œæ•´åœ°å€</p>\n</li>\n<li>\n<p>NOOP:\nå¼ºåˆ¶æœåŠ¡å™¨åšå‡ºä¸€ä¸ªå›åº”ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ã€‚</p>\n</li>\n<li>\n<p>QUIT:\nè¦æ±‚æ”¶ä¿¡æœåŠ¡å™¨è¿”å›ä¸€ä¸ªé‚®ä»¶æ¥æ”¶æˆåŠŸçš„ä¿¡å·ï¼Œä¹‹åé‡Šæ”¾è¿æ¥é€šé“ã€‚</p>\n</li>\n</ul>\n<h2>SMTP æ‰©å±•</h2>\n<p>å‰é¢æè¿°äº†è¿™ä¹ˆå¤šï¼Œåº”è¯¥æ¥è¯´æ‰¾ä¸€äº›æ”¯æŒ TCP (æˆ–è€…å…¶ä»–ç¨³å®šçš„ä¼ è¾“å±‚è¿æ¥ä¹Ÿæ˜¯å¯ä»¥çš„) è¿æ¥çš„å‘½ä»¤å°±å®Œå…¨å¯ä»¥æ”¯æŒä¸€æ¬¡é‚®ä»¶å‘é€çš„éœ€æ±‚ã€‚</p>\n<p>ä½†æ˜¯ï¼Œå¦‚æœæƒ³è¦å‘é€ä¸€äº›ä¸­æ–‡å­—ç¬¦ä¹‹ç±»çš„ï¼Œé©¬ä¸Šå°±å‡ºç°äº†é—®é¢˜ã€‚</p>\n<p>è¿™é‡Œæœ‰å‡ ç§æ–¹å¼ï¼Œä½†æœ¬äººè¿˜æ²¡æœ‰ç†è§£é€å½»ã€‚ä»…åˆ—å‡ºçŸ¥é“çš„å¯è¡Œæ–¹æ¡ˆã€‚</p>\n<ul>\n<li>é€šè¿‡ IMF (Internet Message Format) è¿›è¡Œå‘ä»¶</li>\n<li>é€šè¿‡ ESMTP </li>\n</ul>\n<h2>SMTP å®‰å…¨</h2>\n<p>å‡ºäº SMTP æœ¬èº«åè®®çš„è®¾è®¡ï¼Œæ²¡æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„èº«ä»½è®¤è¯æœºåˆ¶ã€‚</p>\n<p>çºµä½¿é€šè¿‡ <code>MAIL FROM: &#x3C;A@test.net></code> åœ¨ä¿¡å°ä¸Šå†™æ˜äº†æ˜¯ç”± A å‘å‡ºçš„ä¿¡ä»¶ã€‚\nä½†æ˜¯ï¼Œè£…åœ¨ä¿¡å°å†…çš„ä¿¡çº¸å´å¯ä»¥å±ä¸Šå¦ä¸€ä¸ªäººçš„åå­—ã€‚</p>\n<p>åˆ©ç”¨è¿™ç§è§„åˆ™ï¼Œä¹Ÿå°±å‡ºç°äº†ä¼ªè£…å‘ä¿¡äººè¿™æ ·çš„æ“ä½œã€‚å½“ç„¶ï¼Œç°åœ¨çš„å¤§é‡é‚®ç®±æœåŠ¡æä¾›å•†éƒ½ä¼šå¯¹è¿™ç§æƒ…å†µè¿›è¡Œæ ‡è®°ã€‚</p>\n<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fvpbzedf67j315e01q0sp.jpg" alt="â€œä»£å‘â€æ ‡è®°"></p>\n<h2>å‚è€ƒ</h2>\n<ol>\n<li><a href="https://tools.ietf.org/html/rfc821">SIMPLE MAIL TRANSFER PROTOCOL</a></li>\n<li><a href="http://www.ruanyifeng.com/blog/2008/06/mime.html">MIME</a></li>\n</ol>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},EhLH:function(n,e,t){"use strict";t.r(e);var a=t("q1tI"),r=t.n(a),o=t("nOHt"),s=t("0o6o");e.default=Object(o.withRouter)(function(n){var e=t("hzKy")("./"+n.router.query.filePath+".json");return r.a.createElement(s.a,null,r.a.createElement("div",{className:"page-post"},r.a.createElement("div",{dangerouslySetInnerHTML:{__html:e.contents}})))})},GuZ5:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>å†™äº†ä¸¤å¤©ï¼Œå‡ ä¹æ˜¯ä»é›¶å¼€å§‹ï¼ŒC è¯­è¨€æäº†ä¸€ä¸ªå‘ TCP SYN åŒ…çš„å°ç¨‹åºã€‚\nä»åè®®åˆ°ç¨‹åºä»£ç çš„è½¬æ¢ï¼Œç¡®å®æ²¡æœ‰èŠ±è´¹å¤ªå¤šçš„æ—¶é—´ï¼Œä½†æ˜¯ä¸ºäº†å­—èŠ‚åº(byteorder)çš„é—®é¢˜ç®€ç›´æŠ˜è…¾å¾—...</p>\n<h2>TCP é¦–éƒ¨æ ¼å¼</h2>\n<p>ä» RFC 793 äº†è§£åˆ°åŸºç¡€çš„ TCP é¦–éƒ¨æ ¼å¼(å½“ç„¶ï¼Œæ¨¡æ‹Ÿä¸‰æ¬¡æ¡æ‰‹çš„ SYN åŒ…ä¹Ÿæ ¹æœ¬ä¸éœ€è¦å¡«å……ä»»ä½•æ•°æ®)ã€‚</p>\n<pre><code>    0                   1                   2                   3\n    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |          Source Port          |       Destination Port        |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |                        Sequence Number                        |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |                    Acknowledgment Number                      |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |  Data |           |U|A|P|R|S|F|                               |\n   | Offset| Reserved  |R|C|S|S|Y|I|            Window             |\n   |       |           |G|K|H|T|N|N|                               |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |           Checksum            |         Urgent Pointer        |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |                    Options                    |    Padding    |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   |                             data                              |\n   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n</code></pre>\n<p>å¯¹äºä»…ä»…æ¨¡æ‹Ÿä¸€ä¸ª SYN åŒ…è€Œè¨€ï¼Œä¼¼ä¹æ— éœ€å…³å¿ƒ Sequence Number, Ack Number, Window ç­‰ä¿¡æ¯ï¼Œæ¯•ç«Ÿéƒ½ä¸å…³å¿ƒæœåŠ¡å™¨ç«¯ç»™çš„è¿”å›ã€‚\næœ€ä½çš„è¦æ±‚ï¼Œä»…ä»…æ˜¯å‘ä¸€ä¸ªåˆæ³•çš„ TCP æŠ¥æ–‡ï¼Œå¾—åˆ°æœåŠ¡å™¨ç«¯çš„åé¦ˆï¼Œè€Œéç›´æ¥è¢«æœåŠ¡å™¨ç«¯ä¸¢å¼ƒ(å¦‚æœè¢«éªŒè¯åˆ°æŠ¥æ–‡éæ³•æˆ–è€…æ•°æ®å‡ºé”™ç­‰)ã€‚</p>\n<p>é‚£ä¹ˆï¼Œæœ€ä¸ºé‡è¦çš„ç»†èŠ‚å°±æ˜¯ Checksum (æ ¡éªŒå’Œ) äº†ã€‚æœåŠ¡å™¨ç«¯ä¼šå¯¹æ¥æ”¶åˆ°çš„æ•°æ®æµè¿›è¡Œæ ¡éªŒï¼Œå¦‚æœæœ‰å·®é”™ï¼Œåˆ™ç›´æ¥ä¸¢å¼ƒï¼Œè€Œæ— ä»»ä½•ç»“æœã€‚</p>\n<h2>æ ¡éªŒå’Œ</h2>\n<p>ä»ç»†èŠ‚ä¸Šæ¥è¯´ï¼Œç½‘ç»œåè®®ä¸­çš„æ ¡éªŒå’Œæ˜¾å¾—æ¯”è¾ƒç®€å•ã€‚ä»¥ TCP åè®®çš„ Checksum å­—æ®µä¸¾ä¾‹ï¼Œå°±æ˜¯ä¸ºäº†è®©ä¼ªé¦–éƒ¨(TCP é¦–éƒ¨ + source IP + destination IP ç­‰ä¸€äº›é¢å¤–ä¿¡æ¯)\nä»¥æ¯ 16 ä½ (2 å­—èŠ‚) ä¸ºä¸€ä¸ªå•ä½ï¼Œå¾ªç¯ç´¯åŠ å’Œæœ€ç»ˆè¾¾åˆ° 0xFFFF çš„æ•ˆæœã€‚</p>\n<p>ä¸‹é¢ä»¥ä¸€ä¸ªç”± Source IP: 172.16.2.101 -> Destination IP: 172.16.2.127 çš„ TCP é¦–éƒ¨ä¸ºä¾‹è¿›è¡Œç»†èŠ‚æè¿°:</p>\n<pre><code># æ€»é•¿ä¸º 20 å­—èŠ‚çš„ TCP æŠ¥æ–‡é¦–éƒ¨\n27 11 0f a0 00 00 00 00 00 00 00 00 50 02 ff 00 1d 2c 00 00\n\nsrc Port: 0x2711 -> 10001\ndst Port: 0x0fa0 -> 4000\nSeq nr: 0x00000000 -> 0\nAck nr: 0x00000000 -> 0\nData off: 5 -> 32 bits æ•°é‡æ˜¯ 5 -> 20 å­—èŠ‚ (å³ TCP é¦–éƒ¨é•¿åº¦ä¸º 20 å­—èŠ‚)\nFLAG: 0x02 -> urg ack psh rst SYN fin \nWindow: 0xFF00 (çª—å£å¤§å°ä¸º 65280 å­—èŠ‚)\nchk sum: 0x1d2c\nurg pointer: 0x0000\n</code></pre>\n<p>åœ¨è®¡ç®—ä¹‹å‰ï¼ŒTCP æ ¡éªŒå’Œè¿˜å°†æ¶‰åŠåˆ°ä¼ªé¦–éƒ¨çš„æ¦‚å¿µ</p>\n<pre><code>+--------+--------+--------+--------+\n|           Source Address          |\n+--------+--------+--------+--------+\n|         Destination Address       |\n+--------+--------+--------+--------+\n|  zero  |  PTCL  |    TCP Length   |\n+--------+--------+--------+--------+\n\nåœ¨æ­¤ä¾‹ä¸­:\nSource Address: 172.16.2.101 -> 0xAC100265\nDestination Address: 172.16.2.127 -> 0XAC10027F\nzero: 0x00\nPTCL(protocol): TCP(6) -> 0x06\nTCP Length: 20 bytes -> 0x0014\n</code></pre>\n<p>å³åŠ ä¸Šä¼ªé¦–éƒ¨çš„å†…å®¹ï¼Œéœ€è¦å…±åŒè¿›è¡Œæ ¡éªŒçš„æ•°æ®æµå¦‚ä¸‹</p>\n<pre><code>ac 10 02 65 ac 10 02 7f 00 06 00 14 27 11 0f a0 00 00 00 00 00 00 00 00 50 02 ff 00 1d 2c 00 00\n</code></pre>\n<h3>æœåŠ¡å™¨ç«¯æ ¡éªŒ</h3>\n<p>æœåŠ¡å™¨ç«¯æ¥æ”¶åˆ° TCP æŠ¥æ–‡åï¼Œå°†å¯¹æ•´ä¸ªéœ€è¦æ ¡éªŒçš„æ•°æ®æµï¼ŒæŒ‰ 16 bits (2å­—èŠ‚) ä¸ºå•ä½ï¼Œè¿›è¡Œç´¯åŠ ã€‚</p>\n<p>å³: <code>0xac10+0x0265+0xac10+0x027f+0x0006+0x0014+0x2711+0x0fa0+0x0000+0x0000+0x0000+0x0000+0x5002+0xff00+0x1d2c+0x0000 = 0x2fffd</code></p>\n<p>å¯¹äºè¶…é•¿è®¡ç®—ç»“æœ (è¶…å‡º 0xFFFF) ï¼Œå¾ªç¯å°†é«˜ä½å³ç§» 16 ä½ä¸ä½ä½è¿›è¡Œç´¯åŠ ï¼Œç›´åˆ°ç»“æœ &#x3C;= 0xFFFF ï¼Œå³ <code>0x20000 >> 16 + 0xfffd = 0xffff</code></p>\n<p>å¦‚æœæœ€ç»ˆç»“æœ <code>=0xffff</code>(å…¨ä¸º 1) ï¼Œåˆ™è®¤ä¸º TCP é¦–éƒ¨æ²¡æœ‰é—®é¢˜ï¼ŒæœåŠ¡å™¨ç«¯æ¥æ”¶æŠ¥æ–‡ï¼Œå¹¶å›å¤ ACK SYN åŒ…ã€‚</p>\n<h3>å®¢æˆ·ç«¯æ„é€ æ ¡éªŒå’Œ</h3>\n<p>ä¸æœåŠ¡å™¨ç«¯ç›¸å¯¹ï¼Œæ˜¾ç„¶å®¢æˆ·ç«¯å¿…é¡»é€šè¿‡ Check sum ï¼Œä½¿å¾—æœ€ç»ˆçš„ç»“æœæœåŠ¡å™¨ç«¯æ ¡éªŒçš„æ¡ä»¶ã€‚</p>\n<p>ä½œä¸ºåå‘é—®é¢˜ï¼ŒåŒæ ·ä»¥ä¸Šé¢ä¸ºä¾‹å­ï¼Œå‡è®¾ check sum è¿˜æœªç¡®å®šå…·ä½“çš„å€¼ã€‚åˆ™è®¡ç®—æ–¹å¼å¦‚ä¸‹:</p>\n<p>åŠ ä¸Šä¼ªé¦–éƒ¨, æ ¡éªŒå’Œæš‚æ—¶ç½®é›¶çš„æ•°æ®æµ</p>\n<pre><code>ac 10 02 65 ac 10 02 7f 00 06 00 14 27 11 0f a0 00 00 00 00 00 00 00 00 50 02 ff 00 00 00 00 00\n</code></pre>\n<p>ä½œä¸ºé€†è¿‡ç¨‹ï¼ŒæŒ‰ 16 bits ä¸ºå•ä½ï¼Œè¿›è¡Œç´¯åŠ ã€‚å³: <code>0xac10+0x0265+0xac10+0x027f+0x0006+0x0014+0x2711+0x0fa0+0x0000+0x0000+0x0000+0x0000+0x5002+0xff00+0x0000+0x0000 = 0x2e2d1</code></p>\n<p>è¶…é•¿éƒ¨åˆ†å¾ªç¯ç´¯åŠ ï¼Œ<code>0x20000 >> 16 + 0xe2d1 = 0xe2d3</code></p>\n<p>ç»“æœå–åï¼Œ<code>~ 0xe2d3 = 0x1d2c</code></p>\n<p>å³è®¤ä¸º <code>0x1d2c</code> ä¸ºæ ¡éªŒå’Œ</p>\n<h2>HBO ä¸ NBO</h2>\n<p>HBO: host byte order\nNBO: network byte order </p>\n<p>è¯´èµ·å­—èŠ‚åºç®€ç›´èƒ½å¤ŸæŠŠäººé€¼ç–¯ï¼Œè¯´å®è¯è™½ç„¶æœ‰ä¸€å®šçš„å†å²åŸå› ï¼Œä½†æ˜¯ä¸åšç»Ÿä¸€çœŸçš„å¯¹åº•å±‚ç¼–ç¨‹ç›¸å½“å¾—ä¸å‹å¥½ã€‚</p>\n<p>ä¸è¿‡ï¼Œå†åŒçƒ¦ä¹Ÿä¸èƒ½æ”¹å˜ä»€ä¹ˆã€‚æ€»è¿˜å¾—ç»§ç»­å†™ä»£ç ä¸æ˜¯å˜›ã€‚</p>\n<h3>ä¸»æœºå­—èŠ‚åº (HBO, Host Byte Order)</h3>\n<p>é‡‡ç”¨å°ç«¯å­—èŠ‚æ’åºæ–¹å¼ã€‚ç®€å•æè¿°ä¸º é«˜ä½å­—èŠ‚å­˜æ”¾åœ¨å†…å­˜çš„é«˜åœ°å€å¤„ï¼Œä½ä½å­—èŠ‚å­˜å‚¨åœ¨å†…å­˜çš„ä½åœ°å€å¤„ã€‚</p>\n<p>ä»¥ 4 å­—èŠ‚ int å‹æ•°æ® 0xAB1267EF ä¸ºä¾‹:</p>\n<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fvdu3zhh92j31040newel.jpg"></p>\n<p>è€Œç¨‹åºè¯»å–æ•°æ®çš„é¡ºåºï¼Œå¦‚æœä¸è€ƒè™‘æ•°æ®ç±»å‹ï¼ŒæŒ‰å­—èŠ‚è¯»å–ï¼Œæ™®éå°†é‡‡ç”¨å­—èŠ‚é€’å¢åºè¯»å–ï¼Œåˆ™ä¼˜å…ˆå°†è¯»åˆ° 0xEF ç­‰ä½ä½å­—èŠ‚æ•°æ®</p>\n<h3>ç½‘ç»œå­—èŠ‚åº (NBO, Network Byte Order)</h3>\n<p>é‡‡ç”¨å¤§ç«¯å­—èŠ‚æ’åºæ–¹å¼ã€‚ç®€å•æè¿°ä¸ºé€šè¿‡ç½‘ç»œæ¥æ”¶åˆ°æ•°æ®æ—¶å°†ä¼˜å…ˆæ¥æ”¶åˆ°æ•°æ®çš„é«˜ä½å­—èŠ‚ï¼Œç„¶åå†å¾—åˆ°ä½ä½å­—èŠ‚ã€‚</p>\n<p>è¿˜æ˜¯ä»¥ 4 å­—èŠ‚ int å‹æ•°æ® 0xAB1267EF ä¸ºä¾‹:</p>\n<p>åˆ™é€šè¿‡ç½‘ç»œå¾—åˆ°çš„æ•°æ®æµå°†æ˜¯ <code>0xEF 0x67 0x12 0xAB</code></p>\n<h3>å®é™…ä½¿ç”¨</h3>\n<p>C è¯­è¨€ï¼ŒBSD å¹³å°çš„ netinet/tcp.h å®šä¹‰äº† tcp header ç»“æ„ä½“ã€‚</p>\n<pre><code class="language-c">struct tcphdr {\n    unsigned short  th_sport;   /* source port */\n    unsigned short  th_dport;   /* destination port */\n    tcp_seq th_seq;         /* sequence number */\n    tcp_seq th_ack;         /* acknowledgement number */\n#if __DARWIN_BYTE_ORDER == __DARWIN_LITTLE_ENDIAN\n    unsigned int    th_x2:4,    /* (unused) */\n            th_off:4;   /* data offset */\n#endif\n#if __DARWIN_BYTE_ORDER == __DARWIN_BIG_ENDIAN\n    unsigned int    th_off:4,   /* data offset */\n            th_x2:4;    /* (unused) */\n#endif\n    unsigned char   th_flags;\n#define TH_FIN  0x01\n#define TH_SYN  0x02\n#define TH_RST  0x04\n#define TH_PUSH 0x08\n#define TH_ACK  0x10\n#define TH_URG  0x20\n#define TH_ECE  0x40\n#define TH_CWR  0x80\n#define TH_FLAGS    (TH_FIN|TH_SYN|TH_RST|TH_ACK|TH_URG|TH_ECE|TH_CWR)\n\n    unsigned short  th_win;     /* window */\n    unsigned short  th_sum;     /* checksum */\n    unsigned short  th_urp;     /* urgent pointer */\n};\n</code></pre>\n<p>å¯¹äº <code>unsigned char</code> ä¹‹ç±»çš„å•å­—èŠ‚æ•°æ®ï¼Œå°†ä¸å­˜åœ¨ä»»ä½•é—®é¢˜ã€‚ä½†æ˜¯ï¼Œè¯¸å¦‚ <code>unsigned short</code> ç­‰å¤šå­—èŠ‚æ•°æ®ï¼Œå°†æ¶‰åŠåˆ°å­—èŠ‚åºçš„è½¬æ¢ã€‚</p>\n<p>æ¯”å¦‚ï¼Œè™½ç„¶ä»¤ <code>th_sport = 0x2711 (10001)</code> çœ‹ä¼¼åˆç†ã€‚ä½†æ˜¯ï¼Œä»å†…å­˜çš„è§’åº¦æ¥çœ‹ï¼Œæ•°æ®å°†è¢«å­˜å‚¨ä¸º </p>\n<pre><code># å‡è®¾èµ·å§‹ç‰©ç†å†…å­˜åœ°å€ä¸º 0x00007c000\n0x00007c01: 0x27 \n0x00007c00: 0x11\n</code></pre>\n<p>ç­‰åˆ°æ„é€ å®Œ TCP é¦–éƒ¨ï¼Œé¡ºæ¬¡åœ°å‘é€æ•°æ®æ—¶ï¼Œå‘ˆç°çš„æ•°æ®æµå°†å½¢å¦‚: <code>0x11 0x27...</code> å³ä½¿ç”¨é‡Œ HBO (å°ç«¯å­—èŠ‚åº) çš„æ•°æ®æ— æ³•æ»¡è¶³ NBO (å¤§ç«¯å­—èŠ‚åº) çš„è¦æ±‚ã€‚\næ¯•ç«Ÿï¼Œä¸¤è€…ç›¸äº’å¯¹ç«‹ã€‚</p>\n<p>å› æ­¤ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„å­—èŠ‚åºçš„é—®é¢˜ã€‚å½“ç„¶ï¼ŒC è¯­è¨€è¿˜æ˜¯æƒ³å½“å‹å¥½åœ°æä¾›äº†å­—èŠ‚åºè½¬æ¢çš„å·¥å…· <code>htons</code>, <code>htonl</code>, <code>ntohs</code>, <code>ntohl</code> ã€‚è¯¦æƒ…è¯·é€šè¿‡ <code>man byteorder</code> æŸ¥çœ‹ã€‚</p>\n<h2>TCP SYN çš„ç®€å•ä¾‹ç¨‹</h2>\n<pre><code class="language-c">#include &#x3C;stdio.h>\n#include &#x3C;stdlib.h>\n#include &#x3C;string.h>\n#include &#x3C;unistd.h>\n#include &#x3C;errno.h>\n#include &#x3C;arpa/inet.h>\n#include &#x3C;netinet/tcp.h>\n#include &#x3C;netinet/ip.h>\n#include &#x3C;netinet/in.h>\n\n/**\n * +--------+--------+--------+--------+\n * |           Source Address          |\n * +--------+--------+--------+--------+\n * |         Destination Address       |\n * +--------+--------+--------+--------+\n * |  zero  |  PTCL  |    TCP Length   |\n * +--------+--------+--------+--------+\n */\nstruct pseudohdr {\n    unsigned int src_addr;\n    unsigned int dst_addr;\n    unsigned short zero:8;\n    unsigned short protocol:8;\n    unsigned short tcp_length;\n\n    struct tcphdr tcpHdr;\n};\n\nunsigned short check_sum(unsigned short *ptr, size_t nbytes) \n{\n    unsigned int sum = 0;\n\n    while(nbytes > 0) \n    {\n        sum += htons(*ptr++);\n        nbytes -= 2;\n    }\n\n    sum = (sum >> 16) + (sum &#x26; 0xFFFF);\n    sum = (sum >> 16) + (sum &#x26; 0xFFFF);\n\n    sum = ~sum;\n    return (unsigned short) sum;\n}\n\nstruct tcphdr * init_tcp_header(int sport) \n{\n    struct tcphdr * header = (struct tcphdr *) malloc(sizeof(struct tcphdr));\n    header->th_sport = htons(sport);    // æºç«¯å£\n    header->th_dport = htons(4000);     // ç›®æ ‡ç«¯å£\n    header->th_seq = 0;                // åºåˆ—å·\n    header->th_ack = 0;                // ç¡®è®¤åºå· | ACK ç½®ä½æ—¶æœ‰æ•ˆ\n    header->th_off = sizeof(struct tcphdr) / 4;   // TCP é¦–éƒ¨é•¿åº¦ (å­—èŠ‚)\n    header->th_flags = TH_SYN;      // æ ‡å¿—ä½\n    header->th_win = 255;           // æ•°æ®çª—å£å¤§å°\n    header->th_sum = 0;             // æ ¡éªŒå€¼ (å…ˆç½®ä¸º 0, ç­‰ä¼šå†ä¿®æ­£)\n    header->th_urp = 0;\n    return header;\n}\n\nvoid tcp_syn(int tcp_sock, struct tcphdr *header)\n{\n    struct sockaddr_in *addr = (struct sockaddr_in *) malloc(sizeof(struct sockaddr_in));\n    addr->sin_family = PF_INET;\n    addr->sin_port = htons(4000);\n    addr->sin_addr.s_addr = inet_addr("172.16.2.127");\n    ssize_t size = sendto(tcp_sock, header, sizeof(struct tcphdr), 0, (struct sockaddr *)addr, sizeof(addr));\n}\n\nint main(int argc, char **argv)\n{\n    int tcp_sock = socket(PF_INET, SOCK_RAW, IPPROTO_TCP);\n    if(tcp_sock == -1) \n    {\n        fprintf(stderr, "Open Socket Failed: %s(errno: %d)\\n", strerror(errno), errno);\n        exit(0);\n    }\n\n    struct tcphdr *tcpHdr = init_tcp_header(10001);\n\n    struct pseudohdr *psdHdr = (struct pseudohdr *) malloc(sizeof(struct pseudohdr));\n    psdHdr->src_addr = inet_addr("172.16.2.101");\n    psdHdr->dst_addr = inet_addr("172.16.2.127");\n    psdHdr->zero = 0;\n    psdHdr->protocol = 6;\n    psdHdr->tcp_length = htons(sizeof(struct tcphdr));\n    memcpy(&#x26;psdHdr->tcpHdr, tcpHdr, sizeof(struct tcphdr));\n    tcpHdr->th_sum = htons(check_sum((unsigned short *) psdHdr, sizeof(struct pseudohdr)));\n    free(psdHdr);\n\n    tcp_syn(tcp_sock, tcpHdr);\n    free(tcpHdr);\n}\n</code></pre>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},H67F:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>ç”¨æƒ¯äº†ç±» Unix ç³»ç»Ÿï¼Œåº”è¯¥è¯´æ–‡ä»¶ç³»ç»Ÿæ˜¯æ—¥å¸¸æœ€å¸¸æ¥è§¦çš„ä¸€ä¸ªæ“ä½œç³»ç»Ÿæ¨¡å—ä¹‹ä¸€äº†ã€‚</p>\n<pre><code class="language-shell">$ ls\nApplications Network      Users        bin          data         etc          net          sbin         usr\nLibrary      System       Volumes      cores        dev          home         private      tmp          var\n</code></pre>\n<p>ä½†æ˜¯ï¼Œç©¶ç«Ÿä»€ä¹ˆæ˜¯æ–‡ä»¶ç³»ç»Ÿ? ä¸ºä»€ä¹ˆéœ€è¦æ–‡ä»¶ç³»ç»Ÿ? éš¾é“æ–‡ä»¶ä¸æ˜¯ç®€å•åœ°å­˜å‚¨åˆ°å­˜å‚¨è®¾å¤‡ä¸€å—è¿ç»­åŒºåŸŸçš„å—?</p>\n<h2>æ–‡ä»¶ç³»ç»Ÿçš„å½¢å¼</h2>\n<p>é¦–å…ˆæˆ‘ä»¬å‡è®¾æ–‡ä»¶æ˜¯ç®€å•åœ°å­˜å‚¨åœ¨å­˜å‚¨è®¾å¤‡(ç¡¬ç›˜ç­‰)æŸä¸€å—è¿ç»­åŒºåŸŸçš„ã€‚</p>\n<p>é‚£ä¹ˆå¦‚ä½•åœ¨å°åˆ™å‡ ç™¾Gï¼Œå¤§åˆ™å‡ åTç”šè‡³æ›´å¤§çš„å­˜å‚¨è®¾å¤‡ä¸Šæ‰¾åˆ°å…·ä½“çš„æŸä¸€æ–‡ä»¶ï¼Œå¹¶è¯»å–çš„å†…å­˜ä¸­å‘¢?</p>\n<p>æœ€æ™®é€šçš„ï¼Œå°±åªèƒ½åœ¨å­˜å‚¨è®¾å¤‡ä¸Šä¸€å­—èŠ‚ä¸€å­—èŠ‚çš„æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ç›¸åº”çš„ç›®æ ‡æ–‡ä»¶ã€‚æ˜¯ä¸æ˜¯å¯ä»¥æƒ³è±¡ï¼Œè¿™ä¼šå¾ˆæ…¢å¾ˆæ…¢ã€‚</p>\n<p>æœ‰æ²¡æœ‰å¿«ä¸€ç‚¹çš„ï¼Ÿå¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œå‚è€ƒç±»ä¼¼å­—å…¸çš„å½¢å¼å°±å¯ä»¥äº†ã€‚</p>\n<p><strong>ç›®å½•å½¢å¼</strong></p>\n<p>æ–‡ä»¶å†…å®¹å¯èƒ½å¾ˆå¤§ï¼Œä½†ç›¸æ¯”ä¹‹ä¸‹ï¼Œæ–‡ä»¶åå°±å°äº†å¾ˆå¤š(å°±ç®—ä¸åŒç›®å½•ä¸‹åŒåæ–‡ä»¶å¾ˆå¤šï¼Œä½†æ˜¯è®°å½•å…¨è·¯å¾„åä¹Ÿä»£ä»·ä¸å¤§ã€‚å½“ç„¶äº†ï¼Œå¦‚æœéƒ½æ˜¯å°æ–‡ä»¶ã€ç©ºæ–‡ä»¶ï¼Œé‚£å°±ä¸ä¸€æ ·äº†)</p>\n<p>é€šè¿‡ä¸ºæ‰€æœ‰æ–‡ä»¶é€šè¿‡æ–‡ä»¶åç¼–ä¸€ä¸ªç›®å½•ï¼ŒæŒ‡æ˜æ¯ä¸ªæ–‡ä»¶åœ¨å­˜å‚¨è®¾å¤‡ä¸Šçš„å…·ä½“ä½ç½®ã€‚è¿™æ ·éœ€è¦æ‰«æçš„å†…å®¹å°±ä¼šå°å¾ˆå¤šï¼Œä¹Ÿèƒ½æ›´å¿«åœ°å®šä½åˆ°æ–‡ä»¶å†…å®¹ã€‚</p>\n<p><strong>é€çº§ç›®å½•</strong></p>\n<p>ä»…ä»…åªç¼–åˆ¶ä¸€ä¸ªç›®å½•ï¼Œé‚£ä¹ˆå±‚æ¬¡ç›®å½•åˆæœ‰ä»€ä¹ˆå®é™…æ„ä¹‰å—ï¼Ÿåªæ˜¯ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·åˆ†ç±»ä¸åŒåŠŸèƒ½ã€ç›®çš„çš„æ–‡ä»¶å—ï¼Ÿ</p>\n<p>åˆ©ç”¨é€çº§ç›®å½•ï¼Œå¯ä»¥è€ƒè™‘å¯¹æ¬¡çº§ç›®å½•çš„å†…å®¹ç¼–åˆ¶ä¸Šä¸€çº§ç›®å½•ã€‚é€šè¿‡é¡¶çº§ç›®å½•å®šä½æ¬¡çº§ç›®å½•çš„å†…å®¹ï¼Œæ¬¡çº§ç›®å½•å®šä½å†æ¬¡çº§ç›®å½•ï¼Œæœ€åå¯¹åº”ç›®å½•ä¸‹çš„æ–‡ä»¶çš„å†…å®¹ã€‚</p>\n<h2>æ–‡ä»¶ç³»ç»Ÿçš„ç»„ç»‡</h2>\n<p>åœ¨ä¹‹å‰çš„ç†è§£é‡Œï¼Œæ–‡ä»¶ç³»ç»Ÿæ˜¯æ¥ç®¡äº†æ•´ä¸ªå­˜å‚¨è®¾å¤‡ã€‚ä¼¼ä¹æ–‡ä»¶ç³»ç»Ÿå’Œå­˜å‚¨è®¾å¤‡å°±æ˜¯ç›´æ¥å…³è”çš„ï¼Œä¸¤ä¸ªä¸å¯åˆ†å‰²ã€‚æ²¡æœ‰å»ºç«‹æ–‡ä»¶ç³»ç»Ÿçš„ç¡¬ç›˜å°±ä¸èƒ½ä½¿ç”¨ï¼Œè€Œæ²¡æœ‰ç¡¬ç›˜ï¼Œæ–‡ä»¶ç³»ç»Ÿå°±æ²¡æœ‰äº†è½½ä½“ã€‚</p>\n<p>ä½†æ˜¯ï¼Œåœ¨å­¦ä¹  Linux çš„è¿‡ç¨‹ä¸­ï¼Œä¼¼ä¹å‘ç°ä¹Ÿå¹¶ä¸æ˜¯è¿™ä¹ˆä¸€å›äº‹ã€‚æ²¡æœ‰ç›´æ¥ç¡¬ç›˜ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸€æ ·å¯ä»¥å­˜åœ¨ã€‚ä¸€ç›´éƒ½æœ‰åœ¨ä½¿ç”¨ <code>.img</code> ç£ç›˜æ˜ åƒæ–‡ä»¶ï¼Œåªæ˜¯æ²¡æœ‰æ„è¯†åˆ°ï¼Œè¿™æ„è¯†æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ç§è½½ä½“ã€‚åŒæ ·çš„ï¼Œæ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨æ“ä½œç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ ·æ˜¯å¯ä»¥åŠ è½½å„ç§å†…å®¹ï¼Œä¹ƒè‡³é¢„ç½®çš„æ–‡ä»¶ä¿¡æ¯ã€‚</p>\n<p>åœ¨ Linux ä¸­ï¼Œæœ€å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿå°±æ˜¯ ext2, ext3, ext4 ä¹‹æµäº†ã€‚å¶å°”ä¹Ÿæœ‰å¬è¿‡ç”¨è¿‡ï¼Œæ¯”å¦‚è¯´å‡†å¤‡æ¥å…¥æ–°çš„ç¡¬ç›˜çš„æ—¶å€™ã€‚ä½†æ˜¯ï¼ŒçœŸæ­£é‡Œé¢æ˜¯ä»€ä¹ˆæ ·çš„ã€‚è¿˜çœŸä¸äº†è§£ï¼Œext2,3,4 çš„åŒºåˆ«ï¼Œä¹Ÿæ ¹æœ¬ä¸çŸ¥é“ã€‚</p>\n<p>å½“ç„¶äº†ï¼Œæœ¬æ¬¡ä¹Ÿå¹¶ä¸ä¼šå¯¹è¿™äº›å†…å®¹è¿›è¡Œæè¿°ã€‚ç”±äºä¸€ç›´åœ¨å­¦ä¹  Linux 0.11 ç‰ˆæœ¬çš„æºç ï¼Œæ¥ä¸‹æ¥è¦æè¿°çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯ 0.11 ç‰ˆæœ¬ç›´æ¥ä½¿ç”¨çš„ minix æ–‡ä»¶ç³»ç»Ÿäº†ã€‚</p>\n<p>æœ€å¼€å§‹ï¼Œå½“ç„¶æ˜¯åº”è¯¥æœ‰ä¸€ä¸ªæ„Ÿå®˜çš„å°è±¡ï¼Œæ‰èƒ½æ›´æ–¹ä¾¿åœ°æ¥ç†è§£æ–‡ä»¶ç³»ç»Ÿçš„ç»„ç»‡å½¢å¼å•¦!</p>\n<h3>åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ</h3>\n<p>è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª 512 KB å¤§å°çš„æ–‡ä»¶ç³»ç»Ÿ</p>\n<p><code>mkfs</code> åº”è¯¥æ˜¯æœ€ç®€å•çš„æ–¹å¼äº†ã€‚</p>\n<pre><code class="language-shell">$ touch disk.img            # ç£ç›˜æ˜ åƒæ–‡ä»¶ (ç”±äºæ²¡æœ‰é¢å¤–çš„ç£ç›˜ï¼Œå°±ä»¥æ­¤ä½œä¸ºæ–°åˆ›å»ºçš„ minix æ–‡ä»¶ç³»ç»Ÿçš„è½½ä½“)\n$ dd if=/dev/zero of=disk.img bs=1024 count=512     # å…ˆå°†æ–‡ä»¶çš„å¤§å°æ‰©å±•åˆ° 512 KB ï¼Œå¦åˆ™åœ¨åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ä¼šå¤±è´¥\n512+0 records in\n512+0 records out\n524288 bytes (524 kB, 512 KiB) copied, 0.00216049 s, 243 MB/s\n$ mkfs.minix disk.img 512   # åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ\n192 inodes                  # inodes - åº”è¯¥å¾ˆç†Ÿæ‚‰å§ã€‚æ¯ä¸ªæ–‡ä»¶éƒ½å ç”¨ä¸€ä¸ª inode\n512 blocks                  # æ€»å…± 512 ä¸ªç£ç›˜å—\nFirstdatazone=10 (10)       # ç¬¬ 10 ä¸ªç£ç›˜å—å¼€å§‹æ˜¯çœŸæ­£çš„æ•°æ®å—ã€‚å‰é¢æ˜¯ä»€ä¹ˆ? å¤§éƒ¨åˆ†æ˜¯ç›®å½•å ç”¨çš„\nZonesize=1024               # æ¯ä¸ªç£ç›˜å—çš„å¤§å°ä¸º 1024 B\nMaxsize=268966912           # å•ä¸€æ–‡ä»¶çš„æœ€å¤§å¤§å°\n</code></pre>\n<p>å…ˆæ¥çœ‹çœ‹ç›®å‰ disk.img é‡Œé¢çš„å†…å®¹</p>\n<pre><code class="language-shell">$ hexdump disk.img\n0000000 0000 0000 0000 0000 0000 0000 0000 0000\n*                                                   # * è¡¨ç¤ºè¿™æ®µæ•°æ®å…¨ä¸º 0\n0000400 00c0 0200 0001 0001 000a 0000 1c00 1008\n0000410 138f 0001 0000 0000 0000 0000 0000 0000\n0000420 0000 0000 0000 0000 0000 0000 0000 0000\n*\n0000800 0003 0000 0000 0000 0000 0000 0000 0000\n0000810 0000 0000 0000 0000 fffe ffff ffff ffff\n0000820 ffff ffff ffff ffff ffff ffff ffff ffff\n*                                                   # * è¡¨ç¤ºè¿™æ®µæ•°æ®å…¨ä¸º ff ( * æ€»æ˜¯è¡¨ç¤ºä¸å‰ä¸€æ®µæ•°æ®ä¸€è‡´çš„çœç•¥)\n0000c00 0003 0000 0000 0000 0000 0000 0000 0000\n0000c10 0000 0000 0000 0000 0000 0000 0000 0000\n*\n0000c30 0000 0000 0000 0000 0000 0000 0000 ff80\n0000c40 ffff ffff ffff ffff ffff ffff ffff ffff\n*\n0001000 41ed 0000 0040 0000 cf12 5bd3 0200 000a\n0001010 0000 0000 0000 0000 0000 0000 0000 0000\n*\n0002800 0001 002e 0000 0000 0000 0000 0000 0000\n0002810 0000 0000 0000 0000 0000 0000 0000 0000\n0002820 0001 2e2e 0000 0000 0000 0000 0000 0000\n0002830 0000 0000 0000 0000 0000 0000 0000 0000\n0002840 0000 622e 6461 6c62 636f 736b 0000 0000\n0002850 0000 0000 0000 0000 0000 0000 0000 0000\n*\n0080000                                             # æˆªæ­¢å­—èŠ‚ï¼Œ0x80000 = 512 KB å¹¶ä¸å­˜åœ¨\n</code></pre>\n<p>ä¼¼ä¹å¹¶æ²¡æœ‰å¤ªå¤šçš„æ„Ÿè§‰ï¼Œç°åœ¨æˆ‘ä»¬å¾€ disk.img è¿™ä¸ªç£ç›˜æ˜ åƒæ–‡ä»¶ä¸­æ·»äº›å†…å®¹å†æ¥çœ‹çœ‹ã€‚</p>\n<pre><code class="language-shell">$ mount disk.img /mnt   # æŠŠ disk.img æŒ‚è½½åˆ° /mnt ç›®å½•ä¸‹\n$ cd /mnt\n$ echo "#include &#x3C;stdio.h>" > hello.c       # åˆ›å»º hello.c æ–‡ä»¶ï¼Œå¹¶å†™å…¥ #include &#x3C;stdio.h> \n$ umount /mnt           # è§£æŒ‚ disk.img\n$ hexdump -C disk.img\n00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00000400  c0 00 00 02 01 00 01 00  0a 00 00 00 00 1c 08 10  |................|\n00000410  8f 13 01 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00000420  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00000800  07 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00000810  00 00 00 00 00 00 00 00  fe ff ff ff ff ff ff ff  |................|\n00000820  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|\n*\n00000c00  07 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00000c10  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00000c30  00 00 00 00 00 00 00 00  00 00 00 00 00 00 80 ff  |................|\n00000c40  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|\n*\n00001000  ed 41 00 00 60 00 00 00  e5 0d d4 5b 00 02 0a 00  |.A..`......[....|\n00001010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00001020  a4 81 00 00 13 00 00 00  e5 0d d4 5b 00 01 0b 00  |...........[....|\n00001030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00002800  01 00 2e 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002810  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002820  01 00 2e 2e 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002830  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002840  02 00 68 65 6c 6c 6f 2e  63 00 00 00 00 00 00 00  |..hello.c.......|\n00002850  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00002c00  23 69 6e 63 6c 75 64 65  20 3c 73 74 64 69 6f 2e  |#include &#x3C;stdio.|\n00002c10  68 3e 0a 00 00 00 00 00  00 00 00 00 00 00 00 00  |h>..............|\n00002c20  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00080000\n</code></pre>\n<p>å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† <code>#include &#x3C;stdio.h></code> å­—æ ·çš„å†…å®¹ï¼ŒåŒæ—¶ä¹Ÿå‡ºç°äº† <code>hello.c</code> çš„æ–‡ä»¶åã€‚</p>\n<p>éœ€è¦æ³¨æ„ï¼Œæ–‡ä»¶åå’Œæ–‡ä»¶å†…å®¹æ˜¯ç›¸äº’å‰²è£‚çš„ï¼Œå¹¶æ²¡æœ‰ç›´æ¥å­˜å‚¨åœ¨ä¸€èµ·ã€‚</p>\n<h3>æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ç»“æ„</h3>\n<p>é‚£ä¹ˆï¼Œé…åˆç€ä¸Šé¢çš„å†…å®¹æ¥çœ‹çœ‹æ–‡ä»¶ç³»ç»Ÿçš„ç»„ç»‡ç»“æ„ã€‚</p>\n<p>é¦–å…ˆå¯ä»¥æ³¨æ„åˆ°çš„æ˜¯ï¼Œæ¯ä¸€æ®µéé›¶çš„æ•°æ®çš„å¼€å§‹åœ°å€ï¼ŒåŸºæœ¬éƒ½æ˜¯åœ¨ <code>0x0000, 0x0400, 0x0800, 0x0c00, 0x1000</code> ã€‚é—´éš”äº† 0x0400 = 1KBï¼Œè¿™å°±æ˜¯æœ€åŸºæœ¬çš„å—çš„å¤§å°ã€‚</p>\n<p>Minix æ–‡ä»¶ç³»ç»Ÿå°† 1024 B ä½œä¸ºåŸºæœ¬å—çš„å¤§å°ã€‚<code>disk.img</code> è¿™ä¸ª 512 KB çš„ç£ç›˜æ˜ åƒæ–‡ä»¶ï¼Œä¹Ÿå°±æ°å¥½è¢«åˆ†å‰²æˆ 512 å—ã€‚</p>\n<pre><code class="language-shell">$ mkfs.minix disk.img 512   # åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ\n192 inodes                  # inodes - åº”è¯¥å¾ˆç†Ÿæ‚‰å§ã€‚æ¯ä¸ªæ–‡ä»¶éƒ½å ç”¨ä¸€ä¸ª inode\n512 blocks                  # æ€»å…± 512 ä¸ªç£ç›˜å—\nFirstdatazone=10 (10)       # ç¬¬ 10 ä¸ªç£ç›˜å—å¼€å§‹æ˜¯çœŸæ­£çš„æ•°æ®å—ã€‚å‰é¢æ˜¯ä»€ä¹ˆ? å¤§éƒ¨åˆ†æ˜¯ç›®å½•å ç”¨çš„\nZonesize=1024               # æ¯ä¸ªç£ç›˜å—çš„å¤§å°ä¸º 1024 B\nMaxsize=268966912           # å•ä¸€æ–‡ä»¶çš„æœ€å¤§å¤§å°\n</code></pre>\n<p>åœ¨å›è¿‡å¤´æ¥çœ‹çœ‹å‰é¢åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™çš„ä¿¡æ¯ï¼Œç›¸ä¿¡ä¹Ÿå°±èƒ½å¤Ÿçœ‹æ‡‚ä¸€éƒ¨åˆ†äº†ã€‚</p>\n<p><strong>å—çš„ä½œç”¨åˆ’åˆ†</strong></p>\n<p>é‚£ä¹ˆï¼Œæ¯ä¸ªå—å¦‚ä½•è¿›è¡Œä½¿ç”¨å‘¢ï¼Ÿ</p>\n<p>é¦–å…ˆï¼Œæœ€å¼€å§‹çš„ä¸€ä¸ªå—å¹¶ä¸ä¼šç›´æ¥ä½¿ç”¨ã€‚æˆ‘ä»¬çŸ¥é“å¼•å¯¼ç¨‹åºåº”è¯¥å‡ºç°åœ¨å¼•å¯¼ç›˜æœ€å¼€å§‹ 512 Bã€‚ä½†æ˜¯ï¼Œæœ‰äº›ç›˜æœ‰å¼•å¯¼ç¨‹åºï¼Œæœ‰äº›ç›˜åˆæ²¡æœ‰ï¼Œå¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p>\n<p>æ–‡ä»¶ç³»ç»Ÿç»“æ„ä¸­ï¼Œé»˜è®¤åœ°ä¸å¯¹ç¬¬ä¸€ä¸ª 1024 B çš„å—è¿›è¡Œæ“ä½œï¼Œå³åŸæœ¬æ˜¯ä»€ä¹ˆæ•°æ®å°±æ˜¯ä»€ä¹ˆæ•°æ®ï¼Œä¸æ–‡ä»¶ç³»ç»Ÿå¹¶ä¸ç›¸å¹²ã€‚</p>\n<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwnnc753epj31kw04tq35.jpg"></p>\n<p>é™¤äº†å¼•å¯¼å—ï¼Œä¹‹åè¿˜æœ‰è¶…çº§å—ï¼Œinode ä½å›¾ï¼Œé€»è¾‘å—ä½å›¾ï¼Œinode åŒºå—ï¼Œæ•°æ®åŒºå—</p>\n<p><strong>è¶…çº§å—</strong></p>\n<p>çœŸæ­£å¯¹ MINIX æ–‡ä»¶ç³»ç»Ÿèµ·ç€ç»Ÿé¢†æ€§ä½œç”¨çš„ï¼Œæ˜¯è¶…çº§å—(ç¬¬äºŒä¸ªå—)ã€‚</p>\n<pre><code class="language-c">struct super_block {\n unsigned short s_ninodes;          /* i èŠ‚ç‚¹çš„æ•°é‡ */\n unsigned short s_nzones;           /* æ€»åŒºå—æ•°é‡ */\n unsigned short s_imap_blocks;      /* i èŠ‚ç‚¹ä½å›¾çš„æ•°é‡ */\n unsigned short s_zmap_blocks;      /* åŒºå—ä½å›¾çš„æ•°é‡ */\n unsigned short s_firstdatazone;    /* ç¬¬ä¸€ä¸ªæ•°æ®å—çš„ç¼–å· */\n unsigned short s_log_zone_size;    /* log2(ç£ç›˜å—å¤§å° / é€»è¾‘å—å¤§å°) */\n unsigned long s_max_size;          /* å•æ–‡ä»¶çš„æœ€å¤§é•¿åº¦ */\n unsigned short s_magic;            /* æ–‡ä»¶ç³»ç»Ÿçš„é­”æ•° */\n\n /* ä¸‹é¢çš„å†…å®¹æ˜¯åœ¨å†…å­˜ä¸­ä½¿ç”¨çš„ï¼Œå¹¶ä¸ä¼šåœ¨ç£ç›˜ä¸Šè¿›è¡Œè¯»å†™ */\n struct buffer_head * s_imap[8];\n struct buffer_head * s_zmap[8];\n unsigned short s_dev;\n struct m_inode * s_isup;\n struct m_inode * s_imount;\n unsigned long s_time;\n struct task_struct * s_wait;\n unsigned char s_lock;\n unsigned char s_rd_only;\n unsigned char s_dirt;\n};\n</code></pre>\n<p>ç»“åˆç€ <code>disk.img</code> çš„æ•°æ®æ¥çœ‹çœ‹ã€‚</p>\n<pre><code class="language-sh">00000400  c0 00 00 02 01 00 01 00  0a 00 00 00 00 1c 08 10  |................|\n00000410  8f 13 01 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n\n0x00c0  -> 192 ä¸ª i èŠ‚ç‚¹\n0x0200  -> 512 ä¸ªé€»è¾‘å—\n0x0001  -> ä¸€ä¸ªièŠ‚ç‚¹ä½å›¾\n0x0001  -> ä¸€ä¸ªé€»è¾‘å—ä½å›¾\n0x000a  -> ç¬¬ä¸€ä¸ªæ•°æ®å—ç¼–å·ä¸º 10 \n0x0000  -> log2(ç£ç›˜å—å¤§å° / é€»è¾‘å—å¤§å°) = 0 ï¼Œå³ç£ç›˜å—å¤§å° = é€»è¾‘å—å¤§å° = 1024 B\n0x10081c00 -> å•æ–‡ä»¶æœ€å¤§ 268966912 B \n</code></pre>\n<p><strong>inode ä½å›¾</strong></p>\n<p>inode ä½å›¾çš„æ•°æ®æ¯”è¾ƒç®€å•ï¼Œæ˜¯é€šè¿‡è®¾ç½®æ¯”ç‰¹ä½ 0ã€1 çš„æ–¹å¼ï¼Œæ¥ç›´æ¥è¡¨æ˜ç›¸åº”ç¼–å·çš„ i èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ã€‚\né»˜è®¤ i èŠ‚ç‚¹ä» 1 å·å¼€å§‹ç¼–å·ï¼Œ0 å·èŠ‚ç‚¹åœ¨ inode ä½å›¾ä¸Šä¸€å®šè®¾ç½®ä¸º 1 </p>\n<pre><code class="language-sh">00000800  07 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00000810  00 00 00 00 00 00 00 00  fe ff ff ff ff ff ff ff  |................|\n00000820  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|\n</code></pre>\n<p>æ€»å…± 192 ä¸ª i èŠ‚ç‚¹ï¼ŒåŠ ä¸Š 0 å·èŠ‚ç‚¹æ€»è®¡éœ€å ç”¨ 193 ä½ ( = 193 / 8 = 24 å­—èŠ‚ + 1 ä½)</p>\n<p>å…¶ä½™å¤šä½™çš„ä½ï¼Œå…¨éƒ¨ç½®ä½ä¸º 1 ã€‚</p>\n<p>ä½å›¾å­˜å‚¨çš„æœ€åˆæ•°æ® 0x07 (æ³¨æ„ï¼Œå°ç«¯å­˜å‚¨æ³•) = 0b111</p>\n<p>ç”±æ­¤ï¼Œæ€»å…±æœ‰1å·å’Œ2å·ièŠ‚ç‚¹ã€‚</p>\n<p><strong>é€»è¾‘å—ä½å›¾</strong></p>\n<p>ç±»ä¼¼çš„ï¼Œé€»è¾‘å—ä½å›¾æ˜¯ä¸ºäº†è¡¨æ˜ç¬¬nä¸ªé€»è¾‘å—å­˜å‚¨æœ‰æ•°æ®ï¼Œæˆ–å¤„äºç©ºé—²çŠ¶æ€ã€‚</p>\n<p><strong>inode åŒºå—</strong></p>\n<p>å‚ç…§å‰é¢è®²è¿‡çš„å­—å…¸ç›®å½•çš„å½¢å¼ï¼Œinode å°±æ˜¯ä¸€ç§åˆ†çº§ç¼–æ’åçš„ç›®å½•ã€‚</p>\n<p>å½“ç„¶ï¼Œè¯´ç›®å½•å¯èƒ½è¿˜ä¼šå¼•å‘è¯¯è§£ã€‚è¿™é‡Œæ— è®ºæ˜¯å¯¹äºæ“ä½œç³»ç»Ÿä¸‹çš„ç›®å½•æˆ–æ˜¯æ–‡ä»¶ï¼Œæ¯ä¸€ä¸ªéƒ½å¯¹åº”ç€ä¸€ä¸ªç‹¬ç‰¹çš„ inode</p>\n<pre><code class="language-c">struct d_inode {\n unsigned short i_mode;     /* æ–‡ä»¶ç±»å‹å’Œå±æ€§ (rwx ä½) */\n unsigned short i_uid;      /* æ–‡ä»¶æ‰€æœ‰è€… id */\n unsigned long i_size;      /* æ–‡ä»¶å¤§å° */\n unsigned long i_time;      /* ä¿®æ”¹æ—¶é—´ */\n unsigned char i_gid;       /* æ–‡ä»¶æ‰€åœ¨ç»„ id */\n unsigned char i_nlinks;    /* æœ‰å¤šå°‘ä¸ªé“¾æ¥æ•° (æœ‰å¤šå°‘ä¸ªæ–‡ä»¶ç›®å½•é¡¹æŒ‡å‘è¯¥ i èŠ‚ç‚¹) */\n unsigned short i_zone[9];  /* æ–‡ä»¶æ•°æ®æ‰€å ç”¨æ•°æ®ç›˜çš„æŒ‡é’ˆ */\n};\n</code></pre>\n<p>æ¯ä¸ªièŠ‚ç‚¹çš„æ•°æ®åˆ†åˆ« 32 å­—èŠ‚</p>\n<p>åŒæ ·çš„ï¼Œç»“åˆ <code>disk.img</code> çš„æ•°æ®æ¥çœ‹</p>\n<pre><code>00001000  ed 41 00 00 60 00 00 00  e5 0d d4 5b 00 02 0a 00  |.A..`......[....|\n00001010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00001020  a4 81 00 00 13 00 00 00  e5 0d d4 5b 00 01 0b 00  |...........[....|\n00001030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n\n0x41ed  -> \n0x0000  ->  æ–‡ä»¶æ‰€æœ‰è€…ä¸º 0 å³ root\n0x00000060  ->  æ–‡ä»¶å¤§å°ä¸º 96 B\n0x5bd40de5  ->  æ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´ä¸º Unix TimeStamp 1540623845 => 2018/10/27 15:4:5\n0x00    ->  æ–‡ä»¶æ‰€åœ¨ç»„ id\n0x02    ->  æœ‰ä¸¤ä¸ªæ–‡ä»¶ç›®å½•é¡¹æŒ‡å‘1å·ièŠ‚ç‚¹\n0x000a  ->  1 å· i èŠ‚ç‚¹æŒ‡å‘çš„ç¬¬0å—æ•°æ®ä¸ºç¬¬10ä¸ªé€»è¾‘å—(å³ç¬¬1ä¸ªæ•°æ®å—)\n0x0000  =>  ç”±äºæ•°æ®æ¯”è¾ƒå°ï¼Œåé¢çš„ i_zone[1] ~ i_zone[8] å‡ä¸º 0\n</code></pre>\n<p>i_zone æŒ‡å‘çš„æ˜¯æ•°æ®å®é™…å­˜å‚¨çš„æ•°æ®å—çš„ä½ç½®ã€‚</p>\n<p>ä½†æ˜¯ï¼Œä»…ä»…åªæœ‰ 9 ä¸ªæŒ‡é’ˆï¼Œæ¯ä¸ªæ•°æ®å—èƒ½å­˜å‚¨ 1024 B ï¼Œæ˜¯è¿œè¿œè¾¾ä¸åˆ°ä¹‹å‰æ‰€æè¿°çš„å•æ–‡ä»¶ <code>0x10081c00 = 268966912 B</code> çš„ä¸Šé™çš„ã€‚</p>\n<p>äº‹å®ä¸Šï¼Œminix åœ¨å®é™…å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼ŒæŠŠå‰7ä¸ªæŒ‡é’ˆä½œä¸ºç›´æ¥æ•°æ®å—æŒ‡é’ˆï¼Œæœ€å¤šå­˜å‚¨ 7168 B æ•°æ®ã€‚</p>\n<p>i_zone[7] è¡¨ç¤ºä¸€æ¬¡é—´æ¥æŒ‡é’ˆï¼ŒæŒ‡å‘æŸä¸€ä¸ªæ•°æ®å—ï¼Œä½†æ˜¯è¯¥æ•°æ®å—æ¯2å­—èŠ‚ä½œä¸ºä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘çœŸæ­£çš„æ•°æ®å—ã€‚</p>\n<p>i_zone[8] è¡¨ç¤ºäºŒæ¬¡é—´æ¥æŒ‡é’ˆã€‚</p>\n<p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fwnu3zrwuij310y0m6abj.jpg">\nCopied from Linux å†…æ ¸å®Œå…¨æ³¨é‡ŠV3.0</p>\n<p><strong>æ•°æ®å—</strong></p>\n<p>æœ€åï¼Œæˆ‘ä»¬çœ‹çœ‹æ•°æ®å—çš„å†…å®¹ï¼Œä¹Ÿå¸Œæœ›èƒ½å¤Ÿæ›´å¥½åœ°æ¥ç†è§£ Linux ç›®å½•å’Œæ–‡ä»¶çš„å¼‚åŒã€‚</p>\n<pre><code>00002800  01 00 2e 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002810  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002820  01 00 2e 2e 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002830  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n00002840  02 00 68 65 6c 6c 6f 2e  63 00 00 00 00 00 00 00  |..hello.c.......|\n00002850  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n*\n00002c00  23 69 6e 63 6c 75 64 65  20 3c 73 74 64 69 6f 2e  |#include &#x3C;stdio.|\n00002c10  68 3e 0a 00 00 00 00 00  00 00 00 00 00 00 00 00  |h>..............|\n00002c20  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\n</code></pre>\n<p>åœ¨ièŠ‚ç‚¹åŒºå—ä¸Šï¼Œæˆ‘ä»¬çœ‹åˆ°æœ‰1å·ièŠ‚ç‚¹å’Œ2å·ièŠ‚ç‚¹å·²ç»è¢«ä½¿ç”¨äº†ã€‚</p>\n<p>0x2800 ~ 0x2860 çš„ä½ç½®è¡¨ç¤ºçš„å°±æ˜¯ 1 å·ièŠ‚ç‚¹çš„æ•°æ®ã€‚äº‹å®ä¸Šè¿™æ˜¯ä¸€ä¸ªç›®å½•(å½“ç„¶ï¼Œæ€ä¹ˆåŒºåˆ†ç›®å½•è¿˜æ˜¯æ–‡ä»¶ï¼Œåœ¨ièŠ‚ç‚¹åŒºå—çš„ i_mode å­—æ®µå·²ç»æè¿°è¿‡äº†)</p>\n<p>å¯¹äºç›®å½•æ–‡ä»¶ï¼Œå½“ç„¶æ˜¯ç”¨æ¥è®°è½½ç›®å½•é¡¹çš„ï¼Œæ¯ä¸ªç›®å½•é¡¹å ç”¨ 32 å­—èŠ‚ã€‚</p>\n<blockquote>\n<p>è¿™é‡Œéœ€è¦è¿›è¡Œè¯´æ˜ï¼ŒMINIX 1.0 ç‰ˆæœ¬çš„æ–‡ä»¶ç³»ç»Ÿä¼¼ä¹æ˜¯å¯¹æ¯ä¸ªç›®å½•é¡¹å ç”¨ 16 å­—èŠ‚çš„ã€‚</p>\n<p>è¿™é‡Œæä¾›ä¸€ä¸ª Linux 0.11 ç‰ˆæœ¬çš„ä»¿çœŸè¿è¡Œç»“æœä»¥ä¾›è¯æ˜\n<img src="https://ws4.sinaimg.cn/large/006tNbRwly1fwnuexcwx7j30nw0c8745.jpg"></p>\n<p>ä¸Šé¢æè¿°çš„ <code>disk.img</code> æ˜¯åœ¨ Ubuntu 16.04 LTS ä¸‹è·‘å‡ºæ¥çš„ç»“æœï¼Œæ‰€æœ‰ç¡®å®å‡ºç°äº†ä¸€äº›å·®åˆ«ã€‚\nè‡³äºå…·ä½“çš„ä¸€ä¸ªè§„èŒƒï¼Œç›®å‰è¿˜æ²¡æœ‰æ‰¾åˆ°ï¼Œæ‰€æœ‰è¿™éƒ¨åˆ†åªèƒ½åšæ¨¡ç³Šå¤„ç†äº†ï¼Œå‹¿æ€ªã€‚</p>\n</blockquote>\n<p>å‰2ä¸ªå­—èŠ‚ç”¨æ¥è¡¨ç¤ºè¯¥ç›®å½•é¡¹æ‰€å¯¹åº”çš„ i èŠ‚ç‚¹ç¼–å·ã€‚ä¹‹åçš„30ä¸ªå­—èŠ‚ç”¨æ¥æè¿°è¯¥ç›®å½•é¡¹çš„åå­—ã€‚</p>\n<p>å› æ­¤ï¼Œå¯¹ 0x2800 ~ 0x2860 çš„æ•°æ®è¿›è¡Œé‡å»ºçš„ç»“æœå°±æ˜¯ <code>. .. hello.c</code> ä¸‰ä¸ªç›®å½•é¡¹äº†ã€‚å…¶ä¸­ï¼Œç”±äºæ˜¯æ ¹ç›®å½•ï¼Œ<code>.</code> å’Œ <code>..</code> æ‰€æŒ‡å‘çš„ièŠ‚ç‚¹çš„ç›¸åŒçš„ï¼Œéƒ½æ˜¯1å·ièŠ‚ç‚¹ã€‚</p>\n<p>è€Œ hello.c æ–‡ä»¶æŒ‡å‘çš„æ˜¯ 2 å·ièŠ‚ç‚¹ã€‚</p>\n<p>å“ˆå“ˆï¼Œ2å·ièŠ‚ç‚¹çš„æ•°æ®å†…å®¹å°±åœ¨ 0x2c00 å¼€å§‹çš„ä½ç½®ã€‚é€šè¿‡å³ä¾§çš„ ASCII ç»“æœæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ã€‚</p>\n<p>å½“ç„¶ï¼Œä¹‹å‰è¯´è¿‡æ¯ä¸ªæ•°æ®å—æ˜¯ 1024 B ï¼Œé‚£ä¹ˆæ•°æ®å—å¤šä½™çš„éƒ¨åˆ†ï¼Œå°±æ˜¯ç•™ç©ºå’¯ï¼Œè€Œä¸ä¼šè¢«å…¶å®ƒièŠ‚ç‚¹å ç”¨(é™¤éè¯¥æ–‡ä»¶orç›®å½•è¢«å®Œå…¨ç§»é™¤äº†)</p>\n<h2>å°ç»“</h2>\n<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæ–‡ä»¶ç³»ç»Ÿå®è§‚çš„æè¿°å°±å·²ç»å®Œç»“äº†ã€‚</p>\n<p>ä¸‹ä¸€èŠ‚å°†å¯¹æ“ä½œç³»ç»Ÿå¦‚ä½•ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæè¿°ã€‚</p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},IBPC:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>å·¥ç¨‹é¡¹ç›®ä¸­ï¼Œå®šä¹‰ API æ€»æ˜¯ä¸€ä¸ªæ…ä¹‹åˆæ…çš„æ“ä½œã€‚ä¸èƒ½å°‘ï¼Œä¸æ»¡è¶³è°ƒç”¨æ–¹çš„éœ€æ±‚å°±æƒ¨äº†ï¼›ä¹Ÿä¸èƒ½å¤šï¼Œä¸ç„¶å°±ä¹±å¥—äº†ï¼Œè‡ªå·±ç»´æŠ¤å›°éš¾ï¼Œè°ƒç”¨æ–¹ä¹Ÿå¼€å§‹äº†è‡ªæˆ‘å‘æŒ¥ã€‚è™½ç„¶è¶³å¤Ÿæ…é‡ï¼Œä½†ç»å¤§å¤šæ•°éƒ½é€ƒä¸è¿‡æœ€ç»ˆä¸å¾—ä¸â€œæ”¹â€ API çš„æƒ…å†µã€‚ä»Šå¤©è¦è®¨è®ºçš„æ˜¯åœ¨åŒä¸€ä¸ªç±»å†…åŒæ–¹æ³•åä¸åŒå‚æ•°ï¼ˆå…¥å‚/å‡ºå‚ï¼‰çš„æƒ…å†µã€‚</p>\n<p>æƒ³è¦åšåˆ°åŒæ–¹æ³•åä¸åŒå…¥å‚ï¼Œå¾ˆç®€å•ï¼Œå°±æ˜¯â€œé‡è½½ï¼ˆOverloadï¼‰â€ï¼Œæ—¥å¸¸éƒ½åœ¨ä½¿ç”¨ã€‚ä¸å†èµ˜è¿°ï¼</p>\n<p>æƒ³è¦åšåˆ°åŒæ–¹æ³•åä¸åŒå‡ºå‚ï¼Œç­”æ¡ˆå°±ä¸å†é‚£ä¹ˆè‚¯å®šäº†ã€‚å½“ç„¶ï¼Œå¦‚æœé—®æŠŠ<code>void add(int)</code> API æ”¹å†™æˆ <code>int add(int)</code>ï¼Œå¯èƒ½å¾—åˆ°çš„å¤§å¤šæ•°å›ç­”éƒ½æ˜¯å¯ä»¥ã€‚</p>\n<h2>çœ‹å±±æ˜¯å±±</h2>\n<p>é¦–å…ˆä¸¾ä¸€ä¸ªå…·ä½“ç‚¹çš„ä¾‹å­æ¥æè¿°ï¼ˆä¸ºäº†æ–¹ä¾¿ï¼Œå°±ä¸å®šä¹‰<code>CountService</code>çš„æ¥å£ç±»äº†ï¼‰</p>\n<pre><code class="language-java">package com.ffutop.signature;\n\n/**\n * ä¸»ç±»\n * @author fangfeng\n * @since 2019-02-26\n */\npublic class Main {\n\n    public static void main(String[] args) {\n        CountService countService = new CountService();\n        countService.add(1);\n        System.out.println(String.format("currentValue = %d", countService.getCurrentValue()));\n    }\n}\n</code></pre>\n<pre><code class="language-java">package com.ffutop.signature;\n\n/**\n * @author fangfeng\n * @since 2019-02-26\n */\npublic class CountService {\n\n    private int currentValue = 0;\n\n    /**\n     * è¯·æŠŠ add(int) ç†è§£æˆ API\n     * è™½ç„¶å·²ç»åšäº†å®ç°\n     */\n    public void add(int addend) {\n        currentValue += addend;\n    }\n\n    public int getCurrentValue() {\n        return currentValue;\n    }\n}\n</code></pre>\n<p>ç°åœ¨å·²ç»æœ‰ <code>void add(int)</code> æ–¹æ³•ï¼Œå®Œæˆçš„å·¥ä½œæ˜¯ç´¯åŠ ã€‚ç°åœ¨è¦æŠŠ API æ”¹æˆ <code>int add(int)</code>ï¼Œæ˜¯å¦å¯ä»¥å‘¢ï¼Ÿçœ‹ä¼¼æœ¬æ¥æ²¡æœ‰è¿”å›å€¼ï¼Œç°åœ¨åªæ˜¯åŠ ä¸Šä¸€ä¸ªè¿”å›å€¼ï¼Œå¯¹äºåŸæ¥çš„ä»£ç æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œè€Œæ–°ä»£ç åˆèƒ½æ‹¿åˆ°intç±»å‹çš„è¿”å›å€¼ï¼Œçš†å¤§æ¬¢å–œå•Šã€‚</p>\n<h2>çœ‹å±±ä¸æ˜¯å±±</h2>\n<p>å…ˆç»™å¤§å®¶æ‰§è¡Œä¸‹ä»£ç å§ï¼ï¼ˆè¯·ä¸¥æ ¼æŒ‰ç…§é¡ºåºï¼Œä¸”é¿å…ä½¿ç”¨IDEï¼Œå¦åˆ™å°†å¾—ä¸åˆ°é¢„æƒ³çš„ç»“æœï¼‰</p>\n<pre><code class="language-shell">$ # å‡†å¤‡å¥½ä¸¤ä¸ªç±»çš„ä»£ç ï¼ˆCountServiceçš„APIæ˜¯ `void add(int)`ï¼‰\n$ # ç¼–è¯‘Mainç±»\n$ javac com/ffutop/signature/Main.java\n$  \n$ # ä¿®æ”¹CountServiceçš„APIä¸º`int add(int)`\n$ # ç¼–è¯‘ CountService ç±»\n$ javac com/ffutop/signature/CountService.java\n$ \n$ # æ‰§è¡Œä¸»ç¨‹åº\n$ java com.ffutop.signature.Main\nException in thread "main" java.lang.NoSuchMethodError: com.ffutop.signature.CountService.add(I)V\n    at com.ffutop.signature.Main.main(Main.java:11)\n</code></pre>\n<p>å¾ˆé—æ†¾ï¼Œæ‰§è¡Œå¤±è´¥äº†ï¼ŒæŠ¥äº†ä¸ªErrorï¼ˆæ²¡æœ‰è¿™æ ·çš„æ–¹æ³•ï¼‰ã€‚æ–¹æ³•å†™çš„æ˜¯ <code>com.ffutop.signature.CountService.add(I)V</code> ã€‚ç®€å•çš„ç¿»è¯‘ä¸€ä¸‹å°±æ˜¯éœ€è¦<code>ç±»å+æ–¹æ³•å=x.y.CountService.add</code>ï¼Œä¸”å…¥å‚ä¸ºintï¼Œå‡ºå‚ä¸ºvoidçš„æ–¹æ³•ï¼ˆæƒ³äº†è§£æ›´å¤šè¯·ä¼˜å…ˆå­¦ä¹ <a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-4.html#jvms-4.4">Java ClassFile Format</a>ï¼‰ã€‚</p>\n<p>é‚£ä¹ˆï¼Œç°åœ¨å¾—åˆ°çš„ç»“è®ºæ˜¯ä¸è¡Œã€‚</p>\n<h2>çœ‹å±±è¿˜æ˜¯å±±</h2>\n<p>é‚£ä¹ˆï¼Œå°±ä¸€å®šä¸è¡Œå—ï¼Ÿéƒ½æ˜¯åŒåæ–¹æ³•ï¼Œä¸åŒå‚æ•°ã€‚å‡­ä»€ä¹ˆæ”¹ä¸ªå…¥å‚æ˜¯å¯ä»¥çš„ï¼Œæ”¹ä¸ªå‡ºå‚å°±ä¸è¡Œäº†ã€‚</p>\n<p>ä» Java çš„è§’åº¦æ¥è¯´ï¼Œä¸€å®šä¸è¡Œã€‚â€œåŒä¸€ç±»ä¸­ä¸èƒ½å­˜åœ¨ä¸¤ä¸ªåå­—åŠæè¿°ç¬¦å®Œå…¨ç›¸åŒçš„æ–¹æ³•â€</p>\n<p>ä½†æ˜¯ï¼Œå¦‚æœä» JVM çš„è§’åº¦æ¥è¯´ï¼Œå®Œå…¨æ˜¯å¯è¡Œçš„ã€‚â€œåœ¨classæ–‡ä»¶ä¸­ï¼Œä¸¤ä¸ªæ–¹æ³•å¯ä»¥æ‹¥æœ‰å®Œå…¨ç›¸åŒçš„ç‰¹å¾ç­¾åï¼Œå‰ææ˜¯è¿”å›å€¼ä¸èƒ½ç›¸åŒâ€</p>\n<p>ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“å»ºç«‹åœ¨ JVM ä¹‹ä¸Šçš„è¯­è¨€ä¸åªæœ‰ Javaã€‚åƒ Groovyã€Kotlin ç­‰è¯­è¨€éƒ½å®ç°äº†å„è‡ªçš„åŒºåˆ«äº Java ç‹¬æœ‰çš„ç‰¹å¾ã€‚è¿™äº›ç‰¹å¾çš„å®ç°éƒ½æ˜¯ä¾èµ–äº JVMï¼Œä½†ä¸ºä»€ä¹ˆ Java æ²¡æœ‰å‘¢ï¼Ÿåªèƒ½è¯´ Java è¯­è¨€çš„è§„èŒƒæ˜¯ JVM çš„å­é›†ï¼ˆå¥½åƒè¿™è¯æœ‰ç‚¹ä¸ä¸¥è°¨å•Šï¼‰</p>\n<p>é€šè¿‡ç›´æ¥æ“ä½œå­—èŠ‚ç ï¼Œå°±èƒ½å¤Ÿè¾¾åˆ°åœ¨åŒä¸€ä¸ªç±»ä¸­å»ºç«‹ä¸¤ä¸ªåŒåã€ç›¸åŒå…¥å‚ï¼Œä½†è¿”å›å€¼ä¸åŒçš„æ–¹æ³•ã€‚\nå…ˆé€šè¿‡<code>javap</code>å‘½ä»¤çœ‹çœ‹æœ€ç»ˆæä¾›çš„<code>CountService.class</code></p>\n<pre><code class="language-shell">$ javap com.ffutop.signature.CountService\npublic class com.ffutop.signature.CountService {\n  public int add(int);\n  public com.ffutop.signature.CountService();\n  public void add(int);\n  public int getCurrentValue();\n}\n</code></pre>\n<p>æœ‰ä¸¤ä¸ªåŒåçš„æ–¹æ³•<code>add(int)</code>ï¼Œè‡³äºæ‰§è¡Œï¼Œä¹Ÿä¼šç›¸å½“é¡ºåˆ©ã€‚</p>\n<p>è¿˜æ˜¯å†™ä¸ªç¨‹åºæ¥è¯´æ˜ï¼Œåœ¨åŸæœ‰ <code>Main.java</code> çš„åŸºç¡€ä¸Šï¼Œå†åˆ›å»ºä¸€ä¸ªå…¨é™å®šåä¸º <code>com.ffutop.signature.other.Main2</code> çš„ç±»</p>\n<pre><code class="language-java">package com.ffutop.signature.other;\nimport com.ffutop.signature.CountService;\n\n/**\n * @author fangfeng\n * @since 2019-02-27\n */\npublic class Main2 {\n\n    public static void main(String[] args) {\n        CountService countService = new CountService();\n        System.out.println(String.format("currentValue = %d", countService.add(1)));\n    }\n}\n</code></pre>\n<p>ä¸ Main.java æ¯”è¾ƒï¼Œå¾ˆæ˜æ˜¾çš„å°±æ˜¯ä¸€ä¸ªè°ƒç”¨äº† <code>CountService</code> çš„ <code>int add(int)</code> æ–¹æ³•ï¼Œè€Œå¦ä¸€ä¸ªè°ƒç”¨ <code>void add(int)</code> æ–¹æ³•ã€‚</p>\n<p>é‚£ä¹ˆæ˜¯å¦æœ‰æ•ˆå‘¢ï¼Ÿå…ˆæ¥éªŒè¯ä¸€ä¸‹ï¼ˆè¿™é‡Œè¦æ¨¡æ‹Ÿçš„ä¸€ä¸ªåœºæ™¯æ˜¯ï¼ŒCountService ç±»(åªæœ‰ <code>void add(int)</code> æ–¹æ³•)ä½œä¸ºäºŒæ–¹åº“C.jar version 1.0 çš„ä¸»è¦æœåŠ¡ç±»ã€‚CountService ç±»(åŒæ—¶æœ‰ <code>void add(int)</code> å’Œ <code>int add(int)</code> æ–¹æ³•)ä½œä¸ºäºŒæ–¹åº“C.jar version 2.0 çš„ä¸»è¦æœåŠ¡ç±»ã€‚Main ç±»æ ¹æ® C.jar version 1.0 åšçš„ç¼–è¯‘ï¼Œè€Œ Main2 ç±»æ ¹æ® C.jar version 2.0 åšçš„ç¼–è¯‘ã€‚åœ¨ Main å’Œ Main2 ç±»è¿è¡Œæ—¶åªæä¾› C.jar version 2.0ï¼‰</p>\n<pre><code class="language-shell">$ # ç¼–è¯‘ Main ç±»å’Œ CountService ç±»\n$ javac com/ffutop/signature/Main.java\n$\n$ # æ“ä½œ CountService.class å­—èŠ‚ç ï¼Œå¢åŠ æ–¹æ³• `int add(int)` \n$ # é€šè¿‡ ASM å®ç°ï¼Œè¯¦è§é™„å½•æºç  com/ffutop/signature/support/Generator.java\n$ \n$ # ç¼–è¯‘ Main2 ç±» (æä¾› classpathï¼Œå³æ ¹æ® CountService.class ç¼–è¯‘)\n$ javac com/ffutop/signature/other/Main2.java -classpath .\n$\n$ # éªŒè¯\n$ java com.ffutop.signature.Main\ncurrentValue = 1\n$ java com.ffutop.signature.other.Main2\ncurrentValue = 1\n$ # OKï¼ŒéªŒè¯é€šè¿‡\n</code></pre>\n<h2>æ€»ç»“</h2>\n<p>ä¸€æ—¦ API å®šä¹‰é”™è¯¯ï¼Œå¹¶å·²ç»ä½œä¸ºäºŒæ–¹åº“æä¾›ç»™è°ƒç”¨æ–¹ã€‚åæœå¿…ç„¶æ˜¯ç¾éš¾æ€§çš„ã€‚è‡³å°‘ï¼Œåªèƒ½é‡æ–°å®šä¹‰ API ã€‚å¦‚æœå¯¹äºå…¥å‚å®šä¹‰é”™è¯¯ï¼ŒJava è¯­è¨€çº§åˆ«ä¹Ÿèƒ½å¤Ÿæ”¯æŒã€‚ä½†å¦‚æœæ˜¯è¿”å›å€¼ï¼Œå¦‚æœéè¦ä¿æŒæ–¹æ³•åä¸€è‡´ï¼Œé‚£å°±ä¸å¾—ä¸ä¸‹æ²‰åˆ° JVM çº§åˆ«æ¥è¿›è¡Œå¤„ç†äº†ã€‚å½“ç„¶ï¼Œåœ¨å·¥ç¨‹é¡¹ç›®ä¸­æ˜¯å¦åº”è¯¥ç›´æ¥æ“ä½œå­—èŠ‚ç ï¼Ÿè‡³å°‘ä¸ªäººè¿˜æ²¡ç›´æ¥æ¥è§¦è¿‡ã€‚</p>\n<p>åšä¸ªè®°å½•ï¼Œæœªæ¥å¯ä»¥ç¿»ä¸€ç¿»ï¼Œè‡³å°‘æ˜¯ä¸€ç§å¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚</p>\n<p>Update: å¦‚æœç›´æ¥æ“ä½œå­—èŠ‚ç ä¸ºæ·»åŠ äº†ä¸åŒè¿”å›å€¼çš„åŒååŒå‚æ•°æ–¹æ³•ï¼Œå¯èƒ½å¼•èµ·è°ƒç”¨æ–¹é™æ€ç¼–è¯‘å¤±è´¥ã€‚æ­¤æ“ä½œéœ€æ…ä¹‹åˆæ…ã€‚ä¹Ÿè®¸æä¾›ç±»åŠ è½½å™¨åŠ è½½æ—¶çš„å­—èŠ‚ç æ“ä½œèƒ½æ›´åŠ å®Œç¾åœ°è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>\n<h2>å‚è€ƒ</h2>\n<p><a href="https://raw.githubusercontent.com/DorMOUSE-None/Repo/master/signature.zip">æºç .zip</a></p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},KZDG:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<blockquote>\n<p>æœ¬æ–‡æè¿°çš„ ASM æŒ‡çš„æ˜¯ OW2 ASM</p>\n</blockquote>\n<h2>ASM-Core çš„ç»“æ„</h2>\n<p><em>é¦–å…ˆæ˜¯ä¸€äº›æ¦‚è¿°æ€§çš„å†…å®¹ã€‚</em></p>\n<p>ç”±äº ASM æ“ä½œçš„ JAVA å­—èŠ‚ç æœ‰ä¸¥æ ¼çš„æ ¼å¼è§„å®šï¼Œä¸”å³ä½¿éšç€ JVM æ ‡å‡†çš„å‡çº§ä¹Ÿæå°‘å‡ºç°é‡å¤§è°ƒæ•´ã€‚\nå› æ­¤é€‚ç”¨é¢ç‹­çª„çš„è®¿é—®è€…æ¨¡å¼åœ¨è¯¥é¡¹ç›®ä¸­è¢«å¤§é‡åœ°ä½¿ç”¨ï¼Œå¹¶ä¸”å·²ç»åˆ°äº†ä¸§å¿ƒç—…ç‹‚çš„ç¨‹åº¦:)</p>\n<p>ä»æ ¸å¿ƒåŒ…å£°æ˜çš„ç±»æ¥çœ‹ï¼Œä¸»è¦åŒ…æ‹¬:</p>\n<ol>\n<li>\n<p>ClassReader - ä½œä¸ºç»“æ„åŒ–å¯¹è±¡ï¼Œå°†æ¥æ”¶(accept)è®¿é—®è€…çš„è®¿é—®</p>\n</li>\n<li>\n<p>å‡ ç§è®¿é—®è€…æŠ½è±¡ç±»ä»¥åŠç›¸åº”çš„å®ç°ç±»</p>\n</li>\n</ol>\n<ul>\n<li>AnnotationVisitor -> AnnotationWriter</li>\n<li>ClassVisitor -> ClassWriter</li>\n<li>FieldVisitor -> FieldWriter</li>\n<li>MethodVisitor -> MethodWriter</li>\n<li>ModuleVisitor -> ModuleWriter</li>\n</ul>\n<ol start="3">\n<li>\n<p>Opcodes &#x26; Constants - ClassFile ä¸­æè¿°çš„å¤§é‡å¸¸é‡ç¬¦å·ä¸å€¼</p>\n</li>\n<li>\n<p>å…¶å®ƒä¸€äº›è¾…åŠ©çš„ç±»</p>\n</li>\n</ol>\n<ul>\n<li>Attribute - ç”¨äºå¤„ç†éæ ‡å‡†åŒ–çš„å±æ€§(ClassFile å…è®¸<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html">JVMS</a> ä¸­æœªå®šä¹‰çš„ Attribute)</li>\n<li>ByteArray - åŠ¨æ€å¯è‡ªé€‚åº”çš„ byte[] (å­—èŠ‚æ•°ç»„)</li>\n<li>Context - ClassReader åœ¨è¢«è§£æ(è¢«è®¿é—®)è¿‡ç¨‹ä¸­ç”¨äºè¡¨ç¤ºâ€œç´¯ç§¯çŠ¶æ€â€çš„ä¸€ä¸ªç±»/å¯¹è±¡</li>\n<li>Symbol - ç”¨äºè¡¨ç¤º ClassFile ä¸­æè¿°çš„ Constant çš„åŸºç±»</li>\n<li>SymbolTable - ç”¨äºå­˜å‚¨å¸¸é‡æ± å¯¹è±¡</li>\n<li>å…¶å®ƒå†…å®¹çœç•¥</li>\n</ul>\n<h2>ClassFile æ–‡ä»¶æ ¼å¼</h2>\n<p>æœ¬èŠ‚çš„å†…å®¹å¯ä»¥å‚é˜… <a href="https://dormouse-none.github.io/2018-06-11-ASM-ClassReader/">ClassFile æ–‡ä»¶æ ¼å¼</a></p>\n<p>ClassFile æ˜¯ ASM æ“ä½œå­—èŠ‚ç çš„åŸºç¡€ä¸å‰æã€‚åœ¨ JVMS å®šä¹‰äº† .class æ–‡ä»¶æ ¼å¼ä¹‹åï¼ŒASM æ‰åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œäº†å¯¹ ClassFile çš„å­—èŠ‚ç æ“ä½œã€‚</p>\n<p>å› æ­¤ï¼Œæ— è®ºå¦‚ä½•ï¼Œä¸ªäººè®¤ä¸ºåœ¨çœŸæ­£å¼€å§‹äº†è§£ ASM ä¹‹å‰ï¼Œé€šè¯»ä¸€é ClassFile æ–‡ä»¶æ ¼å¼æ˜¯å®Œå…¨æœ‰å¿…è¦çš„ã€‚å¹¶ä¸”ï¼Œåœ¨åŸºæœ¬äº†è§£ ClassFile å†…å®¹çš„åŸºç¡€ä¸Šï¼Œ\nå°è¯•å¯¹æŸä¸ª .class æ–‡ä»¶è¿›è¡Œæ‰‹å·¥è§£æä¹Ÿä¸å¤±ä¸ºä¸€ç§åŠ æ·±ç†è§£çš„é€”å¾„ã€‚</p>\n<h2>Visitor Pattern</h2>\n<p>ç”±äº ASM çš„å®ç°é‡‡ç”¨äº†åé—¨çš„è®¿é—®è€…æ¨¡å¼ã€‚å› æ­¤ï¼Œäº†è§£è®¿é—®è€…æ¨¡å¼ä¹Ÿæ˜¯ä¸€ä¸ªå¿…ä¸å¯å°‘çš„é‡è¦ç¯èŠ‚ã€‚åŒæ—¶åœ¨äº†è§£åä¹Ÿå°†ä¸ºæºç é˜…è¯»è€…æä¾›æ›´æ¸…æ™°çš„è§£è¯»æ€è·¯ã€‚</p>\n<p>ã€Šè®¾è®¡æ¨¡å¼ï¼šå¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€ã€‹ä¸€ä¹¦çš„â€œ5.11 VISITOR(è®¿é—®è€…)â€”â€”å¯¹è±¡è¡Œä¸ºå‹æ¨¡å¼â€æä¾›äº†å¾ˆè¯¦å°½çš„è§£é‡Šã€‚</p>\n<p>æœ¬äººå¯¹è¿™æ–¹é¢çš„ä¸ç”šäº†è§£ï¼Œæ¨èè‡ªè¡ŒæŸ¥æ‰¾èµ„æ–™ã€‚</p>\n<h2>ClassReader</h2>\n<p>ClassReader æ˜¯è§£æç°æœ‰çš„ .class æ–‡ä»¶çš„åŸºæœ¬å·¥å…·ã€‚åŒæ—¶ï¼ŒClassReader ä¹Ÿä½œä¸ºä¸€ä¸ªå†…å®¹çš„æŒæœ‰è€…ï¼Œä¸ SymboleTable é…åˆï¼Œæ¥æ»¡è¶³è®¿é—®è€…åŸºæœ¬çš„è®¿é—®éœ€æ±‚ã€‚</p>\n<p>åˆ¨é™¤å¤§é‡çš„å†…éƒ¨ç§æœ‰æ–¹æ³•ï¼ŒClassReader å¯¹å¤–å¼€æ”¾çš„æ¥å£ç›¸å½“ç®€å•ã€‚æœ€æ ¸å¿ƒçš„æ–¹æ³•ä»…åŒ…æ‹¬ ClassReader(...) ä»¥åŠ accetp(...)</p>\n<h3>ClassReader(...) æ„é€ æ–¹æ³•</h3>\n<p>é¡¾åæ€ä¹‰ï¼Œæ„é€ æ–¹æ³•ç”¨äºå®ä¾‹åŒ– ClassReader å¯¹è±¡ï¼ŒåŒ…æ‹¬ä¸€äº›å¿…é¡»çš„å˜é‡çš„åˆå§‹åŒ–ã€‚</p>\n<p>åœ¨æ„é€ å‡½æ•°ä¸­å®Œæˆçš„åˆå§‹åŒ–å†…å®¹åŒ…æ‹¬:</p>\n<ul>\n<li>æ ¡éªŒç‰ˆæœ¬å·</li>\n<li>å­˜å‚¨æ¯ä¸ªå¸¸é‡æ± é¡¹ç›®çš„èµ·å§‹åç§»é‡ cpInfoOffsets</li>\n<li>å­˜å‚¨æ¯ä¸ªå¼•å¯¼æ–¹æ³•çš„èµ·å§‹åç§»é‡ bootstrapMethodOffsets</li>\n<li>å­˜å‚¨æœ€é•¿å­—ç¬¦ä¸²å¸¸é‡çš„å¤§å° maxStringLength</li>\n</ul>\n<pre><code class="language-java">  ClassReader(final byte[] classFileBuffer, final int classFileOffset, final boolean checkClassVersion) {\n    this.b = classFileBuffer;   // .class æ–‡ä»¶ç¼“å­˜\n    // æ£€æŸ¥ä¸»ç‰ˆæœ¬å·, ç¬¬6,7ä¸ªå­—èŠ‚(ä»0å­—èŠ‚å¼€å§‹è®¡æ•°)\n    if (checkClassVersion &#x26;&#x26; readShort(classFileOffset + 6) > Opcodes.V11) {\n      throw new IllegalArgumentException(\n          "Unsupported class file major version " + readShort(classFileOffset + 6));\n    }\n    // åˆ›å»ºå¸¸é‡æ± æ•°ç»„ï¼Œå¸¸é‡æ± é•¿åº¦çš„å®šä¹‰ constant_pool_count åœ¨ç¬¬8,9å­—èŠ‚\n    int constantPoolCount = readUnsignedShort(classFileOffset + 8);     // è¯»å–æ— ç¬¦å·short, å³è¯»å–è¿ç»­ä¸¤å­—èŠ‚ä½œä¸ºä¸€ä¸ªshortå€¼\n    cpInfoOffsets = new int[constantPoolCount];                         // æ¯ä¸ªå¸¸é‡çš„åç§»ä½ç½®\n    cpInfoValues = new Object[constantPoolCount];                       // æ¯ä¸ªå¸¸é‡çš„å®ä¾‹å¯¹è±¡\n    int currentCpInfoIndex = 1;\n    int currentCpInfoOffset = classFileOffset + 10;\n    int currentMaxStringLength = 0;                                     // æœ€é•¿å­—ç¬¦ä¸²å¸¸é‡\n    while (currentCpInfoIndex &#x3C; constantPoolCount) {\n      cpInfoOffsets[currentCpInfoIndex++] = currentCpInfoOffset + 1;\n      int cpInfoSize;\n      switch (classFileBuffer[currentCpInfoOffset]) {\n        case Symbol.CONSTANT_FIELDREF_TAG:\n        case Symbol.CONSTANT_METHODREF_TAG:\n        case Symbol.CONSTANT_INTERFACE_METHODREF_TAG:\n        case Symbol.CONSTANT_INTEGER_TAG:\n        case Symbol.CONSTANT_FLOAT_TAG:\n        case Symbol.CONSTANT_NAME_AND_TYPE_TAG:\n        case Symbol.CONSTANT_INVOKE_DYNAMIC_TAG:\n        case Symbol.CONSTANT_DYNAMIC_TAG:\n          cpInfoSize = 5;\n          break;\n        case Symbol.CONSTANT_LONG_TAG:\n        case Symbol.CONSTANT_DOUBLE_TAG:\n          cpInfoSize = 9;\n          currentCpInfoIndex++;\n          break;\n        case Symbol.CONSTANT_UTF8_TAG:\n          cpInfoSize = 3 + readUnsignedShort(currentCpInfoOffset + 1);\n          if (cpInfoSize > currentMaxStringLength) {\n            // The size in bytes of this CONSTANT_Utf8 structure provides a conservative estimate\n            // of the length in characters of the corresponding string, and is much cheaper to\n            // compute than this exact length.\n            currentMaxStringLength = cpInfoSize;\n          }\n          break;\n        case Symbol.CONSTANT_METHOD_HANDLE_TAG:\n          cpInfoSize = 4;\n          break;\n        case Symbol.CONSTANT_CLASS_TAG:\n        case Symbol.CONSTANT_STRING_TAG:\n        case Symbol.CONSTANT_METHOD_TYPE_TAG:\n        case Symbol.CONSTANT_PACKAGE_TAG:\n        case Symbol.CONSTANT_MODULE_TAG:\n          cpInfoSize = 3;\n          break;\n        default:\n          throw new IllegalArgumentException();\n      }\n      currentCpInfoOffset += cpInfoSize;\n    }\n    this.maxStringLength = currentMaxStringLength;\n    // The Classfile\'s access_flags field is just after the last constant pool entry.\n    this.header = currentCpInfoOffset;\n\n    // è¯»å– BootstrapMethods å±æ€§(å¦‚æœå­˜åœ¨)\n    int currentAttributeOffset = getFirstAttributeOffset();\n    int[] currentBootstrapMethodOffsets = null;\n    for (int i = readUnsignedShort(currentAttributeOffset - 2); i > 0; --i) {\n      // è¯»å–æ¯ä¸ª attribute_info çš„å±æ€§åå’Œå±æ€§é•¿åº¦\n      String attributeName = readUTF8(currentAttributeOffset, new char[maxStringLength]);\n      int attributeLength = readInt(currentAttributeOffset + 2);\n      currentAttributeOffset += 6;\n      // å¦‚æœå½“å‰å±æ€§åä¸º BootstrapMethods ï¼Œåˆ™è¿›å…¥å¤„ç†é€»è¾‘\n      if (Constants.BOOTSTRAP_METHODS.equals(attributeName)) {\n        // Read the num_bootstrap_methods field and create an array of this size.\n        currentBootstrapMethodOffsets = new int[readUnsignedShort(currentAttributeOffset)];\n        // Compute and store the offset of each \'bootstrap_methods\' array field entry.\n        int currentBootstrapMethodOffset = currentAttributeOffset + 2;\n        for (int j = 0; j &#x3C; currentBootstrapMethodOffsets.length; ++j) {\n          currentBootstrapMethodOffsets[j] = currentBootstrapMethodOffset;\n          // Skip the bootstrap_method_ref and num_bootstrap_arguments fields (2 bytes each),\n          // as well as the bootstrap_arguments array field (of size num_bootstrap_arguments * 2).\n          currentBootstrapMethodOffset +=\n              4 + readUnsignedShort(currentBootstrapMethodOffset + 2) * 2;\n        }\n      }\n      currentAttributeOffset += attributeLength;\n    }\n    this.bootstrapMethodOffsets = currentBootstrapMethodOffsets;\n  }\n</code></pre>\n<p>åˆ°æ­¤ä¸ºæ­¢ï¼ŒClassReader å·²ç»è§£æäº†åŒ…æ‹¬ magic, minor version, major version, constant pool ã€‚\nä½†æ˜¯ï¼Œè¯¸å¦‚ field_info, method_info, attribute_info ç­‰ä»ç„¶æ²¡æœ‰å¾—åˆ°å¤„ç†ã€‚</p>\n<h3>accept(...)</h3>\n<p>è®¿é—®è€…æ¨¡å¼çš„æ ¸å¿ƒæ“ä½œå°±æ˜¯ç»“æ„åŒ–å¯¹è±¡æ¥å—(accept)è®¿é—®è€…å¯¹è±¡å®ä¾‹çš„è®¿é—®ï¼Œå¹¶å°†ç»“æ„åŒ–å†…å®¹å®Œå…¨æš´éœ²ç»™è®¿é—®è€…ã€‚</p>\n<p>ä»æŠ½è±¡çš„æ–¹æ³•è§’åº¦çœ‹ï¼Œå¯ä»¥ç†è§£æˆ:</p>\n<pre><code class="language-java">  // --- ç»“æ„åŒ–å¯¹è±¡çš„ accept() æ–¹æ³• ---\n  public void accept(Visitor visitor) {\n    visitor.visit(this);\n  }\n\n  // --- è®¿é—®è€…å¯¹è±¡çš„ visit() æ–¹æ³• ---\n  public Xxx visit(Element element) {\n    // è‹¥å¹²å…³äº element çš„è¯»æ“ä½œ + å…¶å®ƒæ“ä½œ\n  }\n</code></pre>\n<pre><code class="language-java">public void accept(\n      final ClassVisitor classVisitor,\n      final Attribute[] attributePrototypes,\n      final int parsingOptions) {\n    // å®šä¹‰ Context ä½œä¸ºè¾…åŠ©ç±»ï¼Œæš‚å­˜è¢«è®¿é—®è¿‡ç¨‹çš„â€œç´¯ç§¯çŠ¶æ€â€\n    Context context = new Context();\n    context.attributePrototypes = attributePrototypes;\n    /**\n     * è§£æé€‰é¡¹: \n     * 1. SKIP_CODE - ä¸è§£æ CODE å±æ€§ \n     * 2. SKIP_DEBUG - ä¸è§£æ DEBUG ç›¸å…³çš„å±æ€§(ä¾‹å¦‚SourceFile, SourceDebugExtension, LocalVariableTable, LocalVariableTypeTable, LineNumberTable)\n     * 4. SKIP_FRAMES - è·³è¿‡å¯¹ StackMap å’Œ StackMapTable å±æ€§çš„è§£æ\n     * ...\n     */\n    context.parsingOptions = parsingOptions;\n    // ä»å¸¸é‡æ± è¯»å–å¸¸é‡æ‰€ä½¿ç”¨çš„ç¼“å†²æ•°å­—\n    context.charBuffer = new char[maxStringLength];\n\n    // Read the access_flags, this_class, super_class, interface_count and interfaces fields.\n    // è§£æè®¿é—®æ§åˆ¶, å½“å‰ç±», çˆ¶ç±», æ¥å£æ•°é‡ä¸æ¥å£å€¼ç­‰\n    char[] charBuffer = context.charBuffer;\n    int currentOffset = header;\n    int accessFlags = readUnsignedShort(currentOffset);\n    String thisClass = readClass(currentOffset + 2, charBuffer);\n    String superClass = readClass(currentOffset + 4, charBuffer);\n    String[] interfaces = new String[readUnsignedShort(currentOffset + 6)];\n    currentOffset += 8;\n    for (int i = 0; i &#x3C; interfaces.length; ++i) {\n      interfaces[i] = readClass(currentOffset, charBuffer);\n      currentOffset += 2;\n    }\n\n    // Read the class attributes (the variables are ordered as in Section 4.7 of the JVMS).\n    // Attribute offsets exclude the attribute_name_index and attribute_length fields.\n    // - The offset of the InnerClasses attribute, or 0.\n    int innerClassesOffset = 0;\n    // - The offset of the EnclosingMethod attribute, or 0.\n    int enclosingMethodOffset = 0;\n    // - The string corresponding to the Signature attribute, or null.\n    String signature = null;\n    // - The string corresponding to the SourceFile attribute, or null.\n    String sourceFile = null;\n    // - The string corresponding to the SourceDebugExtension attribute, or null.\n    String sourceDebugExtension = null;\n    // - The offset of the RuntimeVisibleAnnotations attribute, or 0.\n    int runtimeVisibleAnnotationsOffset = 0;\n    // - The offset of the RuntimeInvisibleAnnotations attribute, or 0.\n    int runtimeInvisibleAnnotationsOffset = 0;\n    // - The offset of the RuntimeVisibleTypeAnnotations attribute, or 0.\n    int runtimeVisibleTypeAnnotationsOffset = 0;\n    // - The offset of the RuntimeInvisibleTypeAnnotations attribute, or 0.\n    int runtimeInvisibleTypeAnnotationsOffset = 0;\n    // - The offset of the Module attribute, or 0.\n    int moduleOffset = 0;\n    // - The offset of the ModulePackages attribute, or 0.\n    int modulePackagesOffset = 0;\n    // - The string corresponding to the ModuleMainClass attribute, or null.\n    String moduleMainClass = null;\n    // - The string corresponding to the NestHost attribute, or null.\n    String nestHostClass = null;\n    // - The offset of the NestMembers attribute, or 0.\n    int nestMembersOffset = 0;\n    // - The non standard attributes (linked with their {@link Attribute#nextAttribute} field).\n    //   This list in the &#x3C;i>reverse order&#x3C;/i> or their order in the ClassFile structure.\n    Attribute attributes = null;\n\n    // è§£æ Class æŒæœ‰çš„å±æ€§\n    int currentAttributeOffset = getFirstAttributeOffset();\n    for (int i = readUnsignedShort(currentAttributeOffset - 2); i > 0; --i) {\n      // Read the attribute_info\'s attribute_name and attribute_length fields.\n      String attributeName = readUTF8(currentAttributeOffset, charBuffer);\n      int attributeLength = readInt(currentAttributeOffset + 2);\n      currentAttributeOffset += 6;\n      // The tests are sorted in decreasing frequency order (based on frequencies observed on\n      // typical classes).\n      if (Constants.SOURCE_FILE.equals(attributeName)) {\n        sourceFile = readUTF8(currentAttributeOffset, charBuffer);\n      } else if (Constants.INNER_CLASSES.equals(attributeName)) {\n        innerClassesOffset = currentAttributeOffset;\n      } else if (Constants.ENCLOSING_METHOD.equals(attributeName)) {\n        enclosingMethodOffset = currentAttributeOffset;\n      } else if (Constants.NEST_HOST.equals(attributeName)) {\n        nestHostClass = readClass(currentAttributeOffset, charBuffer);\n      } else if (Constants.NEST_MEMBERS.equals(attributeName)) {\n        nestMembersOffset = currentAttributeOffset;\n      } else if (Constants.SIGNATURE.equals(attributeName)) {\n        signature = readUTF8(currentAttributeOffset, charBuffer);\n      } else if (Constants.RUNTIME_VISIBLE_ANNOTATIONS.equals(attributeName)) {\n        runtimeVisibleAnnotationsOffset = currentAttributeOffset;\n      } else if (Constants.RUNTIME_VISIBLE_TYPE_ANNOTATIONS.equals(attributeName)) {\n        runtimeVisibleTypeAnnotationsOffset = currentAttributeOffset;\n      } else if (Constants.DEPRECATED.equals(attributeName)) {\n        accessFlags |= Opcodes.ACC_DEPRECATED;\n      } else if (Constants.SYNTHETIC.equals(attributeName)) {\n        accessFlags |= Opcodes.ACC_SYNTHETIC;\n      } else if (Constants.SOURCE_DEBUG_EXTENSION.equals(attributeName)) {\n        sourceDebugExtension =\n            readUTF(currentAttributeOffset, attributeLength, new char[attributeLength]);\n      } else if (Constants.RUNTIME_INVISIBLE_ANNOTATIONS.equals(attributeName)) {\n        runtimeInvisibleAnnotationsOffset = currentAttributeOffset;\n      } else if (Constants.RUNTIME_INVISIBLE_TYPE_ANNOTATIONS.equals(attributeName)) {\n        runtimeInvisibleTypeAnnotationsOffset = currentAttributeOffset;\n      } else if (Constants.MODULE.equals(attributeName)) {\n        moduleOffset = currentAttributeOffset;\n      } else if (Constants.MODULE_MAIN_CLASS.equals(attributeName)) {\n        moduleMainClass = readClass(currentAttributeOffset, charBuffer);\n      } else if (Constants.MODULE_PACKAGES.equals(attributeName)) {\n        modulePackagesOffset = currentAttributeOffset;\n      } else if (Constants.BOOTSTRAP_METHODS.equals(attributeName)) {\n        // This attribute is read in the constructor.\n      } else {\n        Attribute attribute =\n            readAttribute(\n                attributePrototypes,\n                attributeName,\n                currentAttributeOffset,\n                attributeLength,\n                charBuffer,\n                -1,\n                null);\n        attribute.nextAttribute = attributes;\n        attributes = attribute;\n      }\n      currentAttributeOffset += attributeLength;\n    }\n\n    // ç¬¬ä¸€ä¸ª .visit() ã€‚è®© ClassVisitor çš„å®ç°ç±»å¤„ç†å½“å‰ç±»çš„ç‰ˆæœ¬å·, è®¿é—®æ§åˆ¶æ ‡å¿—, å½“å‰ç±», ç»“æ„, çˆ¶ç±», æ¥å£\n    // å…·ä½“ visit() ç”±å®ç°ç±»éšæ„å®šåˆ¶ã€‚ä¾‹å¦‚ï¼Œé’ˆå¯¹äºé‚£äº›æœ‰æ‰“å°åŠŸèƒ½çš„è®¿é—®è€…å®ç°ç±»ï¼Œç›´æ¥æ‰“å°ä¹Ÿä¸å¤±ä¸ºä¸€ç§æœ‰æ•ˆçš„è®¿é—®æ“ä½œ\n    // Visit the class declaration. The minor_version and major_version fields start 6 bytes before\n    // the first constant pool entry, which itself starts at cpInfoOffsets[1] - 1 (by definition).\n    classVisitor.visit(\n        readInt(cpInfoOffsets[1] - 7), accessFlags, thisClass, signature, superClass, interfaces);\n\n    // è®¿é—® SourceFile å’Œ SourceDebugExtenstion å±æ€§\n    // Visit the SourceFile and SourceDebugExtenstion attributes.\n    if ((parsingOptions &#x26; SKIP_DEBUG) == 0\n        &#x26;&#x26; (sourceFile != null || sourceDebugExtension != null)) {\n      classVisitor.visitSource(sourceFile, sourceDebugExtension);\n    }\n\n    // Visit the Module, ModulePackages and ModuleMainClass attributes.\n    if (moduleOffset != 0) {\n      readModule(classVisitor, context, moduleOffset, modulePackagesOffset, moduleMainClass);\n    }\n\n    // Visit the NestHost attribute.\n    if (nestHostClass != null) {\n      classVisitor.visitNestHostExperimental(nestHostClass);\n    }\n\n    // Visit the EnclosingMethod attribute.\n    if (enclosingMethodOffset != 0) {\n      String className = readClass(enclosingMethodOffset, charBuffer);\n      int methodIndex = readUnsignedShort(enclosingMethodOffset + 2);\n      String name = methodIndex == 0 ? null : readUTF8(cpInfoOffsets[methodIndex], charBuffer);\n      String type = methodIndex == 0 ? null : readUTF8(cpInfoOffsets[methodIndex] + 2, charBuffer);\n      classVisitor.visitOuterClass(className, name, type);\n    }\n\n    // Visit the RuntimeVisibleAnnotations attribute.\n    if (runtimeVisibleAnnotationsOffset != 0) {\n      int numAnnotations = readUnsignedShort(runtimeVisibleAnnotationsOffset);\n      int currentAnnotationOffset = runtimeVisibleAnnotationsOffset + 2;\n      while (numAnnotations-- > 0) {\n        // Parse the type_index field.\n        String annotationDescriptor = readUTF8(currentAnnotationOffset, charBuffer);\n        currentAnnotationOffset += 2;\n        // Parse num_element_value_pairs and element_value_pairs and visit these values.\n        currentAnnotationOffset =\n            readElementValues(\n                classVisitor.visitAnnotation(annotationDescriptor, /* visible = */ true),\n                currentAnnotationOffset,\n                /* named = */ true,\n                charBuffer);\n      }\n    }\n\n    // Visit the RuntimeInvisibleAnnotations attribute.\n    if (runtimeInvisibleAnnotationsOffset != 0) {\n      int numAnnotations = readUnsignedShort(runtimeInvisibleAnnotationsOffset);\n      int currentAnnotationOffset = runtimeInvisibleAnnotationsOffset + 2;\n      while (numAnnotations-- > 0) {\n        // Parse the type_index field.\n        String annotationDescriptor = readUTF8(currentAnnotationOffset, charBuffer);\n        currentAnnotationOffset += 2;\n        // Parse num_element_value_pairs and element_value_pairs and visit these values.\n        currentAnnotationOffset =\n            readElementValues(\n                classVisitor.visitAnnotation(annotationDescriptor, /* visible = */ false),\n                currentAnnotationOffset,\n                /* named = */ true,\n                charBuffer);\n      }\n    }\n\n    // Visit the RuntimeVisibleTypeAnnotations attribute.\n    if (runtimeVisibleTypeAnnotationsOffset != 0) {\n      int numAnnotations = readUnsignedShort(runtimeVisibleTypeAnnotationsOffset);\n      int currentAnnotationOffset = runtimeVisibleTypeAnnotationsOffset + 2;\n      while (numAnnotations-- > 0) {\n        // Parse the target_type, target_info and target_path fields.\n        currentAnnotationOffset = readTypeAnnotationTarget(context, currentAnnotationOffset);\n        // Parse the type_index field.\n        String annotationDescriptor = readUTF8(currentAnnotationOffset, charBuffer);\n        currentAnnotationOffset += 2;\n        // Parse num_element_value_pairs and element_value_pairs and visit these values.\n        currentAnnotationOffset =\n            readElementValues(\n                classVisitor.visitTypeAnnotation(\n                    context.currentTypeAnnotationTarget,\n                    context.currentTypeAnnotationTargetPath,\n                    annotationDescriptor,\n                    /* visible = */ true),\n                currentAnnotationOffset,\n                /* named = */ true,\n                charBuffer);\n      }\n    }\n\n    // Visit the RuntimeInvisibleTypeAnnotations attribute.\n    if (runtimeInvisibleTypeAnnotationsOffset != 0) {\n      int numAnnotations = readUnsignedShort(runtimeInvisibleTypeAnnotationsOffset);\n      int currentAnnotationOffset = runtimeInvisibleTypeAnnotationsOffset + 2;\n      while (numAnnotations-- > 0) {\n        // Parse the target_type, target_info and target_path fields.\n        currentAnnotationOffset = readTypeAnnotationTarget(context, currentAnnotationOffset);\n        // Parse the type_index field.\n        String annotationDescriptor = readUTF8(currentAnnotationOffset, charBuffer);\n        currentAnnotationOffset += 2;\n        // Parse num_element_value_pairs and element_value_pairs and visit these values.\n        currentAnnotationOffset =\n            readElementValues(\n                classVisitor.visitTypeAnnotation(\n                    context.currentTypeAnnotationTarget,\n                    context.currentTypeAnnotationTargetPath,\n                    annotationDescriptor,\n                    /* visible = */ false),\n                currentAnnotationOffset,\n                /* named = */ true,\n                charBuffer);\n      }\n    }\n\n    // è®¿é—®éæ ‡å‡†çš„å±æ€§\n    // Visit the non standard attributes.\n    while (attributes != null) {\n      // Copy and reset the nextAttribute field so that it can also be used in ClassWriter.\n      Attribute nextAttribute = attributes.nextAttribute;\n      attributes.nextAttribute = null;\n      classVisitor.visitAttribute(attributes);\n      attributes = nextAttribute;\n    }\n\n    // Visit the NestedMembers attribute.\n    if (nestMembersOffset != 0) {\n      int numberOfNestMembers = readUnsignedShort(nestMembersOffset);\n      int currentNestMemberOffset = nestMembersOffset + 2;\n      while (numberOfNestMembers-- > 0) {\n        classVisitor.visitNestMemberExperimental(readClass(currentNestMemberOffset, charBuffer));\n        currentNestMemberOffset += 2;\n      }\n    }\n\n    // Visit the InnerClasses attribute.\n    if (innerClassesOffset != 0) {\n      int numberOfClasses = readUnsignedShort(innerClassesOffset);\n      int currentClassesOffset = innerClassesOffset + 2;\n      while (numberOfClasses-- > 0) {\n        classVisitor.visitInnerClass(\n            readClass(currentClassesOffset, charBuffer),\n            readClass(currentClassesOffset + 2, charBuffer),\n            readUTF8(currentClassesOffset + 4, charBuffer),\n            readUnsignedShort(currentClassesOffset + 6));\n        currentClassesOffset += 8;\n      }\n    }\n\n    // è®¿é—®å­—æ®µå’Œæ–¹æ³•\n    // Visit the fields and methods.\n    int fieldsCount = readUnsignedShort(currentOffset);\n    currentOffset += 2;\n    while (fieldsCount-- > 0) {\n      currentOffset = readField(classVisitor, context, currentOffset);\n    }\n    int methodsCount = readUnsignedShort(currentOffset);\n    currentOffset += 2;\n    while (methodsCount-- > 0) {\n      currentOffset = readMethod(classVisitor, context, currentOffset);\n    }\n\n    // Visit the end of the class.\n    classVisitor.visitEnd();\n  }\n</code></pre>\n<h3>å°ç»“</h3>\n<p>å…¶å®ï¼Œå°†æ•´ä¸ª ClassReader ç†è§£æˆä¸€ä¸ªå¯¹ .class å­—èŠ‚æ–‡ä»¶çš„è§£æå™¨ä¸å¤±ä¸ºä¸€ç§å¯è¡Œçš„è®¤çŸ¥ã€‚</p>\n<ol>\n<li>åœ¨æ„é€ æ–¹æ³•ä¸­å®Œæˆå¯¹ .class æ–‡ä»¶ minor_version, major_version çš„ç¡®è®¤ã€‚</li>\n<li>ç»§è€Œå®Œæˆå¯¹æ•´ä¸ª Constants_pool çš„è§£æ</li>\n<li>ä»¥åŠ BootstarpMethod å±æ€§çš„å®šä½</li>\n<li>ä¹‹ååœ¨ accept(...) æ–¹æ³•ä¸­é€ä¸€è°ƒç”¨ç›¸åº”çš„è®¿é—®è€…å®ç°ç±»å®ç°å¯¹ä¸åŒå†…å®¹çš„è®¿é—®ã€‚</li>\n</ol>\n<p>ä½†æ˜¯ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼ŒClassReader ç»å¯¹ä¸ä¼šæ¶‰åŠåˆ°å¯¹å…¶è§£æçš„ .class æ–‡ä»¶å†…å®¹çš„å†™æ“ä½œã€‚\næ‰€æœ‰çš„å†™æ“ä½œéƒ½åŸºäºä¸åŒçš„ç›®çš„ï¼Œåœ¨ ClassVisitor ä¸­å®ç°ã€‚</p>\n<h2>ClassVisitor</h2>\n<p>Java .class çš„è®¿é—®è€…ï¼ŒæŒ‰ç…§ä¸¥æ ¼çš„é¡ºåºè§„èŒƒé€ä¸€è°ƒç”¨ </p>\n<p>visit\n[ visitSource ] [ visitModule ][ visitNestHost ][ visitOuterClass ]\n( visitAnnotation | visitTypeAnnotation | visitAttribute )<em>\n( visitNestMember | visitInnerClass | visitField | visitMethod )</em>\nvisitEnd.</p>\n<p>å„ä¸ª visitXXX æ–¹æ³•</p>\n<pre><code class="language-java">public abstract class ClassVisitor {\n\n  /**\n   * è®¿é—®ç±»çš„é¦–éƒ¨\n      */\n    public void visit(final int version, final int access, final String name, final String signature, final String superName, final String[] interfaces) {}\n\n  /**\n   * è®¿é—®ç±»çš„æºæ–‡ä»¶åç­‰\n      */\n    public void visitSource(final String source, final String debug) {}\n\n  /**\n   * è®¿é—®ä¸ç±»å…³è”çš„æ¨¡å—\n      */\n    public ModuleVisitor visitModule(final String name, final int access, final String version) {}\n\n  public void visitOuterClass(final String owner, final String name, final String descriptor) {}\n\n  public AnnotationVisitor visitAnnotation(final String descriptor, final boolean visible) {}\n\n  public AnnotationVisitor visitTypeAnnotation(\n      final int typeRef, final TypePath typePath, final String descriptor, final boolean visible) {}\n\n  public void visitAttribute(final Attribute attribute) {}\n\n  public void visitInnerClass(\n      final String name, final String outerName, final String innerName, final int access) {}\n\n  /**\n   * è®¿é—®ç±»çš„å˜é‡\n      */\n    public FieldVisitor visitField(\n      final int access,\n      final String name,\n      final String descriptor,\n      final String signature,\n      final Object value) {}\n\n  /**\n   * è®¿é—®ç±»çš„æ–¹æ³•\n      */\n    public MethodVisitor visitMethod(\n      final int access,\n      final String name,\n      final String descriptor,\n      final String signature,\n      final String[] exceptions) {}\n\n  public void visitEnd() {}\n}\n</code></pre>\n<p>éšç€ visitXxx() æ–¹æ³•çš„é€ä¸€æ‰§è¡Œï¼ŒClassVisitor å°†å¯¹å½“å‰çš„ .class æ–‡ä»¶è¶Šæ¥è¶Šç†Ÿæ‚‰ï¼Œå¹¶é€æ¸è¡¥å…¨å¸¸é‡æ± (ç”± SymbolTable æŒæœ‰å¹¶ç»´æŠ¤)</p>\n<h2>æ€»ç»“</h2>\n<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œå¯¹æ•´ä¸ª ClassReader &#x26; ClassVisitor å°†æœ‰ä¸€ä¸ªåŸºç¡€è€Œç®€å•çš„å°è±¡ã€‚</p>\n<p>ClassReader é€šè¿‡å¯¹ .class æ–‡ä»¶å­—èŠ‚ç çš„è§£æè€Œè·å¾—å¯¹è¿™ä¸ªç±»çš„å…·ä½“å°è±¡(æ›´å¤šçš„åå‘æ˜¯éšæ„è®¿é—® .class çš„å„ç§ç»†èŠ‚)ã€‚</p>\n<p>ClassVisitor é€šè¿‡ visitXxx(...) æ–¹æ³•ï¼Œç”±å…¶å®ƒå¯¹è±¡(å¯ä»¥æ˜¯ ClassReader, ä¹Ÿå¯ä»¥ç›´æ¥æ˜¯ Coder)é€æ¸å¯¹å…¶å¼€æ”¾ä¸€äº› .class çš„ç»†èŠ‚ï¼Œ\nä½†éœ€è¦ ClassVisitor è‡ªè¡Œç»´æŠ¤è·å¾—çš„å†…å®¹(å¦‚æœæœ‰å¿…è¦çš„è¯)ã€‚ç”±æ­¤å¾—åˆ°å¯¹ .class å…¨éƒ¨å†…å®¹çš„äº†è§£(å½“ç„¶ï¼Œå¦‚æœæœ¬èº« visitXxx() å¾—åˆ°çš„å†…å®¹ä¸å…¨ï¼Œåˆ™äº†è§£çš„è‡ªç„¶æœ‰é™)ã€‚</p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},LRZv:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:"<h2>æ¦‚è¿°</h2>\n<blockquote>\n<p>åœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸­ï¼Œéƒ½æˆ–å¤šæˆ–å°‘éœ€è¦è®¤è¯æˆæƒæ¨¡å‹/ç³»ç»Ÿçš„æ”¯æŒã€‚</p>\n</blockquote>\n<p>è®¤è¯/æˆæƒæ˜¯ä»€ä¹ˆï¼Ÿæœ€ç®€å•çš„ï¼Œæˆ‘ä»¬çš„ç³»ç»Ÿè¦æ±‚ç”¨æˆ·å¿…é¡»åœ¨â€œç™»å½•â€ä¹‹åæ‰å…è®¸è¿›è¡Œä¸€äº›æ“ä½œã€‚â€œç™»å½•â€çš„è¿‡ç¨‹å°±æ˜¯è®¤è¯ï¼›è€ŒåŒºåˆ«ä¸æœªç™»å½•çŠ¶æ€ï¼Œåªå…è®¸ç™»å½•ç”¨æˆ·è¿›è¡Œä¸€äº›æ“ä½œï¼Œè¿™å°±æ˜¯æˆæƒã€‚è®¤è¯ä¸æˆæƒç›¸äº’ç‹¬ç«‹ï¼Œæœ‰ååŒé…åˆï¼Œå…±åŒæ”¯æ’‘èµ·ç³»ç»Ÿå¯¹å®‰å…¨çš„åŸºæœ¬è¦æ±‚ã€‚</p>\n<h2>è®¤è¯ä¸æˆæƒ</h2>\n<p>è®¤è¯çš„ç›®çš„åœ¨äºè®¤å‡ºç”¨æˆ·ã€‚æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è§†è§‰ã€å£°éŸ³ç­‰å› ç´ è®¤å‡ºä¸€ä¸ªäººã€‚ä½†æ˜¯å°±ç½‘ç»œåº”ç”¨è€Œè¨€ï¼Œåº”ç”¨æœ€å¤šåªèƒ½å¤Ÿè®¤è¯†åˆ°å‘èµ·è¯·æ±‚çš„æµè§ˆå™¨ã€æ‰‹æœºAPPã€ç‰©è”ç½‘è®¾å¤‡ç­‰ç”¨æˆ·ä»£ç†(User Agent)ï¼Œä¹Ÿæ— æ³•ç›´æ¥åœ°å°†ç”¨æˆ·ä¸ç”¨æˆ·ä»£ç†è¿›è¡Œç»‘å®šã€‚å› æ­¤ï¼Œå‘åº”ç”¨è¯æ˜æ“ä½œè¿™äº›ç”¨æˆ·ä»£ç†çš„å®ä½“å°±æˆäº†è‡³å…³é‡è¦çš„æ­¥éª¤ã€‚ä½ éœ€è¦é€šè¿‡å¯†ç ã€æ‰‹æœºéªŒè¯ç ã€äººè„¸è¯†åˆ«æˆ–å…¶å®ƒå½¢å¼å‡­è¯æ¥å®Œæˆâ€œç™»å½•â€æ“ä½œï¼Œå³è®¤è¯ã€‚</p>\n<p>å½“ç„¶äº†ï¼Œæˆ‘ä»¬ä¹Ÿè®¤è¯†åˆ°ï¼Œä¸æ˜¯æ‰€æœ‰çš„æ“ä½œéƒ½éœ€è¦ä¸€ä¸ªè¿™èˆ¬å¤åˆ¶â€œç™»å½•â€æµç¨‹çš„ï¼Œå³ä½¿è¿™äº›æ“ä½œé€»è¾‘ä¸Šä¹Ÿéœ€è¦è®¤å‡ºèƒŒåçš„ç”¨æˆ·æ˜¯è°ã€‚è¿™éƒ¨åˆ†æ‰€ä½¿ç”¨åˆ°çš„æŠ€æœ¯å°±æ˜¯â€œä¼šè¯ç®¡ç†â€äº†ã€‚åœ¨ä¸€å®šçš„æœ‰æ•ˆæœŸèŒƒå›´å†…ï¼Œç”¨æˆ·æ— éœ€é‡å¤è¯æ˜è‡ªå·±çš„èº«ä»½ï¼Œè€Œç”¨æˆ·-åº”ç”¨é—´ä¿æŒæœ€åŸºæœ¬çš„ä¿¡ä»»ã€‚å½“ç„¶ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¿®æ”¹å¯†ç ç­‰å±é™©æ“ä½œè¿˜æ˜¯éœ€è¦å†æ¬¡è¿›è¡Œè®¤è¯ã€‚</p>\n<p>æ€»è€Œè¨€ä¹‹ï¼Œæ— è®ºæ˜¯â€œç™»å½•â€è®¤è¯æŠ‘æˆ–æ˜¯â€œä¼šè¯â€è®¤è¯ï¼Œå…¶ç›®çš„éƒ½æ˜¯ä¸ºäº†è®¤å‡ºç”¨æˆ·ã€‚</p>\n<p>å®Œæˆè®¤è¯ä¹‹åï¼Œå°±è¦å¯ç”¨æˆæƒäº†ã€‚æˆæƒè´Ÿè´£çš„æ˜¯æ§åˆ¶ç”¨æˆ·èƒ½å¹²ä»€ä¹ˆã€‚ç®¡ç†å‘˜å’Œæ™®é€šå‘˜å·¥æ‰€èƒ½è¿›è¡Œçš„æ“ä½œè‚¯å®šæ˜¯æœ‰æ‰€å·®åˆ«çš„ã€‚å€ŸåŠ©äºå‰ç½®è®¤è¯æä¾›ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œæˆæƒå°†å¯¹ç”¨æˆ·çš„æ“ä½œè¿›è¡Œå†³æ–­ã€‚</p>\n<h2>è®¿é—®æ§åˆ¶ï¼ˆæƒé™æ§åˆ¶ï¼‰</h2>\n<p>æˆæƒæ—¨åœ¨ç•Œå®šç”¨æˆ·èƒ½å¤Ÿè¿›è¡Œå“ªäº›æ“ä½œï¼Œè€Œè®¿é—®æ§åˆ¶æ­£æ˜¯è¿›è¡Œæˆæƒç•Œå®šçš„æªæ–½ã€æ‰‹æ®µã€‚è¯¥å¦‚ä½•å®æ–½è®¿é—®æ§åˆ¶å‘¢ï¼Ÿçœ‹äººä¸‹èœæ˜¯æœ€ç®€å•ã€æœ€å®¹æ˜“è¢«æ¥å—çš„æ–¹å¼â€”â€”ä¸ºæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹åœ°åˆ†é…æƒé™ã€‚ä½†æ˜¯ï¼Œå°±Webåº”ç”¨è€Œè¨€ï¼Œå¦‚æ­¤è¡Œäº‹çš„ä»£ä»·å°†æ˜¯åŠå…¶å·¨å¤§çš„ã€‚åŠ¨è¾„å‡ åä¸‡ã€ä¸Šç™¾ä¸‡...çš„ç”¨æˆ·é‡ï¼Œåˆå¦‚ä½•ç»´æŠ¤å¾—èµ·è¿™èˆ¬ç»†è‡´çš„æ§åˆ¶å‘¢ã€‚è€Œä¸”ï¼Œæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹è®¾ç½®æƒé™ï¼ŒåŒæ—¶ä¹Ÿæ„å‘³ç€æ¯ä¸ªæƒé™éœ€è¦ç›´æ¥å¯¹æ¥ç™¾åä¸‡çš„ç”¨æˆ·ã€‚</p>\n<p>æ’‡å¼€å¯è¡Œæ€§ï¼Œè®¿é—®æ§åˆ¶åšçš„å°±æ˜¯è¿™ç§æ´»è®¡â€”â€”æ§åˆ¶ä¸»ä½“ï¼ˆç”¨æˆ·ï¼‰å¯¹å®¢ä½“ï¼ˆç³»ç»Ÿã€APIç­‰ï¼‰çš„æ“ä½œã€‚</p>\n<p>ä¸»è¦çš„è®¿é—®æ§åˆ¶æŠ€æœ¯åˆ†ä¸ºä¸‰ç±»ï¼šè‡ªä¸»è®¿é—®æ§åˆ¶ã€å¼ºåˆ¶è®¿é—®æ§åˆ¶ã€åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶</p>\n<h3>è‡ªä¸»è®¿é—®æ§åˆ¶(Discretionary Access Controlï¼ŒDAC)</h3>\n<ul>\n<li>æ¯ä¸ªå®¢ä½“éƒ½ç‹¬ç«‹ç»´æŠ¤ä¸€å¼ è®¿é—®æ§åˆ¶è¡¨(Access Control List, ACL)</li>\n<li>æ¯ä¸ªå®¢ä½“éƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…</li>\n<li>æ‰€æœ‰è€…å¯ä»¥å°†å…¶è´Ÿè´£çš„å®¢ä½“è®¿é—®æƒé™åˆ†é…ç»™å…¶å®ƒç”¨æˆ·</li>\n<li>æ¯æ¬¡ä¸»ä½“å¯¹å®¢ä½“çš„è®¿é—®éƒ½é¢å‘ACLåšç¡®è®¤åæ‰§è¡Œ</li>\n<li>å¼ºä¾èµ–äºæ‰€æœ‰è€…å¯¹å®‰å…¨è¦æ±‚çš„è®¤çŸ¥</li>\n</ul>\n<h3>å¼ºåˆ¶è®¿é—®æ§åˆ¶(Mandatory Access Control, MAC)</h3>\n<ul>\n<li>é¢„ç½®ç›¸åº”çš„å¯†çº§ï¼Œä¾‹å¦‚ç»å¯†çº§ã€æœºå¯†çº§å’Œæ™®é€šçº§ã€‚å¯†çº§æœ‰å¼ºå¼±å…³ç³»</li>\n<li>æ¯ä¸ªä¸»ä½“/å®¢ä½“éƒ½åˆ†é…ä¸€ä¸ªå¯†çº§</li>\n<li>æ¯æ¬¡ä¸»ä½“å¯¹å®¢ä½“çš„æ“ä½œï¼Œåˆ¤å®šä¸»ä½“å¯†çº§ >= å®¢ä½“å¯†çº§å³å…è®¸è®¿é—®</li>\n</ul>\n<h3>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(Role-Based Access Control, RBAC)</h3>\n<ul>\n<li>è§’è‰²ä½œä¸ºä¸€ç³»åˆ—æœ‰è¾ƒå¼ºç›¸å…³æ€§æƒé™çš„æŒæœ‰è€…</li>\n<li>ç”¨æˆ·é€šè¿‡è¢«åˆ†é…ä¸€ç³»åˆ—è§’è‰²ï¼Œä»è€Œé—´æ¥åœ°æ‹¥æœ‰æƒé™é›†</li>\n</ul>\n<p><em>ä¸€èˆ¬æ¥è¯´ï¼ŒDACã€MACéƒ½ä¸å¤ªé€‚åˆäºWebåº”ç”¨çš„è®¿é—®æ§åˆ¶ã€‚å› æ­¤ï¼Œåç»­çš„è®¨è®ºéƒ½å°†åŸºäºRBACè¿›è¡Œã€‚</em></p>\n<h2>æ§åˆ¶ç²’åº¦</h2>\n<p>å¦‚ä½•å®šä¹‰ä¸€ä¸ªå®¢ä½“ï¼Œå°±æ¶‰åŠåˆ°æ§åˆ¶ç²’åº¦äº†ã€‚å°±Webåº”ç”¨è€Œè¨€ï¼Œæ¯”è¾ƒç²—ç•¥çš„æœ‰æ•°æ®ç²’åº¦ã€æ–¹æ³•ç²’åº¦ã€URLç²’åº¦ã€ç³»ç»Ÿç²’åº¦ç­‰ç­‰ã€‚ä»»æ„ç²’åº¦ï¼Œéƒ½å¯ä»¥ä½œä¸ºè®¿é—®æ§åˆ¶çš„ç»„æˆéƒ¨åˆ†ï¼Œä½œä¸ºæˆæƒçš„ä¸€éƒ¨åˆ†ã€‚ä½†æ˜¯ï¼Œç²’åº¦çš„æ§åˆ¶ä¹Ÿä¼šå¯¼è‡´ä¸€äº›ç›¸å½“è‡´å‘½çš„é—®é¢˜ã€‚</p>\n<p>è¶Šæƒé—®é¢˜å°±æ˜¯ä¸€ç§ç²’åº¦æ§åˆ¶ä¸‹çš„é—®é¢˜ã€‚</p>\n<p><strong>çºµå‘è®¿é—®æ§åˆ¶</strong></p>\n<p>é¡¾åæ€ä¹‰ï¼Œçºµå‘è®¿é—®æ§åˆ¶æ‰€æ§åˆ¶çš„æƒé™æ‹¥æœ‰ä¸€å®šçš„ä¼˜å…ˆçº§æ¦‚å¿µï¼Œä¾‹å¦‚ç®¡ç†å‘˜æ“ä½œä¸æ™®é€šç”¨æˆ·æ“ä½œã€‚ç‰¹åˆ«é€‚åˆäºä½¿ç”¨å¼ºåˆ¶è®¿é—®æ§åˆ¶çš„è§£å†³æ–¹æ¡ˆï¼Œä½¿ç”¨RBACä¹Ÿå¹¶ä¸å›°éš¾ï¼ŒåŸºæœ¬ä¸Šåªè¦å®šä¹‰ä¸¤ç±»è§’è‰²ä¹Ÿèƒ½è§£å†³ã€‚ä¸šå†…å¯¹äºè¿™ç±»é—®é¢˜çš„è§£å†³æ–¹æ¡ˆç›¸å½“æˆç†Ÿï¼Œéœ€è¦çš„åªæ˜¯æ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœºæ™¯è¿›è¡Œé€‚é…ã€‚</p>\n<p><strong>æ¨ªå‘è®¿é—®æ§åˆ¶</strong></p>\n<p>å¯¹äºæ¨ªå‘è®¿é—®æ§åˆ¶ï¼Œé—®é¢˜å°±ä¸å†é‚£ä¹ˆçš„ç®€å•ã€‚åœ¨æ–¹æ³•ç²’åº¦ä¸‹çš„RBACæ¨¡å‹ï¼Œå¾ˆå®¹æ˜“å°±ä¼šå¯¼è‡´Aç”¨æˆ·äº‹å®ä¸Šè®¿é—®äº†Bç”¨æˆ·æ•°æ®çš„é—®é¢˜å‘ç”Ÿï¼Œä¹Ÿå°±æ˜¯æ¨ªå‘è¶Šæƒã€‚è€Œæƒ³è¦å®ç°æ•°æ®ç²’åº¦çš„é€šç”¨æ¨¡å‹ï¼Œå´åˆä¸å¯é¿å…åœ°å°†å¯¹ä¸šåŠ¡ä»£ç è¿›è¡Œä¾µå…¥ã€‚</p>\n<p>æ§åˆ¶ç²’åº¦çš„å–èˆï¼Œå°±å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºWebåº”ç”¨çš„å®é™…éœ€æ±‚ã€‚</p>\n<h2>å°ç»“</h2>\n<p>è®¤è¯ã€æˆæƒçš„åŸºæœ¬ç›®çš„åœ¨äºæ»¡è¶³å¯¹å®‰å…¨çš„åŸºæœ¬è¦æ±‚ï¼Œå…¶æ¶‰åŠçš„çŸ¥è¯†ç›¸å½“å¹¿æ³›ã€‚æœ¬ç¯‡çš„ç›®çš„ï¼Œä»…ä»…åœ¨äºé˜é‡Šè®¤è¯ã€æˆæƒä¸¤ä¸ªæœ¯è¯­çš„åŸºæœ¬å®šä¹‰ï¼Œå¹¶å¯¹è®¿é—®æ§åˆ¶æŠ€æœ¯åšæ¦‚è¦å¼çš„ä»‹ç»ã€‚</p>\n<pre><code class=\"language-plain\">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>"}},MDTK:function(n,e,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/post",function(){var n=t("EhLH");return{page:n.default||n}}])},NctQ:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<h2>Java ClassFile æ–‡ä»¶æ ¼å¼</h2>\n<p>è¯»äº†å°†è¿‘ä¸€å‘¨çš„æ—¶é—´ï¼Œå‹‰å¼ºç®—æ˜¯æŠŠ ClassFile çš„æ–‡ä»¶æ ¼å¼ç»™ç®€å•çš„æ¢³ç†äº†ä¸ªè„‰ç»œã€‚\n<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html">The class File Format(Java SE 8)</a> </p>\n<blockquote>\n<p>u1, u2, u4 åˆ†åˆ«è¡¨ç¤ºæ— ç¬¦å·çš„ä¸€å­—èŠ‚ã€äºŒå­—èŠ‚ã€å››å­—èŠ‚æ•°æ®(ä»¥å¤§ç«¯å­˜å‚¨)</p>\n</blockquote>\n<pre><code class="language-c++">ClassFile {\n    u4             magic;                                   // é­”æ•°(magic) å›ºå®šä¸º 0xCAFEBABE\n    u2             minor_version;                           // æ¬¡ç‰ˆæœ¬å·\n    u2             major_version;                           // ä¸»ç‰ˆæœ¬å·\n    u2             constant_pool_count;                     // å¸¸é‡æ±  constant_pool çš„æ•°é‡ + 1, æœ€å¤§ä¸º (2&#x3C;&#x3C;16 - 1) = 65535\n    cp_info        constant_pool[constant_pool_count-1];    // å¸¸é‡æ±  å–å€¼ä¸‹æ ‡ä¸º [1, constant_pool_count)\n    u2             access_flags;                            // å¯¹ç±» or æ¥å£çš„è®¿é—®æƒé™å’Œå±æ€§çš„æ ‡å¿—çš„æ©ç \n    u2             this_class;                              // å€¼ä¸º constant_pool çš„æœ‰æ•ˆä¸‹æ ‡(ä¸” constant_pool[this_class] çš„ç±»å‹ä¸º CONSTANT_Class_info)\n    u2             super_class;                             // å€¼ä¸º 0 æˆ–è€… constant_pool çš„æœ‰æ•ˆä¸‹æ ‡(åŒä¸Š), å¦‚æœæ˜¯ interface, åˆ™è¯¥å€¼ä¸€å®šä¸ºæœ‰æ•ˆä¸‹æ ‡\n    u2             interfaces_count;                        // ç›´æ¥çˆ¶æ¥å£çš„æ•°é‡\n    u2             interfaces[interfaces_count];            // å€¼å¿…é¡»æ˜¯ constant_pool çš„æœ‰æ•ˆä¸‹æ ‡, ä¸” interfaces[i](0â‰¤i&#x3C;interfaces_count), æŒ‡å‘çš„ç±»å‹ä¸º CONSTANT_Class_info)\n    u2             fields_count;                            // å­—æ®µæ•°é‡, ç»Ÿè®¡æ‰€æœ‰å­—æ®µ, åŒ…æ‹¬ class variables(é™æ€å˜é‡) å’Œ instance variables(å®ä¾‹å˜é‡)\n    field_info     fields[fields_count];                    // å­—æ®µçš„è¯¦ç»†å£°æ˜, ä¸åŒ…å«ç»§æ‰¿æ¥çš„å­—æ®µ\n    u2             methods_count;                           // æ–¹æ³•æ•°é‡\n    method_info    methods[methods_count];                  // æ–¹æ³•çš„è¯¦ç»†å£°æ˜, ä¸åŒ…æ‹¬ç»§æ‰¿æ¥çš„æ–¹æ³•\n    u2             attributes_count;                        // å±æ€§æ•°é‡\n    attribute_info attributes[attributes_count];            // å±æ€§çš„è¯¦ç»†å£°æ˜\n}\n</code></pre>\n<p>é€šè¿‡ <code>javac Xxx.java</code> å‘½ä»¤å¾—åˆ°çš„ <code>Xxx.class</code> æ–‡ä»¶ä¸¥æ ¼æŒ‰ç…§å®šä¹‰çš„ ClassFile æ–‡ä»¶æ ¼å¼ä»¥8æ¯”ç‰¹çš„å­—èŠ‚ä¸ºå•ä½è¿›è¡Œå­˜å‚¨ã€‚</p>\n<p><strong>ä¸‹é¢çš„ä¾‹å­éƒ½å°†é€šè¿‡ Trie.java (å®é™…ä»£ç è§æœ¬æ–‡æœ€å) ä»¥åŠå…¶ç»ç¼–è¯‘åçš„æ–‡ä»¶ Trie.class åšåŸºæœ¬çš„ä»‹ç»ã€‚</strong></p>\n<h3>magic, minor_verion &#x26; major_version</h3>\n<p>é€šè¿‡å‘½ä»¤ <code>xxd Trie.class</code> æŸ¥çœ‹ Trie.class çš„åå…­è¿›åˆ¶ç¼–ç ï¼Œå‰16å­—èŠ‚çš„å†…å®¹å¦‚ä¸‹:</p>\n<pre><code class="language-text">00000000: cafe babe 0000 0034 008f 0a00 2400 4b09  .......4....$.K.\n</code></pre>\n<p>å¯ä»¥çœ‹åˆ°å‰4å­—èŠ‚çš„å†…å®¹ <code>0xcafebabe</code>ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ï¼Œä½†æ˜¯ä½œä¸ºå…¶æ˜¯èƒ½å¦è¢«JVM(Java Virtual Machine, Javaè™šæ‹Ÿæœº)æ¥æ”¶çš„Classæ–‡ä»¶çš„ä¸€ä¸ªæ ¡éªŒã€‚</p>\n<p>ç´§æ¥ç€çš„4ä¸ªå­—èŠ‚åŒ…æ‹¬<code>æ¬¡ç‰ˆæœ¬å·</code> å’Œ <code>ä¸»ç‰ˆæœ¬å·</code>ï¼Œæš‚æ—¶ä¸åšæ·±å…¥ã€‚</p>\n<h3>å¸¸é‡æ±  constant_pool</h3>\n<p>ä»ç¬¬10ä¸ªå­—èŠ‚å¼€å§‹(ä»ç¬¬0å­—èŠ‚å¼€å§‹è®¡æ•°)ï¼Œè¿ç»­çš„ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºå¸¸é‡æ± ä¸­å„ç§ CONSTANT çš„æ€»ä¸ªæ•°+1 (constant_pool_count)ã€‚constant_pool_count åªæœ‰2å­—èŠ‚ä¹Ÿå°±æ„å‘³ç€: å¸¸é‡æ± çš„æœ€å¤§å¸¸é‡æ•°é‡ä¸º (2&#x3C;&#x3C;16 - 1) = 65535 (å½“ç„¶ï¼Œè²Œä¼¼åœ¨è¿™ä¸ªé‡çº§ä¸Šï¼Œä¹Ÿä»æ²¡è§è¿‡æœ‰è°èƒ½å¤Ÿç»´æŠ¤è¿™æ ·ä¸€ä¸ªå¤§JAVAç±»æ–‡ä»¶äº†)ã€‚</p>\n<p>å¯ä»¥çœ‹åˆ° constant_pool_count çš„å†…å®¹ä¸º <code>0x008f = 143</code> ï¼Œå³å¯¹äºå¸¸é‡æ± çš„å£°æ˜å¯ä»¥è®¤ä¸ºæ˜¯ <code>cp_info constant_pool[142]</code></p>\n<pre><code class="language-text">cp_info {\n    u1 tag;\n    u1 info[]; \n}\n</code></pre>\n<p>åˆ©ç”¨ JDK è‡ªå¸¦çš„ <code>javap</code> æ¥æŸ¥çœ‹ <code>Trie.class</code> æ–‡ä»¶(<code>javap -v Trie.class</code>)ï¼Œå¯ä»¥å¯¹ cp_info çš„æ ¼å¼æœ‰ä¸€ä¸ªç²—æµ…ä½†å½¢è±¡åŒ–çš„è®¤è¯†(ç»“æœè§<strong>é™„å½•2</strong>)\nå…¶ä¸­ç¬¬ä¸€åˆ—çš„å†…å®¹ <code>#? = ?</code> <code>#?</code>è¡¨ç¤ºidï¼Œ<code>= ?</code>è¡¨ç¤ºä¸€ä¸ª cp_info çš„å®é™…ç±»å‹ï¼Œæœ‰ <code>cp_info.tag</code> æŒ‡å®šï¼Œå…·ä½“æ˜ å°„è¡¨ä¸º</p>\n<table>\n<thead>\n<tr>\n<th>Constant Type</th>\n<th>Value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>CONSTANT_Class</code></td>\n<td>7</td>\n</tr>\n<tr>\n<td><code>CONSTANT_Fieldref</code></td>\n<td>9</td>\n</tr>\n<tr>\n<td><code>CONSTANT_Methodref</code></td>\n<td>10</td>\n</tr>\n<tr>\n<td><code>CONSTANT_InterfaceMethodref</code></td>\n<td>11</td>\n</tr>\n<tr>\n<td><code>CONSTANT_String</code></td>\n<td>8</td>\n</tr>\n<tr>\n<td><code>CONSTANT_Integer</code></td>\n<td>3</td>\n</tr>\n<tr>\n<td><code>CONSTANT_Float</code></td>\n<td>4</td>\n</tr>\n<tr>\n<td><code>CONSTANT_Long</code></td>\n<td>5</td>\n</tr>\n<tr>\n<td><code>CONSTANT_Double</code></td>\n<td>6</td>\n</tr>\n<tr>\n<td><code>CONSTANT_NameAndType</code></td>\n<td>12</td>\n</tr>\n<tr>\n<td><code>CONSTANT_Utf8</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td><code>CONSTANT_MethodHandle</code></td>\n<td>15</td>\n</tr>\n<tr>\n<td><code>CONSTANT_MethodType</code></td>\n<td>16</td>\n</tr>\n<tr>\n<td><code>CONSTANT_InvokeDynamic</code></td>\n<td>18</td>\n</tr>\n<tr>\n<td><code>CONSTANT_Module</code></td>\n<td>19</td>\n</tr>\n<tr>\n<td><code>CONSTANT_Package</code></td>\n<td>20</td>\n</tr>\n</tbody>\n</table>\n<p>åœ¨ Java ClassFile çš„æ ¼å¼å®šä¹‰ä¸­ï¼ŒåŒæ—¶å®šä¹‰äº†æ¯ç§ <code>CONSTANT</code> çš„é•¿åº¦ä¸æ ¼å¼ã€‚\nä¾‹å¦‚:</p>\n<pre><code class="language-c++">CONSTANT_Class_info {\n    u1 tag;\n    u2 name_index;\n}\n</code></pre>\n<pre><code class="language-c++">CONSTANT_Fieldref_info {\n     u1 tag;\n     u2 class_index;\n     u2 name_and_type_index;\n}\nCONSTANT_Methodref_info {\n  u1 tag;\n  u2 class_index;\n  u2 name_and_type_index;\n}\n</code></pre>\n<p>æ›´å¤šçš„ <code>CONSTANT_XXX</code> çš„æ ¼å¼å®šä¹‰è§ <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.4">ClassFile CONSTANT_XXX ç»“æ„</a></p>\n<p>ç®€å•è§£æä¸€ä¸‹ cp_info[1]ã€‚</p>\n<pre><code class="language-text">00000000: cafe babe 0000 0034 008f 0a00 2400 4b09  .......4....$.K.\n\n#1 = Methodref          #36.#75       // java/lang/Object."&#x3C;init>":()V\n</code></pre>\n<p><code>cp_info[1].tag = 0x0a = 10</code>ï¼Œå³ cp_info[1] çš„ç±»å‹ä¸º Methodref ã€‚\nä¹‹åå°±ç›´æ¥å¥—ç”¨ <code>CONSTANT_Methodref_info</code> çš„æ•°æ®ç»“æ„å®šä¹‰çš„æ ¼å¼\n<code>cp_info[1].class_index = 0x0024 = 36</code>ï¼Œå³ cp_info[1].class_index è¡¨ç¤ºçš„ç±»åæŒ‡å‘å¸¸é‡æ± ç¬¬ 36 ä¸ªå…ƒç´ è¡¨ç¤ºçš„ç±»\n<code>cp_info[1].name_and_type_index = 0x004b = 75</code>ã€‚è¡¨ç¤ºæŒ‡å‘çš„æ˜¯å¸¸é‡æ± ç¬¬ 75 ä¸ªå…ƒç´ è¡¨ç¤ºçš„ NameAndType ç»“æ„</p>\n<p>å¯¹äºè¿™éƒ¨åˆ†å†…å®¹çš„ç†è§£ï¼Œå¦‚æœè§‰å¾—æœ‰èƒ½å¤Ÿé˜…è¯»è‹±æ–‡æ–‡æ¡£ï¼Œå¯ä»¥å‚è€ƒ <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html">The JavaÂ® Virtual Machine Specification Chap 4.</a>\nå¦åˆ™ï¼Œå¯ä»¥é€‰æ‹© <a href="http://icyfenix.iteye.com/blog/1256329">Java è™šæ‹Ÿæœºè§„èŒƒ(Java SE 7 ç‰ˆ) ç¬¬å››ç« </a>\nå¹¶å°è¯•æ ¹æ®ç»ç¼–è¯‘å.classæ–‡ä»¶çš„äºŒè¿›åˆ¶ç è¿›è¡Œäººå·¥è§£æï¼Œä»¥åŠ æ·±å¯¹æ­¤çš„ç†è§£ã€‚</p>\n<h3>more...</h3>\n<p>æ›´å¤šå†…å®¹äºæ­¤åŸºæœ¬ç±»ä¼¼ï¼Œå‡å±äºå·²ç»è¢«ä¸¥æ ¼é¢„å®šä¹‰çš„è§„èŒƒåŒ–æ ¼å¼ï¼Œå¯¹æ­¤è¿›è¡Œè§£æå³å¯å¾—åˆ°ç›¸åº”çš„å†…å®¹ã€‚</p>\n<h2>ASM æ¦‚è§ˆ</h2>\n<h3>åŒ…ç»“æ„</h3>\n<p>asm, asm-analysis, asm-commons, asm-tree, asm-util, asm-xml æ¨¡å—åŸºäº Maven çš„ç»„ç»‡å½¢å¼ï¼Œå¹¶åŒ…å«æœ‰å•å…ƒæµ‹è¯•çš„å†…å®¹ã€‚</p>\n<p>asm-test å®ç°äº†å¯¹ä¸Šè¿°æ¨¡å—çš„å•å…ƒæµ‹è¯•çš„æ•´åˆã€‚</p>\n<p>benchmarks å®šä¹‰äº†ä¸€äº›åŸºæœ¬çš„ JMH åŸºå‡†æµ‹è¯•æ¥è¡¡é‡ASMçš„è¡¨ç°</p>\n<p>gradle åŒ…å«äº†ä¸€äº› Gradle åŒ…è£…å™¨ï¼Œæ¥è¾…åŠ© Linux or Windows è„šæœ¬çš„è°ƒç”¨è¯·æ±‚</p>\n<p>tools åŒ…å«ä¸¤ä¸ª Gradle é¡¹ç›®æ¥å¸®åŠ© ASM ç”Ÿæˆ Artifacts ã€‚</p>\n<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1frywra01upj308g0akmxr.jpg" alt="ASM Structure"></p>\n<h3>ä»£ç ç»„ç»‡å½¢å¼</h3>\n<p><img src="http://asm.ow2.io/asm-package-dependencies.svg" alt="Code Organization"></p>\n<ul>\n<li>org.objectweb.asm ä½œä¸ºæ ¸å¿ƒåŒ…ï¼Œå®šä¹‰äº† ASM è®¿é—®è€… API ä»¥åŠä¸¤ä¸ªæ ¸å¿ƒç±» ClassReader &#x26; ClassWriter æ¥è¯»å†™ç¼–è¯‘åçš„ Java ç±»ã€‚è¯¥åŒ…ä¸ä¾èµ–äºå…¶ä»–åŒ…ï¼Œä¸”å¯å•ç‹¬ä½¿ç”¨</li>\n<li>org.objectweb.asm.signature æä¾›äº†è¯»å†™æ³›å‹ç­¾åçš„ API</li>\n<li>org.objectweb.asm.tree æä¾›äº†ç±» DOM API ä¸ç±» SAX APIã€‚</li>\n<li>org.objectweb.asm.tree.analysis åŸºäº .tree æä¾›äº†é™æ€å­—èŠ‚ç åˆ†ææ¡†æ¶</li>\n<li>org.objectweb.asm.commons æä¾›äº†ä¸€äº›åŸºäº core å’Œ tree åŒ…çš„ç±»é€‚é…å™¨ã€‚</li>\n<li>org.objectweb.asm.util æä¾›äº†ä¸€äº›ç”¨äº DEBUG çš„è®¿é—®è€…ç±»ä¸é€‚é…å™¨ç±»</li>\n<li>org.objectweb.asm.xml ç›®å‰å·²ç»è¢« @Deprecated ã€‚æä¾›äº†ç±»æ–‡ä»¶ä¸ XML äº’ç›¸è½¬æ¢çš„èƒ½åŠ›</li>\n</ul>\n<p>ç»¼ä¸Šï¼Œasm æ ¸å¿ƒåŒ…æ˜¯æœ€ä¸ºå¤æ‚çš„ä¸€ä¸ªæ¨¡å—ï¼Œè€Œå…¶å®ƒè¯¸å¦‚ tree, util, xml ç­‰éƒ½åªæ˜¯æä¾›äº†å°† JAVA ç±»ä»ä¸€ç§é«˜çº§è¡¨ç¤ºå½¢æ€è½¬æ¢ä¸ºå¦ä¸€ç§çš„èƒ½åŠ›ã€‚signature ä¹Ÿç›¸å½“ç®€å•ï¼Œæä¾›äº†è§£æå’Œæ‰“å°ç®€å•è¯­æ³•çš„èƒ½åŠ›ã€‚</p>\n<h3>ä¸»è¦æ•°æ®ç»“æ„</h3>\n<p>æ ¸å¿ƒåŒ…ç”± 28 ä¸ªç±»(æ¥å£) ç»„æˆã€‚å¦‚æœä¸è€ƒè™‘ Opcodes æ¥å£, 5 ä¸ªæŠ½è±¡è®¿é—®è€…ç±»(AnnotationVistitor, ClassVisitor, FieldVisitor, MethodVisitor and ModuleVisitor), 6 ä¸ªå·¥å…·ç±»(ConstantDynamic, Contants, Handle, Type, TypePath and TypeReference), å‰©ä¸‹ 16 ä¸ªç±»çš„ç”±ä¸‹å›¾æä¾›ä¸€ä¸ªç²—ç•¥çš„å±•ç¤ºã€‚</p>\n<p><img src="http://asm.ow2.io/asm-package-overview.svg"></p>\n<p>ç¼–è¯‘ç±»åˆ°è®¿é—®äº‹ä»¶çš„è½¬æ¢åªç”±ä¸€ä¸ªç±» ClassReader ä»¥åŠè¾…åŠ©ç±» Context å®Œæˆã€‚å…¶é€†è¿‡ç¨‹ç”±ä»¥ ClassWriter ä¸ºæ ¸å¿ƒçš„å…¶å®ƒ 14 ä¸ªç±»å®Œæˆã€‚</p>\n<h3>ClassReader</h3>\n<p>ClassReader ä½œä¸º ASM æ ¸å¿ƒåŒ…è§£æç°æœ‰ .class çš„å”¯ä¸€å·¥å…·ï¼Œç»„ç»‡å½¢å¼ç›¸å½“ç®€å•ã€‚</p>\n<ul>\n<li>åœ¨æ„é€ å‡½æ•°ä¸­å®Œæˆå¯¹å¸¸é‡æ± å’Œå¼•å¯¼æ–¹æ³•çš„è§£æ<ul>\n<li>å­˜å‚¨æ¯ä¸ªå¸¸é‡æ± é¡¹ç›®çš„èµ·å§‹åç§»é‡ cpInfoOffsets</li>\n<li>å­˜å‚¨æ¯ä¸ªå¼•å¯¼æ–¹æ³•çš„èµ·å§‹åç§»é‡ bootstrapMethodOffsets</li>\n<li>å­˜å‚¨æœ€é•¿å­—ç¬¦ä¸²å¸¸é‡çš„å¤§å° maxStringLength</li>\n</ul></li>\n</ul>\n<pre><code class="language-java">  ClassReader(final byte[] classFileBuffer, final int classFileOffset, final boolean checkClassVersion) {\n    this.b = classFileBuffer;   // .class æ–‡ä»¶ç¼“å­˜\n    // æ£€æŸ¥ä¸»ç‰ˆæœ¬å·, ç¬¬6,7ä¸ªå­—èŠ‚(ä»0å­—èŠ‚å¼€å§‹è®¡æ•°)\n    if (checkClassVersion &#x26;&#x26; readShort(classFileOffset + 6) > Opcodes.V11) {\n      throw new IllegalArgumentException(\n          "Unsupported class file major version " + readShort(classFileOffset + 6));\n    }\n    // åˆ›å»ºå¸¸é‡æ± æ•°ç»„ï¼Œå¸¸é‡æ± é•¿åº¦çš„å®šä¹‰ constant_pool_count åœ¨ç¬¬8,9å­—èŠ‚\n    int constantPoolCount = readUnsignedShort(classFileOffset + 8);     // è¯»å–æ— ç¬¦å·short, å³è¯»å–è¿ç»­ä¸¤å­—èŠ‚ä½œä¸ºä¸€ä¸ªshortå€¼\n    cpInfoOffsets = new int[constantPoolCount];                         // æ¯ä¸ªå¸¸é‡çš„åç§»ä½ç½®\n    cpInfoValues = new Object[constantPoolCount];                       // æ¯ä¸ªå¸¸é‡çš„å®ä¾‹å¯¹è±¡\n    int currentCpInfoIndex = 1;\n    int currentCpInfoOffset = classFileOffset + 10;\n    int currentMaxStringLength = 0;                                     // æœ€é•¿å­—ç¬¦ä¸²å¸¸é‡\n    while (currentCpInfoIndex &#x3C; constantPoolCount) {\n      cpInfoOffsets[currentCpInfoIndex++] = currentCpInfoOffset + 1;\n      int cpInfoSize;\n      switch (classFileBuffer[currentCpInfoOffset]) {\n        case Symbol.CONSTANT_FIELDREF_TAG:\n        case Symbol.CONSTANT_METHODREF_TAG:\n        case Symbol.CONSTANT_INTERFACE_METHODREF_TAG:\n        case Symbol.CONSTANT_INTEGER_TAG:\n        case Symbol.CONSTANT_FLOAT_TAG:\n        case Symbol.CONSTANT_NAME_AND_TYPE_TAG:\n        case Symbol.CONSTANT_INVOKE_DYNAMIC_TAG:\n        case Symbol.CONSTANT_DYNAMIC_TAG:\n          cpInfoSize = 5;\n          break;\n        case Symbol.CONSTANT_LONG_TAG:\n        case Symbol.CONSTANT_DOUBLE_TAG:\n          cpInfoSize = 9;\n          currentCpInfoIndex++;\n          break;\n        case Symbol.CONSTANT_UTF8_TAG:\n          cpInfoSize = 3 + readUnsignedShort(currentCpInfoOffset + 1);\n          if (cpInfoSize > currentMaxStringLength) {\n            // The size in bytes of this CONSTANT_Utf8 structure provides a conservative estimate\n            // of the length in characters of the corresponding string, and is much cheaper to\n            // compute than this exact length.\n            currentMaxStringLength = cpInfoSize;\n          }\n          break;\n        case Symbol.CONSTANT_METHOD_HANDLE_TAG:\n          cpInfoSize = 4;\n          break;\n        case Symbol.CONSTANT_CLASS_TAG:\n        case Symbol.CONSTANT_STRING_TAG:\n        case Symbol.CONSTANT_METHOD_TYPE_TAG:\n        case Symbol.CONSTANT_PACKAGE_TAG:\n        case Symbol.CONSTANT_MODULE_TAG:\n          cpInfoSize = 3;\n          break;\n        default:\n          throw new IllegalArgumentException();\n      }\n      currentCpInfoOffset += cpInfoSize;\n    }\n    this.maxStringLength = currentMaxStringLength;\n    // The Classfile\'s access_flags field is just after the last constant pool entry.\n    this.header = currentCpInfoOffset;\n\n    // è¯»å– BootstrapMethods å±æ€§(å¦‚æœå­˜åœ¨)\n    int currentAttributeOffset = getFirstAttributeOffset();\n    int[] currentBootstrapMethodOffsets = null;\n    for (int i = readUnsignedShort(currentAttributeOffset - 2); i > 0; --i) {\n      // è¯»å–æ¯ä¸ª attribute_info çš„å±æ€§åå’Œå±æ€§é•¿åº¦\n      String attributeName = readUTF8(currentAttributeOffset, new char[maxStringLength]);\n      int attributeLength = readInt(currentAttributeOffset + 2);\n      currentAttributeOffset += 6;\n      // å¦‚æœå½“å‰å±æ€§åä¸º BootstrapMethods ï¼Œåˆ™è¿›å…¥å¤„ç†é€»è¾‘\n      if (Constants.BOOTSTRAP_METHODS.equals(attributeName)) {\n        // Read the num_bootstrap_methods field and create an array of this size.\n        currentBootstrapMethodOffsets = new int[readUnsignedShort(currentAttributeOffset)];\n        // Compute and store the offset of each \'bootstrap_methods\' array field entry.\n        int currentBootstrapMethodOffset = currentAttributeOffset + 2;\n        for (int j = 0; j &#x3C; currentBootstrapMethodOffsets.length; ++j) {\n          currentBootstrapMethodOffsets[j] = currentBootstrapMethodOffset;\n          // Skip the bootstrap_method_ref and num_bootstrap_arguments fields (2 bytes each),\n          // as well as the bootstrap_arguments array field (of size num_bootstrap_arguments * 2).\n          currentBootstrapMethodOffset +=\n              4 + readUnsignedShort(currentBootstrapMethodOffset + 2) * 2;\n        }\n      }\n      currentAttributeOffset += attributeLength;\n    }\n    this.bootstrapMethodOffsets = currentBootstrapMethodOffsets;\n  }\n</code></pre>\n<p>åˆ°æ­¤ä¸ºæ­¢ï¼ŒClassReader å·²ç»è§£æäº†åŒ…æ‹¬ magic, minor version, major version, constant pool ã€‚\nä½†æ˜¯ï¼Œè¯¸å¦‚ field_info, method_info, attribute_info ç­‰ä»ç„¶æ²¡æœ‰å¾—åˆ°å¤„ç†ã€‚</p>\n<p>è¿™éƒ¨åˆ†çš„å†…å®¹åœ¨ accept(...) å’Œ readXXX(...) ä¸­å°†å¾—åˆ°è§£æã€‚</p>\n<p>ä¸»è¦æµç¨‹ç±»ä¼¼:</p>\n<ol>\n<li>è¯»å–å½“å‰å†…å®¹çš„åç§»é‡(ç›¸è¾ƒäºæ•´ä¸ª byte[])</li>\n<li>è§£æå½“å‰çš„å†…å®¹</li>\n<li>è°ƒç”¨ visitXXX æ–¹æ³•</li>\n<li>åœ¨ visitXXX æ–¹æ³•ä¸­è¿›è¡Œç›¸å…³çš„å¤„ç†</li>\n<li>visitEnd</li>\n</ol>\n<h2>é™„å½•1 Trie.java</h2>\n<pre><code class="language-java">package me.fangfeng.filter;\n\nimport java.io.BufferedReader;\nimport java.io.BufferedWriter;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.FileNotFoundException;\nimport java.io.InputStreamReader;\nimport java.io.IOException;\nimport java.io.OutputStreamWriter;\n\n/**\n * @author fangfeng\n * @since 2018/5/16\n */\npublic class Trie {\n    \n    private static int MAX_ITEM = 700000;\n    private static int AVG_LENGTH = 11;\n    private static int MAX_NODE = MAX_ITEM * AVG_LENGTH;\n    private static int CHAR_NUM = 10;\n\n    int[][] nxt = new int[MAX_NODE][CHAR_NUM];\n    boolean[] flag = new boolean[MAX_NODE];\n    int trieIndex = 0;\n\n    void insert(long number) {\n        int tmpIndex = 0;\n        for (;number != 0;number /= 10) {\n            if (nxt[tmpIndex][(int) (number % 10)] == 0) {\n                nxt[tmpIndex][(int) (number % 10)] = ++trieIndex;\n            }\n            tmpIndex = nxt[tmpIndex][(int) (number % 10)];\n        }\n        flag[tmpIndex] = true;\n    }\n\n    boolean query(long number) {\n        int tmpIndex = 0;\n        for (;number != 0;number /= 10) {\n            if (nxt[tmpIndex][(int) (number % 10)] == 0) {\n                return false;\n            }\n            tmpIndex = nxt[tmpIndex][(int) (number % 10)];\n        }\n        return flag[tmpIndex];\n    }\n\n    public static void main(String... args) throws FileNotFoundException, IOException {\n\n        long start = System.currentTimeMillis();\n\n        String ruleFilePath = args[0];\n        String sendFilePath = args[1];\n        String outFilePath = args[2];\n\n        BufferedReader ruleReader = new BufferedReader(new InputStreamReader(new FileInputStream(ruleFilePath)));\n        BufferedReader sendReader = new BufferedReader(new InputStreamReader(new FileInputStream(sendFilePath)));\n\n        BufferedWriter outWriter = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(outFilePath)));\n\n        Trie trie = new Trie();\n        String mobile;\n        while((mobile = ruleReader.readLine()) != null) {\n            trie.insert(Long.parseLong(mobile));\n        }\n        ruleReader.close();\n\n        while((mobile = sendReader.readLine()) != null) {\n            if(trie.query(Long.parseLong(mobile)) == false) {\n                outWriter.write(mobile);\n                outWriter.newLine();\n            }\n        }\n        sendReader.close();\n\n        outWriter.flush();\n        outWriter.close();\n\n        long end = System.currentTimeMillis();\n        System.out.println(String.format("exec success! used %d ms", end - start));\n    }\n}\n</code></pre>\n<h2>é™„å½•2 Constant pool</h2>\n<pre><code>Constant pool:\n    #1 = Methodref          #36.#75       // java/lang/Object."&#x3C;init>":()V\n    #2 = Fieldref           #23.#76       // me/fangfeng/filter/Trie.MAX_NODE:I\n    #3 = Fieldref           #23.#77       // me/fangfeng/filter/Trie.CHAR_NUM:I\n    #4 = Class              #49           // "[[I"\n    #5 = Fieldref           #23.#78       // me/fangfeng/filter/Trie.nxt:[[I\n    #6 = Fieldref           #23.#79       // me/fangfeng/filter/Trie.flag:[Z\n    #7 = Fieldref           #23.#80       // me/fangfeng/filter/Trie.trieIndex:I\n    #8 = Long               10l\n   #10 = Methodref          #81.#82       // java/lang/System.currentTimeMillis:()J\n   #11 = Class              #83           // java/io/BufferedReader\n   #12 = Class              #84           // java/io/InputStreamReader\n   #13 = Class              #85           // java/io/FileInputStream\n   #14 = Methodref          #13.#86       // java/io/FileInputStream."&#x3C;init>":(Ljava/lang/String;)V\n   #15 = Methodref          #12.#87       // java/io/InputStreamReader."&#x3C;init>":(Ljava/io/InputStream;)V\n   #16 = Methodref          #11.#88       // java/io/BufferedReader."&#x3C;init>":(Ljava/io/Reader;)V\n   #17 = Class              #89           // java/io/BufferedWriter\n   #18 = Class              #90           // java/io/OutputStreamWriter\n   #19 = Class              #91           // java/io/FileOutputStream\n   #20 = Methodref          #19.#86       // java/io/FileOutputStream."&#x3C;init>":(Ljava/lang/String;)V\n   #21 = Methodref          #18.#92       // java/io/OutputStreamWriter."&#x3C;init>":(Ljava/io/OutputStream;)V\n   #22 = Methodref          #17.#93       // java/io/BufferedWriter."&#x3C;init>":(Ljava/io/Writer;)V\n   #23 = Class              #94           // me/fangfeng/filter/Trie\n   #24 = Methodref          #23.#75       // me/fangfeng/filter/Trie."&#x3C;init>":()V\n   #25 = Methodref          #11.#95       // java/io/BufferedReader.readLine:()Ljava/lang/String;\n   #26 = Methodref          #96.#97       // java/lang/Long.parseLong:(Ljava/lang/String;)J\n   #27 = Methodref          #23.#98       // me/fangfeng/filter/Trie.insert:(J)V\n   #28 = Methodref          #11.#99       // java/io/BufferedReader.close:()V\n   #29 = Methodref          #23.#100      // me/fangfeng/filter/Trie.query:(J)Z\n   #30 = Methodref          #17.#101      // java/io/BufferedWriter.write:(Ljava/lang/String;)V\n   #31 = Methodref          #17.#102      // java/io/BufferedWriter.newLine:()V\n   #32 = Methodref          #17.#103      // java/io/BufferedWriter.flush:()V\n   #33 = Methodref          #17.#99       // java/io/BufferedWriter.close:()V\n   #34 = Fieldref           #81.#104      // java/lang/System.out:Ljava/io/PrintStream;\n   #35 = String             #105          // exec success! used %d ms\n   #36 = Class              #106          // java/lang/Object\n   #37 = Methodref          #96.#107      // java/lang/Long.valueOf:(J)Ljava/lang/Long;\n   #38 = Methodref          #108.#109     // java/lang/String.format:(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;\n   #39 = Methodref          #110.#111     // java/io/PrintStream.println:(Ljava/lang/String;)V\n   #40 = Integer            700000\n   #41 = Fieldref           #23.#112      // me/fangfeng/filter/Trie.MAX_ITEM:I\n   #42 = Fieldref           #23.#113      // me/fangfeng/filter/Trie.AVG_LENGTH:I\n   #43 = Utf8               MAX_ITEM\n   #44 = Utf8               I\n   #45 = Utf8               AVG_LENGTH\n   #46 = Utf8               MAX_NODE\n   #47 = Utf8               CHAR_NUM\n   #48 = Utf8               nxt\n   #49 = Utf8               [[I\n   #50 = Utf8               flag\n   #51 = Utf8               [Z\n   #52 = Utf8               trieIndex\n   #53 = Utf8               &#x3C;init>\n   #54 = Utf8               ()V\n   #55 = Utf8               Code\n   #56 = Utf8               LineNumberTable\n   #57 = Utf8               insert\n   #58 = Utf8               (J)V\n   #59 = Utf8               StackMapTable\n   #60 = Utf8               query\n   #61 = Utf8               (J)Z\n   #62 = Utf8               main\n   #63 = Utf8               ([Ljava/lang/String;)V\n   #64 = Class              #114          // "[Ljava/lang/String;"\n   #65 = Class              #115          // java/lang/String\n   #66 = Class              #83           // java/io/BufferedReader\n   #67 = Class              #89           // java/io/BufferedWriter\n   #68 = Class              #94           // me/fangfeng/filter/Trie\n   #69 = Utf8               Exceptions\n   #70 = Class              #116          // java/io/FileNotFoundException\n   #71 = Class              #117          // java/io/IOException\n   #72 = Utf8               &#x3C;clinit>\n   #73 = Utf8               SourceFile\n   #74 = Utf8               Trie.java\n   #75 = NameAndType        #53:#54       // "&#x3C;init>":()V\n   #76 = NameAndType        #46:#44       // MAX_NODE:I\n   #77 = NameAndType        #47:#44       // CHAR_NUM:I\n   #78 = NameAndType        #48:#49       // nxt:[[I\n   #79 = NameAndType        #50:#51       // flag:[Z\n   #80 = NameAndType        #52:#44       // trieIndex:I\n   #81 = Class              #118          // java/lang/System\n   #82 = NameAndType        #119:#120     // currentTimeMillis:()J\n   #83 = Utf8               java/io/BufferedReader\n   #84 = Utf8               java/io/InputStreamReader\n   #85 = Utf8               java/io/FileInputStream\n   #86 = NameAndType        #53:#121      // "&#x3C;init>":(Ljava/lang/String;)V\n   #87 = NameAndType        #53:#122      // "&#x3C;init>":(Ljava/io/InputStream;)V\n   #88 = NameAndType        #53:#123      // "&#x3C;init>":(Ljava/io/Reader;)V\n   #89 = Utf8               java/io/BufferedWriter\n   #90 = Utf8               java/io/OutputStreamWriter\n   #91 = Utf8               java/io/FileOutputStream\n   #92 = NameAndType        #53:#124      // "&#x3C;init>":(Ljava/io/OutputStream;)V\n   #93 = NameAndType        #53:#125      // "&#x3C;init>":(Ljava/io/Writer;)V\n   #94 = Utf8               me/fangfeng/filter/Trie\n   #95 = NameAndType        #126:#127     // readLine:()Ljava/lang/String;\n   #96 = Class              #128          // java/lang/Long\n   #97 = NameAndType        #129:#130     // parseLong:(Ljava/lang/String;)J\n   #98 = NameAndType        #57:#58       // insert:(J)V\n   #99 = NameAndType        #131:#54      // close:()V\n  #100 = NameAndType        #60:#61       // query:(J)Z\n  #101 = NameAndType        #132:#121     // write:(Ljava/lang/String;)V\n  #102 = NameAndType        #133:#54      // newLine:()V\n  #103 = NameAndType        #134:#54      // flush:()V\n  #104 = NameAndType        #135:#136     // out:Ljava/io/PrintStream;\n  #105 = Utf8               exec success! used %d ms\n  #106 = Utf8               java/lang/Object\n  #107 = NameAndType        #137:#138     // valueOf:(J)Ljava/lang/Long;\n  #108 = Class              #115          // java/lang/String\n  #109 = NameAndType        #139:#140     // format:(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;\n  #110 = Class              #141          // java/io/PrintStream\n  #111 = NameAndType        #142:#121     // println:(Ljava/lang/String;)V\n  #112 = NameAndType        #43:#44       // MAX_ITEM:I\n  #113 = NameAndType        #45:#44       // AVG_LENGTH:I\n  #114 = Utf8               [Ljava/lang/String;\n  #115 = Utf8               java/lang/String\n  #116 = Utf8               java/io/FileNotFoundException\n  #117 = Utf8               java/io/IOException\n  #118 = Utf8               java/lang/System\n  #119 = Utf8               currentTimeMillis\n  #120 = Utf8               ()J\n  #121 = Utf8               (Ljava/lang/String;)V\n  #122 = Utf8               (Ljava/io/InputStream;)V\n  #123 = Utf8               (Ljava/io/Reader;)V\n  #124 = Utf8               (Ljava/io/OutputStream;)V\n  #125 = Utf8               (Ljava/io/Writer;)V\n  #126 = Utf8               readLine\n  #127 = Utf8               ()Ljava/lang/String;\n  #128 = Utf8               java/lang/Long\n  #129 = Utf8               parseLong\n  #130 = Utf8               (Ljava/lang/String;)J\n  #131 = Utf8               close\n  #132 = Utf8               write\n  #133 = Utf8               newLine\n  #134 = Utf8               flush\n  #135 = Utf8               out\n  #136 = Utf8               Ljava/io/PrintStream;\n  #137 = Utf8               valueOf\n  #138 = Utf8               (J)Ljava/lang/Long;\n  #139 = Utf8               format\n  #140 = Utf8               (Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;\n  #141 = Utf8               java/io/PrintStream\n  #142 = Utf8               println\n</code></pre>\n<h2>å‚è€ƒ</h2>\n<p>[1]: <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html">https://docs.oracle.com/javase/specs/jvms/se8/html/index.html</a> "Java Virtual Machine Specification"\n[2]: <a href="http://icyfenix.iteye.com/blog/1256329">http://icyfenix.iteye.com/blog/1256329</a> "Javaè™šæ‹Ÿæœºè§„èŒƒï¼ˆJava SE 7 ä¸­æ–‡ç‰ˆï¼‰"</p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},RrPW:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>title: å­—ç¬¦é›†ä¸å­—ç¬¦ç¼–ç \nauthor: fangfeng\ndate: 2019-02-02\ntags:</p>\n<ul>\n<li>Unicode</li>\n<li>Character Encoding</li>\n</ul>\n<hr>\n<p>{% pdf <a href="https://drive.google.com/file/d/1MuBNtZPMWCt9kGlpqiAtG3i3Al2MaknY/preview">https://drive.google.com/file/d/1MuBNtZPMWCt9kGlpqiAtG3i3Al2MaknY/preview</a> %}</p>'}},S4Mp:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<h2>æ¦‚è¿°</h2>\n<p>ä¹‹æ‰€ä»¥æƒ³è¦äº†è§£ Linux Kernelï¼Œä¸å‰ä¸€ä¸ªæœˆçš„ JVM ClassFile çš„å­¦ä¹ æœ‰è¿™å¾ˆå¤§çš„å…³è”ã€‚</p>\n<p>è¯´å®è¯ï¼Œåˆ¨é™¤ JVM çš„å…·ä½“å®ç°ï¼ŒSun (æˆ–è€…ç°åœ¨è¯¥è¯´æ˜¯ Oracle) ç¡®å®å°† Java çš„åº•å±‚é€»è¾‘è®¾è®¡å¾—ç›¸å½“ç®€å•ã€‚</p>\n<ol>\n<li>æœ‰é™è€Œç»Ÿä¸€çš„æŒ‡ä»¤é›†(ä¸è¶…è¿‡ 256 ä¸ªï¼Œå¯ä»¥ç”¨ 1 å­—èŠ‚è¡¨ç¤º)</li>\n<li>æ“ä½œæ•°æ ˆ+å±€éƒ¨å˜é‡è¡¨å…±åŒå®ç°çš„æŒ‡ä»¤è¿ç®—</li>\n<li>é«˜åº¦å°è£…çš„æˆå‘˜å˜é‡/æ–¹æ³•çš„å¯»å€æ–¹å¼</li>\n<li>... (è§è¯†çŸ­æµ…ï¼Œæƒ³ä¸åˆ°äº†...ä»¥åå†è¡¥å……å§)</li>\n</ol>\n<p>ä½†æ˜¯ï¼Œä¸ JVM æ¨¡æ‹Ÿçš„è™šæ‹Ÿæœºä¸åŒï¼Œå®ä½“æœºå™¨æœ‰ç€æ›´ä¸ºå¤æ‚çš„ç»“æ„ã€‚\næœ€æ ¹æœ¬çš„ï¼Œä¸åŒå‚å•†çš„æœºå™¨å°±å¸¦æ¥äº†ä¸åŒçš„ CPU æŒ‡ä»¤é›†ï¼Œè¿™å°±å·²ç»è®©äººéš¾ä»¥æ¥å—äº†ã€‚</p>\n<p>å…¶å®æœ€åˆï¼Œæ˜¯æƒ³è¦ç»§ç»­å»çœ‹çœ‹ Hotspot è™šæ‹Ÿæœºçš„ã€‚ä½†æ˜¯ï¼Œæ··æ‚çš„ä»£ç (C++, Java, å¹³å°ç›¸å…³å„ç§å®ç°) å¸¦æ¥äº†å¾ˆå¤§çš„é˜…è¯»éšœç¢ã€‚\næœ€æ ¹æœ¬çš„ï¼Œæˆ‘ç”šè‡³æ‰¾ä¸åˆ°ä¸€ä¸ªå­¦ä¹ çš„åŸºæœ¬ç«‹è¶³ç‚¹ï¼Œå‡ºå‘ç‚¹(å½“ç„¶ï¼Œä¹Ÿå¯èƒ½æˆ‘æ ¹æœ¬å°±æ²¡ä»”ç»†å»çœ‹ï¼Œå“ˆå“ˆ)ã€‚</p>\n<p>å€Ÿç€ä¸€æ¬¡æœºä¼šï¼Œæˆ‘å¼€å§‹çœ‹ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»â€”â€”é“¾æ¥ã€è£…è½½ä¸åº“ã€‹ä¸€ä¹¦ã€‚ç¡®å®æ— è®ºæ˜¯ ELF æ ¼å¼ï¼Œé™æ€é“¾æ¥ä¸åŠ¨æ€é“¾æ¥ç”šè‡³ Linux çš„å†…å»ºå‡½æ•°\néƒ½ç»™äº†æˆ‘æ¯”è¾ƒæ·±åˆ»çš„å°è±¡ï¼Œå‘æˆ‘å±•ç¤ºäº† C æ›´æ·±å…¥çš„ä¸€é¢ã€‚ä½†æ˜¯ï¼ŒmacOS ç»™æˆ‘å¸¦æ¥äº†æ¯”è¾ƒå¤§çš„å®¢è§‚é˜»ç¢(å³ä½¿ç”¨ Docker å®¹å™¨å¾—åˆ°äº†ä¸€ä¸ªå¯ç”¨çš„ Linux ç¯å¢ƒï¼Œä½†æ˜¯å¦ä¸ç›´æ¥å»ºç«‹åœ¨æœºå™¨ä¸Šçš„ç³»ç»Ÿæœ‰æ‰€åŒºåˆ«ï¼Œæ­¤å¤„è¿˜å¾—æ‰“ä¸ªé—®å·)ã€‚\nåŒæ—¶ï¼Œä¹¦ä¸­çš„éƒ¨åˆ†å†…å®¹ä¸Šä¸‹ä¸ç»Ÿä¸€ï¼Œç¼ºå°‘å‰åæ–‡ä¹Ÿæ˜¯ä¸€ä¸ªé‡å¤§çš„é—®é¢˜ã€‚æ€»ä¹‹ï¼Œè¿™å¹¶ä¸å®Œå…¨é€‚åˆæˆ‘è¿™ç§åˆå­¦è€…é€ä¸€è¿›è¡Œä¹¦ä¸­æ‰€æè¿°çš„å…¨éƒ¨å®éªŒã€‚</p>\n<p>æœ€åï¼Œæˆ‘å†³å®šå±•å¼€å¯¹ Linux Kernel çš„å­¦ä¹ ï¼Œè¯•å›¾é€šè¿‡å¯¹ç›´æ¥æ„æ¶åœ¨ç¡¬ä»¶ä¸Šçš„æ“ä½œç³»ç»Ÿè¿›è¡Œä¸€ç•ªæ¯”è¾ƒæ·±å…¥çš„å­¦ä¹ ã€‚</p>\n<p>æœŸé—´ï¼Œæ‰¾è¿‡ä¸€äº›èµ„æ–™ï¼Œä¹Ÿäº†è§£åˆ° Linus Torvals ç›´æ¥é¢†å¯¼ç€çš„ <a href="https://www.kernel.org/">Kernel é¡¹ç›®çš„å®˜ç½‘</a>ï¼›ç”šè‡³ï¼Œæ‰¾åˆ°äº†å„ä¸ªç‰ˆæœ¬çš„ kernel æºç (è™½ç„¶ç¡®å®åœ°ä¸¢å¤±äº†æœ€æ—©æœŸ 0.XX çš„è‹¥å¹²ç‰ˆæœ¬)ã€‚\nä¸å¾—ä¸è¯´ï¼Œå°±ç›®å‰æ¥è®²ï¼Œæˆ‘è§‰å¾—ã€ŠLinuxå†…æ ¸å®Œå…¨æ³¨é‡Šã€‹æ˜¯æœ€é€‚åˆ(<em>æ‰“ä¸ªé—®å·ï¼Œè‡³å°‘æš‚æ—¶æ˜¯çš„</em>)æˆ‘å­¦ä¹ çš„ä¸€ä¹¦ã€‚</p>\n<p>ä¹‹åçš„è‹¥å¹²åšæ–‡ï¼Œå°†éƒ½ä»¥ã€ŠLinuxå†…æ ¸å®Œå…¨æ³¨é‡Šã€‹ä¸­çš„å†…å®¹ä¸ºåŸºç¡€ï¼Œç»“åˆç›®å‰çš„å®é™…éœ€è¦ï¼Œä»è€Œè¿›è¡Œå®æ“æ€§çš„è®¤çŸ¥ä¸å­¦ä¹ ã€‚</p>\n<h2>è½¯ç¡¬ä»¶æè¿°</h2>\n<p>è¿›è¡Œè¿™æ–¹é¢çš„æè¿°ï¼Œæ˜¯å› ä¸º Linux Kernel å°†ç›´æ¥ä¸åº•å±‚ç¡¬ä»¶æ‰“äº¤é“(å½“ç„¶ï¼Œè¿™æ–¹é¢ä½¿ç”¨çš„ Bochs ä»¿çœŸå™¨)ã€‚\nä½†æ˜¯ï¼Œå‡†å¤‡è¯¸å¦‚ .img (ç£ç›˜æ˜ åƒæ–‡ä»¶), æœºå™¨æŒ‡ä»¤æ–‡ä»¶ç­‰éƒ½ä¸å¾—ä¸å€ŸåŠ©äºç°æœ‰çš„å¹³å°ã€‚</p>\n<ul>\n<li>æ“ä½œç³»ç»Ÿ: macOS 10.13.6 , Ubuntu 16.04 (Docker è™šæ‹Ÿæœºå®¹å™¨)</li>\n<li>ä»¿çœŸå™¨  : Bochs 2.6.9_2 (macOS ä¸ Ubuntu ä¸Šç›¸åŒ)</li>\n<li>æ›´å¤š    : å°†ç›´æ¥åœ¨æ­£æ–‡é¦–æ¬¡ä½¿ç”¨åˆ°æ—¶è¿›è¡Œè¯´æ˜</li>\n</ul>\n<h2>Bochs</h2>\n<p><a href="http://bochs.sourceforge.net/">Bochs å®˜ç½‘</a></p>\n<p><a href="https://sourceforge.net/projects/bochs/files/">Bochs ä¸‹è½½é“¾</a></p>\n<p>è¯´å®è¯è¿™ä¸€å‘¨éƒ½å·®ä¸å¤šè¦è¢« Bochs æŠ˜è…¾æ­»ï¼Œç”¨æºç è¿›è¡Œç¼–è¯‘å‡ºç°å„ç§å„æ ·çš„é—®é¢˜ã€‚(æˆ‘çŒœæ–°ç‰ˆæœ¬æ ¹æœ¬å°±æ²¡è€ƒè™‘å¯¹ macOS åšå…¼å®¹)</p>\n<p>æœ€åï¼Œä¸å¾—ä¸ä½¿ç”¨ç»ç¼–è¯‘åçš„äºŒè¿›åˆ¶åˆ†å‘ç‰ˆã€‚ <code>brew install bochs</code> å½“ç„¶äº†ï¼Œåæ­£ä¹Ÿèƒ½ç”¨ï¼Œå°±ä¸çº ç»“éå¾—è‡ªå·±ç¼–è¯‘äº†ã€‚(å¦‚æœå“ªä½èƒ½æˆåŠŸç¼–è¯‘ä¸ª macOS å¯ç”¨çš„åº”ç”¨ï¼Œå¸Œæœ›èƒ½æŠŠè¸©å¾—å‘æ•´ç†æ•´ç†ï¼Œä¾›åæ¥è€…å‚è€ƒ)</p>\n<h3>ç›®å½•ç»“æ„</h3>\n<pre><code class="language-plain">.\nâ”œâ”€â”€ CHANGES\nâ”œâ”€â”€ COPYING\nâ”œâ”€â”€ INSTALL_RECEIPT.json\nâ”œâ”€â”€ LICENSE\nâ”œâ”€â”€ README\nâ”œâ”€â”€ TODO\nâ”œâ”€â”€ bin\nâ”‚Â Â  â”œâ”€â”€ bochs                           // bochs å¯æ‰§è¡Œæ–‡ä»¶\nâ”‚Â Â  â””â”€â”€ bximage                         // åˆ¶ä½œç£ç›˜æ˜ åƒæ–‡ä»¶çš„å·¥å…·\nâ”œâ”€â”€ lib                                 // åŠ¨æ€åº“ç›®å½•\nâ”‚Â Â  â””â”€â”€ bochs\nâ”‚Â Â      â””â”€â”€ plugins\nâ”‚Â Â          â”œâ”€â”€ libbx_acpi.0.0.0.so\nâ”‚Â Â          â”œâ”€â”€ ... ç•¥\nâ”‚Â Â          â””â”€â”€ libbx_vga.so -> libbx_vga.0.0.0.so\nâ””â”€â”€ share                               // ä¸ä½“ç³»ç»“æ„æ— å…³çš„æ–‡ä»¶æ”¾åœ¨æ­¤ç›®å½•ä¸‹\n    â”œâ”€â”€ bochs\n    â”‚Â Â  â”œâ”€â”€ BIOS-bochs-latest\n    â”‚Â Â  â”œâ”€â”€ BIOS-bochs-legacy\n    â”‚Â Â  â”œâ”€â”€ SeaBIOS-README\n    â”‚Â Â  â”œâ”€â”€ VGABIOS-elpin-2.40\n    â”‚Â Â  â”œâ”€â”€ VGABIOS-elpin-LICENSE\n    â”‚Â Â  â”œâ”€â”€ VGABIOS-lgpl-README\n    â”‚Â Â  â”œâ”€â”€ VGABIOS-lgpl-latest\n    â”‚Â Â  â”œâ”€â”€ VGABIOS-lgpl-latest-cirrus\n    â”‚Â Â  â”œâ”€â”€ VGABIOS-lgpl-latest-cirrus-debug\n    â”‚Â Â  â”œâ”€â”€ VGABIOS-lgpl-latest-debug\n    â”‚Â Â  â”œâ”€â”€ bios.bin-1.7.5\n    â”‚Â Â  â””â”€â”€ keymaps\n    â”‚Â Â      â”œâ”€â”€ sdl-pc-us.map\n    â”‚Â Â      â”œâ”€â”€ ... ç•¥\n    â”‚Â Â      â””â”€â”€ x11-pc-us.map\n    â”œâ”€â”€ doc\n    â”‚Â Â  â””â”€â”€ bochs\n    â”‚Â Â      â”œâ”€â”€ CHANGES\n    â”‚Â Â      â”œâ”€â”€ COPYING\n    â”‚Â Â      â”œâ”€â”€ LICENSE\n    â”‚Â Â      â”œâ”€â”€ README\n    â”‚Â Â      â”œâ”€â”€ TODO\n    â”‚Â Â      â”œâ”€â”€ bochsrc-sample.txt      // bochsrc é…ç½®æ–‡ä»¶çš„ç¤ºä¾‹æ ·æ¿\n    â”‚Â Â      â””â”€â”€ slirp.conf\n    â””â”€â”€ man\n        â”œâ”€â”€ man1\n        â”‚Â Â  â”œâ”€â”€ bochs-dlx.1.gz\n        â”‚Â Â  â”œâ”€â”€ bochs.1.gz\n        â”‚Â Â  â””â”€â”€ bximage.1.gz\n        â””â”€â”€ man5\n            â””â”€â”€ bochsrc.5.gz\n</code></pre>\n<h3>ç®€å•ä½¿ç”¨</h3>\n<p>Bochs ä¸‹è½½é“¾æä¾›äº† Bochs ä¸åŒç‰ˆæœ¬çš„æºç çš„ä¸‹è½½ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†ä¸€äº›å¯ç”¨çš„ç£ç›˜æ˜ åƒæ–‡ä»¶(éƒ½æ˜¯ä¸€äº›å·²ç»ç»è¿‡å¤„ç†ï¼Œå¯ç”¨ä½¿ç”¨è¿›è¡Œä»¿çœŸè¿è¡Œçš„ OS )</p>\n<p>è¯´å®è¯ï¼Œè¿™æ˜¯ç»å¯¹æœ‰å¿…è¦è¿›è¡Œçš„ä¸€æ­¥ï¼Œä¸ä»…ä»…æ˜¯äº†è§£é…ç½®æ–‡ä»¶ bochsrc çš„é…ç½®æ–¹å¼ï¼Œæ›´å¯ç”¨å€Ÿæ­¤äº†è§£ä¸€ä¸‹ä»¿çœŸå™¨çš„ä½¿ç”¨æ–¹å¼ã€‚(åœ¨å¯åŠ¨ç³»ç»Ÿä¸Šï¼Œæˆ‘ä¹Ÿè¢«å‘äº†ä¸€å¤©ï¼Œåé¢ç»†è¯´)</p>\n<p>é¦–å…ˆï¼Œè¿™é‡Œæ¼”ç¤ºçš„å°†æ˜¯ DLX Linux ã€‚</p>\n<ol>\n<li>\n<p>ä¸‹è½½ï¼Œè§£å‹ï¼Œè¿›å…¥ç›®å½•ã€‚</p>\n</li>\n<li>\n<p>ç›®å½•ä¸‹æ–‡ä»¶å¦‚ä¸‹</p>\n</li>\n</ol>\n<pre><code class="language-plain">.\nâ”œâ”€â”€ bochsrc.txt         // bochs å¯åŠ¨æ—¶å°†é»˜è®¤é€šè¿‡è¿™ä¸ªæ–‡ä»¶è¯»å–ä»¿çœŸå™¨é…ç½®\nâ”œâ”€â”€ hd10meg.img         // ç£ç›˜æ˜ åƒæ–‡ä»¶\nâ”œâ”€â”€ readme.txt\nâ””â”€â”€ testform.txt\n</code></pre>\n<ol start="3">\n<li>å¯åŠ¨ä»¿çœŸå™¨</li>\n</ol>\n<p>åœ¨ DLX Linux ç›®å½•ä¸‹é”®å…¥å‘½ä»¤ <code>bochs</code>, è§‚å¯Ÿåˆ°å‘½ä»¤è¡Œè¾“å‡º:</p>\n<pre><code class="language-plain">========================================================================\n                       Bochs x86 Emulator 2.6.9\n               Built from SVN snapshot on April 9, 2017\n                  Compiled on May  2 2018 at 13:26:32\n========================================================================\n00000000000i[      ] LTDL_LIBRARY_PATH not set. using compile time default \'/usr/local/Cellar/bochs/2.6.9_2/lib/bochs/plugins\'\n00000000000i[      ] BXSHARE not set. using compile time default \'/usr/local/Cellar/bochs/2.6.9_2/share/bochs\'\n00000000000i[      ] lt_dlhandle is 0x7fef2252a500\n00000000000i[PLUGIN] loaded plugin libbx_usb_common.so\n00000000000i[      ] lt_dlhandle is 0x7fef2252a8a0\n00000000000i[PLUGIN] loaded plugin libbx_unmapped.so\n00000000000i[      ] lt_dlhandle is 0x7fef2252ad00\n00000000000i[PLUGIN] loaded plugin libbx_biosdev.so\n00000000000i[      ] lt_dlhandle is 0x7fef2252b1e0\n00000000000i[PLUGIN] loaded plugin libbx_speaker.so\n00000000000i[      ] lt_dlhandle is 0x7fef2252ba50\n00000000000i[PLUGIN] loaded plugin libbx_extfpuirq.so\n00000000000i[      ] lt_dlhandle is 0x7fef2252be70\n00000000000i[PLUGIN] loaded plugin libbx_parallel.so\n00000000000i[      ] lt_dlhandle is 0x7fef238013c0\n00000000000i[PLUGIN] loaded plugin libbx_serial.so\n00000000000i[      ] lt_dlhandle is 0x7fef22706cd0\n00000000000i[PLUGIN] loaded plugin libbx_iodebug.so\n00000000000i[      ] reading configuration from bochsrc.txt\n------------------------------\nBochs Configuration: Main Menu\n------------------------------\n\nThis is the Bochs Configuration Interface, where you can describe the\nmachine that you want to simulate.  Bochs has already searched for a\nconfiguration file (typically called bochsrc.txt) and loaded it if it\ncould be found.  When you are satisfied with the configuration, go\nahead and start the simulation.\n\nYou can also start bochs with the -q option to skip these menus.\n\n1. Restore factory default configuration\n2. Read options from...\n3. Edit options\n4. Save options to...\n5. Restore the Bochs state from...\n6. Begin simulation\n7. Quit now\n\nPlease choose one: [6]\n</code></pre>\n<p>bochs é»˜è®¤è¯»å–å½“å‰ç›®å½•ä¸‹ <code>bochsrc.txt</code> æ–‡ä»¶ï¼Œå› æ­¤ä¸éœ€è¦å…¶ä»–é…ç½®ã€‚</p>\n<p>é€‰æ‹© 6 æˆ–è€…ç›´æ¥ <em>å›è½¦</em></p>\n<pre><code class="language-plain">00000000000i[      ] lt_dlhandle is 0x7fef22707270\n00000000000i[PLUGIN] loaded plugin libbx_sdl2.so\n00000000000i[      ] installing sdl2 module as the Bochs GUI\n00000000000i[SDL2  ] maximum host resolution: x=2880 y=1800\n00000000000i[      ] using log file bochsout.txt\nNext at t=0\n(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0\n&#x3C;bochs:1>\n</code></pre>\n<p><img src="https://ws1.sinaimg.cn/large/006tNbRwgy1fuevtktuh0j30zc0tcwfd.jpg"></p>\n<p>ç»ˆç«¯å‡ºç°æ›´å¤šè¾“å‡ºï¼ŒåŒæ—¶ Bochs å¼€å¯äº†ä¸€ä¸ªå¯è§†åŒ–ç»ˆç«¯(å½“ç„¶ï¼Œç°åœ¨è¿˜æ²¡æœ‰ä»»ä½•å†…å®¹)ã€‚</p>\n<p>åœ¨è¿™å„¿è¢«å‘äº†å¥½ä¹…ã€‚æœ¬æ¥ä»¥ä¸º Bochs ä¼šç›´æ¥æ‰§è¡Œ BIOS æŒ‡ä»¤ï¼Œå¯åŠ¨æ“ä½œç³»ç»Ÿï¼Œä½†æ˜¯è‡ªå§‹è‡³ç»ˆï¼Œåœåœ¨è¿™é‡Œå°±æ²¡åŠ¨è¿‡...</p>\n<p>è¿™è¾¹æ˜¯ç”±äº Bochs æœ¬èº«æ˜¯æ”¯æŒè°ƒè¯•çš„(T_Tï¼Œè§é¬¼)ï¼Œå°±åƒæ˜¯ GDB å’Œ LLDB ä¸€æ ·ï¼Œè¿›å…¥è°ƒè¯•åï¼Œéœ€è¦æŒ‡ä»¤ <code>c</code> (continue) æ¥ç»§ç»­æ‰§è¡Œ(å½“ç„¶ï¼Œè¿˜æœ‰å…¶å®ƒè°ƒè¯•å‘½ä»¤)</p>\n<ol start="4">\n<li>é”®å…¥ <code>c</code> </li>\n</ol>\n<pre><code class="language-plain">&#x3C;bochs:1> c\n</code></pre>\n<p>ä»¿çœŸå™¨å¼€å§‹å¼•å¯¼ç¨‹åºçš„åŠ è½½</p>\n<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fuew9zoocuj313c0pstaw.jpg"></p>\n<p>OS Kernel å¯åŠ¨ï¼Œç­‰å¾…ç”¨æˆ·ç™»å½• (é»˜è®¤çš„ç”¨æˆ·æ˜¯ root , æ²¡æœ‰å¯†ç )ã€‚\nä¹‹åå°±å’Œæ™®é€šçš„ Linux æœºå™¨ç±»ä¼¼ï¼Œä¸è¿‡æ”¯æŒçš„å‘½ä»¤æ¯”è¾ƒå°‘ã€‚æ¯•ç«Ÿæ˜¯ä¸€ä¸ªç²¾ç®€åçš„ç³»ç»Ÿã€‚</p>\n<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fuewamqzm6j313q0pqjtw.jpg"></p>\n<ol start="5">\n<li>å…³æœº</li>\n</ol>\n<p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fuewi9wjawj313q0q2gnc.jpg"></p>\n<p>ä»¿çœŸå™¨ä»¿çœŸäº†è®¸å¤šå®ä½“æœºæ¡ˆä»¶ï¼Œå³ä¸Šè§’æœ€åä¸€ä¸ªå°±æ˜¯å…³æœºé”®</p>\n<h2>Docker å®¹å™¨ä¸­è¿è¡Œ Ubuntu</h2>\n<p>è¿™éƒ¨åˆ†ä¸è¯¦è¿°ï¼Œä½œä¸ºä¸€ä¸ªçƒ­é—¨çš„æŠ€æœ¯ï¼Œè¿™æ–¹é¢çš„èµ„æ–™å¾ˆå¤šã€‚Ubuntu ç³»ç»Ÿåªæ˜¯ä¸ºäº†æ¥æ‰§è¡Œä¸€äº› macOS ä¸Šæ²¡æœ‰çš„å‘½ä»¤çš„(æ¯”å¦‚ <code>as86</code>, <code>ld86</code>)</p>\n<p>ç®€è¿°ä¸¤ä¸ª docker å®¹å™¨å’Œå®¿ä¸»æœºé—´å¤åˆ¶æ–‡ä»¶çš„å‘½ä»¤ </p>\n<p>åœ¨å®¿ä¸»æœºä¸‹æ‰§è¡Œå‘½ä»¤:</p>\n<pre><code class="language-sh">docker cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|-\ndocker cp [OPTIONS] SRC_PATH|- CONTAINER:DEST_PATH [flags]\n</code></pre>\n<p>ä¾‹å¦‚:</p>\n<pre><code class="language-sh">docker cp linux:/root/hello.c ./hello.c         # è¿™é‡Œ linux æ˜¯ docker å®¹å™¨å\ndocker cp 92dfc8ad70e1:/root/hello.c ./hello.c  # è¿™é‡Œ 92dfc8ad70e1 æ˜¯ docker å®¹å™¨ ID\n</code></pre>\n<h2>å‚è€ƒ</h2>\n<p>[1]. ä¿ç”²å­. ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»[M]. ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾, 2009.\n[2]. èµµç‚¯. Linuxå†…æ ¸å®Œå…¨æ³¨é‡Š å†…æ ¸ç‰ˆæœ¬0.11 V3.0[EB/OL]. <a href="http://www.oldlinux.org/">http://www.oldlinux.org/</a>, 2007</p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},SqPm:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<h2>èƒŒæ™¯</h2>\n<p>æ˜¨å¤©æ¥è§¦åˆ°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜, å…¬å¸æµ‹è¯•ç¯å¢ƒä¸€å°æœºå™¨ CPU è·‘åˆ°äº† 400%ï¼Œå¯¼è‡´è¯¥æœºå™¨ä¸Šçš„æ‰€æœ‰æœåŠ¡éƒ½æŒ‚æ‰äº†ã€‚</p>\n<p>æœ€åæŸ¥åˆ°çš„åŸå› ç«Ÿç„¶æ˜¯æ­£åˆ™è¡¨è¾¾å¼æ‰€å¼•èµ·çš„ï¼Œå¤§å¤§å‡ºä¹æ„æ–™å•Šã€‚è™½ç„¶æ—©å°±çŸ¥é“æ­£åˆ™æ•ˆç‡å¾ˆå·®ï¼Œä½†ç»å¯¹æ²¡æœ‰æƒ³åˆ°ä¼šå¯¼è‡´æ•´ä¸ªæœºå™¨ä¸ŠæœåŠ¡å´©æºƒçš„æƒ…å†µã€‚</p>\n<p>å…ˆç®€å•å±•ç¤ºä¸‹é—®é¢˜æ­£åˆ™:</p>\n<pre><code class="language-java">String regex = "(\\\\w+,?)+";\nString val = "abcdefghijklmno,abcdefghijklmno+";\nSystem.out.println(val.matches(regex));\n</code></pre>\n<p>æœ€ç»ˆçš„æ‰§è¡Œæ—¶é—´æ˜¯ 17s å·¦å³ã€‚</p>\n<p>ç›¸åï¼Œå¦‚æœæ”¹æˆ <code>String val = "abcdefghijklmno,abcdefghijklmno"</code> ï¼Œå®é™…æ‰§è¡Œæ—¶é—´ 1ms å·¦å³ã€‚</p>\n<p>å“ˆå“ˆï¼Œå®Œå…¨ä¸æ˜¯ä¸€ä¸ªé‡çº§çš„ç»“æœã€‚</p>\n<p>æœ€åï¼Œå½“ç„¶æ˜¯è¦æ‰¾åŸå› äº†:&#x3C; å½“ç„¶ï¼Œæœ‰å…¶å®ƒé‡è¦çš„äº‹åœ¨è€½æï¼Œæ²¡æ—¶é—´å»çœ‹ Java Regex æºç ã€‚ä¸è¿‡ï¼Œä»æ­£åˆ™æœ¬èº«ä¸‹æ‰‹åè€Œæ˜¯ä¸ªå¥½äº‹æƒ…ã€‚æ¯•ç«Ÿå‡ ä¹æ‰€æœ‰çš„ç¼–ç¨‹è¯­è¨€éƒ½æœ‰å¯¹æ­£åˆ™çš„æ”¯æŒã€‚è€ŒåŒæ ·çš„ï¼Œéƒ½å­˜åœ¨ç€è¿™æ ·çš„é—®é¢˜ã€‚é‚£å°±å¯ä»¥å¤§èƒ†çŒœæƒ³å…¶å®æ˜¯å’Œè¯­è¨€æœ¬èº«æ— å…³ï¼Œè€Œåœ¨äºæ­£åˆ™è§„èŒƒæœ¬èº«äº†ã€‚</p>\n<p>å…ˆç»™ä¸ªç»“æœï¼Œç½ªé­ç¥¸é¦–å°±æ˜¯<code>æŒ‡æ•°çˆ†ç‚¸</code></p>\n<h2>è¿½æœ¬æº¯æº</h2>\n<p>è¿™é‡Œå¹¶ä¸å‡†å¤‡ä¸€æ­¥ä¸€æ­¥åœ°é˜è¿°æ­£åˆ™çš„ï¼Œå¦‚æœçœŸçš„æ˜¯é›¶åŸºç¡€çš„è¯ï¼Œæ¨èå…ˆçœ‹ä¸€ä¸‹ <a href="https://github.com/ziishaned/learn-regex/blob/master/README-cn.md">å­¦ä¹ æ­£åˆ™</a></p>\n<p>å°±äº‹è®ºäº‹ï¼Œè¿˜æ˜¯ä»¥ <code>regex ::= (\\w+,?)+</code> ä½œä¸ºç¤ºä¾‹æ¥è¿›è¡Œè¯´æ˜ã€‚</p>\n<p>é¦–å…ˆéœ€è¦äº†è§£çš„æ˜¯ <code>val.matches(regex)</code> æ‰€è¦è¿›è¡Œçš„å·¥ä½œæ˜¯åˆ¤æ–­ <code>val</code> å…¨ä¸²æ˜¯å¦ç¬¦åˆ <code>regex</code> æ­£åˆ™æ¨¡å¼ã€‚è€Œæ­£åˆ™æ‰€è¦åšçš„å·¥ä½œå°±æ˜¯å°è¯•æ‰€æœ‰çš„åŒ¹é…å¯èƒ½æ€§(å½“ç„¶ï¼Œå¯¹äº <code>val</code> è¿™ä¸ªä¸²æ¥è¯´ï¼Œæœ€ååŒ¹é…åˆ° <code>abcd..,abcd..mno+</code> çš„ <code>+</code> çš„æ—¶å€™ä¸€å®šæ˜¯å¤±è´¥çš„ï¼Œå› ä¸º <code>regex</code> å¹¶ä¸åŒ¹é… <code>+</code>)</p>\n<p>ç®€å•æ‰©å±•ä¸€ä¸‹å¯¹<code>å°è¯•æ‰€æœ‰åŒ¹é…å¯èƒ½æ€§</code>è¿™å¥è¯çš„æè¿°:</p>\n<p>æˆ‘ä»¬ä»¥ <code>()</code> å¯¹åº” <code>regex</code> ä¸­çš„ä¸€ç»„ <code>(\\w+,?)</code> ï¼Œè€Œæœ€åä¸€ä¸ª <code>+</code> è¡¨ç¤ºä¸€ä¸ªæˆ–å¤šä¸ª(å³å…è®¸å­˜åœ¨å¤šä¸ª<code>()</code>)</p>\n<p>å¯¹ <code>val</code> ä¸²çš„åŒ¹é…å¯èƒ½æ€§æœ‰</p>\n<ul>\n<li>\n<p>(abcdefghijklmno,)(abcdefghijklmno)+</p>\n</li>\n<li>\n<p>(abcd)(efghijklmno,)(abcdefghijklmno)+</p>\n</li>\n<li>\n<p>(abcdefghijklmno,)(abcdef)(ghijklmno)+</p>\n</li>\n<li>\n<p>(abc)(defghijklmno,)(abcde)(fg)(hijklmno)+</p>\n</li>\n<li>\n<p>...</p>\n</li>\n</ul>\n<p>æœ‰ç›¸å½“å¤šçš„åŒ¹é…å¯èƒ½ï¼Œä¸å†ä¸€ä¸€è¯¦è¿°(äº‹å®ä¸Šï¼Œå…‰é ä¸ªäººæ‰‹å·¥æ ¹æœ¬åˆ—ä¸¾ä¸å®Œã€‚</p>\n<p>é‚£ä¹ˆåˆ°åº•ä¼šæœ‰å¤šå°‘ä¸­åŒ¹é…å¯èƒ½æ€§å‘¢?</p>\n<p>ä¸‹é¢æˆ‘ä»¬å°±æ¥ç®€å•è®¡ç®—ä¸€ä¸‹:</p>\n<p>é¦–å…ˆï¼Œæˆ‘ä»¬æŠŠ <code>(\\w+,?)+</code> è¿™ä¸ªæ­£åˆ™æ‰©å±•ä¸€ä¸‹ï¼Œå®ƒä¸ä¸‹åˆ—è¿™äº›ä¸²éƒ½æ˜¯ç­‰ä»·çš„ <code>(\\w+,|\\w+)+</code>, <code>(\\w+,)?(\\w+)?(\\w+,?)+</code>, <code>(\\w+,)?(\\w+)?(\\w+)?(\\w+,?)+</code> ...</p>\n<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè‡³å°‘æŠŠ <code>abcdefghijklmno,abcdefghijklmno+</code> æŒ‰ç…§åŒ¹é…ä¸²åˆ’åˆ†å‡º1ç»„ï¼Œ2ç»„ï¼Œ3ç»„...30ç»„(å› ä¸ºæ¯ä¸ªç»„è‡³å°‘éœ€è¦ä¸€ä¸ª<code>\\w</code> )</p>\n<p>ä¸è¿‡è¿™ä¸ªæŒ‰ç…§1ç»„ï¼Œ2ç»„...å»è®¡ç®—å¯èƒ½æ€§çš„è¯å®åœ¨æ˜¯è´¹åŠ›ä¸è®¨å¥½çš„äº‹æƒ…ã€‚ç”¨ç»„åˆæ•°å­¦æ¥è€ƒè™‘è¿™ä¸ªé—®é¢˜</p>\n<p>é¦–å…ˆï¼Œæ•´ä¸ª <code>abcdefghijklmno,abcdefghijklmno+</code> çš„å¼€å§‹åº”è¯¥æœ‰ä¸€ä¸ªå·¦æ‹¬å· <code>(</code>ï¼Œå³ <code>(abcdefghijklmno,abcdefghijklmno+</code></p>\n<p>å…¶æ¬¡ï¼Œåˆ° <code>,</code> ä¸ºæ­¢è‡³å°‘åº”è¯¥æœ‰ä¸€ä¸ªå³å·¦æ‹¬å· <code>)(</code>ï¼Œå³ <code>(abcdefghijklmno,)(abcdefghijklmno+</code></p>\n<p>å†æ¬¡ï¼Œç”±äºåˆ° <code>o+</code> ä¸ºæ­¢ä¸€å®šåŒ¹é…å¤±è´¥ï¼Œå› æ­¤ï¼Œ<code>+</code> ä¹‹å‰åº”è¯¥æœ‰ä¸€ä¸ª <code>)</code>, å³ <code>(abcdefghijklmno,)(abcdefghijklmno)+</code></p>\n<p>è‡³äºå…¶ä»–å­—ç¬¦é—´çš„ç©ºéš™ï¼Œé™¤äº† <code>o,</code> ä¹‹é—´ä¸èƒ½å­˜åœ¨å³å·¦æ‹¬å· <code>)(</code> ï¼Œå…¶ä»–å­—ç¬¦é—´éƒ½å¯ä»¥éšæ„æ’å…¥ <code>)(</code> (è‡³äºä¸ºä»€ä¹ˆæ˜¯å³å·¦æ‹¬å·ï¼Œè¡¨ç¤ºå‰ä¸€ä¸ªç»„çš„ç»“æŸä¸æ–°çš„ç»„çš„å¼€å§‹)</p>\n<p>é‚£ä¹ˆæ€»å…±æœ‰å¤šå°‘ç§å¯èƒ½? </p>\n<ul>\n<li>\n<p>æ’å…¥é›¶ä¸ªå³å·¦æ‹¬å· <code>)(</code> , $C_{28}^0$ = 1 ç§å¯è¡Œæ–¹æ¡ˆ</p>\n</li>\n<li>\n<p>æ’å…¥ä¸€ä¸ªå³å·¦æ‹¬å· <code>)(</code> , $C_{28}^1$ = 28 ç§å¯è¡Œæ–¹æ¡ˆ (æ€»å…± 28 ä¸ªå¯ç”¨å­—ç¬¦é—´éš™)</p>\n</li>\n<li>\n<p>æ’å…¥ä¸¤ä¸ªå³å·¦æ‹¬å· <code>)(</code> , $C_{28}^2$ ç§å¯è¡Œæ–¹æ¡ˆ</p>\n</li>\n<li>\n<p>...</p>\n</li>\n<li>\n<p>æ’å…¥28ä¸ªå³å·¦æ‹¬å· <code>)(</code> , $C_{28}^{28}$ ç§å¯è¡Œæ–¹æ¡ˆ</p>\n</li>\n</ul>\n<p>ç´¯åŠ çš„ç»“æœä¸º $C_{28}^1 + C_{28}^2 + C_{28}^3 + ... + C_{28}^{28} = 2^{28}$</p>\n<p>å¯æƒ³è€ŒçŸ¥ä¸ºä»€ä¹ˆä¼šèŠ± 17s äº†å§ã€‚æ¯•ç«Ÿè¾¾åˆ°äº† 2500 ä¸‡ä»¥ä¸Šçš„è®¡ç®—é‡çº§ï¼ŒåŠ ä¸Š regex æœ¬èº«å°±æ˜¯åæ…¢çš„ã€‚</p>\n<p>è‡³äºä¸ºä»€ä¹ˆæŠŠ <code>abcdefghijklmno,abcdefghijklmno+</code> ä¸²çš„ <code>+</code> å»æ‰å°±å˜å¿«äº†ï¼Ÿç†ç”±ä¹Ÿå¾ˆç®€å•ï¼Œ<code>matches(regex)</code> åœ¨æ­£åˆ™ä¸²ä¸åŸä¸²åŒ¹é…ä¸Šä¹‹åå°±ä¼šå¿«é€Ÿç»“æŸï¼Œå› ä¸ºç»“æœåªéœ€è¦å‘ŠçŸ¥æŸæ¬¡åŒ¹é…æˆåŠŸäº†å³å¯ã€‚è€Œå¤±è´¥çš„åŒ¹é…ä¼šä¸æ–­åœ°å°è¯•æ‰€æœ‰çš„å¯èƒ½æ€§ã€‚</p>\n<h2>è§£å†³æ–¹æ¡ˆ</h2>\n<p>è‡³äºè§£å†³æ–¹æ¡ˆï¼Œä»ä¸Šé¢çš„åŸå› å°±å¯ä»¥çœ‹åˆ°ï¼Œæ‹’ç»åœ¨è´ªå©ªç»„æ¨¡å¼ä¸‹(<code>(...)+</code>) çš„ç»„å†…å¤šæ¨¡å¼åŒ¹é…å¯èƒ½ã€‚å³ <code>(a+a+)+</code> æ˜¯ä¸èƒ½è¢«å…è®¸çš„ï¼Œè€Œ <code>(a+b+)+</code> æ˜¯å¯é çš„ã€‚</p>\n<p>å†™å¾—ä»“ä¿ƒï¼Œå¦‚æœ‰æ ¹æºæ€§é”™è¯¯ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚</p>\n<h2>å‚è€ƒ</h2>\n<p><a href="https://www.regular-expressions.info/catastrophic.html">Catastrophic Backtracking(ç¾éš¾æ€§å›æº¯)</a></p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},U8rl:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>åœ¨è¿›è¡Œ<a href="https://www.ffutop.com/2018-10-12-understand-Kernel-4/">ç¬¬å››ç¯‡(ä»»åŠ¡è°ƒåº¦)</a>è¡Œæ–‡æè¿°æ—¶ï¼Œå°±ä¸€ç›´é—¹ä¸æ¸…å†…æ ¸æ‰€è°“çš„<code>task</code>çš„æ¦‚å¿µã€‚ä¹‹å‰ä¸€ç›´å°†å…¶ä¸è¿›ç¨‹(process)çš„æ¦‚å¿µç­‰åŒè§†ä¹‹ã€‚ä½†è¿™åˆå¯¼è‡´äº†çº¿ç¨‹çš„æ¦‚å¿µæ— å¤„å®‰ç½®ï¼ˆæ¯•ç«Ÿåœ¨è®¡ç®—æœºç§‘å­¦çš„æ¦‚å¿µä¸­ï¼Œçº¿ç¨‹ä½œä¸ºè¿›ç¨‹çš„å­é›†å­˜åœ¨ï¼Œè´Ÿè´£ç¨‹åºæ‰§è¡Œï¼‰ã€‚ä¸è¿‡ï¼Œç°åœ¨è¿™ä¸ªç–‘æƒ‘æ€»ç®—å¾—åˆ°äº†åˆç†çš„è§£é‡Šï¼š<strong>æˆ‘ä»¬é”™è¯¯åœ°å°†ç†è®ºå’Œå®è·µä¸åŠ åŒºåˆ†åœ°æ··æ·†äº†</strong>ã€‚å†…æ ¸å¼€å‘ç¤¾åŒºä¸å­¦æœ¯ç•Œçš„åˆä½œåœ¨æ•´ä¸ªå†…æ ¸å¼€å‘å†å²ä¸Šå¹¶æ²¡æœ‰æƒ³è±¡ä¸­çš„é¢‘ç¹ï¼Œæ­£ç›¸åï¼Œå­¦æœ¯ç•Œå¯¹å†…æ ¸ä»£ç çš„è´¡çŒ®ä¸åˆ°1%[1]ã€‚å¦‚æœæƒ³è¦å°†è¿›ç¨‹/çº¿ç¨‹çš„æ€æƒ³ä»£å…¥å†…æ ¸ï¼Œå¹¶é€ä¸€å°è¯ï¼Œé‚£ä¹ˆè¿‡ç¨‹å°†éå¸¸ç—›è‹¦å¹¶æœ€ç»ˆä¸€æ— æ‰€è·ã€‚æ‰€è°“è¿›ç¨‹/çº¿ç¨‹ï¼Œåœ¨å†…æ ¸ä¸­åªæœ‰ä¸€ä¸ªæ¦‚å¿µâ€”â€”æ‰§è¡Œçš„ä¸Šä¸‹æ–‡(Context of Execution)ï¼Œä»»ä½•æƒ³è¦å¯¹è¿›ç¨‹/çº¿ç¨‹æ¦‚å¿µè¿›è¡ŒåŒºåˆ†çš„è¡Œä¸ºéƒ½å°†æ˜¯ä½œèŒ§è‡ªç¼š[2]ã€‚åŒæ—¶ï¼Œ<code>task</code> ä¹Ÿå°±æ˜¯ <code>Context of Execution</code> æ¦‚å¿µåœ¨å®ç°ä¸Šçš„è¡¨å¾ã€‚</p>\n<p>æ‰§è¡Œçš„ä¸Šä¸‹æ–‡(Context of Execution, COE)ï¼Œè®°å½•äº†æ‰€æœ‰ç¨‹åºæ‰§è¡Œä¸­çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬ï¼šCPUçŠ¶æ€ï¼ˆå¯„å­˜å™¨ä¿¡æ¯ç­‰ï¼‰ã€MMUçŠ¶æ€ï¼ˆé¡µæ˜ å°„ï¼‰ã€æƒé™çŠ¶æ€ï¼ˆuidã€gidç­‰ï¼‰å’Œä¸€äº›å…¬å…±å±æ€§ï¼ˆæ‰“å¼€çš„æ–‡ä»¶ã€ä¿¡å·å¤„ç†å‡½æ•°ç­‰ï¼‰ã€‚å¯¹æ¯”ç†è®ºä¸Šçš„è¿›ç¨‹/çº¿ç¨‹æ¦‚å¿µï¼Œç²—ç•¥åœ°è®²å°±æ˜¯åŒä¸€çº¿ç¨‹ç»„çš„çº¿ç¨‹å„è‡ªæŒæœ‰CPUçŠ¶æ€è€Œå…±äº«å…¶å®ƒçŠ¶æ€ï¼Œè€Œè®¤ä¸ºä¸¤è¿›ç¨‹ä¸å…±äº«ä»»ä½•çŠ¶æ€ã€‚å½“ç„¶ï¼Œåœ¨å†…æ ¸çš„æ¦‚å¿µé‡Œï¼Œè¿›ç¨‹/çº¿ç¨‹åªæ˜¯COEå…±äº«éƒ¨åˆ†çŠ¶æ€ä¸­çš„ä¸€ä¸ªç‰¹ä¾‹ã€‚</p>\n<h2>fork, clone</h2>\n<p>å¦‚æœç”¨è¿›ç¨‹/çº¿ç¨‹çš„æ¦‚å¿µæ¥çœ‹ï¼Œå†…æ ¸æä¾›äº† <code>fork</code> æ¥å®Œæˆè¿›ç¨‹çš„å¤åˆ¶ï¼Œæä¾›äº† <code>clone</code> æ¥å¤„ç†çº¿ç¨‹çš„æ‹·è´ï¼Œå¦å¤–è¿˜æœ‰ <code>vfork</code> , <code>kernel_thread</code> ç­‰ã€‚</p>\n<p><strong>syscall fork</strong></p>\n<pre><code class="language-c">asmlinkage int sys_fork(struct pt_regs regs)\n{\n    return do_fork(SIGCHLD, regs.esp, &#x26;regs, 0, NULL, NULL);\n}\n</code></pre>\n<p><strong>syscall clone</strong></p>\n<pre><code class="language-c">asmlinkage int sys_clone(struct pt_regs regs)\n{\n    unsigned long clone_flags;\n    unsigned long newsp;\n    int __user *parent_tidptr, *child_tidptr;\n    \n    clone_flags = regs.ebx;\n    newsp = regs.ecx;\n    parent_tidptr = (int __user *)regs.edx;\n    child_tidptr = (int __user *)regs.edi;\n    if (!newsp)\n        newsp = regs.esp;\n    return do_fork(clone_flags, newsp, &#x26;regs, 0, parent_tidptr, child_tidptr);\n}\n</code></pre>\n<p><strong>syscall vfork</strong></p>\n<pre><code class="language-c">asmlinkage int sys_vfork(struct pt_regs regs)\n{\n    return do_fork(CLONE_VFORK | CLONE_VM | SIGCHLD, regs.esp, &#x26;regs, 0, NULL, NULL);\n}\n</code></pre>\n<p><strong>kernel function: kernel_thread</strong></p>\n<pre><code class="language-c">int kernel_thread(int (*fn)(void *), void * arg, unsigned long flags)\n{\n    // ...\n    return do_fork(flags | CLONE_VM | CLONE_UNTRACED, 0, &#x26;regs, 0, NULL, NULL);\n}\n</code></pre>\n<p><code>fork</code>, <code>clone</code>, <code>vfork</code> çš„å…¥å‚æ€ä¹ˆå’Œæ—¥å¸¸ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨å…¥å‚ä¸åŒï¼Ÿä¸”çœ‹ï¼š</p>\n<pre><code class="language-c">    .macro PTREGSCALL label, func, arg\n    .globl \\label\n\\label:\n    leaq \\func(%rip),%rax\n    leaq -ARGOFFSET+8(%rsp),\\arg    /* 8 for return address */\n    jmp  ia32_ptregs_common\n    .endm\n\n    CFI_STARTPROC32\n\n    PTREGSCALL stub32_rt_sigreturn, sys32_rt_sigreturn, %rdi\n    PTREGSCALL stub32_sigreturn, sys32_sigreturn, %rdi\n    PTREGSCALL stub32_sigaltstack, sys32_sigaltstack, %rdx\n    PTREGSCALL stub32_sigsuspend, sys32_sigsuspend, %rcx\n    PTREGSCALL stub32_execve, sys32_execve, %rcx\n    PTREGSCALL stub32_fork, sys_fork, %rdi\n    PTREGSCALL stub32_clone, sys32_clone, %rdx\n    PTREGSCALL stub32_vfork, sys_vfork, %rdi\n    PTREGSCALL stub32_iopl, sys_iopl, %rsi\n    PTREGSCALL stub32_rt_sigsuspend, sys_rt_sigsuspend, %rdx\n\nENTRY(ia32_ptregs_common)\n    popq %r11\n    CFI_ENDPROC\n    CFI_STARTPROC32 simple\n    CFI_SIGNAL_FRAME\n    CFI_DEF_CFA rsp,SS+8-ARGOFFSET\n    CFI_REL_OFFSET  rax,RAX-ARGOFFSET\n    CFI_REL_OFFSET  rcx,RCX-ARGOFFSET\n    CFI_REL_OFFSET  rdx,RDX-ARGOFFSET\n    CFI_REL_OFFSET  rsi,RSI-ARGOFFSET\n    CFI_REL_OFFSET  rdi,RDI-ARGOFFSET\n    CFI_REL_OFFSET  rip,RIP-ARGOFFSET\n/*  CFI_REL_OFFSET  cs,CS-ARGOFFSET*/\n/*  CFI_REL_OFFSET  rflags,EFLAGS-ARGOFFSET*/\n    CFI_REL_OFFSET  rsp,RSP-ARGOFFSET\n/*  CFI_REL_OFFSET  ss,SS-ARGOFFSET*/\n    SAVE_REST\n    call *%rax\n    RESTORE_REST\n    jmp  ia32_sysret    /* misbalances the return cache */\n    CFI_ENDPROC\nEND(ia32_ptregs_common)\n</code></pre>\n<p>è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶çš„å¤„ç†é€»è¾‘ç»Ÿä¸€åœ°å°†è¿™äº›å†…å®¹è¿›è¡Œäº†æ•´åˆï¼Œå¹¶å°†CPUçŠ¶æ€ï¼ˆæ‰€æœ‰é€šç”¨å¯„å­˜å™¨çŠ¶æ€ï¼‰ç»´æŠ¤åˆ° <code>struct pt_regs</code> æ•°æ®å—ä¸­ã€‚æ€»ç»“èµ·æ¥ï¼Œä¸‰ç§ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆéƒ½å§”æ‰˜ç»™ <code>do_fork</code> è¿›è¡Œå®ç°ï¼Œåªæ˜¯åœ¨å‚æ•°çš„é€‰æ‹©æ–¹é¢åšäº†ä¸åŒçš„é¢„å¤„ç†ã€‚è¿™åœ¨ç”¨æˆ·å±‚çš„å‡½æ•°åŸå‹ä¸Šå°±æ›´ä¸ºæ˜æ˜¾ï¼Œ<code>fork</code> å’Œ <code>vfork</code> éƒ½ä¸å…è®¸å‚æ•°çš„è°ƒç”¨ã€‚</p>\n<pre><code class="language-c">pid_t fork(void);\n\n/* for x86-32 */\nlong clone(unsigned long flags, void *child_stack,\n        int *ptid, unsigned long newtls,\n        int *ctid);\n\npid_t vfork(void);\n</code></pre>\n<p>å†çœ‹çœ‹ <code>flags</code> æœ‰å“ªäº›å€¼å¯é€‰ã€‚</p>\n<pre><code class="language-c">/*\n * cloning flags:\n */\n#define CSIGNAL     0x000000ff  /* signal mask to be sent at exit */\n#define CLONE_VM    0x00000100  /* set if VM shared between processes */\n#define CLONE_FS    0x00000200  /* set if fs info shared between processes */\n#define CLONE_FILES 0x00000400  /* set if open files shared between processes */\n#define CLONE_SIGHAND   0x00000800  /* set if signal handlers and blocked signals shared */\n#define CLONE_PTRACE    0x00002000  /* set if we want to let tracing continue on the child too */\n#define CLONE_VFORK 0x00004000  /* set if the parent wants the child to wake it up on mm_release */\n#define CLONE_PARENT    0x00008000  /* set if we want to have the same parent as the cloner */\n#define CLONE_THREAD    0x00010000  /* Same thread group? */\n#define CLONE_NEWNS 0x00020000  /* New namespace group? */\n#define CLONE_SYSVSEM   0x00040000  /* share system V SEM_UNDO semantics */\n#define CLONE_SETTLS    0x00080000  /* create a new TLS for the child */\n#define CLONE_PARENT_SETTID 0x00100000  /* set the TID in the parent */\n#define CLONE_CHILD_CLEARTID    0x00200000  /* clear the TID in the child */\n#define CLONE_DETACHED      0x00400000  /* Unused, ignored */\n#define CLONE_UNTRACED      0x00800000  /* set if the tracing process can\'t force CLONE_PTRACE on this clone */\n#define CLONE_CHILD_SETTID  0x01000000  /* set the TID in the child */\n#define CLONE_STOPPED       0x02000000  /* Start in stopped state */\n#define CLONE_NEWUTS        0x04000000  /* New utsname group? */\n#define CLONE_NEWIPC        0x08000000  /* New ipcs */\n#define CLONE_NEWUSER       0x10000000  /* New user namespace */\n#define CLONE_NEWPID        0x20000000  /* New pid namespace */\n#define CLONE_NEWNET        0x40000000  /* New network namespace */\n</code></pre>\n<p><code>xxx shared between processes</code> ï¼Œæè¿°å³å°†è¢«åˆ›å»ºçš„æ–°ä»»åŠ¡å°†è¿›è¡Œå“ªäº›çŠ¶æ€/èµ„æºçš„å…±äº«ï¼Œè€Œå“ªäº›çŠ¶æ€éœ€è¦è¿›è¡Œæ‹·è´ã€‚</p>\n<h3><code>do_fork</code></h3>\n<p>å…ˆçœ‹çœ‹æ ¸å¿ƒçš„ <code>do_fork</code> çš„é€»è¾‘ã€‚</p>\n<p><em>Hint: ä¸‹åˆ—ä»£ç ç»è¿‡å¤§é‡çš„åˆ å‡</em></p>\n<pre><code class="language-c">long do_fork(unsigned long clone_flags,\n        unsigned long stack_start,\n        struct pt_regs *regs,\n        unsigned long stack_size,\n        int __user *parent_tidptr,\n        int __user *child_tidptr)\n{\n    p = copy_process(clone_flags, stack_start, regs, stack_size, child_tidptr, NULL);\n    if (!IS_ERR(p)) {\n        nr = (clone_flags &#x26; CLONE_NEWPID) ?\n            task_pid_nr_ns(p, current->nsproxy->pid_ns) :\n                task_pid_vnr(p);\n        if (!(clone_flags &#x26; CLONE_STOPPED))\n            wake_up_new_task(p, clone_flags);\n        else\n            p->state = TASK_STOPPED;\n    } else {\n        nr = PTR_ERR(p);\n    }\n    return nr;\n}\n</code></pre>\n<pre><code class="language-c">static struct task_struct *copy_process(unsigned long clone_flags,\n                    unsigned long stack_start,\n                    struct pt_regs *regs,\n                    unsigned long stack_size,\n                    int __user *child_tidptr,\n                    struct pid *pid)\n{\n    /* é¢„åˆ†é… task_struct æ•°æ®ç»“æ„ç©ºé—´ */\n    retval = security_task_create(clone_flags);\n    /* å¤åˆ¶ current çš„ task_struct æ•°æ®ç»“æ„ */\n    p = dup_task_struct(current);\n\n    if (nr_threads >= max_threads)\n        goto bad_fork_cleanup_count;\n\n    /* é’ˆå¯¹å¤šæ ¸CPUï¼Œä¸ºæ–°ä»»åŠ¡åˆ†é…CPU */\n    sched_fork(p, clone_flags);\n    /* å¤åˆ¶ thread_info æ•°æ®ç»“æ„åŠçº¿ç¨‹æ ˆ */\n    retval = copy_thread(0, clone_flags, stack_start, stack_size, p, regs);\n\n    /* åˆ†é…æ–°çš„ pid */\n    p->pid = pid_nr(pid);\n    /* thread group id = new pid */\n    p->tgid = p->pid;\n    /* å¦‚æœæ ‡å¿—æ˜¯ CLONE_THREADï¼Œtgid = çˆ¶ä»»åŠ¡id */\n    if (clone_flags &#x26; CLONE_THREAD)\n        p->tgid = current->tgid;\n\n    p->set_child_tid = (clone_flags &#x26; CLONE_CHILD_SETTID) ? child_tidptr : NULL;\n    p->clear_child_tid = (clone_flags &#x26; CLONE_CHILD_CLEARTID) ? child_tidptr: NULL;\n    /*\n     * sigaltstack should be cleared when sharing the same VM\n     */\n    if ((clone_flags &#x26; (CLONE_VM|CLONE_VFORK)) == CLONE_VM)\n        p->sas_ss_sp = p->sas_ss_size = 0;\n\n    /* ok, now we should be set up.. */\n    p->exit_signal = (clone_flags &#x26; CLONE_THREAD) ? -1 : (clone_flags &#x26; CSIGNAL);\n    p->pdeath_signal = 0;\n    p->exit_state = 0;\n\n    /*\n     * Ok, make it visible to the rest of the system.\n     * We dont wake it up yet.\n     */\n    p->group_leader = p;\n    INIT_LIST_HEAD(&#x26;p->thread_group);\n    INIT_LIST_HEAD(&#x26;p->ptrace_children);\n    INIT_LIST_HEAD(&#x26;p->ptrace_list);\n\n    p->cpus_allowed = current->cpus_allowed;\n    if (unlikely(!cpu_isset(task_cpu(p), p->cpus_allowed) ||\n            !cpu_online(task_cpu(p))))\n        set_task_cpu(p, smp_processor_id());\n\n    /* CLONE_PARENT re-uses the old parent */\n    if (clone_flags &#x26; (CLONE_PARENT|CLONE_THREAD))\n        p->real_parent = current->real_parent;\n    else\n        p->real_parent = current;\n    p->parent = p->real_parent;\n\n    spin_lock(&#x26;current->sighand->siglock);\n\n    if (clone_flags &#x26; CLONE_THREAD) {\n        p->group_leader = current->group_leader;\n        list_add_tail_rcu(&#x26;p->thread_group, &#x26;p->group_leader->thread_group);\n\n        if (!cputime_eq(current->signal->it_virt_expires,\n                cputime_zero) ||\n            !cputime_eq(current->signal->it_prof_expires,\n                cputime_zero) ||\n            current->signal->rlim[RLIMIT_CPU].rlim_cur != RLIM_INFINITY ||\n            !list_empty(&#x26;current->signal->cpu_timers[0]) ||\n            !list_empty(&#x26;current->signal->cpu_timers[1]) ||\n            !list_empty(&#x26;current->signal->cpu_timers[2])) {\n            /*\n             * Have child wake up on its first tick to check\n             * for process CPU timers.\n             */\n            p->it_prof_expires = jiffies_to_cputime(1);\n        }\n    }\n\n    if (likely(p->pid)) {\n        add_parent(p);\n        if (unlikely(p->ptrace &#x26; PT_PTRACED))\n            __ptrace_link(p, current->parent);\n\n        if (thread_group_leader(p)) {\n            if (clone_flags &#x26; CLONE_NEWPID)\n                p->nsproxy->pid_ns->child_reaper = p;\n\n            p->signal->tty = current->signal->tty;\n            set_task_pgrp(p, task_pgrp_nr(current));\n            set_task_session(p, task_session_nr(current));\n            attach_pid(p, PIDTYPE_PGID, task_pgrp(current));\n            attach_pid(p, PIDTYPE_SID, task_session(current));\n            list_add_tail_rcu(&#x26;p->tasks, &#x26;init_task.tasks);\n            __get_cpu_var(process_counts)++;\n        }\n        attach_pid(p, PIDTYPE_PID, pid);\n        nr_threads++;\n    }\n\n    total_forks++;\n    spin_unlock(&#x26;current->sighand->siglock);\n    write_unlock_irq(&#x26;tasklist_lock);\n    proc_fork_connector(p);\n    cgroup_post_fork(p);\n    return p;\n}\n</code></pre>\n<p>æ ¹æ®å…¥å‚é…ç½®çš„ <code>flags</code> ï¼Œ<code>copy_process</code> ç¡®å®šäº†æ–°ä»»åŠ¡ä¸çˆ¶ä»»åŠ¡å…±äº«çš„çŠ¶æ€ï¼Œä»¥åŠä¸€äº›éœ€è¦æ‹·è´çš„çŠ¶æ€ã€‚</p>\n<ul>\n<li><code>fork</code> äº§ç”Ÿä¸€ä¸ªæ–°çš„ä»»åŠ¡ï¼Œä¸çˆ¶ä»»åŠ¡ä¸å­˜åœ¨ä»»ä½•èµ„æºå…±äº«çš„æƒ…å†µã€‚</li>\n<li><code>clone</code> å¯é«˜åº¦å®šåˆ¶åŒ–çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå‡ ä¹å¯ä»¥è‡ªç”±ç»„åˆå®šåˆ¶æ–°çš„ä»»åŠ¡</li>\n<li><code>vfork</code> å†å²åŸå› è€Œå­˜åœ¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè®¾è®¡ç›®çš„åœ¨äºä¸€èˆ¬ <code>fork</code> ä¹‹åéƒ½å°†è°ƒç”¨ <code>execve</code> æ¥æ‰§è¡Œå…¨æ–°çš„ä»»åŠ¡ï¼Œä¹Ÿå°±å¯¼è‡´äº† <code>fork</code> æ‰€åšçš„æ‹·è´å…¨éƒ¨ç™½è´¹ï¼Œå› æ­¤æäº†ä¸ªè½»é‡çº§çš„ <code>vfork</code> æ¥é¿å…åšå†…å­˜çš„æ‹·è´ã€‚</li>\n</ul>\n<blockquote>\n<p><strong>VFORK</strong>\nHistoric description\nUnder Linux, fork(2) is implemented using copy-on-write pages, so the only penalty incurred by fork(2) is the time and memory required to duplicate the  parent\'s page tables, and to create a unique task structure for the child.  However, in the bad old days a fork(2) would require making a complete copy of the caller\'s data space, often needlessly, since usually immediately afterward an exec(3) is done.  Thus, for greater efficiency, BSD introduced  the  vfork() system call, which did not fully copy the address space of the parent process, but borrowed the parent\'s memory and thread of control until a call to execve(2) or an exit occurred.  The parent process was suspended while the child was using its resources.   The  use  of vfork() was tricky: for example, not modifying data in the parent process depended on knowing which variables were held in a register.</p>\n</blockquote>\n<h2>pid, tgid</h2>\n<pre><code class="language-c">/* åˆ†é…æ–°çš„ pid */\np->pid = pid_nr(pid);\n/* thread group id = new pid */\np->tgid = p->pid;\n/* å¦‚æœæ ‡å¿—æ˜¯ CLONE_THREADï¼Œtgid = çˆ¶ä»»åŠ¡id */\nif (clone_flags &#x26; CLONE_THREAD)\n    p->tgid = current->tgid;\n</code></pre>\n<p><code>pid</code> ä½œä¸ºæ¯ä¸ª <code>task</code> çš„å”¯ä¸€æ ‡è¯†ç¬¦å­˜åœ¨ã€‚<code>tgid</code> ç”¨äºæŒ‡ä»£çº¿ç¨‹ç»„idï¼Œä»ä»£ç ä¸Šçœ‹ä¹Ÿå°±æ˜¯è¿›ç¨‹ä¸»çº¿ç¨‹idã€‚ï¼ˆè¯·åŸè°…æˆ‘åˆç”¨äº†è¿›ç¨‹/çº¿ç¨‹çš„è¡¨è¿°ï¼‰</p>\n<p>çœ‹ç€æ²¡æœ‰é—®é¢˜ï¼Ÿå½“ç„¶ä¸å¯èƒ½ã€‚è¿™æ®µä»£ç å¯æ˜¯æ„å‘³ç€ <code>pid</code> å”¯ä¸€å•Šï¼Œè¿™å¯ä¸ç¬¦åˆæ—¥å¸¸è¡¨è¿°å•Šã€‚å¯¹äºç³»ç»Ÿçš„ç»ˆç«¯ç”¨æˆ·æ¥è®²ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ã€‚<code>pid</code> å¯æ˜¯ä¸€ç›´è¢«ç¿»è¯‘æˆè¿›ç¨‹ID(process id)ã€‚éš¾é“ï¼Ÿ</p>\n<p>è¿™å°±æ˜¯æœ¬è´¨å®ç°ä¸è¡¨é¢åŠŸå¤«çš„å·®åˆ«å•¦ã€‚<code>pid_t getpid(void);</code>, <code>pid_t gettid(void);</code> ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨åˆ†åˆ«è¢«ç”¨æ¥æä¾›è¿›ç¨‹IDå’Œçº¿ç¨‹IDï¼ˆè¯·ä»”ç»†æ€è€ƒä¸‹ä»£ç å®ç°å’Œå¯¹å¤–å±•ç¤ºçš„å·®è·ï¼‰ã€‚</p>\n<pre><code class="language-c">/**\n * sys_getpid - return the thread group id of the current process\n *\n * Note, despite the name, this returns the tgid not the pid.  The tgid and\n * the pid are identical unless CLONE_THREAD was specified on clone() in\n * which case the tgid is the same in all threads of the same group.\n *\n * This is SMP safe as current->tgid does not change.\n */\nasmlinkage long sys_getpid(void)\n{\n    return task_tgid_vnr(current);\n}\n</code></pre>\n<pre><code class="language-c">/* Thread ID - the internal kernel "pid" */\nasmlinkage long sys_gettid(void)\n{\n    return task_pid_vnr(current);\n}\n</code></pre>\n<p>è¿™æ ·å°±å¥½æ‡‚å¤šäº†å§ã€‚ç”¨æˆ·æ€é€šè¿‡ç³»ç»Ÿè°ƒç”¨å–åˆ°çš„ <code>pid</code>, <code>tid</code> å·²ç»ç»è¿‡äº†ä¸€å±‚åŠ å·¥ï¼Œåˆ†åˆ«æ˜ å°„ç€å†…æ ¸å®ç°çš„ <code>tgid</code>, <code>pid</code> ã€‚</p>\n<p><em>é¢å¤–åœ°ï¼šæƒ³é€šè¿‡ <code>ps</code> æŸ¥çœ‹è¿›ç¨‹/çº¿ç¨‹å¯ä»¥ä½¿ç”¨ <code>ps -eLf</code></em></p>\n<h2>schedule</h2>\n<p>å†æ¥å›é¡¾ä¸‹ä»»åŠ¡è°ƒåº¦æ˜¯å¦‚ä½•å®ç°çš„ã€‚ä¸<a href="https://www.ffutop.com/2018-10-12-understand-Kernel-4/">ç¬¬å››ç¯‡ ä»»åŠ¡è°ƒåº¦</a>æè¿°çš„å¹¶æ— å¤ªå¤§ä¸åŒã€‚è¦è¯´æœ€å¤§çš„åŒºåˆ†ï¼Œå°±æ˜¯æ—©æœŸç‰ˆæœ¬ä¸æ—¶ä¸‹ç‰ˆæœ¬é¡ºæ—¶çš„æ¼”è¿›ã€‚å½“ç„¶ï¼Œè¿˜æœ‰å°±æ˜¯å¤šæ ¸CPUä¸‹çš„SMPè°ƒåº¦ã€‚</p>\n<p>è‡³äºå¤šæ ¸ä¸‹çš„æ‰€è°“è¿›ç¨‹/çº¿ç¨‹å¦‚ä½•è°ƒåº¦ã€‚å†…æ ¸æ ¹æœ¬è®¤è¯†ä¸åˆ°è¿›ç¨‹/çº¿ç¨‹çš„æ¦‚å¿µï¼Œå”¯ä¸€çš„åªæœ‰ä»»åŠ¡(task, or COE)ã€‚è€Œæ¯ä¸ªç”¨æˆ·æ‰€è®¤ä¸ºçš„çº¿ç¨‹åœ¨å†…æ ¸çš„è®¤è¯†ä¸‹ä¹Ÿæ˜¯ä¸€ä¸ªä»»åŠ¡ã€‚å› æ­¤ï¼Œæ‰€è°“ç”¨æˆ·è®¤è¯†åˆ°çš„å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œåœ¨å¤šæ ¸CPUä¸‹ä¹Ÿå°±å®Œå…¨æ˜¯å¯è¡Œçš„ã€‚</p>\n<h2>concept of Thread</h2>\n<p>ä¸”ä¸è®ºLinuxå†…æ ¸æ²¡æœ‰çº¿ç¨‹æ¦‚å¿µçš„å‰æï¼Œçº¿ç¨‹çš„å®šä¹‰æ€»æ˜¯å­˜åœ¨çš„ï¼Œè€Œæ»¡è¶³å…¶å®šä¹‰çš„å®ç°ï¼Œä¹Ÿå°±å¯ä»¥è¢«ç§°ä¸ºâ€œçº¿ç¨‹â€ã€‚å“ªäº›è¦ç´ ç»„æˆäº†çº¿ç¨‹å‘¢ï¼Ÿ</p>\n<ol>\n<li>çº¿ç¨‹æ˜¯ä¸å…¶å®ƒä»£ç å…±äº«è¿›ç¨‹åœ°å€ç©ºé—´çš„æœ€å°æ‰§è¡Œæµ</li>\n<li>è¯¸å¦‚æ ˆã€å¯„å­˜å™¨ä¿¡æ¯ã€æœ¬åœ°çº¿ç¨‹æ•°æ®éœ€è¦ä¿æŒç‹¬ç«‹</li>\n<li>äº’æ–¥é”(Mutex)ã€æ¡ä»¶å˜é‡(Condition Variable)ã€çº¿ç¨‹é—´åŒæ­¥ç®¡ç†çš„æ”¯æŒ</li>\n<li>...</li>\n</ol>\n<p>æ—¢ç„¶éƒ½è¯´äº†Linuxå†…æ ¸æ²¡æœ‰çº¿ç¨‹æ¦‚å¿µï¼Œç°åœ¨å´åˆå¼€å§‹æï¼Œè¿™ä¸æ˜¯æ‰“è„¸å˜›ï¼ŸOKï¼Œå…·ä½“æƒ…å†µæ˜¯ï¼šå†…æ ¸æœ¬èº«ä¸æ”¯æŒçº¿ç¨‹ï¼Œç”šè‡³æ²¡æœ‰çº¿ç¨‹æ¦‚å¿µã€‚ä½†å…¶é€šè¿‡GLIBCçš„NPTL(Native POSIX Thread Library)æ”¯æŒäº†çº¿ç¨‹ã€‚</p>\n<blockquote>\n<p>åœ¨Linuxå†…æ ¸2.6å‡ºç°ä¹‹å‰ä»»åŠ¡æ˜¯(æœ€å°)å¯è°ƒåº¦çš„å¯¹è±¡ï¼Œå½“æ—¶çš„Linuxä¸çœŸæ­£æ”¯æŒçº¿ç¨‹ã€‚ä½†æ˜¯Linuxå†…æ ¸æœ‰ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤<code>clone()</code>ï¼Œè¿™ä¸ªæŒ‡ä»¤å°†äº§ç”Ÿä¸€ä¸ªè°ƒç”¨æ–¹ä»»åŠ¡çš„æ‹·è´ï¼Œè€Œä¸”è¿™ä¸ªæ‹·è´å¯ä»¥ä¸åŸä»»åŠ¡ä½¿ç”¨åŒä¸€åœ°å€ç©ºé—´ã€‚LinuxThreadsè®¡åˆ’ä½¿ç”¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ¥æä¾›ä¸€ä¸ªå†…æ ¸çº§åˆ«çš„çº¿ç¨‹æ”¯æŒã€‚ä½†æ˜¯è¿™ä¸ªè§£å†³æ–¹æ³•ä¸çœŸæ­£çš„POSIXæ ‡å‡†æœ‰ä¸€äº›ä¸å…¼å®¹çš„åœ°æ–¹ï¼Œå°¤å…¶æ˜¯åœ¨ä¿¡å·å¤„ç†ã€è¿›ç¨‹è°ƒåº¦å’Œè¿›ç¨‹é—´åŒæ­¥åŸè¯­æ–¹é¢ã€‚\n<em>Copied From <a href="https://en.wikipedia.org/wiki/Native_POSIX_Thread_Library">Wikipedia NPTL</a></em></p>\n</blockquote>\n<p><img src="https://ws4.sinaimg.cn/large/006tNc79ly1g1x9mjuahnj31400u0doi.jpg" alt="Linux æ¶æ„"></p>\n<h2>Thread Model</h2>\n<p>æœ€åï¼ŒèŠèŠçº¿ç¨‹æ¨¡å‹ã€‚ç›¸ä¿¡å„ä½ä¸ç®¡æ‡‚æˆ–ä¸æ‡‚ï¼Œè‡³å°‘éƒ½å¬è¯´è¿‡ 1:1, N:1, M:N çº¿ç¨‹æ¨¡å‹ã€‚è‡³äºç©¶ç«Ÿè¿™äº›æ¨¡å‹æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿä¸”çœ‹ï¼š</p>\n<p><img src="https://ws4.sinaimg.cn/large/006tNc79ly1g1xhulou5bj30go08zglv.jpg" alt="Thread Model"></p>\n<h3>1:1 Model</h3>\n<p>æœ€ç®€å•çš„çº¿ç¨‹æ¨¡å‹ï¼Œä¹Ÿæ˜¯å†…æ ¸é€šè¿‡NPTLæœ€å®¹æ˜“å®ç°çš„ä¸€ç§æ¨¡å‹ã€‚æ¯ä¸ªé€šè¿‡ <code>clone</code> äº§ç”Ÿçš„æ–°ä»»åŠ¡ï¼ˆå½“ç„¶ï¼Œè‡³å°‘è¦ç¬¦åˆå…±äº«å†…å­˜ç­‰çº¿ç¨‹å®šä¹‰ï¼‰å¯¹åº”ç”¨ç¨‹åºæ¥è¯´å°±æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹ã€‚æ‰€è°“çš„ç”¨æˆ·çº§çº¿ç¨‹å’Œå†…æ ¸çº§çº¿ç¨‹ï¼Œåœ¨ 1:1 æ¨¡å‹ä¸­å°±æ˜¯åŒä¸€ä¸ªä»»åŠ¡ï¼Œåªæ˜¯æ–°ä»»åŠ¡åœ¨è¢«å†…æ ¸ <code>clone</code> ä¹‹åï¼Œåˆç”±NPTLåšäº†è¿›ä¸€æ­¥çš„ç®¡ç†ï¼Œå› æ­¤åœ¨å½¢å¼ä¸Šçœ‹ä¼¼æœ‰ç”¨æˆ·çº§/å†…æ ¸çº§ä¹‹åˆ†ã€‚</p>\n<h3>N:1 Model</h3>\n<p>N:1 çº¿ç¨‹æ¨¡å‹åˆç§°ä¸ºâ€œç”¨æˆ·çº§çº¿ç¨‹æ¨¡å‹â€ã€‚åœ¨è¿™ç§æ¨¡å‹ä¸‹ï¼Œçº¿ç¨‹çš„æ¦‚å¿µç”±ç”¨æˆ·æ€ä»£ç è¿›è¡Œæ”¯æŒï¼ŒåŒ…æ‹¬ç”¨æ¥ç®¡ç†çº¿ç¨‹çš„ç”¨æˆ·ç©ºé—´è°ƒåº¦å™¨ä»¥åŠä»¥éé˜»å¡æ¨¡å¼æ•æ‰å’Œå¤„ç†I/Oæœºåˆ¶ã€‚ä½¿ç”¨N:1æ¨¡å‹çš„å¥½å¤„åœ¨äºå…¶ä¸Šä¸‹æ–‡åˆ‡æ¢çš„ä»£ä»·å‡ ä¹ä¸ºé›¶ï¼Œæ¯•ç«Ÿè¿™æ˜¯çº¯ç”¨æˆ·æ€çš„ã€‚å½“ç„¶ï¼Œç¼ºç‚¹ä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼šç”±äºå¯¹å†…æ ¸æ¥è¯´ï¼Œè®¤ä¸ºè¿™åªæ˜¯å•ä¸ªä»»åŠ¡ï¼Œä¹Ÿå°±æ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸CPUçš„ç‰¹æ€§ã€‚</p>\n<h3>M:N Model</h3>\n<p>æœ‰æ²¡æœ‰æ–¹å¼æ•´åˆ1:1æ¨¡å‹å’ŒN:1æ¨¡å‹ï¼Œè®©å†…æ ¸æ„è¯†åˆ°æœ‰å‡ ä¸ªä»»åŠ¡ï¼Œä½†åˆå­˜åœ¨æ›´å¤šçš„çº¿ç¨‹åœ¨ç”¨æˆ·çº§æ‰§è¡Œå‘¢ï¼Ÿå½“ç„¶ä¹Ÿæ˜¯å¯è¡Œï¼Œä½†å¦‚ä½•åè°ƒè°ƒåº¦åˆæ˜¯è´¹äº‹è´¹åŠ›çš„å®ç°äº†ã€‚</p>\n<h2>Threads vs Events</h2>\n<p>çº¿ç¨‹æ€ä¹ˆåˆå’Œäº‹ä»¶æ‰¯ä¸Šå…³ç³»äº†å‘¢ï¼Ÿå…ˆæ¥å›é¡¾ä¸‹ä»»åŠ¡è°ƒåº¦çš„å‡ ç§æ¨¡å¼ï¼š</p>\n<ol>\n<li>ä¸²è¡Œï¼Œæ¯ä¸ªä»»åŠ¡ä¾æ¬¡æ‰§è¡Œï¼Œä¸å­˜åœ¨ä»»åŠ¡è°ƒåº¦</li>\n<li>æŠ¢å å¼ï¼Œé€šè¿‡æ—¶é’Ÿä¸­æ–­å†³å®šæ˜¯å¦åˆ‡æ¢ä»»åŠ¡</li>\n<li>åä½œå¼ï¼Œåªæœ‰å½“ä»»åŠ¡ä¸»åŠ¨æ”¾å¼ƒå¯¹CPUçš„å ç”¨ï¼Œæ‰èƒ½è½®åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</li>\n</ol>\n<p>å¯¹äºç”¨æˆ·çº§çº¿ç¨‹æ¥è¯´ï¼Œå†…æ ¸æ— æ³•æ„è¯†åˆ°è¿™äº›çº¿ç¨‹çš„å­˜åœ¨ï¼Œç¡¬ä»¶å‘èµ·çš„æ‰€æœ‰ä¸­æ–­åˆéƒ½è¢«å†…æ ¸æ•è·ã€‚å› æ­¤ï¼Œæƒ³è¦å®ç°æŠ¢å å¼æ˜¯ä¸å¯èƒ½å®Œæˆçš„ä»»åŠ¡ï¼ˆè‡³å°‘ä»¥æœ¬äººç›®å‰æ‰€çŸ¥æ˜¯ä¸å¯èƒ½çš„ï¼‰ã€‚æ•…åä½œå¼çº¿ç¨‹è°ƒåº¦æ˜¯ç”¨æˆ·çº§çº¿ç¨‹çš„å”¯ä¸€é€‰æ‹©ã€‚è€Œåä½œå¼å°±æ„å‘³ç€æ˜¯ç”±çº¿ç¨‹ç¡¬ç¼–ç ä¸»åŠ¨æ”¾å¼ƒä»»åŠ¡æ‰§è¡Œï¼ˆ<code>yield</code> / <code>schedule</code> / etc.ï¼‰ã€‚å¦‚æ­¤è¿™èˆ¬ï¼Œä¸äº‹ä»¶é©±åŠ¨ä¸‹ï¼Œä¸åŒä»£ç ç‰‡ä¹‹é—´çš„è°ƒåº¦åˆæ˜¯ä½•å…¶ç›¸ä¼¼ã€‚å½“ç„¶ï¼Œåªæ˜¯å¼€ä¸ªç©ç¬‘ï¼Œå¦‚æœéƒ½ä¸€æ ·äº†ï¼Œç›´æ¥ç”¨äº‹ä»¶é©±åŠ¨ä¸å°±OKäº†ã€‚çº¿ç¨‹ä¹‹æ‰€ä»¥æ˜¯çº¿ç¨‹ï¼Œæœ‰å…¶ç‹¬ç‰¹çš„å®šä¹‰åœ¨ã€‚ä¸è¿‡ä¸å†ç»†è¯´ï¼Œå¯ä»¥å‚è€ƒ <a href="http://courses.cs.vt.edu/cs5204/fall09-kafura/Presentations/Threads-VS-Events.pdf">Threads vs Events</a></p>\n<h2>å‚è€ƒ</h2>\n<p>[1]. Mauerer W. Professional Linux kernel architecture[M]. John Wiley &#x26; Sons, 2010.\n[2]. <a href="http://lkml.iu.edu/hypermail/linux/kernel/9608/0191.html">Linus Torvalds. Re: proc fs and shared pids</a>[EL/OL]. Aug 6th, 1996.\n[3]. <a href="https://randu.org/tutorials/threads/">Multithreaded Programming (POSIX pthreads Tutorial)</a>[EL/OL].\n[4]. <a href="https://blog.csdn.net/u012432778/article/details/47378321">çº¿ç¨‹æ¨¡å‹</a>[EL/OL].\n[5]. <a href="https://www.evanjones.ca/software/threading.html">Implementing a Thread Library on Linux</a>[EL/OL]. Dec 10th, 2003.</p>\n<h2>ç”¨æˆ·çº§çº¿ç¨‹èµ„æ–™å‚è€ƒ</h2>\n<p>[1]. <code>man makecontext</code> &#x26; <code>man swapcontext</code>\n[2]. <a href="https://github.com/brianwatling/libfiber">Libfiber</a>\n[3]. <a href="https://github.com/dramesh/GTThreads"><strong>æ‰€è°“çš„</strong>æŠ¢å å¼ç”¨æˆ·çº¿ç¨‹å®ç°</a></p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},W2Zs:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<h2>ç»ªè®º</h2>\n<p><em>æœ¬æ–‡åªæ˜¯å¯¹ Java å®‰å…¨è®¿é—®ä¸æƒé™æ§åˆ¶çš„åŸºç¡€æ€§æ¢ç©¶ã€‚</em></p>\n<p><strong>æœ¬èŠ‚ä¸å…¨æ–‡å†…å®¹æ— å…³ï¼Œå¦‚æ— å…´è¶£é˜…è¯»ï¼Œå¯ä»¥è·³è¿‡</strong></p>\n<p>äº†è§£ Java å®‰å…¨è®¿é—®ç›¸å…³å†…å®¹çš„åˆè¡·ï¼Œæ˜¯å‡†å¤‡åœ¨é¡¹ç›®ä¸­åˆ©ç”¨ Java æ ‡å‡†åº“æä¾›çš„ ServiceLoader å¯¹ SPI å®ç°ç±»è¿›è¡Œ"è‡ªåŠ¨å‘ç°"å’ŒåŠ è½½ã€‚\nè¿™å¯¹äºå°†æœ¬é¡¹ç›®ä½œä¸ºäºŒæ–¹åº“æ¥ä¾èµ–çš„ä¸Šå±‚é¡¹ç›®å°†æ›´ä¸ºæ–¹ä¾¿ï¼Œåªéœ€è¦\n1. åœ¨ <code>META-INF.services</code> ç›®å½•ä¸‹é…ç½®è¢«å‘½åä¸º SPI æ¥å£å…¨é™å®šåçš„æ–‡ä»¶åŠæ·»åŠ ç›¸å…³å†…å®¹\n2. ç”±é¡¹ç›®çš„æ³¨å†Œç®¡ç†å™¨è§¦å‘ä¸‹åˆ— Java ä»£ç </p>\n<pre><code class="language-java">{\n    ServiceLoader&#x3C;XxxPolicy> xxxPolicyServiceLoader = ServiceLoader.load(XxxPolicy.class);\n    for (Iterator&#x3C;XxxPolicy> it = xxxPolicyServiceLoader.iterator(); it.hasNext(); ) {\n        XxxPolicy xxxPolicy = it.next();\n        // ... more code ...\n    }\n}\n</code></pre>\n<p>å°±å¯ä»¥å®Œæˆä¸€ä¸ªæ–°çš„ SPI ç­–ç•¥çš„æ³¨å†Œå·¥ä½œã€‚</p>\n<p>ä½†æ˜¯ï¼Œåœ¨å°è¯•å®ç°ï¼Œäº†è§£äº† ServiceLoader æºç ï¼Œä»¥åŠ DriverManager å’Œ mysql-connection-java-.jar åœ¨æ³¨å†Œ Driver ç›¸å…³çš„ä»£ç ã€‚\nå‘ç°æ€ä¹ˆä¹Ÿç»•ä¸å¼€ Java å®‰å…¨è®¿é—®ç›¸å…³çš„å†…å®¹ã€‚è¯¸å¦‚ä¸‹åˆ—è¿™æ®µæ¥è‡ª DriverManager.loadInitialDrivers() çš„ä»£ç :</p>\n<pre><code class="language-java">AccessController.doPrivileged(new PrivilegedAction&#x3C;Void>() {\n    public Void run() {\n\n        ServiceLoader&#x3C;Driver> loadedDrivers = ServiceLoader.load(Driver.class);\n        Iterator&#x3C;Driver> driversIterator = loadedDrivers.iterator();\n\n        try{\n            while(driversIterator.hasNext()) {\n            driversIterator.next();\n            }\n        } catch(Throwable t) {\n                // Do nothing\n        }\n        return null;\n    }\n});\n</code></pre>\n<p>è¯¸å¦‚ AccessController, Permission, SecurityManager çš„ä»£ç å§‹ç»ˆæ˜¯ä¸€ä¸ªç»•ä¸å¼€çš„ä¸»æ—‹å¾‹ã€‚</p>\n<p>ä¸ºäº†æ¢ç©¶è¿™éƒ¨åˆ†æ§åˆ¶å¯¹é¡¹ç›®ä¸­ ServiceLoader çš„çœŸæ­£ä½œç”¨ä»¥åŠå…¶ç¼–ç æ„ä¹‰ï¼Œå¼€å§‹äº†å¯¹æœ¬æ–‡æ‰€æè¿°çš„ä¸»ä½“å†…å®¹çš„åˆæ­¥äº†è§£ã€‚</p>\n<h2>ä»ç°è±¡å¼€å§‹...</h2>\n<p>åœ¨é€šè¿‡ <code>java</code> å‘½ä»¤æ‰§è¡Œæœ¬åœ°ä»£ç æ—¶ï¼Œå¶å°”/ç»å¸¸ä¼šå‡ºç°æ–‡ä»¶I/Oæ“ä½œã€‚</p>\n<pre><code class="language-java">public static void main(String... args) throws IOException {\n\n    System.out.println(System.getSecurityManager());\n\n    FileInputStream fis = new FileInputStream("/Users/fangfeng/test.in");\n    for (int chr; (chr = fis.read()) != -1;) {\n        System.out.print((char) chr);\n    }\n    fis.close();\n}\n</code></pre>\n<p>è¯¸å¦‚ä¸Šé¢è¿™æ®µä»£ç ï¼Œæ„åœ¨è¯»å–å¤–éƒ¨è·¯å¾„ä¸‹ <code>test.in</code> æ–‡ä»¶(ä¸è¦æ”¾åœ¨é¡¹ç›®è·¯å¾„ä¸‹ï¼Œæ–‡æœ¬å†…å®¹ä¸º <code>0123456789</code>)ã€‚å½“ç„¶ï¼Œè¿˜åŒ…æ‹¬æ‰“å° System.getSecurityManager().toString() ã€‚</p>\n<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™éƒ½æ˜¯èƒ½å¤Ÿæ‰§è¡ŒæˆåŠŸï¼Œç»“æœä¸º:</p>\n<pre><code class="language-plain">null\n0123456789\n</code></pre>\n<p>ä½†æ˜¯ï¼Œé€šè¿‡åœ¨å‘½ä»¤è¡Œ <code>java</code> ä¸­æ·»åŠ é€‰é¡¹ <code>-Djava.security.manager</code>ï¼Œå†æ¬¡æ‰§è¡Œä»£ç ï¼Œç»“æœä¸º:</p>\n<pre><code class="language-plain">java.lang.SecurityManager@4e25154f\nException in thread "main" java.security.AccessControlException: access denied ("java.io.FilePermission" "/Users/fangfeng/test.in" "read")\n    at java.security.AccessControlContext.checkPermission(AccessControlContext.java:472)\n    at java.security.AccessController.checkPermission(AccessController.java:884)\n    at java.lang.SecurityManager.checkPermission(SecurityManager.java:549)\n    at java.lang.SecurityManager.checkRead(SecurityManager.java:888)\n    at java.io.FileInputStream.&#x3C;init>(FileInputStream.java:127)\n    at java.io.FileInputStream.&#x3C;init>(FileInputStream.java:93)\n    at me.fangfeng.security.SecurityTest.main(SecurityTest.java:16)\n</code></pre>\n<p>ç°åœ¨å·²ç»èƒ½å¤Ÿè·å–åˆ° <code>System.getSecuriryManager</code> çš„å®ä¾‹ã€‚\nä½†æ˜¯æƒ³è¦è¯»å– <code>test.in</code> æ–‡ä»¶å´å¤±è´¥äº†ï¼Œè¡¨ç°ä¸º access deniedï¼ˆè®¿é—®è¢«æ‹’ç»ï¼‰ã€‚</p>\n<p>ç°åœ¨ï¼Œåœ¨ç”¨æˆ·ç›®å½•ä¸‹(è¿™é‡Œæ˜¯ /Users/fangfeng, ä¸åŒç³»ç»Ÿä¸åŒç”¨æˆ·è¯·åšç›¸åº”ä¿®æ”¹) æ·»åŠ  <code>.java.policy</code> æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹åˆ—æ–‡æœ¬:</p>\n<pre><code class="language-plain">grant {\n    permission java.io.FilePermission "/Users/fangfeng/test.in", "read";\n};\n</code></pre>\n<p>å†æ¬¡ <code>java -Djava.security.manager &#x3C;class\'s path></code>ï¼Œä¸ä»…èƒ½å¤Ÿå¾—åˆ° SecurityManager çš„å®ä¾‹ï¼ŒåŒæ—¶ä¹Ÿè¯»å–åˆ°äº†æ–‡æœ¬å†…å®¹ã€‚</p>\n<pre><code class="language-plain">java.lang.SecurityManager@3af49f1c\n0123456789\n</code></pre>\n<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œåº”è¯¥å·²ç»èƒ½å¤Ÿæ„Ÿå—åˆ° Java å¯¹å®‰å…¨è®¿é—®çš„æ§åˆ¶åœ¨æ–‡ä»¶I/Oä¸Šçš„ä½“ç°äº†ã€‚</p>\n<h2>å®‰å…¨æ§åˆ¶ä¸‹çš„æ“ä½œ</h2>\n<p><strong>åœ¨å¼€å§‹ä¸‹åˆ—å†…å®¹ä¹‹å‰ï¼Œéœ€è¦æå‰äº†è§£ä¸€ä¸ªå‰æ:</strong>\n<strong>Java å¯¹æ“ä½œæƒé™çš„æ§åˆ¶æ˜¯é€šè¿‡æ£€æŸ¥å½“å‰çº¿ç¨‹æ“ä½œä¸Šä¸‹æ–‡çš„ä»£ç æ˜¯å¦å­˜åœ¨è¦æ±‚çš„æ“ä½œæƒé™å®ç°çš„(é™¤äº†ç‰¹æƒçš„å£°æ˜ä»¥åŠå…¶å®ƒè¿˜éœ€è¦æ§åˆ¶åˆ«çš„çº¿ç¨‹ä¸Šä¸‹æ–‡æƒé™çš„æƒ…å†µ)</strong></p>\n<p>ä¸Šä¸€èŠ‚æ¼”ç¤ºäº†æƒé™æ§åˆ¶ä¸‹æœ¬åœ°ä»£ç å¯¹æœ¬åœ°èµ„æºçš„è®¿é—®ã€‚ä½†æ˜¯ï¼Œå®‰å…¨æ§åˆ¶çœŸçš„æœ‰å¿…è¦å—ï¼Ÿ</p>\n<ul>\n<li>å°±æœ¬åœ°ç¨‹åºè€Œè¨€ï¼Œä¸å¿…è¦ã€‚äº‹å®ä¸Šï¼ŒJava ä¹Ÿç¡®å®æ˜¯è¿™ä¹ˆåšçš„ã€‚å¹³æ—¶åœ¨æœ¬åœ°åˆ©ç”¨ <code>java</code> å‘½ä»¤æ‰§è¡Œç¨‹åºï¼Œéƒ½ä¸ä¼šå—åˆ°ä»»ä½•é™åˆ¶ã€‚Java å¯åŠ¨æ—¶é»˜è®¤ä¸ä¼šè£…è½½ SecurityManagerï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘å¯¹å„ç§æ“ä½œçš„æƒé™éªŒè¯ã€‚</li>\n<li>å¯å¦‚æœç¨‹åºè¿è¡Œä¸ç½‘ç»œä¸Šå…¶å®ƒç¨‹åºäº¤äº’ï¼Œç”šè‡³ç›´æ¥åŠ è½½æ¥è‡ªç½‘ç»œçš„å­—èŠ‚ç ã€‚é‚£ä¹ˆï¼Œæƒé™æ§åˆ¶ç¡®å®æ˜¯æœ‰å¿…è¦çš„ã€‚è‡³å°‘ï¼Œå¦‚æœä¸å­˜åœ¨æƒé™æ§åˆ¶ï¼Œæ¥è‡ªç½‘ç»œçš„æ¶æ„ä»£ç è®¿é—®æ•´å°æœºå™¨çš„ä»»æ„èµ„æºéƒ½å°†ç•…é€šæ— é˜»ã€‚</li>\n</ul>\n<h3>SecurityManager</h3>\n<p>SecurityManager æ˜¯æ•´ä¸ªè®¿é—®æ§åˆ¶çš„ç®¡ç†å™¨å’ŒåŸºæœ¬å…¥å£ã€‚æ‰€æœ‰æ¶‰åŠåˆ°æƒé™æ§åˆ¶çš„ä»£ç ï¼Œéƒ½ä¼šç±»ä¼¼åœ°å­˜åœ¨ä¸‹åˆ—è¿™èˆ¬çš„ä»£ç :</p>\n<pre><code class="language-java">SecurityManager security = System.getSecurityManager();\n// å¦‚æœç³»ç»Ÿå­˜åœ¨å®‰å…¨ç®¡ç†å™¨\nif (security != null) {\n    // è°ƒç”¨ SecurityManager ä¸­ä»¥ check å¼€å¤´çš„æ–¹æ³•\n    security.checkXxx(...);\n}\n</code></pre>\n<p><code>security.checkXxx(...)</code> æ˜¯æ²¡æœ‰è¿”å›å€¼çš„(é™¤äº† checkTopLevelWindow)ï¼›å¯¹äºæ²¡æœ‰æ“ä½œæƒé™çš„ä»£ç ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸</p>\n<p>è‡³äºåˆ°åº•åœ¨ check ä»€ä¹ˆï¼ŒJava ä¸­å®šä¹‰äº†åŒ…æ‹¬æ–‡ä»¶(File)ã€å¥—æ¥å­—(Socket)ã€ç½‘ç»œ(Net)ã€å®‰å…¨æ€§(Security)ã€è¿è¡Œæ—¶(Runtime)ã€å±æ€§(Property)ã€AWTã€åå°„(Reflect)å’Œå¯åºåˆ—åŒ–(Serializable) ä¹ç±»æƒé™ã€‚</p>\n<p>é€šå¸¸ï¼Œsecurity.checkXxx(...) æ–¹æ³•å°†æ„é€ ä¸€ä¸ª XxxPermission(...) å¯¹è±¡æ¥è°ƒç”¨ SecurityManager æä¾›çš„ç»Ÿä¸€æ–¹æ³• checkPermission(Permission) ã€‚</p>\n<pre><code class="language-java">// ä»¥ checkRead(name) ä¸ºä¾‹\npublic void checkRead(String file) {\n    checkPermission(new FilePermission(file, SecurityConstants.FILE_READ_ACTION));\n}\n\n// è°ƒç”¨ checkPermission(Permission) æ–¹æ³•\npublic void checkPermission(Permission perm) {\n    // ç›´æ¥è°ƒç”¨ è®¿é—®æ§åˆ¶å™¨ æ¥å¯¹æƒé™è¿›è¡Œé‰´åˆ«\n    java.security.AccessController.checkPermission(perm);\n}\n</code></pre>\n<h3>AccessController</h3>\n<p>AccessController ç”¨äºä¸è®¿é—®æ§åˆ¶ç›¸å…³çš„æ“ä½œå’Œå†³å®šã€‚</p>\n<blockquote>\n<p>AccessController ç±»ç”¨äºä»¥ä¸‹ä¸‰ä¸ªç›®çš„ï¼š</p>\n<p>åŸºäºå½“å‰ç”Ÿæ•ˆçš„å®‰å…¨ç­–ç•¥å†³å®šæ˜¯å…è®¸è¿˜æ˜¯æ‹’ç»å¯¹å…³é”®ç³»ç»Ÿèµ„æºçš„è®¿é—®\nå°†ä»£ç æ ‡è®°ä¸ºäº«æœ‰â€œç‰¹æƒâ€ï¼Œä»è€Œå½±å“åç»­è®¿é—®å†³å®šï¼Œä»¥åŠ\nè·å–å½“å‰è°ƒç”¨ä¸Šä¸‹æ–‡çš„â€œå¿«ç…§â€ï¼Œè¿™æ ·ä¾¿å¯ä»¥ç›¸å¯¹äºå·²ä¿å­˜çš„ä¸Šä¸‹æ–‡ä½œå‡ºå…¶ä»–ä¸Šä¸‹æ–‡çš„è®¿é—®æ§åˆ¶å†³å®š</p>\n</blockquote>\n<h3>å°ç»“</h3>\n<p>æ€»çš„æ¥è¯´ï¼ŒJava çš„è®¿é—®æ§åˆ¶å°±æ˜¯é€šè¿‡é’ˆå¯¹ä¸åŒçš„æ“ä½œæ„å»ºä¸åŒçš„ Permission å¯¹è±¡ï¼Œç„¶åé€šè¿‡ä¸ AccessControllerContent æŒæœ‰çš„å„ä»£ç çš„æƒé™è¿›è¡Œæ¯”å¯¹ï¼Œ\nä»è€Œåˆ¤æ–­ä»£ç æ˜¯å¦å­˜åœ¨ç›¸åº”çš„è®¿é—®æƒé™ã€‚</p>\n<p><em>æ‰€è°“çš„Permissionåˆ¤æ–­å°†æ˜¯å¯¹å½“å‰çº¿ç¨‹çš„è°ƒç”¨æ ˆçš„æ¯ä¸ªè°ƒç”¨è€…é€ä¸€å€’åºé€’å½’ï¼Œåˆ¤æ–­æ˜¯å¦æ‹¥æœ‰æƒé™ã€‚å¦‚æœå…¶ä¸­çš„æŸä¸ªä»£ç è¢«å£°æ˜ä¸º Privilegedï¼Œåˆ™ç›´æ¥è®¤ä¸ºæ˜¯æ‹¥æœ‰æƒé™</em></p>\n<p><strong>æ›´å¤šçš„å…³äº checkPermission(...) è°ƒç”¨ç›¸å…³çš„å†…å®¹ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥é˜…èµ„æ–™è¿›è¡Œå­¦ä¹ ï¼Œåœ¨æ­¤ä¸åšè¿‡å¤šé™ˆè¿°ã€‚:)</strong></p>\n<h2>ä¸ºæ“ä½œèµ‹æƒ</h2>\n<p>ä¸Šä¸€èŠ‚è®²å®Œäº†å¦‚æœå¯¹å½“å‰é¡¹ç›®é…ç½®äº† SecurityManager ï¼Œå°†å¯¹å„ç§æ•æ„Ÿæ“ä½œè¿›è¡Œè®¿é—®æ§åˆ¶ï¼Œå¹¶ä¸”å°†æ ¹æ®æ•´ä¸ªè°ƒç”¨é“¾è¢«èµ‹äºˆçš„æƒé™æ¥å†³å®šæ˜¯å…è®¸æ‰§è¡Œè¿˜æ˜¯æŠ›å‡º access deniedã€‚</p>\n<p>ä½†æ˜¯ï¼Œç©¶ç«Ÿæ€ä¹ˆæ‰èƒ½å¤Ÿç»™ code èµ‹äºˆæƒé™å‘¢ï¼Ÿ</p>\n<p>å›é¡¾å‰ä¸€èŠ‚çš„å†…å®¹ï¼Œåœ¨åŸºæœ¬æ¢ç©¶ä¸­ï¼Œå…¶å®ä¸€ä¸ªèƒ½å¤Ÿçœ‹åˆ° </p>\n<pre><code class="language-java">grant {\n    permission java.io.FilePermission "/Users/fangfeng/test.in", "read";\n};\n</code></pre>\n<p>è¿™å°±æ˜¯ä¸€ç§èµ‹æƒçš„æ“ä½œã€‚</p>\n<p>é€šè¿‡åœ¨æŒ‡å®šçš„æ–‡ä»¶ä¸­å†™å…¥ç¬¦åˆç‰¹å®šè§„åˆ™çš„ä»£ç ï¼Œæ¥å®Œæˆå¯¹ code çš„èµ‹æƒã€‚<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/PolicyFiles.html">Default Policy Implementation and Policy File Syntax</a></p>\n<p>åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™ï¼Œé»˜è®¤å°±ä¼šè¯»å– $JAVA_HOME/jre/lib/security/java.policy ä»¥åŠ ${user.home}/.java.policy ä¸¤ä¸ªæ–‡ä»¶çš„èµ‹æƒå†…å®¹ï¼Œå¹¶åšç¼“å­˜ç»™åé¢ä»£ç ä½¿ç”¨ã€‚</p>\n<p>å½“ç„¶ï¼ŒJava ä¹Ÿæä¾›æŒ‡å®šè‡ªå®šä¹‰çš„èµ‹æƒæ–‡ä»¶ï¼Œé€šè¿‡ -Djava.security.policy= æˆ–è€… -Djava.security.policy== ã€‚</p>\n<h2>å‚è€ƒ</h2>\n<p>[1]. Java Document - Security. <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/index.html">https://docs.oracle.com/javase/8/docs/technotes/guides/security/index.html</a></p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},bzvy:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>åœ¨ Java æ•´ä¸ªç”Ÿæ€é‡Œé¢, é€šç”¨çš„æœ‰ä¸¤ç±»åŠ¨æ€ä»£ç†çš„åº”ç”¨: Java Proxy ä¸ CGlib ä»£ç†ã€‚</p>\n<p>ä»å®½æ³›çš„åŒºåˆ«æ¥è¯´ï¼ŒJava Proxy åªèƒ½å¯¹æ¥å£è¿›è¡Œå¢å¼ºï¼Œè€Œ CGlib åŒæ—¶é€‚ç”¨äºç±»å’Œæ¥å£çš„å¢å¼ºã€‚\nè€Œä¸”ï¼Œä¸šå†…æ™®éçš„è®¤çŸ¥æ˜¯ï¼ŒCGlib åŠ¨æ€ä»£ç†è¾ƒä¹‹äº Java Proxy åœ¨ç”Ÿæˆå­—èŠ‚ç çš„é€Ÿåº¦ä¸Šä¹Ÿæ›´ä¸ºé«˜æ•ˆã€‚</p>\n<h2>ä»å®ä¾‹å¼€å§‹...</h2>\n<p>ä¸‹é¢ï¼Œé¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ Java Proxy çš„ä½¿ç”¨ç¼–ç :</p>\n<p>ICodeFactory æ¥å£, ä½œä¸ºå°†è¢« Java åŠ¨æ€ä»£ç†å¢å¼ºçš„åŸºæœ¬æ¥å£</p>\n<pre><code class="language-java">public interface ICodeFactory {\n\n    Code getCode();\n\n    void setCode(Code code);\n\n}\n</code></pre>\n<p>CodeFactory ç±», ä½œä¸º ICodeFactory æ¥å£çš„å®ç°ç±»ã€‚è¢«è§†ä¸ºæ˜¯çœŸæ­£è¢«åŠ¨æ€ä»£ç†å¢å¼ºçš„å†…å®¹ï¼Œ:) å› ä¸ºæ¥å£æ–¹æ³•å¹¶ä¸å­˜åœ¨æ–¹æ³•ä½“(å½“ç„¶ï¼ŒJava 8 åŠä»¥ä¸Šçš„ default è¯·å®¹æˆ‘å¿½è§†)</p>\n<pre><code class="language-java">public class CodeFactory implements ICodeFactory {\n\n    private Code code;\n\n    public Code getCode() {\n        return new Code();\n    }\n\n    @Override\n    public void setCode(Code code) {\n        this.code = code;\n    }\n}\n</code></pre>\n<p>è¾…åŠ©ç±» Code çš„å†…å®¹(ç®€å•å†™ï¼Œè¯·å¿½ç•¥ä¸ç¬¦åˆå®é™…ç¼–ç¨‹è§„èŒƒçš„ä¸€äº›å†…å®¹):</p>\n<pre><code class="language-java">public class Code {\n\n    public int codeA;\n\n    public String codeB;\n\n}\n</code></pre>\n<p>æ„å»ºå¢å¼ºçš„ä»£ç é€»è¾‘:</p>\n<pre><code class="language-java">// main(String[]) æ–¹æ³•\npublic static void main(String[] args) throws Exception {\n\n    // å†…éƒ¨åŒ¿åç±»ï¼Œç”¨äºåŠ¨æ€ä»£ç†ç”Ÿæˆç±»çš„æ„é€ æ–¹æ³•åŠå…¶å®ƒå†…å®¹ï¼Œåé¢è®²ã€‚\n    InvocationHandler handler = new InvocationHandler() {\n\n        Object obj = new CodeFactory();\n\n        @Override\n        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n\n            if (method.getName() == "getCode") {\n                Code code = (Code) method.invoke(obj, args);\n                code.codeA = code.codeA + 100;\n                code.codeB = "Proxied: " + code.codeB;\n                return code;\n            } else {\n                return method.invoke(obj, args);\n            }\n        }\n    };\n\n    // æ„å»ºç”Ÿæˆç±»å®ä¾‹\n    Class&#x3C;?> clazz = Proxy.getProxyClass(ICodeFactory.class.getClassLoader(), ICodeFactory.class);\n    // è·å–ç”Ÿæˆç±»å¯¹è±¡\n    ICodeFactory factory = (ICodeFactory) clazz.getConstructor(new Class[] { InvocationHandler.class }).newInstance(new Object[] { handler });\n\n    // è°ƒç”¨ getCode() æ–¹æ³•\n    Code code = factory.getCode();\n    // æ‰“å°å‚æ•°\n    System.out.println(code.codeA);\n    System.out.println(code.codeB);\n}\n</code></pre>\n<p>ä»é»˜è®¤é¢„æœŸæ¥è®²ï¼Œæˆ‘ä»¬æ˜¯å¯¹æ¥å£è¿›è¡Œå¢å¼ºã€‚æ¥å£æ–¹æ³•ä¸å­˜åœ¨æ–¹æ³•ä½“ï¼Œä¹Ÿè®¸å°†åœ¨ <code>factory.getCode()</code> æ—¶æ‰§è¡Œå¤±è´¥ï¼Ÿ\næˆ–è€…ç»“åˆå·²æœ‰çš„è®¤çŸ¥ï¼ŒæˆåŠŸè°ƒç”¨ <code>CodeFactory.getCode()</code> æ–¹æ³•ï¼Œå¹¶è·å¾— <code>new Code()</code> ã€‚</p>\n<p>é‚£ä¹ˆï¼Œ<code>code.codeA</code> <code>code.codeB</code> çš„å…·ä½“å€¼å°†æ˜¯ä»€ä¹ˆï¼Ÿ</p>\n<p>æ‰§è¡Œç»“æœå°†æ˜¯:</p>\n<pre><code class="language-plain">100\nProxied: null\n</code></pre>\n<h2>äº†è§£ Proxy çš„å†…å®¹é€»è¾‘</h2>\n<p>ä» <code>Proxy.getProxyClass(ClassLoader, Class&#x3C;?>...)</code> å…¥æ‰‹ï¼Œä¸‹é¢å°†å±•å¼€å¯¹ <code>Proxy</code> å…·ä½“æ‰§è¡Œé€»è¾‘çš„æ¢ç©¶ã€‚</p>\n<pre><code class="language-java">public static Class&#x3C;?> getProxyClass(ClassLoader loader, Class&#x3C;?>... interfaces) throws IllegalArgumentException {\n    // å¯¹ interfaces æ•°ç»„çš„æµ…æ‹·è´\n    final Class&#x3C;?>[] intfs = interfaces.clone();\n    final SecurityManager sm = System.getSecurityManager();\n    if (sm != null) {\n        // å¦‚æœé…ç½®äº†å®‰å…¨ç®¡ç†å™¨ï¼Œé‚£ä¹ˆéœ€è¦ç¡®è®¤ Proxy æœ‰åˆ›å»ºæ–°çš„ä»£ç†ç±»çš„è®¸å¯\n        checkProxyAccess(Reflection.getCallerClass(), loader, intfs);\n    }\n\n    // è°ƒç”¨ \n    return getProxyClass0(loader, intfs);\n}\n</code></pre>\n<pre><code class="language-java">private static Class&#x3C;?> getProxyClass0(ClassLoader loader, Class&#x3C;?>... interfaces) {\n    // ç¡®è®¤éœ€è¦è¿›è¡Œå¢å¼ºçš„æ¥å£æ•°é‡å°‘äºç­‰äº 65535ï¼Œè¯¦ç»†åŸå› è¯·å»äº†è§£ ClassFile è§„èŒƒ(è§„èŒƒä¸­çš„æ¥å£ä¸Šé™)\n    if (interfaces.length > 65535) {\n        throw new IllegalArgumentException("interface limit exceeded");\n    }\n\n    // å¦‚æœéœ€è¦ç”±æŒ‡å®š ClassLoader åŠ è½½, å®ç°ç»™å®š interfaces çš„ä»£ç†ç±»å·²ç»å­˜åœ¨, \n    // å°†ç›´æ¥è¿”å›å·²ç»ç¼“å­˜è¿‡çš„æ‹·è´\n    // å¦åˆ™ï¼Œé€šè¿‡ ProxyClassFactory åˆ›å»ºæ–°çš„ä»£ç†ç±»\n    return proxyClassCache.get(loader, interfaces);\n}\n</code></pre>\n<p>ç°åœ¨éœ€è¦é¢å¤–æ¥è€ƒå¯Ÿä¸€ä¸‹ proxyClassCache çš„å…·ä½“ç±»å‹ã€‚</p>\n<pre><code class="language-java">private static final WeakCache&#x3C;ClassLoader, Class&#x3C;?>[], Class&#x3C;?>>\n        proxyClassCache = new WeakCache&#x3C;>(new KeyFactory(), new ProxyClassFactory());\n</code></pre>\n<p><code>WeakCache</code>, ä»åç§°æ¥å°†ï¼Œæ˜¯ä¸€ä¸ªç¼“å­˜ï¼ŒåŒæ—¶åº”è¯¥ä½¿ç”¨äº† WeakReference æŠ€æœ¯</p>\n<p>è¿›å…¥ <code>WeakCache.get(...)</code> æ–¹æ³•ä½“</p>\n<pre><code class="language-java">public V get(K key, P parameter) {\n    // parameter ä¼ å…¥çš„æ˜¯æ¥å£æ•°ç»„ï¼Œè¦æ±‚ä¸èƒ½ä¸ºç©º\n    Objects.requireNonNull(parameter);\n\n    // åˆ é™¤è¿‡æœŸå…ƒç´ \n    expungeStaleEntries();\n\n    // æ„å»ºä¸€ä¸ª WeakReference å¯¹è±¡(key è¡¨ç¤º ClassLoader)\n    Object cacheKey = CacheKey.valueOf(key, refQueue);\n\n    // lazily install the 2nd level valuesMap for the particular cacheKey\n    ConcurrentMap&#x3C;Object, Supplier&#x3C;V>> valuesMap = map.get(cacheKey);\n    if (valuesMap == null) {\n        ConcurrentMap&#x3C;Object, Supplier&#x3C;V>> oldValuesMap\n                = map.putIfAbsent(cacheKey,\n                valuesMap = new ConcurrentHashMap&#x3C;>());\n        if (oldValuesMap != null) {\n            valuesMap = oldValuesMap;\n        }\n    }\n\n    // åˆ›å»ºæ¬¡çº§ Key\n    // åŒæ—¶æ£€ç´¢æ˜¯å¦å­˜åœ¨è¿‡å»æœ‰åŒä¸€ä¸ª ClassLoader åŠ è½½çš„è¡¨ç¤º Supplier&#x3C;V>\n    Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter));\n    Supplier&#x3C;V> supplier = valuesMap.get(subKey);\n    Factory factory = null;\n\n    while (true) {\n        if (supplier != null) {\n            // supplier might be a Factory or a CacheValue&#x3C;V> instance\n            // æœ€ç»ˆ supplier å°†éç©ºï¼ŒåŒæ—¶è°ƒç”¨ .get() æ–¹æ³•è·å– Class ç±»\n            V value = supplier.get();\n            if (value != null) {\n                return value;\n            }\n        }\n        // else no supplier in cache\n        // or a supplier that returned null (could be a cleared CacheValue\n        // or a Factory that wasn\'t successful in installing the CacheValue)\n        // æœªæ‰¾åˆ°è¿‡å»åŠ è½½çš„è®°å½•\n\n        // æ‡’åŠ è½½ä¸€ä¸ª Factory \n        if (factory == null) {\n            factory = new Factory(key, parameter, subKey, valuesMap);\n        }\n\n        if (supplier == null) {\n            supplier = valuesMap.putIfAbsent(subKey, factory);\n            if (supplier == null) {\n                // successfully installed Factory\n                supplier = factory;\n            }\n            // else retry with winning supplier\n        } else {\n            if (valuesMap.replace(subKey, supplier, factory)) {\n                // successfully replaced\n                // cleared CacheEntry / unsuccessful Factory\n                // with our Factory\n                supplier = factory;\n            } else {\n                // retry with current supplier\n                supplier = valuesMap.get(subKey);\n            }\n        }\n    }\n}\n</code></pre>\n<pre><code class="language-java">@Override\npublic synchronized V get() { // serialize access\n    // re-check\n    Supplier&#x3C;V> supplier = valuesMap.get(subKey);\n    if (supplier != this) {\n        // something changed while we were waiting:\n        // might be that we were replaced by a CacheValue\n        // or were removed because of failure ->\n        // return null to signal WeakCache.get() to retry\n        // the loop\n        return null;\n    }\n    // else still us (supplier == this)\n\n    // create new value\n    V value = null;\n    try {\n        // è§¦å‘ valueFactory.apply() çœŸæ­£çš„æ„å»º\n        value = Objects.requireNonNull(valueFactory.apply(key, parameter));\n    } finally {\n        if (value == null) { // remove us on failure\n            valuesMap.remove(subKey, this);\n        }\n    }\n    // the only path to reach here is with non-null value\n    assert value != null;\n\n    // wrap value with CacheValue (WeakReference)\n    CacheValue&#x3C;V> cacheValue = new CacheValue&#x3C;>(value);\n\n    // put into reverseMap\n    reverseMap.put(cacheValue, Boolean.TRUE);\n\n    // try replacing us with CacheValue (this should always succeed)\n    if (!valuesMap.replace(subKey, this, cacheValue)) {\n        throw new AssertionError("Should not reach here");\n    }\n\n    // successfully replaced us with new CacheValue -> return the value\n    // wrapped by it\n    return value;\n}\n</code></pre>\n<p>ä¸Šé¢ä¸¤æ®µä»£ç çš„å†…å®¹ï¼Œéƒ½æ˜¯åœ¨åå¤ç¡®è®¤å°†è¦æ„å»ºçš„ç”Ÿæˆç±»æ˜¯å¦åœ¨è¿‡å»æ›¾ç»åˆ›å»ºè¿‡ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›è¿‡å»æ„å»ºçš„ç±»å®ä¾‹;\nå¦åˆ™æ‰ä¼šå°è¯•åˆ›å»ºï¼Œå¹¶æœ€ç»ˆå°†è¿™ä¸ªæ„å»ºçš„ç±»ä¹Ÿè¿›è¡Œç¼“å­˜ã€‚</p>\n<p>ä¸‹é¢è¿™æ®µä»£ç æ¥è‡ªäº <code>Proxy</code> çš„å†…éƒ¨ç±» <code>ProxyClassFactory</code>\nè¿™éƒ¨åˆ†ï¼Œä¹Ÿç»ˆäºå¼€å§‹äº†å¯¹ä»£ç†ç±»å­—èŠ‚ç çš„ç»Ÿç­¹æ€§æ„é€ çš„å†…å®¹ã€‚</p>\n<pre><code class="language-java">public Class&#x3C;?> apply(ClassLoader loader, Class&#x3C;?>[] interfaces) {\n\n    Map&#x3C;Class&#x3C;?>, Boolean> interfaceSet = new IdentityHashMap&#x3C;>(interfaces.length);\n    for (Class&#x3C;?> intf : interfaces) {\n        /*\n         * æ ¡éªŒå½“å‰æ¥å£æ˜¯ç”±åŒä¸€ä¸ª ClassLoader (å°†è¦ç”¨æ¥åŠ è½½æ–°çš„ä»£ç†ç±»)åŠ è½½çš„\n         */\n        Class&#x3C;?> interfaceClass = null;\n        try {\n            interfaceClass = Class.forName(intf.getName(), false, loader);\n        } catch (ClassNotFoundException e) {\n        }\n        if (interfaceClass != intf) {\n            throw new IllegalArgumentException(\n                    intf + " is not visible from class loader");\n        }\n        /*\n         * æ ¡éªŒå½“å‰ Class å¯¹è±¡ç¡®å®æ˜¯ä¸€ä¸ªæ¥å£\n         */\n        if (!interfaceClass.isInterface()) {\n            throw new IllegalArgumentException(\n                    interfaceClass.getName() + " is not an interface");\n        }\n        /*\n         * æ ¡éªŒå½“å‰æ¥å£æ²¡æœ‰è¢«è¦æ±‚é‡å¤è¿›è¡Œä»£ç†å¢å¼º\n         */\n        if (interfaceSet.put(interfaceClass, Boolean.TRUE) != null) {\n            throw new IllegalArgumentException(\n                    "repeated interface: " + interfaceClass.getName());\n        }\n    }\n\n    String proxyPkg = null;     // ç”Ÿæˆçš„ä»£ç†ç±»æ‰€å±çš„ package\n    int accessFlags = Modifier.PUBLIC | Modifier.FINAL;\n\n    /*\n     * å¦‚æœä»£ç†çš„æ¥å£æ˜¯é PUBLIC ï¼Œé‚£ä¹ˆç”Ÿæˆçš„ä»£ç†ç±»çš„æ¥å£å°†ä¸è¿™ä¸ªé PUBLIC æ¥å£\n     * åœ¨åŒä¸€ä¸ªåŒ…ä¸‹ã€‚\n     * å¦‚æœä»£ç†çš„æ¥å£æœ‰å¤šä¸ªé PUBLIC ï¼Œä¸”åˆ†åˆ«ä½äºä¸åŒçš„åŒ…ä¸‹ï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸\n     */\n    for (Class&#x3C;?> intf : interfaces) {\n        int flags = intf.getModifiers();\n        if (!Modifier.isPublic(flags)) {\n            accessFlags = Modifier.FINAL;\n            String name = intf.getName();\n            int n = name.lastIndexOf(\'.\');\n            String pkg = ((n == -1) ? "" : name.substring(0, n + 1));\n            if (proxyPkg == null) {\n                proxyPkg = pkg;\n            } else if (!pkg.equals(proxyPkg)) {\n                throw new IllegalArgumentException(\n                        "non-public interfaces from different packages");\n            }\n        }\n    }\n\n    // å¦‚æœä»£ç†çš„æ¥å£å…¨æ˜¯ PUBLIC çš„ï¼Œé‚£ä¹ˆä½¿ç”¨é»˜è®¤çš„åŒ… com.sun.proxy\n    if (proxyPkg == null) {\n        // if no non-public proxy interfaces, use com.sun.proxy package\n        proxyPkg = ReflectUtil.PROXY_PACKAGE + ".";\n    }\n\n    /*\n     * ä¸ºå°†è¦ç”Ÿæˆçš„ä»£ç†ç±»é€‰æ‹©ä¸€ä¸ªå…¨é™å®šå\n     * è§„åˆ™æ˜¯ åŒ…å + "$Proxy" + &#x3C;å”¯ä¸€é€’å¢çš„id, ä»0å¼€å§‹ç¼–å·>\n     */\n    long num = nextUniqueNumber.getAndIncrement();\n    String proxyName = proxyPkg + proxyClassNamePrefix + num;\n\n    /*\n     * ç”Ÿæˆä¸€ä¸ªç‰¹æ®Šçš„ä»£ç†ç±»çš„å­—èŠ‚ç \n     * byte[] proxyClassFile å°±ç­‰åŒäº .class æ–‡ä»¶çš„å…¨éƒ¨äºŒè¿›åˆ¶å†…å®¹ã€‚\n     * ä¸ .class æ–‡ä»¶çš„åŒºåˆ«å°±åœ¨äºä¸€ä¸ªå†™åœ¨äº†å¤–å­˜ä¸Šï¼Œå¦ä¸€ä¸ªå®Œå…¨åœ¨å†…å­˜ä¸­åˆ›å»º\n     */\n    byte[] proxyClassFile = ProxyGenerator.generateProxyClass(\n            proxyName, interfaces, accessFlags);\n    try {\n        /**\n          * è°ƒç”¨ ClassLoader çš„ defineClass0(...) æ–¹æ³•åŠ è½½å­—èŠ‚ç å†…å®¹ï¼Œæ„é€  Class å¯¹è±¡\n          * æœ¬æ¥ defineClass0(...) æ–¹æ³•æ˜¯å®šä¹‰åœ¨ ClassLoader ä¸­ï¼Œä½†è¿™é‡Œé¢å¤–å£°æ˜äº†ä¸€ä¸ªæœ¬åœ°æ–¹æ³• defineClass0(...)\n          * æƒ³æ¥å®ç°ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œæœ€ç»ˆçš„ç›®çš„ä¹Ÿæ˜¯åŠ è½½ Class \n          */\n        return defineClass0(loader, proxyName,\n                proxyClassFile, 0, proxyClassFile.length);\n    } catch (ClassFormatError e) {\n        /*\n         * A ClassFormatError here means that (barring bugs in the\n         * proxy class generation code) there was some other\n         * invalid aspect of the arguments supplied to the proxy\n         * class creation (such as virtual machine limitations\n         * exceeded).\n         */\n        throw new IllegalArgumentException(e.toString());\n    }\n}\n</code></pre>\n<p>åœ¨å®ŒæˆåŸºç¡€æ€§çš„æ ¡éªŒï¼Œå¹¶æ„é€ äº†ç”Ÿæˆç±»çš„ç±»åç­‰å†…å®¹åï¼Œ\n<code>ProxyGenerator.generateProxyClass</code> å°†å¼€å§‹æ„é€  <a href="https://docs.oracle.com/javase/specs/jvms/se9/html/jvms-4.html">ClassFile</a> çš„å…·ä½“å†…å®¹ã€‚</p>\n<p>å…³äºè¿™éƒ¨åˆ†ç”Ÿæˆå­—èŠ‚ç çš„å†…å®¹ï¼Œè¯·åœ¨äº†è§£äº† ClassFile çš„åŸºç¡€æ€§å†…å®¹ä¹‹åï¼Œåœ¨è‡ªè¡Œå­¦ä¹ ï¼Œå†…å®¹å…¨éƒ¨åœ¨ ProxyGenerator ç±»ä¸­ã€‚</p>\n<p>è¿™éƒ¨åˆ†çš„è§„åˆ™æ˜¯(åœ¨æ„å»ºæ–°çš„ä»£ç†ç”Ÿæˆç±»æ—¶):</p>\n<ul>\n<li>é¢å¤–æ·»åŠ ä¸‰ä¸ª Object çš„æ–¹æ³• (<code>hashCode</code>, <code>equals</code>, <code>toString</code>)</li>\n<li>é€ä¸€è¯»å–æ‰€æœ‰éœ€è¦å¢å¼ºçš„æ¥å£çš„æ–¹æ³•ï¼Œå¹¶å¯¹é‡å¤æ–¹æ³•è¿›è¡Œåˆ¤æ–­; å¦‚æœæ–¹æ³•åç›¸åŒï¼Œå…¥å‚æ•°é‡ä¸ç±»å‹ç›¸åŒï¼Œä½†è¿”å›å‚æ•°ä¸åŒï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</li>\n<li>åœ¨éå†æ‰€æœ‰æ¥å£çš„æ–¹æ³•çš„æ—¶å€™ï¼ŒåŒæ—¶ä¹Ÿå°†ä¸ºæ–°çš„ç”Ÿæˆç±»æ„é€ æ–°çš„å­—æ®µ(å†…å®¹å°±æ˜¯é€šè¿‡åå°„è·å–è¯¥æ–¹æ³•)</li>\n<li>æœ€åå°†æ–°çš„ç”Ÿæˆç±»å°†è¦åŒ…å«çš„æ‰€æœ‰å­—æ®µä¸æ–¹æ³•è¿›è¡Œæ„é€ ï¼ŒåŒæ—¶ç»´æŠ¤ä¸€ä¸ªå¸¸é‡æ± å†…å®¹</li>\n<li>è¾“å‡ºè¿™äº›å†…å®¹çš„äºŒè¿›åˆ¶è¡¨ç¤º byte[];</li>\n</ul>\n<h2>å¦‚ä½•å¯¹æ–¹æ³•å¢å¼º</h2>\n<p>æƒ³å¿…ä¸Šäº†ä¸Šä¸€èŠ‚ï¼Œè™½ç„¶å¯¹ Java åŠ¨æ€ä»£ç†çš„è°ƒç”¨é“¾æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚</p>\n<p>ä½†æ˜¯ï¼Œç©¶ç«Ÿ Proxy æ˜¯å¦‚ä½•å®Œæˆå¯¹å®ç°ç±»æ–¹æ³•çš„å¢å¼ºå‘¢ï¼Ÿ</p>\n<p>ä¹Ÿè®¸æˆ‘ä»¬éœ€è¦å…ˆçœ‹ä¸€ä¸‹ç”Ÿæˆç±» .class æ–‡ä»¶çš„ä¸€äº›å†…å®¹æ¥å¯¹è¿™ä¸ªå‘½é¢˜å½¢æˆåŸºç¡€æ€§çš„å½±å“ã€‚</p>\n<pre><code class="language-java">public final Code getCode() throws  {\n    try {\n        return (Code)super.h.invoke(this, m4, (Object[])null);\n    } catch (RuntimeException | Error var2) {\n        throw var2;\n    } catch (Throwable var3) {\n        throw new UndeclaredThrowableException(var3);\n    }\n}\n</code></pre>\n<p>å¯ä»¥çœ‹åˆ°ï¼Œç”Ÿæˆç±»çš„ <code>getCode()</code> æ–¹æ³•å‡ ä¹æ²¡æœ‰ä»€ä¹ˆå®è´¨æ€§çš„å†…å®¹, åªæ˜¯ <code>super.h.invoke(...)</code> ã€‚</p>\n<p><code>h</code> å®ä¾‹å˜é‡æ˜¯ä»€ä¹ˆï¼Ÿ<code>InvocationHandler</code> çš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚</p>\n<p>äº‹å®ä¸Šï¼ŒJava Proxy ç”Ÿæˆç±»çš„æ¯ä¸ªæ–¹æ³•ç»“æ„å‡ ä¹éƒ½æ˜¯ç±»ä¼¼çš„ã€‚æ–¹æ³•ä½“çš„å†…å®¹å°±æ˜¯é€šè¿‡å®ä¾‹æŒæœ‰çš„ <code>h</code> å˜é‡åˆ†å‘å®é™…çš„æ“ä½œæŒ‡ä»¤</p>\n<p>è‡³äº h çš„å…·ä½“å†…å®¹ã€‚:) æœ‰ç¼–ç¨‹è€…è‡ªå®šä¹‰ï¼Œå¹¶åœ¨ Proxy ç”Ÿæˆå­—èŠ‚ç ï¼Œå¹¶è¢« ClassLoader åŠ è½½åï¼Œåœ¨å‡†å¤‡å®ä¾‹åŒ–çš„æ—¶å€™ä½œä¸ºæ„é€ å‚æ•°è¿›è¡Œä¼ å…¥ã€‚</p>\n<pre><code class="language-java">ICodeFactory factory = (ICodeFactory) clazz.getConstructor(new Class[] { InvocationHandler.class }).newInstance(new Object[] { handler });\n</code></pre>\n<p>è‡³äºå…·ä½“å°†åšå“ªäº›å¢å¼ºï¼Œè°ƒç”¨ä¾‹å¦‚ä¸Šä¾‹çš„ <code>ICodeFactory</code> çš„é‚£ä¸ªå®ç°ç±»çš„æ–¹æ³•ï¼Œå…¨éƒ¨æœ‰ä½¿ç”¨è€…è‡ªå®šä¹‰ã€‚</p>\n<h2>ç”Ÿæˆç±»çš„åç¼–è¯‘ç»“æœ</h2>\n<p>ä»ç„¶ä»¥æœ¬æ–‡å¼€å§‹çš„ ICodeFactory çš„å¢å¼ºä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹ç©¶ç«Ÿé€šè¿‡ Java Proxy åŠ¨æ€ä»£ç†ç”Ÿæˆçš„å­—èŠ‚ç çš„åç¼–è¯‘ç»“æœç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿ\nå¹¶ä»¥æ­¤æ¥å¯¹è¿™ç§åŠ¨æ€ä»£ç†æœºåˆ¶å½¢æˆæ›´ä¸ºç›´è§‚çš„å°è±¡</p>\n<p>åœ¨ Java æºä»£ç ä¸­ï¼Œè™½ç„¶é»˜è®¤ä¸ä¼šè¾“å‡ºç”Ÿæˆç±»çš„äºŒè¿›åˆ¶å†…å®¹ï¼Œä½†æ˜¯ï¼Œä»ç„¶é¢„ç•™äº†æ‰“å° .class æ–‡ä»¶çš„å¯é€‰é¡¹ã€‚</p>\n<p>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸€ä¸‹ <code>ProxyGenerator.saveGeneratedFiles</code> å­—æ®µçš„å†…å®¹ï¼Œè¿™å°±å†³å®šæ˜¯åœ¨æ„é€ ä»£ç†ç±»åæ˜¯å¦å­˜å‚¨åˆ°å¤–å­˜ä¸­ã€‚</p>\n<p>æƒ³è¦çœ‹åˆ°ä»£ç†ç±»çš„å­—èŠ‚ç ï¼Œç›´æ¥é€šè¿‡åœ¨ Java æ‰§è¡Œç¨‹åºä¸­æ·»åŠ ä¸€è¡Œä»£ç </p>\n<pre><code class="language-java">System.setProperty("sun.misc.ProxyGenerator.saveGeneratedFiles", "true");\n</code></pre>\n<p>æˆ–è€…åœ¨å¯åŠ¨ç¨‹åºçš„ <code>java</code> å‘½ä»¤ä¸‹æ·»åŠ å‚æ•°</p>\n<pre><code class="language-sh">-Dsun.misc.ProxyGenerator.saveGeneratedFiles=true`\n</code></pre>\n<p>è‡³äºç”Ÿæˆç±»å°†æ‰“å°åœ¨å“ªï¼Œé¦–å…ˆå¿…ç„¶æ˜¯åœ¨é¡¹ç›®æ‰€å±çš„ç›®å½•ä¸‹ã€‚æœ‰ä¸Šä¸€èŠ‚ä¸­æ„é€ ç”Ÿæˆç±»å…¨é™å®šåçš„å†…å®¹ï¼Œæ ¹æ®åŒ…åçš„è§„åˆ™å»å¯»æ‰¾å³å¯ã€‚(å…·ä½“ä¸å†è¯¦è¿°)</p>\n<p>ç›´æ¥é€šè¿‡ IDEA, Eclipse æˆ–è€…å…¶å®ƒå·¥å…·ï¼Œå¯¹ç”Ÿæˆç±» .class æ–‡ä»¶è¿›è¡Œåç¼–è¯‘å¯ä»¥æŸ¥çœ‹åˆ°æ•´ä¸ªç”Ÿæˆç±»çš„å†…å®¹ã€‚</p>\n<pre><code class="language-java">package com.sun.proxy;\n\nimport java.lang.reflect.InvocationHandler;\nimport java.lang.reflect.Method;\nimport java.lang.reflect.Proxy;\nimport java.lang.reflect.UndeclaredThrowableException;\nimport me.fangfeng.jdk.proxy.Code;\nimport me.fangfeng.jdk.proxy.ICodeFactory;\n\npublic final class $Proxy0 extends Proxy implements ICodeFactory {\n    private static Method m1;\n    private static Method m2;\n    private static Method m4;\n    private static Method m3;\n    private static Method m0;\n\n    public $Proxy0(InvocationHandler var1) throws  {\n        super(var1);\n    }\n\n    public final boolean equals(Object var1) throws  {\n        try {\n            return (Boolean)super.h.invoke(this, m1, new Object[]{var1});\n        } catch (RuntimeException | Error var3) {\n            throw var3;\n        } catch (Throwable var4) {\n            throw new UndeclaredThrowableException(var4);\n        }\n    }\n\n    public final String toString() throws  {\n        try {\n            return (String)super.h.invoke(this, m2, (Object[])null);\n        } catch (RuntimeException | Error var2) {\n            throw var2;\n        } catch (Throwable var3) {\n            throw new UndeclaredThrowableException(var3);\n        }\n    }\n\n    public final Code getCode() throws  {\n        try {\n            return (Code)super.h.invoke(this, m4, (Object[])null);\n        } catch (RuntimeException | Error var2) {\n            throw var2;\n        } catch (Throwable var3) {\n            throw new UndeclaredThrowableException(var3);\n        }\n    }\n\n    public final void setCode(Code var1) throws  {\n        try {\n            super.h.invoke(this, m3, new Object[]{var1});\n        } catch (RuntimeException | Error var3) {\n            throw var3;\n        } catch (Throwable var4) {\n            throw new UndeclaredThrowableException(var4);\n        }\n    }\n\n    public final int hashCode() throws  {\n        try {\n            return (Integer)super.h.invoke(this, m0, (Object[])null);\n        } catch (RuntimeException | Error var2) {\n            throw var2;\n        } catch (Throwable var3) {\n            throw new UndeclaredThrowableException(var3);\n        }\n    }\n\n    static {\n        try {\n            m1 = Class.forName("java.lang.Object").getMethod("equals", Class.forName("java.lang.Object"));\n            m2 = Class.forName("java.lang.Object").getMethod("toString");\n            m4 = Class.forName("me.fangfeng.jdk.proxy.ICodeFactory").getMethod("getCode");\n            m3 = Class.forName("me.fangfeng.jdk.proxy.ICodeFactory").getMethod("setCode", Class.forName("me.fangfeng.jdk.proxy.Code"));\n            m0 = Class.forName("java.lang.Object").getMethod("hashCode");\n        } catch (NoSuchMethodException var2) {\n            throw new NoSuchMethodError(var2.getMessage());\n        } catch (ClassNotFoundException var3) {\n            throw new NoClassDefFoundError(var3.getMessage());\n        }\n    }\n}\n</code></pre>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},cN4P:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fs8oc4ri7qj30mq055aap.jpg" alt="åŒºå—é“¾ç®€å•ç»“æ„"></p>\n<p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1foxcpmmpfhj31kw107n2e.jpg" alt="Merkle tree"></p>\n<h2>åŸºæœ¬å·¥ä½œæµç¨‹</h2>\n<h3>æ–°äº¤æ˜“å‘èµ·æµç¨‹</h3>\n<ol>\n<li>ç”¨æˆ·é€šè¿‡å…¬/ç§é’¥ä¸åŒºå—é“¾ç½‘ç»œè¿›è¡Œäº¤äº’</li>\n<li>å¤„ç†ç”¨æˆ·äº¤æ˜“çš„èŠ‚ç‚¹å‘ç½‘ç»œé‚»èŠ‚ç‚¹å¹¿æ’­ç”¨æˆ·äº¤æ˜“</li>\n<li>é‚»èŠ‚ç‚¹éªŒè¯äº¤æ˜“çš„æœ‰æ•ˆæ€§ï¼›å¯ä¿¡ï¼Œç»§ç»­å‘å…¶å®ƒé‚»èŠ‚ç‚¹å¹¿æ’­ï¼›ä¸å¯ä¿¡ï¼Œä¸¢å¼ƒã€‚</li>\n</ol>\n<h3>æ–°åŒºå—äº§ç”Ÿæµç¨‹</h3>\n<ol>\n<li>çŸ¿å·¥å°è¯•å°†ä¸€ä¸ªæ—¶é—´åŒºé—´å†…çš„äº¤æ˜“è¿›è¡Œæ‰“åŒ…å½¢æˆæ–°åŒºå—ï¼ˆæ€ä¹ˆæ‰“åŒ…ï¼Œçœ‹ä¸‹æ–‡ï¼‰</li>\n<li>ç”Ÿäº§å‡ºæ–°åŒºå—çš„çŸ¿å·¥èŠ‚ç‚¹å‘ç½‘ç»œå¹¿æ’­æ–°åŒºå—</li>\n<li>æ”¶åˆ°æ–°åŒºå—çš„ç½‘ç»œèŠ‚ç‚¹éªŒè¯è¯¥åŒºå—çš„æœ‰æ•ˆæ€§</li>\n</ol>\n<p><a href="https://blockchain.info/zh-cn">æ¯”ç‰¹å¸åŒºå—æµè§ˆå™¨</a>      æ›´å¤š<a href="https://en.wikipedia.org/wiki/Metric_prefix">å›½é™…å•ä½åˆ¶å‰ç¼€</a></p>\n<h2>ç½‘ç»œå…±è¯†</h2>\n<p>æ‰€æœ‰åŒºå—é“¾ç½‘ç»œèŠ‚ç‚¹éœ€è¦å¯¹äº¤æ˜“ä»¥åŠå…¶åœ¨æ–°åŒºå—é‡Œé¢çš„é¡ºåºè¾¾æˆä¸€è‡´ï¼ˆäº¤æ˜“çš„æœ‰æ•ˆæ€§ä»¥åŠäº¤æ˜“çš„æ‰“åŒ…é¡ºåºï¼‰ã€‚</p>\n<p>å¯èƒ½å‡ºç°ï¼š</p>\n<ul>\n<li>å¥³å·«æ”»å‡»â€”â€”å•ä¸€å®ä½“ä»¥å¤šé‡èº«ä»½é‡å¤å¯¹æ–°åŒºå—ç»“æœè¿›è¡Œè¡¨å†³ï¼ˆå°‘æ•°äººæŠ“ä½äº†ç½‘ç»œçš„æŠ•ç¥¨æƒï¼‰</li>\n<li><a href="https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98">æ‹œå åº­å°†å†›é—®é¢˜</a>â€”â€”åˆ†å¸ƒå¼å¯¹ç­‰ç½‘ç»œçš„é€šä¿¡å®¹é”™é—®é¢˜<ul>\n<li>ä¸åŒçš„è®¡ç®—æœºé€šè¿‡é€šè®¯äº¤æ¢ä¿¡æ¯è¾¾æˆå…±è¯†è€ŒæŒ‰ç…§åŒä¸€å¥—åä½œç­–ç•¥è¡ŒåŠ¨<ul>\n<li>æˆå‘˜è®¡ç®—æœºå¯èƒ½å‡ºé”™è€Œå‘é€é”™è¯¯ä¿¡æ¯</li>\n<li>ç½‘ç»œçš„ä¸å¯é æ€§</li>\n<li>ä»è€Œå½±å“ç½‘ç»œå…±è¯†çš„è¾¾æˆï¼Œç ´åä¸€è‡´æ€§ã€‚</li>\n</ul></li>\n<li>ä¸è§£å†³çš„è¯å¯èƒ½å¯¼è‡´â€”â€”åŒºå—é“¾åˆ†å‰</li>\n</ul></li>\n</ul>\n<p>è§£å†³æ–¹æ¡ˆï¼š</p>\n<ul>\n<li>å·¥ä½œé‡è¯æ˜ï¼ˆproof-of-work, PoWï¼‰ï¼Œæƒç›Šè¯æ˜(proof-of-stake, PoS)ï¼Œç™½åå•æœºåˆ¶ï¼ˆä»…é€‚ç”¨äºç§æœ‰ç½‘ç»œï¼‰ç­‰</li>\n<li>å®ç”¨æ‹œå åº­å®¹é”™ç®—æ³•</li>\n</ul>\n<h3>å±€é™</h3>\n<p>ç½‘ç»œå…±è¯†æœºåˆ¶çš„å®ç°å¯¼è‡´äº†ï¼š</p>\n<ol>\n<li>äº¤æ˜“ååé‡</li>\n<li>æ›´é«˜çš„äº¤æ˜“æ—¶å»¶ã€‚äº¤æ˜“ç¡®è®¤æ—¶é—´ï¼ˆåªæœ‰æ‰“åŒ…çš„æ–°åŒºå—ä¸­æ‰äº¤æ˜“æ‰ä¼šè¢«æ‰¿è®¤ï¼‰ã€‚</li>\n</ol>\n<p>å…±è¯†æœºåˆ¶çš„ä¼¸ç¼©å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šè§£å†³ä¸Šè¿°é—®é¢˜</p>\n<h2>èµ„äº§äº¤æ˜“</h2>\n<p>ç®€å•äº¤æ˜“çŠ¶æ€æè¿°ï¼Œä»¥é›†ä¸­å¼æ•°æ®åº“ä¸ºä¾‹</p>\n<p>å‡è®¾åˆå§‹çŠ¶æ€ä¸º</p>\n<pre><code>-------------------------\n| èµ„äº§ç±»å‹ | æ‰€æœ‰è€… | æ•°é‡ |\n-------------------------\n|   CNY   |  é˜²é£  |  10 |\n-------------------------\n|   CNY   |  çº¢è–¯  |  0  |\n-------------------------\n</code></pre>\n<p>é˜²é£ å‘ çº¢è–¯ è½¬è´¦ 2 CNY </p>\n<pre><code>-------------------------\n| èµ„äº§ç±»å‹ | æ‰€æœ‰è€… | æ•°é‡ |\n-------------------------\n|   CNY   |  é˜²é£  |  8  |\n-------------------------\n|   CNY   |  çº¢è–¯  |  2  |\n-------------------------\n</code></pre>\n<p>æ•°æ®åº“ä¸­ç›¸åº”è®°å½•çš„æ›´æ”¹å®Œæˆäº†èµ„äº§çš„äº¤æ˜“è¿‡ç¨‹ã€‚</p>\n<p>åœ¨åŒºå—é“¾ä¸­ï¼Œä»ç„¶å°†åˆ†å¸ƒå¼é“¾çœ‹ä½œæ˜¯ä¸€ä¸ªè¾¾æˆå…±è¯†çš„é›†ä¸­å¼æ•°æ®åº“</p>\n<p>é‚£ä¹ˆç°åœ¨çš„åˆå§‹çŠ¶æ€å¯ä»¥è¡¨ç¤ºæˆ</p>\n<pre><code>---------------------------------\n| èµ„äº§ç±»å‹ |     æ‰€æœ‰è€…     | æ•°é‡ |\n---------------------------------\n|   IOTA  |  é˜²é£ pub_key  | 10  |\n---------------------------------\n</code></pre>\n<p>ç°åœ¨çš„æ‰€æœ‰è€…ç”±å…¬é’¥è¡¨ç¤ºï¼Œæƒ³è¦ä¿®æ”¹è®°å½•å¿…é¡»æä¾›å¯¹åº”çš„å¯†é’¥ã€‚</p>\n<p>ä¾‹å¦‚ï¼Œé˜²é£ å‘ çº¢è–¯ è½¬è´¦ 2 IOTA ï¼Œéœ€è¦æä¾›é˜²é£çš„ç§é’¥å’Œçº¢è–¯çš„å…¬é’¥ã€‚äº¤æ˜“è®°å½•ä¿®æ”¹ç»“æœï¼š</p>\n<pre><code>---------------------------------\n| èµ„äº§ç±»å‹ |     æ‰€æœ‰è€…     | æ•°é‡ |\n---------------------------------\n                                 è¢«åˆ é™¤äº†         |   IOTA  |  é˜²é£ pub_key  | 10  |\n---------------------------------\n|   IOTA  |  çº¢è–¯ pub_key  |  2  |\n---------------------------------\n|   IOTA  |  é˜²é£ pub_key  |  8  |\n</code></pre>\n<p>äº¤æ˜“çš„æ¦‚å¿µæµç¨‹ï¼š</p>\n<ol>\n<li>å®šä½é˜²é£æ‰€æœ‰çš„èµ„äº§è®°å½•è¡Œ</li>\n<li>åˆ é™¤è¯¥è¡Œå‰éªŒè¯å¯†é’¥</li>\n<li>ç¡®è®¤è¯¥è®°å½•æ²¡æœ‰è¢«åˆ«çš„äº¤æ˜“ä½¿ç”¨ï¼ˆåŒèŠ±é—®é¢˜ï¼ŒåŒé‡äº¤æ˜“ï¼‰</li>\n<li>å†™å…¥æ–°çš„æ­£ç¡®çš„è®°å½•ï¼ˆçº¢è–¯è·å¾—çš„èµ„äº§ &#x26; é˜²é£å‰©ä½™çš„èµ„äº§ï¼‰ï¼Œç¡®ä¿äº¤æ˜“å‰ä¸äº¤æ˜“åèµ„äº§æ€»é¢ä¸å˜</li>\n</ol>\n<p>ä¸Šé¢çš„æ¨¡å‹ â€”â€” åŸºäºæ¯”ç‰¹å¸çš„äº¤æ˜“æ¨¡å‹(UTXO <em>model</em>)</p>\n<p><strong>é€‚åˆäºæ•°å­—æ ‡è®°èµ„äº§çš„ä¼ è¾“ä¸è¿½è¸ª</strong></p>\n<ul>\n<li>æ¦‚å¿µï¼šUTXO (unspent transaction outputs) æœªèŠ±è´¹çš„äº¤æ˜“è¾“å‡ºï¼šæ•°æ®åº“ç°æœ‰çš„è®°å½•</li>\n</ul>\n<p>---------------------------------</p>\n<p>å¦ä¸€ç§æ¨¡å‹å¸¸ç”¨äºæ™ºèƒ½åˆçº¦ â€”â€” åŸºäºè´¦å·çš„æ¨¡å‹(account-based <em>model</em>)</p>\n<p><strong>æä¾›äº†å»ºç«‹å¤šæ­¥éª¤æ‰§è¡Œçš„åŸºæœ¬æœºåˆ¶</strong> </p>\n<h3>èµ„äº§å¦‚ä½•äº§ç”Ÿ</h3>\n<ul>\n<li>æ¯”ç‰¹å¸ï¼š<ul>\n<li>çŸ¿å·¥èŠ‚ç‚¹å…è®¸åœ¨æŒ–å‡ºçš„æ–°èŠ‚ç‚¹ä¸­åŠ å…¥ä¸€ç§ coinbase ç±»å‹çš„äº¤æ˜“ï¼ˆä¸å­˜åœ¨äº¤æ˜“è¾“å…¥ï¼Œæ–°èµ„äº§æ•°é¢æœ‰æ¯”ç‰¹å¸é“¾æå‰å®šä¹‰ï¼‰</li>\n</ul></li>\n<li>åœ¨åˆ›å§‹æ–°ä»£å¸çš„æ—¶å€™å…¨é¢å‘è¡Œ</li>\n<li>å…¶å®ƒæœºåˆ¶</li>\n</ul>\n<h2>åŒºå—é“¾ç‰¹æ€§</h2>\n<ol>\n<li>ä¸€ç§å¥å£®çš„ã€çœŸæ­£çš„åˆ†å¸ƒå¼å¯¹ç­‰ç³»ç»Ÿï¼Œå®ƒèƒ½å®¹å¿èŠ‚ç‚¹æ•…éšœã€‚</li>\n<li>èƒ½å¤Ÿè¯†åˆ«å†²çªå’Œåˆ†å‰å¹¶è‡ªåŠ¨è§£å†³çš„ç½‘ç»œï¼Œä»¥ä¾¿æ”¶æ•›åˆ°å•ä¸€çš„ã€å…¬è®¤çš„å”¯ä¸€çŠ¶æ€ã€‚ï¼ˆåŒºå—é“¾æ°¸è¿œé€‰æ‹©æœ€é•¿çš„åˆ†æ”¯æ¥è¾¾æˆç½‘ç»œä¸Šçš„å…±è¯†ï¼‰</li>\n<li>ç½‘ç»œæ´»åŠ¨çš„é€æ˜æ€§ã€å¯éªŒè¯æ€§ã€å¯å®¡è®¡æ€§ã€‚æˆ‘ä»¬èƒ½è·å–å¯éªŒè¯çš„è¿‡ç¨‹ï¼Œæ— è®ºå®ƒä»¬æ˜¯å¦äº¤æ¢å’Œè·Ÿè¸ªæ•°å­—èµ„äº§ï¼Œè¿˜æ˜¯æ•°æ®é©±åŠ¨çš„äº¤äº’ã€‚æ¯ä¸€ä¸ªè¡Œä¸ºï¼Œéƒ½å­˜æœ‰å…¬å¼€çš„ä¸ç½‘ç»œäº¤äº’çš„è®°å½•ï¼Œå¹¶ä»¥æ­¤æ¥æ¶ˆé™¤äººä¸ºçš„çŸ›ç›¾ã€‚</li>\n<li>è¿™æ˜¯ä¸€ç§å¯ä»¥æ ‡è®°ä¸åŒä¿¡æ¯çš„è§¦å‘è€…çš„æ–¹æ³•ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨æ²¡æœ‰ä¸­å¤®æƒå¨çš„æƒ…å†µä¸‹å¼ºåˆ¶æ‰§è¡Œã€‚</li>\n<li>è¿™æ˜¯ä¸€ä¸ªä½¿å¾—ä¸ä¿¡ä»»åŒæ–¹æ ¹æ®å¯é¢„æµ‹çš„ã€ç¡®å®šæ€§çš„æ–¹å¼äº¤äº’çš„ç³»ç»Ÿã€‚</li>\n</ol>\n<h2>æ™ºèƒ½åˆçº¦</h2>\n<p>è‡ªåŠ¨åŒ–åœ°æ‰§è¡Œä¸€ç³»åˆ—åˆçº¦æ¡æ¬¾çš„äº¤æ˜“åè®®</p>\n<p>æ™ºèƒ½åˆçº¦æ˜¯å­˜å‚¨åœ¨åŒºå—é“¾ä¸­çš„è„šæœ¬ï¼ˆè®¤è¯†ä¸Šå¯ä»¥ä¸å…³ç³»å‹æ•°æ®åº“çš„å­˜å‚¨è¿‡ç¨‹ç±»ä¼¼ï¼‰ã€‚</p>\n<p>ä»¥åŸºäºè´¦å·çš„æ¨¡å‹ä¸ºä¾‹å¯¹åˆçº¦æ‰§è¡Œè¿›è¡Œæè¿°ï¼š</p>\n<pre><code>å‡è®¾å®šä¹‰ä¸€ä¸ªåˆçº¦ï¼ŒåŒ…æ‹¬ä¸‰ä¸ªæ–¹æ³•\n\n(1) â€œå­˜å‚¨â€â€”â€”åˆçº¦çš„â€œå­˜æ¬¾â€åŠŸèƒ½å…è®¸ é˜²é£ï¼ˆé€šè¿‡é˜²é£çš„å¯†é’¥éªŒè¯ï¼‰å°†è‹¥å¹²å•ä½çš„Xå­˜å…¥åˆçº¦ä¸­ï¼›\n(2) â€œäº¤æ˜“â€â€”â€”â€œäº¤æ˜“â€åŠŸèƒ½å…è®¸ä»»ä½•äººå‘åˆçº¦å‘é€5å•ä½Yï¼Œå¹¶ä»åˆçº¦æŒæœ‰çš„Xä¸­è¿”å›1å•ä½ç»™äº¤æ˜“æ–¹ï¼›\n(3) â€œæ’¤é”€â€â€”â€”â€œæ’¤é”€â€åŠŸèƒ½å…è®¸ é˜²é£ å–å‡ºåˆçº¦ä¸­å­˜æœ‰çš„æ‰€æœ‰èµ„äº§ã€‚\n\n    è¯·æ³¨æ„ï¼Œä¸Šè¿°â€œå­˜æ¬¾â€å’Œâ€œæ’¤é”€â€åŠŸèƒ½è¢«é™åˆ¶ä¸ºåªå…è®¸è¢« é˜²é£ï¼ˆå®é™…ä¸Šæ˜¯é˜²é£çš„ç§é’¥ï¼‰è°ƒç”¨ã€‚å½“ç„¶ï¼Œè¿™åªæœ‰ç”±äºä¸Šè¿°åˆçº¦ç”±é˜²é£åˆ¶å®šã€‚è‹¥äººä¸ºçš„åˆ¶å®šä¸€ä¸ªæ‰€æœ‰äººéƒ½èƒ½è°ƒç”¨ä»»ä½•åŠŸèƒ½çš„åˆçº¦ä¹Ÿæ˜¯å…è®¸çš„ï¼ˆè™½ç„¶è¿™åœ¨äº‹å®ä¸Šæ²¡æœ‰æ„ä¹‰ï¼‰ã€‚\n</code></pre>\n<p>é‚£ä¹ˆåœ¨åŸºäºè´¦æˆ·çš„æ¨¡å‹ä¸‹ï¼Œå¯ä»¥è®¤ä¸º æ‹¥æœ‰â€œå­˜å‚¨â€ã€â€œäº¤æ˜“â€ã€â€œæ’¤é”€â€æ–¹æ³•çš„åˆçº¦æŒæœ‰ä¸€ä¸ªå•ç‹¬çš„è´¦æˆ·ï¼ˆä¸ç”¨æˆ·æ‰€æŒæœ‰çš„è´¦æˆ·ç­‰ä»·ï¼‰ã€‚</p>\n<p>åœ¨ä¸Šè¿°åˆçº¦ä¸‹ï¼Œè¿™ä¸ªè´¦æˆ·å°†å¯èƒ½æŒæœ‰ä¸€å®šæ•°é‡çš„èµ„äº§ã€‚é™¤äº†åªèƒ½æŒ‰ç…§é¢„å®šçš„åˆçº¦æ­¥éª¤å¯¹èµ„äº§è¿›è¡Œå¤„ç½®ä¹‹å¤–ï¼Œå…¶å®ƒä¸ç”¨æˆ·æŒæœ‰çš„è´¦æˆ·åˆ«æ— äºŒè‡´ã€‚</p>\n<pre><code class="language-text">  __                    __\n / _| __ _ _ __   __ _ / _| ___ _ __   __ _\n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/\n</code></pre>'}},fORH:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>æœ€è¿‘é‡æ–°å¼€å§‹å›é¡¾ C è¯­è¨€ä»¥åŠå…¶ç¼–è¯‘åçš„æ–‡ä»¶æ ¼å¼ ELFã€‚\næš‚æ—¶å‘Šåˆ«ä¸€æ­¥åˆ°ä½çš„å‘½ä»¤ <code>gcc main.c</code>ï¼Œå¦‚æœä» <code>.c</code> æ–‡ä»¶çš„ç¼–è¯‘æ¥è¯´ï¼Œä¸»è¦åˆ†ä¸ºé¢„ç¼–è¯‘(preprocess)ã€ç¼–è¯‘(Compilation)ã€æ±‡ç¼–(Assembly)ã€é“¾æ¥(Linking) å››ä¸ªæ­¥éª¤ã€‚\nä½†æ˜¯ï¼Œä»…ä»…ä»ç¬¬ä¸€ä¸ªæµç¨‹ <strong>é¢„ç¼–è¯‘</strong> è€Œè¨€ï¼Œå°±å·²ç»é‡åˆ°äº†ä¸€äº›éº»çƒ¦ã€‚</p>\n<p>program.i</p>\n<pre><code class="language-c"># 1 "program.c"\n# 1 "&#x3C;built-in>"\n# 1 "&#x3C;command-line>"\n# 1 "/usr/include/stdc-predef.h" 1 3 4\n# 1 "&#x3C;command-line>" 2\n# 1 "program.c"\n# 1 "header.h" 1\nchar *test(void);\n# 2 "program.c" 2\n\nint main(void)\n{\n}\n</code></pre>\n<p>é¢„ç¼–è¯‘åçš„é—®é¢˜å‡ºç°äº†è¯¸å¦‚ <code># 1 "program.c"</code> çš„ <em>æ³¨é‡Š?</em> </p>\n<p>è¿™é‡Œç®€å•è®°å½•é¢„å¤„ç†è¾“å‡ºæ–‡ä»¶çš„åŸºæœ¬æ ¼å¼ï¼Œæ–¹ä¾¿ä»Šåå›é¡¾ã€‚</p>\n<h2>Output File format</h2>\n<p>é¦–å…ˆï¼Œä»é¢„ç¼–è¯‘çš„ç»“æœçœ‹ï¼Œ<code>cpp (C preprocessor)</code> ç¨‹åºä¸»è¦æ˜¯å¤„ç†äº†æ‰€æœ‰çš„<strong>å®æŒ‡ä»¤</strong>ã€‚ç„¶åæ·»åŠ ä¸Šäº†ä¸€äº›æ‰€è°“<strong>çº¿æ€§æ ‡è®°</strong>çš„å†…å®¹ã€‚\næœ€ç»ˆå¾—åˆ°çš„å°±æ˜¯ç±»ä¼¼ <code>program.i</code> çš„ç»“æœã€‚</p>\n<p>ä»ç»†èŠ‚ä¸Šæ¥è¯´:\né¦–å…ˆï¼Œæ‰€æœ‰çš„å®æŒ‡ä»¤ï¼ŒåŒ…æ‹¬ <code>#include</code> (ç”¨äºå¼•å…¥ç”¨æˆ·è‡ªå®šä¹‰åŠç³»ç»Ÿé¢„å®šä¹‰çš„å¤´æ–‡ä»¶)ã€<code>#define</code> (ç”¨äºå°†ä½¿ç”¨åˆ°çš„å®è¿›è¡Œæ›¿æ¢)ã€‚\nå½“ç„¶ï¼Œåœ¨æ›¿æ¢å®Œæˆåï¼Œè¿™äº›æŒ‡ä»¤æ‰€åœ¨çš„è¡Œå°†è¢«æ›¿æ¢æˆç©ºè¡Œã€‚åŒæ—¶ï¼Œæ‰€æœ‰çš„æ³¨é‡Šè¡Œä¹Ÿå°†è¢«æ›¿æ¢æˆç©ºè¡Œã€‚</p>\n<p>æ­¤å¤–ï¼Œå°†æ·»åŠ ä¸Šæ³¨å…¥ <code>#1 "program.c"</code> çš„<strong>çº¿æ€§æ ‡è®°</strong>ã€‚</p>\n<h3>çº¿æ€§æ ‡è®°</h3>\n<p>çº¿æ€§æ ‡è®°çš„æ ‡å‡†æ ¼å¼:</p>\n<p><code># linenum filename flags</code></p>\n<p>linenum æ˜¯ä¸ºäº†é…åˆé¢„å®šä¹‰å® <code>__LINE__</code> æ˜¯ä½¿ç”¨çš„ï¼Œç”¨äºå®šä½ç´§éšçš„ä¸‹ä¸€è¡Œå†…å®¹åœ¨åŸæ–‡ä»¶ä¸­æ‰€åœ¨çš„è¡Œã€‚</p>\n<p>filename æŒ‡å‡ºäº†æ¥ä¸‹æ¥çš„å†…å®¹æ¥è‡ªå“ªä¸ªåŸæ–‡ä»¶</p>\n<p>flags æœ‰å¦‚ä¸‹å‡ ä¸ªå–å€¼:</p>\n<ul>\n<li>1 : è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ–°çš„æ–‡ä»¶çš„å¼€å§‹</li>\n<li>2 : è¡¨ç¤ºå›åˆ°æ–‡ä»¶ <code>filename</code> çš„å†…å®¹ (ä»å…¶ä»–çš„ <em>include</em> çš„æ–‡ä»¶ä¸­)</li>\n<li>3 : è¡¨ç¤ºæ¥ä¸‹æ¥çš„å†…å®¹æ˜¯ä»ç³»ç»Ÿé¢„å®šä¹‰å¤´æ–‡ä»¶ä¸­æ¥çš„ï¼Œå› æ­¤éœ€è¦æŠ‘åˆ¶æŸäº›è­¦å‘Š</li>\n<li>4 : è¡¨ç¤ºæ¥ä¸‹æ¥çš„å†…å®¹éœ€è¦è¢«è§†ä½œæ˜¯è¢«å°è£…çš„éšå¼ <code>extern "C"</code> å—</li>\n</ul>\n<h3>å®ä¾‹è§£è¯»</h3>\n<p>program.c</p>\n<pre><code class="language-c">#include "header.h"\nint main(void)\n{\n    puts(test());\n}\n</code></pre>\n<p>header.h</p>\n<pre><code class="language-c">char *test(void);\n</code></pre>\n<p>æ¥ä¸‹æ¥çš„æ¼”ç¤ºéƒ½å°†ä»¥ <strong>program.c</strong> å’Œ <strong>header.h</strong> ä¸¤ä¸ªæ–‡ä»¶ä½œä¸ºæ ‡å‡†ç¤ºä¾‹ã€‚\næœŸé—´ï¼Œå°†å¯¹ <strong>program.c</strong> or <strong>header.h</strong> åšä¸åŒç¨‹åº¦çš„ä¿®æ”¹ï¼Œå·²è¾¾åˆ°æ›´å¥½çš„å±•ç¤ºæ•ˆæœã€‚\n<em>æ³¨æ„:</em> é¢å¤–æ·»åŠ çš„æ³¨é‡Šç”± <code>!</code> å¼€å§‹åˆ°è¯¥è¡Œç»“æŸ(å¹¶ä¸ç¬¦åˆ C è¯­è¨€è¯­æ³•)ï¼Œä½†æ˜¯å¸®åŠ©ç†è§£</p>\n<p><strong>Sample 1</strong></p>\n<p>ç›´æ¥åˆ©ç”¨ program.c ä¸ header.h è¿›è¡Œé¢„ç¼–è¯‘ <code>cpp -o program.i program.c</code>\nç»“æœå¦‚ä¸‹:</p>\n<pre><code class="language-c"># 1 "program.c"\n# 1 "&#x3C;built-in>"\n# 1 "&#x3C;command-line>"\n# 1 "/usr/include/stdc-predef.h" 1 3 4\n# 1 "&#x3C;command-line>" 2\n# 1 "program.c"\n# 1 "header.h" 1            ! ä¸‹ä¸€è¡Œä»£ç å¯¹åº”çš„æ˜¯ header.h æ–‡ä»¶ç¬¬ä¸€è¡Œ\nchar *test(void);\n# 2 "program.c" 2           ! flag=2 è¡¨ç¤ºä¸‹åˆ—å†…å®¹ç”±å›åˆ°äº† program.c ä¸­ï¼Œä¸‹ä¸€è¡Œå¯¹åº”åŸæ–‡ä»¶ç¬¬äºŒè¡Œ\n\nint main(void)\n{\n    puts(test());\n}\n</code></pre>\n<p><strong>Sample 2</strong></p>\n<p>æ¥ç€ï¼Œç»™ <strong>program.c</strong> åŠ ç‚¹æ³¨é‡Šï¼Œåœ¨åŠ ç‚¹ç©ºè¡Œ</p>\n<p>program.c - sub 1</p>\n<pre><code class="language-c">// This is comment          ! è¿™é‡Œæ·»åŠ äº†ä¸€è¡Œæ³¨é‡Š\n#include "header.h"\n\n                            ! è¿™é‡ŒåŠ äº†ä¸ªç©ºè¡Œ\nint main(void)\n{\n    puts(test());\n}\n</code></pre>\n<p>å†çœ‹çœ‹æ•ˆæœ</p>\n<pre><code class="language-c"># 1 "program.c"\n# 1 "&#x3C;built-in>"\n# 1 "&#x3C;command-line>"\n# 1 "/usr/include/stdc-predef.h" 1 3 4\n# 1 "&#x3C;command-line>" 2\n# 1 "program.c"             ! ä¸‹ä¸€è¡Œä»£ç å¯¹åº”åŸä»£ç ä¸­ç¬¬ 1 è¡Œï¼Œæœ¬æ¥æ˜¯æ³¨é‡Šï¼Œä½†ä¼šè¢«é¢„ç¼–è¯‘å™¨å¤„ç†æˆç©ºè¡Œ (å¤šè¡Œå°†é€ä¸€å¤„ç†ï¼Œä½†è¡Œæ•°ä¸ä¼šå˜)\n\n# 1 "header.h" 1            ! ä¸‹é¢å°†æè¿° header.h çš„ä»£ç \nchar *test(void);\n# 3 "program.c" 2           ! ç»§ç»­æè¿° program.c ï¼Œä¸‹ä¸€è¡Œå¯¹åº”åŸä»£ç ç¬¬ 3 è¡Œã€‚è‡³äºç¬¬ 2 è¡Œï¼Œå°±æ˜¯ #include "header.h" ï¼Œä¸ä¼šç›´æ¥è¡¨ç°äº†\n\n\nint main(void)\n{\n    puts(test());\n}\n</code></pre>\n<p><strong>Sample 3</strong></p>\n<p>åœ¨æ”¹å˜ä¸€äº›</p>\n<p>program.c - sub 2</p>\n<pre><code class="language-c">// This is comment\n#include "header.h"\n#define TEN 10\n\nint main(void)\n{\n    puts(test());\n}\n</code></pre>\n<p>çœ‹çœ‹ç»“æœ</p>\n<pre><code class="language-c"># 1 "program.c"\n# 1 "&#x3C;built-in>"\n# 1 "&#x3C;command-line>"\n# 1 "/usr/include/stdc-predef.h" 1 3 4\n# 1 "&#x3C;command-line>" 2\n# 1 "program.c"\n\n# 1 "header.h" 1\nchar *test(void);\n# 3 "program.c" 2\n                        ! åŸä»£ç ä¸­å¯¹åº”è¡Œæ˜¯å® #define TEN 10 ï¼Œå·²ç»è¢«ç©ºè¡Œæ›¿æ¢æ‰äº†ã€‚\n\nint main(void)\n{\n    puts(test());\n}\n</code></pre>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},frAL:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p><a href="./2019-01-15-understand-Kernel-8/">å‰ä¸€ç¯‡</a>å·²ç»å¯¹ Linux å†…æ ¸ç½‘ç»œç›¸å…³çš„å†…å®¹è¿›è¡Œäº†åŸºç¡€æ€§çš„ä»‹ç»ã€‚æ•°æ®ä»åˆ°è¾¾ç½‘å¡ï¼Œåˆ°æœ€ç»ˆè¢«ç”¨æˆ·è¿›ç¨‹è·å–ï¼Œæœ€å°‘ç»è¿‡äº†ä¸‰ä¸ªè¿›ç¨‹/ç¡¬ä¸­æ–­çš„é…åˆï¼šç½‘ç»œä¸­æ–­è´Ÿè´£å°†ç½‘ç»œæ¥æ”¶åˆ°çš„æ•°æ®è¯»å–åˆ°å†…å­˜å¹¶æ·»åŠ åˆ° softnet_data é˜Ÿåˆ—ï¼Œå¹¶è®¾ç½®è½¯ä¸­æ–­é€šçŸ¥å†…æ ¸è¿›ç¨‹ ksoftirqdï¼›å†…æ ¸è¿›ç¨‹ ksoftirqd è¢«è°ƒåº¦å¹¶å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå¤„ç†ä½äº softnet_data ä¸­çš„ <code>struct sock</code> å¯¹è±¡ï¼Œå°†å…¶é€çº§ä»ç½‘ç»œæ¥å£å±‚é€çº§æå‡åˆ°ç½‘ç»œå±‚ã€ä¼ è¾“å±‚...æœ€ç»ˆæ·»åŠ åˆ°æ¥æ”¶é˜Ÿåˆ— <code>sk_receive_queue</code> ä¸­ï¼›ç”¨æˆ·è¿›ç¨‹é€šè¿‡ <code>read</code>ã€<code>recv</code>ã€<code>recvfrom</code> ç­‰å‘½ä»¤æ£€æŸ¥å¹¶è·å– <code>sk_receive_queue</code> ä¸­çš„æ•°æ®ã€‚</p>\n<p>æ•´ä¸ªæµç¨‹ä»æ¦‚è¿°ä¸Šå¯ä»¥å¾ˆè½»æ¾åœ°é…åˆè¿›è¡Œç½‘ç»œæ•°æ®äº¤äº’ï¼Œä½†å¦‚æœè¦ç›‘æ§å¤šä¸ªç½‘ç»œå¥—æ¥å­—å‘¢ï¼Ÿå¤„ç†æµç¨‹å°†å˜å¾—å¤æ‚ã€‚æˆ‘ä»¬æ— æ³•é¢„çŸ¥å“ªä¸ªå¥—æ¥å­—èƒ½ä¼˜å…ˆæ¥æ”¶åˆ°æ•°æ®ã€‚å› æ­¤ï¼Œæœ€ç›´æ¥çš„åŠæ³•å°±æ˜¯è½®è¯¢ï¼Œåœ¨ç”¨æˆ·ç¨‹åºç¡¬ç¼–ç ï¼Œé€šè¿‡è®¾ç½®è¶…æ—¶æ—¶é—´çš„æ–¹å¼å°è¯•è·å–æ•°æ®ã€‚å½“ç„¶ï¼Œè¿™ä¸ªæ•ˆç‡å°±ç›¸å½“ä½ä¸‹äº†ã€‚æ¯æ¬¡è¯•æ¢éƒ½éœ€è¦è§¦å‘ç³»ç»Ÿè°ƒç”¨ï¼ˆè¦çŸ¥é“è¿™ä»£ä»·å¯æ˜¯ç›¸å½“å¤§çš„ï¼‰ï¼Œå¦å¤–è¶…æ—¶æ—¶é—´çš„è®¾ç½®ä¹Ÿæ˜¯ä¸€ä¸ªç¡¬æ€§çš„é˜»å¡å¼æ¶ˆè€—ã€‚</p>\n<p>é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿå½“ç„¶æœ‰ã€‚é€šè¿‡ç”¨æˆ·ç¨‹åºç¡¬ç¼–ç å¼çš„è½®è¯¢æ˜¾ç„¶æ˜¯é™·å…¥æ€§èƒ½ç“¶é¢ˆçš„æ ¹æºã€‚å› æ­¤å†…æ ¸ä¸»åŠ¨æä¾›äº†è½®è¯¢å¼çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆ<code>select</code>, <code>poll</code>, <code>epoll</code>ï¼‰ã€‚é€šè¿‡å°†è½®è¯¢é€»è¾‘ä¸‹æ²‰åˆ°å†…æ ¸æ€ï¼Œç³»ç»Ÿè°ƒç”¨å°±åªä¼šæœ‰ä¸€æ¬¡ï¼Œè€Œä¸”è¶…æ—¶æ—¶é—´çš„è®¾ç½®ä¹Ÿæ˜¾å¾—ç»Ÿä¸€ã€‚æœ¬ç¯‡å°±è¦å°± <code>select</code> å’Œ <code>epoll</code> ä¸¤ç±»ç³»ç»Ÿè°ƒç”¨çš„å®ç°è¿›è¡Œæ¢ç©¶ã€‚</p>\n<h2>SELECT</h2>\n<p><code>select</code> æ˜¯ä¸€ç§æ¯”è¾ƒå¤è€çš„ç³»ç»Ÿè°ƒç”¨æ–¹å¼ï¼Œå­˜åœ¨ç€è®¸å¤šçš„è°ƒç”¨é™åˆ¶ã€‚å½“ç„¶ï¼Œç›¸å¯¹çš„ä¹Ÿå°±æ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚</p>\n<p><code>select</code> ç³»ç»Ÿè°ƒç”¨æœ€åˆçš„é€»è¾‘å°±æ˜¯å¯¹è¶…æ—¶æ—¶é—´çš„ç›¸å…³æ“ä½œï¼Œå®Œæˆä»ç”¨æˆ·æ•°æ®æ®µåˆ°å†…æ ¸æ•°æ®æ®µçš„æ•°æ®æ‹·è´å·¥ä½œï¼Œè€Œä½¿ç”¨ <code>copy_from_user</code> çš„ç›®çš„ï¼Œè™½ç„¶çœ‹ä¼¼æ¯”è¾ƒæ™¦æ¶©ï¼Œä¸å¦‚å¤§å®¶åœ¨ç”¨æˆ·ç¨‹åºä¸­æ™®é€šè°ƒç”¨çš„memcpyï¼Œä½†ç©¶å…¶åŸå› ï¼Œæ˜¯ä¸ºäº†å¤„ç†MMUç›¸å…³çš„é—®é¢˜ã€‚å°†å†…æ ¸å¤åˆ¶çš„æ•°æ®timevalåšä¸€å®šçš„å–æ•´æ“ä½œï¼ˆå› ä¸ºç¡¬ä»¶ä¸­æ–­çš„ç²¾åº¦å¯èƒ½è¾¾ä¸åˆ°timevalæ‰€æè¿°çš„ç²’åº¦ï¼Œæ•…æ ¹æ®HZåšå–æ•´ï¼Œæ°å¥½ä¸ºæ—¶é’Ÿä¸­æ–­å‘¨æœŸçš„æ•´æ•°å€ï¼‰ã€‚è°ƒç”¨ <code>core_sys_select</code> è¿›è¡ŒçœŸæ­£çš„è½®è¯¢æ“ä½œï¼ˆå½“ç„¶ï¼Œå¥½åƒä¹Ÿç®—ä¸ä¸ŠçœŸæ­£çš„é€»è¾‘ï¼Œè¿˜æœ‰ä¸€å±‚æ ¸å¿ƒçš„è°ƒç”¨å‘¢ï¼‰ã€‚ç»“æŸåçš„æ“ä½œå½“ç„¶æ˜¯å‡†å¤‡æ›´æ–°timevalã€‚å› ä¸ºè¿›è¡Œè½®è¯¢çš„ç»“æœæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å› ä¸ºè¶…æ—¶è€Œç»“æŸ <code>core_sys_select</code> å‡½æ•°è°ƒç”¨ï¼›å¦ä¸€ç§æ˜¯å¾—åˆ°äº†ä¸€ä¸ªæˆ–å¤šä¸ªå‡†å¤‡å°±ç»ªçš„æ•°æ®ï¼Œæ‰ç»“æŸè°ƒç”¨å¹¶è¿”å›ã€‚æ˜¾ç„¶ï¼Œå› ä¸ºç¬¬äºŒç§ç»“æœè€Œæ›´æ–°timevalæœ‰ç€ä¸€å®šçš„å®é™…æ„ä¹‰â€”â€”åˆ°åº•ç­‰å¾…äº†å¤šä¹…ã€‚ä¸è¿‡è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸æ˜¯æ‰€æœ‰çš„Linuxç³»ç»Ÿéƒ½æ”¯æŒå¯¹timevalåšæ›´æ–°ã€‚</p>\n<pre><code class="language-c">asmlinkage long sys_select(int n, fd_set __user *inp, fd_set __user *outp,\n            fd_set __user *exp, struct timeval __user *tvp)\n{\n    s64 timeout = -1;\n    struct timeval tv;\n    int ret;\n\n    /* å¦‚æœè®¾ç½®äº†è¶…æ—¶æ—¶é—´ */\n    if (tvp) {\n        if (copy_from_user(&#x26;tv, tvp, sizeof(tv)))\n            return -EFAULT;\n\n        /* è®¡æ—¶å™¨ä¸èƒ½è®¾ç½®ä¸ºè´Ÿæ•° */\n        if (tv.tv_sec &#x3C; 0 || tv.tv_usec &#x3C; 0)\n            return -EINVAL;\n\n        /* Cast to u64 to make GCC stop complaining */\n        /* å¯¹ timeout åšä¸€å®šçš„å¤„ç†ï¼Œæ ¹æ®æ—¶é’Ÿå‘¨æœŸå¯¹ usec è¿›è¡Œå–æ•´ */\n        if ((u64)tv.tv_sec >= (u64)MAX_INT64_SECONDS)\n            timeout = -1;   /* æ— é™ç­‰å¾… */\n        else {\n            timeout = DIV_ROUND_UP(tv.tv_usec, USEC_PER_SEC/HZ);\n            timeout += tv.tv_sec * HZ;\n        }\n    }\n\n    /* æ ¸å¿ƒçš„ select å®ç°é€»è¾‘ */\n    ret = core_sys_select(n, inp, outp, exp, &#x26;timeout);\n\n    /* å¦‚æœè®¾ç½®äº†è¶…æ—¶æ—¶é—´ */\n    if (tvp) {\n        struct timeval rtv;\n\n        if (current->personality &#x26; STICKY_TIMEOUTS)\n            goto sticky;\n        rtv.tv_usec = jiffies_to_usecs(do_div((*(u64*)&#x26;timeout), HZ));\n        rtv.tv_sec = timeout;\n        if (timeval_compare(&#x26;rtv, &#x26;tv) >= 0)\n            rtv = tv;\n        /* å†…æ ¸æ•°æ®->ç”¨æˆ·æ•°æ®çš„æ‹·è´ï¼Œæ›´æ–°è·ç¦»è¶…æ—¶å‰©ä½™çš„æ—¶é—´é—´éš” */\n        if (copy_to_user(tvp, &#x26;rtv, sizeof(rtv))) {\nsticky:\n            /*\n             * å¦‚æœåº”ç”¨ç¨‹åºæŠŠtimevalæ”¾åœ¨åªè¯»å†…å­˜ä¸­ï¼Œå†…æ ¸å°±æ— éœ€ç‰¹åˆ«çš„æ›´æ–°å®ƒ\n             * If an application puts its timeval in read-only\n             * memory, we don\'t want the Linux-specific update to\n             * the timeval to cause a fault after the select has\n             * completed successfully. However, because we\'re not\n             * updating the timeval, we can\'t restart the system\n             * call.\n             */\n            if (ret == -ERESTARTNOHAND)\n                ret = -EINTR;\n        }\n    }\n\n    return ret;\n}\n</code></pre>\n<p><code>core_sys_select</code> ä¹Ÿæ²¡æœ‰å¤ªå¤šæ ¸å¿ƒæ“ä½œï¼Œå®Œå…¨æ˜¯åœ¨ä¸ºä¸‰ä¸ªä½å›¾â€”â€”è¾“å…¥ã€è¾“å‡ºã€é”™è¯¯ä»ç”¨æˆ·æ•°æ®æ®µåˆ°å†…æ ¸æ•°æ®æ®µçš„æ‹·è´å·¥ä½œï¼Œä»¥åŠåœ¨ç»“æŸ <code>do_select</code> è°ƒç”¨åçš„åå‘æ‹·è´æ“ä½œã€‚ä¸è¿‡ï¼Œæ— è®ºæ˜¯ <code>sys_select</code> è¿˜æ˜¯ <code>core_sys_select</code> éƒ½å°†å„è‡ªéœ€è¦å®Œæˆçš„å·¥ä½œåˆ†å‰²å¾—éå¸¸æ¸…æ™°ï¼Œä¸€ä¸ªå®Œæˆtimevalçš„å¤„ç†å·¥ä½œï¼Œå¦ä¸€ä¸ªå®Œæˆä½å›¾çš„å¤„ç†ã€‚</p>\n<pre><code class="language-c">/*\n * å†…æ ¸æ•°æ®-ä½å›¾çš„å‡†å¤‡ï¼Œè°ƒç”¨do_selectå®Œæˆæ ¸å¿ƒçš„é€»è¾‘\n */\nstatic int core_sys_select(int n, fd_set __user *inp, fd_set __user *outp,\n               fd_set __user *exp, s64 *timeout)\n{\n    fd_set_bits fds;\n    void *bits;\n    int ret, max_fds;\n    unsigned int size;\n    struct fdtable *fdt;\n    /*\n     * åœ¨æ ˆä¸­å®šä¹‰è¾ƒå°çš„æ•°ç»„ï¼Œå‡å°‘å †å†…å­˜çš„å ç”¨ï¼ŒåŒæ—¶å¯ä»¥æ›´å¿«ï¼›\n     * SELECT_STACK_ALLOC = 256\n     */\n    long stack_fds[SELECT_STACK_ALLOC/sizeof(long)];\n\n    ret = -EINVAL;\n    if (n &#x3C; 0)\n        goto out_nofds;\n\n    /* max_fds can increase, so grab it once to avoid race */\n    /* max_fds å¯èƒ½åŒæ—¶åœ¨å¢åŠ ï¼Œæ‰€ä»¥æå‰è·å–ä¸€ä»½å›ºå®šçš„æ‹·è´é¿å…ç«äº‰ */\n    rcu_read_lock();\n    /* è·å–å½“å‰ä»»åŠ¡çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ */\n    fdt = files_fdtable(current->files);\n    max_fds = fdt->max_fds;\n    rcu_read_unlock();\n    if (n > max_fds)\n        n = max_fds;\n\n    /*\n     * We need 6 bitmaps (in/out/ex for both incoming and outgoing),\n     * since we used fdset we need to allocate memory in units of\n     * long-words.\n     */\n    size = FDS_BYTES(n);\n    bits = stack_fds;\n    if (size > sizeof(stack_fds) / 6) {\n        /* Not enough space in on-stack array; must use kmalloc */\n        /* æ ˆæ•°ç»„å¤§å°ä¸è¶³ï¼›ä½¿ç”¨ kmalloc è·å–æ–°çš„ç©ºé—´ */\n        ret = -ENOMEM;\n        bits = kmalloc(6 * size, GFP_KERNEL);\n        if (!bits)\n            goto out_nofds;\n    }\n    fds.in      = bits;\n    fds.out     = bits +   size;\n    fds.ex      = bits + 2*size;\n    fds.res_in  = bits + 3*size;\n    fds.res_out = bits + 4*size;\n    fds.res_ex  = bits + 5*size;\n\n    /* ç”¨æˆ·æ•°æ®æ®µçš„æ•°æ® inpã€outpã€exp å¾€å†…æ ¸æ•°æ®æ®µ fds.xxx æ‹·è´ */\n    if ((ret = get_fd_set(n, inp, fds.in)) ||\n        (ret = get_fd_set(n, outp, fds.out)) ||\n        (ret = get_fd_set(n, exp, fds.ex)))\n        goto out;\n    /* fds.res_xxx ä½œä¸º do_select çš„æ‰§è¡Œç»“æœï¼Œé¢„ç½®ä¸º0ï¼Œè¡¨ç¤ºæ¯ä¸€ä½ç›¸åº”çš„fdéƒ½æœªå‡†å¤‡å°±ç»ª */\n    zero_fd_set(n, fds.res_in);\n    zero_fd_set(n, fds.res_out);\n    zero_fd_set(n, fds.res_ex);\n\n    /* äº¤ç”± do_select å®ŒæˆçœŸæ­£æ ¸å¿ƒçš„æ“ä½œ */\n    ret = do_select(n, &#x26;fds, timeout);\n\n    if (ret &#x3C; 0)\n        goto out;\n    if (!ret) {\n        ret = -ERESTARTNOHAND;\n        if (signal_pending(current))\n            goto out;\n        ret = 0;\n    }\n\n    /* å°†ç»“æœé›†æ‹·è´å›ç”¨æˆ·æ•°æ®æ®µçš„ inpã€outpã€exp ä¸­ */\n    if (set_fd_set(n, inp, fds.res_in) ||\n        set_fd_set(n, outp, fds.res_out) ||\n        set_fd_set(n, exp, fds.res_ex))\n        ret = -EFAULT;\n\nout:\n    if (bits != stack_fds)\n        kfree(bits);\nout_nofds:\n    return ret;\n}\n</code></pre>\n<p>ç»ˆäºæ˜¯æ ¸å¿ƒçš„é€»è¾‘äº†ï¼Œé€ä¸€åœ°å°†å½“å‰ä»»åŠ¡æŒ‚åˆ°ç›¸åº”æ–‡ä»¶çš„ç­‰å¾…é˜Ÿåˆ—ä¸Šï¼Œå¹¶ç­‰å¾…è°ƒç”¨ <code>poll</code> å‡½æ•°è¢«å”¤é†’</p>\n<pre><code class="language-c">int do_select(int n, fd_set_bits *fds, s64 *timeout)\n{\n    struct poll_wqueues table;\n    poll_table *wait;\n    int retval, i;\n\n    rcu_read_lock();\n    /* ç¡®è®¤fds.xxxæ‰€éœ€è½®è¯¢çš„fdå…¨éƒ¨å…¨éƒ¨å¤„äºæ‰“å¼€çŠ¶æ€ï¼ŒåŒæ—¶è¿”å›æœ€å¤§çš„fd */\n    retval = max_select_fd(n, fds);\n    rcu_read_unlock();\n\n    if (retval &#x3C; 0)\n        return retval;\n    n = retval;\n\n    /* æŠŠå½“å‰ä»»åŠ¡æ”¾å…¥è‡ªå·±çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ */\n    poll_initwait(&#x26;table);\n    wait = &#x26;table.pt;\n    /* å¦‚æœè¶…æ—¶æ—¶é—´ä¸º0ï¼Œå³æ— éœ€ç­‰å¾… */\n    if (!*timeout)\n        wait = NULL;\n    retval = 0;\n    /* æ— é™å¾ªç¯ */\n    for (;;) {\n        unsigned long *rinp, *routp, *rexp, *inp, *outp, *exp;\n        long __timeout;\n\n        set_current_state(TASK_INTERRUPTIBLE);\n\n        inp = fds->in; outp = fds->out; exp = fds->ex;\n        rinp = fds->res_in; routp = fds->res_out; rexp = fds->res_ex;\n\n        for (i = 0; i &#x3C; n; ++rinp, ++routp, ++rexp) {\n            unsigned long in, out, ex, all_bits, bit = 1, mask, j;\n            unsigned long res_in = 0, res_out = 0, res_ex = 0;\n            const struct file_operations *f_op = NULL;\n            struct file *file = NULL;\n\n            in = *inp++; out = *outp++; ex = *exp++;\n            all_bits = in | out | ex;\n            if (all_bits == 0) {\n                i += __NFDBITS;\n                continue;\n            }\n\n            /* å¯¹ unsigned long çš„æ¯ä¸€ä½è¿›è¡Œç¡®è®¤ */\n            for (j = 0; j &#x3C; __NFDBITS; ++j, ++i, bit &#x3C;&#x3C;= 1) {\n                int fput_needed;\n                /* è¶…è¿‡éœ€æ£€æµ‹çš„æœ€å¤§çš„æ–‡ä»¶æè¿°ç¬¦ */\n                if (i >= n)\n                    break;\n                /* è¯¥ fd æ— éœ€æ£€æµ‹ï¼Œç›´æ¥ä¸‹ä¸€ä¸ª */\n                if (!(bit &#x26; all_bits))\n                    continue;\n                /* è·å–ç›¸åº”çš„æ–‡ä»¶å®ä¾‹ */\n                file = fget_light(i, &#x26;fput_needed);\n                if (file) {\n                    f_op = file->f_op;\n                    mask = DEFAULT_POLLMASK;\n                    /* å¯¹äºå¥—æ¥å­—ï¼Œè°ƒç”¨çš„æ˜¯sock_pollï¼Œåœ¨pollæˆåŠŸæ—¶å°†å”¤é†’waité˜Ÿåˆ—çš„ä»»åŠ¡ï¼ˆå³æŠŠå½“å‰ä»»åŠ¡å”¤é†’ï¼‰*/\n                    if (f_op &#x26;&#x26; f_op->poll)\n                        mask = (*f_op->poll)(file, retval ? NULL : wait);\n                    fput_light(file, fput_needed);\n                    if ((mask &#x26; POLLIN_SET) &#x26;&#x26; (in &#x26; bit)) {\n                        res_in |= bit;\n                        retval++;\n                    }\n                    if ((mask &#x26; POLLOUT_SET) &#x26;&#x26; (out &#x26; bit)) {\n                        res_out |= bit;\n                        retval++;\n                    }\n                    if ((mask &#x26; POLLEX_SET) &#x26;&#x26; (ex &#x26; bit)) {\n                        res_ex |= bit;\n                        retval++;\n                    }\n                }\n                /* ä¸»åŠ¨è®©å‡ºCPUç‰‡ï¼Œç­‰å¾…é‡æ–°è°ƒåº¦ï¼ˆæå‰è®¾ç½®äº†æœ€é«˜ä¼˜å…ˆçº§PREEMPT_ACTIVEï¼‰*/\n                cond_resched();\n            }\n            if (res_in)\n                *rinp = res_in;\n            if (res_out)\n                *routp = res_out;\n            if (res_ex)\n                *rexp = res_ex;\n        }\n        wait = NULL;\n        if (retval || !*timeout || signal_pending(current))\n            break;\n        if(table.error) {\n            retval = table.error;\n            break;\n        }\n\n        if (*timeout &#x3C; 0) {\n            /* Wait indefinitely */\n            __timeout = MAX_SCHEDULE_TIMEOUT;\n        } else if (unlikely(*timeout >= (s64)MAX_SCHEDULE_TIMEOUT - 1)) {\n            /* Wait for longer than MAX_SCHEDULE_TIMEOUT. Do it in a loop */\n            __timeout = MAX_SCHEDULE_TIMEOUT - 1;\n            *timeout -= __timeout;\n        } else {\n            __timeout = *timeout;\n            *timeout = 0;\n        }\n        /* è¿›å…¥å»¶æ—¶å”¤é†’çŠ¶æ€ï¼Œå¾…å®šé¢„å®šçš„è¶…æ—¶æ—¶é—´ */\n        __timeout = schedule_timeout(__timeout);\n        if (*timeout >= 0)\n            *timeout += __timeout;\n    }\n    __set_current_state(TASK_RUNNING);\n\n    poll_freewait(&#x26;table);\n\n    return retval;\n}\n</code></pre>\n<p>æ€»ç»“æ¥çœ‹ï¼Œ<code>select</code> å®Œå…¨èƒ½å¤Ÿæ”¯æŒIOå¤šè·¯å¤ç”¨ã€‚è‡³å°‘æ¯”ç”¨æˆ·ç¨‹åºè‡ªè¡Œå®ç°è½®è¯¢ä¼˜ç§€å¾—å¤šã€‚ä½†æ˜¯ï¼Œä¹Ÿå­˜åœ¨ç€ä¸€äº›æ˜æ˜¾çš„ç¼ºé™·ï¼š</p>\n<ol>\n<li>æ”¯æŒçš„æ–‡ä»¶æè¿°ç¬¦å­˜åœ¨ä¸Šé™ï¼Œé»˜è®¤æ˜¯1024ã€‚</li>\n<li>æ¯æ¬¡é™·å…¥å†…æ ¸æ€ <code>select</code> å‡½æ•°ä¹‹åï¼Œéƒ½éœ€è¦æŒ‰ä½éå†æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ— è®ºè¯¥fdæ˜¯å¦å­˜åœ¨ï¼‰ï¼Œmax(fd)è¶Šå¤§ï¼Œå¼€é”€è¶Šå¤§ã€‚</li>\n<li>æ¯æ¬¡è°ƒç”¨ <code>select</code> éƒ½éœ€è¦å°†fdé›†åˆä»ç”¨æˆ·æ€å¤åˆ¶åˆ°å†…æ ¸æ€ï¼Œmax(fd)è¶Šå¤§ï¼Œå¼€é”€è¶Šå¤§ã€‚</li>\n</ol>\n<h2>EPOLL</h2>\n<p>ç®€å•åœ°æè¿°è¿‡ <code>select</code> ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œæˆ‘ä»¬ç€é‡æ¥èŠä¸€èŠ <code>epoll</code> çš„å®ç°ã€‚æ¯•ç«Ÿ <code>select</code> å’Œ <code>poll</code> çš„å¤æ‚åº¦æ˜¯ $O(N)$ï¼Œè€Œ <code>epoll</code> åªæ˜¯ $O(\\log{N})$ ï¼ˆå½“ç„¶ï¼Œè¿™é‡Œå¯¹æ—¶é—´å¤æ‚åº¦çš„æ¯”è¾ƒç»´åº¦ä¸åŒï¼Œç¨å€™ç»†è®²ï¼‰ã€‚<code>epoll</code> åŒºåˆ«äºä¼ ç»ŸI/Oå¤ç”¨æ¨¡å‹çš„æœ€å¤§ç‰¹è‰²åœ¨äºï¼šå®ƒå°†åˆ›å»ºå¹¶ç»´æŠ¤ä¸€ä¸ª <code>eventpoll</code> å®ä¾‹ï¼Œå¹¶é€šè¿‡æ³¨å†Œè¯· <code>epoll</code> å¯¹æ–°çš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œç›‘å¬ï¼Œè¿™æ„å‘³ç€æ•°æ®ä»ç”¨æˆ·æ•°æ®åŒºåˆ°å†…æ ¸æ•°æ®åŒºçš„æ‹·è´åªæœ‰ä¸€æ¬¡ï¼›ç›¸å¯¹çš„ï¼Œä¼ ç»Ÿæ–¹å¼åœ¨æ¯æ¬¡è½®è¯¢æ—¶ï¼Œéƒ½éœ€è¦å…¨é‡åœ°å°†æ•°æ®ä»ç”¨æˆ·æ•°æ®åŒºæ‹·è´åˆ°å†…æ ¸æ•°æ®åŒºã€‚ </p>\n<h3><code>epoll_create</code></h3>\n<p><code>epoll_create</code> è´Ÿè´£åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>eventpoll</code> å®ä¾‹ã€‚è¿™é‡Œçš„sizeå¹¶æ²¡æœ‰å®é™…æ„ä¹‰ï¼ˆç”±äºå†å²åŸå› è€Œå­˜åœ¨ï¼‰ï¼Œä¼ å…¥çš„å‚æ•°å°†è¢«å¿½ç•¥ã€‚çœ‹æºç æ€»æ˜¯ä»¶æœ‰æ„æ€çš„äº‹ï¼Œè¿™ä¸ªsizeè¢«æè¿°æˆäº†æ£€æŸ¥ç²¾ç¥å¥å…¨çš„æ ‡å¿—...</p>\n<pre><code class="language-c">asmlinkage long sys_epoll_create(int size)\n{\n    int error, fd = -1;\n    struct eventpoll *ep;\n    struct inode *inode;\n    struct file *file;\n\n    DNPRINTK(3, (KERN_INFO "[%p] eventpoll: sys_epoll_create(%d)\\n",\n             current, size));\n\n    /*\n     * ç²¾ç¥å¥å…¨æ£€æµ‹(size)ï¼›åŒæ—¶å»ºç«‹å†…éƒ¨æ•°æ®ç»“æ„ struct eventpoll\n     */\n    error = -EINVAL;\n    if (size &#x3C;= 0 || (error = ep_alloc(&#x26;ep)) != 0)\n        goto error_return;\n\n    /*\n     * åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ–‡ä»¶æ•°æ®ç»“æ„å’ŒièŠ‚ç‚¹\n     */\n    error = anon_inode_getfd(&#x26;fd, &#x26;inode, &#x26;file, "[eventpoll]",\n                 &#x26;eventpoll_fops, ep);\n    if (error)\n        goto error_free;\n\n    DNPRINTK(3, (KERN_INFO "[%p] eventpoll: sys_epoll_create(%d) = %d\\n",\n             current, size, fd));\n\n    return fd;\n\nerror_free:\n    ep_free(ep);\nerror_return:\n    DNPRINTK(3, (KERN_INFO "[%p] eventpoll: sys_epoll_create(%d) = %d\\n",\n             current, size, error));\n    return error;\n}\n</code></pre>\n<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1g0qi7lrtgzj31eu0u075i.jpg" alt="Epoll Create | Model"></p>\n<h3><code>epoll_ctl</code></h3>\n<p><code>epoll_ctl</code> é¡¾åæ€ä¹‰â€”â€”<code>epoll</code>æ§åˆ¶å™¨ï¼Œç”¨äºå¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤ç›‘å¬çš„äº‹ä»¶ã€‚è¿™é‡Œ <code>epfd</code> ç”¨äºæ‰¾åˆ° <code>eventpoll</code> å®ä¾‹ï¼Œ<code>fd</code> è¡¨ç¤ºéœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œ<code>op</code> åŒºåˆ†å¢åˆ æ”¹ï¼Œ<code>event</code> è¡¨ç¤ºç›‘å¬çš„å…·ä½“äº‹ä»¶æè¿°ã€‚</p>\n<pre><code class="language-c">asmlinkage long sys_epoll_ctl(int epfd, int op, int fd,\n                  struct epoll_event __user *event)\n{\n    int error;\n    struct file *file, *tfile;\n    struct eventpoll *ep;\n    struct epitem *epi;\n    struct epoll_event epds;\n\n    DNPRINTK(3, (KERN_INFO "[%p] eventpoll: sys_epoll_ctl(%d, %d, %d, %p)\\n",\n             current, epfd, op, fd, event));\n\n    error = -EFAULT;\n    /* å¦‚æœæ˜¯å¢æ”¹æ“ä½œï¼Œéœ€è¦æŠŠäº‹ä»¶æè¿°æ‹·è´åˆ°å†…æ ¸æ•°æ®åŒº; åˆ é™¤æ“ä½œä¸éœ€è¦ */\n    if (ep_op_has_event(op) &#x26;&#x26;\n        copy_from_user(&#x26;epds, event, sizeof(struct epoll_event)))\n        goto error_return;\n\n    /* Get the "struct file *" for the eventpoll file */\n    error = -EBADF;\n    file = fget(epfd);\n    if (!file)\n        goto error_return;\n\n    /* Get the "struct file *" for the target file */\n    tfile = fget(fd);\n    if (!tfile)\n        goto error_fput;\n\n    /* éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦å¿…é¡»æ”¯æŒæ–‡ä»¶æ“ä½œ poll */\n    error = -EPERM;\n    if (!tfile->f_op || !tfile->f_op->poll)\n        goto error_tgt_fput;\n\n    /* éœ€è¦ç¡®ä¿ä¸èƒ½æŠŠepfdä½œä¸ºè¢«ç›‘å¬çš„fdåŠ å…¥ */\n    error = -EINVAL;\n    if (file == tfile || !is_file_epoll(file))\n        goto error_tgt_fput;\n\n    /* \n     * è¿™é‡Œçš„æ–‡ä»¶æè¿°ç¬¦ä¸€å®šæ˜¯æŒ‡eventpollå®ä¾‹å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦\n     * å› æ­¤ç›´æ¥ä»ä¸­æ‹¿ç§æœ‰æ•°æ®--é¢„å®šä¹‰çš„*eventpoll\n     */\n    ep = file->private_data;\n\n    mutex_lock(&#x26;ep->mtx);\n\n    /*\n     * ä»RBæ ‘ä¸­æŸ¥æ‰¾å·²ç»ç»´æŠ¤èµ·æ¥çš„ç›‘å¬äº‹ä»¶\n     * å½“ç„¶ï¼Œå¿…é¡»å…ˆæŠŠè¿™ä¸ªRBæ ‘ç»“æ„é”å®šï¼Œé˜²æ­¢æŸ¥æ‰¾æ—¶ç»“æ„æ”¹å˜\n     */\n    epi = ep_find(ep, tfile, fd);\n\n    error = -EINVAL;\n    switch (op) {\n    case EPOLL_CTL_ADD:     // æ–°å¢ç›‘å¬\n        if (!epi) {\n            epds.events |= POLLERR | POLLHUP;\n\n            error = ep_insert(ep, &#x26;epds, tfile, fd);\n        } else\n            error = -EEXIST;\n        break;\n    case EPOLL_CTL_DEL:     // åˆ é™¤ç›‘å¬\n        if (epi)\n            error = ep_remove(ep, epi);\n        else\n            error = -ENOENT;\n        break;\n    case EPOLL_CTL_MOD:     // ä¿®æ”¹ç›‘å¬\n        if (epi) {\n            epds.events |= POLLERR | POLLHUP;\n            error = ep_modify(ep, epi, &#x26;epds);\n        } else\n            error = -ENOENT;\n        break;\n    }\n    mutex_unlock(&#x26;ep->mtx);\n\nerror_tgt_fput:\n    fput(tfile);\nerror_fput:\n    fput(file);\nerror_return:\n    DNPRINTK(3, (KERN_INFO "[%p] eventpoll: sys_epoll_ctl(%d, %d, %d, %p) = %d\\n",\n             current, epfd, op, fd, event, error));\n\n    return error;\n}\n</code></pre>\n<p>è¿™é‡Œçš„æ ¸å¿ƒæ“ä½œï¼Œå°±æ˜¯å¾€ <code>eventpoll</code> å®ä¾‹ä¸­å¢åˆ æ”¹ç›‘å¬çš„äº‹ä»¶ã€‚ä»¥ <code>ep_insert</code> ä¸ºä¾‹ï¼Œå…ˆçœ‹çœ‹æ€ä¹ˆæ–°å¢ç›‘å¬ã€‚</p>\n<pre><code class="language-c">/* å®ä¾‹åŒ– epitem */\nif (!(epi = kmem_cache_alloc(epi_cache, GFP_KERNEL)))\n    goto error_return;\n/* å¯¹ epitem å®ä¾‹è¿›è¡Œåˆå§‹åŒ–æ•°æ® */\nep_rb_initnode(&#x26;epi->rbn);\nINIT_LIST_HEAD(&#x26;epi->rdllink);\nINIT_LIST_HEAD(&#x26;epi->fllink);\nINIT_LIST_HEAD(&#x26;epi->pwqlist);\nepi->ep = ep;\n/* æ„å»ºstruct epoll_filefdï¼Œä½œä¸ºrb_treeæ¯”è¾ƒä¸åŒçš„key */\nep_set_ffd(&#x26;epi->ffd, tfile, fd);\nepi->event = *event;\nepi->nwait = 0;\nepi->next = EP_UNACTIVE_PTR;\n</code></pre>\n<p>æ¥ä¸‹æ¥è¦æ¥è§¦çš„å°±æ˜¯ä¸€æ®µæ¯”è¾ƒçƒ§è„‘çš„é€»è¾‘ã€‚</p>\n<p><code>poll_table</code> æ˜¯åœ¨ VFS å®ç°ä¸­ç›¸å½“é‡è¦çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œç”¨æ¥ä¸<code>poll</code>é…åˆï¼ˆè¿™é‡Œçš„<code>poll</code>æ˜¯æŒ‡æ–‡ä»¶æ“ä½œä¸­çš„ï¼Œè€Œä¸æ˜¯<code>poll()</code>ç³»ç»Ÿè°ƒç”¨ï¼‰</p>\n<pre><code class="language-c">typedef struct poll_table_struct {\n    poll_queue_proc _qproc;\n} poll_table;\n</code></pre>\n<p>å…¶ä¸­<code>poll_queue_proc</code>æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ</p>\n<pre><code class="language-c">typedef void (*poll_queue_proc)(struct file *, wait_queue_head_t *, struct poll_table_struct *);\n</code></pre>\n<p>ä¸ºäº†è®© <code>epitem</code> æ›´æ–¹ä¾¿åœ°è¿½è¸ª <code>poll_queue_proc</code>ï¼Œ<code>epoll_ctl</code> ä¸­ä½¿ç”¨äº†ä¸€ä¸ª <code>ep_pqueue</code> çš„æ•°æ®ç»“æ„æ¥åŒ…è£… <code>poll_table</code>ã€‚</p>\n<pre><code class="language-c">/* ä½¿ç”¨ queue å›è°ƒå‡½æ•°åˆå§‹åŒ– poll table */\nepq.epi = epi;\ninit_poll_funcptr(&#x26;epq.pt, ep_ptable_queue_proc);\n</code></pre>\n<p><img src="https://ws1.sinaimg.cn/large/006tKfTcly1g0qwphhnz0j30xa0o6aan.jpg"></p>\n<p>ä¹‹åå°±æ˜¯æŠŠè¿™ä¸ª <code>poll_table</code> ä½œä¸ºé’©å­æ–¹æ³•æŒ‚è½½åˆ°è¢«ç›‘æ§çš„æ–‡ä»¶ä¸Š</p>\n<pre><code class="language-c">revents = tfile->f_op->poll(tfile, &#x26;epq.pt);\n</code></pre>\n<p>è¿™é‡Œä»¥ <code>tcp_poll</code> ä¸ºä¾‹ï¼Œå…ˆçœ‹çœ‹è¿™æ®µé€»è¾‘æ€ä¹ˆå®ç°çš„ã€‚</p>\n<pre><code class="language-c">static unsigned int sock_poll(struct file *file, poll_table *wait)\n{\n    struct socket *sock;\n    /* è·å– struct sock å†…æ ¸å¥—æ¥å­—æ•°æ®ç»“æ„ */\n    sock = file->private_data;\n    return sock->ops->poll(file, sock, wait);\n}\n\nunsigned int tcp_poll(struct file *file, struct socket *sock, poll_table *wait)\n{\n    unsigned int mask;\n    struct sock *sk = sock->sk;\n    struct tcp_sock *tp = tcp_sk(sk);\n\n    /*\n     * è¿™é‡Œå°†è°ƒç”¨ poll_table *wait ç»´æŠ¤çš„å›è°ƒå‡½æ•°\n     * å°†æŒæœ‰ eventpoll å®ä¾‹çš„è¿›ç¨‹æ³¨å†Œåˆ° sk çš„ç­‰å¾…é˜Ÿåˆ—ä¸­\n     */\n    poll_wait(file, sk->sk_sleep, wait);\n    if (sk->sk_state == TCP_LISTEN)\n        return inet_csk_listen_poll(sk);\n\n    /*\n     * è¿™é‡Œçœç•¥äº†éƒ¨åˆ†é€»è¾‘ï¼Œä¸»è¦æ˜¯è´Ÿè´£å¤„ç† struct sock æ¥æ”¶åˆ°çš„äº‹ä»¶\n     * å¤„ç†æˆ mask å¹¶è¿”å›\n     */\n    ...\n\n    return mask;\n}\n\nstatic inline void poll_wait(struct file * filp, wait_queue_head_t * wait_address, poll_table *p)\n{\n    if (p &#x26;&#x26; wait_address)\n        p->qproc(filp, wait_address, p);\n}\n</code></pre>\n<p>å†æ¥çœ‹çœ‹epollå®šä¹‰çš„å›è°ƒå‡½æ•°çš„å®ç°ã€‚</p>\n<pre><code class="language-c">static void ep_ptable_queue_proc(struct file *file, wait_queue_head_t *whead,\n                 poll_table *pt)\n{\n    struct epitem *epi = ep_item_from_epqueue(pt);\n    struct eppoll_entry *pwq;\n\n    if (epi->nwait >= 0 &#x26;&#x26; (pwq = kmem_cache_alloc(pwq_cache, GFP_KERNEL))) {\n        init_waitqueue_func_entry(&#x26;pwq->wait, ep_poll_callback);\n        pwq->whead = whead;\n        pwq->base = epi;\n        /* æ·»åŠ åˆ° struct sock ç­‰å¾…é˜Ÿåˆ—é˜Ÿé¦– */\n        add_wait_queue(whead, &#x26;pwq->wait);\n        list_add_tail(&#x26;pwq->llink, &#x26;epi->pwqlist);\n        epi->nwait++;\n    } else {\n        /* We have to signal that an error occurred */\n        epi->nwait = -1;\n    }\n}\n</code></pre>\n<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œ<code>ep_insert</code> æ ¸å¿ƒçš„é€»è¾‘å·²ç»ä»‹ç»å®Œæ¯•ã€‚ä¸»è¦å°±æ˜¯å°†å½“å‰çš„ <code>eventpoll</code> å®ä¾‹æ³¨å†Œåˆ°ç›‘å¬ç›®æ ‡ï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰çš„ç­‰å¾…é˜Ÿåˆ—ä¸Šï¼Œå¹¶æ³¨å†Œ<code>ep_poll_callback</code>ä½œä¸ºå›è°ƒå‡½æ•°ã€‚å›è°ƒå‡½æ•°å®ç°æ˜¯æ€æ ·å‘¢ï¼Ÿ</p>\n<pre><code class="language-c">static int ep_poll_callback(wait_queue_t *wait, unsigned mode, int sync, void *key)\n{\n    int pwake = 0;\n    unsigned long flags;\n    /* è·å– wait ç»“æ„ç»´æŠ¤çš„ epitem å®ä¾‹ */\n    struct epitem *epi = ep_item_from_wait(wait);\n    struct eventpoll *ep = epi->ep;\n\n    // ... code omitted...\n    /* \n     * æŠŠå½“å‰çš„ epitem å®ä¾‹æ·»åŠ åˆ° eventpoll å®ä¾‹çš„å°±ç»ªé˜Ÿåˆ—ä¸­ \n     * è¿™æ˜¯æ˜¾ç„¶çš„ï¼Œæ¯•ç«Ÿæ­¤å›è°ƒå‡½æ•°åªæœ‰åœ¨fdå‡†å¤‡å°±ç»ªåè¢«å›è°ƒ\n     */\n    list_add_tail(&#x26;epi->rdllink, &#x26;ep->rdllist);\n\nis_linked:\n    /* å¦‚æœ wait ç»“æ„ç»´æŠ¤çš„è¿›ç¨‹å¤„äºSleepingçŠ¶æ€ï¼Œåˆ™å°†å…¶å”¤é†’å¹¶åŠ å…¥ä»»åŠ¡å°±ç»ªé˜Ÿåˆ— */\n    if (waitqueue_active(&#x26;ep->wq))\n        __wake_up_locked(&#x26;ep->wq, TASK_UNINTERRUPTIBLE |\n                 TASK_INTERRUPTIBLE);\n    if (waitqueue_active(&#x26;ep->poll_wait))\n        pwake++;\n\nout_unlock:\n    spin_unlock_irqrestore(&#x26;ep->lock, flags);\n\n    /* We have to call this outside the lock */\n    if (pwake)\n        ep_poll_safewake(&#x26;psw, &#x26;ep->poll_wait);\n\n    return 1;\n}\n</code></pre>\n<h3><code>epoll_wait</code></h3>\n<p>å¤„ç†å®Œæ‰€æœ‰çš„ç›‘å¬äº‹ä»¶çš„ç»´æŠ¤ï¼Œç”¨æˆ·ç¨‹åºéœ€è¦é€šè¿‡ <code>epoll_wait</code> ä¸ <code>eventpoll</code> å®ä¾‹è¿›è¡Œäº¤äº’ï¼Œå¹¶è¢«å‘ŠçŸ¥æ‰€æœ‰æ­£åœ¨ç›‘å¬ä¸­çš„äº‹ä»¶æ˜¯å¦å‘ç”Ÿã€‚ç”±äº <code>epoll_wait</code> çš„æ•´ä¸ªé€»è¾‘åŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨è¿›è¡Œé”™è¯¯æ£€æµ‹ï¼Œæ­¤å¤„ä¸è¡¨ã€‚æˆ‘ä»¬åªå…³æ³¨å…¶ä¸­çš„æ ¸å¿ƒé€»è¾‘ï¼Œå³è°ƒç”¨çš„ <code>ep_poll</code> å‡½æ•°ã€‚</p>\n<pre><code class="language-c">static int ep_poll(struct eventpoll *ep, struct epoll_event __user *events,\n           int maxevents, long timeout)\n{\n    int res, eavail;\n    unsigned long flags;\n    long jtimeout;\n    wait_queue_t wait;\n\n    /*\n     * Calculate the timeout by checking for the "infinite" value ( -1 )\n     * and the overflow condition. The passed timeout is in milliseconds,\n     * that why (t * HZ) / 1000.\n     */\n    jtimeout = (timeout &#x3C; 0 || timeout >= EP_MAX_MSTIMEO) ?\n        MAX_SCHEDULE_TIMEOUT : (timeout * HZ + 999) / 1000;\n\nretry:\n    spin_lock_irqsave(&#x26;ep->lock, flags);\n\n    res = 0;\n    /* \n     * å¦‚æœ eventpoll å®ä¾‹çš„å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºï¼Œè¡¨æ˜æœ‰æ²¡ä»»ä½•ç›‘å¬çš„äº‹ä»¶å‘ç”Ÿã€‚\n     * ä¸»åŠ¨è®©è¿›ç¨‹é™·å…¥SleepingçŠ¶æ€ï¼ŒçŸ¥é“è¢« ep_poll_callback() å”¤é†’\n     */\n    if (list_empty(&#x26;ep->rdllist)) {\n        init_waitqueue_entry(&#x26;wait, current);\n        wait.flags |= WQ_FLAG_EXCLUSIVE;\n        __add_wait_queue(&#x26;ep->wq, &#x26;wait);\n\n        for (;;) {\n            /*\n             * We don\'t want to sleep if the ep_poll_callback() sends us\n             * a wakeup in between. That\'s why we set the task state\n             * to TASK_INTERRUPTIBLE before doing the checks.\n             */\n            set_current_state(TASK_INTERRUPTIBLE);\n            if (!list_empty(&#x26;ep->rdllist) || !jtimeout)\n                break;\n            if (signal_pending(current)) {\n                res = -EINTR;\n                break;\n            }\n\n            spin_unlock_irqrestore(&#x26;ep->lock, flags);\n            /* ä¸»åŠ¨é™·å…¥SleepingçŠ¶æ€ */\n            jtimeout = schedule_timeout(jtimeout);\n            spin_lock_irqsave(&#x26;ep->lock, flags);\n        }\n        __remove_wait_queue(&#x26;ep->wq, &#x26;wait);\n\n        set_current_state(TASK_RUNNING);\n    }\n\n    /* Is it worth to try to dig for events ? */\n    eavail = !list_empty(&#x26;ep->rdllist);\n\n    spin_unlock_irqrestore(&#x26;ep->lock, flags);\n\n    /*\n     * å°†ç›‘å¬åˆ°çš„äº‹ä»¶æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚å¦‚æœæ²¡æœ‰äº‹ä»¶å°±ç»ªä¸”è¿˜æ²¡è¶…æ—¶ï¼Œå°±å†æŠ±ç€\n     * å¸Œæœ›è¯•ä¸€æ¬¡ã€‚\n     */\n    if (!res &#x26;&#x26; eavail &#x26;&#x26;\n        !(res = ep_send_events(ep, events, maxevents)) &#x26;&#x26; jtimeout)\n        goto retry;\n\n    return res;\n}\n</code></pre>\n<h3>Extra</h3>\n<p>è¿™éƒ¨åˆ†çš„æ•°æ®ç»“æ„é…åˆç€ä¸€äº›èƒ¶æ°´ä»£ç æ¯”è¾ƒéš¾ä»¥ç†è§£ï¼Œæœ€å¥½é…åˆç€ç±»å›¾çœ‹çœ‹ï¼ˆä¸ªäººä½¿ç”¨ï¼Œä¸ä¸€å®šé€‚åˆå„ä½ï¼‰</p>\n<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1g0rmx65dzhj324y0t8di4.jpg"></p>\n<h2>å‚è€ƒ</h2>\n<ol>\n<li>Linux Kernel 2.6.24</li>\n<li><a href="https://idndx.com/2014/09/01/the-implementation-of-epoll-1/">The Implementation of epoll(1)</a></li>\n<li><a href="https://idndx.com/2014/09/02/the-implementation-of-epoll-2/">The Implementation of epoll(2)</a></li>\n<li><a href="https://idndx.com/2014/09/22/the-implementation-of-epoll-3/">The Implementation of epoll(3)</a></li>\n<li><a href="https://idndx.com/2015/07/08/the-implementation-of-epoll-4/">The Implementation of epoll(4)</a></li>\n</ol>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},fuPZ:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<h2>å‰è¨€</h2>\n<p>åœ¨<a href="https://dormouse-none.github.io/2018-08-19-understand-Kernel-0/">æ¦‚è¿°</a>ï¼Œæˆ‘æƒ³æˆ‘å·²ç»ä»‹ç»è¿‡æˆ‘å¼€å§‹è¿™ä¸€äº›åˆ—åšæ–‡çš„åŸå› ã€‚\næˆ‘ä¸èƒ½æ‹…ä¿æˆ‘æ‰€è¿›è¡Œçš„æ‰€æœ‰è¯•éªŒæ€§æ“ä½œéƒ½æ˜¯å¯¹çš„ï¼Œä½†æ˜¯ï¼Œè‡³å°‘è¿™äº›åœ¨æˆ‘æ‰€æè¿°çš„ç¯å¢ƒä¸‹æˆåŠŸçš„è¿è¡Œäº†èµ·æ¥ï¼Œå¹¶å¸®åŠ©æˆ‘è§¦åŠæˆ‘å§‹ç»ˆæ•¬ç•è€Œåˆæ•¬è€Œè¿œä¹‹çš„<strong>ç¡¬ä»¶&#x26;OS</strong></p>\n<p>åœ¨ã€ŠLinuxå†…æ ¸å®Œå…¨æ³¨é‡Šã€‹ä¸€ä¹¦ç¬¬ä¸‰ç« â€”â€”å†…æ ¸ç¼–ç¨‹è¯­è¨€å’Œç¯å¢ƒï¼Œæè¿°äº†ç”¨ as86 æ±‡ç¼–è¯­è¨€æ„å»º boot å¼•å¯¼ç¨‹åºï¼Œå¹¶æœ€ç»ˆé€šè¿‡ Bochs ä»¿çœŸå™¨åœ¨æ¨¡æ‹Ÿå¼€æœºé€šç”µåï¼ŒBIOS Load\nboot ç¨‹åºï¼Œé€šè¿‡æ˜¾ç¤ºå™¨è¾“å‡º <em>Loading System...</em> ã€‚</p>\n<p>è¿™äº›ï¼Œå°†æ˜¯è¿™é‡Œæ‰€è¦æè¿°çš„ä¸»è¦å†…å®¹ã€‚</p>\n<h2>boot.s æ±‡ç¼–ç¨‹åº</h2>\n<p>è¿™é‡Œæ²¡æ³•å¤šè¯´ï¼Œéƒ½æ˜¯ä¹¦ä¸­çš„æºç ï¼Œåªæ˜¯ä¾›æœªè¯»è¿‡ä¹¦çš„è¯»è€…å‚è€ƒï¼Œç‰¹æ„æ‘˜å½•äº†ä¸‹æ¥(ä¸è¿‡ï¼Œå°±ä¸åŠ æ³¨é‡Šäº†)</p>\n<p>boot.s æºä»£ç </p>\n<pre><code class="language-asm">.global begtext, begdata, begbss, endtext, enddata, endbss\n.text\nbegtext:\n.data\nbegdata:\n.bss\nbegbss:\n.text\nBOOTSEG=0x07c0\n\nentry start\nstart:\n    jmpi    go,BOOTSEG\ngo: mov ax,cs\n    mov ds,ax\n    mov es,ax\n    mov [msg+17],ah\n    mov cx,#20\n    mov dx,#0x1004\n    mov bx,#0x000c\n    mov bp,#msg\n    mov ax,#0x1301\n    int 0x10\nloop1:  jmp loop1\nmsg:    .ascii  "Loading System..."\n        .byte   13,10\n.org    510\n.word   0xAA55\n.text\nendtext:\n.data\nenddata:\n.bss\nendbss:\n</code></pre>\n<p>è¿™æ®µç¨‹åºçš„ä¸»è¦çš„æ‰§è¡Œæµç¨‹å°†æ˜¯:</p>\n<ol>\n<li>é€šè¿‡ BIOS åŠ è½½è¿™æ®µ boot å¼•å¯¼ç¨‹åº</li>\n<li>çº¢è‰²å­—ä½“æ‰“å° <em>Loading System...</em> å¹¶å“é“ƒ</li>\n<li>æŒ‡ä»¤è‡ªå¾ªç¯ (<code>loop1 jmp loop1</code>) ï¼Œå°†å§‹ç»ˆå±•ç¤ºä¸Šè¿°å­—æ ·ï¼Œå¹¶ä¸æ¥æ”¶å‘½ä»¤</li>\n</ol>\n<p>ä¸‹é¢å°±è¯¥æŠŠè¿™ä¸ªæ±‡ç¼–ç¨‹åº <em>ç¼–è¯‘ + é“¾æ¥</em> æˆ boot å¼•å¯¼ç¨‹åºã€‚</p>\n<p>è™½ç„¶åœ¨ macOS ä¸Šç¡®å®æ‰¾åˆ°äº†ä¸€ä¸ª as86 æ±‡ç¼–å™¨(æ¥è‡ª nasm çš„ä¸€ä¸ªç¼–è¯‘é€‰é¡¹ï¼Œä½†æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆå§‹ç»ˆæ— æ³•æ­£å¸¸ç¼–è¯‘ï¼Œä¹Ÿå¯èƒ½è¿™ä¸ªæ ¹æœ¬å°±ä¸æ˜¯æˆ‘æƒ³è¦çš„)ã€‚</p>\n<p>é€šè¿‡ docker å®¹å™¨éƒ¨ç½²çš„ Ubuntuï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°å¾—åˆ°ä¸€ä¸ª as86 æ±‡ç¼–ç¨‹åºã€‚</p>\n<pre><code class="language-sh">apt-get install bin86   # as86, ld86 éƒ½åœ¨è¿™ä¸ªåŒ…é‡Œæä¾›äº†\n\n# è¿™å¥éœ€è¦åœ¨å®¿ä¸»æœºä¸Šæ‰§è¡Œ\ndocker cp boot.s linux:/root/boot.s     # è¿™é‡Œ linux æ˜¯æˆ‘ docker éƒ¨ç½²çš„ Ubuntu çš„å®¹å™¨çš„åç§°ã€‚   å¦‚æœä¹‹å‰ boot.s åœ¨å®¿ä¸»æœºä¸Šï¼Œå¯ä»¥è¿™æ ·æ‹·è´åˆ°å®¹å™¨ä¸­\n\nas86 -0 -a -o boot.o boot.s             # ç¼–è¯‘\n\nld86 -0 -s -o execfile boot.o           # é“¾æ¥\n\n# å½“ç„¶ï¼Œåˆ°è¿™é‡Œä¸ºæ­¢ï¼Œå…¶å®éƒ½å¯ä»¥ç†è§£æˆåœ¨å°†æ±‡ç¼–ä»£ç ç¼–è¯‘é“¾æ¥æˆå¯æ‰§è¡Œç¨‹åº (å’Œ boot å¼•å¯¼ç¨‹åºæ²¡æœ‰å¤ªå¤§å…³ç³»ï¼Œå”¯ä¸€æœ‰å…³ç³»çš„å°±æ˜¯è¿™æ®µæ±‡ç¼–è¯­è¨€æ˜¯ä»¥å¼•å¯¼ä¸ºç›®çš„å†™çš„)\n\ndd bs=32 if=execfile of=boot skip=1     # è¿™é‡Œå»æ‰å¯æ‰§è¡Œç¨‹åºçš„å‰ 32 å­—èŠ‚ï¼Œå½¢æˆåˆšå¥½ 512 å­—èŠ‚çš„ boot å¼•å¯¼ç¨‹åº\n</code></pre>\n<h2>ç”¨ä»¿çœŸå™¨å¯åŠ¨å¼•å¯¼ç¨‹åº</h2>\n<p>äº‹å®ä¸Šï¼Œè¿™éƒ¨åˆ†å†…å®¹ï¼Œæˆ‘å§‹ç»ˆæ²¡æœ‰ææ¸…æ¥š <strong>ç£ç›˜æ˜ åƒæ–‡ä»¶</strong> å’Œ <strong>boot å¼•å¯¼ç¨‹åº</strong> é—´çš„å…³ç³»(å½“ç„¶è¿˜æœ‰ floppy å’Œ ata0~3)</p>\n<p>åœ¨ä¸Šä¸€èŠ‚æˆåŠŸæ‹¿åˆ° <em>512B</em> çš„ boot å¼•å¯¼ç¨‹åºä¹‹åï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ªè²Œä¼¼æˆ‘ä¹Ÿè¿è¡ŒæˆåŠŸäº†(æ ¹æœ¬å°±ä¸éœ€è¦åˆ›å»ºç£ç›˜æ˜ åƒæ–‡ä»¶å¹¶å°†å¼•å¯¼ç¨‹åºå†™å…¥æ˜ åƒæ–‡ä»¶ä¸­ï¼Œä¸è¿‡ï¼Œä¹Ÿè®¸åªæ˜¯å› ä¸ºè¿™ä¸ªå¼•å¯¼ç¨‹åºå¤ªç®€å•äº†ï¼Œæ ¹æœ¬å°±ä¸éœ€è¦å…¶ä»–ç¨‹åºçš„é…åˆã€‚å®ƒæœ€åå°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ )</p>\n<p>æ€»ä¹‹ï¼Œå…ˆæŒ‰ç…§æœ€ç®€å•çš„æ¥å§ã€‚</p>\n<p>æŠŠ boot å¼•å¯¼ç¨‹åºæ‹·è´åˆ°å®¿ä¸»æœºä¸Š(è²Œä¼¼é¢‘ç¹åœ°åœ¨ä¸¤ä¸ªOSä¸Šäº¤äº’æ–‡ä»¶ï¼Œè¿™ä¸ªå¾ˆæ— å¥ˆï¼Œdockerå®¹å™¨ä¸­çš„è¿›ç¨‹éš¾ä»¥å¯åŠ¨æ˜¾ç¤ºç¨‹åº)</p>\n<ol>\n<li>åœ¨å®¿ä¸»æœºæ–°å»ºä¸€ä¸ªç›®å½• <em>linux-boot</em></li>\n<li>æ‹·è´ boot å¼•å¯¼ç¨‹åºåˆ°å®¿ä¸»æœºä¸Š <code>docker cp linux:/root/boot linux-boot/</code></li>\n<li>åœ¨ <em>linux-boot</em> ä¸‹å»ºç«‹ bochsrc æ–‡ä»¶(è¿™å°†æ˜¯æ•´ä¸ªä»¿çœŸå™¨çš„é…ç½®ï¼Œç”¨äºæ¨¡æ‹Ÿç»„è£…æœºå™¨æ¶‰åŠçš„ CPU, å†…å­˜, BIOS, æ˜¾ç¤ºå™¨ç­‰)</li>\n<li>è¿™é‡Œä½¿ç”¨çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹:</li>\n</ol>\n<pre><code class="language-rc"># You may now use double quotes around pathnames, in case\n# your pathname includes spaces.\n\ncpu: model=pentium, count=1, ips=50000000, reset_on_triple_fault=1, ignore_bad_msrs=1, msrs="msrs.def"\ncpu: cpuid_limit_winnt=0\n\nmemory: guest=512, host=256\n\nromimage: file=$BXSHARE/BIOS-bochs-legacy, options=fastboot     # BIOS é…ç½®\n\nvgaromimage: file=$BXSHARE/VGABIOS-lgpl-latest\n\nmouse: enabled=0\n\npci: enabled=1, chipset=i440fx\n\nprivate_colormap: enabled=0\n\nfloppya: 1\\_44="./boot", status=inserted         # è£…è½½ä¸€ä¸ªè½¯ç›˜ A ï¼Œè¿™é‡Œç”¨å½“å‰ç›®å½•ä¸‹çš„ boot (boot å¼•å¯¼ç¨‹åºï¼Œäº‹å®ä¸Šä¹¦ä¸­è¯´è¦ç”¨ .img ç£ç›˜æ˜ åƒæ–‡ä»¶ï¼Œä½†è¿™é‡Œä¸å½±å“å®é™…æ•ˆæœ)\n\nata0: enabled=1, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14\nata1: enabled=1, ioaddr1=0x170, ioaddr2=0x370, irq=15\nata2: enabled=0, ioaddr1=0x1e8, ioaddr2=0x3e0, irq=11\nata3: enabled=0, ioaddr1=0x168, ioaddr2=0x360, irq=9\n\nboot: a                                         # é…ç½®å¼•å¯¼ç¨‹åºæ‰€åœ¨çš„ç£ç›˜\n\nfloppy_bootsig_check: disabled=0\n\nlog: bochsout.txt\n\npanic: action=ask\nerror: action=report\ninfo: action=report\ndebug: action=ignore, pci=report # report BX_DEBUG from module \'pci\'\n\ndebugger_log: -\n\nparport1: enabled=1, file="parport.out"\n\nspeaker: enabled=1, mode=sound\n</code></pre>\n<ol start="5">\n<li>å½“å‰ç›®å½• <em>linux-boot</em> ä¸‹ï¼Œé”®å…¥å‘½ä»¤ <code>bochs</code></li>\n<li>ç”±äºè¯»å–åˆ° <em>bochsrc</em> é…ç½®æ–‡ä»¶çš„å­˜åœ¨ï¼Œmenu çš„é»˜è®¤é€‰é¡¹ä¸º 6 (å¼€å§‹æ¨¡æ‹Ÿæœºå™¨)</li>\n</ol>\n<pre><code class="language-plain">You can also start bochs with the -q option to skip these menus.\n\n1. Restore factory default configuration\n2. Read options from...\n3. Edit options\n4. Save options to...\n5. Restore the Bochs state from...\n6. Begin simulation\n7. Quit now\n\nPlease choose one: [6]\n</code></pre>\n<ol start="7">\n<li>ç›´æ¥å¼€å§‹è¿è¡Œæœºå™¨ï¼Œé”®å…¥å‘½ä»¤ <code>c</code> (è¿™éƒ¨åˆ†åœ¨ <a href="https://dormouse-none.github.io/2018-08-19-understand-Kernel-0/">æ¦‚è¿°</a> æœ‰è¿‡äº†æè¿°ï¼Œä»¥åå°†ä¸å†æè¿°)</li>\n</ol>\n<pre><code class="language-plain">Please choose one: [6]\n00000000000i[      ] lt_dlhandle is 0x7f85d0405ff0\n00000000000i[PLUGIN] loaded plugin libbx_sdl2.so\n00000000000i[      ] installing sdl2 module as the Bochs GUI\n00000000000i[SDL2  ] maximum host resolution: x=2880 y=1800\n00000000000i[      ] using log file bochsout.txt\nNext at t=0\n(0) [0x0000fffffff0] f000:fff0 (unk. ctxt): jmpf 0xf000:e05b          ; ea5be000f0\n&#x3C;bochs:1> c\n</code></pre>\n<ol start="8">\n<li>è§‚å¯Ÿä»¿çœŸå™¨çš„è¡¨ç°</li>\n</ol>\n<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fuf2kicsqyj313y0q0gn4.jpg"></p>\n<p>Oh, YES! æˆåŠŸè¾“å‡ºäº† <em>Loading System...</em> (ä¸è¿‡å“é“ƒæ²¡æœ‰å¬åˆ°ï¼Œå¯èƒ½ä¸æˆ‘æ²¡æœ‰é…ç½® sound æœ‰å…³)</p>\n<ol start="9">\n<li>å…³æœº</li>\n</ol>\n<p>æ— éœ€å¤šè¨€ï¼Œå³ä¸Šè§’æ¨¡æ‹Ÿçš„å°±æ˜¯<strong>å…³æœºå®ä½“æŒ‰é”®</strong></p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},hCSg:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<h2>å‰è¨€</h2>\n<p>æ­¤åšæ–‡å†™ä½œçš„ç›®çš„: </p>\n<ul>\n<li>(Core) é€šè¿‡äº†è§£ CGlib Enhancer çš„æ•´ä¸ªè°ƒç”¨é“¾ï¼Œäº†è§£å…¶å¯¹äºå”¯ä¸€ä¾èµ–çš„ ASM åº“çš„è°ƒç”¨æ–¹å¼ã€‚</li>\n<li>åŸºäº Enhancer å¯¹å·²æœ‰å­—èŠ‚ç è¿›è¡Œå¢å¼ºçš„è¿›ä¸€æ­¥ç†è§£ä¸æŒæ¡ã€‚</li>\n</ul>\n<h2>Enhancer</h2>\n<p>ä»è¿™ç¯‡ä¸æ˜¯å®˜æ–¹ä½†æ›´èƒœäºå®˜æ–¹æ–‡æ¡£çš„ <a href="http://mydailyjava.blogspot.com/2013/11/cglib-missing-manual.html">CGlib Guide</a> æ¥çœ‹ï¼Œå®ƒé¦–å…ˆæåˆ°çš„ç¬¬ä¸€ä¸ªç±»å°±æ˜¯ Enhancerã€‚\nå…¶è¢«ç”¨äºåˆ›å»º Java ä»£ç†ç±»ï¼Œç›¸è¾ƒäº Java æ ‡å‡†åº“çš„ Proxy ç±»ï¼Œå®ƒ<strong>ç‰¹åˆ«åœ°</strong>ï¼Œèƒ½å¤Ÿæ”¯æŒé‚£äº›æ²¡æœ‰å®ç°æ¥å£çš„ç±»çš„ä»£ç†å·¥ä½œã€‚</p>\n<h3>Enhancer ç®€å•ç¤ºä¾‹å±•ç¤º</h3>\n<p>é’ˆå¯¹ç°æœ‰çš„ SampleClass ç±»</p>\n<pre><code class="language-java">public class SampleClass {\n    public String test(String input) {\n        return "Hello World!";\n    }\n}\n</code></pre>\n<p>ä½¿ç”¨ CGlib çš„ Enhancer å¯¹ SampleClass è¿›è¡Œå¢å¼ºï¼Œä¸‹åˆ—æ“ä½œçš„ç›®çš„åœ¨äºå°† test(String) æ–¹æ³•çš„è¿”å›å€¼æ”¹å†™æˆ "Hello cglib!"</p>\n<pre><code class="language-java">@Test\npublic void testFixedValue() {\n    // new ä¸€ä¸ª Enhancer å®ä¾‹\n    Enhancer enhancer = new Enhancer();\n    // å£°æ˜ä½¿ç”¨çš„çˆ¶ç±»æ˜¯ SampleClass\n    enhancer.setSuperclass(SampleClass.class);\n    // è®¾ç½®å›è°ƒæ–¹æ³• - å›è°ƒæ–¹æ³•å®ç°ä¸º FixedValue (å›ºå®šå€¼) .\n    enhancer.setCallback(new FixedValue() {\n        public Object loadObject() throws Exception {\n            return "Hello cglib!";\n        }\n    });\n    // åˆ›å»º SampleClass çš„ä»£ç†å­ç±»å®ä¾‹\n    SampleClass proxy = (SampleClass) enhancer.create();\n    Assert.assertEquals("Hello cglib!", proxy.test(null));\n}\n</code></pre>\n<p>ç®€å•æµ‹è¯•ä¸Šè¿°ä»£ç ï¼Œå¯ä»¥äº†è§£åˆ°ç¡®å®ï¼Œä»£ç†ç±»çš„ test(String) æ–¹æ³•çš„è¿”å›å€¼è¢«æ”¹å†™äº†ã€‚\né‚£ä¹ˆï¼Œç©¶ç«Ÿè¿™ç§æ“ä½œæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿä¸‹é¢ğŸ‘‡å°†è¿›è¡Œå…·ä½“çš„æ¢ç©¶ã€‚</p>\n<h2>è°ƒç”¨é“¾è·Ÿè¸ª</h2>\n<h3>é«˜åº¦æŠ½è±¡çš„æ—¶åºå›¾</h3>\n<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1ft4ifuo997j31jh0st42t.jpg" alt="Enhancer è°ƒç”¨é“¾ æ—¶åºå›¾"></p>\n<p><em>ä¸‹åˆ—å†…å®¹å°†æ ¹æ®æ—¶åºå›¾è¿›è¡Œç»„ç»‡ï¼Œæ ¹æ®è°ƒç”¨ç¼–å·(1,2,3...)è¿›è¡Œå±•å¼€</em></p>\n<h3>Seq 1.</h3>\n<pre><code class="language-java">public Object create() {\n    classOnly = false;\n    argumentTypes = null;\n    return createHelper();\n}\n\npublic Object create(Class[] argumentTypes, Object[] arguments) {\n    classOnly = false;\n    if (argumentTypes == null || arguments == null || argumentTypes.length != arguments.length) {\n        throw new IllegalArgumentException("Arguments must be non-null and of equal length");\n    }\n    this.argumentTypes = argumentTypes;\n    this.arguments = arguments;\n    return createHelper();\n}\n</code></pre>\n<p>ä¸Šè¿°ä¸¤ä¸ª <code>create(...)</code> æ–¹æ³•ã€‚ç»“åˆä¸Šä¸€èŠ‚çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ° <code>create()</code> å¯¹åº”çš„<strong>æ— å‚æ„é€ </strong>ã€‚\nå­˜åœ¨æ— å‚æ„é€ ï¼Œé‚£ä¹ˆ<strong>æœ‰å‚çš„æ„é€ æ–¹æ³•</strong>æ˜¾ç„¶ä¹Ÿæ˜¯åº”è¯¥è¢«æ”¯æŒidã€‚<code>create(Class[], Object[])</code> æ­£æ˜¯ä¸ºäº†è¿™ä¸ªç›®æ ‡è€Œå­˜åœ¨ã€‚é€šè¿‡æä¾›å‚æ•°ç±»å‹æ•°ç»„å’Œå‚æ•°å®ä¾‹æ•°ç»„ï¼Œå¯ä»¥å”¯ä¸€åœ°å®šä½åŠè°ƒç”¨ä»£ç†ç±»çš„ç‰¹å®šæ„é€ æ–¹æ³•ã€‚</p>\n<p>è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯å°† Enhancer ä½œä¸ºä¸€ä¸ªæ•°æ®å†…å®¹çš„æŒæœ‰è€…ï¼Œé‡ç½®äº†æ–°ä»£ç†ç±»å°†ä½¿ç”¨çš„æ„é€ å‡½æ•°å‚æ•°å†…å®¹ï¼Œä¹‹åå°±ç›´æ¥è°ƒç”¨äº† <code>createHelper()</code> ã€‚</p>\n<h3>Seq 2.</h3>\n<pre><code class="language-java">private Object createHelper() {\n    // å¯¹é¢„å£°æ˜çš„å›è°ƒæ–¹æ³•è¿›è¡ŒéªŒè¯ï¼Œè¦æ±‚ [å¤šä¸ªå›è°ƒå°±å¿…é¡»å­˜åœ¨ CallbackFilter ä½œä¸ºè°ƒåº¦å™¨]\n    preValidate();\n    // æ„å»ºä¸€ä¸ªå¯¹è¿™ç±»å¢å¼ºæ“ä½œå”¯ä¸€å®šä½çš„ key\n    Object key = KEY_FACTORY.newInstance((superclass != null) ? superclass.getName() : null,\n            ReflectUtils.getNames(interfaces),\n            filter == ALL_ZERO ? null : new WeakCacheKey&#x3C;CallbackFilter>(filter),\n            callbackTypes,\n            useFactory,\n            interceptDuringConstruction,\n            serialVersionUID);\n    this.currentKey = key;\n    // è°ƒç”¨çˆ¶ç±»é€šè¿‡çš„ create(...) æ–¹æ³•\n    Object result = super.create(key);\n    return result;\n}\n</code></pre>\n<h3>Seq 3.</h3>\n<pre><code class="language-java">protected Object create(Object key) {\n    try {\n        // è·å–ç”¨äº åŠ è½½ ç”Ÿæˆç±» çš„ ClassLoader\n        ClassLoader loader = getClassLoader();\n        // ä»ç¼“å­˜ä¸­åŠ è½½ è¿™ä¸ª ClassLoader è¿‡å»åŠ è½½çš„ç›¸å…³æ•°æ®\n        Map&#x3C;ClassLoader, ClassLoaderData> cache = CACHE;\n        ClassLoaderData data = cache.get(loader);\n        // å¦‚æœåœ¨ ç¼“å­˜ ä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™åˆå§‹åŒ–æ„é€ å…³äºè¿™ä¸ª ClassLoader çš„æ•°æ®å®ä¾‹\n        if (data == null) {\n            // åŒæ­¥\n            synchronized (AbstractClassGenerator.class) {\n                // è¿›å…¥åŒæ­¥å—åçš„ å†æ¬¡ç¡®è®¤ï¼Œé¿å…é‡å¤åˆå§‹åŒ–æ„å»º\n                cache = CACHE;\n                data = cache.get(loader);\n                if (data == null) {\n                    // æ„å»ºæ–°çš„ ç¼“å­˜ï¼Œæ‹·è´åŸæœ‰çš„ç¼“å­˜é›†çš„å†…å®¹\n                    Map&#x3C;ClassLoader, ClassLoaderData> newCache = new WeakHashMap&#x3C;ClassLoader, ClassLoaderData>(cache);\n                    // åˆå§‹åŒ– ClassLoaderData ï¼ŒçœŸæ­£çš„æ„é€ æ“ä½œ\n                    data = new ClassLoaderData(loader);\n                    // æ·»åŠ åˆ°ç¼“å­˜ä¸­\n                    newCache.put(loader, data);\n                    CACHE = newCache;\n                }\n            }\n        }\n        this.key = key;\n        Object obj = data.get(this, getUseCache());\n        if (obj instanceof Class) {\n            // åˆæ¬¡å®ä¾‹åŒ–æ“ä½œï¼Œå°±æ˜¯ Class åˆ©ç”¨åå°„æ¥è¿›è¡Œå®ä¾‹åŒ–\n            return firstInstance((Class) obj);\n        }\n        // éåˆæ¬¡å®ä¾‹åŒ–ï¼Œåˆ™æ˜¯ä» ClassLoaderData ä¸­å¾—åˆ°çš„ä¹‹å‰ç»´æŠ¤çš„å†…å®¹\n        return nextInstance(obj);\n    } catch (RuntimeException e) {\n        throw e;\n    } catch (Error e) {\n        throw e;\n    } catch (Exception e) {\n        throw new CodeGenerationException(e);\n    }\n}\n</code></pre>\n<p>è¿™éƒ¨åˆ†å†…å®¹æ¯”è¾ƒå¤šï¼Œä¸”æ˜¯è°ƒç”¨é“¾æ¯”è¾ƒé‡è¦çš„ä¸€ç¯ã€‚<strong>Seq 4.</strong> å’Œ <strong>Seq 5.</strong> å°†ä½œä¸ºå…¶å­å†…å®¹è¿›è¡Œè°ƒç”¨ï¼Œä½†ä¸ºäº†æœ¬åšæ–‡çš„ç»“æ„å®Œæ•´ï¼Œ <em>Seq 4. &#x26; Seq5.</em> çš„æ ‡é¢˜ä¸ <em>Seq 3.</em> æ ‡é¢˜åŒçº§</p>\n<h3>Seq 4.</h3>\n<p>é¦–å…ˆåº”è¯¥è®¤è¯†åˆ°ï¼Œæ¯ä¸ªè¢«åŠ è½½çš„ Class ï¼Œåœ¨ <code>equal</code> çš„åˆ¤æ–­è¿‡ç¨‹ä¸­ï¼Œä¾æ®çš„æ˜¯åŒä¸€ä¸ª ClassLoader åŠ è½½çš„åŒä¸€ Class æ‰è¢«è®¤ä¸ºæ˜¯ç›¸åŒçš„ï¼Œå¦åˆ™å³ä½¿ Class æ˜¯åŒä¸€ä¸ªï¼Œä½†ä»ä¼šè¢«è®¤ä¸ºæ˜¯ä¸åŒçš„(ç”±ä¸åŒçš„ ClassLoader åŠ è½½)ã€‚</p>\n<pre><code class="language-java">public ClassLoader getClassLoader() {\n    ClassLoader t = classLoader;\n    if (t == null) {\n        t = getDefaultClassLoader();\n    }\n    if (t == null) {\n        t = getClass().getClassLoader();\n    }\n    if (t == null) {\n        t = Thread.currentThread().getContextClassLoader();\n    }\n    if (t == null) {\n        throw new IllegalStateException("Cannot determine classloader");\n    }\n    return t;\n}\n</code></pre>\n<p>å› æ­¤ï¼Œåœ¨è¿™éƒ¨åˆ†ä¸­ï¼Œé¦–å…ˆéœ€è¦ç¡®å®šçš„æ˜¯ç”±å“ªä¸ª ClassLoader è¿›è¡ŒåŠ è½½çš„å·¥ä½œã€‚<code>getClassLoader()</code> çš„ç¡®å®šé¡ºåºæ˜¯:</p>\n<ol>\n<li>å…·ä½“å®ç°ç±»å£°æ˜çš„ <strong>é»˜è®¤ ClassLoader</strong> ä¸ºç¬¬ä¸€ä¼˜å…ˆçº§</li>\n<li>åŠ è½½å½“å‰ç±»(è¿™é‡Œæ˜¯ Enhancer) çš„ ClassLoader ä¸ºç¬¬äºŒä¼˜å…ˆçº§</li>\n<li><strong>å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡ ClassLoader</strong> ä¸ºç¬¬ä¸‰ä¼˜å…ˆçº§</li>\n<li>æŠ›å‡ºå¼‚å¸¸</li>\n</ol>\n<p>å›åˆ° <strong>Seq 3.</strong> çš„å†…å®¹ï¼Œ\nä¸‹ä¸€æ­¥æ˜¯å¯¹å½“å‰è¿™ä¸ª<strong>AbstractClassGenerator</strong> ç»´æŠ¤çš„ CACHE è¿›è¡Œå¤„ç†ï¼Œå¦‚æœåœ¨ CACHE ä¸­èƒ½å¤Ÿå¾—åˆ°ä»¥ç¡®å®šçš„ ClassLoader ä¸º Key çš„é”®å€¼å¯¹ï¼Œåˆ™ç›´æ¥è·å– ClassLoader å¯¹åº”çš„å€¼ï¼Œå¦åˆ™å°†è¿›è¡Œåˆå§‹åŒ–æ„å»ºä¸€ä¸ªæ–°çš„ ClassLoaderData ä½œä¸ºè¿™ä¸ª ClassLoader çš„å€¼ã€‚</p>\n<h3>Seq 5.</h3>\n<p>åœ¨æ„å»º ClassLoaderData çš„è¿‡ç¨‹ä¸­ï¼Œæœ€é‡è¦çš„ä¸€æ­¥:</p>\n<pre><code class="language-java">public ClassLoaderData(ClassLoader classLoader) {\n    // ClassLoader ä¸å¯ä¸ºç©º\n    if (classLoader == null) {\n        throw new IllegalArgumentException("classLoader == null is not yet supported");\n    }\n    // æ„å»º ClassLoader çš„å¼±å¼•ç”¨\n    this.classLoader = new WeakReference&#x3C;ClassLoader>(classLoader);\n    // å†™äº†ä¸ªåç½®è°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºæ‡’åŠ è½½ï¼Œåªæœ‰è°ƒç”¨äº† load.apply(...) æ‰ä¼šæ„å»º ç”Ÿæˆç±»\n    Function&#x3C;AbstractClassGenerator, Object> load =\n            new Function&#x3C;AbstractClassGenerator, Object>() {\n                public Object apply(AbstractClassGenerator gen) {\n                    Class klass = gen.generate(ClassLoaderData.this);\n                    return gen.wrapCachedClass(klass);\n                }\n            };\n    generatedClasses = new LoadingCache&#x3C;AbstractClassGenerator, Object, Object>(GET_KEY, load);\n}\n</code></pre>\n<p>æ„å»ºäº†ä¸€ä¸ª Function å®ä¾‹ï¼Œè¿™ä¸ª Function ä½œä¸ºå‡½æ•°å¼æ¥å£ï¼Œé¢„å®šä¹‰æ‰§è¡Œçš„å…·ä½“æµç¨‹ï¼Œä½†ç”±ä¸Šä¸‹æ–‡ç¡®å®šå…·ä½“çš„è°ƒç”¨æ—¶åˆ»ã€‚</p>\n<h3>Seq 6.</h3>\n<p>åœ¨æ­£ç¡®å¾—åˆ°äº† ClassLoader å¯¹åº”çš„ ClassLoaderData ä¹‹åï¼ŒClassLoaderData çš„ <code>get(...)</code> æ–¹æ³•å°†åœ¨ç‰¹å®šçš„ ClassLoader ä¹‹ä¸‹ï¼Œè¿›è¡Œæ›´å…·ä½“çš„åŠ è½½æ–°ç”Ÿæˆç±»çš„å·¥ä½œã€‚\nå½“ç„¶ï¼Œè¿™é‡Œçš„å‰ææ˜¯æ–°çš„ç”Ÿæˆç±»çš„å­—èŠ‚ç å·²ç»è¢«æ„å»º:)</p>\n<pre><code class="language-java">public Object get(AbstractClassGenerator gen, boolean useCache) {\n    // æ ‡è®°ä¸ºä¸ä½¿ç”¨ç¼“å­˜ï¼Œç›´æ¥æ„å»º æ–°çš„ç”Ÿæˆç±»\n    if (!useCache) {\n      return gen.generate(ClassLoaderData.this);\n    }\n    // ä½¿ç”¨ç¼“å†²çš„æƒ…å†µ\n    else {\n      Object cachedValue = generatedClasses.get(gen);\n      return gen.unwrapCachedValue(cachedValue);\n    }\n}\n</code></pre>\n<p>å¯ä»¥çœ‹åˆ° <code>gen.generate(ClassLoaderData.this)</code> è¿™æ®µä»£ç åœ¨ <code>get(...)</code> æ–¹æ³•å’Œä¸Šä¸€å°èŠ‚ <code>ClassLoaderData(...)</code> æ„é€ æ–¹æ³•çš„ Function å‡½æ•°å¼å®ä¾‹éƒ½å‡ºç°äº†ã€‚</p>\n<p>å®é™…ä¸Šï¼Œè¿™ä¹Ÿæ˜¯è§¦å‘ ClassLoader æ¥åŠ è½½åŠ¨æ€ç”Ÿæˆçš„æ–° Class çš„å”¯ä¸€å…¥å£ã€‚</p>\n<p><em>åˆ¤æ–­é€»è¾‘</em> çš„ <code>else</code> å†…å®¹çš„å”¯ä¸€åŒºåˆ«å°±åœ¨äºå…¶æ„å»ºçš„æ˜¯ä¸€ä¸ªåŠ è½½ç¼“å­˜ï¼Œå°†çœŸæ­£è§¦å‘ gen.generate(ClassLoaderData.this) çš„é€»è¾‘å»¶è¿Ÿã€‚(ä¸è¿‡ï¼Œæœ€ç»ˆä¹Ÿè¿˜æ˜¯ä¼šè¿›è¡Œè°ƒç”¨çš„ï¼Œ:) è¿™æ˜¯æ¯‹åº¸ç½®ç–‘çš„)ã€‚</p>\n<h3>Seq 7.</h3>\n<pre><code class="language-java">protected Class generate(ClassLoaderData data) {\n    Class gen;\n    Object save = CURRENT.get();\n    CURRENT.set(this);\n    try {\n        // æ‹¿åˆ°ç”¨äºåŠ è½½ç”Ÿæˆç±»çš„ ClassLoader\n        ClassLoader classLoader = data.getClassLoader();\n        if (classLoader == null) {\n            throw new IllegalStateException("ClassLoader is null while trying to define class " +\n                    getClassName() + ". It seems that the loader has been expired from a weak reference somehow. " +\n                    "Please file an issue at cglib\'s issue tracker.");\n        }\n        // æ„å»ºä¸€ä¸ªåˆæ³•çš„ ç”Ÿæˆç±» çš„ç±»å(éé‡å¤)\n        synchronized (classLoader) {\n          String name = generateClassName(data.getUniqueNamePredicate());\n          data.reserveName(name);\n          this.setClassName(name);\n        }\n        if (attemptLoad) {\n            try {\n                // å°è¯•ç›´æ¥é€šè¿‡ ClassLoader è¿›è¡ŒåŠ è½½\n                gen = classLoader.loadClass(getClassName());\n                return gen;\n            } catch (ClassNotFoundException e) {\n                // ignore\n            }\n        }\n        // ç­–ç•¥ä¸‹çš„ç”Ÿæˆç±»æ„å»ºæ–¹æ³•\n        byte[] b = strategy.generate(this);\n        // é€šè¿‡è§£æå­—èŠ‚ç çš„å½¢å¼è·å– ç”Ÿæˆç±»çš„ className\n        String className = ClassNameReader.getClassName(new ClassReader(b));\n        ProtectionDomain protectionDomain = getProtectionDomain();\n        synchronized (classLoader) { // just in case\n            // åå°„çš„å½¢å¼åŠ è½½ Class ç±»\n            if (protectionDomain == null) {\n                gen = ReflectUtils.defineClass(className, b, classLoader);\n            } else {\n                gen = ReflectUtils.defineClass(className, b, classLoader, protectionDomain);\n            }\n        }\n        return gen;\n    } catch (RuntimeException e) {\n        throw e;\n    } catch (Error e) {\n        throw e;\n    } catch (Exception e) {\n        throw new CodeGenerationException(e);\n    } finally {\n        CURRENT.set(save);\n    }\n}\n</code></pre>\n<p>è¿™ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯æ“ä½œå­—èŠ‚ç ï¼ŒåŠ è½½ Class çš„æ ¸å¿ƒè°ƒåº¦æ–¹æ³•ã€‚</p>\n<p>å¯ä»¥çœ‹åˆ° <code>generateClassName(...)</code> æ–¹æ³•å°†æ„å»ºä¸€ä¸ªå½“å‰ ClassLoader ä¸‹å”¯ä¸€, ä¸é‡å¤çš„æ–°çš„ç±»åã€‚</p>\n<p><code>strategy.generate(this)</code> å°†é€šè¿‡ç‰¹å®šç­–ç•¥å®ç°çš„å½¢å¼ç”Ÿæˆæ–°çš„å­—èŠ‚ç </p>\n<p><code>ReflectUtils.defineClass(className, b, classLoader)</code> å°†ä½¿ç”¨åå°„ä½¿å¾— ClassLoader æ¥åŠ è½½è¿™ä¸ªæ–°çš„ç”Ÿæˆç±»ã€‚</p>\n<h3>Seq 8.</h3>\n<p>ç”Ÿæˆæ–°çš„ä¸é‡å¤ç±»åè¿™éƒ¨åˆ†ä¸åšè¿‡å¤šé™ˆè¿°ï¼Œå¯ä»¥ç®€å•è¿›è¡Œäº†è§£ï¼Œå¹¶ç†Ÿæ‚‰ CGlib é»˜è®¤çš„æ–°ç±»åçš„å‘½åè§„åˆ™</p>\n<pre><code class="language-java">// DefaultNamePolicy\npublic String getClassName(String prefix, String source, Object key, Predicate names) {\n    if (prefix == null) {\n        prefix = "net.sf.cglib.empty.Object";\n    } else if (prefix.startsWith("java")) {\n        prefix = "$" + prefix;\n    }\n    String base =\n        prefix + "$$" +\n        source.substring(source.lastIndexOf(\'.\') + 1) +\n        getTag() + "$$" +\n        Integer.toHexString(STRESS_HASH_CODE ? 0 : key.hashCode());\n    String attempt = base;\n    int index = 2;\n    while (names.evaluate(attempt))\n        attempt = base + "_" + index++;\n    return attempt;\n}\n</code></pre>\n<h3>Seq 9.</h3>\n<pre><code class="language-java">// ä¸‹åˆ—æ˜¯ DefaultGeneratorStrategy çš„å®ç°\npublic byte[] generate(ClassGenerator cg) throws Exception {\n    DebuggingClassWriter cw = getClassVisitor();\n    transform(cg).generateClass(cw);\n    return transform(cw.toByteArray());\n}\n</code></pre>\n<h3>Seq 10.</h3>\n<p>è°ƒç”¨ <code>generateClass(ClassVisitor)</code> å°†è·å¾—åˆ°æ–°ç±»çš„å­—èŠ‚ç ã€‚</p>\n<pre><code class="language-java">public void generateClass(ClassVisitor v) throws Exception {\n    // ç¡®å®šç”Ÿæˆç±»çš„ çˆ¶ç±»\n    Class sc = (superclass == null) ? Object.class : superclass;\n\n    // çˆ¶ç±»æ ‡è¯†ç¬¦ä¸å¯ä»¥ä¸º final\n    if (TypeUtils.isFinal(sc.getModifiers()))\n        throw new IllegalArgumentException("Cannot subclass final class " + sc.getName());\n    // è·å–çˆ¶ç±»ç›´æ¥å£°æ˜çš„æ„é€ æ–¹æ³•\n    List constructors = new ArrayList(Arrays.asList(sc.getDeclaredConstructors()));\n    filterConstructors(sc, constructors);\n\n    // Order is very important: must add superclass, then\n    // its superclass chain, then each interface and\n    // its superinterfaces.\n    List actualMethods = new ArrayList();\n    List interfaceMethods = new ArrayList();\n    final Set forcePublic = new HashSet();\n    // ä»çˆ¶ç±»ä¸­æå–å„ç§ä¿¡æ¯\n    getMethods(sc, interfaces, actualMethods, interfaceMethods, forcePublic);\n\n    List methods = CollectionUtils.transform(actualMethods, new Transformer() {\n        public Object transform(Object value) {\n            Method method = (Method)value;\n            int modifiers = Constants.ACC_FINAL\n                | (method.getModifiers()\n                   &#x26; ~Constants.ACC_ABSTRACT\n                   &#x26; ~Constants.ACC_NATIVE\n                   &#x26; ~Constants.ACC_SYNCHRONIZED);\n            if (forcePublic.contains(MethodWrapper.create(method))) {\n                modifiers = (modifiers &#x26; ~Constants.ACC_PROTECTED) | Constants.ACC_PUBLIC;\n            }\n            return ReflectUtils.getMethodInfo(method, modifiers);\n        }\n    });\n\n    ClassEmitter e = new ClassEmitter(v);\n    if (currentData == null) {\n    e.begin_class(Constants.V1_2,\n                  Constants.ACC_PUBLIC,\n                  getClassName(),\n                  Type.getType(sc),\n                  (useFactory ?\n                   TypeUtils.add(TypeUtils.getTypes(interfaces), FACTORY) :\n                   TypeUtils.getTypes(interfaces)),\n                  Constants.SOURCE_FILE);\n    } else {\n        e.begin_class(Constants.V1_2,\n                Constants.ACC_PUBLIC,\n                getClassName(),\n                null,\n                new Type[]{FACTORY},\n                Constants.SOURCE_FILE);\n    }\n    List constructorInfo = CollectionUtils.transform(constructors, MethodInfoTransformer.getInstance());\n\n    e.declare_field(Constants.ACC_PRIVATE, BOUND_FIELD, Type.BOOLEAN_TYPE, null);\n    e.declare_field(Constants.ACC_PUBLIC | Constants.ACC_STATIC, FACTORY_DATA_FIELD, OBJECT_TYPE, null);\n    if (!interceptDuringConstruction) {\n        e.declare_field(Constants.ACC_PRIVATE, CONSTRUCTED_FIELD, Type.BOOLEAN_TYPE, null);\n    }\n    e.declare_field(Constants.PRIVATE_FINAL_STATIC, THREAD_CALLBACKS_FIELD, THREAD_LOCAL, null);\n    e.declare_field(Constants.PRIVATE_FINAL_STATIC, STATIC_CALLBACKS_FIELD, CALLBACK_ARRAY, null);\n    if (serialVersionUID != null) {\n        e.declare_field(Constants.PRIVATE_FINAL_STATIC, Constants.SUID_FIELD_NAME, Type.LONG_TYPE, serialVersionUID);\n    }\n\n    for (int i = 0; i &#x3C; callbackTypes.length; i++) {\n        e.declare_field(Constants.ACC_PRIVATE, getCallbackField(i), callbackTypes[i], null);\n    }\n    // This is declared private to avoid "public field" pollution\n    e.declare_field(Constants.ACC_PRIVATE | Constants.ACC_STATIC, CALLBACK_FILTER_FIELD, OBJECT_TYPE, null);\n\n    if (currentData == null) {\n        emitMethods(e, methods, actualMethods);\n        emitConstructors(e, constructorInfo);\n    } else {\n        emitDefaultConstructor(e);\n    }\n    emitSetThreadCallbacks(e);\n    emitSetStaticCallbacks(e);\n    emitBindCallbacks(e);\n\n    if (useFactory || currentData != null) {\n        int[] keys = getCallbackKeys();\n        emitNewInstanceCallbacks(e);\n        emitNewInstanceCallback(e);\n        emitNewInstanceMultiarg(e, constructorInfo);\n        emitGetCallback(e, keys);\n        emitSetCallback(e, keys);\n        emitGetCallbacks(e);\n        emitSetCallbacks(e);\n    }\n\n    e.end_class();\n}\n</code></pre>\n<p><code>generateClass(...)</code> æ‰§è¡Œçš„æ“ä½œå’Œ ASM åº“çš„ ClassVisitor è®¿é—® Class æ–‡ä»¶ç»“æ„çš„æµç¨‹åŸºæœ¬ç±»ä¼¼ã€‚</p>\n<p>ä»ä¸Šè¿°æˆªå–åˆ°çš„éƒ¨åˆ†ä»£ç ï¼Œä¾‹å¦‚:</p>\n<pre><code class="language-java">e.begin_class(Constants.V1_2, Constants.ACC_PUBLIC, getClassName(), Type.getType(sc), \n        (useFactory ? TypeUtils.add(TypeUtils.getTypes(interfaces), FACTORY) : TypeUtils.getTypes(interfaces)),\n        Constants.SOURCE_FILE);\n</code></pre>\n<pre><code class="language-java">e.declare_field(Constants.PRIVATE_FINAL_STATIC, THREAD_CALLBACKS_FIELD, THREAD_LOCAL, null);\n</code></pre>\n<p>éƒ½ä¸ <code>classVisitor.visit(...)</code> ä»¥åŠ <code>classVisitor.visitField(...)</code> ç›¸å½“ç±»ä¼¼ã€‚è€Œäº‹å®ä¸Šï¼Œè¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°ä¹Ÿç¡®å®è°ƒç”¨äº† cv.visitXxx(...) ã€‚\næ¯•ç«Ÿï¼Œä½œä¸º CGlib å”¯ä¸€ä¾èµ–çš„åº“ï¼ŒASM è¿˜æ˜¯å¯ä»¥è¯´æ˜¯éš¾ä»¥æ›¿ä»£çš„(æ—¢ç„¶å·²ç»æœ‰äº†å¯ç”¨çš„è½®å­ï¼Œåˆä½•å¿…é‡å¤é€ å‘¢?)</p>\n<h2>æ„é€ çš„å®ä¾‹</h2>\n<p>ä¸‹é¢å°†å±•ç¤ºé€šè¿‡ CGlib ç”Ÿæˆçš„æ–°çš„ç±»(ç”±äºç”Ÿæˆçš„æ˜¯å­—èŠ‚ç ï¼Œæ‡’å¾—å†è‡ªè¡Œè§£æ ClassFile çš„å†…å®¹ï¼Œæ‰€æœ‰ç›´æ¥ç”¨ <code>IDEA</code> åšäº†å­—èŠ‚ç çš„è§£æ)</p>\n<p><strong>é¦–å…ˆå±•ç¤ºçš„éœ€è¦è¿›è¡Œå¢å¼ºçš„ SampleClass çš„å…·ä½“å†…å®¹</strong></p>\n<pre><code class="language-java">public class SampleClass {\n    public String test(String input) {\n        return "Hello World!";\n    }\n}\n</code></pre>\n<p><strong>ç”¨äºå¢å¼ºçš„ç®€å•ä»£ç </strong></p>\n<pre><code class="language-java">// çœç•¥éƒ¨åˆ†ä»£ç \npublic static void main(String... args) {\n    Enhancer enhancer = new Enhancer();\n    enhancer.setSuperclass(SampleClass.class);\n    enhancer.setCallback(new FixedValue() {\n        public Object loadObject() throws Exception {\n            return "Hello cglib!";\n        }\n    });\n    SampleClass proxy = (SampleClass) enhancer.create();\n}\n</code></pre>\n<p><strong>åŠ¨æ€ç”Ÿæˆçš„æ–°çš„ç±»</strong></p>\n<pre><code class="language-java">//\n// Source code recreated from a .class file by IntelliJ IDEA\n// (powered by Fernflower decompiler)\n//\n\n// ä¸ç”¨è¿‡å¤šå…³æ³¨ï¼Œåªæ˜¯ CGlib ä¿è¯ç”Ÿæˆç±»ä¸åŸæœ‰çš„ç±»ä¸€å®šå±äºåŒä¸€åŒ…ä¸‹ï¼Œå·æ‡’ç›´æ¥æŠŠ SampleClass å†™åœ¨ CGlib é¡¹ç›®é‡Œäº†\npackage net.sf.cglib.samples;\n\nimport net.sf.cglib.proxy.Callback;\nimport net.sf.cglib.proxy.Factory;\nimport net.sf.cglib.proxy.FixedValue;\n\n/**\n * æ–°çš„ç±»åï¼Œé€šè¿‡ $$EnhancerByCGLIB ä»¥åŠ $$7cd64b81(è¿™ä¸ªæ˜¯å“ˆå¸Œå€¼) å¯¹ç±»åè¿›è¡Œå”¯ä¸€åŒºåˆ† \n * å¦‚æœè¿˜æ˜¯é‡å¤äº†ï¼Œåœ¨åŠ¨æ€ç”Ÿæˆå‰ä¼šè¿›è¡Œç±»åçš„æ£€æµ‹ï¼Œå¹¶é€šè¿‡å¢åŠ åºå· "_&#x3C;index>" çš„å½¢å¼è¿›è¡Œè¿›ä¸€æ­¥åŒºåˆ†\n *\n * å¯ä»¥çœ‹åˆ°æ–°ç”Ÿæˆçš„ç±»ç»§æ‰¿äº† SampleClass \n */\npublic class SampleClass$$EnhancerByCGLIB$$7cd64b81 extends SampleClass implements Factory {\n    private boolean CGLIB$BOUND;\n    public static Object CGLIB$FACTORY_DATA;\n    private static final ThreadLocal CGLIB$THREAD_CALLBACKS;\n    private static final Callback[] CGLIB$STATIC_CALLBACKS;\n\n    // ç»‘å®šä¸€ä¸ªåœ¨å¢å¼ºä¸­å£°æ˜çš„ Callback å®ä¾‹\n    private FixedValue CGLIB$CALLBACK_0;\n    // ç»‘å®šä¸€ä¸ªé™æ€çš„å›è°ƒè°ƒåº¦å®ä¾‹\n    private static Object CGLIB$CALLBACK_FILTER;\n\n    static void CGLIB$STATICHOOK1() {\n        CGLIB$THREAD_CALLBACKS = new ThreadLocal();\n    }\n\n    /**\n      * å¯¹ test(String) çš„æ–¹æ³•çš„å¢å¼º\n      */ \n    public final String test(String var1) {\n        // åœ¨æ–¹æ³•å—ä¸­æ‹¿åˆ° Callback å®ä¾‹\n        FixedValue var10000 = this.CGLIB$CALLBACK_0;\n        // ä¸ºç©ºåˆ™å°è¯•è·å–\n        if (this.CGLIB$CALLBACK_0 == null) {\n            CGLIB$BIND_CALLBACKS(this);\n            var10000 = this.CGLIB$CALLBACK_0;\n        }\n\n        // è§¦å‘å›è°ƒå®ä¾‹çš„æ–¹æ³•è·å¾—è¿”å›å€¼\n        return (String)var10000.loadObject();\n    }\n\n    /**\n      * ç”±äºæ­¤æ¬¡å¢å¼ºåªå£°æ˜äº†ä¸€ä¸ª Callback\n      * å› æ­¤æ‰€æœ‰æ–¹æ³•çš„å¢å¼ºéƒ½ç›¸åŒ, éƒ½æ˜¯è°ƒç”¨è¿™ä¸ªå›è°ƒæ–¹æ³•è·å–\n      */\n    public final boolean equals(Object var1) {\n        FixedValue var10000 = this.CGLIB$CALLBACK_0;\n        if (this.CGLIB$CALLBACK_0 == null) {\n            CGLIB$BIND_CALLBACKS(this);\n            var10000 = this.CGLIB$CALLBACK_0;\n        }\n\n        Object var2 = var10000.loadObject();\n        /**\n         * ä½†æ˜¯ï¼Œæ­¤å¤„ä¼šå°è¯•å¼ºåˆ¶è½¬å‹\n         * åŒæ—¶åœ¨æœ€ç»ˆæ‰§è¡Œå¤±è´¥çš„æ—¶å€™ç›´æ¥æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸\n         * æ¯•ç«Ÿä¸Šé¢å¢å¼ºçš„æ—¶å€™è¿”å›å›ºå®šå€¼ "Hello, cglib!"\n         */\n        return var2 == null ? false : (Boolean)var2;\n    }\n\n    public final String toString() {\n        FixedValue var10000 = this.CGLIB$CALLBACK_0;\n        if (this.CGLIB$CALLBACK_0 == null) {\n            CGLIB$BIND_CALLBACKS(this);\n            var10000 = this.CGLIB$CALLBACK_0;\n        }\n\n        return (String)var10000.loadObject();\n    }\n\n    public final int hashCode() {\n        FixedValue var10000 = this.CGLIB$CALLBACK_0;\n        if (this.CGLIB$CALLBACK_0 == null) {\n            CGLIB$BIND_CALLBACKS(this);\n            var10000 = this.CGLIB$CALLBACK_0;\n        }\n\n        Object var1 = var10000.loadObject();\n        return var1 == null ? 0 : ((Number)var1).intValue();\n    }\n\n    protected final Object clone() throws CloneNotSupportedException {\n        FixedValue var10000 = this.CGLIB$CALLBACK_0;\n        if (this.CGLIB$CALLBACK_0 == null) {\n            CGLIB$BIND_CALLBACKS(this);\n            var10000 = this.CGLIB$CALLBACK_0;\n        }\n\n        return var10000.loadObject();\n    }\n\n    public SampleClass$$EnhancerByCGLIB$$7cd64b81() {\n        CGLIB$BIND_CALLBACKS(this);\n    }\n\n    public static void CGLIB$SET_THREAD_CALLBACKS(Callback[] var0) {\n        CGLIB$THREAD_CALLBACKS.set(var0);\n    }\n\n    public static void CGLIB$SET_STATIC_CALLBACKS(Callback[] var0) {\n        CGLIB$STATIC_CALLBACKS = var0;\n    }\n\n    private static final void CGLIB$BIND_CALLBACKS(Object var0) {\n        SampleClass$$EnhancerByCGLIB$$7cd64b81 var1 = (SampleClass$$EnhancerByCGLIB$$7cd64b81)var0;\n        if (!var1.CGLIB$BOUND) {\n            var1.CGLIB$BOUND = true;\n            Object var10000 = CGLIB$THREAD_CALLBACKS.get();\n            if (var10000 == null) {\n                var10000 = CGLIB$STATIC_CALLBACKS;\n                if (CGLIB$STATIC_CALLBACKS == null) {\n                    return;\n                }\n            }\n\n            var1.CGLIB$CALLBACK_0 = (FixedValue)((Callback[])var10000)[0];\n        }\n\n    }\n\n    public Object newInstance(Callback[] var1) {\n        CGLIB$SET_THREAD_CALLBACKS(var1);\n        SampleClass$$EnhancerByCGLIB$$7cd64b81 var10000 = new SampleClass$$EnhancerByCGLIB$$7cd64b81();\n        CGLIB$SET_THREAD_CALLBACKS((Callback[])null);\n        return var10000;\n    }\n\n    public Object newInstance(Callback var1) {\n        CGLIB$SET_THREAD_CALLBACKS(new Callback[]{var1});\n        SampleClass$$EnhancerByCGLIB$$7cd64b81 var10000 = new SampleClass$$EnhancerByCGLIB$$7cd64b81();\n        CGLIB$SET_THREAD_CALLBACKS((Callback[])null);\n        return var10000;\n    }\n\n    public Object newInstance(Class[] var1, Object[] var2, Callback[] var3) {\n        CGLIB$SET_THREAD_CALLBACKS(var3);\n        SampleClass$$EnhancerByCGLIB$$7cd64b81 var10000 = new SampleClass$$EnhancerByCGLIB$$7cd64b81;\n        switch(var1.length) {\n        case 0:\n            var10000.&#x3C;init>();\n            CGLIB$SET_THREAD_CALLBACKS((Callback[])null);\n            return var10000;\n        default:\n            throw new IllegalArgumentException("Constructor not found");\n        }\n    }\n\n    public Callback getCallback(int var1) {\n        CGLIB$BIND_CALLBACKS(this);\n        FixedValue var10000;\n        switch(var1) {\n        case 0:\n            var10000 = this.CGLIB$CALLBACK_0;\n            break;\n        default:\n            var10000 = null;\n        }\n\n        return var10000;\n    }\n\n    public void setCallback(int var1, Callback var2) {\n        switch(var1) {\n        case 0:\n            this.CGLIB$CALLBACK_0 = (FixedValue)var2;\n        default:\n        }\n    }\n\n    public Callback[] getCallbacks() {\n        CGLIB$BIND_CALLBACKS(this);\n        return new Callback[]{this.CGLIB$CALLBACK_0};\n    }\n\n    public void setCallbacks(Callback[] var1) {\n        this.CGLIB$CALLBACK_0 = (FixedValue)var1[0];\n    }\n\n    static {\n        CGLIB$STATICHOOK1();\n    }\n}\n</code></pre>\n<p>ä»ä¸Šé¢çš„ç”Ÿæˆç±»å¯ä»¥çœ‹å‡ºæ¥ï¼ŒCGlib æ‰€è¿›è¡Œçš„å¢å¼ºï¼Œæ˜¯åœ¨ä¸ç›´æ¥å¯¹åŸæœ‰çš„æ–¹æ³•ä½“å†…å®¹è¿›è¡Œæ”¹é€ çš„åŸºç¡€ä¸Š(ä¾‹å¦‚ä¸Šé¢çš„ test(String) æ–¹æ³•ï¼Œæ²¡æœ‰ç›´æ¥æ”¹å†™æˆ <code>return "Hello, cglib!</code> çš„å½¢å¼)ï¼Œå¯¹æ–¹æ³•æ‰§è¡Œä¹‹å‰å…¥å‚æˆ–è€…æ–¹æ³•æ‰§è¡Œä¹‹åçš„è¿”å›å€¼è¿›è¡Œä¸€å®šçš„å¤„ç†ã€‚</p>\n<p>ä¸»è¦ä½¿ç”¨çš„å½¢å¼å°±æ˜¯å°†å›è°ƒå®ä¾‹ä¸åŸæœ‰æ–¹æ³•è¿›è¡Œç»‘å®šï¼Œå¹¶é€šè¿‡è°ƒç”¨å›è°ƒæ–¹æ³•æ¥å®ç°æ–¹æ³•çš„å¢å¼ºã€‚</p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},hW3s:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<h2>Start</h2>\n<p>ä»ç°æœ‰çš„å‰ç½®çŸ¥è¯†æ¥è¯´ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè®¤è¯†åˆ°ä¸¤ä¸ªäº‹å®:</p>\n<ol>\n<li>Java Class é€šè¿‡ ClassLoader è¿›è¡ŒåŠ è½½ã€‚\né€šè¿‡<code>å…¨é™å®šå</code>è¿›è¡ŒåŒºåˆ†ã€‚å½“éœ€è¦åŠ è½½æ–°çš„ç±»æ—¶ï¼ŒClassLoader é€šè¿‡åŒäº²å§”æ´¾æœºåˆ¶åˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½è¿‡è¿™ä¸ªç±»ã€‚\næ¢å¥è¯è¯´: Class ä¸€ç»åŠ è½½ï¼Œå°±ä¸ä¼šå°è¯•é‡å¤åŠ è½½ (è‡³å°‘æŒ‰ç»å¤§å¤šæ•°äººçš„è®¤çŸ¥æ¥è¯´ï¼Œç¡®å®æ˜¯çš„)</li>\n<li>æœ‰æ²¡æœ‰å¯èƒ½è®©è¢«åŠ è½½çš„ Class ä¸ç‰©ç†å­˜å‚¨ä¸Šçš„ .class å†…å®¹ä¸åŒã€‚\nå½“ç„¶ä¹Ÿæ˜¯å®Œå…¨å¯ä»¥åšåˆ°çš„ã€‚ä¸ç®¡æ€ä¹ˆè¯´ï¼ŒCGlib å’Œ Java Proxy ä¹Ÿæ˜¯ä¸€ä¸ªè€³ç†Ÿèƒ½è¯¦çš„æ¦‚å¿µå§\n(è™½ç„¶å¯èƒ½ä¸äº†è§£ç»†èŠ‚ã€‚åœ¨æ­¤ï¼Œæ¬¢è¿å­¦ä¹ å‰ç½®æŠ€èƒ½ <a href="https://dormouse-none.github.io/2018-07-10-CGlib-Enhancer/">CGlib Enhancer ä¸»æµç¨‹æºç è§£æ</a> å’Œ <a href="https://dormouse-none.github.io/2018-07-20-Java-Proxy/">Java Proxy æºç è§£æ</a>ã€‚ä¸è¿‡ä¸å½±å“æœ¬æ–‡åç»­å†…å®¹)</li>\n</ol>\n<p>å¦ä¸€ä¸ªæ–¹é¢ï¼Œä¹Ÿè®¸ç»å¤§å¤šæ•°äººéƒ½å¬è¯´è¿‡æ‰€è°“çš„<code>çƒ­éƒ¨ç½²</code>ã€‚ä½†æ˜¯ç©¶ç«Ÿæ€ä¹ˆæ‰èƒ½åšåˆ° <code>çƒ­éƒ¨ç½²</code>(è¯é¢˜å¼€å¾—æœ‰ç‚¹å¤§å“ˆã€‚Y_Y æœ¬æ–‡ä¸è®²è¿™ä¸ª)</p>\n<p>æ“ä½œå­—èŠ‚ç ä¸€å®šæ˜¯ä¸€ä¸ªé€ƒä¸å¼€çš„è¯é¢˜ï¼Œæ¯•ç«Ÿ Class å°±æ˜¯æ‰€è°“çš„è¢«åŠ è½½åˆ°å†…å­˜çš„å­—èŠ‚ç å˜›ã€‚</p>\n<p>å¦‚ä½•æ“ä½œå­—èŠ‚ç ? ASM, CGlib, Java Proxy, Javassist ? ä¸è¿‡è¿™äº›éƒ½è¦ç­‰åˆ°éœ€è¦è¢«æ“ä½œçš„ç±»è¢«åŠ è½½äº†æ‰è¡Œå•Šï¼Œä¼¼ä¹æœ‰ç‚¹æ™š...</p>\n<p>Java æä¾›äº†ä¸€ä¸ªå¯è¡Œçš„æœºåˆ¶ï¼Œç”¨æ¥åœ¨ ClassLoader åŠ è½½å­—èŠ‚ç ä¹‹å‰å®Œæˆå¯¹æ“ä½œå­—èŠ‚ç çš„ç›®çš„</p>\n<h2>Instrumentation</h2>\n<p><code>java.lang.instrument.Instrumentation</code> ç±»ä¸ºæä¾›ç›´æ¥æ“ä½œ Java å­—èŠ‚ç çš„åˆä¸€ä¸ªé€”å¾„(è™½ç„¶ Java Doc çš„è¯´æ˜æ˜¯ç”¨æ¥æ£€æµ‹ Java ä»£ç çš„)</p>\n<p>ç›¸ä¿¡æˆ‘è¿™ä¸ªè¯´æ˜æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚æ¯•ç«Ÿå®Œæˆå¯¹ä»£ç æ£€æµ‹çš„é€”å¾„æ˜¯ç›´æ¥ä¿®æ”¹å­—èŠ‚ç ã€‚</p>\n<p>ä¸‹åˆ—æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è¾¾åˆ°ç›®çš„</p>\n<ol>\n<li>å½“ JVM ä»¥æŒ‡ç¤ºä¸€ä¸ªä»£ç†ç±»çš„æ–¹å¼å¯åŠ¨æ—¶ï¼Œå°†ä¼ é€’ç»™ä»£ç†ç±»çš„ premain æ–¹æ³•ä¸€ä¸ª Instrumentation å®ä¾‹ã€‚</li>\n<li>å½“ JVM æä¾›æŸç§æœºåˆ¶åœ¨ JVM å¯åŠ¨ä¹‹åæŸä¸€æ—¶åˆ»å¯åŠ¨ä»£ç†æ—¶ï¼Œå°†ä¼ é€’ç»™ä»£ç†ä»£ç çš„ agentmain æ–¹æ³•ä¸€ä¸ª Instrumentation å®ä¾‹ã€‚</li>\n</ol>\n<p>è¯ä¸å¤šè¯´ï¼Œä¸‹é¢å°†å…¨éƒ¨ä»¥å®ä¾‹æ¥å±•ç°å¯¹è¿™ç§ JVM æ£€æµ‹æœºåˆ¶(è™½ç„¶ä¾‹å­å·²ç»è„±ç¦»äº†<em>æ£€æµ‹</em>çš„ç›®çš„)çš„ä½¿ç”¨</p>\n<h2>å¯¹å„æ–¹æ³•è¿›è¡Œæ‰§è¡Œæ—¶é—´ç»Ÿè®¡</h2>\n<h3>éš JVM ä¸€èµ·å¯åŠ¨</h3>\n<p>åŸºæœ¬å®ä¾‹: å°†å¯¹ç‰¹å®šåŒ… <code>me.fangfeng.client</code> ä¸‹çš„æ¯ä¸ªæ–¹æ³•æ‰§è¡Œè®¡æ—¶</p>\n<p>é¦–å…ˆäº†è§£ä¸€ä¸‹ client åŒ…çš„å†…å®¹:</p>\n<pre><code class="language-java">package me.fangfeng.client;\n\n/**\n * Main.java\n * æ‰§è¡Œä¸¤ä¸ªæ–¹æ³•ï¼Œrand() &#x26; sleep() \n *\n * @author fangfeng\n * @since 2018/8/7\n */\npublic class Main {\n\n    static void sleep() {\n        try {\n            Thread.sleep(5000);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n    }\n\n    public static void main(String[] args) {\n\n        Rand rand = new Rand();\n\n        for (int i=0;i&#x3C;10;i++) {\n            System.out.println(">>> start Rand.run() &#x3C;&#x3C;&#x3C;");\n            rand.run();\n            System.out.println(">>> end Rand.run() &#x3C;&#x3C;&#x3C;");\n\n            System.out.println();\n\n            System.out.println(">>> start Main.sleep() &#x3C;&#x3C;&#x3C;");\n            Main.sleep();\n            System.out.println(">>> end MAin.sleep() &#x3C;&#x3C;&#x3C;");\n\n            System.out.println();\n        }\n    }\n}\n</code></pre>\n<pre><code class="language-java">package me.fangfeng.client;\n\n/**\n * Rand.java\n * @author fangfeng\n * @since 2018/8/7\n */\npublic class Rand {\n\n    public void run() {\n        while (true) {\n            double rand = Math.random();\n            if (rand > 0.995) {\n                System.out.println(String.format("get random, values %f", rand));\n                return;\n            }\n        }\n    }\n}\n</code></pre>\n<p>æ¥ç€ï¼Œæ¥æ„é€ ä¸€ä¸ªä»£ç†ç±»ï¼Œä»¥åŠæœ€é‡è¦çš„ <code>premain</code> æ–¹æ³•</p>\n<pre><code class="language-java">package me.fangfeng.javaagent;\n\nimport java.lang.instrument.Instrumentation;\n\n/**\n * Agent - ä»£ç†\n * åŸºäº JVM TI (JVM Tool Interface) å®ç°çš„ Java ClassFile çš„å¢å¼º\n * @author fangfeng\n * @since 2018/8/7\n */\npublic class Agent {\n\n    // premain å°† JVM åˆå§‹åŒ–åï¼Œmain(String... ) æ‰§è¡Œå‰è°ƒç”¨\n    public static void premain(String args, Instrumentation instrumentation) {\n        // new ä¸€ä¸ªè½¬æ¢å™¨å®ä¾‹\n        ClassTimer transformer = new ClassTimer();\n        instrumentation.addTransformer(transformer);\n    }\n\n    // ä¹‹åçš„ agentmain(...) å°†åœ¨è¿™é‡Œæä¾›ï¼Œæš‚æ—¶éšå»ï¼Œé¿å…å¯¹å¯¹è¯»è€…äº§ç”Ÿå¹²æ‰°\n}\n</code></pre>\n<pre><code class="language-java">package me.fangfeng.javaagent;\n\nimport org.objectweb.asm.ClassReader;\nimport org.objectweb.asm.ClassWriter;\nimport org.objectweb.asm.Opcodes;\n\nimport java.lang.instrument.ClassFileTransformer;\nimport java.security.ProtectionDomain;\n\n/**\n * @author fangfeng\n * @since 2018/8/7\n */\npublic class ClassTimer implements ClassFileTransformer {\n\n    @Override\n    public byte[] transform(ClassLoader loader, String className, Class&#x3C;?> classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) {\n        // è¿™é‡Œæ¶‰åŠåˆ°äº† ASM çš„å†…å®¹ï¼Œä¸»è¦ç›®çš„æ˜¯å‘æ¯ä¸ªæ–¹æ³•å—çš„å¼€å§‹åŠæ–¹æ³•å—çš„ç»“æŸéƒ¨åˆ†æ’å…¥ä¸è®¡æ—¶å™¨æœ‰å…³çš„ä»£ç \n        // å¦‚æœæƒ³äº†è§£ ASM çš„å†…å®¹ï¼Œè¯·å‚é˜… https://dormouse-none.github.io/2018-06-25-ASM-Core/  æä¾›äº†ä¸€äº›åŸºç¡€æ€§çš„å†…å®¹ï¼Œæ›´å¤šçš„è¯·è‡ªè¡Œå­¦ä¹ \n        // ä¸äº†è§£å…·ä½“å†…å®¹å°†ä¸å½±å“å¯¹ä¸»ä½“å†…å®¹çš„ç†è§£\n        ClassReader cr = new ClassReader(classfileBuffer);\n        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);\n        MyClassWriter mcw = new MyClassWriter(Opcodes.ASM6, cw);\n        cr.accept(mcw, ClassReader.EXPAND_FRAMES);\n        return cw.toByteArray();\n    }\n}\n</code></pre>\n<p>å…¶å®ƒä»£ç ç•¥ï¼Œè¯¦è§é™„ä»¶ã€‚</p>\n<p>Java è¿™ç§å¯¹æ“ä½œå­—èŠ‚ç çš„æ”¯æŒæœ‰ä¸ªå‘çˆ¹çš„åœ°æ–¹ï¼Œå°±æ˜¯ä¸å¾—ä¸æ‰“åŒ…æˆ Jar æ¥ä½¿ç”¨ã€‚</p>\n<p>å…·ä½“æ¥çœ‹ä¸€ä¸‹</p>\n<p><code>me.fangfeng.javaagent</code> åŒ…ä¸­åŒ…æ‹¬ </p>\n<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fublsbbdw0j309o07g74u.jpg"></p>\n<p>å°†è¢«æ‰“åŒ…æˆ <code>agent.jar</code> æ¥ä½¿ç”¨</p>\n<p>é¦–å…ˆï¼Œæ¥çœ‹ä¸€ä¸‹éœ€è¦æ‰“åŒ…åœ¨ <code>agent.jar</code> çš„ <strong>MANIFEST.MF</strong> çš„å†…å®¹</p>\n<pre><code>Manifest-Version: 1.0\nClass-Path: /Users/fangfeng/.m2/repository/org/ow2/asm/asm/6.1.1/asm-6.1.1.jar\nPremain-Class: me.fangfeng.javaagent.Agent\nCan-Retransform-Classes: true\n</code></pre>\n<p>å†æ¥ä¸ª SHELL è„šæœ¬ï¼Œç”¨æ¥ç»™æ‰“åŒ…è¿™ä¸ª Jar</p>\n<pre><code class="language-sh">#!/bin/bash\n\n# ç¼–è¯‘ me.fangfeng.javaagent åŒ…ä¸‹çš„ç±»\njavac -cp .:/Users/fangfeng/.m2/repository/org/ow2/asm/asm/6.1.1/asm-6.1.1.jar me/fangfeng/javaagent/Agent.java me/fangfeng/javaagent/ClassTimer.java me/fangfeng/javaagent/MyClassWriter.java me/fangfeng/javaagent/MyMethodWriter.java me/fangfeng/javaagent/StaticTimer.java\n\n# æ‰“åŒ… me.fangfeng.javaagent çš„ .class -> agent.jar\njar cvfm agent.jar MANIFEST-agent.MF me/fangfeng/javaagent/Agent.class me/fangfeng/javaagent/ClassTimer.class me/fangfeng/javaagent/MyClassWriter.class me/fangfeng/javaagent/MyMethodWriter.class me/fangfeng/javaagent/StaticTimer.class\n\n# ç¼–è¯‘ me.fangfeng.client åŒ…ä¸‹çš„ç±»\njavac me/fangfeng/client/Main.java me/fangfeng/client/Rand.java\n\n# ä»¥ me.fangfeng.client.Main ä½œä¸ºä¸»ç±»å¯åŠ¨\njava -javaagent:agent.jar me.fangfeng.client.Main\n</code></pre>\n<p>æ‰§è¡Œåï¼Œå¯ä»¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹å†…å®¹:</p>\n<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fubmp354ejj30tq0rmtdp.jpg"></p>\n<p>è€Œç›´æ¥ç”¨ <code>java me.fangfeng.client.Main</code> çš„æ‰§è¡Œç»“æœæ˜¯:</p>\n<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fubmqmj4uhj30j00f0dho.jpg"></p>\n<p>ä»ç†è®ºä¸Šæ¥è®²ï¼Œ<code>-javaagent:agent.jar</code> é…åˆ <code>agent.jar</code> ä¸­çš„ MANIFEST.MF æ–‡ä»¶ï¼Œ\nä½¿å¾— JVM åœ¨åˆå§‹åŒ–ä¹‹åè§¦å‘äº†è¢«å£°æ˜ä¸º <code>Pre-Main</code> çš„ me.fangfeng.javaagent.Agent ç±»çš„ premain(...) æ–¹æ³•ã€‚</p>\n<p>å¹¶ä¸º ClassLoader åœ¨åŠ è½½ç±»çš„æµç¨‹ä¸Šå¢åŠ äº†ä¸€å±‚<strong>æ‹¦æˆªå™¨</strong> (è¿™é‡Œæ˜¯ ClassTimer.java ç±»ï¼Œå®ƒå®ç°äº† <code>ClassFileTransformer</code> æ¥å£</p>\n<p>å¦å¤–ï¼Œ<code>Can-Retransform-Classes: true</code> çš„é…ç½®ä½¿å¾— ClassTimer è¢«å…è®¸å¯¹å­—èŠ‚ç è¿›è¡Œé‡æ–°è½¬æ¢ã€‚(è€Œæ“ä½œå­—èŠ‚ç æ˜¯é€šè¿‡ ASM æ¥å®ç°çš„)</p>\n<h3>åœ¨è¿è¡Œä¸­è¿›è¡Œå¢å¼º</h3>\n<p>éšç€ç¨‹åºå¯åŠ¨æ—¶ç›´æ¥ä½¿ç”¨äº† <code>-javaagent</code> é€‰é¡¹ã€‚</p>\n<p>é‚£ä¹ˆæ˜¯å¦å­˜åœ¨åœ¨ç¨‹åºè¿è¡Œä¸­è¿›è¡Œé¢å¤–ä»£ç†æ“ä½œçš„æ”¯æŒå‘¢ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ã€‚è¿™é‡Œè¦å€ŸåŠ© Java æä¾›çš„å¦ä¸€ä¸ªç±» com.sun.tools.attach.VirtualMachine ã€‚</p>\n<p>å¯åŠ¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹æ¥è¿æ¥åˆ° æ­£åœ¨è¿è¡Œä¸­çš„è¿›ç¨‹ï¼Œå¹¶ä»¤å…¶åŠ è½½ java agentã€‚</p>\n<p>åŸºæœ¬çš„ç±»ä¸ä¸Šä¸€èŠ‚çš„æè¿°ç›¸åŒï¼Œä¸»è¦æ˜¯åŒ… <code>me.fangfeng.javaagent.*</code> å’Œ <code>me.fangfeng.client.*</code></p>\n<p>æ–°å¢ä¸€ä¸ªç±» <code>me.fangfeng.javaagent.Main</code> ç”¨æ¥å¯åŠ¨å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶è¦æ±‚è¿è¡Œä¸­çš„ java è¿›ç¨‹åŠ è½½ agent.jar æ¥è¿›è¡Œå¢å¼ºã€‚</p>\n<pre><code class="language-java">package me.fangfeng.javaagent;\n\nimport com.sun.tools.attach.AgentInitializationException;\nimport com.sun.tools.attach.AgentLoadException;\nimport com.sun.tools.attach.AttachNotSupportedException;\nimport com.sun.tools.attach.VirtualMachine;\n\nimport java.io.IOException;\n\n/**\n * @author fangfeng\n * @since 2018/8/7\n */\npublic class Main {\n\n    public static void main(String[] args) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException {\n        VirtualMachine vm = null;\n        try {\n            // é€šè¿‡ VirtualMachine è¿æ¥åˆ° è¿è¡Œä¸­çš„è¿›ç¨‹ (å¯ä»¥é€šè¿‡ jps æ‰¾åˆ°è¿›ç¨‹å·)\n            vm = VirtualMachine.attach(&#x3C;PID>);\n            vm.loadAgent(&#x3C;agent.jar çš„è·¯å¾„>);\n        } finally {\n            if (vm != null) {\n                vm.detach();\n            }\n        }\n    }\n}\n</code></pre>\n<pre><code class="language-java">public class Agent {\n\n    public static void premain(String args, Instrumentation instrumentation) {\n        ClassTimer transformer = new ClassTimer();\n        instrumentation.addTransformer(transformer);\n    }\n\n    // ç°åœ¨åœ¨ Agent.java ä¸Šè¡¥ä¸Š agentmain(...) çš„å…·ä½“å®ç°\n    public static void agentmain(String args, Instrumentation instrumentation) throws UnmodifiableClassException {\n        System.out.println("SUCCESS AGENTMAIN");\n        ClassTimer transformer = new ClassTimer();\n        // add Transformer\n        instrumentation.addTransformer(transformer, true);\n        // å¯¹ Rand.class è¿›è¡Œé‡æ–°è½¬æ¢\n        instrumentation.retransformClasses(Rand.class);\n    }\n}\n</code></pre>\n<p>å…¶å®ƒå†…å®¹åŸºæœ¬ç›¸åŒ</p>\n<p>é¦–å…ˆéœ€è¦å…ˆæ‰“åŒ… agent.jar ã€‚å½“ç„¶ï¼Œå¦‚æœæ˜¯é¡ºç€æœ¬æ–‡çš„é¡ºåºè¿›è¡Œæœ¬æœºå®éªŒï¼Œåˆ™ agent.jar å·²ç»å­˜åœ¨</p>\n<p>å…ˆå¯åŠ¨è¿›ç¨‹ <code>java me.fangfeng.client.Main</code></p>\n<p>é€šè¿‡ <code>jps</code> è·å– Main è¿›ç¨‹çš„ <strong>PID</strong></p>\n<p>åœ¨ <code>java me.fangfeng.javaagent.Main</code> ä¸­æ›¿æ¢ä¸Šè¿›ç¨‹å·ï¼Œå¹¶æ‰§è¡Œ</p>\n<p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fuboclcelsj30tu152dlw.jpg"></p>\n<p>ä»æ‰§è¡Œç»“æœå¯ä»¥çœ‹åˆ°ï¼ŒåŸè¿›ç¨‹é¦–å…ˆæ­£å¸¸æ‰§è¡Œä»£ç ï¼Œç­‰åˆ°è¢« load Agent ä¹‹åï¼Œå­—èŠ‚ç å·²ç»æœ‰äº†æ–°çš„å˜åŒ–ï¼Œä»è€Œå¯¼è‡´è¾“å‡ºç»“æœåŠ¨æ€çš„äº§ç”Ÿäº†å˜åŒ–ã€‚</p>\n<p><em>å½“ç„¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰§è¡Œä¸­çš„è¿›ç¨‹è¢«è¦æ±‚ load Agent ä¹‹åï¼Œè¿è¡Œä¸­çš„ Class å°†è¢«æ”¹å†™ï¼Œå¹¶å§‹ç»ˆå¦‚æ­¤ï¼ŒçŸ¥é“è¿›ç¨‹ç»ˆæ­¢ã€‚å†ä¸‹ä¸€æ¬¡é‡æ–°å¯åŠ¨</em></p>\n<h2>BTrace</h2>\n<p>ä»¥ä¸Šæè¿°çš„å†…å®¹ä¹Ÿå¯ä»¥ç†è§£ä¸ºæ˜¯ BTrace å®ç°çš„åŸºç¡€ã€‚æ¯•ç«Ÿï¼ŒJVMTI (JVM Tool Interface) åŸæœ¬çš„ç›®çš„å°±æ˜¯èµ‹äºˆä½¿ç”¨è€…ä¸€ä¸ªåœ¨è¿è¡Œä¸­\næŸ¥è¯¢ç³»ç»Ÿå„é¡¹æ•°æ®çš„æƒåˆ©</p>\n<p>å½“ç„¶ï¼Œå®ç°ä¸Šï¼Œä¸Šè¿°ä»£ç ç›´æ¥å°†å„ç§å¢å¼º(è®¡æ—¶)ç¡¬ç¼–ç åˆ°è¯¥è¿›ç¨‹ä¸­ï¼ŒåŒæ—¶ç»Ÿä¸€ä½¿ç”¨äº†è¯¥è¿›ç¨‹çš„è¾“å…¥è¾“å‡ºã€‚</p>\n<p>ä½†æ˜¯ï¼ŒBTrace é€šè¿‡ Socket å°†è¿™äº›åˆ†ç¦»ï¼Œæ£€æµ‹ä»£ç é€šè¿‡ Socket å‘å›æ–°çš„è¿›ç¨‹æ¥ç»´æŒè¾“å…¥è¾“å‡ºã€‚</p>\n<p>åœ¨æ­¤ï¼Œä¸å†ç»†è¯´ã€‚</p>\n<h2>é™„å½•</h2>\n<p>[1]. ç¤ºä¾‹ä»£ç : <a href="https://github.com/DorMOUSE-None/Repo/raw/master/instru.zip">instru.zip</a>\n[2]. <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/Instrumentation.html">java.lang.instrument.Instrumentation</a>\n[3]. <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html">Package java.lang.instrument</a></p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},hzKy:function(n,e,t){var a={"./2018-01-15-Spring-JDBC-Code-Reading.json":"6bZZ","./2018-03-01-åŒºå—é“¾ç®€å•ä»‹ç».json":"cN4P","./2018-06-11-ASM-ClassReader.json":"NctQ","./2018-06-21-java-memory-model.json":"nYHc","./2018-06-25-ASM-Core.json":"KZDG","./2018-06-28-ASM-VerifyError.json":"BQvL","./2018-07-04-JDK-Permission.json":"W2Zs","./2018-07-10-CGlib-Enhancer.json":"hCSg","./2018-07-13-How-to-easily-get-CGlib-generated-code.json":"tpF5","./2018-07-20-Java-Proxy.json":"bzvy","./2018-07-24-JVM-Instruction.json":"xo5S","./2018-08-15-Java-Instrumentation.json":"hW3s","./2018-08-19-understand-Kernel-0.json":"S4Mp","./2018-08-19-understand-Kernel-1.json":"fuPZ","./2018-08-26-understand-Kernel-2.json":"B/bq","./2018-09-08-preprocessor-output.json":"fORH","./2018-09-18-TCP-SYN.json":"GuZ5","./2018-09-27-mail.json":"CrC2","./2018-10-06-understand-Kernel-3.json":"yEfC","./2018-10-12-understand-Kernel-4.json":"BX5X","./2018-10-14-understand-Kernel-5.json":"H67F","./2018-11-11-understand-Kernel-6.json":"5DNh","./2018-11-16-regex-exponential-explosion.json":"SqPm","./2018-12-15-sql-injection.json":"wCSB","./2018-12-28-understand-Kernel-7.json":"zZw6","./2019-01-15-understand-Kernel-8.json":"9vk+","./2019-02-02-unicode.json":"RrPW","./2019-02-27-Java-Fatal-API.json":"IBPC","./2019-03-05-understand-Kernel-9.json":"frAL","./2019-03-19-JANUS.json":"LRZv","./2019-03-25-mem-dump.json":"mF68","./2019-04-10-understand-Kernel-10.json":"U8rl"};function r(n){var e=o(n);return t(e)}function o(n){var e=a[n];if(!(e+1)){var t=new Error("Cannot find module '"+n+"'");throw t.code="MODULE_NOT_FOUND",t}return e}r.keys=function(){return Object.keys(a)},r.resolve=o,n.exports=r,r.id="hzKy"},mF68:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>å‰äº›å¤©çœ‹äº†å…³äºåœ¨å¯†ç å­¦åº”ç”¨ä¸­ä½¿ç”¨<code>java.lang.String</code>ä¸<code>byte[]</code>çš„ç›¸å…³è®¨è®ºï¼Œä¸æ¨èä½¿ç”¨<code>java.lang.String</code>çš„é‡ç‚¹å°±æ˜¯å…¶å°†åœ¨JVMä¸­é©»ç•™ï¼Œä»è€Œå¯èƒ½è¢«çªƒå–ã€‚ä½†æ˜¯ï¼Œå¦‚ä½•ä»å†…å­˜ä¸­è·å–è¿™äº›å†…å®¹ï¼ŸJVMå½“ç„¶æä¾›äº†ä¸€äº›æœºåˆ¶ï¼Œä½†æ˜¯ä¸ªäººæ›´å–œæ¬¢ä»å†…æ ¸çš„è§’åº¦æ¥çœ‹çœ‹è¿™ä¸ªé—®é¢˜ã€‚</p>\n<h2>/proc/${pid}/maps</h2>\n<p>é¦–å…ˆå½“ç„¶æ˜¯ç¡®å®šè¿›ç¨‹å †æ ˆåœ¨ç‰©ç†å†…å­˜çš„ä½ç½®å•¦ã€‚å¾ˆé—æ†¾ï¼Œæ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„æ–¹æ¡ˆã€‚æ¯•ç«Ÿè¿›ç¨‹è®°å½•çš„éƒ½æ˜¯è™šæ‹Ÿçº¿æ€§åœ°å€ï¼Œè€Œé€šè¿‡å†…æ ¸åˆ†æ®µã€åˆ†é¡µæœºåˆ¶æœ€ç»ˆæ˜ å°„åˆ°ç‰©ç†å†…å­˜ã€‚ä¸è¿‡ï¼Œä»<code>/proc</code>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæä¾›äº†è¿›ç¨‹è™šæ‹Ÿåœ°å€æ˜ å°„ã€‚</p>\n<pre><code>address                   perm offset   dev   inode                      pathname\n556566cb5000-556566cb6000 r-xp 00000000 fc:01 2496598                    /root/ffTrace/run\n556566eb5000-556566eb6000 r--p 00000000 fc:01 2496598                    /root/ffTrace/run\n556566eb6000-556566eb7000 rw-p 00001000 fc:01 2496598                    /root/ffTrace/run\n55656814f000-556568170000 rw-p 00000000 00:00 0                          [heap]\n7f2a95f91000-7f2a96178000 r-xp 00000000 fc:01 1835434                    /lib/x86_64-linux-gnu/libc-2.27.so\n7f2a96178000-7f2a96378000 ---p 001e7000 fc:01 1835434                    /lib/x86_64-linux-gnu/libc-2.27.so\n7f2a96378000-7f2a9637c000 r--p 001e7000 fc:01 1835434                    /lib/x86_64-linux-gnu/libc-2.27.so\n7f2a9637c000-7f2a9637e000 rw-p 001eb000 fc:01 1835434                    /lib/x86_64-linux-gnu/libc-2.27.so\n7f2a9637e000-7f2a96382000 rw-p 00000000 00:00 0\n7f2a96382000-7f2a963a9000 r-xp 00000000 fc:01 1835410                    /lib/x86_64-linux-gnu/ld-2.27.so\n7f2a965a0000-7f2a965a2000 rw-p 00000000 00:00 0\n7f2a965a9000-7f2a965aa000 r--p 00027000 fc:01 1835410                    /lib/x86_64-linux-gnu/ld-2.27.so\n7f2a965aa000-7f2a965ab000 rw-p 00028000 fc:01 1835410                    /lib/x86_64-linux-gnu/ld-2.27.so\n7f2a965ab000-7f2a965ac000 rw-p 00000000 00:00 0\n7ffe2cf5e000-7ffe2cf7f000 rw-p 00000000 00:00 0                          [stack]\n7ffe2cfed000-7ffe2cff0000 r--p 00000000 00:00 0                          [vvar]\n7ffe2cff0000-7ffe2cff2000 r-xp 00000000 00:00 0                          [vdso]\nffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]\n</code></pre>\n<p><code>/proc/${pid}/maps</code> è®°å½•äº†å½“å‰è¿›ç¨‹è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„åˆ†é…ä»¥åŠå…¶è®¿é—®æ§åˆ¶ã€‚</p>\n<ul>\n<li>å‰ä¸‰è¡Œè¡¨è¿°çš„æ˜¯å½“å‰è¿›ç¨‹ELFæ–‡ä»¶åœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„åœ°å€ï¼ˆè¿™é‡Œä½¿ç”¨çš„ELFæ–‡ä»¶åä¸º <code>run</code> ï¼‰<ul>\n<li>ç¬¬ä¸€è¡Œ <code>r-xp</code> è¡¨ç¤ºå…¶å°†é…åˆ<code>Code Segment Register (CS)</code> ä½œä¸ºCPUæ‰§è¡ŒæŒ‡ä»¤çš„ç›´æ¥ä¾æ®ã€‚</li>\n<li>ç¬¬äºŒä¸‰è¡Œåˆ†åˆ«ç”¨ä½œå¯è¯»ã€å¯å†™æ•°æ®åŒºï¼Œå°†é…åˆ <code>Data Segment Register (DS), ES, FS, GS</code> ç­‰ä½¿ç”¨</li>\n</ul></li>\n<li>ç¬¬å››è¡Œç›´æˆªäº†å½“ï¼Œå°±æ˜¯åˆ†é…ç»™å †çš„åœ°å€ç©ºé—´ã€‚å½“ç„¶ï¼Œå¦‚æœä¸å¤Ÿï¼Œå¯ä»¥ä¸æ–­åœ°å‘ä¸Šæ‰©å¼ ã€‚</li>\n<li><code>xxx.so</code> æ–‡ä»¶æè¿°çš„æ˜¯Cå…±äº«åº“åœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„åœ°å€ã€‚</li>\n<li>æœ€åæ‰æ˜¯æ ˆå†…å­˜ï¼Œå°†ä»¥å€’åºçš„æ–¹å¼ä¸‹å†…å­˜ä½åœ°å€æ‰©å¼ ã€‚</li>\n<li>è‡³äºä¹‹åçš„å†…å®¹ï¼Œä¸äº†è§£ï¼Œä¸è¡¨ã€‚</li>\n</ul>\n<h2>ptrace</h2>\n<p>æ‹¿åˆ°äº†è¿›ç¨‹è™šæ‹Ÿå†…å­˜åˆ†å¸ƒï¼Œåˆå¦‚ä½•è·å–å…¶ä¸­çš„å†…å®¹ã€‚<code>ptrace</code> æ€»ç®—æ˜¯æ´¾ä¸Šç”¨åœºäº†ã€‚ä¹‹å‰åœ¨é˜…è¯»å†…æ ¸æºç çš„æ—¶å€™ï¼Œä»»åŠ¡æ•°æ®ç»“æ„ <code>struct task</code> ä¸“é—¨ä¸ºæ­¤é¢„ç•™äº†ä¸€äº›å­—æ®µæ¥åŠ ä»¥æè¿°ï¼Œä½†å§‹ç»ˆæ‰¾ä¸åˆ°å…¶ç”¨é€”ã€‚ç°åœ¨æ€»ç®—å¯¹å…¶æœ‰äº†åˆæ­¥çš„äº†è§£ã€‚</p>\n<p>ä¸€èˆ¬æ¥è¯´ï¼Œè¿›ç¨‹å½¼æ­¤ä¹‹é—´åº”è¯¥ç›¸äº’ç‹¬ç«‹ï¼Œè™½ç„¶è¿è¡Œåœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œä½†åº”è¯¥æ˜¯ç›¸äº’é—´ä¸çŸ¥é“å…¶ä»–è¿›ç¨‹çš„å­˜åœ¨ã€‚é‚£åˆå¦‚ä½•èƒ½å¤Ÿé€šè¿‡ä¸€ä¸ªè¿›ç¨‹çš„ä»£ç æ¥è·å–å¦ä¸€ä¸ªè¿›ç¨‹çš„å †æ ˆæ•°æ®å‘¢ï¼Ÿ<code>ptrace</code> æä¾›çš„å°±æ˜¯è¿™ä¹ˆä¸€ç§å¯èƒ½æ€§ã€‚é€šè¿‡ <code>PTRACE_ATTACH</code> å’Œ <code>PTRACE_DETACH</code>ï¼ŒAè¿›ç¨‹ä¼šä½¿å¾—ç›®æ ‡è¿›ç¨‹Bé™·å…¥SleepingçŠ¶æ€ï¼Œè€Œç­‰å¾…Aç»§ç»­é€šè¿‡å…¶ä»–å‘½ä»¤æ¥è·å–å…¶æ•°æ®ã€‚è‡³äºä¸ºä»€ä¹ˆä¼šæ˜¯é™·å…¥Sleepingå‘¢ï¼Ÿä¸€æ—¦Bè¿›ç¨‹çš„åœ¨è¿è¡Œï¼Œæ•°æ®ç­‰éšæ—¶å¯èƒ½æ”¹å˜ï¼Œæ˜¾ç„¶ä¸é€‚åˆè¯»å–æ•°æ®å•Šã€‚</p>\n<p>å¦‚ä½•è¯»å–ï¼Ÿ<code>PTRACE_PEEKTEXT</code> å°±æ˜¯è¿™æ ·ä¸€ä¸ªå®ç°è¿›ç¨‹é—´äº¤äº’çš„å¥½å·¥å…·ã€‚</p>\n<pre><code class="language-c">void attach()\n{\n    if (ptrace(PTRACE_ATTACH, options.pid, NULL, NULL) == -1)\n    {\n        fprintf(stderr, "ptract attach failed. %s(errno: %d)\\n", strerror(errno), errno);\n        exit(0);\n    }\n    fprintf(stderr, "attach to %d success!\\n", options.pid);\n    wait(NULL);\n}\n\nvoid peek()\n{\n    char maps[17];\n    sprintf(maps, "/proc/%d/maps", options.pid);\n    FILE *fd = fopen(maps, "r");\n    if (fd == NULL)\n    {\n        fprintf(stderr, "open /proc/%d/maps failed. %s(errno: %d)\\n", strerror(errno), errno);\n        exit(0);\n    }\n\n    struct map *map = (struct map *) malloc(sizeof(struct map *));\n\n    long word;\n    while (fscanf(fd, "%llx-%llx %s %lx %*s %*s%*[^\\n]", &#x26;map->start_addr, &#x26;map->end_addr, map->op_flag, &#x26;map->offset) != EOF)\n    {\n        if (map->op_flag[0] == \'-\')\n            continue;\n        fprintf(stderr, "peek from [%llx-%llx]\\n", map->start_addr, map->end_addr);\n        long mem_len = map->end_addr - map->start_addr;\n        char *data = malloc(mem_len + 1);\n        for (long cursor = map->start_addr;cursor &#x3C; map->end_addr;cursor += sizeof(long))\n        {\n            if ((word = ptrace(PTRACE_PEEKTEXT, options.pid, cursor, NULL)) == -1 &#x26;&#x26; errno)\n            {\n                fprintf(stderr, "peek failed. %s(errno: %d)\\n", strerror(errno), errno);\n                free(data);\n                exit(0);\n            }\n            memcpy(data+cursor-map->start_addr, &#x26;word, sizeof(word));\n        }\n        dump(data, mem_len);\n\n        free(data);\n    }\n\n    free(map);\n}\n\nvoid detach()\n{\n    if (ptrace(PTRACE_DETACH, options.pid, NULL, NULL) == -1)\n    {\n        fprintf("ptract detach failed. %s(errno: %d)\\n", strerror(errno), errno);\n        exit(0);\n    }\n    fprintf(stderr, "detach from %d success!", options.pid);\n}\n\nint main(int argc, char **argv)\n{\n    // ...\n\n    attach();\n    peek();\n    detach();\n}\n</code></pre>\n<p>æ­¤å¤„çš„ä»£ç ç‰‡æ®µå°±èƒ½å®Œæˆdumpå †æ ˆçš„å·¥ä½œäº†ï¼ˆå½“ç„¶ï¼Œç”±äºæ²¡æœ‰å¯¹å…¶å®ƒå†…å®¹è¿›è¡Œå¤„ç†ï¼ŒåŒæ—¶ä¼šdumpä¸‹ELFæ•°æ®ç­‰ï¼‰ã€‚<a href="https://github.com/DorMOUSE-None/ffDump">å®Œæ•´ä»£ç </a></p>\n<h2>å°ç»“</h2>\n<p>å½“ç„¶ï¼Œä¹‹åæ‰å‘ç° GDB çš„å®ç°å€Ÿç”¨çš„ä¹Ÿæ­£æ˜¯è¿™æ ·ä¸€å¥—æœºåˆ¶ã€‚åŒæ—¶ä¹Ÿæ„å‘³ç€ä¸Šé¢è¿™æ®µä»£ç çš„å®ç°åœ¨ GDB ä¸­æœ‰ç°æˆçš„å·¥å…·äº†:&#x3C;</p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},nYHc:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<h2>JVM è¿è¡Œæ—¶æ•°æ®åŒº</h2>\n<p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1ft5osi6it1j31kw0ql78e.jpg"></p>\n<h3>PCå¯„å­˜å™¨</h3>\n<p>ä¸æ“ä½œç³»ç»Ÿä¸­çš„PCå¯„å­˜å™¨åŠŸèƒ½åŸºæœ¬ä¸€è‡´ã€‚æ¯•ç«Ÿ JVM å»ºç«‹çš„åˆè¡·å°±æ˜¯æ¨¡æ‹Ÿä¸€å°æœºå™¨ã€‚\næŒ‡å‘å­˜å‚¨åœ¨<strong>æ–¹æ³•åŒº</strong>çš„å­—èŠ‚ç methods_infoéƒ¨åˆ†çš„å†…å­˜åœ°å€ã€‚</p>\n<h3>è™šæ‹Ÿæœºæ ˆ</h3>\n<p><strong>è™šæ‹Ÿæœºæ ˆ</strong>ç”¨äºå­˜å‚¨<strong>æ ˆå¸§</strong></p>\n<h3>æœ¬åœ°æ–¹æ³•æ ˆ</h3>\n<p>ç”¨äºæ”¯æŒ native æ–¹æ³•çš„æ‰§è¡Œ</p>\n<h3>æ ˆå¸§</h3>\n<p>å­˜å‚¨åœ¨<strong>è™šæ‹Ÿæœºæ ˆ</strong>ä¸­ï¼Œä¸»è¦åŒ…æ‹¬<strong>å±€éƒ¨å˜é‡è¡¨</strong>å’Œ<strong>æ“ä½œæ•°æ ˆ</strong>(åˆç§°<strong>å½“å‰æ ˆå¸§çš„æ“ä½œæ•°æ ˆ</strong>)ä»¥åŠ<strong>è¿è¡Œæ—¶å¸¸é‡æ± çš„å¼•ç”¨</strong>ã€‚</p>\n<p><em>ä»ç„¶æœ‰å¿…è¦åŒºåˆ«ä¸¤ä¸ªæ¦‚å¿µ: æ“ä½œæ•° &#x26; æŒ‡ä»¤</em>\n<em>æŒ‡ä»¤æŒ‡ä½¿æ“ä½œæ•°è¿›è¡Œç›¸å…³æ“ä½œçš„åŸºæœ¬å‘½ä»¤</em>\n<em>æ“ä½œæ•°é€šå¸¸æŒ‡æ•´æ•°ã€æµ®ç‚¹æ•°ä»¥åŠç±»å‹å¼•ç”¨ç­‰</em></p>\n<h3>æ–¹æ³•åŒº</h3>\n<p><strong>æ–¹æ³•åŒº</strong>æ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„ä¸€å—åŒºåŸŸï¼Œä¸»è¦ç”¨äºå­˜å‚¨I/Oæ“ä½œä¸­è¯»å…¥çš„ç±»/æ¥å£çš„å­—èŠ‚ç (ClassFile æ–‡ä»¶)\nåŒ…æ‹¬æœ‰ constant_pool, field_info, method_info, attribute_info ç­‰</p>\n<h3>Javaå †</h3>\n<p>ç”¨äºå­˜å‚¨å„ç§ç±»çš„å®ä¾‹å¯¹è±¡</p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},tpF5:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<h2>é…ç½®å‚æ•°</h2>\n<p><strong>å‘½ä»¤è¡Œä½¿ç”¨</strong></p>\n<p>åœ¨ java å¯åŠ¨å‘½ä»¤ä¸­æ·»åŠ å‚æ•°é…ç½®é¡¹ <code>-Dcglib.debugLocation=&#x3C;Custom Path></code></p>\n<p><strong>ç¼–ç å®ç°</strong></p>\n<p>åœ¨æ‰§è¡Œ CGlib è·å–æ–°ç”Ÿæˆç±»ä¹‹å‰ï¼Œè°ƒç”¨ <code>System.setProperty("cglib.debugLocation", &#x3C;Custom Path>)</code></p>\n<h2>å¦‚ä½•æ¸¸åˆƒæœ‰ä½™åœ° Debug æºæ‚ CGlib ç”Ÿæˆç±»çš„è°ƒç”¨é“¾</h2>\n<p>ç»å¸¸ä¼šé‡åˆ°ï¼Œé¡¹ç›®ä¸­ä¸ç»æ„é—´å°±é‡åˆ°äº† CGlib ä»£ç†ï¼Œç„¶åå¯¹è°ƒç”¨é“¾çš„ Debug å°±å¼€å§‹å‡ºç°æ–­å±‚ã€‚ç»§è€Œï¼Œå¯¹å¯¹è±¡æˆ–å®ä¾‹å˜é‡çš„è·Ÿè¸ªå°±æ˜¾å¾—ä¸€å¤´é›¾æ°´ã€‚</p>\n<p>ç‰¹åˆ«æ˜¯åœ¨ä¸äº†è§£ç”Ÿæˆç±»åˆ°åº•æ˜¯å¢å¼ºäº†é‚£äº›å†…å®¹çš„æ—¶å€™ï¼Œç”šè‡³å¯èƒ½è¿è°ƒç”¨é“¾éƒ½è·Ÿè¸ªä¸ä¸‹å»äº† T_T ã€‚</p>\n<p>é€šè¿‡ <strong>é…ç½®å‚æ•°</strong> ä¸€èŠ‚çš„å†…å®¹ï¼Œä½ å°±å¯ä»¥åœ¨ä½ ç†æƒ³çš„ç›®å½• <code>&#x3C;Custom Path></code> ä¸‹çœ‹åˆ°<strong>æ‰€è°“é»‘ç›’</strong>ä¸­ç”Ÿæˆç±»çš„å®Œæˆå†…å®¹äº†ã€‚</p>\n<p>ä¸‹é¢çš„å†…å®¹ï¼Œå°†ç®€å•åœ°ä»‹ç»å¦‚ä½•é…åˆ CGlib ç”Ÿæˆç±»çš„å†…å®¹å®ç°: ä¿è¯ Debug çš„æ¯ä¸€æ­¥éª¤å¯è§; ä¿è¯ Debug çš„è¿‡ç¨‹ä¸ä¼šå‡ºç°<em>é»‘ç›’</em>ã€‚</p>\n<h3>ç¡®å®š <code>&#x3C;Custom Path></code> ä¸‹å“ªä¸ªæ–‡ä»¶æ˜¯åŸæœ‰ Java ç±»çš„ç”Ÿæˆç±»</h3>\n<pre><code class="language-java">public String getClassName(String prefix, String source, Object key, Predicate names) {\n    if (prefix == null) {\n        prefix = "net.sf.cglib.empty.Object";\n    } else if (prefix.startsWith("java")) {\n        prefix = "$" + prefix;\n    }\n    String base =\n        prefix + "$$" +\n        source.substring(source.lastIndexOf(\'.\') + 1) +\n        getTag() + "$$" +\n        Integer.toHexString(STRESS_HASH_CODE ? 0 : key.hashCode());\n    String attempt = base;\n    int index = 2;\n    while (names.evaluate(attempt))\n        attempt = base + "_" + index++;\n    return attempt;\n}\n</code></pre>\n<p>CGlib é»˜è®¤çš„ç±»åç”Ÿæˆç­–ç•¥ä¸‹ï¼Œç”Ÿæˆç±»çš„å…¨é™å®šåå°†ç»“åˆåŸæ–‡ä»¶çš„å…¨é™å®šåå†³å®šã€‚</p>\n<p>é€šå¸¸å‘½åå¦‚ä¸‹: <code>&#x3C;åŸ Java ç±»å…¨é™å®šå>$$&#x3C;ç±»ä¼¼ EnhancerByCGlib>$$&#x3C;ç”Ÿæˆç±»æ ¸å¿ƒå†…å®¹çš„ hash å€¼>_&#x3C;index[å¯èƒ½å­˜åœ¨]></code></p>\n<p>ä¾‹å¦‚: åŸæœ‰ Java ç±»å…¨é™å®šåä¸º me.fangfeng.Test ï¼Œåˆ™ç”Ÿæˆç±»åå¯èƒ½ä¸º <code>me.fangfeng.Test$$EnhancerByCGlib$$ab1203aa</code></p>\n<p>å½“ç„¶ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¼šå­˜åœ¨ä¸€ä¸ªç±»åå½¢å¦‚ <code>me.fangfeng.Test$$FastClassBySpring$$...</code> çš„ç±»ï¼Œè¿™æ˜¯ä½œä¸ºç”Ÿæˆç±» <code>me.fangfeng.Test$$EnhancerByCGlib$$ab1203aa</code> çš„è¾…åŠ©ç±»æ¥ä½¿ç”¨ã€‚</p>\n<h3>ç®€å•äº†è§£ç”Ÿæˆç±»ä¸‹çš„è°ƒç”¨å…³ç³»</h3>\n<p>Java ä»£ç è§¦å‘è¢«å¢å¼ºçš„ç±»ï¼Œå°†é¦–å…ˆè°ƒç”¨ç”Ÿæˆç±»ã€‚ä½†æ˜¯ï¼Œè¿™æ˜¯æ²¡åŠæ³•è¿›è¡Œ Debug çš„ï¼Œå› ä¸ºè¿™ä¸ªç”Ÿæˆç±»çš„å­—èŠ‚ç ç¼ºå°‘ SourceFile å±æ€§ï¼ŒåŒæ—¶ç¼ºå°‘ LineNumberTable å±æ€§ã€‚</p>\n<p>ä½†æ˜¯ï¼Œè¿™å¹¶ä¸å½±å“å¯¹è°ƒç”¨é“¾çš„è·Ÿè¸ªã€‚</p>\n<p>CGlib çš„å¢å¼ºï¼Œæ‰€æœ‰çš„å¢å¼ºé€»è¾‘éƒ½æ˜¯ä»¥ Callback å®ç°ç±»çš„å½¢å¼æ¥æä¾›çš„ã€‚åŒæ—¶åœ¨ CGlib ç”Ÿæˆç±»ä¸­ä¹Ÿæœ‰ Callback çš„å®ä¾‹å˜é‡æ¥æŒæœ‰è¿™äº›æ³¨å…¥çš„ Callback ã€‚</p>\n<p><strong>åŸæœ‰ Java ç±»</strong></p>\n<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1ft8e7kr7qvj30sc0j0wh4.jpg" alt="LogonService.java"></p>\n<p><strong>å¯¹åº”çš„ç”Ÿæˆç±»</strong></p>\n<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8e9ww4hqj31hg0oojzv.jpg"></p>\n<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8eanb6c9j31j00lgn1e.jpg"></p>\n<p><strong>è·Ÿè¸ª LogonService.addLogon(String var1) æ¼”ç¤º</strong></p>\n<p>å½“å‰ LogonService çš„ç”Ÿæˆç±»å…¨é™å®šåä¸ºme.fangfeng.transactionBugs.LogonService$$EnhancerBySpringCGLIB$$bfc1dc3.class; ä»¥ä¸‹ç®€ç§°ä¸º LogonSerivce$$bfc1dc3 </p>\n<ol>\n<li>\n<p>é¦–å…ˆï¼Œé…ç½® <code>cglib.debugLocation</code> å‚æ•°ï¼Œå€¼ = é¡¹ç›®ç”Ÿæˆçš„ .class è·¯å¾„</p>\n</li>\n<li>\n<p>æ— æ–­ç‚¹ç›´æ¥è¿è¡Œä¸€æ¬¡éœ€è¦å¤„ç†çš„é€»è¾‘</p>\n</li>\n<li>\n<p>æ‰¾åˆ° LogonSerive$$bfc1dc3.class, éšæ„æ‰“ä¸Šä¸€ä¸ªçœ‹ä¼¼æœ‰æ•ˆçš„æ–­ç‚¹</p>\n</li>\n<li>\n<p>åœ¨å„å¤„æ‰“ä¸Šå¿…è¦çš„æ–­ç‚¹ï¼Œå¼€å§‹è¿›è¡ŒçœŸæ­£çš„è°ƒè¯•å·¥ä½œ</p>\n</li>\n<li>\n<p>ä»£ç æ‰§è¡Œåˆ° LogonService$$bfc1dc3.class, è™½ç„¶æ²¡æœ‰çœŸæ­£è¿›å…¥æ–­ç‚¹ä½ç½®, ä½†æ˜¯å¯ä»¥çœ‹åˆ°è¿™ä¸ª LogonService$$bfc1dc3 å®ä¾‹çš„å®ä¾‹å˜é‡ä¿¡æ¯</p>\n</li>\n</ol>\n<p><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1ft8eq1be61j319w0bwtde.jpg"></p>\n<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8egtg1naj31ji0fmgp2.jpg"></p>\n<p>æ¯”ç…§ç”Ÿæˆç±»ä»£ç ä¸­ addLogon(String var1) æ–¹æ³•ä½“çš„å†…å®¹ä»¥åŠå±•ç¤ºçš„å®ä¾‹å˜é‡ä¿¡æ¯ã€‚å¯ä»¥çœ‹åˆ°ç”Ÿæˆç±»è°ƒç”¨çš„ Callback å®ä¾‹æ˜¯ <code>CGLIB$CALLBACK_0</code>\nç±»å‹æ˜¯ CglibAopProxy çš„é™æ€å†…éƒ¨ç§æœ‰ç±» DynamicAdvisedInterceptor ã€‚</p>\n<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1ft8eu91oscj31gq0ayju5.jpg"></p>\n<p>åœ¨ intercept(...) ä¸Šæ‰“ä¸ªæ–­ç‚¹ï¼Œè·³è¿‡ç”Ÿæˆç±» addLogon(String var1) æ–¹æ³•çš„ä¸‹ä¸€ä¸ªè°ƒç”¨æ–¹æ³•å°±æ˜¯ intercept(...) </p>\n<p><strong>è€Œä¸”äº‹å®ä¸Šï¼ŒCGlib ç”Ÿæˆç±»çš„å†…å®¹åŸºæœ¬ä¹Ÿå°±æ˜¯å¯¹è°ƒç”¨æ–¹æ³•è¿›è¡Œçš„ä¸€ç§è½¬å‘</strong></p>\n<ol start="6">\n<li>ç»§ç»­ Debug ï¼Œå¯¹äºç”Ÿæˆç±»çš„å†…å®¹ï¼Œäººè‚‰äº†è§£å¹¶å®šä½åˆ°è§¦å‘çš„ Callback å®ä¾‹æˆ–è€… super.Xxx() æ–¹æ³•ã€‚</li>\n</ol>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},wCSB:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:"<p>è¯´å®è¯æ­¤å‰å¯¹ SQL æ³¨å…¥çš„ç†è§£ä»…ä»…åªæ˜¯çš®æ¯›ã€‚å½“ç„¶ï¼Œç›®å‰ä¹Ÿæ˜¯ï¼Œåªæ˜¯æœ‰äº†ä¸€å®šç¨‹åº¦çš„ç†è§£ã€‚</p>\n<p>æœ€è¿‘å¥½åƒå·¥å…·ç”¨å¾—æœ‰äº›è¿‡å¤´äº†ï¼Œéœ€è¦åœä¸‹æ¥æ•´ç†ä¸‹å·¥å…·çš„å®ç°åŸç†ã€‚</p>\n<p>æ›´å¥½åœ°ç†è§£äº†å·¥å…·å®ç°ï¼Œæ‰èƒ½æ›´åŠ å¿ƒå®‰ç†å¾—åœ°ä½¿ç”¨å·¥å…·ã€‚æ¯•ç«Ÿç­‰åˆ«äººæ€¼çš„æ—¶å€™ï¼Œè¿˜èƒ½å¤Ÿæ¯”è¾ƒå®‰å¿ƒåœ°å›é“: \"æˆ‘ç”¨ä¸ç”¨ç°æˆçš„å·¥å…·åªæ˜¯å–å†³äºæˆ‘æƒ³ä¸æƒ³è‡ªå·±å†å†™ä¸€å¥—\"</p>\n<p>å½“ç„¶ï¼Œæ¯•ç«Ÿæˆç†Ÿçš„å·¥å…·æœ‰æ›´å¤šçš„ä¼˜åŒ–ï¼Œè¿™å°±ä¸æ˜¯çŸ­æ—¶é—´å†…æˆ‘æƒ³ä¸æƒ³è‡ªå·±å†™çš„é—®é¢˜äº†ï¼Œå“ˆå“ˆã€‚</p>\n<h2>æ¦‚è¦</h2>\n<p>SQL æ³¨å…¥æ¼æ´ç©¶ç«Ÿä¼šäº§ç”Ÿæ€ä¹ˆæ ·çš„å±å®³æ€§ï¼Œä»…ä»…åªæ˜¯ç»•è¿‡æŸäº›ç™»å½•è´¦å·å¯†ç çš„éªŒè¯? åªæ˜¯ç»•è¿‡æŸäº›è®¿é—®é™åˆ¶å®ç°ç‰¹æƒå†…å®¹çš„è®¿é—®?</p>\n<p>æ­¤å‰æˆ‘çš„è®¤è¯†ä¹Ÿä»…ä»…åªæ˜¯åœç•™åœ¨è¿™é‡Œã€‚å¯è°æ›¾æƒ³ï¼ŒSQL SELECT è¯­å¥çœŸçš„æ˜¯åŠŸèƒ½å¼ºå¤§å•Šã€‚é€šè¿‡å„ç§å„æ ·çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œæœ€ç»ˆèƒ½è¾¾åˆ°çš„ç›®çš„ï¼Œå¯ä»¥è¯´æŠŠæ•´ä¸ªæ•°æ®åº“çš„å†…å®¹æ‹–ä¸‹æ¥ä¹Ÿä¸ä¸ºè¿‡ã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿæ˜¯é™å®šåœ¨æ²¡æœ‰å®ç°åˆ†åº“åˆ†è¡¨ï¼Œæ•°æ®åº“æŸ¥è¯¢è´¦å·çš„æƒé™è¿‡å¤§çš„å‰æä¸‹ã€‚</p>\n<p>ä¸è¿‡ï¼Œè¿™ä¹Ÿå°±å¤Ÿäº†ã€‚åªæœ‰çœŸæ­£è®¤è¯†åˆ°é—®é¢˜çš„ä¸¥é‡æ€§ï¼Œæœ€ç»ˆæ‰ä¼šæƒ³ç€å»åšå‡ºä¸€äº›æ”¹å–„ã€‚</p>\n<h2>SQL æ³¨å…¥æŠ€æœ¯</h2>\n<h3>åŸºäºå¸ƒå°”çš„æ³¨å…¥</h3>\n<p>æœ€æ—©æ¥è§¦åˆ° SQL æ³¨å…¥é—®é¢˜ï¼Œè¿˜æ˜¯ä¸¤ä¸ªæœˆå‰ã€‚æ“ä½œçš„å†…å®¹ä¹Ÿç›¸å½“ç®€å•ï¼ŒçŒœè§£æŸè´¦å·çš„å¯†ç ã€‚</p>\n<p>æŸæ¥å£æä¾›äº†æŸ¥è¯¢è´¦å·çš„åŠŸèƒ½ï¼Œåå°çš„æ‹¼æ¥ SQL å¯ä»¥ç®€å•ç†è§£æˆ <code>SELECT * FROM users WHERE username = '${}'</code> ã€‚å…¶ä¸­ <code>${}</code> å°±æ˜¯ç›´æ¥ä½¿ç”¨çš„æ¥å£è¯·æ±‚å‚æ•°ã€‚</p>\n<p>è€Œæ¥å£çš„è¯·æ±‚ç»“æœä¼šæ ¹æ® SQL æŸ¥è¯¢çš„ç»“æœï¼Œæœ‰æˆ–æ²¡æœ‰è®°å½•å‘ˆç°ä¸¤ä¸ªä¸åŒçš„é¡µé¢ã€‚</p>\n<p>è¿™ç®—æ˜¯æœ€ç®€å•å®¹æ˜“çš„ SQL æ³¨å…¥äº†ï¼Œä¹Ÿæ˜¯å‡­å€Ÿä¸ªäººèƒ½åŠ›ç›´æ¥èƒ½å¤Ÿæƒ³åˆ°æ³¨å…¥ç‚¹çš„é—®é¢˜äº†ã€‚</p>\n<p>æœ€å…ˆåšçš„å°±æ˜¯çŒœè§£å­˜å‚¨å¯†ç å­—æ®µçš„å­—æ®µåç©¶ç«Ÿæ˜¯ä»€ä¹ˆ? å¾ˆå¥½ï¼Œç¬¦åˆå¸¸ç†çš„è®¾è®¡ï¼Œç›´æ¥å°±æ˜¯ <code>passwd</code> ã€‚</p>\n<p>ä¸‹é¢å°±æ˜¯è‹¦åŠ›å·¥ä½œï¼Œåˆ©ç”¨ SQL LIKE æ“ä½œç¬¦ï¼Œé€ä¸€å»çŒœæ¯ä¸€ä½ã€‚<code>${}</code> çš„æ³¨å…¥å†…å®¹å°±ç±»ä¼¼ <code>admin' AND passwd LIKE '?%</code> è¿™é‡Œçš„é—®å·å°±æ˜¯é€ä¸€çŒœè§£çš„å†…å®¹(1-9a-zA-Z + ç‰¹æ®Šç¬¦å·)</p>\n<p>è‡³äºä¸ºä»€ä¹ˆåˆ©ç”¨ LIKE æ“ä½œç¬¦ï¼Œå¾ˆæ˜ç¡®ï¼Œå‡å°‘çŒœè§£çš„æ¬¡æ•°ã€‚å¦åˆ™ï¼Œåœ¨å¯†ç æœªçŸ¥çš„æƒ…å†µä¸‹ï¼Œå³ä½¿å…­ä½å¯†ç ä¹Ÿæœ‰çŒœè§£ç™¾ä¸‡æ¬¡ã€‚è€Œ LIKE æ“ä½œç¬¦èƒ½å°†çŒœè§£æ¬¡æ•°é™ä¸ºçº¿æ€§ï¼Œ<code>å¯†ç é•¿åº¦ * å­—ç¬¦é›†æ•°</code> æ¬¡</p>\n<p>è¿™é‡Œä»…ä»…ç”¨äº† <code>AND</code>ï¼Œä½†ç†Ÿæ‚‰äº†ä¸€ä¸ªï¼Œå…¶å®ƒå°±åŸºæœ¬ç±»ä¼¼äº†ã€‚</p>\n<p>å¦‚æœç™»å½•ä¹Ÿèƒ½å¤Ÿæ³¨å…¥ï¼Œè®¤è¯ SQL ç±»ä¼¼ <code>SELECT * FROM users WHERE username = '${}' AND passwd = '${}'</code>ï¼Œé‚£ä¹ˆç›´æ¥åœ¨ç¬¬ä¸€ä¸ª <code>${}</code> å¤„æ³¨å…¥ <code>admin' OR 1=1; --</code></p>\n<h3>åŸºäºæ—¶é—´çš„æ³¨å…¥</h3>\n<p>ç»å¤§å¤šæ•°æ—¶å€™ï¼Œæ³¨å…¥ç»å¯¹æ²¡æœ‰è¿™ä¹ˆç®€å•ã€‚ä¹Ÿè®¸æ³¨å…¥ç‚¹èƒŒåçš„æ‹¼æ¥ SQL å¹¶ä¸å¯¹è¿”å›å€¼äº§ç”Ÿå½±å“ã€‚ä¾‹å¦‚ä»…ä»…åªæ˜¯ä¸ºäº†ä» DB æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶æ‰“ä¸€æ¡æ—¥å¿—ï¼Œè¿”å›çš„æ°¸è¿œæ˜¯é™æ€æ—¥å¿—ï¼ˆå½“ç„¶ï¼Œæˆ‘çŸ¥é“è¿™ä¸ªä¾‹å­ä¸æ°å½“ï¼Œæ— å¥ˆç›®å‰åªèƒ½æƒ³åˆ°è¿™ä¸ªï¼‰ã€‚</p>\n<p>æ—¢ç„¶æ‹¼æ¥ SQL æ€»æ˜¯å­˜åœ¨ï¼Œä½†æ²¡æ³•ç»™æˆ‘ä»¬ä¸€ä¸ªç›´è§‚çš„æ³¨å…¥æˆåŠŸ OR å¤±è´¥çš„æç¤ºã€‚é‚£ä¹ˆï¼Œæ—¶é—´å°±æˆäº†ä¸€ä¸ªæœ€å¥½çš„åˆ¤æ–­ã€‚æ¯•ç«Ÿæ˜¯é˜»å¡å¼çš„æ‰§è¡Œã€‚</p>\n<p>è¿˜æ˜¯ä»¥ <code>SELECT * FROM users WHERE username = '${}'</code> ä¸ºä¾‹ï¼Œä½¿ç”¨ç±»ä¼¼ <code>admin' AND IF(passwd LIKE '5%', SLEEP(5), 1);--</code> çš„ PAYLOAD ï¼Œå½“æ»¡è¶³ <code>passwd</code> ä»¥ 5 å¼€å§‹æ—¶ï¼Œåˆ™ IF åˆ¤æ–­è¿›å…¥ <code>SLEEP(5)</code> ï¼Œæ ¹æ®ç½‘é¡µçš„å“åº”æ—¶é•¿å°±å¯ä»¥è¿›è¡Œç›¸åº”çš„åˆ¤æ–­ã€‚</p>\n<h3>åŸºäºæŠ¥é”™çš„æ³¨å…¥</h3>\n<p>è¿™åº”è¯¥ä¹Ÿç®—ä¸€ç§æ¯”è¾ƒå®¹æ˜“è‡ªåŠ¨åŒ–çš„æ³¨å…¥æ–¹å¼äº†ã€‚å…¶å®åœ¨çŒœè§£å­˜å‚¨å¯†ç å­—æ®µçš„å­—æ®µåæ—¶ï¼Œå‰é¢ä¹Ÿæ˜¯è¿™æ ·ç”¨çš„ã€‚</p>\n<pre><code class=\"language-sql\">> SELECT * FROM users WHERE password ='1';\nERROR 1054 (42S22): Unknown column 'password' in 'where clause'\n</code></pre>\n<p>å¦‚æœç¨‹åºä¸åšä»»ä½•å¤„ç†ï¼Œå¯¹ SQL é”™è¯¯ç›´æ¥æŠ›å‡ºï¼Œé‚£ä¹ˆï¼Œé€šè¿‡è¿™ä¸ªå°±èƒ½è·å¾—ç›¸å½“å¤šçš„ä¿¡æ¯ã€‚</p>\n<p>ç”±äºè¿™éƒ¨åˆ†æ¥è§¦ä¸æ·±ï¼Œä»…ä»…ç»™å‡º sqlmap æçš„ PAYLOAD</p>\n<pre><code>AND (SELECT [RANDNUM] FROM(SELECT COUNT(*),CONCAT('[DELIMITER_START]',([QUERY]),'[DELIMITER_STOP]',FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)\n</code></pre>\n<p>å¾ˆæ ‡å‡†çš„ PAYLOADï¼Œè€Œä¸”å®Œå…¨å¯ä»¥ã€‚<code>INFORMATION_SCHEMA</code> åº“çš„è¡¨å¯¹æ‰€æœ‰ç”¨æˆ·éƒ½å¯æŸ¥ï¼Œå› æ­¤ä¸å­˜åœ¨æˆæƒçš„é—®é¢˜ã€‚è€Œä¸”è¡¨ä¸­æ•°æ®è‡³å°‘å¤§äºç­‰äº 3 æ¡ã€‚</p>\n<p>è¿™ä¸ª PAYLOAD ä¸€å®šå¯¼è‡´æŠ¥é”™çš„ä¸»å› ï¼Œå°±æ˜¯å¯¹ <code>RAND()</code> ä¸ <code>GROUP BY</code> çš„é…åˆåº”ç”¨ã€‚</p>\n<blockquote>\n<p>Use of a column with RAND() values in an ORDER BY or GROUP BY clause may yield unexpected results because for either clause a RAND() expression can be evaluated multiple times for the same row, each time returning a different result. If the goal is to retrieve rows in random order, you can use a statement like this:</p>\n</blockquote>\n<p>è€ŒçœŸæ­£æƒ³è¦å¾—åˆ°çš„å†…å®¹ï¼Œé€šè¿‡ <code>CONCAT('[DELIMITER_START]',([QUERY]),'[DELIMITER_STOP]',FLOOR(RAND(0)*2))x</code> å¾—åˆ°ï¼Œ<code>[QUERY]</code> å°±æ˜¯çœŸæ­£æƒ³è¦æ³¨å…¥çš„å®Œæ•´SQLä¸²ã€‚</p>\n<p>è€Œè¿™é‡Œçš„ <code>DELIMITER_START</code> <code>DELIMITER_STOP</code> ä½œä¸ºç•Œå®šç¬¦ï¼Œå¸®åŠ©ç¨‹åºæå– <code>[QUERY]</code> å¾—åˆ°çš„ç»“æœã€‚å¦åˆ™ï¼Œç›´æ¥å¯¹è¯·æ±‚è¿”å›çš„ç»“æœè¿›è¡Œè¿‡æ»¤å¯çœŸæ˜¯å¤ªå›°éš¾äº†ã€‚</p>\n<h3>è”åˆæŸ¥è¯¢æ³¨å…¥</h3>\n<p>è”åˆæŸ¥è¯¢ï¼Œåº”è¯¥ç®—æ˜¯æœ€é¡¾åæ€ä¹‰çš„æ³¨å…¥æ–¹å¼ã€‚ä½¿ç”¨ <code>UNION</code> åœ¨åŸ SQL å·²ç»é™å®šäº†æŸ¥è¯¢è¡¨çš„å‰æä¸‹ï¼Œè·å¾—æ•°æ®åº“å…¶å®ƒåº“è¡¨çš„ä¿¡æ¯ã€‚</p>\n<p>LIKE: <code>1' UNION SELECT * FROM users;--</code> è¿™æ ·çš„ PAYLOADã€‚</p>\n<h3>å †æŸ¥è¯¢æ³¨å…¥</h3>\n<p>æˆ‘æƒ³è¿™åº”è¯¥æ˜¯æœ€è®©äººæ‘¸ä¸ç€å¤´è„‘çš„å‘½åæ–¹å¼äº†ã€‚</p>\n<p>å½¢è±¡åŒ–çš„ï¼Œæˆ‘ä»¬åˆ©ç”¨ PAYLOAD æ¥è¿›è¡Œè¯´æ˜ã€‚<code>1'; INSERT INTO users (user, passwd) VALUES ('aaa', 'aaa');--</code></p>\n<p>çœ‹èµ·æ¥å’Œ UNION æŒºåƒçš„å“ˆï¼Œéƒ½æ˜¯è¡¥å……ä¸Šä¸€ä¸ª OR å¤šä¸ª SQL ã€‚å½“ç„¶ï¼Œä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼Œå¦åˆ™ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·ä¸€ç§æŠ€æœ¯å‘¢ã€‚</p>\n<p>æœ€å¤§çš„åŒºåˆ«ï¼Œå°±æ˜¯å †æŸ¥è¯¢æ³¨å…¥èƒ½å¤Ÿå®Œæˆ <code>UPDATE</code>, <code>INSERT</code>, <code>DELETE</code> ç­‰æ“ä½œï¼Œæ¯•ç«Ÿï¼ŒUNION è”åˆçš„åªèƒ½æ˜¯ä½œä¸ºæŸ¥è¯¢äº†ï¼ˆå¯èƒ½è¯´æ³•ä¸å¤ªæ°å½“ï¼Œä½†å§‘ä¸”è¿™æ ·å§ï¼‰</p>\n<h3>å¦ç±»æ³¨å…¥</h3>\n<p>ä¹‹å‰çš„å‡ ç§ï¼Œæˆ‘ä»¬éƒ½æ˜¯åˆ©ç”¨äº† <code>SELECT</code> å®Œæˆçš„æ³¨å…¥ï¼Œé‚£ä¹ˆå¯¹äº <code>INSERT</code>, <code>UPDATE</code> ä¹‹ç±»çš„è¯­å¥æ˜¯å¦æœ‰æ³¨å…¥çš„å¯èƒ½å‘¢ã€‚å½“ç„¶ä¹Ÿæ˜¯å­˜åœ¨å¯èƒ½çš„ã€‚</p>\n<p>ä¸è¿‡ï¼Œç²¾åŠ›æœ‰é™ï¼Œè€Œä¸”ç›®å‰çœ‹æ¥ä¹Ÿä¸éœ€è¦åšåˆ°è¿™ä¸€æ­¥ã€‚æš‚æ—¶æŒ–ä¸ªå‘å§ã€‚ä¸å¡«</p>\n<h2>SQLMAP</h2>\n<p>ç®€å•çš„äº†è§£äº†å‡ ç§æ³¨å…¥åŸç†ä¹‹åï¼Œè¿˜æ˜¯è¦çœ‹çœ‹ SQL æ³¨å…¥ç¥å™¨çš„â€”â€”<code>SQLMAP</code></p>\n<p>ä¹Ÿç®—æ˜¯å°è¯•äº†å¥½ä¹…æ‰çœŸæ­£äº†è§£å®ƒçš„å¼ºå¤§ä¹‹å¤„ã€‚æ­¤å¤„å¼ºçƒˆæ¨è DVWAï¼Œ<code>Damn Vulnerable Web Application</code>ï¼Œä¸€ä¸ªç”¨æ¥åˆæ³•æ”»å‡»çš„å·¥å…·ã€‚</p>\n<p>éƒ¨ç½²æ–¹å¼ä¹Ÿæ˜¯å¼€ç®±å¯ç”¨ï¼Œåªè¦æœ‰ dockerï¼Œç›´æ¥ <code>docker run --rm -it -p 80:80 vulnerables/web-dvwa</code> å³å¯å®Œæˆéƒ¨ç½²ã€‚</p>\n<p>å¯¹äºå°† DVWA å®‰å…¨çº§åˆ«è®¾ç½®ä¸º low æ—¶ï¼Œä»…ä»…åªéœ€è¦æ‰§è¡Œä¸‹åˆ—å‘½ä»¤å°±å¯ä»¥è·å–åˆ° DB é‡Œå‡ ä¹å®Œæ•´çš„ä¿¡æ¯ã€‚</p>\n<pre><code class=\"language-sh\">$ sqlmap -u http://127.0.0.1/vulnerabilities/sqli/\\?id\\=1\\&#x26;Submit\\=Submit\\# --cookie=\"PHPSESSID=jhton35qahj78l3unjea9k2lf7;security=low\" -v 3 --banner\n</code></pre>\n<p>å½“ç„¶ï¼Œæ¢ä¸€ä¸‹ç›¸å…³è·å–çš„å†…å®¹ï¼Œä¾‹å¦‚æŠŠ <code>--banner</code> æ¢æˆ <code>--dump</code> ï¼Œæˆ‘ä»¬å€Ÿæ­¤æ¥ç®€å•çœ‹çœ‹ SQL æ³¨å…¥æ¼æ´çš„å¯æ€•ä¹‹å¤„</p>\n<pre><code class=\"language-sh\">[10:41:39] [INFO] using default dictionary\ndo you want to use common password suffixes? (slow!) [y/N]\n[10:41:40] [INFO] starting dictionary-based cracking (md5_generic_passwd)\n[10:41:40] [INFO] starting 8 processes\n[10:41:42] [INFO] cracked password 'abc123' for hash 'e99a18c428cb38d5f260853678922e03'\n[10:41:44] [INFO] cracked password 'charley' for hash '8d3533d75ae2c3966d7e0d4fcc69216b'\n[10:41:47] [INFO] cracked password 'letmein' for hash '0d107d09f5bbe40cade3de5c71e9e9b7'\n[10:41:49] [INFO] cracked password 'password' for hash '5f4dcc3b5aa765d61d8327deb882cf99'\n[10:41:53] [DEBUG] post-processing table dump\nDatabase: dvwa\nTable: users\n[5 entries]\n+---------+-----------------------------+---------+---------------------------------------------+-----------+------------+---------------------+--------------+\n| user_id | avatar                      | user    | password                                    | last_name | first_name | last_login          | failed_login |\n+---------+-----------------------------+---------+---------------------------------------------+-----------+------------+---------------------+--------------+\n| 1       | /hackable/users/admin.jpg   | admin   | 5f4dcc3b5aa765d61d8327deb882cf99 (password) | admin     | admin      | 2018-12-15 00:42:31 | 0            |\n| 2       | /hackable/users/gordonb.jpg | gordonb | e99a18c428cb38d5f260853678922e03 (abc123)   | Brown     | Gordon     | 2018-12-15 00:42:31 | 0            |\n| 3       | /hackable/users/1337.jpg    | 1337    | 8d3533d75ae2c3966d7e0d4fcc69216b (charley)  | Me        | Hack       | 2018-12-15 00:42:31 | 0            |\n| 4       | /hackable/users/pablo.jpg   | pablo   | 0d107d09f5bbe40cade3de5c71e9e9b7 (letmein)  | Picasso   | Pablo      | 2018-12-15 00:42:31 | 0            |\n| 5       | /hackable/users/smithy.jpg  | smithy  | 5f4dcc3b5aa765d61d8327deb882cf99 (password) | Smith     | Bob        | 2018-12-15 00:42:31 | 0            |\n+---------+-----------------------------+---------+---------------------------------------------+-----------+------------+---------------------+--------------+\n</code></pre>\n<p>è¿™é‡Œå°±å¯ä»¥çœ‹åˆ° <code>dvwa.users</code> è¡¨çš„å…¨éƒ¨å†…å®¹ï¼Œç”šè‡³è¿ç®€å•å¯†ç éƒ½å¸®ä½ å®Œæˆäº†çˆ†ç ´ã€‚</p>\n<p>æ›´å¤šå†…å®¹å¯ä»¥è‡ªè¡Œå°è¯•ï¼Œè¯´çœŸçš„ï¼Œè¿™ä¸ªå·¥å…·ç›¸å½“å¼ºå¤§ã€‚å¦‚æœä»…ä»…è¯´æˆ‘é’ˆå¯¹æŸå‹æ•°æ®åº“(ä¾‹å¦‚ MySQL)å®Œæˆè¯¸å¦‚åŸºäºæŠ¥é”™çš„æ³¨å…¥ï¼Œåœ¨ä¸è€ƒè™‘é²æ£’æ€§çš„æƒ…å†µä¸‹ï¼Œå®Œå…¨å¯ä»¥åšåˆ°ã€‚ä½†æ˜¯æ”¯æŒè¶…10ä½™ç§æ•°æ®åº“ï¼Œä¸”è‡ªåŠ¨å®Œæˆæ³¨å…¥çš„å…¨è¿‡ç¨‹...</p>\n<h2>é¢„ç¼–è¯‘ SQL</h2>\n<p>æäº†è¿™ä¹ˆå¤šï¼Œç©¶ç«Ÿ SQL æ³¨å…¥å°±ä¸èƒ½å¤Ÿé¢„é˜²å—? å½“ç„¶å¯ä»¥ï¼Œä¸ç„¶æ•´ä¸ªç½‘ç»œç¯å¢ƒä¸‹çš„WEBåº”ç”¨ä¸å¾—éƒ½å®Œè›‹äº†ã€‚æœ‰é‡œåº•æŠ½è–ªçš„å¤„ç†æ–¹å¼å—ï¼Œä¹Ÿæœ‰ã€‚</p>\n<p>é¢„ç¼–è¯‘ SQL å°±æ˜¯ä¸€ä¸ªè¶…çº§ OK çš„è§£å†³æ–¹æ¡ˆã€‚åŒæ—¶åœ¨ä½¿ç”¨ä¸Šä¹Ÿèƒ½å¤Ÿæ˜æ˜¾æå‡ DB æŸ¥è¯¢æ•ˆç‡</p>\n<p>æˆ‘ç›¸ä¿¡é¢„ç¼–è¯‘ SQL å¾ˆå¤šäººå†™è¿‡ï¼Œæ¯•ç«Ÿå€ŸåŠ©ä¾‹å¦‚ MyBatis æ¡†æ¶ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®ç° SQL é¢„ç¼–è¯‘è¯­å¥çš„ç¼–å†™ã€‚åŒæ—¶åœ¨æ±‚å­¦è¿‡ç¨‹ä¸­ä¼°è®¡ä¹Ÿéƒ½ç”¨è¿‡ Java åŸç”Ÿ JDBC çš„ <code>PreparedStatement</code> ã€‚</p>\n<p>é‚£ä¹ˆï¼Œä¸ MySQL äº¤äº’æ—¶çš„é¢„ç¼–è¯‘ SQL æ˜¯æ€ä¹ˆæ ·åœ°å¡«ä¸Šäº†å ä½ç¬¦å‘¢? å…ˆæ¥çœ‹çœ‹å†è¯´</p>\n<pre><code class=\"language-sql\">mysql> prepare {name} from 'SELECT * FROM users WHERE user=? AND passwd=?'; # è¿™é‡Œçš„ {name} å¯ä»¥è‡ªå®šä¹‰å‘½åï¼Œæ— éœ€ {}\n\nmysql> set @a='admin', @b='password';     # å£°æ˜å˜é‡ï¼Œå¹¶èµ‹å€¼\n\nmysql> execute {name} using @a, @b;     # æä¾›å˜é‡å¹¶æ‰§è¡Œé¢„ç¼–è¯‘ SQL\n</code></pre>\n<p>æˆ‘æƒ³çœ‹åˆ°è¿™é‡Œåº”è¯¥å°±åº”è¯¥èƒ½å¤Ÿæ˜ç™½äº†å§ï¼ŒMySQL å¯¹äºé¢„ç¼–è¯‘ SQL çš„æ¯ä¸€ä¸ªå ä½ç¬¦ï¼Œéƒ½å·²ç»è®¤å®šäº†æ˜¯å•ä¸€çš„å…ƒç´ ï¼Œä¹Ÿå°±ä¸å¯èƒ½å­˜åœ¨å…è®¸æ‰“ç ´å·²æœ‰é¢„ç¼–è¯‘ç»“æœçš„å†…å®¹äº†ã€‚</p>\n<p>å³ä½¿çœŸçš„æ³¨å…¥äº† <code>admin OR 1=1</code> ä¹‹ç±»çš„å†…å®¹ï¼Œä¹Ÿæ˜¯ä¼šè¢«è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å­—ç¬¦ä¸²ï¼Œç”¨æ¥æ›¿ä»£ <code>user</code> å­—æ®µæˆ– <code>passwd</code> å­—æ®µï¼Œæ ¹æœ¬ä¸å¯èƒ½é‡æ–°æ‹†è§£ã€‚</p>\n<pre><code class=\"language-plain\"> __                    __                  \n/ _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | '_ \\ / _` | |_ / _ \\ '_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                |___/                |___/ \n</code></pre>"}},xo5S:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>åœ¨ä¹‹å‰æè¿°è¿‡åŒ…æ‹¬ ASM, CGlib, Java Proxy çš„åŸºæœ¬å†…å®¹ä¹‹åï¼Œæœ¬æ–‡å°†å°±æ›´ä¸ºåŸºç¡€çš„ JVM æŒ‡ä»¤é›†è¿›è¡Œç®€å•è€Œæœ‰æ•ˆçš„ä»‹ç»ã€‚</p>\n<p>å½“ç„¶ï¼Œåœ¨å¼€å§‹æ­£æ–‡å‰ï¼Œè¯»è€…éœ€è¦äº†è§£åˆ°ï¼ŒJVM æŒ‡ä»¤é›†è¿™ç§ç±»ä¼¼äºæ±‡ç¼–çš„è§„èŒƒæ€§å†…å®¹ï¼ŒåŒ…å«ä¸€ç™¾å¤šä¸ªæŒ‡ä»¤ï¼Œè‹¥è¦æ±‚ä¸€ä¸€ä»‹ç»ã€‚\né‚£ä¹ˆï¼Œç›´æ¥é˜…è¯» <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html">å®˜æ–¹æ–‡æ¡£</a> ç»å¯¹æ˜¯æ¯”æœ¬æ–‡çš„å†…å®¹æ›´ä¸ºè¯¦å®ä¸”å‡†ç¡®ã€‚</p>\n<p>è¿™ç¯‡æ–‡æ¡£çš„ç›®çš„ï¼Œåªæ˜¯ä¸ºäº†ä½¿è¯»è€…å»ºç«‹èµ·å…³äº JVM æŒ‡ä»¤é›†åŸºæœ¬çš„å¸¸è¯†æ€§è§‚å¿µã€‚</p>\n<h2>æœ¯è¯­çº¦å®š</h2>\n<p>é¦–å…ˆï¼Œéœ€è¦å°± <code>æœ¯è¯­</code> è¿›è¡Œä¸€äº›åŸºç¡€æ€§çš„çº¦å®š:</p>\n<h3>å˜é‡</h3>\n<p><img src="https://ws3.sinaimg.cn/large/006tNc79gy1ftidi0xpmij30oa07kaaq.jpg" alt="å˜é‡"></p>\n<ul>\n<li><code>å˜é‡</code>: åœ¨ç±»ä¸­ï¼ŒåŒºåˆ†äº <code>æ–¹æ³•</code> çš„å£°æ˜<ul>\n<li><code>æˆå‘˜å˜é‡</code>: ä½œç”¨åŸŸä¸ºæ•´ä¸ªç±»ï¼Œåœ¨æ–¹æ³•ä½“ä¸è¯­å¥å—ä¹‹å¤–å£°æ˜çš„å†…å®¹ã€‚åœ¨ <code>å­—èŠ‚ç </code> ä¸­é€šå¸¸è¢«ç§°ä¸º <code>å­—æ®µ(Field)</code><ul>\n<li><code>ç±»æˆå‘˜å˜é‡ / é™æ€æˆå‘˜å˜é‡</code>: è¢« <code>static</code> ä¿®é¥°çš„ <code>æˆå‘˜å˜é‡</code>ã€‚ä¸€ä¸ªç±»åªæœ‰ä¸€ä»½ï¼Œåœ¨ç±»è¢«åŠ è½½çš„æ—¶å€™å³åˆå§‹åŒ–ã€‚</li>\n<li><code>å®ä¾‹æˆå‘˜å˜é‡</code>: é <code>static</code> ä¿®é¥°çš„ <code>æˆå‘˜å˜é‡</code>ã€‚éšç€ç±»è¢«å®ä¾‹åŒ–è€Œè¿›è¡Œåˆå§‹åŒ–ï¼Œæ¯ä¸ªå®ä¾‹å¯¹è±¡éƒ½æœ‰ä¸€ä»½ç‰¹æœ‰çš„ <code>å®ä¾‹å˜é‡</code>ã€‚</li>\n</ul></li>\n<li><code>å±€éƒ¨å˜é‡</code>: ä½œç”¨åŸŸä¸ºæ–¹æ³•ä½“æˆ–è€…è¯­å¥å—ã€‚</li>\n</ul></li>\n</ul>\n<h3>JVM æŒ‡ä»¤</h3>\n<p>é€šå¸¸ï¼Œæˆ‘ä»¬å€ŸåŠ©äº <code>javap</code> å‘½ä»¤æ¥å¯¹ .class æ–‡ä»¶çš„å­—èŠ‚ç å†…å®¹è¿›è¡ŒæŸ¥é˜…ã€‚</p>\n<p>ç±»ä¼¼äºæ±‡ç¼–ä»£ç ï¼Œ<code>javap</code> æ‰“å°çš„JVM æŒ‡ä»¤å°†ä»¥ä¸‹åˆ—æ ¼å¼è¿›è¡Œå±•ç¤º:</p>\n<pre><code class="language-plain">&#x3C;index> &#x3C;opcode> [&#x3C;operand1> [&#x3C;operand2> ...]] [&#x3C;comment>]\n</code></pre>\n<p>å…¶ä¸­ </p>\n<ul>\n<li><code>&#x3C;index></code> æŒ‡åœ¨ <code>code[]</code> å±æ€§ä¸­è¿™æ¡æŒ‡ä»¤çš„åç§»é‡(ä» 0 å¼€å§‹è®¡æ•°)ã€‚</li>\n<li><code>&#x3C;opcode></code> æŒ‡ <code>æ“ä½œç </code></li>\n<li><code>&#x3C;operandX></code> æŒ‡ <code>æ“ä½œæ•°</code>ï¼Œæ¯ä¸ª <code>&#x3C;opcode></code> éƒ½éœ€è¦ç¡®å®šæ•°é‡çš„æ“ä½œæ•°(è§„èŒƒä¸­å·²ç»ç¡®å®š)ã€‚</li>\n<li><code>&#x3C;comment></code> æŒ‡æ³¨é‡Š</li>\n</ul>\n<h2>æŒ‡ä»¤é›†æ¦‚è§ˆ</h2>\n<p>é¦–å…ˆï¼ŒJava ä»£ç ç»ç¼–è¯‘åçš„æ‰€æœ‰æŒ‡ä»¤éƒ½åŸºäº <code>æ–¹æ³•(Method)</code> è¢«å®šä¹‰åœ¨ <code>Code</code> å±æ€§ä¸­ã€‚</p>\n<p>åœ¨ <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.7.3">ClassFile</a> çš„ <code>Code</code> å±æ€§ï¼Œç»“æ„å®šä¹‰å¦‚ä¸‹:</p>\n<pre><code class="language-java">Code_attribute {\n    // å…¶ä¸­ u1, u2, u4 åˆ†åˆ«è¡¨ç¤ºè¿™ä¸ªå˜é‡æ‰€å çš„å­—èŠ‚é•¿åº¦\n    u2 attribute_name_index;                    // å±æ€§ååœ¨å¸¸é‡æ± ä¸­çš„ index (æ‰§è¡Œå¸¸é‡æ± ä¸­ Code çš„ä½ç½®)\n    u4 attribute_length;                        // å±æ€§é•¿åº¦ï¼Œä¸åŒ…æ‹¬å¼€å§‹çš„å…­ä¸ªå­—èŠ‚\n    u2 max_stack;                               // è¿è¡Œæ—¶æ“ä½œæ•°æ ˆçš„æœ€å¤§æ·±åº¦\n    u2 max_locals;                              // è¿è¡Œæ—¶æ‰€éœ€çš„å±€éƒ¨å˜é‡è¡¨çš„å¤§å°\n    u4 code_length;                             // code æ•°ç»„çš„é•¿åº¦\n    u1 code[code_length];                       // code æ•°ç»„ï¼Œç¼–è¯‘åæ–¹æ³•ä½“çš„å†…å®¹éƒ½é€šè¿‡å­—èŠ‚ç æŒ‡ä»¤å­˜å‚¨åœ¨è¿™é‡Œ\n    u2 exception_table_length;                  // å¼‚å¸¸è¡¨çš„é•¿åº¦\n    {   u2 start_pc;\n        u2 end_pc;\n        u2 handler_pc;\n        u2 catch_type;\n    } exception_table[exception_table_length]; // å¼‚å¸¸è¡¨ï¼ŒJava ä»£ç ä¸­æ‰€æœ‰çš„ catch, finally çš„æ•è·éƒ½å°†ç”±æ­¤è¡¨è¿›è¡Œå®ç°\n    u2 attributes_count;                       // å±æ€§è®¡æ•°\n    attribute_info attributes[attributes_count];\n}\n</code></pre>\n<p>Java è™šæ‹Ÿæœºçš„æŒ‡ä»¤æ˜¯ç”±ä¸€ä¸ªå­—èŠ‚é•¿åº¦çš„ <code>æ“ä½œç </code> é…åˆä¸Šå…¶åçš„ 0 ä¸ªæˆ–å¤šä¸ª <code>æ“ä½œæ•°</code> æ‰€æ„æˆçš„ã€‚</p>\n<p>å…¶ä¸­ï¼Œ<code>æ“ä½œæ•°</code> çš„æ•°é‡å–å†³äº <code>æ“ä½œç </code>ï¼Œä¸åŒçš„ <code>æ“ä½œç </code> éœ€è¦ä¸åŒæ•°é‡çš„ <code>æ“ä½œæ•°</code>ã€‚</p>\n<p>æŒ‰ç…§ç±»å‹åˆ’åˆ†ï¼Œ<code>æ“ä½œæ•°</code> ä¸»è¦åŒ…æ‹¬ä¸‹åˆ—å‡ ç±»:</p>\n<ul>\n<li>åŠ è½½ä¸å­˜å‚¨æŒ‡ä»¤ï¼Œä¾‹å¦‚ iload, istore ç­‰</li>\n<li>è¿ç®—æŒ‡ä»¤ï¼Œä¾‹å¦‚ iadd, isub, imul ç­‰</li>\n<li>ç±»å‹è½¬æ¢æŒ‡ä»¤ï¼Œä¾‹å¦‚ i2b, i2s ç­‰</li>\n<li>å¯¹è±¡åˆ›å»ºä¸æ“ä½œæŒ‡ä»¤ï¼Œä¾‹å¦‚ new, newarray ç­‰</li>\n<li>æ“ä½œæ•°æ ˆç®¡ç†æŒ‡ä»¤ï¼Œä¾‹å¦‚ dup, pop ç­‰</li>\n<li>æ§åˆ¶è½¬ç§»æŒ‡ä»¤ï¼Œä¾‹å¦‚ if_icmpeq ç­‰</li>\n<li>æ–¹æ³•è°ƒç”¨ä¸è¿”å›æŒ‡ä»¤ï¼Œä¾‹å¦‚ invokevirtual, invokestatic ç­‰</li>\n<li>æŠ›å‡ºå¼‚å¸¸æŒ‡ä»¤ï¼Œä¾‹å¦‚ athrow ç­‰</li>\n<li>åŒæ­¥æŒ‡ä»¤ï¼Œä¾‹å¦‚ monitorenter ç­‰</li>\n</ul>\n<p><strong>ä¸¾å‡ ä¸ªç®€å•çš„ä¾‹å­:</strong></p>\n<p><code>iadd</code> æŒ‡ä»¤ï¼Œè¡¨ç¤ºå¯¹ä¸¤ä¸ª int æ•°çš„ç›¸åŠ æŒ‡ä»¤ã€‚å°†ä»æ“ä½œæ•°æ ˆé¡¶ä¾æ¬¡å–å‡ºä¸¤ä¸ªæ•°ï¼Œå¹¶ç›¸åŠ ï¼Œå†é‡æ–°å‹å…¥æ“ä½œæ•°æ ˆä¸­ã€‚</p>\n<p><code>bipush 100</code> ï¼Œå…¶ä¸­ <code>bipush</code> æ˜¯æŒ‡ä»¤ï¼Œåéšä¸€ä¸ªæ“ä½œæ•°ï¼Œè¡¨ç¤ºæŠŠ <code>æ“ä½œæ•° 100 è¿™ä¸ª byte ç±»å‹çš„æ•°</code> å‹å…¥æ“ä½œæ•°æ ˆé¡¶</p>\n<h2>è¿è¡Œæ—¶æ•°æ®åŒº</h2>\n<p>JVM å®šä¹‰äº†è‹¥å¹²ç§è¿è¡ŒæœŸé—´ä¼šä½¿ç”¨åˆ°çš„è¿è¡Œæ—¶æ•°æ®åŒºï¼Œè§ä¸‹å›¾:</p>\n<p><img src="https://ws4.sinaimg.cn/large/006tNc79gy1ft5osi6it1j31kw0ql78e.jpg" alt="JVM è¿è¡Œæ—¶æ•°æ®åŒº"></p>\n<p>è‡³äºæ¯ä¸€ä¸ªçš„å…·ä½“æ„ä¹‰ï¼Œåœ¨æ­¤ä¸åšè¯¦ç»†å±•å¼€ï¼Œå¯ç”¨å‚è€ƒ:</p>\n<ul>\n<li>ç”±å‘¨å¿—æ˜ç­‰ç¿»è¯‘çš„ ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒ(Java SE 7ç‰ˆ) ã€‹ 2.5èŠ‚å†…å®¹ <a href="http://icyfenix.iteye.com/blog/1256329">é“¾æ¥</a></li>\n<li><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5">JVMS 2.5. Run-Time Data Areas</a></li>\n</ul>\n<h2>Getter, Setter çš„æŒ‡ä»¤ä»£ç </h2>\n<p>é¦–å…ˆï¼Œæœ‰å¿…è¦æåŠï¼Œæƒ³è¦å¾—åˆ° .class å¯è§†ä¸”å‹å¥½çš„å±•ç¤ºç»“æœï¼Œå¯ä»¥ä½¿ç”¨ JDK è‡ªå¸¦çš„ <code>javap</code> å‘½ä»¤ã€‚</p>\n<p>æœ¬èŠ‚è¦å±•ç¤ºçš„å†…å®¹æ˜¯å¸¸è§çš„ POJO çš„ get, set æ–¹æ³•çš„æŒ‡ä»¤ä»£ç ã€‚ä½¿ç”¨çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹:</p>\n<pre><code class="language-java">public class Test {\n    \n    private int number;\n\n    public int getNumber() {\n        return number;\n    }\n\n    public void setNumber(int number) {\n        this.number = number;\n    }\n}\n</code></pre>\n<p>åœ¨ç»è¿‡ <code>javac</code> ç¼–è¯‘ï¼Œ<code>javap</code> è§£æä¹‹åï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä¸‹åˆ—å†…å®¹</p>\n<pre><code class="language-plain">Classfile /Users/fangfeng/WorkPkg/lab/src/main/java/me/fangfeng/asm/Test.class\n  Last modified Jul 23, 2018; size 357 bytes\n  MD5 checksum bb1940cc6534d789359295b8dc80233b\n  Compiled from "Test.java"\npublic class me.fangfeng.asm.Test\n  minor version: 0\n  major version: 52\n  flags: ACC_PUBLIC, ACC_SUPER\nConstant pool:\n   #1 = Methodref          #4.#17         // java/lang/Object."&#x3C;init>":()V\n   #2 = Fieldref           #3.#18         // me/fangfeng/asm/Test.number:I\n   #3 = Class              #19            // me/fangfeng/asm/Test\n   #4 = Class              #20            // java/lang/Object\n   #5 = Utf8               number\n   #6 = Utf8               I\n   #7 = Utf8               &#x3C;init>\n   #8 = Utf8               ()V\n   #9 = Utf8               Code\n  #10 = Utf8               LineNumberTable\n  #11 = Utf8               getNumber\n  #12 = Utf8               ()I\n  #13 = Utf8               setNumber\n  #14 = Utf8               (I)V\n  #15 = Utf8               SourceFile\n  #16 = Utf8               Test.java\n  #17 = NameAndType        #7:#8          // "&#x3C;init>":()V\n  #18 = NameAndType        #5:#6          // number:I\n  #19 = Utf8               me/fangfeng/asm/Test\n  #20 = Utf8               java/lang/Object\n{\n  public me.fangfeng.asm.Test();\n    descriptor: ()V\n    flags: ACC_PUBLIC\n    Code:\n      stack=1, locals=1, args_size=1\n         0: aload_0\n         1: invokespecial #1                  // Method java/lang/Object."&#x3C;init>":()V\n         4: return\n      LineNumberTable:\n        line 3: 0\n\n  public int getNumber();\n    descriptor: ()I\n    flags: ACC_PUBLIC\n    Code:\n      stack=1, locals=1, args_size=1\n         0: aload_0\n         1: getfield      #2                  // Field number:I\n         4: ireturn\n      LineNumberTable:\n        line 8: 0\n\n  public void setNumber(int);\n    descriptor: (I)V\n    flags: ACC_PUBLIC\n    Code:\n      stack=2, locals=2, args_size=2\n         0: aload_0\n         1: iload_1\n         2: putfield      #2                  // Field number:I\n         5: return\n      LineNumberTable:\n        line 12: 0\n        line 13: 5\n}\nSourceFile: "Test.java"\n</code></pre>\n<p>æ‰“å°å‡ºæ¥çš„å†…å®¹åŒ…æ‹¬æœ‰ ç±»çš„å…¨é™å®šåï¼Œè®¿é—®æ§åˆ¶æƒé™ï¼Œçˆ¶ç±»ï¼Œæ¥å£ï¼Œå¸¸é‡æ± ä»¥åŠå„ä¸ªæ–¹æ³•ã€‚</p>\n<p>ä»¥ <code>getNumber</code> ä¸ºä¾‹:</p>\n<pre><code class="language-plain">public int getNumber();\n  descriptor: ()I\n  flags: ACC_PUBLIC\n  Code:\n    stack=1, locals=1, args_size=1\n       0: aload_0\n       1: getfield      #2                  // Field number:I\n       4: ireturn\n    LineNumberTable:\n      line 8: 0\n</code></pre>\n<ul>\n<li>descriptor: è¡¨ç¤ºæ–¹æ³•æè¿°ç¬¦ï¼Œå…¶ä¸­ <code>()</code> å†…å®¹è¡¨ç¤ºå…¥å‚ï¼Œ<code>I</code> è¡¨ç¤ºè¿”å›å€¼çš„ç±»å‹</li>\n<li>flags     : è¡¨ç¤ºæ–¹æ³•çš„è®¿é—®æƒé™ï¼Œå½“å‰é™å®šä¸º <code>public</code></li>\n<li>Code      : å­˜å‚¨æœ‰å½“å‰æ–¹æ³•ä½“æŒ‡ä»¤ç çš„ä¸€ç§æ–¹æ³•å†…éƒ¨å±æ€§ã€‚<ul>\n<li>stack : è¡¨ç¤ºå½“å‰æ–¹æ³•(æ„å³åœ¨è¿è¡Œæ—¶æ‰€å¤„çš„æ ˆå¸§ï¼Œæ¯ä¸ªæ–¹æ³•çš„è°ƒç”¨éƒ½å°†åœ¨ <code>è™šæ‹Ÿæœºæ ˆ</code> ä¸­æ„å»ºä¸€ä¸ªæ–°çš„ <code>æ ˆå¸§</code>) ä½¿ç”¨çš„ <code>æ“ä½œæ•°æ ˆçš„æœ€å¤§æ·±åº¦</code></li>\n<li>locals: è¡¨ç¤ºå½“å‰æ–¹æ³•ä½¿ç”¨çš„ <code>å±€éƒ¨å˜é‡è¡¨</code> çš„å¤§å°</li>\n<li>args_size : è¡¨ç¤ºå˜é‡ä¸ªæ•°</li>\n<li>LineNumberTable : ä¸ Debug æœ‰å…³ï¼ŒæŒ‡å½“å‰çš„çš„æŒ‡ä»¤é›†åœ¨æºæ–‡ä»¶ä¸­çš„ç¬¬å‡ è¡Œå¼€å§‹</li>\n</ul></li>\n</ul>\n<pre><code class="language-plain">0: aload_0              // ä»å±€éƒ¨å˜é‡è¡¨ä¸­åŠ è½½ 0 å·å…ƒç´ åˆ°æ“ä½œæ•°æ ˆä¸­\n1: getfield #2          // è·å–å¸¸é‡æ± ä¸­ 2 å·å…ƒç´ (å³ Field number:I) çš„å€¼ï¼Œå¹¶åŠ è½½åˆ°æ“ä½œæ•°æ ˆä¸­\n4: ireturn              // æŠ›å‡ºå½“å‰æ“ä½œæ•°æ ˆé¡¶å…ƒç´ ä½œä¸ºè¿”å›å€¼\n</code></pre>\n<p>å…¶ä¸­ï¼Œæ¯æ¡æŒ‡ä»¤å‰çš„ 0, 1, 4 æŒ‡å½“å‰æŒ‡ä»¤ä½œä¸º <code>Code</code> å±æ€§çš„å†…å®¹çš„åç§»é‡ã€‚</p>\n<p>æ¢ä¸€å¥è¯è¯´ï¼Œ<code>aload_0</code> æ˜¯ Code å±æ€§ code[] çš„ç¬¬ 0 ä¸ªå­—èŠ‚çš„å†…å®¹\n<code>getfield #2</code> çš„æ˜¯ä» code[] çš„ç¬¬ 1 ä¸ªå­—èŠ‚å¼€å§‹çš„ã€‚\n<code>ireturn</code> æ˜¯ä» code[] çš„ç¬¬ 4 ä¸ªå­—èŠ‚å¼€å§‹ã€‚</p>\n<p>è‡³äºä¸ºä»€ä¹ˆæ¯æ¡æŒ‡ä»¤çš„å¼€å§‹ä½ç½®ä¸åŒï¼Œè¿™å–å†³äºæ¯æ¡æŒ‡ä»¤çš„é•¿åº¦ã€‚<code>aload_0</code> æŒ‡ä»¤æœ¬èº«ä¸º 1 å­—èŠ‚çš„é•¿åº¦ï¼Œä¸”ä¸è¦æ±‚é™„å¸¦æ“ä½œæ•°ã€‚\n<code>getfield</code> æŒ‡ä»¤è‡ªé•¿ 1 ä¸ªå­—èŠ‚ï¼Œä½†éœ€è¦ä¸€ä¸ªé•¿åº¦ä¸º 2 å­—èŠ‚çš„å¸¸é‡æ± ç´¢å¼•ã€‚å› æ­¤ <code>ireturn</code> å°†ä»ç¬¬ 4 å­—èŠ‚å¼€å§‹</p>\n<hr>\n<p>åŒæ—¶ï¼Œå¯èƒ½æœ‰äººä¼šæœ‰æ‰€ç–‘é—®ï¼Œ<code>aload_0</code> åŠ è½½çš„ 0 å·å…ƒç´ æ˜¯ä»€ä¹ˆï¼Ÿå®ƒè²Œä¼¼æ²¡æœ‰è¢«ç”¨åˆ°ï¼Ÿ</p>\n<p>é¦–å…ˆï¼Œåœ¨æ¯ä¸ªæ–¹æ³•è¢«è§¦å‘ï¼Œåœ¨æ„å»ºæ–°çš„æ ˆå¸§æ—¶ï¼Œ<code>this</code> å°†è‡ªåŠ¨ä½œä¸º 0 å·å…ƒç´ è¢«å­˜å…¥æ–°æ ˆå¸§çš„å±€éƒ¨å˜é‡è¡¨ä½œä¸º 0 å·å…ƒç´ ã€‚\nåŒæ—¶ï¼Œå¦‚æœæ–¹æ³•æœ‰å…¥å‚ï¼Œåˆ™å…¥å‚æŒ‰å…¥å‚å£°æ˜é¡ºåºä¾æ¬¡ä½œä¸º 1, 2, 3, ... å…ƒç´ å­˜å…¥ã€‚\n(å½“ç„¶ï¼Œè¿™é‡Œå­˜åœ¨ç‰¹æ®Šæƒ…å†µï¼Œè¯¸å¦‚ long, double è¿™æ ·é•¿ä¸º 8 å­—èŠ‚çš„å…ƒç´ ï¼Œå°†å ç”¨ 2 ä¸ªå±€éƒ¨å˜é‡è¡¨çš„æ•°ç»„ä¸‹æ ‡ï¼Œè€Œå…¶ä»–å…ƒç´ é¡ºå»¶)ã€‚</p>\n<p>è‡³äºçœ‹ä¼¼ 0 å·å…ƒç´  <code>this</code> å¹¶æ²¡æœ‰è¢«ç”¨åˆ°ã€‚äº‹å®ä¸Šï¼Œå®ƒæ˜¯ä½œä¸º <code>getfield</code> çš„ä¸€ä¸ªé™å®šè¢«ä½¿ç”¨çš„ã€‚\nè¯•æƒ³ï¼Œ<code>getfield</code> è™½ç„¶é€šè¿‡ <code>#2</code> èƒ½å¤ŸçŸ¥é“éœ€è¦è·å–åˆ°çš„å˜é‡åä¸º <code>number</code> ç±»å‹ä¸º <code>I(å³ int)</code> çš„å…ƒç´ ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªå…ƒç´ ç©¶ç«Ÿå±äºå“ªä¸ªå®ä¾‹ï¼Ÿ\nè€Œæ“ä½œæ•°æ ˆé¡¶çš„ <code>this</code> æ°æ°æ˜¯æŒ‡æ˜ï¼Œéœ€è¦ä½¿ç”¨å½“å‰æ–¹æ³•æ‰€åœ¨çš„ç±»çš„ number å˜é‡ã€‚</p>\n<hr>\n<p>ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>setNumber</code> æ–¹æ³•</p>\n<pre><code class="language-plain">0: aload_0              // ä»å±€éƒ¨å˜é‡è¡¨ä¸­åŠ è½½ 0 å·å…ƒç´ åˆ°æ“ä½œæ•°æ ˆä¸­ (ç”¨äºç¡®å®šå­—æ®µæ‰€å±çš„ç±»)\n1: iload_1              // ä»å±€éƒ¨å˜é‡è¡¨ä¸­åŠ è½½ 1 å·å…ƒç´ åˆ°æ“ä½œæ•°æ ˆä¸­ (ç”¨äºç¡®å®šå°†è¦ç»™å­—æ®µèµ‹çš„å€¼)\n2: putfield      #2     // è·å–å¸¸é‡æ± ä¸­ 2 å·å…ƒç´ (å³ Field number:I) çš„åœ°å€ï¼Œå¹¶èµ‹å€¼\n5: return               // æ— è¿”å›å€¼çš„ return æŒ‡ä»¤æ¥ç»“æŸå½“å‰æ ˆå¸§çš„æ‰§è¡Œ\n</code></pre>\n<h2>ç»™å˜é‡èµ‹åˆå§‹å€¼</h2>\n<p>ç»å¸¸ä¼šè§åˆ°åœ¨æ–¹æ³•ä½“å†…éƒ¨æœ‰ç±»ä¼¼è¿™æ ·çš„å£°æ˜ <code>int score = 100</code> ï¼Œé‚£ä¹ˆè¿™æ ·çš„å†…å®¹ç¿»è¯‘æˆæŒ‡ä»¤ä¼šæ˜¯å¦‚ä½•ï¼Ÿ</p>\n<p>å¯¹äºè¾ƒå°çš„å€¼ï¼Œä¾‹å¦‚ 100ï¼Œå°†é€šè¿‡ <code>bipush 100</code>, <code>istore_1(å‡è®¾ç”¨å±€éƒ¨å˜é‡è¡¨ 1 å·å…ƒç´ å­˜å‚¨ score å˜é‡</code> ç±»ä¼¼çš„å½¢å¼è¿›è¡Œèµ‹å€¼ã€‚\nç±»ä¼¼çš„ï¼Œè¿˜æ˜¯ <code>sipush</code> ï¼Œä¸¤è€…çš„åŒºåˆ«æ˜¯ bipush å¯ä»¥æ”¯æŒ 1 å­—èŠ‚å¤§å°çš„æ•´æ•°ï¼Œsipush æ”¯æŒ 2 å­—èŠ‚å¤§å°çš„æ•´æ•°ã€‚</p>\n<p>ä½†æ˜¯ï¼Œint æœ€å¤§å¯æ˜¯å¯ä»¥åˆ°è¾¾ 4 å­—èŠ‚ï¼Œæ›´ç”šè€…ï¼Œlong å°†è¾¾åˆ° 8 å­—èŠ‚ã€‚</p>\n<p>è¿™æ—¶å€™ï¼Œå°†è¦å€ŸåŠ©çš„å°±æ˜¯ <code>ldc #&#x3C;index></code> ç”¨æ¥è¯»å–å¸¸é‡æ± ç¼–å·å°äº 128 çš„å¸¸é‡(ä¾‹å¦‚æ•´æ•°å¸¸é‡ï¼Œæµ®ç‚¹å¸¸é‡ç­‰ç­‰)\né‚£ä¹ˆï¼Œè¶…å‡º 128 ç¼–å·çš„ï¼Ÿä½¿ç”¨ <code>ldc_w #&#x3C;index></code> è¯»å– 2 å­—èŠ‚å†…å®¹ä½œä¸ºç¼–å·ï¼Œæœ€å¤§ 65535ã€‚å½“ç„¶ï¼Œæ›´å¤§çš„å†…å®¹ï¼Œå¸¸é‡æ± éƒ½ä¸èƒ½æ”¯æŒäº†å“ˆã€‚</p>\n<p>åŒæ—¶ï¼ŒåŒºåˆ«äºå°† byte, short, int, float ç»Ÿä¸€ä½œä¸º 4 å­—èŠ‚ç»“æœè¯»å–ï¼Œå¯¹äº long, double è¿™æ ·çš„å…«å­—èŠ‚å…ƒç´ ï¼Œä½¿ç”¨ <code>ldc2_w</code></p>\n<h2>æ§åˆ¶ç»“æ„</h2>\n<p>ä½œä¸ºä¸€é—¨å›¾çµå®Œå¤‡çš„è¯­è¨€ï¼Œè‡³å°‘ï¼Œæ§åˆ¶ç»“æ„æ˜¯å¿…ä¸å¯å°‘çš„å…ƒç´ ã€‚</p>\n<p>é‚£ä¹ˆï¼Œç±»ä¼¼ <code>for(int i=0;i&#x3C;10;i++)</code> çš„ Java ä»£ç ç¼–è¯‘æˆæŒ‡ä»¤åˆ°åº•æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p>\n<pre><code class="language-plain">0: iconst_0                     // èµ‹å€¼æŒ‡ä»¤ï¼Œå¾€æ“ä½œæ•°æ ˆé¡¶æ·»åŠ æ•´æ•°å€¼ 0\n1: istore_1                     // å°†æ“ä½œæ•°æ ˆé¡¶çš„å…ƒç´ å­˜å…¥å±€éƒ¨å˜é‡è¡¨ 1 å·ä½ç½®\n2: iload_1                      // ä»å±€éƒ¨å˜é‡è¡¨ 1 å·ä½ç½®åŠ è½½å…ƒç´ åˆ°æ“ä½œæ•°æ ˆ\n3: bipush        10             // å¾€æ“ä½œæ•°æ ˆé¡¶å‹å…¥ byte å‹å€¼ 10\n5: if_icmpge     21             // å°†æ“ä½œæ•°æ ˆé¡¶çš„ä¸¤ä¸ªå…ƒç´ è¿›è¡Œæ¯”è¾ƒ, å¦‚æœ æ¬¡é¡¶éƒ¨å…ƒç´  >= é¡¶éƒ¨å…ƒç´ ï¼Œåˆ™é‡å®šå‘åˆ°åç§»é‡ä¸º 21 çš„æŒ‡ä»¤\n//  for (...) {} è¯­å¥å—çš„å†…å®¹\n15: iinc          1, 1          // å°†å±€éƒ¨å˜é‡è¡¨çš„ 1 å·ä½ç½®å…ƒç´  +1\n18: goto          2             // è·³è½¬åˆ°åç§»é‡ä¸º 2 çš„æŒ‡ä»¤\n21: return                      // è°ƒç”¨æ— è¿”å›å€¼çš„ return\n</code></pre>\n<p>ç±»ä¼¼çš„ï¼Œ<code>if(...)</code> è¯­å¥çš„æ¯”è¾ƒè¾ƒä¹‹ <code>for(;;)</code> å°±æ›´ä¸ºç®€å•ã€‚ç±»æ¯”åç§»é‡ä¸º 5 çš„æŒ‡ä»¤å³å¯ã€‚</p>\n<h2>è°ƒç”¨æ–¹æ³•</h2>\n<p>JVM æŒ‡ä»¤é›†ä¸­æ€»è®¡æœ‰ 4 ç§è°ƒç”¨æ–¹æ³•çš„æŒ‡ä»¤ï¼ŒåŒ…æ‹¬æœ‰: </p>\n<ul>\n<li><code>invokevirtual</code>, å¯¹æ™®é€šå®ä¾‹æ–¹æ³•çš„è°ƒç”¨ï¼Œå°†æ ¹æ®å¯¹è±¡ç±»å‹è¿›è¡Œåˆ†å‘è°ƒç”¨</li>\n<li><code>invokestatic</code>, å¯¹é™æ€æ–¹æ³•çš„è°ƒç”¨</li>\n<li><code>invokespecial</code>, ç”¨äºè°ƒç”¨ç±»çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œä¹Ÿç”¨äºè°ƒç”¨çˆ¶ç±»æ–¹æ³•å’Œç§æœ‰æ–¹æ³•</li>\n<li><code>invokeinterface</code>, ç”¨äºè°ƒç”¨æ¥å£æ–¹æ³•</li>\n</ul>\n<p>ä»¥æ‰§è¡Œ <code>System.out.println()</code> ä¸ºä¾‹\nå‡è®¾å¸¸é‡æ± å†…å®¹å­˜åœ¨ç›®æ ‡å…ƒç´ (å…·ä½“ä»¥ç›¸åº”æ³¨é‡Šä¸ºå‡†)</p>\n<pre><code class="language-plain">getstatic     #3                  // Field java/lang/System.out:Ljava/io/PrintStream;\ninvokevirtual #4                  // Method java/io/PrintStream.println:()V\n</code></pre>\n<h2>More</h2>\n<p>æ›´å¤šå†…å®¹ï¼ŒåŒ…æ‹¬: å¦‚ä½•å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚ä½•æŠ›å‡ºåŠå¤„ç†å¼‚å¸¸ï¼Œä»£ç åŒæ­¥å£°æ˜ç­‰ï¼Œæš‚ä¸”ä¸è¡¨ã€‚</p>\n<p>æœ‰æ—¶é—´å†åšè¡¥å……</p>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},yEfC:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>è¿™æ¬¡æ‹–å¾—æœ‰å¤Ÿä¹…çš„ï¼Œæ¯•ç«Ÿéœ€è¦å°†çŸ¥è¯†ä¸²è”èµ·æ¥å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚æ›´ä½•å†µå¾ˆå¤šå†…å®¹å¯ä»¥è¯´å’Œå¸¸ç†(ä¸ªäººç†è§£çš„å¸¸ç†)æœ‰äº†æ¯”è¾ƒå¤§çš„åå·®ã€‚</p>\n<p>ä¸è¿‡ç¡®å®æ¯”è¾ƒæœ‰æ„æ€ã€‚ä»å¼•å¯¼ç¨‹åºåˆ°æ“ä½œç³»ç»Ÿå¯åŠ¨ï¼Œè¿™ä¸­é—´ç©¶ç«Ÿç»å†äº†å¤šå°‘æµç¨‹å‘¢ï¼Ÿ</p>\n<p>ç”±äºæœ‰äº†å‰å‡ èŠ‚çš„å†…å®¹ï¼Œè¿™é‡Œä¸ä¼šå†å¯¹å¼•å¯¼ç¨‹åºåŠæ±‡ç¼–è¯­æ³•åšè¿‡å¤šçš„ä»‹ç»ã€‚è€Œç€é‡åœ¨äºæ•´ä¸ªæµç¨‹çš„æè¿°ã€‚</p>\n<h2>å¼•å¯¼ç¨‹åº</h2>\n<p>ä» BIOS å°†512å­—èŠ‚é•¿çš„å¼•å¯¼ç¨‹åºåŠ è½½åˆ°ç‰©ç†å†…å­˜<code>0x7c00</code>å¼€å§‹çš„è¿ç»­é€’å¢ç©ºé—´åï¼Œå³å°†ç¨‹åºçš„æ‰§è¡Œæƒäº¤ç»™äº†å¼•å¯¼ç¨‹åº(è¿™é‡ŒæŒ‡çš„æ‰§è¡Œæƒå¯ä»¥ç®€å•ç†è§£æˆCS:IP)</p>\n<blockquote>\n<p><em>CS:IP</em></p>\n<p><strong>CS</strong>. ä»£ç æ®µåŸºå€ã€‚ä¸€èˆ¬ç”¨äºåˆ’å®šä¸€æ®µè¿ç»­ä»£ç å¼€å§‹çš„åœ°å€ã€‚æ˜¯ä¸€ä¸ª16ä½æ®µå¯„å­˜å™¨ï¼Œç±»ä¼¼çš„è¿˜æœ‰ DS, ES, FS, GS, SS ç­‰16ä½æ®µå¯„å­˜å™¨ï¼Œåˆ†åˆ«æä¾›ä¸åŒçš„æ®µåŸºå€å­˜å‚¨åŠŸèƒ½)\n<strong>IP</strong>. ä»£ç æ®µåç§»å€¼ã€‚é…åˆ CS å…±åŒä¸º CPU ç¡®å®šä¸‹ä¸€ä¸ªå°†è¦è¢«æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤çš„çº¿æ€§åœ°å€ã€‚</p>\n</blockquote>\n<p>Linux 0.11 ç‰ˆæœ¬çš„å¼•å¯¼ç¨‹åºå®ç°çš„æ”¯æŒæ¯”è¾ƒç®€å•ã€‚</p>\n<ol>\n<li>å°†å¼•å¯¼ç¨‹åºä»£ç (è‡ªèº«) 512 å­—èŠ‚çš„å†…å®¹ç§»åŠ¨åˆ° <code>0x90000</code> å¼€å§‹çš„ 512B å†…å­˜ç©ºé—´ä¸Š</li>\n<li>è·³åˆ° <code>0x90000</code> å¼€å§‹çš„æ®µçš„ç›¸åº”ä½ç½®ç»§ç»­æ‰§è¡Œ</li>\n<li>ä»ç£ç›˜ä¸­è¯»å– 4*512 å­—èŠ‚çš„ setup ç¨‹åºçš„äºŒè¿›åˆ¶å†…å®¹</li>\n<li>è¯»å–æ“ä½œç³»ç»Ÿçš„äºŒè¿›åˆ¶å†…å®¹åˆ°å†…å­˜ <code>0x10000</code> å¼€å§‹çš„è¿ç»­åœ°å€ç©ºé—´ä¸­ (æ­¤å¤„æœ€å¤§å¯ä»¥æœ‰ 0x90000 - 0x10000 = 0x80000 = 512 KBï¼Œå³å½“æ—¶çš„æ“ä½œç³»ç»ŸäºŒè¿›åˆ¶ç¨‹åº+æ•°æ®æœ€å¤§åªèƒ½æ˜¯ 512KB, ä¸è¿‡ä¹Ÿå¾ˆå¤šäº†)</li>\n<li>ç¡®è®¤å°†è¦ä½œä¸ºæ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜æ˜¯å¦å­˜åœ¨</li>\n<li>å°†æ§åˆ¶æƒäº¤ç»™ setup ç¨‹åº</li>\n</ol>\n<h2>SETUP ç¨‹åº</h2>\n<p><strong>è¯»å–ç¡¬ä»¶é…ç½®</strong></p>\n<p>setup ç¨‹åºï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨æä¸€äº›é…ç½®ã€‚é‚£ä¹ˆç©¶ç«Ÿåœ¨é…ç½®ä»€ä¹ˆï¼Ÿ</p>\n<p>å°±æ˜¯é€šè¿‡ BIOS ä¸­æ–­è¯»å–å„ç§ç¡¬ä»¶ä¿¡æ¯(è¯¸å¦‚å†…å­˜å¤§å°ï¼Œæ˜¾ç¤ºå™¨é•¿å®½æ¯”ï¼Œç£ç›˜ç­‰)ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨å†…å­˜çš„æŒ‡å®šä½ç½®ã€‚</p>\n<p>å“ˆå“ˆï¼Œç”±äºå¼•å¯¼ç¨‹åºå·²ç»æ‰§è¡Œå®Œäº†ï¼Œå†ä¹Ÿä¸ä¼šä½¿ç”¨äº†ã€‚å› æ­¤ï¼Œsetup ç¨‹åºå°±æ˜¯å°†è¿™äº›ä¿¡æ¯å­˜å‚¨åˆ°äº†åŸå¼•å¯¼ç¨‹åºæ‰€åœ¨çš„ä½ç½®ï¼Œå³ 0x90000 ~ 0x901FF å…± 512 B çš„å†…å­˜ä¸­ã€‚</p>\n<p>å½“ç„¶ï¼Œæ¯ä¸ªå­—èŠ‚å­˜çš„æ˜¯ä»€ä¹ˆå†…å®¹éƒ½æ˜¯ä¸€ç§çº¦å®š(æ¯”å¦‚ setup ç¨‹åºæŠŠå†…å­˜å¤§å°çš„ä¿¡æ¯å­˜åˆ°äº†å“ªï¼Œåé¢å…¶å®ƒç¨‹åºå°±åˆ°ç›¸åº”çš„ä½ç½®å»å–)ã€‚</p>\n<p><strong>ç§»åŠ¨æ“ä½œç³»ç»Ÿç¨‹åº</strong></p>\n<p>OKï¼Œsetup ç¨‹åºä¹Ÿä¸æ˜¯ä»…ä»…åªå¹²è¿™ä¹ˆç‚¹äº‹æƒ…çš„ï¼Œä¸ç„¶è¦ 4*512 å­—èŠ‚å²‚ä¸æ˜¯å¤ªæµªè´¹äº†ï¼Œå“ªç”¨å¾—äº†è¿™ä¹ˆå¤šã€‚</p>\n<p>setup è¿˜è¦è´Ÿè´£å°†æ“ä½œç³»ç»Ÿç¨‹åºç§»åŠ¨åˆ°<em>æ–¹ä¾¿</em>çš„ä½ç½®ã€‚å‰é¢å°†æ“ä½œç³»ç»Ÿç¨‹åºåŠ è½½åˆ°äº†å†…å­˜ 0x10000 å¤„ï¼Œä¸»è¦æ˜¯ä¸ºäº†æš‚æ—¶ä¿æŒ BIOS ä¸­æ–­å‘é‡è¡¨ (ä½äº 0x0000 å¼€å§‹çš„è¿ç»­ 1024 B å†…å­˜ä¸­ï¼Œç”± BIOS ç¨‹åºåˆ›å»ºï¼Œç”¨äºå„ç§ä¸­æ–­è°ƒç”¨) ã€‚åœ¨ setup å†³å®šä¸å†ä½¿ç”¨ BIOS ä¸­æ–­ä¹‹åï¼Œå°±å·²ç»å¯ä»¥å®Œå…¨åºŸå¼ƒäº†ã€‚</p>\n<p>å› æ­¤ï¼Œæ“ä½œç³»ç»Ÿç¨‹åºå°†ä» 0x10000 é¡ºæ¬¡ç§»åŠ¨åˆ° 0x00000 çš„ä½ç½®ã€‚</p>\n<p><strong>é‡ç½®ä¸­æ–­</strong></p>\n<p>è½¯ä¸­æ–­ä¸ç¡¬ä¸­æ–­ï¼Œåº”è¯¥æ˜¯åœ¨è½¯ç¡¬ä»¶åˆ’åˆ†ä¸‹å”¯äºŒçš„ä¸¤ç§ä¸­æ–­å½¢å¼ã€‚è½¯ä¸­æ–­ä¸€èˆ¬é€šè¿‡æ±‡ç¼–æŒ‡ä»¤ <code>INT {ä¸­æ–­å·}</code> çš„å½¢å¼é€šè¿‡è½¯ä»¶æ‰§è¡Œçš„å½¢å¼äº§ç”Ÿï¼Œè€Œç¡¬ä¸­æ–­æ˜¯ç¡¬ä»¶ç”±äºæŸäº›é”™è¯¯æŒ‡ä»¤è€Œè‡ªåŠ¨äº§ç”Ÿçš„ä¸­æ–­ã€‚</p>\n<p>å½“ç„¶ï¼Œè¿™äº›ä¸­æ–­éƒ½éœ€è¦ CPU è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚é‚£ä¹ˆï¼Œåœ¨ BIOS  ä¸­æ–­å‘é‡è¡¨è¢«è¦†ç›–äº†ä¹‹åï¼Œå¦‚ä½•æ¥å¤„ç†è¿™äº›ä¸­æ–­å‘¢ï¼Ÿ</p>\n<p>é¦–å…ˆï¼Œåœ¨ä¸Šä¸€æ­¥ <strong>ç§»åŠ¨æ“ä½œç³»ç»Ÿç¨‹åº</strong> å¼€å§‹æ—¶ï¼Œå°±ç›´æ¥é€šè¿‡æ±‡ç¼–æŒ‡ä»¤ <code>cli</code> å¼ºåˆ¶ç¦æ­¢é™¤ <em>éå¯å±è”½ä¸­æ–­</em> å¤–çš„æ‰€æœ‰ä¸­æ–­ï¼Œå› æ­¤ä¹Ÿå°±åŸºæœ¬ä¸è€ƒè™‘ä¸­æ–­çš„é—®é¢˜ã€‚</p>\n<p>ä½†æ˜¯ï¼Œæ€»è¿˜å¾—è§£é™¤ç¦æ­¢å§ã€‚å› æ­¤ï¼Œsetup ç¨‹åºå°½å¿«åœ°é‡æ–°ç¼–åˆ¶äº†ç¡¬ä»¶ä¸­æ–­ï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼ã€‚ä½¿ç”¨ä¿æŠ¤æ¨¡å¼ä¸‹çš„ä¸­æ–­æè¿°ç¬¦è¡¨æ¥æ›¿ä»£ BIOS ä¸­æ–­å‘é‡è¡¨ã€‚</p>\n<p>è‡³äºå¦‚ä½•åˆ›å»ºä¸­æ–­æè¿°ç¬¦è¡¨ï¼Œå“ˆå“ˆï¼Œè¿™éƒ½æ˜¯ç›´æ¥åœ¨æ±‡ç¼–ç¼–ç¨‹çš„æ—¶å€™å†™å¥½çš„ã€‚ç›´æ¥åˆ’å‡ºäº†ä¸€å—åŒºåŸŸå†™ä¸Šäº†ä¸­æ–­æè¿°ç¬¦è¡¨çš„è¡¨é¡¹ï¼Œç„¶åä¸ setup ä»£ç ä¸€èµ·è¢«è¯»å–åˆ°äº†å†…å­˜çš„æŒ‡å®šä½ç½®ã€‚è‡³äºå”¯ä¸€è¦åšçš„ï¼Œå°±æ˜¯å°† IDTR (ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨) ä¿®æ”¹ä¸ºä¸­æ–­æè¿°ç¬¦è¡¨åœ¨å†…å­˜çš„å¼€å§‹åœ°å€ã€‚</p>\n<p><strong>è¿›å…¥ä¿æŠ¤æ¨¡å¼</strong></p>\n<p>é¦–å…ˆï¼Œç®€å•ä»‹ç»ä¸€ä¸‹å®æ¨¡å¼ &#x26; ä¿æŠ¤æ¨¡å¼ã€‚</p>\n<p>ä¿æŠ¤æ¨¡å¼ä¸å®æ¨¡å¼çš„ä¸»è¦åŒºåˆ«ï¼Œå°±åœ¨äºä¸¤è€…çš„å†…å­˜å¯»å€æ–¹å¼ï¼Œå½’æ ¹ç»“åº•ä¹Ÿå°±æ˜¯æ®µå¯„å­˜å™¨å¦‚ä½•è¾…åŠ©å®Œæˆå†…å­˜åœ°å€å®šä½çš„é—®é¢˜ã€‚</p>\n<p>å…ˆç®€å•çš„å›é¡¾ä¸‹å®æ¨¡å¼ä¸‹çš„å¯»å€æ–¹å¼</p>\n<p>æ®µå¯„å­˜å™¨çš„å‡ºç°ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¸ºäº†å¯¹ 16 bit CPU ä¸‹å¯å¯»å€åœ°å€ä¸è¶³æ‰€ä½œå‡ºçš„è¡¥å……ã€‚\nè¯¸å¦‚ CS:IP = 0x07C0:0x0001 -> 0x07C01 ã€‚é€šè¿‡CS:IP çš„é…åˆï¼Œç‰©ç†åœ°å€ = CS &#x3C;&#x3C; 4 + IP ï¼Œå°†åŸæœ¬ 128 KB çš„å¯å¯»å€ç©ºé—´æ‰©å±•åˆ° 0xFFFF:0xFFFF -> 0x10FFFE çš„å¯»å€ç©ºé—´</p>\n<p>è€Œä¿æŠ¤æ¨¡å¼çš„å‡ºç°ï¼Œä¹Ÿæ˜¯ç”±äºå®æ¨¡å¼ä¸‹çš„åœ°å€å¯»å€ä»ç„¶ä¸èƒ½æ»¡è¶³å¯¹å†…å­˜å¯»å€çš„éœ€æ±‚ã€‚</p>\n<p>é‚£ä¹ˆä¿æŠ¤æ¨¡å¼ç©¶ç«Ÿå°†å¦‚ä½•è¿›è¡Œå¯»å€å‘¢ï¼Ÿç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡æ–°å¢äº†ä¸€ä¸ªå¯„å­˜å™¨ GDTR (å…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨ã€‚å½“ç„¶ï¼Œæš‚æ—¶ä¸è€ƒè™‘ LDTR) ç”¨æ¥å­˜å‚¨å…¨å±€æè¿°ç¬¦è¡¨(å…¨å±€æè¿°ç¬¦è¡¨æ˜¯ä¸€äº›åœ¨å†…å­˜ä¸­çš„æœ‰ç»“æ„çš„æ•°æ®) ï¼Œé‚£ä¹ˆç±»ä¼¼çš„ï¼Œæœ¬æ¥æ˜¯æ®µå¯„å­˜å™¨ä¸­æ˜¯è¡¨ç¤ºä¸€ä¸ªå†…å­˜æ®µåŸºå€ï¼Œç°åœ¨é€šè¿‡å€ŸåŠ©ä¸­é—´é¡¹ (GDTR) ï¼Œç”±å…¨å±€æè¿°ç¬¦è¡¨çš„æ¯ä¸€ä¸ªè¡¨é¡¹æ¥è¡¨ç¤ºæ¯ä¸€ä¸ªå†…å­˜æ®µåŸºå€ï¼Œä»è€Œè¾¾åˆ°åœ¨æœ€å¤§ 4GB çš„å†…å­˜ä¸­è¿›è¡Œå†…å­˜åœ°å€çš„å¯»å€ã€‚</p>\n<p>è€Œä¸ä¸Šé¢çš„ä¸­æ–­æè¿°ç¬¦è¡¨ç±»ä¼¼çš„ï¼Œå…¨å±€æè¿°ç¬¦è¡¨ä¹Ÿæ˜¯ä»¥åŒæ ·çš„æ–¹å¼ï¼Œé¢„å…ˆå†™å¥½ï¼Œç„¶åè®¾ç½®ä¸€ä¸‹ GDTR å°± OK äº†ã€‚</p>\n<p><strong>è½¬å…¥æ“ä½œç³»ç»Ÿç¨‹åº</strong></p>\n<p>æœ€åçš„æœ€åï¼Œå½“ç„¶æ˜¯æŠŠæ§åˆ¶æƒäº¤ç»™æ“ä½œç³»ç»Ÿç¨‹åºã€‚å³è·³è½¬åˆ°å†…å­˜ 0x00000 å¤„ã€‚å½“ç„¶ï¼Œç”±äºç°åœ¨å·²ç»å¤„äºä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œå› æ­¤ jmp æŒ‡ä»¤ç•¥æœ‰ä¸åŒã€‚ ä¸º <code>jmpi 0, 8</code>ã€‚</p>\n<p>ç®€å•è§£é‡Šä¸€ä¸‹è¿™ä¸€æ¡æŒ‡ä»¤ </p>\n<p><code>jmpi</code> æŒ‡ä»¤è¡¨ç¤ºè¿›è¡Œæ®µé—´è·³è½¬ã€‚(æ®µé—´è·³è½¬ä¸æ®µå†…è·³è½¬çš„åŒºåˆ«åœ¨äº: ç¨‹åºä»£ç çš„å¯»å€ä¸€èˆ¬é€šè¿‡ CS:IP é…åˆå®Œæˆï¼Œå¦‚æœæ˜¯æ®µå†…è·³è½¬ï¼Œåˆ™æ®µåŸºå€ä¸å˜ï¼Œå³ CS ä¸å˜ï¼Œåªéœ€è¦ç»™å‡º IP å³å¯ï¼›è€Œæ®µé—´è·³è½¬éœ€è¦åŒæ—¶ç»™å‡ºæ–°çš„æ®µåŸºå€(CS)å’Œæ–°çš„æ®µåç§»(IP)ã€‚</p>\n<p><code>0</code> è¿™é‡Œ 0 å°±è¡¨ç¤ºçš„æ˜¯æ®µåç§»ã€‚</p>\n<p><code>8</code> ä¿æŠ¤æ¨¡å¼ä¸‹çš„æ®µå¯„å­˜å™¨ä»¥ä¸€ç§ç‰¹æ®Šçš„æ–¹å¼æ¥é…åˆ GDTR/LDTR æ¥å®Œæˆå¯¹å…¨å±€/å±€éƒ¨æè¿°ç¬¦è¡¨é¡¹çš„å®šä½ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æœ€åä¸¤ä½è¡¨ç¤ºç‰¹æƒçº§ï¼Œç”¨äºåŒºåˆ†ç”¨æˆ·æ€(11) or å†…æ ¸æ€(00) (Linux åªä½¿ç”¨äº†ä¸¤ä¸ªï¼Œè¿˜æœ‰ 01 å’Œ 10 ä¸ä½¿ç”¨)</p>\n<p>ç¬¬ä¸‰ä½è¡¨ç¤ºä½¿ç”¨ GDTR è¿˜æ˜¯ LDTR</p>\n<p>é«˜ 13 ä½å…±åŒç»„æˆäº†å¯¹ GDTR/LDTR è¡¨é¡¹çš„æè¿°ï¼Œç©¶ç«Ÿä½¿ç”¨å“ªä¸€ä¸ªè¡¨é¡¹ã€‚å½“ç„¶ï¼Œè¿™é‡Œå…¶å®ä¹Ÿä¾§é¢åæ˜ äº†ï¼Œå…¶å®æ¯ä¸ªå…¨å±€æè¿°ç¬¦è¡¨/å±€éƒ¨æè¿°ç¬¦è¡¨æœ€å¤šåªèƒ½æœ‰ $2^{13} = 8192$ ä¸ªè¡¨é¡¹ã€‚</p>\n<p><img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fulm7vumywj31220aw74f.jpg"></p>\n<h2>æ“ä½œç³»ç»Ÿç¨‹åº</h2>\n<p>ç»ˆäºè¦åˆ°æ“ä½œç³»ç»Ÿç¨‹åºäº†ã€‚è¿™ä¸ªå°±æ¯”è¾ƒå¤æ‚äº†ã€‚è¿™é‡Œåªç®€å•æè¿°å°†æ“ä½œç³»ç»Ÿå¯åŠ¨èµ·æ¥çš„æœ€åŸºæœ¬ä½¿ç”¨åˆ°çš„ä»£ç ã€‚å…¶å®ƒä»¥åç»§ç»­ã€‚</p>\n<p>å…¶å®æ•´ä¸€ä¸ªæ“ä½œç³»ç»Ÿç¨‹åºæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é‡ï¼Œæ¯•ç«Ÿæœ€å¤§èƒ½å¤Ÿè¾¾åˆ° 512 KB å‘¢ã€‚</p>\n<p>ç®€å•çš„çœ‹ä¸€ä¸‹æ–‡æ¡£æ ‘ï¼Œè§é™„å½•ä¸€ï¼Œç¼–è¯‘å‰çš„æºä»£ç æ–‡ä»¶æ€»è®¡ 100 å¤šä¸ªã€‚</p>\n<p>é¦–å…ˆè¢«æ‰§è¡Œçš„æ˜¯ head.s ä¸­çš„ä»£ç ï¼Œè¿™é‡Œå®Œæˆçš„å·¥ä½œä¸»è¦åŒ…æ‹¬:</p>\n<ol>\n<li>\n<p>é‡æ–°ç¼–åˆ¶æ¯ä¸ªä¸­æ–­çš„å…·ä½“å¤„ç†ä»£ç (è¿™ä¸ªåº”è¯¥æ¯”è¾ƒå¥½ç†è§£ï¼Œè¯´åˆ°åº•ä¸­æ–­å‡ºç°äº†ï¼Œä¹Ÿè¿˜æ˜¯è¦é€šè¿‡å®ç°ä»£ç æ¥å®Œæˆä¸­æ–­é€»è¾‘ã€‚ä¸è®ºæ˜¯ BIOS ä¸­æ–­å‘é‡è¿˜æ˜¯ä¿æŠ¤æ¨¡å¼ä¸‹ä½¿ç”¨çš„ä¸­æ–­æè¿°ç¬¦è¡¨ï¼Œéƒ½ä¸è¿‡æ˜¯è®°å½•äº†ä¸€ä¸‹ä¸­æ–­å¤„ç†ä»£ç çš„ä½ç½®ï¼Œè¿›è¡Œäº†å®šä½è€Œå·²)ã€‚</p>\n</li>\n<li>\n<p>åˆå§‹åŒ–åˆ†é¡µæ¨¡å¼(ä¸è¯¦è¿°ï¼Œä»¥åæœ‰æœºä¼šåœ¨è¯´)</p>\n</li>\n<li>\n<p>éªŒè¯ 80387 æ•°å­¦åå¤„ç†å™¨ã€‚</p>\n</li>\n<li>\n<p>è¿›å…¥ main.c ç¨‹åº (æ—¢ç„¶ Linus éƒ½å°†å…¶å‘½åä¸º main äº†ï¼Œé‚£ä¹ˆæ˜¾ç„¶è¿™æ˜¯æ•´ä¸ªæ“ä½œç³»ç»Ÿæœ€æ ¸å¿ƒçš„éƒ¨åˆ†äº†)ã€‚</p>\n</li>\n</ol>\n<h3>main.c</h3>\n<p>ä¸‹é¢å°†ç®€å•ç»™å‡º main.c ç¨‹åºçš„ä¸¤æ®µä»£ç  <code>main(...)</code> å’Œ <code>init(...)</code>ï¼Œå¹¶ç›´æ¥é’ˆå¯¹ä»£ç è¿›è¡Œç›´æ¥è§£é‡Šã€‚</p>\n<h4>main(void)</h4>\n<pre><code class="language-c">void main(void)     \n{\n    ROOT_DEV = ORIG_ROOT_DEV;   // è¯»å–åœ¨å¼•å¯¼ç¨‹åºæ‰§è¡Œæ—¶è·å–åˆ°çš„æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨çš„ç£ç›˜\n    drive_info = DRIVE_INFO;\n    memory_end = (1&#x3C;&#x3C;20) + (EXT_MEM_K&#x3C;&#x3C;10); // é¦–å…ˆå…ˆç¡®è®¤æ•´ä¸ªå†…å­˜çš„å¤§å°\n    memory_end &#x26;= 0xfffff000;               // å½“ç„¶ï¼Œè¿™é‡Œä¸ºäº†åˆ†é¡µæ–¹ä¾¿ (æ¯é¡µ 4096 B)ï¼Œç›´æ¥å°†ä¸æ»¡ä¸€é¡µçš„å†…å­˜å¿½ç•¥æ‰äº†\n    if (memory_end > 16*1024*1024)          // æœ€å¤§æ”¯æŒ 16 MB çš„å†…å­˜ï¼Œè¿™é‡Œæ˜¯ Linus å½“æ—¶çš„æœºå™¨åªæœ‰ 16 MBï¼Œå› æ­¤æ²¡æœ‰åšæ›´å¤§å†…å­˜çš„æ”¯æŒï¼Œä½†å¯ä»¥è‡ªå·±å»æ”¹æºç \n        memory_end = 16*1024*1024;\n    if (memory_end > 12*1024*1024)          // ç¡®è®¤ç¼“å­˜åŒºçš„æœ«åœ°å€ (æ ¹æ®å®é™…å†…å­˜å¤§å°è°ƒæ•´, >12MB ç•™ 4MB ç¼“å­˜ï¼Œ>6MB ç•™ 2 MB ç¼“å­˜ï¼Œå¦åˆ™ 1MB )\n        buffer_memory_end = 4*1024*1024;\n    else if (memory_end > 6*1024*1024)\n        buffer_memory_end = 2*1024*1024;\n    else\n        buffer_memory_end = 1*1024*1024;\n    main_memory_start = buffer_memory_end;\n#ifdef RAMDISK\n    main_memory_start += rd_init(main_memory_start, RAMDISK*1024);      // å¦‚æœéœ€è¦è™šæ‹Ÿç›˜ï¼Œåˆ™å†ç•™ä¸€éƒ¨åˆ†ä½œä¸ºäº¤æ¢åŒº\n#endif\n    mem_init(main_memory_start,memory_end); // å†…å­˜åˆå§‹åŒ–ï¼Œæ¯•ç«Ÿ Linux æ“ä½œç³»ç»Ÿä¸‹çš„æ‰€æœ‰å†…å­˜éƒ½å°†è¢«ç»Ÿä¸€åˆ†é…ï¼Œç”¨æˆ·ç¨‹åºæ²¡æœ‰æƒé™éšä¾¿ä½¿ç”¨å†…å­˜ï¼Œåªèƒ½ç”¨è¢«åˆ†é…çš„\n    trap_init();            // åˆå§‹åŒ–ä¸­æ–­\n    blk_dev_init();         // åˆå§‹åŒ–å—è®¾å¤‡\n    chr_dev_init();         // åˆå§‹åŒ–å­—ç¬¦è®¾å¤‡\n    tty_init();             // åˆå§‹åŒ– tty\n    time_init();            // è®¾ç½®å¼€æœºå¯åŠ¨æ—¶é—´\n    sched_init();           // åˆå§‹åŒ–ä»»åŠ¡è°ƒåº¦ç¨‹åºï¼Œç”±æ­¤å°±å°†å¯ä»¥è¿›è¡Œå¤šä»»åŠ¡åˆ‡æ¢äº†\n    buffer_init(buffer_memory_end); // ç¼“å­˜åŒºåˆå§‹åŒ–\n    hd_init();              // ç¡¬ç›˜åˆå§‹åŒ–\n    floppy_init();          // è½¯ç›˜åˆå§‹åŒ–\n    sti();                  // ä¸å†ç¦æ­¢ä¸­æ–­ï¼Œç°åœ¨å¼€å§‹åˆå…è®¸ä¸­æ–­äº†\n    move_to_user_mode();    // è¿›å…¥ç”¨æˆ·æ€\n    if (!fork()) {          // å…³äº fork å‡½æ•°ï¼Œä¸‹é¢å°†ç®€å•ä»‹ç»ã€‚\n        init();\n    }\n\n    for(;;) pause();\n}\n</code></pre>\n<p><strong>fork()</strong></p>\n<p>å¦‚æœç†Ÿæ‚‰ C è¯­è¨€ï¼Œåº”è¯¥å¯¹ fork() ä¹Ÿæ¯”è¾ƒç†Ÿæ‚‰å§ã€‚è¿™å°†æ‰§è¡Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ä»»åŠ¡ (è¿™é‡Œå°†åŸæ¥çš„æ“ä½œç³»ç»Ÿç¨‹åºè®¤ä¸ºæ˜¯ 0 å·è¿›ç¨‹/ä»»åŠ¡ï¼Œå°†äº§ç”Ÿ 1 å·è¿›ç¨‹/ä»»åŠ¡)ã€‚æ–°çš„ä»»åŠ¡ä¸åŸæœ‰ä»»åŠ¡å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œé™¤äº† fork() è°ƒç”¨çš„è¿”å›å€¼ä¸åŒã€‚å­ä»»åŠ¡å°†è¿”å› 0 ï¼ŒåŸæœ‰ä»»åŠ¡å°†è¿”å›å­ä»»åŠ¡çš„ä»»åŠ¡å·ã€‚</p>\n<p>å› æ­¤ï¼Œå¯¹äºä¸Šé¢çš„ä»£ç ï¼Œ<code>if(!fork())</code> ï¼Œ0å·ä»»åŠ¡å°†ä¸æ‰§è¡Œ <code>if(){}</code> è¯­å¥å—å†…çš„ init ï¼Œè€Œ 1 å·ä»»åŠ¡å°†æ‰§è¡Œ <code>init()</code> å‡½æ•°</p>\n<p>è€Œ 0 å·è¿›ç¨‹åœ¨åšä»€ä¹ˆå‘¢? </p>\n<p>å¾ˆç®€å•ï¼Œä¸‹é¢ <code>for(;;) pause();</code>ã€‚ <code>pause()</code> æ˜¯æŒ‡è®© CPU å®Œå…¨åœæ­¢ï¼Œåªæœ‰å‘ç”Ÿç¡¬ä»¶ä¸­æ–­ï¼Œ CPU æ‰ä¼šä»åœæ­¢çŠ¶æ€ä¸­æ¢å¤ (å‰é¢å·²ç»è®¾ç½®äº†å®šæ—¶çš„/ 10ms/æ¬¡çš„æ—¶é’Ÿä¸­æ–­ï¼Œå› æ­¤ CPU æ€»æ˜¯èƒ½å¤Ÿæ¢å¤)ï¼Œ </p>\n<p>å…·ä½“çš„æè¿°å°±æ˜¯ï¼Œå¦‚æœä»»åŠ¡è°ƒåº¦ç¨‹åºæŠŠæ—¶é—´ç‰‡åˆ†é…ç»™äº† 0 å·è¿›ç¨‹ï¼Œé‚£ä¹ˆ 0 å·è¿›ç¨‹å”¯ä¸€åšçš„ï¼Œå°±æ˜¯è®© CPU åœæ­¢ã€‚è€Œä¸” 0 å·è¿›ç¨‹çš„ <code>for</code> æ˜¯æ­»å¾ªç¯ï¼Œæ¯æ¬¡æŠŠæ—¶é—´åˆ†é…ç»™ 0 å·è¿›ç¨‹ï¼Œå®ƒå°± CPU åœæ­¢ã€‚æˆ‘ä»¬åœ¨ Linux æ“ä½œç³»ç»Ÿä¸Šï¼Œé€šè¿‡ top å¯ä»¥çœ‹åˆ°å¯¹ cpu æœ‰å¦‚ä¸‹æè¿°</p>\n<pre><code>%Cpu(s):  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n</code></pre>\n<p>å…¶ä¸­å¯¹ idle(id) çš„ç»Ÿè®¡ï¼Œå…¶å®å°±åœ¨ 0 å·ä»»åŠ¡è®© cpu åœæ­¢å·¥ä½œäº†è€Œå·²ã€‚</p>\n<h4>init(void)</h4>\n<pre><code class="language-c">void init(void)\n{\n    int pid,i;\n\n    setup((void *) &#x26;drive_info);\n    (void) open("/dev/tty0",O_RDWR,0);\n    (void) dup(0);\n    (void) dup(0);\n    printf("%d buffers = %d bytes buffer space\\n\\r",NR_BUFFERS,\n        NR_BUFFERS*BLOCK_SIZE);\n    printf("Free mem: %d bytes\\n\\r",memory_end-main_memory_start);\n    if (!(pid=fork())) {\n        close(0);\n        if (open("/etc/rc",O_RDONLY,0))\n            _exit(1);\n        execve("/bin/sh",argv_rc,envp_rc);\n        _exit(2);\n    }\n    if (pid>0)\n        while (pid != wait(&#x26;i))\n            /* nothing */;\n    while (1) {\n        if ((pid=fork())&#x3C;0) {\n            printf("Fork failed in init\\r\\n");\n            continue;\n        }\n        if (!pid) {\n            close(0);close(1);close(2);\n            setsid();\n            (void) open("/dev/tty0",O_RDWR,0);\n            (void) dup(0);\n            (void) dup(0);\n            _exit(execve("/bin/sh",argv,envp));\n        }\n        while (1)\n            if (pid == wait(&#x26;i))\n                break;\n        printf("\\n\\rchild %d died with code %04x\\n\\r",pid,i);\n        sync();\n    }\n    _exit(0);   /* NOTE! _exit, not exit() */\n}\n</code></pre>\n<p>é‚£ä¹ˆ 1 å·ä»»åŠ¡åœ¨åšä»€ä¹ˆå‘¢ï¼Ÿçœ‹ init çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å¤§é‡è¯¸å¦‚ <code>/dev/tty0</code>, <code>/bin/sh</code> çš„ä»£ç ã€‚å“ˆå“ˆï¼Œä¸‹é¢é€šè¿‡ 1,2,3... å¯¹æ­¥éª¤è¿›è¡Œæ ‡å·ç®€å•æè¿°ä¸€ä¸‹ã€‚</p>\n<ol>\n<li>\n<p>1 å·è¿›ç¨‹åœ¨åšçš„æ˜¯ fork å‡ºæ–°çš„è¿›ç¨‹(æš‚æ—¶å«å®ƒè¿›ç¨‹ X )</p>\n</li>\n<li>\n<p>1 å·è¿›ç¨‹ä¸æ–­è¯¢é—® X æ˜¯å¦è¢«é”€æ¯ </p>\n<ul>\n<li>å¦‚æœ X è¿›ç¨‹è¢«é”€æ¯äº†ï¼šé‚£ä¹ˆç»§ç»­æ‰§è¡Œæ­¥éª¤ 1</li>\n<li>å¦åˆ™ï¼šç»§ç»­æ‰§è¡Œæ­¥éª¤ 2 ï¼ˆä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸æ–­å¾ªç¯å‘¢ï¼Ÿå…¶å®ç”±äºä»»åŠ¡è°ƒåº¦ç¨‹åºçš„å­˜åœ¨ï¼Œåœ¨å•ä¸ª CPU çœ‹æ¥ï¼Œè¿™ä¸ªè½®è¯¢å¹¶ä¸ä¸€ç›´å‘ç”Ÿï¼Œæœ‰ä¸€äº›æ—¶é—´ç‰‡å·²ç»ç»™äº†å…¶ä»–è¿›ç¨‹ç»§ç»­æ‰§è¡Œä»»åŠ¡äº†</li>\n</ul>\n</li>\n<li>\n<p>X ä»»åŠ¡é€šè¿‡è°ƒç”¨ <code>execve()</code> æŠŠå½“å‰ç¨‹åºçš„ä»£ç +æ•°æ®å…¨éƒ¨æ›¿æ¢æˆæ˜¯ shell çš„ (å…¶å®å¤§é‡çš„ç”¨æˆ·ç¨‹åºéƒ½æ˜¯é€šè¿‡è¿™ç§ fork + execve çš„å½¢å¼å‡ºç°çš„)</p>\n</li>\n<li>\n<p>X ä»»åŠ¡(ä¹Ÿå°±æ˜¯ Shell ç¨‹åº) å¼€å§‹é€šè¿‡ tty ä¸ç”¨æˆ·å¼€å§‹äº¤äº’ã€‚ç›´åˆ°ç”¨æˆ·é€‰æ‹© <code>exit</code> é€€å‡º shell </p>\n</li>\n</ol>\n<p><strong>execve(...)</strong></p>\n<p>å‰é¢ä»‹ç»è¿‡ fork æ˜¯å¤åˆ¶ä¸€ä»½ç¨‹åºçš„å„ä¸ªå¯„å­˜å™¨çš„çŠ¶æ€ + ç¨‹åºçš„æ•°æ®ã€‚ç°åœ¨ execve åšå‡ºçš„æ“ä½œæ˜¯ç›´æ¥å°†å½“å‰ç¨‹åºçš„ä»£ç å’Œæ•°æ®æ›¿æ¢æˆç›®æ ‡ç¨‹åºçš„ä»£ç å’Œæ•°æ®ï¼Œå¹¶é€šè¿‡å¯¹å¯„å­˜å™¨ä¸€å®šçš„é‡ç½®ï¼Œå®Œæˆä¸€ä¸ªç”¨æˆ·ç¨‹åºçš„å¯åŠ¨æµç¨‹(ç¨‹åºå¯åŠ¨è¯´åˆ°åº•ä¸å°±æ˜¯åœ¨å†…å­˜ä¸­å­˜åœ¨è¿™ä¸ªç¨‹åºçš„ä»£ç ï¼Œç„¶åé€šè¿‡ CS:IP å®šä½åˆ°å³å°†æ‰§è¡Œçš„ç¨‹åºæŒ‡ä»¤ï¼Œæœ€åè®© CPU å¼€å§‹æ‰§è¡Œå°± OK äº†)</p>\n<h2>å°ç»“</h2>\n<p>æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„å¯åŠ¨æµç¨‹å°±ç®€å•åœ°ä»‹ç»åˆ°è¿™é‡Œã€‚</p>\n<p>0 å·ä»»åŠ¡ä½œä¸ºæ“ä½œç³»ç»Ÿçš„å¸¸é©»ç¨‹åºï¼Œåœ¨ OS å¯åŠ¨å®Œæˆï¼Œæ¯æ¬¡æ—¶é—´ç‰‡è¢«åˆ†é…ç»™å®ƒï¼Œå®ƒå°±è®© CPU åœæ­¢å·¥ä½œ(é€šè¿‡ pause() ç³»ç»Ÿè°ƒç”¨)</p>\n<p>1 å·ä»»åŠ¡ä½œä¸ºæ“ä½œç³»ç»Ÿçš„å¸¸é©»ç¨‹åºï¼Œå”¯ä¸€çš„ä»»åŠ¡å°±æ˜¯åˆ¤æ–­è¿›ç¨‹Xæ˜¯å¦è¢«é€€å‡ºï¼Œå¦‚æœé€€å‡ºäº†ï¼Œå°±é‡æ–°åˆ›å»ºä¸€ä¸ª(å½“ç„¶ï¼Œä¹Ÿå¯èƒ½æœ‰äººæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆç°åœ¨çš„ Linux å¼€å¤šä¸ª bash éƒ½æ²¡æœ‰é—®é¢˜å‘¢? è¿™é‡Œæœ‰ä¸ªçŒœæµ‹æ˜¯æœ‰ä¸€ä¸ªéšè—çš„ shell æ˜¯è¢« 1 å·ä»»åŠ¡å¯åŠ¨çš„ï¼Œå…¶å®ƒçš„ bash æ˜¯å¤šä½™çš„ã€‚ä¸è¿‡è¿™åªæ˜¯çŒœæµ‹ï¼Œå¾…è€ƒå¯Ÿ)</p>\n<h2>é™„å½•</h2>\n<h3>é™„å½•ä¸€</h3>\n<pre><code>.\n|-- Makefile\n|-- boot\n|   |-- head.s\n|-- fs\n|   |-- Makefile\n|   |-- bitmap.c\n|   |-- block_dev.c\n|   |-- buffer.c\n|   |-- char_dev.c\n|   |-- exec.c\n|   |-- fcntl.c\n|   |-- file_dev.c\n|   |-- file_table.c\n|   |-- inode.c\n|   |-- ioctl.c\n|   |-- namei.c\n|   |-- open.c\n|   |-- pipe.c\n|   |-- read_write.c\n|   |-- stat.c\n|   |-- super.c\n|   `-- truncate.c\n|-- include\n|   |-- a.out.h\n|   |-- asm\n|   |   |-- io.h\n|   |   |-- memory.h\n|   |   |-- segment.h\n|   |   `-- system.h\n|   |-- const.h\n|   |-- ctype.h\n|   |-- errno.h\n|   |-- fcntl.h\n|   |-- linux\n|   |   |-- config.h\n|   |   |-- fdreg.h\n|   |   |-- fs.h\n|   |   |-- hdreg.h\n|   |   |-- head.h\n|   |   |-- kernel.h\n|   |   |-- mm.h\n|   |   |-- sched.h\n|   |   |-- sys.h\n|   |   `-- tty.h\n|   |-- signal.h\n|   |-- stdarg.h\n|   |-- stddef.h\n|   |-- string.h\n|   |-- sys\n|   |   |-- stat.h\n|   |   |-- times.h\n|   |   |-- types.h\n|   |   |-- utsname.h\n|   |   `-- wait.h\n|   |-- termios.h\n|   |-- time.h\n|   |-- unistd.h\n|   `-- utime.h\n|-- init\n|   |-- main.c\n|-- kernel\n|   |-- Makefile\n|   |-- asm.o\n|   |-- asm.s\n|   |-- blk_drv\n|   |   |-- Makefile\n|   |   |-- blk.h\n|   |   |-- floppy.c\n|   |   |-- hd.c\n|   |   |-- ll_rw_blk.c\n|   |   `-- ramdisk.c\n|   |-- chr_drv\n|   |   |-- Makefile\n|   |   |-- console.c\n|   |   |-- keyboard.S\n|   |   |-- rs_io.s\n|   |   |-- serial.c\n|   |   |-- tty_io.c\n|   |   `-- tty_ioctl.c\n|   |-- exit.c\n|   |-- fork.c\n|   |-- fork.i\n|   |-- math\n|   |   |-- Makefile\n|   |   `-- math_emulate.c\n|   |-- mktime.c\n|   |-- panic.c\n|   |-- printk.c\n|   |-- sched.c\n|   |-- sched.o\n|   |-- signal.c\n|   |-- sys.c\n|   |-- system_call.o\n|   |-- system_call.s\n|   |-- traps.c\n|   |-- traps.o\n|   `-- vsprintf.c\n|-- lib\n|   |-- Makefile\n|   |-- _exit.c\n|   |-- close.c\n|   |-- ctype.c\n|   |-- dup.c\n|   |-- errno.c\n|   |-- execve.c\n|   |-- malloc.c\n|   |-- open.c\n|   |-- setsid.c\n|   |-- string.c\n|   |-- wait.c\n|   `-- write.c\n|-- mm\n|   |-- Makefile\n|   |-- memory.c\n|   `-- page.s\n`-- tools\n    `-- build.c\n</code></pre>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}},zZw6:function(n){n.exports={data:{},messages:[],history:[],cwd:"/Users/fangfeng/MISC/blog/ffutop",contents:'<p>ç›¸æ¯”è¾ƒäºå—è®¾å¤‡ï¼Œå­—ç¬¦è®¾å¤‡æ— è®ºä»ç‰©ç†è®¤çŸ¥ä¸Šï¼ŒæŠ‘æˆ–æ˜¯ç†è®ºç†è§£ä¸Šï¼Œéƒ½å­˜åœ¨ç€ç›¸å½“å¤§çš„å…¥é—¨é—¨æ§›ã€‚ç‰¹åˆ«æ˜¯åœ¨å°†å­—ç¬¦è®¾å¤‡ä¸æ§åˆ¶å°ã€å‘½ä»¤è¡Œç»ˆç«¯æ··æ·†çš„æ—¶å€™ï¼Œå°±æ›´åŠ éš¾ä»¥è¿›è¡Œåˆ†è¾¨äº†ã€‚</p>\n<p>å›åˆ°å­—ç¬¦è®¾å¤‡æœ¬èº«ï¼Œå­—ç¬¦è®¾å¤‡ä¸å—è®¾å¤‡æœ€ä¸»è¦çš„åŒºåˆ«å°±åœ¨äºå—è®¾å¤‡å¯ä»¥éšæœºè¯»å†™ï¼Œè€Œå­—ç¬¦è®¾å¤‡åªèƒ½å¤Ÿé¡ºåºè¯»ï¼Œé¡ºåºå†™ã€‚</p>\n<p>é‚£ä¹ˆï¼Œå¸¸è§çš„å­—ç¬¦è®¾å¤‡æœ‰ä»€ä¹ˆï¼Ÿæ˜¾ç¤ºå™¨ã€é”®ç›˜ã€é¼ æ ‡ã€‚</p>\n<h2>å®è§‚æ¦‚è§ˆ</h2>\n<p>é€šå¸¸åœ¨æˆ‘ä»¬çš„è®¤è¯†ä¸­ï¼Œå‘½ä»¤è¡Œç»ˆç«¯å°±è¢«è®¤ä¸ºæ˜¯ä¸ä¸€å¥—å­—ç¬¦è®¾å¤‡ç›¸é…åˆæ¥ä½¿ç”¨çš„ã€‚å¾ˆæ­£å¸¸å˜›ã€‚æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ª Shell ï¼Œé€šè¿‡é”®ç›˜è¾“å…¥ä¸€äº›å­—ç¬¦ï¼Œé…åˆæ˜¾ç¤ºå™¨æŠŠè¿™äº›ç»è¿‡åŠ å·¥çš„å­—ç¬¦å±•ç¤ºå‡ºæ¥ã€‚</p>\n<p>é‚£ä¹ˆï¼Œæ˜¯ä¸æ˜¯å°±æ„å‘³ç€ Shell ä½œä¸ºä¸€ä¸ªä»»åŠ¡(è¿›ç¨‹)ï¼Œä»¥é”®ç›˜è®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å…¥ï¼Œä»¥æ˜¾ç¤ºè®¾å¤‡ä½œä¸ºæ ‡å‡†è¾“å‡º?</p>\n<p>çœ‹çœ‹ä¸€ä¸ª 1 å·ä»»åŠ¡ <code>/bin/bash</code> çš„æ–‡ä»¶æè¿°ç¬¦è¯´æ˜å§ã€‚</p>\n<pre><code class="language-sh">$ ls -al\ntotal 0\ndr-x------ 2 root root  0 Dec 13 23:20 .\ndr-xr-xr-x 9 root root  0 Dec 13 23:20 ..\nlrwx------ 1 root root 64 Dec 13 23:20 0 -> /dev/pts/0\nlrwx------ 1 root root 64 Dec 13 23:20 1 -> /dev/pts/0\nlrwx------ 1 root root 64 Dec 13 23:20 2 -> /dev/pts/0\nlrwx------ 1 root root 64 Dec 25 01:09 255 -> /dev/pts/0\n</code></pre>\n<p>è¿™é‡Œæ–‡ä»¶æè¿°ç¬¦ 0, 1, 2 åˆ†åˆ«è¡¨ç¤ºä»»åŠ¡çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ã€‚è¿™äº›å†…å®¹åœ¨è¡¨ç°å½¢å¼ä¸Šåšäº†ä¸€ä¸ªé“¾æ¥ã€‚</p>\n<p>é‚£ä¹ˆï¼Œ<code>/dev/pts/0</code> æ˜¯ä»€ä¹ˆ? </p>\n<pre><code class="language-sh">crw--w---- 1 root tty 136, 0 Dec 13 23:20 /dev/pts/0\n</code></pre>\n<p>ä¸€ä¸ªå­—ç¬¦è®¾å¤‡ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼Œä¼¼ä¹å’Œæœ€åˆé¢„æƒ³çš„æœ‰æ¯”è¾ƒå¤§çš„åŒºåˆ«ã€‚è‡³å°‘åœ¨å‡è±¡ä¸­ï¼Œè‡³å°‘æ˜¯ä¸€ä¸ªè¾“å…¥(é”®ç›˜)ï¼Œä¸€ä¸ªè¾“å‡º(æ˜¾ç¤ºå™¨)ã€‚æ€ä¹ˆå°±æ··æˆäº†ä¸€ä¸ªå‘¢ï¼Ÿ</p>\n<p>æœ¬æ¥æ˜¯æ€ä¹ˆéƒ½æƒ³ä¸é€šçš„ï¼Œä½†åæ¥é…åˆ"Unixä¸€åˆ‡çš†æ–‡ä»¶"çš„ä¿¡æ¡ï¼Œæ€»ç®—æ˜¯æœ‰ç‚¹æ˜ç™½äº†ã€‚</p>\n<p>ç›¸ä¿¡å¤§å®¶éƒ½æœ‰è¿™è¿™æ ·çš„ç»å†ï¼ŒæŸä¸ªç¨‹åºæ˜¯ä»¥é”®ç›˜è¾“å…¥ä½œä¸ºæ ‡å‡†è¾“å…¥çš„ã€‚å…¶å®å°±å’Œä¸Šé¢ğŸ‘†å±•ç¤ºçš„ä¸€æ · <code>0 -> /dev/pts/0</code> ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰è€ƒè™‘è¿‡è¿™æ•´å¥—æµç¨‹æ˜¯æ€ä¹ˆåä½œçš„å‘¢ï¼Ÿ</p>\n<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fyjvtjiu0zj31980oqmxe.jpg"></p>\n<p>å¯¹äºç¨‹åºæ¥è¯´ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ™®é€šçš„è°ƒç”¨ <code>read</code>, <code>write</code> ç­‰ç»è¿‡å°è£…çš„å‡½æ•°ï¼Œæ¥è¯»å–ä¸€ä¸ªæ‰€è°“çš„æ–‡ä»¶ã€‚</p>\n<p>ä½†å¯¹äºæ–‡ä»¶æ˜¯å­—ç¬¦è®¾å¤‡æ—¶ï¼Œæœ€ç»ˆè°ƒç”¨çš„å°±æ˜¯ <code>tty_read</code>, <code>tty_write</code> äº†ã€‚é€šä¿—çš„è®²ï¼Œå¤§æ¦‚ç‡çš„å°±æ˜¯é”®ç›˜ä½œä¸ºè¾“å…¥ï¼Œæ˜¾ç¤ºå™¨ä½œä¸ºè¾“å‡ºäº†ã€‚</p>\n<h2>æºç å‰–æ</h2>\n<h3>æ–‡ä»¶è¯»å†™</h3>\n<p>è¿™éƒ¨åˆ†ä¸Šä¸€ç¯‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œä¸åšè¿‡å¤šè¯´æ˜ã€‚</p>\n<p>ç®€å•å›é¡¾ä¸‹ <code>sys_read</code> å‡½æ•°</p>\n<pre><code class="language-c">int sys_read(unsigned int fd,char * buf,int count)\n{\n    struct file * file;\n    struct m_inode * inode;\n\n    if (fd>=NR_OPEN || count&#x3C;0 || !(file=current->filp[fd]))\n        return -EINVAL;\n    if (!count)\n        return 0;\n    verify_area(buf,count);\n    inode = file->f_inode;\n    if (inode->i_pipe)\n        return (file->f_mode&#x26;1)?read_pipe(inode,buf,count):-EIO;\n    /* ç¡®è®¤åˆ°ièŠ‚ç‚¹æè¿°çš„æ˜¯å­—ç¬¦è®¾å¤‡ */\n    if (S_ISCHR(inode->i_mode)) \n        return rw_char(READ,inode->i_zone[0],buf,count,&#x26;file->f_pos);\n    if (S_ISBLK(inode->i_mode))\n        return block_read(inode->i_zone[0],&#x26;file->f_pos,buf,count);\n    if (S_ISDIR(inode->i_mode) || S_ISREG(inode->i_mode)) {\n        if (count+file->f_pos > inode->i_size)\n            count = inode->i_size - file->f_pos;\n        if (count&#x3C;=0)\n            return 0;\n        return file_read(inode,file,buf,count);\n    }\n    printk("(Read)inode->i_mode=%06o\\n\\r",inode->i_mode);\n    return -EINVAL;\n}\n</code></pre>\n<p>å¯ä»¥çœ‹åˆ° <code>S_ISCHR()</code> å°±æ˜¯åœ¨å¯¹ièŠ‚ç‚¹çš„ç±»å‹è¿›è¡Œåˆ¤åˆ«ï¼Œä»è€Œè¿›è¡Œä¸åŒçš„åˆ†å‘ã€‚</p>\n<pre><code class="language-c">static crw_ptr crw_table[]={\n    NULL,       /* nodev */\n    rw_memory,  /* /dev/mem etc */\n    NULL,       /* /dev/fd */\n    NULL,       /* /dev/hd */\n    rw_ttyx,    /* /dev/ttyx */\n    rw_tty,     /* /dev/tty */\n    NULL,       /* /dev/lp */\n    NULL};      /* unnamed pipes */\n/**\n * è¿™æ®µè¿˜æ˜¯æ¶‰åŠåˆ°åˆ†å‘ï¼Œç”±ä¸åŒçš„è®¾å¤‡å·(dev) æ¥ç¡®å®šæ‰§è¡Œå‡½æ•° (ttyx, ä¸²å£ç»ˆç«¯; tty, æ§åˆ¶å°ç»ˆç«¯; mem, /dev/mem ç­‰)\n * crw_ptr æ˜¯ C è¯­è¨€ä¸­å¸¸è§çš„å‡½æ•°æŒ‡é’ˆã€‚ç”±devå·æ¥ç¡®å®šè°ƒç”¨å“ªä¸ªå‡½æ•°\n */\nint rw_char(int rw,int dev, char * buf, int count, off_t * pos)\n{\n    crw_ptr call_addr;\n\n    if (MAJOR(dev)>=NRDEVS)\n        return -ENODEV;\n    if (!(call_addr=crw_table[MAJOR(dev)]))\n        return -ENODEV;\n    return call_addr(rw,MINOR(dev),buf,count,pos);\n}\n</code></pre>\n<p>æ‰§è¡Œåˆ° <code>rw_tty</code>, <code>rw_ttyx</code> ä¸¤ä¸ªå‡½æ•°ï¼Œå°±å°†å¯¹è¯»/å†™è¿›è¡ŒåŒºåˆ†ï¼Œå¹¶ç”±ç‰¹å®šçš„å‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p>\n<pre><code class="language-c">static int rw_ttyx(int rw,unsigned minor,char * buf,int count,off_t * pos)\n{\n    return ((rw==READ)?tty_read(minor,buf,count):\n        tty_write(minor,buf,count));\n}\n\nstatic int rw_tty(int rw,unsigned minor,char * buf,int count, off_t * pos)\n{\n    if (current->tty&#x3C;0)\n        return -EPERM;\n    return rw_ttyx(rw,current->tty,buf,count,pos);\n}\n</code></pre>\n<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œåº”è¯¥èƒ½å¤ŸåŸºæœ¬äº†è§£äº†å­—ç¬¦è®¾å¤‡ï¼Œä½œä¸º Linux çš„æ–‡ä»¶ï¼Œæ‰€åº”è¯¥æœ‰çš„è¯»å†™çš„ç›¸å…³æ”¯æŒã€‚</p>\n<p>ä½†æ˜¯ï¼Œç©¶ç«Ÿè¯»ã€å†™çš„å†…å®¹åœ¨å“ªå‘¢ï¼Ÿæ¯”å¦‚æ­£è§„æ–‡ä»¶ï¼Œéƒ½å¾ˆå®¹æ˜“åœ°å¯ä»¥ç†è§£åˆ°ï¼Œå°±æ˜¯ä»ç£ç›˜ä¸­å–å‡ºæŸä¸ª/æŸå‡ ä¸ªç›˜å—çš„å†…å®¹å³å¯ã€‚å­—ç¬¦è®¾å¤‡çš„IOè¦ä»å“ªé‡Œå–(å¾€å“ªé‡Œé€)æ•°æ®å‘¢?</p>\n<h3>å­—ç¬¦è®¾å¤‡é©±åŠ¨</h3>\n<p>å¯¹äºè®¾å¤‡é©±åŠ¨è¿™ä¸ªæ¦‚å¿µï¼Œè‡³ä»Šæ²¡æœ‰ææ¸…æ¥šã€‚ä¸è¿‡ï¼Œè¿™ä¸å¦¨ç¢å¯¹ä»£ç çš„ç†è§£ã€‚åæ­£å¯¹äºå­—ç¬¦è®¾å¤‡é©±åŠ¨æ¥è¯´ï¼Œä¹Ÿå°±æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€äº›è½¯ä»¶å±‚é¢çš„ä»£ç ï¼Œä¸æ™®é€šä»£ç çš„å”¯ä¸€åŒºåˆ«ï¼Œå°±æ˜¯å¯¹å¤–è®¾ç¡¬ä»¶åšäº†ç›¸åº”çš„äº¤äº’æ”¯æŒã€‚</p>\n<p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fykyc6lo9pj31i40u0ac8.jpg"></p>\n<p>æ‰¿æ¥æ“ä½œç³»ç»Ÿçš„å­—ç¬¦è®¾å¤‡æ¥å£ï¼Œ<code>tty_read</code>ã€<code>tty_write</code> è´Ÿè´£è¯»å…¥å’Œå†™å‡ºã€‚</p>\n<p>ä»å“ªé‡Œè¯»ï¼Ÿ<code>secondary</code> æ•°æ®é˜Ÿåˆ—ï¼›å¾€å“ªé‡Œå†™ï¼Ÿ<code>write_q</code> æ•°æ®é˜Ÿåˆ—ã€‚</p>\n<p>åŒæ—¶ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œä¸è¿™äº›é˜Ÿåˆ—ç›´æ¥ç›¸å…³çš„ï¼Œå°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„é”®ç›˜å’Œæ˜¾ç¤ºå™¨äº†ã€‚æ˜¯ä¸æ˜¯æœ‰äº†ç‚¹è±ç„¶å¼€æœ—çš„æ„Ÿè§‰ã€‚</p>\n<p>å¥½ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™é‡Œæè¿°çš„ä¸‰ä¸ªé˜Ÿåˆ—ç©¶ç«Ÿæ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚è¿™é‡Œå°±ä¸å¾—ä¸å…ˆçœ‹çœ‹å†…å­˜ä¸­æŠ½è±¡å‡ºæ¥çš„æè¿°ç»ˆç«¯çš„æ•°æ®ç»“æ„ <code>tty_struct</code>ã€‚</p>\n<pre><code class="language-c">/**\n * copied from include/linux/tty.h\n */\nstruct tty_struct {\n    struct termios termios;     /* terminal IO conf */\n    int pgrp;                   /* æ‰€å±è¿›ç¨‹ç»„ */\n    int stopped;                /* åœæ­¢æ ‡å¿— */\n    void (*write)(struct tty_struct * tty); /* ç»ˆç«¯å†™å‡½æ•°æŒ‡é’ˆ */\n    struct tty_queue read_q;    /* ç»ˆç«¯è¯»é˜Ÿåˆ— */\n    struct tty_queue write_q;   /* ç»ˆç«¯å†™é˜Ÿåˆ— */\n    struct tty_queue secondary; /* ç»ˆç«¯è¾…åŠ©é˜Ÿåˆ— */\n};\n\n/**\n * copied from include/termios.h\n */\nstruct termios {                /* terminal IO å±æ€§ */\n    unsigned long c_iflag;      /* input mode flags */\n    unsigned long c_oflag;      /* output mode flags */\n    unsigned long c_cflag;      /* control mode flags */\n    unsigned long c_lflag;      /* local mode flags */\n    unsigned char c_line;       /* line discipline */\n    unsigned char c_cc[NCCS];   /* control characters */\n};\n\n/**\n * copied from include/linux/tty.h\n */\nstruct tty_queue {\n    unsigned long data;         /* å­—ç¬¦è¡Œæ•°é‡ | ä¸²å£ç»ˆç«¯åˆ™å­˜å‚¨ç«¯å£å· */\n    unsigned long head;         /* å¤´æŒ‡é’ˆ */\n    unsigned long tail;         /* å°¾æŒ‡é’ˆ */\n    struct task_struct * proc_list; /* ç­‰å¾…è¯¥ç»ˆç«¯çš„ä»»åŠ¡é˜Ÿåˆ— */\n    char buf[TTY_BUF_SIZE];     /* é˜Ÿåˆ—çš„ç¼“å†²åŒº */\n};\n</code></pre>\n<p>å¯¹äºä»»ä½•ä»»åŠ¡éœ€è¦è¯»å†™å­—ç¬¦è®¾å¤‡(è¿™é‡ŒæŒ‡ç»ˆç«¯è®¾å¤‡)ï¼Œæœ€ç»ˆç›´æ¥è¯»å–/å†™å…¥åˆ°çš„å°±æ˜¯ <code>secondary</code> å’Œ <code>write_q</code>ã€‚</p>\n<hr>\n<p>è¿™é‡Œå¯èƒ½æœ‰ä¸ªå°å°çš„ç–‘é—®? ä¸ºä»€ä¹ˆè¯»ç»ˆç«¯è®¾å¤‡ä¸æ˜¯è¯» <code>read_q</code> å‘¢ï¼Ÿ</p>\n<p>å…¶å®ä¹Ÿæ¯”è¾ƒå¥½è§£é‡Šï¼Œç›¸ä¿¡æ—¥å¸¸åœ¨æ“ä½œå‘½ä»¤è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨é”®ç›˜ä¸Šæ•²å‡»çš„é”®ä½ä¸æ˜¾ç¤ºå™¨ä¸Šå®é™…å±•ç¤ºçš„å†…å®¹æ˜¯ä¸ç›¸åŒ¹é…çš„ã€‚æœ€æ™®é€šçš„ï¼Œæˆ‘ä»¬é”®å…¥äº† <strong>delete(åˆ é™¤é”®)</strong>ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯ä¸€ä¸ª <strong>delete</strong> å¯¹åº”çš„ ascii (å½“ç„¶ï¼Œè¿™é‡Œè¯·å…ˆå¿½è§†éæ‰“å°å­—ç¬¦çš„é—®é¢˜)ï¼Œè€Œæ˜¯åˆ é™¤äº†æœ€åä¸€ä¸ªå­—ç¬¦å‘¢ï¼Ÿå®Œå…¨å¯ä»¥æƒ³è±¡ï¼Œåæ­£ä»»ä½•é”®ä½ä¸é©±åŠ¨äº¤äº’çš„æ—¶å€™éƒ½æ˜¯ä¼ å…¥ä¸€ä¸²äºŒè¿›åˆ¶ç å˜›ã€‚</p>\n<p>è¿™é‡Œçš„ <code>secondary</code> å®Œæˆçš„å°±æ˜¯æ€ä¹ˆä¸€ä¸ªå·¥ä½œï¼Œ<code>read_q</code> å­˜å‚¨çš„æ˜¯æ‰€æœ‰çš„å¤–è®¾(è¿™é‡Œæ˜¯é”®ç›˜)çš„è¾“å…¥ï¼Œå¹¶åŸæ ·å­˜å‚¨ã€‚è€Œåˆ°äº† <code>secondary</code> å°±æ˜¯ç»è¿‡ç›¸åº”çš„åŠ å·¥ï¼Œè¯¸å¦‚æ§åˆ¶å­—ç¬¦ä¹‹ç±»çš„éƒ½å±•ç°äº†å„è‡ªçš„æ„ä¹‰ï¼Œå¹¶å®Œæˆä¸€äº›åŠ å·¥å·¥ä½œï¼Œè€Œä¸å†ä»…ä»…åªæ˜¯æ™®é€šåœ°å±•ç¤ºäº†ã€‚</p>\n<hr>\n<p>å¦å¤–ï¼Œå¯èƒ½è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚è™½ç„¶æˆ‘ä»¬å·²ç»ä¹ æƒ¯äº†åœ¨å‘½ä»¤è¡Œäº¤äº’æ—¶ï¼Œæ‰€æœ‰çš„è¾“å…¥éƒ½å°†ç›´æ¥åœ¨æ˜¾ç¤ºå™¨ä¸Šè¿›è¡Œå±•ç¤ºï¼Œå¥½åƒæˆ‘ä»¬åœ¨ç›´æ¥å¾€æ˜¾ç¤ºå™¨ä¸Šå†™å†…å®¹ã€‚ä½†æ˜¯ï¼Œå‰é¢æˆ‘ä»¬æè¿°çš„å†…å®¹éƒ½æ˜¯ï¼Œé”®ç›˜è®¾å¤‡ä½œä¸ºè¾“å…¥ï¼Œæ˜¯è¦å†™åˆ° <code>read_q</code> ä¹ƒè‡³ <code>secondary</code> å¹¶æœ€ç»ˆä½œä¸ºè¿›ç¨‹çš„è¾“å…¥çš„ã€‚åœ¨æ˜¾ç¤ºå™¨ä¸Šæ˜¾ç¤ºå¹¶ä¸æ˜¯å®ƒæœ¬æ¥åº”è¯¥å¹²çš„äº‹æƒ… (æ¯”è¾ƒæ˜¾ç¤ºå™¨ä¸Šå±•ç¤ºçš„åº”è¯¥æ˜¯ <code>write_q</code> çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹çš„æ ‡å‡†è¾“å‡º)</p>\n<p>äº‹å®ä¸Šï¼Œè¿™ä»…ä»…åªæ˜¯ä¸€ä¸ªå›æ˜¾ï¼Œå°† <code>secondary</code> é˜Ÿåˆ—çš„å†…å®¹å¤åˆ¶äº†ä¸€ä»½åˆ°å†™é˜Ÿåˆ—ï¼Œä¹Ÿå°±å‘ˆç°å‡ºè®©æ˜¾ç¤ºå™¨æ‰“å°ç›¸åº”é”®ç›˜è¾“å…¥çš„æ•ˆæœäº†ã€‚</p>\n<p>åŒæ—¶ï¼Œè¿™ä¹Ÿå°±èƒ½å¤Ÿç›´æ¥è§£é‡Šä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä½¿ç”¨ <code>passwd</code>, <code>su</code>, <code>sudo</code> ç­‰å‘½ä»¤æ—¶ï¼Œè¦æ±‚è¾“å…¥å¯†ç éƒ½æ˜¯ä¸åœ¨æ˜¾ç¤ºå™¨ä¸Šå›æ˜¾çš„ã€‚å®ç°ä¹Ÿç›¸å½“ç®€å•äº†å˜›ã€‚æŠŠ tty_struct.termios çš„ç›¸åº”æ§åˆ¶å±æ€§ (ECHO) é‡ç½®ï¼Œå°±å¯ä»¥å®ç°ä¸å›æ˜¾çš„æ•ˆæœäº†ã€‚</p>\n<h3>ç»ˆç«¯è®¾å¤‡äº¤äº’</h3>\n<p>æœ€åä¸€éƒ¨åˆ†ï¼Œåº”è¯¥ä¹Ÿæ˜¯æœ€å…³å¿ƒçš„äº†ã€‚å¤–è®¾å¦‚ä½•ä¸æ“ä½œç³»ç»Ÿå®Œæˆäº¤äº’ã€‚å…¶å®ä¹Ÿèƒ½å¤Ÿæƒ³å¾—åˆ°äº†â€”â€”ä¸­æ–­ã€‚</p>\n<p>åœ¨æ“ä½œç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œå°±æŠŠä¸­æ–­æè¿°ç¬¦è¡¨çš„ä¸­æ–­è¡¨é¡¹é…ç½®å¾—å½“ã€‚ä¹‹åçš„äº‹æƒ…å°±æ˜¯ç­‰å¾…é”®ç›˜ç­‰å¤–è®¾è¾“å…¥çš„ä¸­æ–­ä¿¡å·äº†ã€‚</p>\n<p>åˆçœ‹å›åˆ°äº† <code>init/main.c</code> ç¨‹åº</p>\n<pre><code class="language-c">void main(void)\n{\n    ...\n    trap_init();\n    blk_dev_init();\n    chr_dev_init(); /* å—è®¾å¤‡ç›¸å…³åˆå§‹åŒ–, æ–¹æ³•ä½“æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰å®ç° */\n    tty_init();     /* tty ç»ˆç«¯è®¾å¤‡åˆå§‹åŒ– */\n    time_init();\n    sched_init();\n    buffer_init(buffer_memory_end);\n    ...\n}\n</code></pre>\n<pre><code>/**\n * Copied from kernel/chr_drv/tty_io.c\n * ç»ˆç«¯è®¾å¤‡åˆè¯†åŒ–\n */\nvoid tty_init(void)\n{\n    /** ä¸²å£è®¾å¤‡åˆå§‹åŒ– */\n    rs_init();\n    /** æ§åˆ¶å°è®¾å¤‡åˆå§‹åŒ– */\n    con_init();\n}\n</code></pre>\n<p>è‡³äºä¸ºä»€ä¹ˆæœ‰ä¸¤ç§åˆå§‹åŒ–æ–¹å¼ã€‚è¿™æ¥æºäºç»ˆç«¯åˆåŒºåˆ†ä¸ºæ§åˆ¶å°ç»ˆç«¯ä¸ä¸²å£ç»ˆç«¯ï¼ŒåŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯ç›´æ¥å»ºç«‹åœ¨ä¸»æœºä¸Šï¼Œä¸²å£ç»ˆç«¯æ˜¯é€šè¿‡ä¸²è¡Œæ¥å£è¿æ¥åˆ°ä¸»æœºçš„ã€‚å½“ç„¶ï¼Œè¿™éƒ½æ˜¯å¤è€çš„æ–¹å¼äº†ï¼Œç»†èŠ‚å°±ä¸å¤ªæ¸…æ¥šäº†ã€‚</p>\n<p>ä¸‹é¢æ¥çœ‹çœ‹ <code>con_init()</code> åšäº†å“ªäº›å·¥ä½œ(<code>rs_init()</code> çš„å†…å®¹è¯·è‡ªè¡Œäº†è§£)</p>\n<pre><code class="language-c">void con_init(void)\n{\n    register unsigned char a;\n    char *display_desc = "????";\n    char *display_ptr;\n\n    /**\n     * è¯»å– setup.s ç¨‹åºé¢„å¤„ç†çš„å†…å®¹\n     * åŒ…æ‹¬æ˜¾ç¤ºå™¨çš„å„ç§é…ç½®å‚æ•°\n     */\n    video_num_columns = ORIG_VIDEO_COLS;\n    video_size_row = video_num_columns * 2;\n    video_num_lines = ORIG_VIDEO_LINES;\n    video_page = ORIG_VIDEO_PAGE;\n    video_erase_char = 0x0720;\n\n    /**\n     * è¯»å–æ˜¾ç¤ºå™¨çš„é…ç½®å¹¶è¿›è¡Œç›¸å…³è®¾ç½® (çœç•¥ä»£ç )\n     */\n    ...\n\n    origin  = video_mem_start;\n    scr_end = video_mem_start + video_num_lines * video_size_row;\n    top = 0;\n    bottom  = video_num_lines;\n\n    gotoxy(ORIG_X,ORIG_Y);\n    /** è®¾ç½®é™·é˜±é—¨ */\n    set_trap_gate(0x21,&#x26;keyboard_interrupt);\n    outb_p(inb_p(0x21)&#x26;0xfd,0x21);\n    a=inb_p(0x61);\n    outb_p(a|0x80,0x61);\n    outb(a,0x61);\n}\n</code></pre>\n<p>åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°æœ€é‡è¦çš„å†…å®¹å°±æ˜¯<strong>è®¾ç½®é”®ç›˜ä¸­æ–­é™·é˜±é—¨</strong>äº†ã€‚</p>\n<p>ä¹‹ååªæœ‰é™é™åœ°ç­‰å¾…é”®ä½æ•²å‡»ï¼Œä¹Ÿå°±èƒ½å¤Ÿäº§ç”Ÿç¡¬ä»¶ä¸­æ–­ï¼Œä»è€Œè®© <code>read_q</code> è·å¾—åˆ°ç›¸åº”çš„å­—ç¬¦è¾“å…¥ã€‚</p>\n<p>è‡³äºé”®ç›˜ä¸­æ–­çš„ç›¸åº”å¤„ç†æµç¨‹ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚ç®€è¿°ä¸€äº›æ­¥éª¤:</p>\n<ol>\n<li>\n<p>äº§ç”Ÿç¡¬ä¸­æ–­ <code>keyboard_interrupt</code>ï¼Œç”±ç¨‹åº <code>Keyboard.s</code> çš„æ±‡ç¼–ä»£ç è¿›è¡Œå¤„ç†</p>\n</li>\n<li>\n<p>æ ¹æ®ä¸åŒçš„é”®ç›˜(US é”®ç›˜ã€å¾·å¼é”®ç›˜ç­‰ç­‰)å°†è·å¾—çš„é”®ä½ä¿¡å·è¿›è¡Œç›¸åº”çš„å­—ç¬¦è½¬æ¢(æŸ¥è½¬æ¢è¡¨)</p>\n</li>\n<li>\n<p>è°ƒç”¨ <code>do_tty_interrupt</code> å¤„ç†å‡½æ•° (ç¡®è®¤æ˜¯ç»™å“ªä¸ªç»ˆç«¯çš„ä¿¡å·)</p>\n</li>\n<li>\n<p>è°ƒç”¨ <code>copy_to_cooked(tty)</code> ï¼Œå³å®Œæˆ <code>read_q</code> åˆ° <code>secondary</code> çš„ç›¸å…³åŠ å·¥ã€‚</p>\n</li>\n</ol>\n<pre><code class="language-plain">  __                    __                  \n / _| __ _ _ __   __ _ / _| ___ _ __   __ _ \n| |_ / _` | \'_ \\ / _` | |_ / _ \\ \'_ \\ / _` |\n|  _| (_| | | | | (_| |  _|  __/ | | | (_| |\n|_|  \\__,_|_| |_|\\__, |_|  \\___|_| |_|\\__, |\n                 |___/                |___/ \n</code></pre>'}}},[["MDTK","5d41","9da1","ad9d"]]]);